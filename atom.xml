<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2024-03-21T03:28:48.697Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure プライベート DNS ゾーンに関するベスト プラクティス及びよくあるお問合せ</title>
    <link href="https://jpaztech.github.io/blog/network/private-dns-zone-faq/"/>
    <id>https://jpaztech.github.io/blog/network/private-dns-zone-faq/</id>
    <published>2024-03-21T00:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.697Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの杜です。</p><p>Azure DNS では、仮想ネットワーク内の名前解決結果を上書きできる<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone">プライベート DNS ゾーン</a>というサービスをご提供しており、<br><a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview">プライベート エンドポイント</a>の名前解決などと併用する場合が多いです。</p><p>このブログでは、プライベート DNS ゾーンのベスト プラクティス、及びよく頂いているお問い合わせをご紹介させて頂きます。</p><span id="more"></span><hr><h3 id="シナリオ"><a href="#シナリオ" class="headerlink" title="シナリオ"></a>シナリオ</h3><ul><li>仮想ネットワーク上のリソース (VM) がプライベート エンドポイント経由でストレージ アカウントに接続する</li><li>仮想ネットワークでは Azure 既定の DNS (168.63.129.16) を DNS サーバーとして指定している</li><li>プライベート エンドポイント経由でストレージ アカウント<code>storagebloga</code>へアクセスするために、プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> をクライアント VM の仮想ネットワークにリンクした</li><li>プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> に <code>storagebloga IN A ＜プライベート エンドポイント IP＞</code> のレコードを登録し、プライベート エンドポイントの名前解決が成功している</li><li>ただし、それ以外一部のストレージ アカウントの名前解決を行ったところ、空の結果 (NXDOMAIN) が返されてしまい、接続も失敗している</li><li>すべてストレージ アカウントの名前解決が失敗するわけではなく、問題なく接続できる場合もある</li><li>ストレージ アカウントの他に、AppService や Azure SQL Database など他の Azure PaaS サービスにも類似の事象がある</li></ul><h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>発生原因を理解するために、まず全体的な名前解決フローを説明させて頂きます。</p><p>ストレージ アカウントなどの Azure PaaS サービスでは、プライベート エンドポイントの有効化状況により、名前解決フローが異なります。<br>プライベート エンドポイントが無効化されているリソースでは、名前解決フローが以下となります。<code>privatelink.blob.core.windows.net</code> のドメインを経由しません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント無効化時の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 20 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 60 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントを有効化すると、<code>storagebloga.blob.core.windows.net</code> の CNAME 先が <code>privatelink.blob.core.windows.net</code> ドメインに変更される動作となります。<br>クライアントが存在する仮想ネットワークがプライベート DNS ゾーンにリンクしていない場合、名前解決結果は変わりません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化時の名前解決フロー (プライベート DNS ゾーンのリンクなし)</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 60 IN CNAME storagebloga.privatelink.blob.core.windows.net.</span><br><span class="line">storagebloga.privatelink.blob.core.windows.net. 60 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 17 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントへ接続させるには、お客様側にプライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> に A レコードを作成し、仮想ネットワークにリンクすることで、該当 CNAME 先を上書きして実現できているわけです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時の名前解決フロー</span><br><span class="line">※10.0.3.4 がプライベート エンドポイントの IP アドレスとなります。</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 60 IN CNAME storagebloga.privatelink.blob.core.windows.net.</span><br><span class="line">storagebloga.privatelink.blob.core.windows.net. 60 IN A 10.0.3.4</span><br></pre></td></tr></table></figure><p>プライベート DNS ゾーンをリンクすると、Azure DNS が該当 DNS ゾーン <code>privatelink.blob.core.windows.net</code> の権威サーバーとなります。<br>そのドメインへの名前解決要求を受信する時に、インターネット経由で再帰的問い合わせを行わずに、プライベート DNS ゾーンに登録されているレコードを権威結果として応答するようになります。<br>その場合、プライベート DNS ゾーンに <code>storagebloga</code> 以外のレコードが登録されていないため、以下のように、NXDOMAIN が応答されてしまいます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時に、別のリソース（プライベート エンドポイント有効化）の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storageblogbwithpe.blob.core.windows.net. INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storageblogbwithpe.blob.core.windows.net. 60 IN CNAMEstorageblogbwithpe.privatelink.blob.core.windows.net.</span><br></pre></td></tr></table></figure><p>また、各ストレージ アカウントの構成次第で、プライベート エンドポイントが有効化されていない場合があります。<br>その場合の名前解決フローでは <code>privatelink.blob.core.windows.net</code> のドメインが存在しないため、プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> をリンクしても影響がありません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時に、別のリソース（プライベート エンドポイント無効化）の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storageblogcwithoutpe.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storageblogcwithoutpe.blob.core.windows.net. 20 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 60 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><h3 id="回避策"><a href="#回避策" class="headerlink" title="回避策"></a>回避策</h3><p>特定のストレージ アカウントの名前解決のみをプライベート DNS ゾーンで実現し、それ以外の名前解決への影響を回避したい場合は、<code>privatelink.blob.core.windows.net</code> ではなく、<br><code>storagebloga.privatelink.blob.core.windows.net</code> のプライベート DNS ゾーンを作成し、頂点（APEX）レコード <code>@ IN A ＜プライベート エンドポイント IP＞</code> を構成すれば実現できます。<br>そうしますと、Azure DNS の権威ドメインが <code>storagebloga.privatelink.blob.core.windows.net</code> のみとり、それ以外 <code>storageblogcwithoutpe.privatelink.blob.core.windows.net</code> の名前解決要求を受けると、<br>インターネット経由で再帰的問い合わせを行い、プライベート DNS ゾーンに影響されなくなります。</p><p>ただし、もし複数のストレージ アカウントが存在する場合は、ストレージ アカウントの名前ごとにプライベート DNS ゾーンを用意する必要がありますので、ご注意ください。</p><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="プライベート-DNS-ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。"><a href="#プライベート-DNS-ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。" class="headerlink" title="プライベート DNS ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。"></a>プライベート DNS ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。</h2><p>変更対象以外のレコードには影響がなく、該当プライベート DNS ゾーンで一時的に名前解決ができなくなるといった事象は発生しませんので、ご安心ください。</p><h2 id="東日本リージョンに本番環境を構築しており、プライベート-DNS-ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン-レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート-DNS-ゾーンもリージョンごとに作成する必要がありますでしょうか。"><a href="#東日本リージョンに本番環境を構築しており、プライベート-DNS-ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン-レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート-DNS-ゾーンもリージョンごとに作成する必要がありますでしょうか。" class="headerlink" title="東日本リージョンに本番環境を構築しており、プライベート DNS ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート DNS ゾーンもリージョンごとに作成する必要がありますでしょうか。"></a>東日本リージョンに本番環境を構築しており、プライベート DNS ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート DNS ゾーンもリージョンごとに作成する必要がありますでしょうか。</h2><p>プライベート DNS ゾーンを含め、Azure DNS は 100% の <a href="https://azure.microsoft.com/ja-jp/updates/azuredns100sla/">SLA</a> でご提供しているため、冗長化の観点ではリージョンごとに作成する必要はありません。</p><p>ただし、もし各リージョンの IP アドレス構成が異なり、同じ FQDN に対し、リージョンごとに名前解決結果を分けたい場合は、１つのプライベート DNS ゾーンでは実現できませんので、各リージョンごとにリソース グループを作成し、複数のプライベート DNS ゾーンの構成をご検討ください。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの杜です。&lt;/p&gt;
&lt;p&gt;Azure DNS では、仮想ネットワーク内の名前解決結果を上書きできる&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone&quot;&gt;プライベート DNS ゾーン&lt;/a&gt;というサービスをご提供しており、&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview&quot;&gt;プライベート エンドポイント&lt;/a&gt;の名前解決などと併用する場合が多いです。&lt;/p&gt;
&lt;p&gt;このブログでは、プライベート DNS ゾーンのベスト プラクティス、及びよく頂いているお問い合わせをご紹介させて頂きます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>168.63.129.16 の DNS 機能について</title>
    <link href="https://jpaztech.github.io/blog/network/dns-168-63-129-16/"/>
    <id>https://jpaztech.github.io/blog/network/dns-168-63-129-16/</id>
    <published>2024-03-08T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.681Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。<br>Azure データーセンターでは、168.63.129.16 のパブリック IP アドレスは重要な役割を担います。<br>168.63.129.16 の役割については<a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16">こちら</a> でご紹介していますが、このブログでは 168.63.129.16 の DNS 機能について補足やよくあるお問い合わせをご紹介します。</p><span id="more"></span><h2 id="168-63-129-16-の概要"><a href="#168-63-129-16-の概要" class="headerlink" title="168.63.129.16 の概要"></a>168.63.129.16 の概要</h2><p>168.63.129.16 は Microsoft が保有するパブリック IP アドレスであり、Azure データーセンター上でのみ利用している仮想 IP アドレスです。<br>この 168.63.129.16 は Azure データーセンターのホスト サーバー (物理サーバー) 上で動作する IP アドレスとして割り当てられていて、パブリック インターネット上には公開されていないため Azure データーセンター上のリソース以外からは接続ができません。<br>仮想マシンなど Azure データーセンター上のリソースが正常に稼働するためのエンドポイントでもあるため、NSG やルート テーブル (UDR) で 168.63.129.16 を制御することは出来ず、仮想マシン上の OS 上でも制御しないことを強く推奨しています。</p><blockquote><p>注意<br>NSG では 168.63.129.16 に対する制御はできないと記載しましたが、AzurePlatformDNS や AzureLoadBalancer のサービスタグを利用することで、168.63.129.16 に関する通信の一部を NSG で制御可能です。<br>ただし、意図しない動作を回避するためにも原則制御しないことを強く推奨します。</p></blockquote><h2 id="168-63-129-16-の-DNS-機能"><a href="#168-63-129-16-の-DNS-機能" class="headerlink" title="168.63.129.16 の DNS 機能"></a>168.63.129.16 の DNS 機能</h2><p>168.63.129.16 は <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances?tabs=redhat">Azure 上の名前解決</a> のための再帰的リゾルバー (フルサービス リゾルバー) の機能を提供しています。下記の用途で利用いただけます。</p><p><strong>・インターネット上のドメインに対する名前解決</strong><br><strong>・<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone">プライベート DNS ゾーン</a> の名前解決</strong><br><strong>・同一仮想ネットワーク上のホスト名での名前解決</strong>  </p><p>この 168.63.129.16 の DNS 機能は、Azure ポータルであれば仮想ネットワークの DNS 設定における既定値である <strong>“既定 (Azure 提供)”</strong> で利用でき、明示的に 168.63.129.16 を指定する必要はありません。<br>また、冗長構成を意識いただくことなく、Azure 基盤内で既定で冗長化されています。<br>仮想ネットワークの DNS の観点で、168.63.129.16 を参照することは必須要件ではなく、仮想ネットワークや仮想マシンの仮想 NIC の DNS サーバーの設定として、任意の DNS サーバーを指定可能です。<br>Azure では任意の DNS サーバーを指定する構成をカスタム DNS サーバーと呼んでおり、仮想ネットワーク上のカスタム DNS サーバーでよくあるお問い合わせについては <a href="/blog/network/custom-dns-faq/">こちら</a> をご確認ください。</p><blockquote><p>注意<br>168.63.129.16 が提供するホスト名での名前解決は、同一の仮想ネットワークに限定されています。<br>例えば 2 つの仮想ネットワークでピアリング接続をしている構成では、ピアリング先のリソースをホスト名で名前解決することは出来ません。</p></blockquote><h2 id="168-63-129-16-を参照する-DNS-構成"><a href="#168-63-129-16-を参照する-DNS-構成" class="headerlink" title="168.63.129.16 を参照する DNS 構成"></a>168.63.129.16 を参照する DNS 構成</h2><p>168.63.129.16 の DNS サーバーは、Azure データーセンター上のリソースからのみ DNS クエリを受け付け可能な為、ExpressRoute や VPN で接続されたオンプレミスから 168.63.129.16 を DNS サーバーとして参照できません。<br>プライベート DNS ゾーンをオンプレミスから参照させたい場合や、ハブ&amp;スポーク構成の仮想ネットワークにおいてハブの仮想ネットワークのプライベート DNS ゾーンを参照させたい場合など、Azure 上に DNS プロキシに該当する機能が必要です。<br>この DNS プロキシは、Azure であれば現在下記の構成案があります。</p><p><strong>・Azure DNS Private Resolver を利用する</strong><br><strong>・Azure Firewall の DNS プロキシ機能を有効化する</strong><br><strong>・仮想マシン上に DNS サーバーを構成する</strong>  </p><p>それぞれの特徴としては下記があります。</p><h4 id="Azure-DNS-Private-Resolver"><a href="#Azure-DNS-Private-Resolver" class="headerlink" title="Azure DNS Private Resolver"></a>Azure DNS Private Resolver</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/dns/dns-private-resolver-overview">Azure DNS Private Resolver</a> は、仮想ネットワークのサブネット上に、DNS クエリを受け付ける受信エンドポイントを構成します。<br>受信エンドポイントの IP アドレスは仮想ネットワーク上の IP アドレスとなり、IP レイヤーで疎通性があればオンプレミスからも DNS クエリを受け付けることができます。既定で高可用性/ゾーン冗長構成のマネージド サービスであるため、運用コストが削減できます。<br>168.63.129.16 の DNS サーバーは条件付き転送などカスタマイズ機能がありませんでしたが、Azure DNS Private Resolver であれば送信エンドポイントと転送ルールを構成することで条件付き転送も利用できます。</p><h4 id="Azure-Firewall"><a href="#Azure-Firewall" class="headerlink" title="Azure Firewall"></a>Azure Firewall</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/overview">Azure Firewall</a> は仮想ネットワーク上でデプロイ可能なファイアウォール アプライアンスですが、DNS クエリを受け付ける <a href="https://learn.microsoft.com/ja-jp/azure/firewall/dns-settings#dns-proxy">DNS プロキシ</a> の機能があります。<br>Azure Firewall が参照する DNS サーバーは仮想ネットワークのカスタム DNS サーバーとは連動しておらず、既定で 168.63.129.16 を参照します。Azure Firewall の DNS サーバーの設定で任意の DNS サーバーを参照するように構成変更可能です。<br>既に Azure Firewall をご利用いただいており、条件付き転送が不要であれば DNS プロキシとしてご利用いただけますが、DNS プロキシの機能のみをご利用いただく場合は Azure DNS Private Resolver よりも高額です。</p><h4 id="仮想マシン上の-DNS-サーバー"><a href="#仮想マシン上の-DNS-サーバー" class="headerlink" title="仮想マシン上の DNS サーバー"></a>仮想マシン上の DNS サーバー</h4><p>Azure 上の DNS プロキシとしては、仮想マシン上に DNS サーバー (Windows サーバーや BIND など) を構成いただき、フォワーダー先として 168.63.129.16 を指定いただく構成も考えられます。<br>仮想マシン上の構成となるため、DNS サーバーの構成及び運用はお客様のご対応範囲となり、Azure サポートではご支援できかねる点はご留意ください。  </p><p>DNS プロキシをオンプレミスから参照する構成イメージとしては、<a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns-integration">プライベート エンドポイントのドキュメント</a> に Azure DNS Private Resolver をベースとした構成例があります。<br>必要に応じて Azure Firewall や仮想マシン上の DNS サーバーと置き換えてください。</p><blockquote><p>注意<br>オンプレミスの DNS サーバーから Azure 上の DNS プロキシを参照する構成で、プライベート エンドポイントに関連するドメインを条件付きフォワーダーで指定する時、指定するドメイン ゾーンは対象 Azure PaaS の パブリック DNS ゾーンを指定することを推奨しています。<br>プライベート エンドポイントで利用される privatelink サブドメインの DNS ゾーンだけ条件付きフォワーダーで転送した場合、オンプレミスの DNS サーバーの動作によっては意図した名前解決とならない場合があります。  </p></blockquote><h2 id="よくいただくお問い合わせ"><a href="#よくいただくお問い合わせ" class="headerlink" title="よくいただくお問い合わせ"></a>よくいただくお問い合わせ</h2><p>168.63.129.16 の DNS 機能に関して、Azure サポートによくお問い合わせいただく内容についてご案内します。<br>仮想ネットワーク上のカスタム DNS サーバーでよくあるお問い合わせについては <a href="/blog/network/custom-dns-faq/">こちら</a> をご確認ください。<br>プライベート DNS ゾーンに関してよくあるお問い合わせについては <a href="/blog/network/private-dns-zone-faq/">こちら</a> をご参照ください。  </p><h4 id="DNS-プロキシから-168-63-129-16-をフォワーダー先に指定して制限がかかりませんか？"><a href="#DNS-プロキシから-168-63-129-16-をフォワーダー先に指定して制限がかかりませんか？" class="headerlink" title="DNS プロキシから 168.63.129.16 をフォワーダー先に指定して制限がかかりませんか？"></a>DNS プロキシから 168.63.129.16 をフォワーダー先に指定して制限がかかりませんか？</h4><p>1 台の仮想マシンから 1 秒あたりに送信可能な DNS クエリの数 (QPS) は 1000  という <a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#azure-dns-limits">Azure 上の制限内</a> であれば、168.63.129.16 は DNS サーバーとして DNS クエリを処理可能です。<br>言い換えますと、仮想マシン上の DNS サーバー、または Azure Firewall を経由して 168.63.129.16 に対する  1000 QPS 以上の DNS クエリは失敗する可能性があります。<br>なお、Azure DNS Private Resolver はエンドポイント毎に 10,000 QPS が上限です。</p><h4 id="仮想マシン上の名前解決でホスト名で-IP-アドレスが解決できなくなりました。"><a href="#仮想マシン上の名前解決でホスト名で-IP-アドレスが解決できなくなりました。" class="headerlink" title="仮想マシン上の名前解決でホスト名で IP アドレスが解決できなくなりました。"></a>仮想マシン上の名前解決でホスト名で IP アドレスが解決できなくなりました。</h4><p>考えられる要因として、仮想ネットワークの DNS サーバーの設定が変更されてカスタム DNS サーバーを参照する構成になったことが考えられます。<br>仮想マシンが 168.63.129.16 を参照している構成では、ホスト名で名前解決をした際、Azure 基盤が内部 DNS サフィックス (.internal.cloudapp.net) を自動で付与します。<br>この動作により仮想マシン上でホスト名だけで名前解決ができます。<br>仮想マシンが 168.63.129.16 を参照しない構成 (カスタム DNS サーバー構成) に変更された場合、Azure 基盤の内部 DNS サフィックス (.internal.cloudapp.net) の自動付与の機能が停止されるため、仮想マシンはホスト名で名前解決ができなくなります。</p><h4 id="仮想マシン上のホスト名での名前解決の-IP-アドレスが変更されました。"><a href="#仮想マシン上のホスト名での名前解決の-IP-アドレスが変更されました。" class="headerlink" title="仮想マシン上のホスト名での名前解決の IP アドレスが変更されました。"></a>仮想マシン上のホスト名での名前解決の IP アドレスが変更されました。</h4><p>考えられる要因として、同一のコンピューター名を持つ仮想マシンを 1 つの仮想ネットワーク上に複数展開したことが挙げられます。<br>仮想マシンが展開されたとき、Azure 基盤では内部 DNS サフィックス (.internal.cloudapp.net) に仮想マシンのコンピューター名をホスト名とした DNS レコード情報を追加します。<br>仮想マシンのバックアップなどでバックアップ先を同一の仮想ネットワークにした場合、Azure 基盤は仮想マシンの展開時に DNS レコード情報を更新します。<br>この動作により、ホスト名に対する名前解決の結果が、後からデプロイされた仮想マシンの IP アドレスと紐づけられることで、ホスト名に対する名前解決の結果が変更されます。</p><p>もし、仮想マシン間の名前解決をホスト名のみで実施されており、仮想マシンのバックアップなどを実施される場合は、別の仮想ネットワーク上にデプロイいただくなどのご対応を実施願います。</p><h4 id="サフィックスとして追加された-reddog-microsoft-com-は消しても良いですか？"><a href="#サフィックスとして追加された-reddog-microsoft-com-は消しても良いですか？" class="headerlink" title="サフィックスとして追加された reddog.microsoft.com は消しても良いですか？"></a>サフィックスとして追加された reddog.microsoft.com は消しても良いですか？</h4><p>仮想マシンが 168.63.129.16 を DNS サーバーとして参照しないカスタム DNS サーバー構成では、Azure 基盤は既定の内部 DNS サフィックス (.internal.cloudapp.net) ではなく、機能を持たないプレース ホルダー (reddog.microsoft.com) が付与されます。<br>この reddog.microsoft.com  プレフィックスを削除または上書きされても仮想マシンの動作上は影響ありません。</p><h4 id="168-63-129-16-で名前解決された-DNS-クエリのログは確認できますか？"><a href="#168-63-129-16-で名前解決された-DNS-クエリのログは確認できますか？" class="headerlink" title="168.63.129.16 で名前解決された DNS クエリのログは確認できますか？"></a>168.63.129.16 で名前解決された DNS クエリのログは確認できますか？</h4><p>現状 168.63.129.16 の DNS ログを Azure ユーザーが確認する方法はございません。<br>Azure サポート担当にご依頼いただければ該当ログの調査支援が可能ですが、ログの調査をするには対象の FQDN と調査対象の時刻を可能な限り具体的にご提示願います。<br>なお、Azure 既定の DNS のログは、30 日程度でローテーションされ、過去のログは参照できない点はご留意ください。</p><h4 id="DNSSEC-はサポートしていますか？"><a href="#DNSSEC-はサポートしていますか？" class="headerlink" title="DNSSEC はサポートしていますか？"></a>DNSSEC はサポートしていますか？</h4><p>現状 168.63.129.16 において DNSSEC はサポートされていません。<br>今後の機能追加として検討されているため、今後の機能追加にご期待いただければと存じます。</p></br><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。&lt;br&gt;Azure データーセンターでは、168.63.129.16 のパブリック IP アドレスは重要な役割を担います。&lt;br&gt;168.63.129.16 の役割については&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16&quot;&gt;こちら&lt;/a&gt; でご紹介していますが、このブログでは 168.63.129.16 の DNS 機能について補足やよくあるお問い合わせをご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>Gateway メンテナンスコントロール機能について</title>
    <link href="https://jpaztech.github.io/blog/network/gw-maintenance/"/>
    <id>https://jpaztech.github.io/blog/network/gw-maintenance/</id>
    <published>2024-02-29T15:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.689Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure ゲートウェイサービスでは以前からお客様よりメンテナンスのコントロールについてご要望をいただいておりました。<br>2023 年 11 月よりプレビュー中の機能とはなりますが、メンテナンスコントロールのための機能が実装されましたのでご紹介させていただきます。</p><ul><li>ご参考: <a href="https://azure.microsoft.com/ja-jp/updates/public-preview-customercontrolled-maintenance/">Public preview: Customer-controlled maintenance | Azure の更新情報 | Microsoft Azure</a></li></ul><h2 id="仮想ネットワークゲートウェイ-VGW-メンテナンスとは"><a href="#仮想ネットワークゲートウェイ-VGW-メンテナンスとは" class="headerlink" title="仮想ネットワークゲートウェイ( VGW ) メンテナンスとは"></a>仮想ネットワークゲートウェイ( VGW ) メンテナンスとは</h2><p>VGW ではサービスを健全に保つため、月に数回のメンテナンスを実施しており、定期メンテナンスは大きく以下の 3 種類に分類されます。</p><ol><li>ゲートウェイ機能を提供するソフトウェア メンテナンス</li><li>ホスト基盤メンテナンス </li><li>ハードウェアメンテナンス</li></ol><p>ゲートウェイ機能を提供しているソフトウェアのアップグレードの他、一般的な VM と同様の IaaS サービス基盤上で動作しているため、<br>ホストで稼働するソフトウェアアップグレードやホスト、上位ネットワーク装置などハードウェアの更新などの作業を行います。<br>一般的にこれらは Azure サービス基盤上で自動化された作業で、冗長性を考慮し、数千、数万のリソースに対し、順次、更新を適用いたします。</p><ul><li>ご参考: <a href="https://jpaztech.github.io/blog/vm/vm-maintenance/">Azure IaaS VM で実施されるメンテナンスについて</a></li></ul><p>定期メンテナンスでは極力お客様サービスに影響が発生しないように、ExressRoute ゲートウェイではトラフィックを迂回した上で実施するなどの対処を行っております。しかしながら現状、実行時に多少の通信遅延の増加、パケットロスが検出されることがあります。また VPNGW では VPN 接続で再接続が必要になることがあります。</p><h2 id="メンテナンスコントロール機能でできること"><a href="#メンテナンスコントロール機能でできること" class="headerlink" title="メンテナンスコントロール機能でできること"></a>メンテナンスコントロール機能でできること</h2><p>本機能を設定することで、 VGW リソース毎に定期メンテナンスを実行するためのメンテナンスウィンドウを指定することができます。トラフィックの少ない時間帯、営業時間外にメンテナンスウィンドウを設定いただくことにより、サービス影響を極力避けた運用が可能となります。この機能を用いても、上記の 3 種類のメンテナンスの中の “1. ゲートウェイ機能を提供するソフトウェア メンテナンス” のみの制御となりますので、<strong>全メンテナンスを制御できるわけではございませんのでご注意ください。</strong></p><p>( VGW は共有リソース上で稼働しているため、ホスト基盤、ハードウェアメンテナンスについては本機能の制御対象外となります )</p><h2 id="対応可能なゲートウェイの種類"><a href="#対応可能なゲートウェイの種類" class="headerlink" title="対応可能なゲートウェイの種類"></a>対応可能なゲートウェイの種類</h2><p>対象可能な VGW の種類は下記となります。<br>現時点では Virtual WAN Point-to-Site GW, VirtualWAN 仮想ハブルータついては未対応です</p><ul><li>ExpressRoute GW</li><li>VPNGW</li><li>VirtualWAN Site-to-Site GW</li><li>VirtualWAN ExpressRoute GW</li></ul><h2 id="設定例"><a href="#設定例" class="headerlink" title="設定例"></a>設定例</h2><p>設定方法詳細については以下ドキュメントご参照ください。</p><p>＊ご参考: <a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/customer-controlled-gateway-maintenance">VPN Gateway にお客様が管理するゲートウェイ メンテナンスを構成する (プレビュー)</a></p><p>＊ご参考: <a href="https://learn.microsoft.com/ja-jp/azure/expressroute/customer-controlled-gateway-maintenance">ExpressRoute にお客様が管理するゲートウェイ メンテナンスを構成する (プレビュー)</a></p><p>仮想ネットワーク ゲートウェイにお客様が管理するメンテナンスを構成する - Azure VPN Gateway | Microsoft Learn</p><p>重要な設定項目としてメンテナンスウィンドウ スケジュールを指定する箇所がありますが、直観的にわかりにくいため、設定例とその動作について以下例を挙げて説明いたします。</p><p>スケジュールの設定例</p><p><img src="/blog/network/gw-maintenance/maintenance_control_1.png"> </p><p>“スケジュールの追加” を選択することで、メンテナンスウィンドウの開始時刻と許容するメンテナンス期間を設定します。<br>※メンテナンス期間の最小値は 5 時間で、それ以下を設定することはできません。</p><p><img src="/blog/network/gw-maintenance/maintenance_control_2.png"> </p><h2 id="設定例と実際の動作について"><a href="#設定例と実際の動作について" class="headerlink" title="設定例と実際の動作について"></a>設定例と実際の動作について</h2><h3 id="設定シナリオ-1"><a href="#設定シナリオ-1" class="headerlink" title="設定シナリオ 1."></a>設定シナリオ 1.</h3><p>メンテナンス構成設定を追加した日時 1/1 9:00</p><h4 id="設定内容"><a href="#設定内容" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>開始日 1/31 5:00 </li><li>メンテナンス期間 ５時間</li></ul><h4 id="実際の動作"><a href="#実際の動作" class="headerlink" title="実際の動作"></a>実際の動作</h4><p>1/31 に計画メンテナンスがある場合<br>メンテナンスウィンドウ設定に従い、 1/31 5:00 ～ 10:00 の間にメンテナンスが発生します</p><hr><h3 id="設定シナリオ-2"><a href="#設定シナリオ-2" class="headerlink" title="設定シナリオ 2."></a>設定シナリオ 2.</h3><p>メンテナンス構成設定を追加した日時 1/1 9:00</p><h4 id="設定内容-1"><a href="#設定内容-1" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>開始日 1/31 5:00 </li><li>終了日 2/28 23:00</li><li>メンテナンス期間 ５時間</li></ul><h4 id="実際の動作-1"><a href="#実際の動作-1" class="headerlink" title="実際の動作"></a>実際の動作</h4><p>2/10 に計画メンテナンスがある場合、メンテナンスウィンドウ設定に従い、 2/10 5:00 ～ 10:00 の間にメンテナンスが発生します</p><hr><h3 id="設定シナリオ-3"><a href="#設定シナリオ-3" class="headerlink" title="設定シナリオ 3."></a>設定シナリオ 3.</h3><p>メンテナンス構成設定を追加した日時 1/1 9:00</p><h4 id="設定内容-2"><a href="#設定内容-2" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>開始日 1/31 5:00 </li><li>メンテナンス期間 5 時間</li></ul><h4 id="実際の動作-2"><a href="#実際の動作-2" class="headerlink" title="実際の動作"></a>実際の動作</h4><p>1/15 に計画メンテナンスがある場合、<strong>メンテナンス構成設定は働かず</strong>、元々の計画メンテナンスの予定通り 1/15 にメンテナンスが実行されます</p><h2 id="運用上注意すべき点"><a href="#運用上注意すべき点" class="headerlink" title="運用上注意すべき点"></a>運用上注意すべき点</h2><ul><li>メンテナンス構成設定は制御対象ゲートウェイリソースと同じリージョンに設定する必要があります</li><li>メンテナンスウィンドウは最低 5 時間必要です</li><li>障害、セキュリティ対応など緊急性が要求されるメンテナンスについては制御対象外です</li><li>設定が即時反映されるわけではなく、反映までに最大 24 時間かかることがございます。</li><li>VPNGW basic SKU は非対応です</li><li>P2S GW 非対応です</li><li>現状 daily スケジュール( 1 日単位のスケジュール )のみ使用可能です</li></ul><ul><li>ご参考: <a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-vpn-faq#customer-controlled">顧客が管理するゲートウェイのメンテナンス</a></li></ul><h2 id="今後の予定"><a href="#今後の予定" class="headerlink" title="今後の予定"></a>今後の予定</h2><p>VirtualWAN 仮想ハブルータ, P2S GW, Application Gateway, Azure Firewall への対応時期は未定です</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure ゲートウェイサービスでは以前からお客様よりメンテナンスのコントロールについてご要望をいただいておりました。&lt;br&gt;2023 年 11 月よりプレビュー中の機能とはなりますが、メンテナンスコ</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
    <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Azure Network 製品について TLS 1.2 以降に移行するアナウンスの補足 (Tracking ID:7_8G-D8Z)</title>
    <link href="https://jpaztech.github.io/blog/network/tls1.2_migration/"/>
    <id>https://jpaztech.github.io/blog/network/tls1.2_migration/</id>
    <published>2024-02-27T00:10:00.000Z</published>
    <updated>2024-03-21T03:28:48.697Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。</p><p>メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。</p><h2 id="TLS-バージョンとは"><a href="#TLS-バージョンとは" class="headerlink" title="TLS バージョンとは"></a>TLS バージョンとは</h2><p>TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、<a href="https://datatracker.ietf.org/doc/html/rfc8996">RFC 8996</a> により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。</p><h2 id="TLS-接続時のバージョン選定動作について"><a href="#TLS-接続時のバージョン選定動作について" class="headerlink" title="TLS 接続時のバージョン選定動作について"></a>TLS 接続時のバージョン選定動作について</h2><p>TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。</p><h3 id="Windows-OS-の場合"><a href="#Windows-OS-の場合" class="headerlink" title="Windows OS の場合"></a>Windows OS の場合</h3><p><a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows">こちらの公開ドキュメント</a>の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。<br>また、特定の TLS バージョンを有効化/無効化されたい場合は、<a href="https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/">こちらの記事</a>の通りご対応ください。</p><p>Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。</p><p>参考として、Android など他のクライアント対応状況は<a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation">こちら</a>の公開ドキュメントに開示されています。 </p><h3 id="Chrome-Edge-などのブラウザの場合"><a href="#Chrome-Edge-などのブラウザの場合" class="headerlink" title="Chrome/Edge などのブラウザの場合"></a>Chrome/Edge などのブラウザの場合</h3><p>最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、<br>特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。<br>Edgeの場合は<a href="https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg">こちらの記事</a>の通り対応できます。</p><h3 id="それ以外の場合"><a href="#それ以外の場合" class="headerlink" title="それ以外の場合"></a>それ以外の場合</h3><p>上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。</p><h3 id="TLS-チェッカー-ツール"><a href="#TLS-チェッカー-ツール" class="headerlink" title="TLS チェッカー ツール"></a>TLS チェッカー ツール</h3><p><a href="https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html">こちら</a>のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。</p><h2 id="Azure-Network製品の対応状況及び推奨アクションについて"><a href="#Azure-Network製品の対応状況及び推奨アクションについて" class="headerlink" title="Azure Network製品の対応状況及び推奨アクションについて"></a>Azure Network製品の対応状況及び推奨アクションについて</h2><p>以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。<br>もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。</p></div><span id="more"></span><h2 id="Application-Gateway"><a href="#Application-Gateway" class="headerlink" title="Application Gateway"></a>Application Gateway</h2><h3 id="クライアントから-Application-Gateway-への接続について"><a href="#クライアントから-Application-Gateway-への接続について" class="headerlink" title="クライアントから Application Gateway への接続について"></a>クライアントから Application Gateway への接続について</h3><p>Application Gateway では、SSL ポリシーを選択することで、クライアントが Application Gateway へ接続する際の最小 TLS バージョン（1.0 から 1.3 まで）を設定できます。 </p><p>現時点では、Application Gateway は2024 年 10 月 31 日以降にも引き続き TLS1.0 から TLS1.3 をサポートしており、TLS1.2 以下のバージョンをサポートしなくなる予定はございません。 </p><p>ただし、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-configure-ssl-policy-powershell">こちらの公開ドキュメント</a>の記載通り、セキュリティ強化のためには TLS1.2 のご利用を推奨いたします。 </p><blockquote><p>注意<br>Application Gateway でのセキュリティを強化するために、TLS プロトコルの最小バージョンとして TLS 1.2 を使用することをお勧めします。</p></blockquote><h4 id="最小TLS-バージョンの設定方法"><a href="#最小TLS-バージョンの設定方法" class="headerlink" title="最小TLS バージョンの設定方法"></a>最小TLS バージョンの設定方法</h4><p>下図の通り、Azure ポータル → 対象 Application Gateway → 「リスナー」のタブにて、 「選択した SSL ポリシー」の「変更」ボタンをクリックし、「 SSL ポリシーの変更」より設定できます。<br><img src="./appgw_tls_setting.png"></p><p>また、Application Gateway SKU v2 の場合は、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-configure-listener-specific-ssl-policy">こちらの手順通り</a>、リスナー毎に異なる TLS バージョンを設定することも可能です。 </p><h3 id="Application-Gateway-からバックエンド-サーバーへの接続について"><a href="#Application-Gateway-からバックエンド-サーバーへの接続について" class="headerlink" title="Application Gateway からバックエンド サーバーへの接続について"></a>Application Gateway からバックエンド サーバーへの接続について</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-ssl-policy-overview#limitations">こちらの公開ドキュメント</a>の記載通り、Application Gateway がバックエンド サーバーへ通信する際に TLS 1.0, 1.1, 1.2 をサポートしております。 </p><blockquote><p>バックエンド サーバーへの接続は、常に最小でプロトコル TLS v1.0、最大で TLS v1.2 までです。 そのため、バックエンド サーバーとのセキュリティで保護された接続を確立するには、TLS バージョン 1.0、1.1、1.2 のみがサポートされます。</p></blockquote><p>具体的な TLS バージョンの選定は接続先のバックエンド サーバーに依存するため、もし最小 TLS バージョンを 1.2 に指定したい場合は、Application Gateway ではなく、バックエンド サーバー側の TLS 設定に対応して頂く必要があります。 </p><h2 id="Azure-Firewall"><a href="#Azure-Firewall" class="headerlink" title="Azure Firewall"></a>Azure Firewall</h2><p>Azure Firewall では、TLS バージョンが関わる部分は TLS インスペクションのみとなります。アプリケーション ルール、ネットワーク ルール、及び DNAT ルールで通信を許可する場合は本通知の対象外となります。</p><p>TLS インスペクション機能を使用する場合は、<a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-features#tls-inspection">こちらの公開ドキュメント</a>の記載通り、現状及び 2024 年 10 月 31 日以降にも TLS1.0 及び TLS1.1 は互換性のために引き続き動作する予定ですが、早めに TLS 1.2 に移行することを強く推奨します。</p><blockquote><p>ヒント<br>TLS 1.0 と 1.1 は非推奨になっていて、サポートされません。 TLS 1.0 と 1.1 のバージョンの TLS/SSL (Secure Sockets Layer) は脆弱であることが確認されています。現在、これらは下位互換性を維持するために使用可能ですが、推奨されていません。 できるだけ早く TLS 1.2 に移行してください。</p></blockquote><p>また、現状の TLS インスペクション機能では TLS1.3 をサポートしておりませんが、2024 年 3 月頃にサポートする予定です。</p><h2 id="Front-Door"><a href="#Front-Door" class="headerlink" title="Front Door"></a>Front Door</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/end-to-end-tls?pivots=front-door-standard-premium#supported-tls-versions">こちらの公開ドキュメント</a>の記載通り、 Front Door ではカスタム ドメインを利用する場合は、最小 TLS バージョンを 1.0 または 1.2 を選択できます。 </p><blockquote><p>Azure Front Door では、TLS プロトコルの 4 つのバージョン (TLS バージョン 1.0、1.1、1.2、1.3) がサポートされています。 2019 年 9 月以降に作成されたすべての Azure Front Door プロファイルでは、TLS 1.3 が有効になっている既定の最小値として TLS 1.2 が使用されますが、TLS 1.0 と TLS 1.1 は下位互換性のために引き続きサポートされています。</p></blockquote><p>Front Door では 2024 年 10 月 31 日以降も引き続き TLS 1.0 から TLS 1.3 まで利用できますが、セキュリティ強化のためには TLS 1.2 以上のご利用を推奨いたします。 </p><h2 id="Private-Link-Service-または-Private-Endpoint"><a href="#Private-Link-Service-または-Private-Endpoint" class="headerlink" title="Private Link Service または Private Endpoint"></a>Private Link Service または Private Endpoint</h2><p>Private Link Service と Private Endpoint のサービスでは、TLS プロトコルは終端しません。<br>Private Link Service と Private Endpoint を利用した通信の場合には、クライアントとサーバーの通信上の両端で TLS ネゴシエーションが実施されます。クライアントおよびサーバーとなるサービスの観点でご確認頂く必要があります。 </p><h2 id="Bastion"><a href="#Bastion" class="headerlink" title="Bastion"></a>Bastion</h2><p>Bastion はお客様側で証明書の管理運用を意識する必要のないサービスとして、<a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-overview#key">以下の公開ドキュメント</a>の記載通り、 TLS 1.2 のみをサポートしておりますので、お客様側の対処が不要です。 </p><blockquote><p>Bastion では、TLS 1.2 がサポートされています。 以前の TLS バージョンはサポートされません。</p></blockquote><h2 id="Traffic-Manager"><a href="#Traffic-Manager" class="headerlink" title="Traffic Manager"></a>Traffic Manager</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-how-it-works#how-clients-connect-using-traffic-manager">こちらの公開ドキュメント</a>の説明通り、TrafficManager は DNS レベルで動作する負荷分散サービスとして、クライアントからの通信は TrafficManager を経由しませんので、本通知の対象外となります。 </p><h2 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a>Load Balancer</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-faqs#azure-load-balancer---tls-ssl---------------">こちらの公開ドキュメント</a>記載通り、Azure Load Balancer では、TLS 接続を終端せずにバックエンド サーバーへ転送する動作となりますので、本通知の対象外となります。 </p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。&lt;/p&gt;
&lt;p&gt;メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。&lt;/p&gt;
&lt;h2 id=&quot;TLS-バージョンとは&quot;&gt;&lt;a href=&quot;#TLS-バージョンとは&quot; class=&quot;headerlink&quot; title=&quot;TLS バージョンとは&quot;&gt;&lt;/a&gt;TLS バージョンとは&lt;/h2&gt;&lt;p&gt;TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8996&quot;&gt;RFC 8996&lt;/a&gt; により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。&lt;/p&gt;
&lt;h2 id=&quot;TLS-接続時のバージョン選定動作について&quot;&gt;&lt;a href=&quot;#TLS-接続時のバージョン選定動作について&quot; class=&quot;headerlink&quot; title=&quot;TLS 接続時のバージョン選定動作について&quot;&gt;&lt;/a&gt;TLS 接続時のバージョン選定動作について&lt;/h2&gt;&lt;p&gt;TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。&lt;/p&gt;
&lt;h3 id=&quot;Windows-OS-の場合&quot;&gt;&lt;a href=&quot;#Windows-OS-の場合&quot; class=&quot;headerlink&quot; title=&quot;Windows OS の場合&quot;&gt;&lt;/a&gt;Windows OS の場合&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows&quot;&gt;こちらの公開ドキュメント&lt;/a&gt;の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。&lt;br&gt;また、特定の TLS バージョンを有効化/無効化されたい場合は、&lt;a href=&quot;https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/&quot;&gt;こちらの記事&lt;/a&gt;の通りご対応ください。&lt;/p&gt;
&lt;p&gt;Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。&lt;/p&gt;
&lt;p&gt;参考として、Android など他のクライアント対応状況は&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation&quot;&gt;こちら&lt;/a&gt;の公開ドキュメントに開示されています。 &lt;/p&gt;
&lt;h3 id=&quot;Chrome-Edge-などのブラウザの場合&quot;&gt;&lt;a href=&quot;#Chrome-Edge-などのブラウザの場合&quot; class=&quot;headerlink&quot; title=&quot;Chrome/Edge などのブラウザの場合&quot;&gt;&lt;/a&gt;Chrome/Edge などのブラウザの場合&lt;/h3&gt;&lt;p&gt;最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、&lt;br&gt;特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。&lt;br&gt;Edgeの場合は&lt;a href=&quot;https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg&quot;&gt;こちらの記事&lt;/a&gt;の通り対応できます。&lt;/p&gt;
&lt;h3 id=&quot;それ以外の場合&quot;&gt;&lt;a href=&quot;#それ以外の場合&quot; class=&quot;headerlink&quot; title=&quot;それ以外の場合&quot;&gt;&lt;/a&gt;それ以外の場合&lt;/h3&gt;&lt;p&gt;上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。&lt;/p&gt;
&lt;h3 id=&quot;TLS-チェッカー-ツール&quot;&gt;&lt;a href=&quot;#TLS-チェッカー-ツール&quot; class=&quot;headerlink&quot; title=&quot;TLS チェッカー ツール&quot;&gt;&lt;/a&gt;TLS チェッカー ツール&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html&quot;&gt;こちら&lt;/a&gt;のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。&lt;/p&gt;
&lt;h2 id=&quot;Azure-Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;a href=&quot;#Azure-Network製品の対応状況及び推奨アクションについて&quot; class=&quot;headerlink&quot; title=&quot;Azure Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;/a&gt;Azure Network製品の対応状況及び推奨アクションについて&lt;/h2&gt;&lt;p&gt;以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。&lt;br&gt;もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!WARNING]&lt;br&gt;以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway からの 500 番台の HTTP 応答について</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-http-response-codes-5xx-server-error/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-http-response-codes-5xx-server-error/</id>
    <published>2024-02-22T08:30:00.000Z</published>
    <updated>2024-03-21T03:28:48.673Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームの間島です。</p><p>今回は、Application Gateway 経由で Web サイトへアクセスしている際に、Application Gateway からの HTTP 応答でエラーが発生した場合の原因や調査方法などについてご紹介させていただき、特にお客様よりお問い合わせをいただく機会が多い 500 番台の HTTP 応答について、お客様が問題判別を行う際の参考にしていただくことを目的としております。(なお、V1 SKU は廃止となることが発表されておりますので、当ブログの対象外とさせていただいております。)</p><h2 id="Application-Gateway-からの-HTTP-応答の確認方法"><a href="#Application-Gateway-からの-HTTP-応答の確認方法" class="headerlink" title="Application Gateway からの HTTP 応答の確認方法"></a>Application Gateway からの HTTP 応答の確認方法</h2><p>Application Gateway からは、状況に応じて、様々な HTTP 応答コードが返されます。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/http-response-codes">Application Gateway の HTTP 応答コード</a><br>HTTP 応答コードの確認方法ですが、Azure ポータルより、関連するメトリックを参照することが可能です。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-metrics#application-gateway-metrics">Application Gateway メトリック</a></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>メトリックを確認する際には、上流側 (Up Stream = データ配信側 = バックエンド側) から先に確認してください。(下に記載した各項目は、上流から順に並べています)</p></div><h4 id="異常なホストの数-Unhealthy-Host-Count"><a href="#異常なホストの数-Unhealthy-Host-Count" class="headerlink" title="- 異常なホストの数 (Unhealthy Host Count)"></a>- 異常なホストの数 (Unhealthy Host Count)</h4><p>このメトリックは、正常性プローブによって異常であると判定されたバックエンドの数を表します。バックエンド プールごとにフィルター処理を行って、特定のバックエンド プールの異常なホストの数を表示することも可能です。Application Gateway が バックエンド プールにリクエストを転送するためには、該当のバックエンド プールへの正常性プローブが成功している必要があります。もし、想定外の「異常なホスト」が発生している場合には、下のリンク先を参照し、該当のバックエンド サーバーへの正常性プローブが成功するよう、問題判別を行ってください。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></p><h4 id="バックエンド応答の状態-Backend-Response-Status"><a href="#バックエンド応答の状態-Backend-Response-Status" class="headerlink" title="- バックエンド応答の状態 (Backend Response Status)"></a>- バックエンド応答の状態 (Backend Response Status)</h4><p>バックエンド サーバーから Application Gateway に返された HTTP 応答コードの数を表します。(Application Gateway によって生成された HTTP 応答コードは含まれません。) HTTP 応答コードの分布をさらに分類し、2xx、3xx、4xx、5xx のカテゴリで応答を表示できます。Application Gateway は、基本的には、バックエンド サーバーによって返された HTTP 応答コードをクライアントに転送しますので、バックエンド サーバーが想定外の HTTP 応答コードを返している場合には、バックエンド サーバー側にて問題判別を行ってください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>IIS がバックエンド サーバーの場合には、下のリンク先をご参照いただき、IIS ログをご確認ください。</p><p><a href="https://jpdsi.github.io/blog/web-apps/LogCollection1/#2-IIS-%E3%83%AD%E3%82%B0">IIS の調査に必要な基本的なログ情報について</a></p></div><h4 id="応答の状態-Response-Status"><a href="#応答の状態-Response-Status" class="headerlink" title="- 応答の状態 (Response Status)"></a>- 応答の状態 (Response Status)</h4><p>Application Gateway からクライアントに返された HTTP 応答コードの数を表します。応答状態コードの分布をさらに分類し、2xx、3xx、4xx、5xx のカテゴリで応答を表示できます。</p><h4 id="失敗した要求-Failed-Requests"><a href="#失敗した要求-Failed-Requests" class="headerlink" title="- 失敗した要求 (Failed Requests)"></a>- 失敗した要求 (Failed Requests)</h4><p>Application Gateway が 5xx サーバー エラーコードで処理した要求の数です。これには、Application Gateway から生成された 5xx コードと、バックエンドから生成された 5xx のコードが含まれます。<br>要求の数をさらにフィルター処理することで、各々のまたは特定のバックエンド プール http 設定の組み合わせごとに数を表示できます。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>上記のメトリックにて、バックエンド サーバーもしくは Application Gateway にて、どのような HTTP 応答コードを返しているかを確認した後に、下の HTTP 応答コード毎の発生原因 / 問題判別方法 に進んでください。</p><p>また HTTP 応答コードは、「診断ログ」にてアクセス ログを有効化することにより確認することも可能です。</p></div><h2 id="500-番台の-HTTP-応答コード毎の発生原因-問題判別方法"><a href="#500-番台の-HTTP-応答コード毎の発生原因-問題判別方法" class="headerlink" title="500 番台の HTTP 応答コード毎の発生原因 / 問題判別方法"></a>500 番台の HTTP 応答コード毎の発生原因 / 問題判別方法</h2><p>500 から 599 の HTTP 応答コードは、クライアントからの要求の実行中に Application Gateway または バックエンド サーバーにおいて問題が発生したことを示しています。</p><h4 id="502-無効なゲートウェイ-バックエンド-サーバーが原因であることが多い"><a href="#502-無効なゲートウェイ-バックエンド-サーバーが原因であることが多い" class="headerlink" title="- 502 - 無効なゲートウェイ (バックエンド サーバーが原因であることが多い)"></a>- 502 - 無効なゲートウェイ (バックエンド サーバーが原因であることが多い)</h4><p>Application Gateway が 502 エラーを返す理由はいくつかありますが、まずは前述のように、正常性プローブが成功しているかどうか確認してください。502 エラーは、お客様からのお問い合わせが最も多いエラーですが、前述のように Application Gateway から バックエンド プールへの正常性プローブが失敗しているため、発生しているケースが多く見受けられます。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></p><p>また、502 エラーの原因といたしましては、下記などもあげられます。</p><ul><li>ネットワーク セキュリティ グループ (NSG)、ユーザー定義ルート (UDR)、またはカスタム DNS に関する問題</li><li>既定の正常性プローブに関する問題</li><li>カスタムの正常性プローブに関する問題</li><li>要求のタイムアウト</li><li>空の BackendAddressPool</li><li>BackendAddressPool の異常なインスタンス</li></ul><p>502 エラーにつきましては、過去にもブログにて取り上げておりますので、下のリンク先もご参照いただければと思います。<br><a href="https://jpaztech.github.io/blog/archive/application-gateway-502-error-info/">Application Gateway における 502 Error について</a><br><a href="https://jpaztech.github.io/blog/network/appgw-502error/">Application Gateway の散発的な 502 エラー</a></p><h4 id="504-ゲートウェイ-タイムアウト-処理時間の長い-Web-アプリケーションで発生することが多い"><a href="#504-ゲートウェイ-タイムアウト-処理時間の長い-Web-アプリケーションで発生することが多い" class="headerlink" title="- 504 - ゲートウェイ タイムアウト (処理時間の長い Web アプリケーションで発生することが多い)"></a>- 504 - ゲートウェイ タイムアウト (処理時間の長い Web アプリケーションで発生することが多い)</h4><p>バックエンド サーバーからの応答時間が、「要求のタイムアウト」値 (既定値 : 20 秒) を超えた場合には、HTTP 504 エラーが発生します。問題判別の方法としては、</p><ol><li>バックエンド サーバー側にて、ログをご確認いただき、Application Gateway からのリクエストに対して、バックエンド サーバーが「要求のタイムアウト」値を超えてレスポンスを返していないかどうか確認してください。</li><li>リクエスト受信からレスポンス送信までが 20 秒を超える場合には、「<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502#request-time-out">要求のタイムアウト</a>」の値を、アプリケーションの処理時間に合わせて、変更してください。(「要求のタイムアウト」の値は、1 ～ 86400 の範囲で設定可能) </li></ol><div class="alert is-success"><p class="alert-title">ヒント</p><p>IIS がバックエンド サーバーの場合には、下のリンク先をご参照いただき、IIS ログをご確認ください。</p><p><a href="https://jpdsi.github.io/blog/web-apps/LogCollection1/#2-IIS-%E3%83%AD%E3%82%B0">IIS の調査に必要な基本的なログ情報について</a></p></div><h4 id="500-内部サーバー-エラー-Application-Gateway-が原因"><a href="#500-内部サーバー-エラー-Application-Gateway-が原因" class="headerlink" title="- 500 - 内部サーバー エラー (Application Gateway が原因)"></a>- 500 - 内部サーバー エラー (Application Gateway が原因)</h4><p>この応答コードは、Application Gateway の内部でエラーが発生したことを示すものです。このコードが表示された場合は、サポート リクエストを起票してください。</p><div class="alert is-important"><p class="alert-title">重要</p><p>サポート リクエスト起票の際には、下記の情報を添えてお問い合わせいただければと思います。</p><p>・問題発生日時 (mm/dd hh:mm:ss)</p><p>・Application Gateway のリソース ID</p><p>・クライアントの情報 (パブリック IP アドレス等、仮想マシンの場合は リソース ID)</p><p>・アクセスした URL</p><p>・HTTP 応答コード</p><p>・お客様にて行った問題判別の内容や確認の結果 (例 : バックエンド サーバーのログの確認結果等)</p><p>・問題発生の前後にて Application Gateway やバックエンド サーバーにて行った設定変更内容 (もしあれば) </p></div><p>当ブログが、お客様よりお問い合わせをいただくことが多い 500 番台の HTTP 応答が発生した場合に、お客様にて問題判別を行う際の手助けになりましたら、幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームの間島です。&lt;/p&gt;
&lt;p&gt;今回は、Application Gateway 経由で Web サイトへアクセスしている際に、Application Gateway からの HTTP 応答でエラーが発生した場合の原因や調査方法などについて</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Error" scheme="https://jpaztech.github.io/blog/tags/Error/"/>
    
    <category term="500" scheme="https://jpaztech.github.io/blog/tags/500/"/>
    
  </entry>
  
  <entry>
    <title>Azure Firewall Premium における TLS 検査用の中間 CA 証明書作成方法の違い</title>
    <link href="https://jpaztech.github.io/blog/network/fw-tls-cert/"/>
    <id>https://jpaztech.github.io/blog/network/fw-tls-cert/</id>
    <published>2024-02-20T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.685Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの中野です。<br>本ブログでは、Azure Firewall Premium でご利用いただける「TLS 検査」に用いる中間 CA 証明書の作成方法の違いについてご案内いたします。</p><span id="more"></span><h2 id="中間-CA-証明書の要件"><a href="#中間-CA-証明書の要件" class="headerlink" title="中間 CA 証明書の要件"></a>中間 CA 証明書の要件</h2><p>まず前提として、Azure Firewall の観点では、Azure Firewall が参照する中間 CA 証明書によって、TLS 検査を行うためのサーバー証明書が作成できるのであれば、中間 CA 証明書を発行した CA の種別は問いません。  </p><ul><li>参考: <a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates#certificates-used-by-azure-firewall-premium">Azure Firewall Premium によって使用される証明書</a></li></ul><blockquote><p>Azure Firewall Premium の TLS 検査を適切に構成するには、有効な中間 CA 証明書を用意し、それを Azure Key Vault に格納する必要があります。</p></blockquote><p>上記で抜粋した <code>有効な中間 CA 証明書</code> に関しまして、Azure Firewall の TLS 検査に必要な中間 CA 証明書の要件は下記のドキュメントの通りとなります。<br>こちらの要件を満たした中間 CA 証明書であれば、どの CA から発行されたものであっても、検証環境 / 運用環境を問わずご使用いただくことが可能です。</p><ul><li>参考: <a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates#intermediate-ca-certificate-requirements">中間 CA 証明書の要件</a></li></ul><blockquote><p>・Key Vault シークレットとしてデプロイする場合、証明書と秘密キーを使用するパスワードレス PFX (PKCS12) を使用する必要があります。<br>・PEM 証明書はサポートされていません。<br>・単一の証明書でなければならず、証明書チェーン全体を含めることはできません。<br>・今後 1 年間有効でなければなりません。<br>・最小サイズが 4096 バイトである RSA 秘密キーでなければなりません。<br>・KeyCertSign フラグによって Critical とマーク付けされた KeyUsage 拡張が必要です (RFC 5280、4.2.1.3 Key Usage)。<br>・Critical とマーク付けされた BasicConstraints 拡張が必要です (RFC 5280、4.2.1.9 Basic Constraints)。<br>・CA フラグが TRUE に設定されている必要があります。<br>・パスの長さは 1 以上でなければなりません。<br>・証明書はエクスポートできる必要があります。  </p></blockquote><h2 id="TLS-検査でご利用いただける証明書について"><a href="#TLS-検査でご利用いただける証明書について" class="headerlink" title="TLS 検査でご利用いただける証明書について"></a>TLS 検査でご利用いただける証明書について</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates">こちら</a> のドキュメントに記載の通り、TLS 検査で使用可能な中間 CA 証明書は下記の 3 つの方法で作成していただけます。</p><ol><li>エンタープライズ PKI</li><li>openssl コマンドによる手動生成 </li><li>Azure Firewall による自動生成</li></ol><p>以下の表は 3 つの方法の簡単な比較表となります。 </p><p><img src="/blog/network/fw-tls-cert/azfwtls_table.png"> </p><p>下記にそれぞれの生成方法についての詳細をご説明いたします。 </p><h2 id="1-エンタープライズ-PKI"><a href="#1-エンタープライズ-PKI" class="headerlink" title="(1) エンタープライズ PKI"></a>(1) エンタープライズ PKI</h2><p>エンタープライズ PKI としては「エンタープライズ CA」と「スタンドアロン CA」が存在します。  </p><h3 id="1-1-エンタープライズ-CA-こちらを用いた証明書作成手順の詳細は、ドキュメント-に記載がございます"><a href="#1-1-エンタープライズ-CA-こちらを用いた証明書作成手順の詳細は、ドキュメント-に記載がございます" class="headerlink" title="(1-1) エンタープライズ CA  (こちらを用いた証明書作成手順の詳細は、ドキュメント に記載がございます)"></a>(1-1) エンタープライズ CA  (こちらを用いた証明書作成手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-deploy-certificates-enterprise-ca">ドキュメント</a> に記載がございます)</h3><ul><li>オンプレミスの Active Directory 環境でのみ構築可能 （Azure AD DS 環境では Enterprise Admins の権限を保有できないため構築不可）  </li><li>作成された証明書は配布作業を行わなくとも AD ドメインに参加している各クライアント端末において、デフォルトで「信頼された証明書」となる  </li><li>企業内のプライベート CA であるため、少なくとも企業内においては信頼された CA であると認識され、これによって発行された証明書は自己署名証明書よりもセキュリティ面で優位であると認識される  </li><li>証明書の有効期限は任意に設定可能</li></ul><h3 id="1-2-スタンドアロン-CA"><a href="#1-2-スタンドアロン-CA" class="headerlink" title="(1-2) スタンドアロン CA"></a>(1-2) スタンドアロン CA</h3><ul><li>Azure AD DS 環境でも構築可能</li><li>証明書テンプレートが使用できない</li><li>デフォルトではクライアント端末において「信頼された証明書」ではないため、各クライアント端末にルート証明書の配布が必要</li><li>作成された証明書は グループ ポリシー (GPO) を用いてドメイン参加している各クライアント端末に一括配布可能**</li><li>企業内のプライベート CA であるため、少なくとも企業内においては信頼された CA であると認識され、これによって発行された証明書は自己署名証明書よりもセキュリティ面で優位であると認識される  </li><li>証明書の有効期限は任意に設定可能  </li></ul><p>**参考: <a href="https://learn.microsoft.com/ja-jp/windows-server/identity/ad-fs/deployment/distribute-certificates-to-client-computers-by-using-group-policy">グループ ポリシーを使用してクライアント コンピューターに証明書を配布する</a>  </p><h2 id="3-openssl-コマンドによる手動生成"><a href="#3-openssl-コマンドによる手動生成" class="headerlink" title="(3) openssl コマンドによる手動生成"></a>(3) openssl コマンドによる手動生成</h2><ul><li>自己署名証明書である</li><li>デフォルトではクライアント端末において「信頼された証明書」ではないため、各クライアント端末にルート証明書の配布が必要</li><li>作成された証明書は グループ ポリシー (GPO) を用いてドメイン参加している各クライアント端末に一括配布可能</li><li>証明書の有効期限は任意に設定可能</li></ul><h2 id="4-Azure-Firewall-による自動生成"><a href="#4-Azure-Firewall-による自動生成" class="headerlink" title="(4) Azure Firewall による自動生成"></a>(4) Azure Firewall による自動生成</h2><ul><li>自己署名証明書である</li><li>検証環境での使用を想定しているので、作成されるのはルート証明書である</li><li>デフォルトではクライアント端末において「信頼された証明書」ではないため、各クライアント端末にルート証明書の配布が必要</li><li>作成されたルート CA 証明書を Key Vault からエクスポートすることで、グループ ポリシー (GPO) を用いてドメイン参加している各クライアント端末に一括配布可能</li><li>新規に Key Vault、マネージド ID のリソースが作成される (既存のリソースは使用不可)</li><li>証明書の有効期限は 1 年固定 (1 年ごとに証明書の更新を行う必要があるので、1 年ごとに GPO で証明書の配布が必要)</li></ul><br>以上、ご参考になれば幸いです。<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates">Azure Firewall Premium の証明書</a></li><li><a href="https://techcommunity.microsoft.com/t5/azure-network-security-blog/building-a-poc-for-tls-inspection-in-azure-firewall/ba-p/3676723">HBuilding a POC for TLS inspection in Azure Firewall</a></li></ul><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの中野です。&lt;br&gt;本ブログでは、Azure Firewall Premium でご利用いただける「TLS 検査」に用いる中間 CA 証明書の作成方法の違いについてご案内いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="Certificate" scheme="https://jpaztech.github.io/blog/tags/Certificate/"/>
    
  </entry>
  
  <entry>
    <title>プライベート エンドポイントをご利用いただく上でのポイント</title>
    <link href="https://jpaztech.github.io/blog/network/pe-introduction/"/>
    <id>https://jpaztech.github.io/blog/network/pe-introduction/</id>
    <published>2024-02-20T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.693Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。<br>Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。</p><ol><li>プライベート エンドポイントをご利用いただく上でのポイント  (今回のご紹介)</li><li><a href="/blog/network/pe-troubleshooting/">プライベート エンドポイントのよくあるお問い合わせ</a></li></ol><span id="more"></span><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>プライベート エンドポイントは主に Azure PaaS に対して、仮想ネットワーク上のアドレス空間のプライベート IP アドレスを用いて接続を提供するサービスです。<br>プライベート エンドポイントをご利用いただけば、Azure PaaS に対して、ExpressRoute や VPN で接続されたオンプレミスからもインターネット経由ではなく仮想ネットワーク経由で接続が可能です。<br>またこのブログでは紹介しませんが、Azure Load Balancer に対して適用できる <a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-link-service-overview">Private Link Service</a> をご利用いただけば、アドレス空間が重複した仮想ネットワーク間でも接続が可能です。<br>類似機能のプライベート エンドポイントとサービス エンドポイントの違いについては、<a href="/blog/network/pe-difference-se/">別のブログ</a> で紹介していますのでご参照いただければと思います。</p><h2 id="基本動作"><a href="#基本動作" class="headerlink" title="基本動作"></a>基本動作</h2><p>Azure PaaS は基本的にパブリック インターネットからの接続を前提としています。また、ほとんどの Azure PaaS がマルチテナント構成となり、ご利用時に接続する際は、対象の Azure PaaS に該当する FQDN で接続します。<br>プライベート エンドポイントは仮想ネットワーク上にエンドポイントを構成することで、Azure PaaS にプライベート IP アドレスで接続する機能を提供していますが、クライアントが接続する際の FQDN は変わりません。<br>プライベート エンドポイントは、あくまで Azure PaaS への接続点を仮想ネットワーク上に構成するものであり、Azure PaaS へのプライベート接続は DNS レイヤーのルーティングで実現しています。<br>この時、DNS レイヤーのルーティングを privatelink サブドメインが付与された FQDN を用いて実施します。<br>つまり、プライベート エンドポイントをご利用いただく上で、DNS レイヤーの構成が大変重要な要素になります。</p><h2 id="DNS-レコードの遷移"><a href="#DNS-レコードの遷移" class="headerlink" title="DNS レコードの遷移"></a>DNS レコードの遷移</h2><p>Azure PaaS のプライベート エンドポイントを有効化することで、具体的にどのような変化が発生するのかをご紹介します。<br>ここでは東日本リージョンの Azure Blob Storage の FQDN (jpaztechpeblog.blob.core.windows.net) の DNS レコードの遷移をご紹介します。<br>なお説明の便宜上、dig コマンドで応答された ANSWER SECTION の表示を基にご紹介します。</p><p>まず、プライベート エンドポイントが有効化されていない Azure Blob Storage の FQDN を名前解決した時、下記のような DNS レコードが応答されます。下記の応答結果から、Azure Blob Storage に接続時の FQDN が、Azure Blob Storage のエンドポイントに CNAME レコードで変換され、その後 A レコードでパブリック IP アドレスが応答されることが確認できます。</p><blockquote><p>jpaztechpeblog.blob.core.windows.net. 60 IN CNAME blob.tyo20prdstr07a.store.core.windows.net.<br>blob.tyo20prdstr07a.store.core.windows.net. 60 IN A 20.60.248.65</p></blockquote><p>次に、Azure Blob Storage に対して、プライベート エンドポイントを有効化した時の DNS レコードの応答を確認します。<br>下記の応答結果から、プライベート エンドポイントが有効化された後に、<strong>privatelink サブドメイン</strong>が付与された FQDN が追加されたことが確認できます。</p><blockquote><p>jpaztechpeblog.blob.core.windows.net. 60 IN CNAME jpaztechpeblog.<strong>privatelink</strong>.blob.core.windows.net.<br>jpaztechpeblog.<strong>privatelink</strong>.blob.core.windows.net. 60 IN CNAME blob.tyo20prdstr07a.store.core.windows.net.<br>blob.tyo20prdstr07a.store.core.windows.net. 60 IN A 20.60.248.65</p></blockquote><p>上記の DNS レコードの遷移や応答結果は、ご利用いただくリージョンや各 Azure PaaS によっては細部が異なりますが、基本的には上記の例が大多数となっています。<br>各 Azure PaaS の FQDN がどのように遷移するかは<a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns">プライベート エンドポイントの公開情報</a> でご紹介しています。<br>なお、Azure PaaS によってはすべてのユーザーに同一の FQDN でエンドポイントを提供している下記のようなサービスもあり、この場合既定で privatelink サブドメインが付与されています。</p><p>・Azure Virtual Desktop : rdweb.wvd.microsoft.com / <foo>www</foo>.wvd.microsoft.com / client.wvd.microsoft.com </br><br>・Azure Synapse : web.azuresynapse.net </br><br>・Azure Data Factory : adf.azure.com </br></p><h2 id="DNS-ルーティング"><a href="#DNS-ルーティング" class="headerlink" title="DNS ルーティング"></a>DNS ルーティング</h2><p>Azure PaaS への接続をパブリック エンドポイントからプライベート エンドポイントに切り替えるには、DNS レイヤーの構成が重要になります。<br>この DNS レイヤーのルーティングについてご紹介します。<br>ここでは Azure の仮想ネットワーク上に仮想マシンをデプロイし、Azure Blob Storage に接続するシナリオを例に挙げて、DNS ルーティングについて説明します。</p><p>通常の Azure Blob Storage に接続する場合、下記の構成図のように接続時の FQDN に対してパブリック IP アドレスが応答され、クライアントは該当のパブリック IP アドレスに接続を試行します。</p><p><img src="/blog/network/pe-introduction/01.png" alt="通常の接続"></p><p>プライベート エンドポイントを有効化した際に、既定の設定では対象の Azure PaaS に対応するプライベート DNS ゾーンが構成されます。プライベート DNS ゾーンは仮想ネットワークとリンクすることで、Azure 既定の DNS (168.63.129.16) を参照しているクライアントに、構成したゾーンの DNS レコードを応答するサービスです。<br>Azure Blob Storage の場合、privatelink.blob.core.windows.net が該当ゾーンとしてデプロイされ、対象のホスト名に対して設定された A レコードが応答されます。これにより、仮想マシンはプライベート エンドポイントに対して Azure Blob Storage の FQDN の接続を試行します。<br>このように、プライベート DNS ゾーンを用いて privatelink サブドメインの DNS レコードをオーバーライドすることで、DNS ルーティングを実現します。</p><p><img src="/blog/network/pe-introduction/02.png" alt="PE経由の接続"></p><p>なお、プライベート エンドポイントの利用にあたり、プライベート DNS ゾーンの利用は必須ではありません。DNS レコードのオーバーライドができれば hosts ファイル、カスタム DNS、オンプレミスの DNS などでも DNS ルーティングが実現可能です。<br>例えば、仮想マシンの OS 上の hosts ファイルで、接続先の FQDN に対して、プライベート エンドポイントの IP アドレスを指定することでも構成可能です。</p><p>以上がプライベート エンドポイントの仕組みとなります。実際にご利用いただく中で、よくお問い合わせいただく内容や情報採取については、<a href="/blog/network/pe-troubleshooting/">こちら</a> をご覧ください。　</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。&lt;br&gt;Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;プライベート エンドポイントをご利用いただく上でのポイント  (今回のご紹介)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/blog/network/pe-troubleshooting/&quot;&gt;プライベート エンドポイントのよくあるお問い合わせ&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
    <category term="PrivateEndpoint" scheme="https://jpaztech.github.io/blog/tags/PrivateEndpoint/"/>
    
  </entry>
  
  <entry>
    <title>プライベート エンドポイントのよくあるお問い合わせ</title>
    <link href="https://jpaztech.github.io/blog/network/pe-troubleshooting/"/>
    <id>https://jpaztech.github.io/blog/network/pe-troubleshooting/</id>
    <published>2024-02-20T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.693Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。<br>Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。<br>Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。</p><ol><li><a href="/blog/network/pe-introduction/">プライベート エンドポイントをご利用いただく上でのポイント</a></li><li>プライベート エンドポイントのよくあるお問い合わせ (今回のご紹介)</li></ol><span id="more"></span><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>プライベート エンドポイントをご利用いただく上で、DNS レイヤーの構成がポイントになる点について、<a href="/blog/network/pe-introduction/">こちら</a>でご紹介しました。<br>今回は実際に構成する上でのよくあるトラブル事例や、Azure サポートにお問い合わせいただく際に情報提供いただきたい事項などを纏めました。</p><h2 id="情報採取"><a href="#情報採取" class="headerlink" title="情報採取"></a>情報採取</h2><p>プライベート エンドポイントのトラブルシューティングでは、DNS 構成を確認するために、クライアントの名前解決の状況を確認することが重要です。<br>そのため、Azure サポート担当にお問い合わせ時に下記の点について情報提供いただけると幸いです。</p><blockquote><p><strong>・接続元のクライアント情報</strong></br><br><strong>・接続先のプライベート エンドポイントのリソース情報</strong></br><br><strong>・接続経路</strong></br><br><strong>・接続元クライアントの DNS 構成</strong></br><br><strong>・接続元クライアントの名前解決の状況</strong></br></p></blockquote><p>上記についてそれぞれ補足致します。</p><blockquote><p><strong>・接続元クライアント情報</strong></p></blockquote><p>接続元クライアントが Azure 仮想マシンなど Azure 上のリソースであれば、該当の Azure リソース ID をご提供ください。<br>もしオンプレミス上の機器が接続元クライアントとなる場合、オンプレミスである旨と接続元クライアントの IP アドレスをご提供ください。</p><blockquote><p><strong>・接続先のプライベート エンドポイントのリソース情報</strong></p></blockquote><p>お問合せ時に対象のプライベート エンドポイントのリソースを選択可能な場合は、選択いただければ Azure サポート担当は対象のリソース情報を確認できます。<br>対象のプライベート エンドポイントのリソースを選択してお問い合わせが難しい場合、プライベート エンドポイントのリソース ID をご提供ください。</p><blockquote><p><strong>・接続経路</strong></p></blockquote><p>想定されている接続元クライアントからプライベート エンドポイントの接続経路についてご提供ください。<br>例えばオンプレミスからの接続の場合は ExpressRoute をご利用いただいている旨や、Azure Firewall で通信制御をされている、プロキシ サーバーをご利用いただいているなどの情報をご提供いただけると幸いです。</p><blockquote><p><strong>・接続元クライアントの DNS 構成</strong></p></blockquote><p>DNS 構成として hosts、オンプレミスの DNS サーバー、Azure DNS Private Resolver 、カスタム DNS など複数の構成方法がありますが、接続元クライアントのご状況に合わせて情報をご提供ください。<br>例えば、hosts で制御している場合は該当の hosts ファイルも併せてご提供いただけると幸いです。<br>接続元クライアントがオンプレミスの DNS サーバーを参照している場合、オンプレミスの DNS サーバーから Azure へのクエリ転送設定 (フォワーダー・条件付きフォワーダー) の状況も併せてご提供ください。<br>また、Azure DNS Private Resolver をご利用いただいている場合は、リソース ID をご提供ください。</p><blockquote><p><strong>・接続元クライアントの名前解決の状況</strong></p></blockquote><p>接続元クライアントの名前解決の確認方法はクライアントの実行環境によって異なります。<br>Azure サポート担当での調査では、下記の情報の提供をお願いする場合がありますため、事前にご提供いただけると幸いです。<br>(お客様の環境に沿って FQDN をご変更ください。)</p><p><strong>・ &lt;推奨&gt; PowerShell</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-Date -Format &quot;yyyy/MM/dd HH:mm:ss K&quot;</span><br><span class="line">Test-NetConnection contoso.blob.core.windows.net -port 443 </span><br><span class="line">Resolve-DnsName -name contoso.blob.core.windows.net</span><br><span class="line">nslookup -debug contoso.blob.core.windows.net</span><br><span class="line">Invoke-WebRequest -URI https://contoso.blob.core.windows.net/</span><br></pre></td></tr></table></figure><p>・ dig (Linux)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">date -u</span><br><span class="line">dig contoso.blob.core.windows.net</span><br><span class="line">curl -v contoso.blob.core.windows.net</span><br></pre></td></tr></table></figure><p>なお、パブリック インターネット上で名前解決の状況を確認する場合は、<a href="https://digwebinterface.com/">https://digwebinterface.com/</a> などでカスタマイズしたクエリが実行可能です。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>プライベート エンドポイントに関して、よくお問い合わせいただく内容について下記の通りお伝えいたします。</p><h3 id="プライベート-エンドポイントの-IP-アドレスの仕様について教えてください。"><a href="#プライベート-エンドポイントの-IP-アドレスの仕様について教えてください。" class="headerlink" title="プライベート エンドポイントの IP アドレスの仕様について教えてください。"></a>プライベート エンドポイントの IP アドレスの仕様について教えてください。</h3><p>プライベート エンドポイントの IP アドレスは動的・静的での割り当てが選択できます。<br>動的の割り当ての場合、プライベート エンドポイントをデプロイする対象サブネットのプレフィックスの範囲内で、基本的に若番から割り当てがされます。<br>静的の割り当ての場合、対象サブネットの範囲で任意の IP アドレスを指定可能です。<br>動的の割り当てを選択された場合でも、プライベート エンドポイントのリソースを削除しない限り、一度割り当てられた IP アドレスは変わりません。</p><h3 id="プライベート-DNS-ゾーンを同時に作ったが、プライベート-エンドポイントの-IP-アドレスの名前解決ができません。"><a href="#プライベート-DNS-ゾーンを同時に作ったが、プライベート-エンドポイントの-IP-アドレスの名前解決ができません。" class="headerlink" title="プライベート DNS ゾーンを同時に作ったが、プライベート エンドポイントの IP アドレスの名前解決ができません。"></a>プライベート DNS ゾーンを同時に作ったが、プライベート エンドポイントの IP アドレスの名前解決ができません。</h3><p>プライベート DNS ゾーンに適切な DNS レコードを設定したにも関わらず、名前解決ができない場合は下記の理由が考えられます。</p><p>　　<strong>A プライベート DNS ゾーンが、クライアントが存在する仮想ネットワークとリンク設定されていない。</strong></br><br>　　<strong>B プライベート DNS ゾーンが参照されない構成になっている。</strong></br><br>　　<strong>C プライベート DNS ゾーン上に必要な DNS レコードが存在していない。</strong></br></p><p><strong>A</strong></br><br>プライベート DNS ゾーンは、リンクされた仮想ネットワーク上のリソースに対して、登録されたゾーン上の DNS レコードに関して名前解決を提供します。そのため、プライベート DNS ゾーンのリソースから対象の<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-virtual-network-links">仮想ネットワークにリンク設定</a>を忘れないようにしてください。</p><p><strong>B</strong></br><br>プライベート DNS ゾーンを参照するためには、Azure 既定の DNS サーバー (168.63.129.16) に DNS クエリを転送する必要があります。オンプレミスのリソースからプライベート DNS ゾーンを参照する場合は、Azure DNS Private Resolver をご利用いただき、オンプレミスの DNS サーバーから条件付きフォワーダーなどで参照できるように構成してください。構成事例は<a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns-integration">こちら</a>にあります。</p><p><strong>C</strong></br><br>プライベート DNS ゾーンは、リソース グループ内で重複がなければ同一ゾーン名で複数構成が可能です。プライベート エンドポイントを構成時に DNS 統合した場合、自動で DNS レコードがプライベート DNS ゾーン上に構成されますが、この時対象のプライベート DNS ゾーンが異なるとクライアントが接続先の FQDN の名前解決ができなくなる場合があります。</p><h3 id="プライベート-DNS-ゾーンや-Azure-既定の-DNS-サーバーの名前解決のログを確認したい。"><a href="#プライベート-DNS-ゾーンや-Azure-既定の-DNS-サーバーの名前解決のログを確認したい。" class="headerlink" title="プライベート DNS ゾーンや Azure 既定の DNS サーバーの名前解決のログを確認したい。"></a>プライベート DNS ゾーンや Azure 既定の DNS サーバーの名前解決のログを確認したい。</h3><p>ご期待に沿えず恐れ入りますが、現状該当 DNS ログを Azure ユーザーが確認する方法はございません、<br>Azure サポート担当にご依頼いただければ、該当ログの調査支援が可能ですが、ログの調査をするには対象の FQDN と調査対象の時刻を可能な限り具体的にご提示願います。<br>なお、Azure 既定の DNS のログは、30 日程度でローテーションされ、過去のログは参照できない点はご留意ください。</p><h3 id="hosts-を使った-DNS-構成は非推奨とありますが、サポート外ですか？"><a href="#hosts-を使った-DNS-構成は非推奨とありますが、サポート外ですか？" class="headerlink" title="hosts を使った DNS 構成は非推奨とありますが、サポート外ですか？"></a>hosts を使った DNS 構成は非推奨とありますが、サポート外ですか？</h3><p>プライベート エンドポイントは、最終的に接続元クライアントが適切な名前解決ができれば接続可能なため、プライベート エンドポイントをご利用いただく上で hosts を利用いただくことがサポート外といった事はございません。そのため、トラブルシューティングの対応の一環でサポート担当から hosts への追加を依頼する場合があります。<br><br>しかしながら、hosts はクライアント端末毎に手動での個別管理となりますため、プライベート エンドポイントの作り直しによる IP アドレスの更新や新規エンドポイントの追加などが自動で適応されません。構成変更時などで hosts の更新漏れによる意図せぬ通信影響を回避するためにも、運用環境では hosts による構成は推奨していません。</p><h3 id="privatelink-サブドメインで-Azure-PaaS-に接続ができないのはなぜですか？"><a href="#privatelink-サブドメインで-Azure-PaaS-に接続ができないのはなぜですか？" class="headerlink" title="privatelink サブドメインで Azure PaaS に接続ができないのはなぜですか？"></a>privatelink サブドメインで Azure PaaS に接続ができないのはなぜですか？</h3><p>プライベート エンドポイントをご利用いただく上での<a href="/blog/network/pe-introduction/">ポイント</a> にも記載の通り、Azure PaaS にプライベート エンドポイント接続をする構成でも、接続時にご利用いただく FQDN は、Azure PaaS の既定のドメインが対象となります。<br>DNS レイヤーでルーティングができるように、privatelink サブドメインが追加されますが、この privatelink サブドメインが付与された FQDN で Azure PaaS に接続することは想定されていないため、接続エラーや証明書エラーが発生します。</p><h3 id="任意のドメイン-カスタムドメイン-を利用して-Azure-PaaS-にプライベート-エンドポイント接続が可能ですか？"><a href="#任意のドメイン-カスタムドメイン-を利用して-Azure-PaaS-にプライベート-エンドポイント接続が可能ですか？" class="headerlink" title="任意のドメイン (カスタムドメイン) を利用して Azure PaaS にプライベート エンドポイント接続が可能ですか？"></a>任意のドメイン (カスタムドメイン) を利用して Azure PaaS にプライベート エンドポイント接続が可能ですか？</h3><p>プライベート エンドポイントは、Azure PaaS への接続点を提供しているものであり、ドメイン管理などの機能は持ち合わせていません。<br>そのため、カスタムドメインをご利用いただけるかは、ご利用される Azure PaaS の機能に依存し、カスタムドメインをご利用いただく場合は対象の FQDN の名前解決が、プライベート エンドポイントの IP アドレスに解決されるように DNS 構成を実施いただく必要があります。</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。&lt;br&gt;Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。&lt;br&gt;Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/blog/network/pe-introduction/&quot;&gt;プライベート エンドポイントをご利用いただく上でのポイント&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;プライベート エンドポイントのよくあるお問い合わせ (今回のご紹介)&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
    <category term="PrivateEndpoint" scheme="https://jpaztech.github.io/blog/tags/PrivateEndpoint/"/>
    
  </entry>
  
  <entry>
    <title>Azure Peering Service と ExpressRoute の違いについて</title>
    <link href="https://jpaztech.github.io/blog/network/azure-peering-service-vs-expressroute/"/>
    <id>https://jpaztech.github.io/blog/network/azure-peering-service-vs-expressroute/</id>
    <published>2024-01-29T01:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.677Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートの宇田です。<br>今回は Azure Peering Service と ExpressRoute の違いについてご紹介いたします。</p><h2 id="Azure-Peering-Service-とはどのようなサービスか"><a href="#Azure-Peering-Service-とはどのようなサービスか" class="headerlink" title="Azure Peering Service とはどのようなサービスか"></a>Azure Peering Service とはどのようなサービスか</h2><p>Microsoft Azure Peering Service (MAPS) は、インターネット サービス プロバイダー (ISP) や Internet Exchange (IX) 経由で Microsoft のグローバル ネットワーク (AS8075) へのルーティングを最適化し信頼性とパフォーマンスを強化するサービスです。サービス名に “Azure” の名前を冠してはいますが、その接続先は Azure だけではなく、パブリック インターネット経由でアクセス可能な Microsoft 365 や Dynamics 365 等を含んだ Microsoft のグローバル ネットワーク全体になります。</p><p>また、以下のドキュメントにも記載がありますが、Azure Peering Service は閉域接続 (プライベート接続) サービスではありません。あくまでも ISP や IX 経由で直接 Microsoft のネットワークに接続するサービスですので、他の AS を経由しない分だけホップ数や遅延が小さく抑えられ、通信経路上の影響を受けにくいというのみであり、位置づけとしてはパブリック ネットワーク (≒インターネット) 経由での接続となります。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/peering-service/about">Azure Peering Service の概要</a></li></ul><h2 id="ExpressRoute-の-Microsoft-Peering-と何が違うのか"><a href="#ExpressRoute-の-Microsoft-Peering-と何が違うのか" class="headerlink" title="ExpressRoute の Microsoft Peering と何が違うのか"></a>ExpressRoute の Microsoft Peering と何が違うのか</h2><p>Azure Peering Service と似たサービスとして、ExpressRoute 回線 (ExpressRoute Circuit) の Microsoft Peering が存在します。両者の違いについてお問い合わせいただく事も多いため、具体的な差異を以下の表でご説明します。</p><table><thead><tr><th></th><th>Azure Peering Service</th><th>ExpressRoute (Microsoft Peering)</th></tr></thead><tbody><tr><td>接続先</td><td>Microsoft のグローバル ネットワーク</td><td>主に Azure のみ</td></tr><tr><td>Microsoft 側の ASN</td><td>8075</td><td>12076</td></tr><tr><td>接続形態</td><td>パブリック接続 (≒インターネット)</td><td>プライベート接続 (≒閉域網)</td></tr><tr><td>Azure VNet への接続</td><td>不可</td><td>Private Peering を構成すれば可能</td></tr><tr><td>Microsoft 365 との接続 <a href="#Microsoft-365-%E3%81%A8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AB%E9%96%A2%E3%81%97%E3%81%A6">(*)</a></td><td>可能</td><td>一部の承認されたお客様のみ可能</td></tr><tr><td>Azure 上のリソース <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>テレメトリ機能を利用する場合のみ作成</td><td>ExpressRoute 回線リソースを作成</td></tr><tr><td>接続料金 <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>原則、接続プロバイダー様のみにお支払い</td><td>Azure と接続プロバイダー様の双方にお支払い</td></tr><tr><td>SLA <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>接続プロバイダー様にご確認ください</td><td>MSEE 側の問題であれば Microsoft 側の SLA 有り</td></tr><tr><td>サポート窓口 <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>原則、接続プロバイダー様</td><td>Azure (MSEE) 側は Microsoft、PE 側は接続プロバイダー様</td></tr></tbody></table><h3 id="Microsoft-365-との接続に関して"><a href="#Microsoft-365-との接続に関して" class="headerlink" title="(*) Microsoft 365 との接続に関して"></a>(*) Microsoft 365 との接続に関して</h3><p><a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/azure-expressroute">Azure ExpressRoute for Microsoft 365</a> に以下の記載がある通り、ExpressRoute での Microsoft 365 への接続は承認制となっています。法規制により閉域接続が必須となっているような一部のお客様に限ってのみ承認され、そうした特殊な要件がない場合にはご利用いただけません。<strong>Microsoft 365 との安定した接続を確保したい一般のお客様は、Azure Peering Service での接続をご検討ください。</strong>(ただし、前述の通り Azure Peering Service は閉域接続のためのサービスではございませんのでご留意ください。)</p><blockquote><p><strong>Microsoft 365 の ExpressRoute は、ほとんどの状況でサービスに最適な接続モデルを提供しないため 、お勧めしません。</strong> そのため、この接続モデルを使用するには Microsoft の承認が必要です。 お客様のすべての要求を確認し、必要なまれなシナリオでのみ、Microsoft 365 の ExpressRoute を承認します。 詳細については 、<a href="https://aka.ms/erguide">ExpressRoute for Microsoft 365 ガイド</a> を参照してください。また、生産性、ネットワーク、セキュリティ チームに関するドキュメントの包括的なレビューに従って、Microsoft アカウント チームと協力して、必要に応じて例外を送信してください。 Microsoft 365 のルート フィルターを作成しようとしている未承認のサブスクリプションには、 <a href="https://support.microsoft.com/kb/3181709">エラー メッセージが表示</a>されます。</p></blockquote><p>また、Microsoft 365 は Internet 経由で快適にご利用いただけるよう弊社外の 3rd party の CDN サービス等も利用しているため、ExpressRoute と Azure Peering Service のいずれを利用される場合であっても、弊社外のエンドポイントとの通信に Internet 接続が必要となりますので、十分ご留意ください。</p><h3 id="Microsoft-の関与する範囲について"><a href="#Microsoft-の関与する範囲について" class="headerlink" title="(**) Microsoft の関与する範囲について"></a>(**) Microsoft の関与する範囲について</h3><p>ExpressRoute をご利用の場合には、Azure 上で ExpressRoute 回線のリソースを作成したり、各種設定をご実施いただきます。他方で Azure Peering Service に関しては、(テレメトリの機能を利用しない限りは) Azure 上のリソースは作成したり、設定を行っていただく必要はなく、ExpressRoute 回線のように Microsoft に対して接続料金をお支払いいただくことはありません。言い換えますと、仮に通信障害などが発生したとしても、Microsoft としては料金を頂戴していないため、SLA による返金はございません。(接続プロバイダー様による SLA の提供有無をご確認ください。)</p><p>また、Azure 側に個々のお客様のリソースが存在せず、各接続プロバイダー様とお客様間の契約情報なども弊社では把握できないことから、障害時に Microsoft 側へお問い合わせいただいたとしても環境固有の調査などを行うことができません。したがって、トラブル時のお問い合わせ先 (サポート窓口) は原則として Microsoft ではなく、接続プロバイダー様となります。(接続プロバイダー様によって Microsoft 側に問題があると判断された場合には、接続プロバイダー様と弊社の NOC 間で調査を行うこととなります。)</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure サポートの宇田です。&lt;br&gt;今回は Azure Peering Service と ExpressRoute の違いについてご紹介いたします。&lt;/p&gt;
&lt;h2 id=&quot;Azure-Peering-Service-とはどのようなサービスか&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="Azure Peering Service" scheme="https://jpaztech.github.io/blog/tags/Azure-Peering-Service/"/>
    
  </entry>
  
  <entry>
    <title>設定変更不可の項目を VM 再作成により再設定する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/recreate-vm-to-change-settings/"/>
    <id>https://jpaztech.github.io/blog/vm/recreate-vm-to-change-settings/</id>
    <published>2024-01-25T08:00:00.000Z</published>
    <updated>2024-03-21T03:28:49.005Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの藤澤です。 </p><p>Azure VM のいくつかの設定項目は、VM 作成後は変更いただくことが叶いませんが、OS / データディスクを保持したまま、VM を再作成いただくことで再作成時に変更することが可能でございます。<br>本記事では、通常変更不可である設定項目を、VM を再作成で変更する手順についてご案内します。 </p><span id="more"></span><hr><h2 id="■再作成が必要となるシナリオ一覧紹介"><a href="#■再作成が必要となるシナリオ一覧紹介" class="headerlink" title="■再作成が必要となるシナリオ一覧紹介"></a>■再作成が必要となるシナリオ一覧紹介</h2><p>以下の項目を変更したい場合、VM の再作成が必要となっております。 </p><ul><li>可用性ゾーンの変更 / 追加 / 削除 </li><li>可用性セットの変更 / 追加 / 削除 </li><li>Spot VM 設定の有効 / 無効 の変更 </li><li>一時ディスク有りの VM サイズから一時ディスク無しの VM へサイズ変更（また、その逆） </li><li>VM リソース名称の変更 </li><li>VM の接続先 VNet の変更</li></ul><hr><h2 id="ポータルで-VM-再作成を行う手順"><a href="#ポータルで-VM-再作成を行う手順" class="headerlink" title="ポータルで VM 再作成を行う手順"></a>ポータルで VM 再作成を行う手順</h2><p>それでは、実際に VM 再作成で各項目を変更するための手順について説明させていただきます。 </p><h3 id="1-必要事項を控える"><a href="#1-必要事項を控える" class="headerlink" title="1. 必要事項を控える"></a>1. 必要事項を控える</h3><p> まずは、VM 再作成時に再度同じ設定をするために Azure ポータルの対象 VM の画面を開き、赤枠の項目を控えます。<br> 多くの項目がございますが、代表的なものについて説明させていただきますので、以下の通り設定値を控えておきましょう。 </p><h4 id="a-概要メニュー"><a href="#a-概要メニュー" class="headerlink" title="a. 概要メニュー"></a>a. 概要メニュー</h4><ul><li>リソースグループ名 </li><li>場所 </li><li>サイズ </li><li>パブリック IP アドレス </li><li>仮想ネットワーク / サブネット </li><li>可用性とスケーリング </li></ul><p> <img src="/blog/vm/recreate-vm-to-change-settings/1.png"></p><h4 id="b-ネットワークメニュー"><a href="#b-ネットワークメニュー" class="headerlink" title="b. ネットワークメニュー"></a>b. ネットワークメニュー</h4><p> 元の NIC を用いるかどうかによって、以下の 2 パターンに分けられます。VM 再作成時は Azure Portal にて既存 NIC を指定できませんが、VM 再作成後に後から NIC を付け替えることが可能です。該当する方を控えてください。 </p><p> <strong>b-1. 元の NIC を用いて新しい仮想マシンを作成する場合</strong></p><ul><li>ネットワーク設定メニュー<ul><li>NIC名 (元のNICが複数ある場合はすべて控える)<br><img src="/blog/vm/recreate-vm-to-change-settings/2.png"></li></ul></li></ul><p> <strong>b-2. 新しい仮想マシンを作成する際に、元の NIC を使用しない場合</strong></p><ul><li><p>ネットワーク設定メニュー</p><ul><li>NIC に設定されている NSG 名<br><img src="/blog/vm/recreate-vm-to-change-settings/3.png"></li></ul></li><li><p>負荷分散メニュー</p><ul><li>負荷分散の設定<br><img src="/blog/vm/recreate-vm-to-change-settings/4.png"></li></ul></li><li><p>ディスクメニュー</p><ul><li>各ディスク名 </li><li>各ディスクのホストキャッシュ設定<br><img src="/blog/vm/recreate-vm-to-change-settings/6.png"></li></ul></li></ul><p>これで、再作成のための情報を控えることができました。</p><hr><h3 id="2-スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）"><a href="#2-スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）" class="headerlink" title="2.スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）"></a>2.スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）</h3><div class="alert is-info"><p class="alert-title">Note</p><p>この手順は<strong>以下のシナリオに該当する場合のみ</strong>実施をお願いいたします。</p><p>該当しない場合は、後述の「3. 元の仮想マシンを削除する」の手順に進んでください。</p></div><p> <strong>【該当シナリオ】</strong></p><ul><li>もともと可用性ゾーンを使っており、今回可用性ゾーンに関する設定変更を行う<ul><li>例：ゾーン番号の変更・可用性ゾーンから可用性セットへの切り替え・可用性ゾーンをやめる</li></ul></li><li>可用性ゾーンを使っていなかったが、今回可用性ゾーンを使用するように変更する</li></ul><p> 上記シナリオの場合は、そのゾーン設定に対応するディスクを作成する必要があります。<br> 理由としては、以下の例のように特定のゾーン対応に存在しないディスクから、そのゾーン以外の VM を作成しようとすると、以下のような警告メッセージが表示され、VM 再作成ができないからとなります。 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/7.png"></p><h3 id="2-1-元の仮想マシンの-OS-ディスクのスナップショットを取る"><a href="#2-1-元の仮想マシンの-OS-ディスクのスナップショットを取る" class="headerlink" title="2-1. 元の仮想マシンの OS ディスクのスナップショットを取る"></a>2-1. 元の仮想マシンの OS ディスクのスナップショットを取る</h3><p>  a. Azure ポータルより [Virtual Machines] - [&lt;当該 VM 名&gt;] を開きます。 </p><p>  b. 左メニュー “設定” より [ディスク] を選択し、開いた画面 “OS ディスク” より [&lt;当該 OS ディスク名&gt;] をクリックします。</p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/5.png"></p><p>  c. 画面の [+ スナップショットの作成] をクリックします。</p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/8.png"></p><p>  d. 必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>  [ストレージの種類] は、スナップショットを高パフォーマンスのディスクに保存する必要がある場合を除き、 [Standard HDD(ローカル冗長ストレージ)] を選択します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/9.png"></p><p>  e. データディスクがある場合、データディスクについても同様にスナップショットを作成します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/10.png"></p><h3 id="2-2-スナップショットからディスクを作成する際に可用性ゾーン-可用性セットを変更する"><a href="#2-2-スナップショットからディスクを作成する際に可用性ゾーン-可用性セットを変更する" class="headerlink" title="2-2. スナップショットからディスクを作成する際に可用性ゾーン/可用性セットを変更する"></a>2-2. スナップショットからディスクを作成する際に可用性ゾーン/可用性セットを変更する</h3><p>  a. Azure ポータル 上部の検索バーに “スナップショット” と入力し、サービス [スナップショット] を選択します。<br>  上記手順で作成した OS ディスクおよび、データ ディスクのスナップショットが作成されていることを確認します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/11.png"></p><p>  b. 対象ディスクのスナップショットを選択し、[+ ディスクの作成] をクリックします </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/12.png"></p><p>  c. 必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>  特定の可用性ゾーンに所属させたい場合は、以下のように可用性ゾーン番号をご指定ください。<br>  それ以外の場合は [インフラストラクチャ冗長は必要ありません] を選択します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/13.png"></p><p>これにより、特定のゾーンに所属するディスク（もしくは、ゾーン設定の無いディスク）を用意することが出来ました。<br>この作成したディスク名は VM 再作成時に使用しますので、控えておいてください。 </p><hr><h3 id="3-元の仮想マシンを削除する"><a href="#3-元の仮想マシンを削除する" class="headerlink" title="3. 元の仮想マシンを削除する"></a>3. 元の仮想マシンを削除する</h3><p> 元の仮想マシンを削除します。 </p><p> なお、この際にディスク等のリソースは残しますので、データが消失するものでは無い点はご安心ください。<br> 一時ディスクの内容は破棄されます点はご承知おきくださいませ。</p><p> a. 対象の仮想マシンの概要上部にある「削除」をクリック<br> <img src="/blog/vm/recreate-vm-to-change-settings/14.png"></p><p> b. 以下赤枠内にチェックを入れないように気を付けて削除してください<br> <img src="/blog/vm/recreate-vm-to-change-settings/15.png"></p><p>これでディスクを残したまま、仮想マシンのリソースを削除できました。 </p><hr><h3 id="4-元の仮想マシンの-OS-ディスクから新規仮想マシンを作成する際に変更したい項目を変更する"><a href="#4-元の仮想マシンの-OS-ディスクから新規仮想マシンを作成する際に変更したい項目を変更する" class="headerlink" title="4. 元の仮想マシンの OS ディスクから新規仮想マシンを作成する際に変更したい項目を変更する"></a>4. 元の仮想マシンの OS ディスクから新規仮想マシンを作成する際に変更したい項目を変更する</h3><p>残されたディスクから VM を再作成します。<br>VM 再作成時にお好みの設定に変更が可能となっております。 </p><p> a. Azure ポータルより削除した VM で使用していた OS ディスク (控えていた OS ディスク名を参照) の画面を開きます。<br> なお、ゾーンに関する設定変更を行う場合は <strong>「2.スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）」</strong> の手順で作成したディスクをかわりに選択します。</p><p> b. [VM の作成] をクリックします。 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/16.png"></p><p> c. 手順 <strong>「1. 必要事項を控える」</strong> にて控えていた内容をもとに VM の設定項目を入力していきます。<br> この際、変更を行いたい項目をご変更くださいませ。 </p><ul><li><p>リソース名を変更したい場合 </p><p><img src="/blog/vm/recreate-vm-to-change-settings/17.png"></p></li><li><p>データディスクを追加したい場合 </p><p>元の仮想マシンのデータディスクを追加したい場合は、[既存のディスクの接続] より追加します。 </p><p><img src="/blog/vm/recreate-vm-to-change-settings/18.png"></p><p><img src="/blog/vm/recreate-vm-to-change-settings/19.png"></p></li><li><p>新しい仮想マシンで可用性セットを使用したい場合</p><p> [可用性オプション] にて [可用性セット] を選択し、[可用性セット] の項目にてご希望の障害ドメイン、更新ドメイン数を入力ください。 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/20.png"></p></li><li><p>新しい仮想マシンで可用性ゾーンを使用したい場合 </p><p> [可用性オプション]の項目で[可用性ゾーン] を選択し、[可用性ゾーン] の項目では、スナップショットからディスクを作成する際に指定したゾーン番号を選択します。  </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/21.png"></p></li><li><p>Azure Spot 割引を変更したい場合 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/22.png"></p></li><li><p> 接続先 VNET を変更したい場合 </p></li></ul><p>   <img src="/blog/vm/recreate-vm-to-change-settings/23.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>ネットワークについて、既存の NIC 接続は VM 作成後に行いますので、既存 NIC を使用する場合、この段階での “NIC ネットワーク セキュリティ グループ” の設定は不要です。</p><p>新規の NIC を使用する場合は、リージョンの変更が無い場合、元と同じ NSG を選択することも可能です。  </p></div><p> d.全ての設定が完了後、 [確認および作成] から[作成] をクリックします。  </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/24.png"></p><hr><h3 id="オプション：-NIC-の付け替え"><a href="#オプション：-NIC-の付け替え" class="headerlink" title="オプション： NIC の付け替え"></a>オプション： NIC の付け替え</h3><p>  Azure ポータルより VM 作成をする際には既存 NIC を指定できませんが、 VM 再作成後に後から NIC を付け替えることが可能です。</p><p>  a. 仮想マシンを作成後、既存の NIC を接続するため、VM を停止 (割り当て解除) します。</p><p>  b. VM 停止 (割り当て解除) 後、VM のページから [ネットワーク] - ネットワーク設定 - [ネットワーク インターフェイスのアタッチ] を選択し、削除した VM で使用していた NIC を接続します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/26.png"></p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/27.png"></p><p>  c. 既存の NIC の接続完了後も、VM 作成時に作成された NIC がまだプライマリとなっている状態なので、[ネットワーク インターフェイスのデタッチ] を選択し、その NIC をデタッチします。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/28.png"></p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/29.png"></p><p>  NIC のデタッチを実施後、セカンダリとして接続した既存 NIC は自動的にプライマリとなります。<br>  なお、デタッチした NIC については削除されても問題ありません。 </p><p>  d. VM を起動します。 </p><hr><p>手順は以上となります。本記事が皆様のお役に立ちましたら幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの藤澤です。 &lt;/p&gt;
&lt;p&gt;Azure VM のいくつかの設定項目は、VM 作成後は変更いただくことが叶いませんが、OS / データディスクを保持したまま、VM を再作成いただくことで再作成時に変更することが可能でございます。&lt;br&gt;本記事では、通常変更不可である設定項目を、VM を再作成で変更する手順についてご案内します。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>お問い合わせにてパスワード等の機密情報を記載しないようにお願いいたします</title>
    <link href="https://jpaztech.github.io/blog/information/do-not-provide-sensitive-data/"/>
    <id>https://jpaztech.github.io/blog/information/do-not-provide-sensitive-data/</id>
    <published>2024-01-25T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.665Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>Azure テクニカル サポート チームではお客様から頂いた情報は厳重に管理をしております。<br>しかしながら、お客様のセキュリティを守るためにも、お問い合わせにてパスワード等の機密情報を記載しないように注意喚起のご案内をさせていただきたく存じます。</p><hr><h2 id="お問い合わせにて機密情報を記載しないようにお願いいたします"><a href="#お問い合わせにて機密情報を記載しないようにお願いいたします" class="headerlink" title="お問い合わせにて機密情報を記載しないようにお願いいたします"></a>お問い合わせにて機密情報を記載しないようにお願いいたします</h2><p>幣 Azure テクニカル サポート チームにお問い合わせをいただく際に、パスワード等の機密情報を記載されてしまっているというケースが発生しております。<br>恐れ入りますが、機密情報はお客様自身で適切に管理いただき、お問い合わせにてお客様の機密情報を記載をしないようにお願い申し上げます。  </p><p>これはお問い合わせ起票時以外にも、以下のようなお問い合わせ最中のやり取りも含めてのお願いとなります点、ご理解頂けますと幸いでございます。  </p><ul><li>お問い合わせ起票時の本文内への記載</li><li>お問い合わせ起票時にアップロードいただいたファイル内での記載</li><li>弊社とのメールやり取りでの本文内への記載</li><li>弊社とのメールやり取りでの添付ファイルでの記載</li><li>お問い合わせ後にアップロードいただいたファイル内での記載</li><li>電話での口頭でのやり取り</li></ul><p>加えて、テキストベースのファイル以外にもスクリーンショットなどの画像についても機密情報が含まれないようにご注意くださいませ。</p><hr><h2 id="記載してはいけない機密情報の例"><a href="#記載してはいけない機密情報の例" class="headerlink" title="記載してはいけない機密情報の例"></a>記載してはいけない機密情報の例</h2><p>以下の例のような機密情報は、お問い合わせに記載をしないようにお願い申し上げます。  </p><ul><li>OS ユーザー / Azure ユーザー等のパスワード</li><li>Azure ストレージアカウントのアクセスキー</li><li>有効な Azure ストレージアカウントの SAS キー</li><li>秘密鍵</li><li>クレジットカード番号</li></ul><p>もしこれらの情報が含まれる場合は、当該箇所をマスクしていただくようにお願い申し上げます。<br>以下はパスワードや Azure ストレージアカウントのアクセスキーおよび SAS キーについてマスクする一例となります。</p><h3 id="パスワードが入ったコマンドについてお問い合わせする場合"><a href="#パスワードが入ったコマンドについてお問い合わせする場合" class="headerlink" title="パスワードが入ったコマンドについてお問い合わせする場合"></a>パスワードが入ったコマンドについてお問い合わせする場合</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- password P@ssw0rd!</span><br><span class="line">　   ↓</span><br><span class="line">-- password &lt;●●●機密情報のためパスワードはマスクします●●●&gt;</span><br></pre></td></tr></table></figure><h3 id="Azure-ポータルから取得した-Azure-Files-への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）"><a href="#Azure-ポータルから取得した-Azure-Files-への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）" class="headerlink" title="Azure ポータルから取得した Azure Files への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）"></a>Azure ポータルから取得した Azure Files への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$connectTestResult</span> = <span class="built_in">Test-NetConnection</span> <span class="literal">-ComputerName</span> <span class="built_in">test-storage</span><span class="literal">-account</span>.file.core.windows.net <span class="literal">-Port</span> <span class="number">445</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$connectTestResult</span>.TcpTestSucceeded) &#123;</span><br><span class="line">    <span class="comment"># 再起動時にドライブが維持されるように、パスワードを保存する</span></span><br><span class="line">    cmd.exe /C <span class="string">&quot;cmdkey /add:`&quot;test-storage-account.file.core.windows.net`&quot; /user:`&quot;localhost\test-storage-account`&quot; /pass:`&quot;&lt;●●●ストレージアカウントのアクセスキーなのでマスクします●●●&gt;`&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ドライブをマウントする</span></span><br><span class="line">    <span class="built_in">New-PSDrive</span> <span class="literal">-Name</span> Z <span class="literal">-PSProvider</span> FileSystem <span class="literal">-Root</span> <span class="string">&quot;\\test-storage-account.file.core.windows.net\test&quot;</span> <span class="literal">-Persist</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Error</span> <span class="literal">-Message</span> <span class="string">&quot;Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SAS-キーを用いたストレージアカウントの-Blob-コンテナへのアクセスについてお問い合わせする際の例（SAS-キーをマスク）"><a href="#SAS-キーを用いたストレージアカウントの-Blob-コンテナへのアクセスについてお問い合わせする際の例（SAS-キーをマスク）" class="headerlink" title="SAS キーを用いたストレージアカウントの Blob コンテナへのアクセスについてお問い合わせする際の例（SAS キーをマスク）"></a>SAS キーを用いたストレージアカウントの Blob コンテナへのアクセスについてお問い合わせする際の例（SAS キーをマスク）</h3><p><code>https://test-storage-account.blob.core.windows.net/container?sv=2022-11-02&amp;ss=bfqt&amp;srt=sco&amp;sp=rwdlacupiytfx&amp;se=2023-12-29T12:05:45Z&amp;st=2023-12-29T04:05:45Z&amp;spr=https&amp;sig=&lt;●●●ストレージアカウントの SAS キーなのでマスクします●●●&gt;</code></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure ストレージアカウントのアクセスキーについてご懸念がございます場合は、以下の公開ドキュメントの通りローテーションを行うことが可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-account-keys-manage#manually-rotate-access-keys">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-account-keys-manage#manually-rotate-access-keys</a></p></div><hr><h2 id="機密情報をお問い合わせで記載してしまった場合"><a href="#機密情報をお問い合わせで記載してしまった場合" class="headerlink" title="機密情報をお問い合わせで記載してしまった場合"></a>機密情報をお問い合わせで記載してしまった場合</h2><p>もし、お客様側より上記のような機密情報を記載されてしまった際は、弊社よりお客様へご連絡の上、弊社およびお客様側で当該情報の削除の対応や、場合によっては新規のお問い合わせ発行をお願いさせていただくといったお手間をおかけする可能性があります。<br>そのため、サポート着手までお時間をいただく可能性がございます。<br>迅速なサポートのご提供およびお客様のセキュリティのためにも、機密情報の記載をしないようにご協力をお願い申し上げます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;Azure テクニカル サポート チームではお客様から頂いた情報は厳重に管理をしております。&lt;br&gt;しかしながら、お客様のセキュリティを守るためにも、お問い合わせにてパスワード等の機密情報を記載しないように注</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Azure Firewall の SKU をダウングレードする方法</title>
    <link href="https://jpaztech.github.io/blog/network/fw_sku_downgrade/"/>
    <id>https://jpaztech.github.io/blog/network/fw_sku_downgrade/</id>
    <published>2024-01-24T05:30:00.000Z</published>
    <updated>2024-03-21T03:28:48.689Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Azure Firewall の SKU を Premium から Standard にダウングレードする方法ついて紹介します。</p><span id="more"></span><p>Azure Firewall のイージー アップグレード/ダウングレード 機能の導入により、Standard と Premiume の SKU アップグレード/ダウングレードが容易に行えるようになりました。<br>しかしながら、Premium から Standard へのダウングレードに当たっては、Firewall Policy の ポリシー レベルを Premium から Standard へ変更することができません。<br>そのため、Azure Firewall の SKU を変更する前に Firewall Policy を Standard で再作成する必要があります。<br>Azure Firewall の SKU を Premium から Standard にダウングレードする手順は以下の通りとなります。</p><h2 id="Azure-Firewall-の-SKU-変更手順"><a href="#Azure-Firewall-の-SKU-変更手順" class="headerlink" title="Azure Firewall の SKU 変更手順"></a>Azure Firewall の SKU 変更手順</h2><ol><li>Firewall Policy を Standard で作成します。</li><li>対象の Azure Firewall の [概要] をクリックし、Firewall policy の [change] をクリックします。</li><li>1 で作成した Firewall policy をチェックし、下部の [保存] をクリックします。</li><li>対象の Azure Firewall の [概要] をクリックし、上記の [SKU の変更] をクリックします。</li><li>ファイアウォール SKU の Standard をクリックします。</li><li>“ファイアウォール ポリシーを選択してください” の箇所が、3 で保存した Firewall policy であることを確認します。</li><li>下部の [Downgrade] をクリックします。</li></ol><p>なお、Azure Firewall の SKU を Premium から Standard にダウングレードできるのは、Firewall Policy を使用している場合のみとなります。<br>ファイアウォール規則 (クラシック) を使用して Azure Firewall を管理することができないため、この点ご留意いただけますと幸いです。</p><p>また、ダウングレードした際のダウンタイムにつきましては、明確なダウンタイムはご案内することが困難ですが、15 ～ 20 分程度の時間がかかることを確認しております。<br>そのため、ダウングレードする際は、影響がない時間帯で実施いただければと存じます。</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Firewall の SKU 変更ついては以下にも記載がありますのでご一読ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/easy-upgrade">Azure Firewall イージー アップグレード/ダウングレード</a></p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Azure Firewall の SKU を Premium から Standard にダウングレードする方法ついて紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>ExpressRoute 回線に対するマイクロソフト側エッジルーターにおけるレート制限に関する補足</title>
    <link href="https://jpaztech.github.io/blog/network/expressroute_MV1F-T9G/"/>
    <id>https://jpaztech.github.io/blog/network/expressroute_MV1F-T9G/</id>
    <published>2024-01-16T15:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.685Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。 2024 年 1 月 17 日に ExpressRoute の使用に関するアナウンス Tracking ID MV1F-T9G (タイトル : We have important information for your ExpressRoute service ) が ExpressRoute をご利用中のお客様に送付されました。<br>アナウンスされた内容は英語でのご案内であるため、この記事にて補足させていただきます。  </p><span id="more"></span><hr><h2 id="ExpressRoute-回線に対するお客様による回線帯域幅の設定と、マイクロソフトによる流量制御の実施"><a href="#ExpressRoute-回線に対するお客様による回線帯域幅の設定と、マイクロソフトによる流量制御の実施" class="headerlink" title="ExpressRoute 回線に対するお客様による回線帯域幅の設定と、マイクロソフトによる流量制御の実施"></a>ExpressRoute 回線に対するお客様による回線帯域幅の設定と、マイクロソフトによる流量制御の実施</h2><p>この度の通知以前から、お客様が ExpressRoute 回線リソースをご作成される際には 50 Mbps から 10 Gbps の間で回線帯域幅をご選択いただいております。この回線帯域幅は作成後にお客様にて増速することが可能です。この回線帯域幅はマイクロソフト側エッジルーターの割り当て済み帯域幅の計算に利用されております。<br><br>2024 年 1 月 17 日 の Tracking ID MV1F-T9G (タイトル : We have important information for your ExpressRoute service ) の通知は、すべてのお客様がご契約済みの回線帯域幅をより公平にご利用いただくために、ExpressRoute 回線のマイクロソフト側エッジルーターにおいて流量制御を今後実施する旨をご案内しております。<br><br><br></p><h2 id="マイクロソフトによる流量制御の有効化時期と、お客様において必要な作業"><a href="#マイクロソフトによる流量制御の有効化時期と、お客様において必要な作業" class="headerlink" title="マイクロソフトによる流量制御の有効化時期と、お客様において必要な作業"></a>マイクロソフトによる流量制御の有効化時期と、お客様において必要な作業</h2><p>2024 年 2 月 15 日から 6 月 30 日の間にかけて、Azure における標準的な変更管理プロセス(※)に則って、順次マイクロソフト側エッジルーターにおけるレート制限は有効化されます。</p><p>(※) <a href="https://azure.microsoft.com/en-us/blog/advancing-safe-deployment-practices/">Advancing safe deployment practices | Microsoft Azure Blog</a>  </p><p>マイクロソフト側エッジルーターにおけるレート制限に際して、ほとんどのお客様において構成変更作業は発生いたしません。<br>この流量制御の影響を受けるのは、お客様にてご選択済みの ExpressRoute 回線帯域幅を超える帯域幅をご利用になっているお客様のみであるためです。  </p><p>ご利用中の回線において実際に利用している帯域幅が、お客様にてご選択済みの ExpressRoute 回線帯域幅を下回っていることを確認するには、ExpressRoute 回線のメトリックをご利用ください。  </p><p>（参考ドキュメント）<br><a href="https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-monitoring-metrics-alerts#bits-in-and-out---metrics-per-peering">Azure ExpressRoute： 監視、メトリック、およびアラート | Microsoft Learn</a><br>ビットのインとアウト - ピアリングごとのメトリック  </p><p>ご利用中の回線において実際に利用している帯域幅が、お客様にてご選択済みの ExpressRoute 回線帯域幅を上回っている場合、ご選択いただいた回線帯域幅の増速をご検討ください。<br>ExpressRoute 回線帯域幅の増速にあたっては、お客様と ExpressRoute プロバイダー様の間でご契約いただいている回線帯域幅についても過不足がないかをご確認ください。<br><br></p><h2 id="エッジルーターのレート制限に関わる-FAQ"><a href="#エッジルーターのレート制限に関わる-FAQ" class="headerlink" title="エッジルーターのレート制限に関わる FAQ"></a>エッジルーターのレート制限に関わる FAQ</h2><ul><li>Q: 流量制御機能が動作した場合、私の ExpressRoute 回線にどのような影響がありますか？<br></li><li>A: まず、ExpressRoute 回線の帯域幅を 50 Mbps とご選択いただいた場合、プライマリ回線とセカンダリ回線の両系統がそれぞれ 50 Mbps ご利用可能です。これは片系統のメンテナンスや障害が発生した場合でも、ご選択いただいた 50 Mbps が利用可能であり続けることを目的に構成されています。 <br><br>この度有効となる流量制御は、各回線ごとに 50 Mbps を上回った場合に、パケットが破棄されるように動作します。<br>なお、レート制限の有効後も、両系統をアクティブ/アクティブ構成で均等にご使用されている場合に限れば、理論上は同回線で 2 倍の最大 100 Mbps まで一時的に「バースト」して利用いただけます。<br>ただし、アクティブ/アクティブ構成の場合もメンテナンスや障害等で一時的に片系統が利用できない場合も考えられ、その場合の最大値は 50 Mbps となりますのでご注意いただければと存じます。<br><br></li><li>Q: なぜ流量制御を実施するのですか？<br></li><li>A: ごく一部のお客様において、ご選択いただいた回線帯域幅を上回る帯域の利用が恒常化しているためです。すべてのお客様が公平に帯域幅をご利用いただき続けるために、マイクロソフト側エッジルーターにおける流量制御を有効化することになりました。<br><br></li><li>Q: どのようにして ExpressRoute 回線帯域幅を増速することができますか？<br></li><li>A: Azure Portal より ExpressRoute 回線リソースの「構成」をご選択いただき、増速後の「帯域幅」をプルダウンからご選択のうえ、設定を「保存」してください。  <br></li></ul><p>（参考ドキュメント）<br><a href="https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-circuit-portal-resource-manager#modify">クイックスタート： ExpressRoute を使った回線の作成と変更 - Azure portal | Microsoft Learn</a><br>ExpressRoute 回線の変更  </p><ul><li>Q: 増速時にはどのくらいの時間が必要ですか？増速時に通信断は発生しますか？<br></li><li>A: 増速に伴う設定変更は数秒で完了します。この間にお客様の通信の切断は想定されていませんが、設定変更に伴う不測の事態の影響を回避するためにも、慎重を期してお客様のシステムのメンテナンス時間帯に増速することを推奨いたします。<br><br></li><li>Q: ExpressRoute 回線帯域幅を増速したあと、元の帯域幅に戻したくなった場合には同様の操作で戻せますか？<br></li><li>A: いいえ、帯域幅の減速には ExpressRoute 回線リソースの削除と再作成が必要となります。増速時と同様の操作で減速することはできません。また、ExpressRoute 回線リソースの削除から再作成までの間は ExpressRoute 回線経由の通信ができないため、お客様のシステムにおいて通信断が発生します。<br><br><br>本ブログが皆様のお役に立てれば幸いです。  </li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。 2024 年 1 月 17 日に ExpressRoute の使用に関するアナウンス Tracking ID MV1F-T9G (タイトル : We have important information for your ExpressRoute service ) が ExpressRoute をご利用中のお客様に送付されました。&lt;br&gt;アナウンスされた内容は英語でのご案内であるため、この記事にて補足させていただきます。  &lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>特定の操作における Azure カスタム ロールの作成について</title>
    <link href="https://jpaztech.github.io/blog/vm/create-custom-roles/"/>
    <id>https://jpaztech.github.io/blog/vm/create-custom-roles/</id>
    <published>2024-01-16T01:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.809Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。<br>今回は特定の操作における Azure カスタム ロールの作成手順をご紹介いたします。 </p><ul><li>1.Azure カスタム ロールについて</li><li>2.カスタム ロールを作成する</li><li>3.補足情報 - ブラウザー トレースにて必要となるリソース プロバイダー操作を把握する</li><li>4.ご留意点</li></ul><h2 id="1-Azure-カスタム-ロールについて"><a href="#1-Azure-カスタム-ロールについて" class="headerlink" title="1.Azure カスタム ロールについて"></a>1.Azure カスタム ロールについて</h2><p>Azure では、ロール ベース アクセス制御 (RBAC) という機能を使用し、アクセスできるリソースを制限したり、リソースへの操作を制限したりすることが可能です。<br>Azure には既定で各リソース操作（アクション）の許可をまとめた組み込みロールのご用意がありますが、Azure 組み込みロールがお客様のご要件を満たさない場合は、独自の Azure カスタム ロールを作成することができます。 </p><p>参考）Azure 組み込みロール<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles</a> </p><blockquote><p>(抜粋)<br>Azure ロールベースのアクセス制御 (Azure RBAC) には、ユーザー、グループ、サービス プリンシパル、マネージド ID に割り当てることのできる Azure 組み込みロールがいくつかあります。 ロールの割り当ては、Azure リソースへのアクセスを制御する方法です。 組み込みロールが組織の特定のニーズを満たさない場合は、独自の Azure カスタム ロールを作成することができます。 ロールの割り当て方法については、「Azure ロールを割り当てる手順」を参照してください。 </p></blockquote><p>上記のドキュメントにて各組み込みロールで、実際にどのアクションが許可されているのかも確認が可能です。 </p><p>ただし、リソースへの操作に対して最低限必要となるアクションの組み合わせについては、公開ドキュメントに明記されていないこともございますので、お客様のご要件に合わせてトライ アンド エラーしながら最終的に必要となるアクションを確認し、カスタム ロールを作成いただくこととなります。<br>また、Azure サポート窓口にて、カスタム ロールの作成の代行は叶いません点あらかじめご了承ください。</p><h2 id="2-カスタム-ロールを作成する"><a href="#2-カスタム-ロールを作成する" class="headerlink" title="2.カスタム ロールを作成する"></a>2.カスタム ロールを作成する</h2><p>ここでは、Azure Portal から仮想マシンのディスクのスナップショットを取得するという操作を例に、当該操作を許可するためのアクションを確認し、カスタム ロールを作成していきます。<br>なお、他のどのような操作におきましても必要最小限のアクションのみが許可されたカスタム ロールを作成いただく場合、基本的には以下例のようにトライ アンド エラーを繰り返しながらカスタム ロールを作成いただくこととなります。</p><h3 id="手順-1-「Azure-リソース-プロバイダーの操作」より使用可能なアクセスアクションを検索し、カスタム-ロールに含めるアクセスアクションを探します。"><a href="#手順-1-「Azure-リソース-プロバイダーの操作」より使用可能なアクセスアクションを検索し、カスタム-ロールに含めるアクセスアクションを探します。" class="headerlink" title="手順 1.「Azure リソース プロバイダーの操作」より使用可能なアクセスアクションを検索し、カスタム ロールに含めるアクセスアクションを探します。"></a>手順 1.「Azure リソース プロバイダーの操作」より使用可能なアクセスアクションを検索し、カスタム ロールに含めるアクセスアクションを探します。</h3><p>Microsoft.Compute のリソース プロバイダーに対する操作となるため、Microsoft.Compute の項目を確認します。 </p><p>参考）Azure リソース プロバイダーの操作<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations</a> </p><p><img src="/blog/vm/create-custom-roles/01.png"></p><p>スナップショットの作成には ‘Microsoft.Compute/snapshots/write’ のアクションが必要となることを確認します。 </p><p><img src="/blog/vm/create-custom-roles/02.png"></p><p>必要となるアクションについては、既に権限のあるユーザーで実際の操作を行った際に記録されるアクティビティ ログの action 項目をご確認いただくことも有用です。 </p><p><img src="/blog/vm/create-custom-roles/03.png"></p><h3 id="手順-2-カスタム-ロールを作成します。"><a href="#手順-2-カスタム-ロールを作成します。" class="headerlink" title="手順 2.カスタム ロールを作成します。"></a>手順 2.カスタム ロールを作成します。</h3><p>手順 1 で確認した ‘Microsoft.Compute/snapshots/write’ アクションのみを許可したカスタム ロールを作成します。 </p><p><img src="/blog/vm/create-custom-roles/04.png"></p><p><img src="/blog/vm/create-custom-roles/05.png"></p><p>[JSON] タブを選択すると  ‘Microsoft.Compute/snapshots/write’ アクションのみが割り当たっていることを確認することができます。 </p><p> <img src="/blog/vm/create-custom-roles/06.png"></p><p>特定のユーザー testuser01 に当該カスタム ロールを割り当てます。 </p><p><img src="/blog/vm/create-custom-roles/07.png"></p><p>カスタム ロールの作成手順の詳細については、以下のブログ記事や公開ドキュメントをご参照ください。 </p><p>参考）カスタムロールを作成する手順<br><a href="https://jpaztech.github.io/blog/vm/rbac-vm-start-stop-restart/#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">https://jpaztech.github.io/blog/vm/rbac-vm-start-stop-restart/#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86</a><br>参考）Azure portal を使用して Azure カスタム ロールを作成または更新する<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal</a><br>参考）カスタム ロールの作成手順<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles</a> </p><h3 id="手順-3-動作確認をします。"><a href="#手順-3-動作確認をします。" class="headerlink" title="手順 3.動作確認をします。"></a>手順 3.動作確認をします。</h3><p>ユーザー testuser01 で Azure Portal へサインインし、[Virtual Machines] の一覧ページへ遷移します。<br>仮想マシンが表示されていません。 </p><p><img src="/blog/vm/create-custom-roles/08.png"></p><p>これは、ユーザー testuser01 に対して [閲覧者] ロールが割り当てられていないためとなります。 </p><h3 id="手順-4-割り当てられているロールを修正します。"><a href="#手順-4-割り当てられているロールを修正します。" class="headerlink" title="手順 4. 割り当てられているロールを修正します。"></a>手順 4. 割り当てられているロールを修正します。</h3><p>リソースにアクセスできるよう ユーザー testuser01 に対して [閲覧者] ロールを割り当てます。 </p><p><img src="/blog/vm/create-custom-roles/09.png"></p><p>仮想マシンの閲覧が可能となりました。 </p><p><img src="/blog/vm/create-custom-roles/10.png"></p><h3 id="手順-5-OS-ディスクのスナップショットを作成します。"><a href="#手順-5-OS-ディスクのスナップショットを作成します。" class="headerlink" title="手順 5.OS ディスクのスナップショットを作成します。"></a>手順 5.OS ディスクのスナップショットを作成します。</h3><p>OS ディスクのスナップショットを取得するため、対象となる OS ディスク名をクリックし、[+ スナップショットの作成] へ進みます。 </p><p><img src="/blog/vm/create-custom-roles/11.png"></p><h3 id="手順-6-動作確認を行いながら、トライ-アンド-エラーを繰り返します。"><a href="#手順-6-動作確認を行いながら、トライ-アンド-エラーを繰り返します。" class="headerlink" title="手順 6. 動作確認を行いながら、トライ アンド エラーを繰り返します。"></a>手順 6. 動作確認を行いながら、トライ アンド エラーを繰り返します。</h3><p>スナップショット作成のための必要事項を編集し、作成を行うと以下のエラーが出力されました。 </p><p><img src="/blog/vm/create-custom-roles/12.png"></p><blockquote><p>{“code”:”AuthorizationFailed”,”message”:”オブジェクト ID が ‘XXX’ のクライアント ‘testuser01@XXX’ には、スコープ ‘/subscriptions/XXXXXX/resourceGroups/rg_test/providers/Microsoft.Resources/deployments/Snapshot.snapshot01-20240103123034’ でアクション ‘Microsoft.Resources/deployments/validate/action’ を実行する認可がないか、スコープが無効です。アクセスが最近許可された場合は、資格情報を更新してください。”} </p></blockquote><p>リソースのデプロイ検証に必要なアクションが不足していることが分かります。 </p><p>参考）Microsoft.Resources<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftresources">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftresources</a></p><table><thead><tr><th align="left">アクション</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">Microsoft.Resources/deployments/validate/action</td><td align="left">デプロイを検証します。</td></tr></tbody></table><p>手順 2 で作成したカスタム ロールに ‘Microsoft.Resources/deployments/validate/action’ アクションを追加します。 </p><p><img src="/blog/vm/create-custom-roles/13.png"></p><p>次は別のエラーが出力されました。 </p><p><img src="/blog/vm/create-custom-roles/14.png"></p><blockquote><p>デプロイ要求を送信中にエラーが発生しました。<br>役立つ可能性がある基本 API から得られた追加の詳細情報: オブジェクト ID が ‘XXX’ のクライアント ‘testuser01@XXX’ には、スコープ ‘/subscriptions/XXXXX/resourceGroups/rg_test/providers/Microsoft.Resources/deployments/Snapshot.snapshot01-20240103124401’ でアクション ‘Microsoft.Resources/deployments/write’ を実行する認可がないか、スコープが無効です。アクセスが最近許可された場合は、資格情報を更新してください。 </p></blockquote><p>デプロイの作成に必要となるアクションが不足していることが分かります。 </p><p>参考）Microsoft.Resources<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftresources">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftresources</a></p><table><thead><tr><th align="left">アクション</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">Microsoft.Resources/deployments/write</td><td align="left">デプロイを作成または更新します。</td></tr></tbody></table><p>手順 2 で作成したカスタム ロールに ‘Microsoft.Resources/deployments/write’ アクションを追加します。 </p><p><img src="/blog/vm/create-custom-roles/15.png"></p><p>今度は、’Microsoft.Compute/disks/beginGetAccess/action’ アクションが不足しているというエラーが出力されました。 </p><p><img src="/blog/vm/create-custom-roles/16.png"></p><blockquote><p>The client ‘testuser01@XXX’ with object id ‘XXX’ has permission to perform action ‘Microsoft.Compute/snapshots/write’ on scope ‘/subscriptions/XXXXX/resourcegroups/rg_test/providers/Microsoft.Compute/snapshots/snapshot01’; however, it does not have permission to perform action(s) ‘Microsoft.Compute/disks/beginGetAccess/action’ on the linked scope(s) ‘/subscriptions/XXXXX/resourceGroups/rg_test/providers/Microsoft.Compute/disks/win2022_OsDisk_1_XXX (respectively) or the linked scope(s) are invalid。詳細については、ここをクリックしてください </p></blockquote><p>参考）Microsoft.Compute<br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftcompute">https://learn.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftcompute</a></p><table><thead><tr><th align="left">アクション</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">Microsoft.Compute/disks/beginGetAccess/action</td><td align="left">BLOB へのアクセス用にディスクの SAS URI を取得します。</td></tr></tbody></table><p>手順 2 で作成したカスタム ロールに “Microsoft.Compute/disks/beginGetAccess/action” を追加します。 </p><p><img src="/blog/vm/create-custom-roles/17.png"></p><p>ついに、スナップショットの作成に成功しました。 </p><p><img src="/blog/vm/create-custom-roles/18.png"></p><p><img src="/blog/vm/create-custom-roles/19.png"></p><p>最終的にユーザー testuser01 に対して必要となったアクションは以下となります。 </p><table><thead><tr><th align="left">アクション</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">*/read</td><td align="left">「閲覧者」ロール</td></tr><tr><td align="left">Microsoft.Compute/snapshots/write</td><td align="left">新しいスナップショットを作成するか、既存のスナップショットを更新します。</td></tr><tr><td align="left">Microsoft.Resources/deployments/validate/action</td><td align="left">デプロイを検証します。</td></tr><tr><td align="left">Microsoft.Resources/deployments/write</td><td align="left">デプロイを作成または更新します。</td></tr><tr><td align="left">Microsoft.Compute/disks/beginGetAccess/action</td><td align="left">BLOB へのアクセス用にディスクの SAS URI を取得します。</td></tr></tbody></table><p>以上のような手順にて、トライ アンド エラーを繰り返しながら、お客様環境にて必要最小となるアクションのみを付与したロールを作成いただく形となります。 </p><h2 id="3-補足情報-ブラウザー-トレースにて必要となるリソース-プロバイダー操作を把握する"><a href="#3-補足情報-ブラウザー-トレースにて必要となるリソース-プロバイダー操作を把握する" class="headerlink" title="3.補足情報 - ブラウザー トレースにて必要となるリソース プロバイダー操作を把握する"></a>3.補足情報 - ブラウザー トレースにて必要となるリソース プロバイダー操作を把握する</h2><p>トライ アンド エラーにてカスタム ロールを作成いただく際の補足情報となりますが、ブラウザー トレース (HAR トレース、F12 トレース) をご活用いただくことで、特定の操作を行う際に必要となるリソース プロバイダー操作をある程度把握することも可能です。 </p><h3 id="手順-1-ブラウザー-トレース-HAR-トレース、F12-トレース-を取得します。"><a href="#手順-1-ブラウザー-トレース-HAR-トレース、F12-トレース-を取得します。" class="headerlink" title="手順 1. ブラウザー トレース (HAR トレース、F12 トレース) を取得します。"></a>手順 1. ブラウザー トレース (HAR トレース、F12 トレース) を取得します。</h3><p>既に権限を持っているユーザーにてスナップショットを作成する際に、ブラウザー トレースを取得します。 </p><p> <img src="/blog/vm/create-custom-roles/20.png"></p><p>ブラウザー トレース (HAR トレース、F12 トレース) の取得手順の詳細は以下をご参照ください。 </p><p>参考）ネットワーク トレースの収集方法<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-web-pubsub/howto-troubleshoot-network-trace">https://learn.microsoft.com/ja-jp/azure/azure-web-pubsub/howto-troubleshoot-network-trace</a> </p><h3 id="手順-2-取得したブラウザー-トレースを確認します。"><a href="#手順-2-取得したブラウザー-トレースを確認します。" class="headerlink" title="手順 2. 取得したブラウザー トレースを確認します。"></a>手順 2. 取得したブラウザー トレースを確認します。</h3><p>手順 1 にて生成された portal.azure.com.har という .har ファイルを開き、スナップショットを作成する際に必要となったリソース プロバイダー操作 (providers) を確認します。 </p><p><img src="/blog/vm/create-custom-roles/21.png"></p><p>以下 3 つに関するリソース プロバイダー操作が必要となることが分かります。 </p><p>Microsoft.Resources/deployments<br>Microsoft.Compute/snapshots<br>Microsoft.Compute/disks </p><p>さらに細かなアクションまでを把握することは叶いませんが、カスタム ロールを作成いただく際にどのリソース プロバイダー操作が必要となるかをある程度把握することができます。 </p><h3 id="4-ご留意点"><a href="#4-ご留意点" class="headerlink" title="4. ご留意点"></a>4. ご留意点</h3><p>・Azure RBAC のスコープについて<br>Azure RBAC の付与は、管理グループ、サブスクリプション、リソース グループ、リソースいずれかのスコープに対して適用することが可能となります。<br>今回、サブスクリプションをスコープとしたカスタム ロールを割り当てたため、サブスクリプション内に存在する全ての仮想マシンに対して同様の操作が実施可能になります。 </p><p>特定の複数の仮想マシンに対してロールを付与をしたい場合には、対象の仮想マシンが所属するリソース グループや仮想マシンひとつひとつに対して付与を行っていただくことが可能になります。<br>（親スコープに設定されたロールは、子スコープに継承されます） </p><p>参考）Azure RBAC のスコープについて<br><a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/scope-overview">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/scope-overview</a> </p><p>・リソース操作を行うツールについて </p><p>Azure Portal や Azure PowerShell、Azure CLI 等のツールからリソースを操作することが可能ですが、操作を行うツールによって必要となるアクションが異なるケースがございます。このような場合は、リソース操作を行うツールにて検証を行い、必要となるアクションを取捨選択いただきますようお願い申し上げます。 </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;br&gt;今回は特定の操作における Azure カスタム ロールの作成手順をご紹介いたします。 &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.Azure カスタム ロールについて&lt;/li&gt;
&lt;li&gt;2.カスタム ロールを作成す</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="RBAC" scheme="https://jpaztech.github.io/blog/tags/RBAC/"/>
    
  </entry>
  
  <entry>
    <title>Azure RHEL VM の 非 EUS/ EUS リポジトリについて</title>
    <link href="https://jpaztech.github.io/blog/vm/rhui-eus/"/>
    <id>https://jpaztech.github.io/blog/vm/rhui-eus/</id>
    <published>2024-01-15T00:00:00.000Z</published>
    <updated>2024-03-21T03:28:49.021Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure テクニカル サポート チームの高橋です。<br>今回は、Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の<br>仮想マシンをご利用のお客様からよくお問い合わせを頂く</p><blockquote><p>・RHEL のマイナーバージョンがアップデートされない<br>・yum/dnf update したら意図せずマイナーバージョンが上がってしまった<br>・脆弱性対応のためパッケージのバージョンをアップデートしたいのに、yum/dnf update しても対象のバージョンに更新されない<br>・パッケージをインストール / 更新しようとするとパッケージの競合などのエラーが発生する</p></blockquote><p>という内容について、原因と解決方法をご紹介いたします。</p><span id="more"></span><hr><h2 id="原因について"><a href="#原因について" class="headerlink" title="原因について"></a>原因について</h2><p>結論から書いてしまうと、RHEL VM に接続されている Azure RHUI リポジトリが<br>非 EUS か EUS かによって発生している可能性が高いものと存じます。<br>RHEL VM のマイナーバージョンやパッケージのアップデートを実行する際には、<br>接続されているリポジトリの確認をする必要があります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>マイナーバージョンがアップデートされない事例として、</p><p>ゲスト OS 内の /etc/dnf/dnf.conf 内に exclude=kernel* の設定がないかご確認をください。</p><p>この設定がある場合、カーネルのアップデートが除外対象となっているため、マイナーバージョンのアップデートもされません。</p></div><hr><h2 id="非-EUS-と-EUS-リポジトリとは"><a href="#非-EUS-と-EUS-リポジトリとは" class="headerlink" title="非 EUS と EUS リポジトリとは"></a>非 EUS と EUS リポジトリとは</h2><p>ここでは、非 EUS、EUS リポジトリについてご紹介します。<br>Azure 上の RHEL VM は、既定で Azure RHUI (Red Hat Update Infrastructure) のリポジトリサーバーに接続されています。<br>Azure RHUI には、非 EUS (Extend Update Support) リポジトリと EUS リポジトリ の 2 種類があります。<br>RHEL VM が 非 EUS リポジトリに接続されている場合に、yum/dnf update を実施した際には、その時点で提供されている<br>最新の RHEL マイナーバージョンにアップグレードされ、最新のパッケージを取得できることとなります。 </p><p>一方で、RHEL VM が EUS リポジトリに接続されている場合、<br>yum/dnf update を実行した際に、更新プログラムは、<br>特定の RHEL マイナーバージョンを超えることはありません。<br>つまり、特定マイナーバージョンに固定されている状態 (マイナーバージョンロック) となります。<br>EUS は、ワークロードの都合上、特定のマイナーバージョンに固定して利用したいお客様向けにご利用頂けるものとなります。<br>EUS の詳細については、以下 Red Hat 社の公開情報にも纏められています。</p><blockquote><p>□ 参考 : Red Hat Enterprise Linux (RHEL) Extended Update Support (EUS) の概要<br>   <a href="https://access.redhat.com/ja/articles/3055941">https://access.redhat.com/ja/articles/3055941</a></p></blockquote><p>弊社公開情報にもリポジトリについて情報をお纏めしておりますので<br>併せてご確認ください。</p><blockquote><p>□ 参考 : Azure のオンデマンド Red Hat Enterprise Linux VM 用 Red Hat Update Infrastructure<br>  <a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui?tabs=rhel7#image-update-behavior">https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui?tabs=rhel7#image-update-behavior</a></p></blockquote><hr><h2 id="接続しているリポジトリの確認方法"><a href="#接続しているリポジトリの確認方法" class="headerlink" title="接続しているリポジトリの確認方法"></a>接続しているリポジトリの確認方法</h2><p>ご利用の RHEL VM が 非 EUS / EUS リポジトリのどちらに接続されているのか<br>確認する方法についてご紹介します。<br>yum repolist コマンドで接続されているリポジトリを確認することができます。<br>yum repolist all コマンドを実行すると、以下のようにリポジトリが設定されていることが確認できます。<br>また、以下コマンドで、releasever がどのマイナーバージョンに固定されているか確認することができます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/dnf/vars/releasever (RHEL 7 は、/etc/yum/vars/releasever)</span></span><br></pre></td></tr></table></figure><p>非 EUS リポジトリに接続されているときは以下のように releasever の固定もありません。<br><img src="/blog/vm/rhui-eus/01.png"></p><p>一方で、EUS リポジトリに接続されている環境では、リポジトリ名に <strong>“eus”</strong> の記載があり、<br>EUS リポジトリに接続されていることが確認できます。<br>例えば、EUS リポジトリに接続されている RHEL 8.4 の VM での<br>確認結果は以下のようになります。</p><p><img src="/blog/vm/rhui-eus/02.png"></p><hr><h2 id="接続しているリポジトリの変更方法と動作について"><a href="#接続しているリポジトリの変更方法と動作について" class="headerlink" title="接続しているリポジトリの変更方法と動作について"></a>接続しているリポジトリの変更方法と動作について</h2><p>それでは、接続しているリポジトリを変更する方法についてご紹介します。<br>リポジトリの変更については、以下 2 つの操作ができます。</p><blockquote><p>・非 EUS から EUS リポジトリに切り替える方法 (バージョンロック)<br>・EUS から、非 EUS リポジトリに変更する方法 (バージョンロックの解除)</p></blockquote><p>それぞれの方法について、RHEL 8 の環境を例にご紹介します。<br>なお、本操作はゲスト OS 内での作業となりますため、<br>予期せぬ問題に備えて、事前に<strong>バックアップ</strong>を取得頂くことや<strong>十分な検証</strong>をすることを推奨します。</p><h3 id="■-非-EUS-から-EUS-リポジトリに切り替える方法"><a href="#■-非-EUS-から-EUS-リポジトリに切り替える方法" class="headerlink" title="■ 非 EUS から EUS リポジトリに切り替える方法"></a>■ 非 EUS から EUS リポジトリに切り替える方法</h3><p>EUS リポジトリへ接続するためには以下の手順でコマンドを実行ください。</p><ol><li><p>EUS 以外のリポジトリを無効にする</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dnf --disablerepo=&#x27;*&#x27; remove &#x27;rhui-azure-rhel8&#x27; -y</span></span><br></pre></td></tr></table></figure></li><li><p>EUS リポジトリを追加する2 EUS リポジトリを追加する</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dnf --config=&#x27;https://rhelimage.blob.core.windows.net/repositories/rhui-microsoft-azure-rhel8-eus.config&#x27; install rhui-azure-rhel8-eus -y</span></span><br></pre></td></tr></table></figure></li><li><p>releaseverを固定する<br>EUS が提供されているバージョンを指定する必要があります。 (RHEL 8 の場合、8.1、8.2、8.4、8.6、8.8 のいずれかである必要があります)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sh -c &#x27;echo 8.x &gt; /etc/dnf/vars/releasever&#x27;</span></span><br></pre></td></tr></table></figure></li></ol><p>EUS が提供されているバージョンは以下 Red Hat 社の公開情報からご確認ください。</p><blockquote><p>□ 参考 : Red Hat Enterprise Linux (RHEL) Extended Update Support (EUS) の概要<br>  <a href="https://access.redhat.com/ja/articles/3055941">https://access.redhat.com/ja/articles/3055941</a> </p></blockquote><p>以下の環境では、RHEL 8.4 の EUS リポジトリに接続されていることが確認できます。</p><p><img src="/blog/vm/rhui-eus/03.png"></p><p>この状態で dnf update をしても、マイナーバージョンは上がりません。(8.4 のまま)<br>また、アップデートできるパッケージは RHEL 8.4 向けのパッケージのバージョンまでしか取得できないことになります。<br>一例ではございますが、本記事の執筆時点で、httpd の最新バージョンは、<br>RHEL 8.4 に固定されている状態で、2.4.37-39 が取得できることが確認できます。</p><p><img src="/blog/vm/rhui-eus/04.png"></p><p>また、EUS リポジトリを特定のマイナーバージョンに固定することもできます。<br>以下のように releasever を固定したいバージョンに設定することが可能となります。<br>( x には、 EUS が提供されているバージョンを指定する必要があります)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 8.x &gt; /etc/yum/vars/releasever</span></span><br></pre></td></tr></table></figure><p>以下例では、RHEL 8.4 の VM を RHEL 8.8 の EUS リポジトリに接続するよう変更しています。</p><p><img src="/blog/vm/rhui-eus/05.png"></p><p>この状態で、dnf update を実行し、再起動をすると RHEL 8.8 にマイナーバージョンがアップデートされます。<br>以下 dnf update を実施後の結果</p><p><img src="/blog/vm/rhui-eus/06.png"></p><p>また、パッケージは RHEL 8.8 向けのバージョンを取得することが可能となります。<br>httpd の場合、2.4.37-56 まで取得できることとなります。</p><p><img src="/blog/vm/rhui-eus/07.png"></p><h3 id="■-EUS-から、非-EUS-リポジトリに変更する方法"><a href="#■-EUS-から、非-EUS-リポジトリに変更する方法" class="headerlink" title="■ EUS から、非 EUS リポジトリに変更する方法"></a>■ EUS から、非 EUS リポジトリに変更する方法</h3><p>非 EUS リポジトリへ接続するためには以下の手順でコマンドを実行ください。</p><ol><li><p>releasever ファイルを削除</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rm -f /etc/dnf/vars/releasever</span></span><br></pre></td></tr></table></figure></li><li><p>EUS リポジトリを無効にする</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dnf --disablerepo=&#x27;*&#x27; remove &#x27;rhui-azure-rhel8-eus&#x27; -y</span></span><br></pre></td></tr></table></figure></li><li><p>非 EUS リポジトリを追加する</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dnf --config=&#x27;https://rhelimage.blob.core.windows.net/repositories/rhui-microsoft-azure-rhel8.config&#x27; install rhui-azure-rhel8 -y</span></span><br></pre></td></tr></table></figure></li></ol><p>以下例では、RHEL 8.4 の VM を 非 EUS リポジトリに接続するよう変更しています。<br><img src="/blog/vm/rhui-eus/08.png"></p><p>この状態で dnf update をすると、その時点で提供されている最新のマイナーバージョンにアップデートされます。<br>dnf update を実施後の結果は以下のようになります。<br><img src="/blog/vm/rhui-eus/09.png"></p><p>各パッケージについては、RHEL 8 の最新のパッケージまで更新することが可能となります。<br>非 EUS リポジトリに接続することで、httpd は 2.4.37-62 のバージョンまでアップデートすることができます。<br><img src="/blog/vm/rhui-eus/10.png"></p><p>詳細な手順については、以下の公開ドキュメントにもお纏めしております。</p><blockquote><p>□ 参考 : RHEL Server を EUS リポジトリに切り替えます。<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui?tabs=rhel8#switch-a-rhel-server-to-eus-repositories">https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui?tabs=rhel8#switch-a-rhel-server-to-eus-repositories</a></p></blockquote><blockquote><p>□ 参考 : RHEL Server を EUS 以外のリポジトリに切り替えます。<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui?tabs=rhel8#switch-a-rhel-server-to-non-eus-repositories">https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui?tabs=rhel8#switch-a-rhel-server-to-non-eus-repositories</a></p></blockquote><p>マイナーバージョンが想定通りアップグレードできない場合や、<br>脆弱性対応などで、ご要望のパッケージバージョンが表示されない際には、<br>上記リポジトリの設定をご確認頂き、適切なリポジトリを設定頂くようご確認頂ければと思います。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>リポジトリの設定変更作業において、ゲスト OS の再起動は不要となります。</p><p>ただし、yum / dnf update によりカーネルの更新等を行った場合には、</p><p>更新を反映させるため再起動が必要となります。</p><p>再起動の必要性はパッチの適用状況によって異なるため、一概にご案内することは難しいですが、needs-restarting -r を実施することで、再起動が必要か判断することもできます。</p><p>以下の Red Hat 社の公開情報についてもご確認頂ければと思います。</p><p>□ 参考 : 更新後にシステムの再起動が必要なパッケージを特定する</p><p><a href="https://access.redhat.com/ja/solutions/2725591">https://access.redhat.com/ja/solutions/2725591</a></p><p>＃閲覧には Red Hat 社のアカウントが必要になります。</p></div><hr><h2 id="補足-1-依存関係について"><a href="#補足-1-依存関係について" class="headerlink" title="補足 1 : 依存関係について"></a>補足 1 : 依存関係について</h2><p>マイナーバージョンの固定や、解除は環境に合わせて設定変更ができます。<br>しかしながら、以下のような場合、パッケージをインストールする際に、<br>関連するパッケージの依存関係の問題が発生し、<br>正常にインストールできないエラーが発生することがございます。 </p><blockquote><p>・マイナーバージョンを固定しない状態でパッケージのアップデートを行った後で、マイナーバージョンを固定した場合<br>・特定のマイナーバージョンに固定し、パッケージをアップデートした後に、それよりも低いマイナーバージョンに固定した場合</p></blockquote><p>イメージとしては、以下の通りとなります。<br><img src="/blog/vm/rhui-eus/11.png"></p><p>EUS リポジトリでは、問題の修正のため、取得できるパッケージのバージョンが分岐されて提供されております。<br>インストール済みのパッケージのバージョンと、<br>インストール予定のパッケージのバージョンに差があることで パッケージの <strong>conflict</strong> が発生します。</p><p>一例ではございますが、本事象は以下のような手順を実施した場合に再現します。</p><p>以下の手順を実施します。</p><blockquote><ol><li>RHEL 8.4 の VM で 非 EUS リポジトリに接続されている環境から、glibc をアップデート</li><li>非 EUS リポジトリから、RHEL 8.4 の EUS リポジトリに固定するよう変更</li><li>dnf install gcc を実行する</li></ol></blockquote><p>この手順を実施した際にパッケージの <strong>conflict</strong> が発生して、正常にインストールができない事象が発生します。</p><p>エラー内容一部抜粋</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel84 ~]# cat /etc/dnf/vars/releasever</span><br><span class="line">8.4</span><br><span class="line">[root@rhel84 ~]#</span><br><span class="line">[root@rhel84 ~]# dnf install gcc</span><br><span class="line">Last metadata expiration check: 22:49:35 ago on Thu 28 Dec 2023 06:32:39 AM UTC.</span><br><span class="line">Error:</span><br><span class="line"> Problem: package gcc-8.4.1-1.1.el8_4.x86_64 requires glibc-devel &gt;= 2.2.90-12, but none of the providers can be installed</span><br><span class="line">  - package glibc-devel-2.28-127.el8_3.2.x86_64 requires glibc = 2.28-127.el8_3.2, but none of the providers can be installed</span><br><span class="line">  - package glibc-devel-2.28-101.el8.x86_64 requires glibc = 2.28-101.el8, but none of the providers can be installed</span><br><span class="line">~</span><br><span class="line">  - cannot install both glibc-2.28-101.el8.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - cannot install both glibc-2.28-42.el8.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - cannot install both glibc-2.28-72.el8_1.1.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - cannot install both glibc-2.28-127.el8.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - cannot install both glibc-2.28-72.el8.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - cannot install both glibc-2.28-42.el8_0.1.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - cannot install both glibc-2.28-151.el8.x86_64 and glibc-2.28-236.el8.7.x86_64</span><br><span class="line">  - package glibc-gconv-extra-2.28-236.el8.7.x86_64 requires glibc(x86-64) = 2.28-236.el8.7, but none of the providers can be installed</span><br><span class="line">  - cannot install the best candidate for the job</span><br><span class="line">  - problem with installed package glibc-gconv-extra-2.28-236.el8.7.x86_64</span><br><span class="line">(try to add &#x27;--allowerasing&#x27; to command line to replace conflicting packages or &#x27;--skip-broken&#x27; to skip uninstallable packages or &#x27;--nobest&#x27; to use not only best candidate packages)</span><br></pre></td></tr></table></figure><p>この場合、変更したマイナーバージョンへのアップデートまたは、<br>作業前のバックアップを取得している場合は、VM を復元頂くことを推奨いたします。<br>問題となっているパッケージのダウングレードや削除・再インストールで解消できる場合もありますが、<br>EUS の継続利用が困難になることや、<br>その他の予期しない問題が発生することもございますため、<br>再度マイナーバージョンの固定化を実施する際にはご留意ください。</p><h2 id="補足-2-RHUI-より提供されるパッケージバージョンについて"><a href="#補足-2-RHUI-より提供されるパッケージバージョンについて" class="headerlink" title="補足 2 : RHUI より提供されるパッケージバージョンについて"></a>補足 2 : RHUI より提供されるパッケージバージョンについて</h2><p>Azure RHUI はRed Hat社のリポジトリとの即時の同期が実施されないため、タイミングによっては、最新バージョンのパッケージがまだ提供されてない場合もありますので、そのような場合は時間をおいて再度ご確認ください。 </p><p>また、OSS のパッケージについてはその OSS が提供している最新のバージョンが RHUI では提供されていない場合もございます。 </p><p>不具合に対する修正については、パッケージのバージョンが古い場合でも Red Hatでは適切にバックポートされている場合もございます。</p><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure テクニカル サポート チームの高橋です。&lt;br&gt;今回は、Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の&lt;br&gt;仮想マシンをご利用のお客様からよくお問い合わせを頂く&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;・RHEL のマイナーバージョンがアップデートされない&lt;br&gt;・yum/dnf update したら意図せずマイナーバージョンが上がってしまった&lt;br&gt;・脆弱性対応のためパッケージのバージョンをアップデートしたいのに、yum/dnf update しても対象のバージョンに更新されない&lt;br&gt;・パッケージをインストール / 更新しようとするとパッケージの競合などのエラーが発生する&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;という内容について、原因と解決方法をご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="RHEL" scheme="https://jpaztech.github.io/blog/tags/RHEL/"/>
    
    <category term="RHUI" scheme="https://jpaztech.github.io/blog/tags/RHUI/"/>
    
    <category term="Non EUS" scheme="https://jpaztech.github.io/blog/tags/Non-EUS/"/>
    
    <category term="EUS" scheme="https://jpaztech.github.io/blog/tags/EUS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Front Door 及び Microsoft Standard SKU の Azure CDN において発生する接続の問題</title>
    <link href="https://jpaztech.github.io/blog/network/afd-connection-issue/"/>
    <id>https://jpaztech.github.io/blog/network/afd-connection-issue/</id>
    <published>2023-12-29T08:30:00.000Z</published>
    <updated>2024-03-21T03:28:48.669Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>本ブログでは、Azure Front Door 及び Microsoft Standard SKU の Azure CDN (以降は AFD と記載致します) において起こりうる接続の問題やお客様で対策可能な内容などについてご案内致します。</p><span id="more"></span><hr><h2 id="AFD-で発生しうる接続の問題ついて"><a href="#AFD-で発生しうる接続の問題ついて" class="headerlink" title="AFD で発生しうる接続の問題ついて"></a>AFD で発生しうる接続の問題ついて</h2><p>AFD のプラットフォーム上では、より早くより適切なルートでオリジンへトラフィックをルーティングするために、さまざまな仕組みが用いられています。その仕組みの 1 つとして、AFD のプラットフォーム上にて処理するトラフィックの流量を調整する機能が存在しております。<br>AFD のサービスは世界中のエッジ サーバーに分散配置されており、複数のお客様でエッジ サーバーを共有して利用するマネージド サービスです。お客様のリクエストが、どのエッジ サーバーへルーティングされるかは、AFD によって動的にコントロールされています。<br>また、トラフィックの流量を調整する機能が特定のエッジ サーバーで起動した場合は、そのエッジ サーバーにルーティングされた一部のクライアントに対して RST パケットを送信する動作になります。<br>つまり、お客様の構成した AFD にアクセスを行い、該当のエッジ サーバーにルーティングされてしまった一部のクライアントも RST パケットを受け取る可能性があります。<br>なお、この仕組みによって、断続的に数分から数十分程度の間、クライアントから AFD への接続に影響を及ぼす可能性があります。</p><h2 id="接続の問題を受けるクライアント"><a href="#接続の問題を受けるクライアント" class="headerlink" title="接続の問題を受けるクライアント"></a>接続の問題を受けるクライアント</h2><p>TCP RST パケットを受信したクライアントが TCP レイヤー レベルで接続をリトライしない場合は、トラフィックの流量の調整が機能している間は、クライアントから AFD への接続に影響が発生してしまいます。<br>例えば、アプリケーション システムのフロントとして AFD を使用しており、一般ユーザーが PC 端末やスマートフォンの WEB ブラウザを用いて直接 AFD にアクセスする場合は、一時的に接続エラーになっても、WEB ブラウザにて画面を更新することによって正常に接続できる可能性があります。<br>一方で、API を処理するようなシステムのフロントとして AFD を使用しており、API を送信するクライアント側で TCP レイヤー レベルで再送処理を考慮していない場合は、RST パケットを受信したあとで AFD への TCP レイヤーでの再接続が実行されずに通信が失敗します。他には、Zabbix などの監視システムにおいて curl コマンドを AFD に送信している場合も同様のことが発生する可能性があります。</p><h2 id="リトライ-ロジックの実装"><a href="#リトライ-ロジックの実装" class="headerlink" title="リトライ ロジックの実装"></a>リトライ ロジックの実装</h2><p>一時的な接続の問題をクライアントが処理できるようにするために、AFD に接続を行うクライアント サイドの動作にてリトライ ロジックやサーキット ブレークの実装をご検討ください。これにより、アプリケーション システム上の通信の安定性を向上させることに繋がります。<br>リトライ ロジックやサーキット ブレークの必要性や実装の概要について記載されている公開ドキュメントやブログ (英語) につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/architecture/patterns/retry">再試行パターン</a></p><p><a href="https://azure.microsoft.com/en-us/blog/using-the-retry-pattern-to-make-your-cloud-application-more-resilient/">Using the Retry pattern to make your cloud application more resilient</a></p><h2 id="詳細な調査が必要なケース"><a href="#詳細な調査が必要なケース" class="headerlink" title="詳細な調査が必要なケース"></a>詳細な調査が必要なケース</h2><p>リトライ ロジックやサーキット ブレークを実装しているにもかかわらず、AFD への接続で遅延やタイムアウトなどの問題が、数分程度ではなく長時間にわたって事象が継続している場合は、詳細に調査を行う必要がございますので、サポート窓口までお問い合わせください。<br>なお、お問い合わせをいただく際には、AFD へ接続を実施している通信状況が分かるネットワーク パケットのキャプチャー ファイルとカスタム ドメインを nslookup コマンドなどで名前解決した結果をサポートまで提供いただくことにより、お客様とサポートとの間でのヒアリングをスムーズに進めることができます。<br>お手数をおかけいたしますが、下記の手順を参考にネットワーク パケット キャプチャー ファイルの採取及びカスタム ドメインの名前解決結果にご協力いただけますと幸いです。</p><h4 id="■-ネットワーク-パケット-キャプチャー-ファイルの採取"><a href="#■-ネットワーク-パケット-キャプチャー-ファイルの採取" class="headerlink" title="■ ネットワーク パケット キャプチャー ファイルの採取"></a>■ ネットワーク パケット キャプチャー ファイルの採取</h4><p>【クライアントが Windows OS の場合】</p><ol><li>管理者権限を持つアカウントでコマンド プロンプトを開きます (UAC が有効の場合には、”管理者として実行” します)。</li><li>コマンド プロンプト上で次のコマンドを実行して、ネットワーク パケットのキャプチャを開始します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh trace start capture=yes</span><br></pre></td></tr></table></figure></li><li>お客様のアプリケーションを配信元として設定している AFD に対し、クライアント上で WEB ブラウザや curl コマンドなどを使用して AFD へリクエストを送って接続問題の事象を再現させます。この操作を 5 秒ほどの間隔をあけて 2 ~ 3 度リクエストを送ってください。</li><li>コマンド プロンプト上で次のコマンドを実行して、ネットワーク パケット キャプチャを停止します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh trace stop</span><br></pre></td></tr></table></figure>トレース ファイルの収集処理が完了しましたら、コマンド プロンプト上で “ファイルの場所” として表示されている NetTrace.etl ファイル、及び同じフォルダ内の NetTrace.cab の 2 つのファイルを取得します。</li></ol><p>【クライアントが Linux OS の場合】</p><ol><li>sudo 権限を持っているユーザーとしてログインし、次のコマンドを実行し、キャプチャを開始します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -s0 -i any -n -w outfile.pcap</span><br></pre></td></tr></table></figure></li><li>お客様のアプリケーションを配信元として設定している AFD に対し、クライアント上で WEB ブラウザや curl コマンドなどを使用して AFD へリクエストを送って接続問題の事象を再現させます。この操作を 5 秒ほどの間隔をあけて 2 ~ 3 度リクエストを送ってください。</li><li>Ctrl + C でパケットキャプチャを停止します。</li><li>コマンドを実行した場所にある outfile.pcap を取得します。</li></ol><h4 id="■-カスタム-ドメインの名前解決結果"><a href="#■-カスタム-ドメインの名前解決結果" class="headerlink" title="■ カスタム ドメインの名前解決結果"></a>■ カスタム ドメインの名前解決結果</h4><p>お手元の端末においてコマンド プロンプトなどを開き、以下のコマンドを実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;カスタム ドメイン名&gt;</span><br></pre></td></tr></table></figure><p>もしくは</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig &lt;カスタム ドメイン名&gt;</span><br></pre></td></tr></table></figure><p>また、お問い合わせをいただいた後に、担当のサポート エンジニアよりヒアリング シートへの記入をお願いする可能性もございます。その際はご協力の程よろしくお願い致します。</p><h2 id="AFD-の接続の問題によって大きなサービス-インパクトが発生するシステムの場合"><a href="#AFD-の接続の問題によって大きなサービス-インパクトが発生するシステムの場合" class="headerlink" title="AFD の接続の問題によって大きなサービス インパクトが発生するシステムの場合"></a>AFD の接続の問題によって大きなサービス インパクトが発生するシステムの場合</h2><p>AFD はマネージド サービスになるため、場合によっては短期間で完全な対策を講じることができない可能性もあります。<br>AFD の接続の問題が長時間にわたって継続することによって、お客様のシステムに大きなサービス インパクトが懸念される場合は、お客様にて影響範囲や時間、発生パターンなどに応じてシステムを継続するための代替構成の導入をご検討をお願いする場合があります。<br>あくまで例としてですが、代替システムの構成例としては、以下のようなパターンがございます。</p><h4 id="パターン-1-AFD-を経由しない構成"><a href="#パターン-1-AFD-を経由しない構成" class="headerlink" title="パターン 1 : AFD を経由しない構成"></a>パターン 1 : AFD を経由しない構成</h4><p>AFD に登録しているカスタム ドメインの名前解決先を AFD のエンドポイントではなく、オリジンのパブリック IP アドレスや FQDN になるように DNS レコードを更新して、AFD を経由せずに直接オリジンにアクセスします。</p><h4 id="パターン-2-Traffic-Manager-と-Application-Gateway-を組み合わせた構成"><a href="#パターン-2-Traffic-Manager-と-Application-Gateway-を組み合わせた構成" class="headerlink" title="パターン 2 : Traffic Manager と Application Gateway を組み合わせた構成"></a>パターン 2 : Traffic Manager と Application Gateway を組み合わせた構成</h4><p>AFD と同じように L7 のリバース プロキシとして動作するサービスに Application Gateway がありますが、リージョン レベルでの冗長性を確保するために AFD をご利用いただいているお客様も多いかと存じます。<br>複数の Application Gateway を異なるリージョンにデプロイして、Traffic Manager のエンドポイントに Application Gateway パブリック IP アドレスや FQDN を登録し、AFD に登録しているカスタム ドメインの名前解決先を Traffic Manager の FQDN に変更することで、リージョン レベルでの冗長性を確保して継続稼働することが可能になります。<br>Traffic Manager と Application Gateway を組み合わせた構成については、下記の公開ドキュメントに記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-load-balancing-azure">Azure で負荷分散サービスを使用する</a></p><div class="alert is-info"><p class="alert-title">Note</p><p>なお AFD とは異なり、Application Gateway ではバックエンドから取得したコンテンツをキャッシュしたり、コンテンツを圧縮してクライアントに配信することはできませんので、その点をご理解いただいたうえで、Application Gateway の使用をご検討ください。</p></div><h4 id="パターン-3-Edgio-SKU-の-Azure-CDN-の利用"><a href="#パターン-3-Edgio-SKU-の-Azure-CDN-の利用" class="headerlink" title="パターン 3 : Edgio SKU の Azure CDN の利用"></a>パターン 3 : Edgio SKU の Azure CDN の利用</h4><p>Azure Front Door と Microsoft Standard SKU の Azure CDN は同じプラットフォーム上で動作しています。一方で、Edgio SKU の Azure CDN は Edgio 社が管理しているプラットフォーム上で動作しているため、AFD にて接続の問題が発生している間、Edgio SKU の Azure CDN にて同一の原因で接続の問題が発生することはありません。<br>また、AFD で使用しているカスタム ドメインを予め Edgio SKU の Azure CDN に登録いただけますので、予め Edgio SKU の Azure CDN を準備してカスタム ドメインを登録しておくことにより、AFD から Edgio SKU の Azure CDN に切り替えて継続稼働することが可能になります。<br>なお、Edgio SKU の Azure CDN に固定費用はなくデータ転送量による従量課金制になるため、アクセスが発生しない限りは課金されることはございません。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Azure Front Door 及び Microsoft Standard SKU の Azure CDN (以降は AFD と記載致します) において起こりうる接続の問題やお客様で対策可能な内容などについてご案内致します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="AzureFrontDoor" scheme="https://jpaztech.github.io/blog/tags/AzureFrontDoor/"/>
    
    <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の「再起動を必要としないメンテナンス」を事前に検知する方法</title>
    <link href="https://jpaztech.github.io/blog/vm/get-scheduled-events-from-imds/"/>
    <id>https://jpaztech.github.io/blog/vm/get-scheduled-events-from-imds/</id>
    <published>2023-12-29T07:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は表題の通り、Azure VM の再起動を必要としないメンテナンスを事前に検知する方法をご紹介させていただきます。<br>IMDS を用いて Scheduled Events を監視することで、再起動を必要としないメンテナンスを事前に検知することが可能です。  </p><hr><h2 id="Azure-VM-のメンテナンスについて"><a href="#Azure-VM-のメンテナンスについて" class="headerlink" title="Azure VM のメンテナンスについて"></a>Azure VM のメンテナンスについて</h2><p>Azure VM はお客様に安心してご利用いただくためにセキュリティ向上の対応や機能改善等を目的として定期的に Azure 基盤側のメンテナンスを行っております。<br>お客様の VM に影響の発生する可能性のあるメンテナンスとして、大きく以下の 2 種類に分けられます。  </p><ul><li>再起動を<strong>必要とする</strong>メンテナンス</li><li>再起動を必要としないメンテナンス（ライブマイグレーションを含む）</li></ul><blockquote><p>■ご参考：Azure での仮想マシンのメンテナンス<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates</a></p></blockquote><p>再起動を<strong>必要とする</strong>メンテナンスについては、以下の通り Azure Portal の [サービスの正常性] で事前に確認が可能です。</p><blockquote><p>■ご参考：計画メンテナンスの通知の処理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications</a></p></blockquote><p>再起動を必要としないメンテナンスについては、恐縮ながら Azure Portal での事前の確認をすることや、既定でメールの通知がされるものではございません。<br>そのため、「何とかして再起動を必要としないメンテナンスが発生することを事前に確認することができないか？」というお問い合わせをいただくこともございます。<br>後述の通り、IMDS を用いて Scheduled Events を監視することで再起動を必要としないメンテナンスを事前に確認する事が可能です。  </p><hr><h2 id="IMDS-を用いて-Scheduled-Events-を確認する"><a href="#IMDS-を用いて-Scheduled-Events-を確認する" class="headerlink" title="IMDS を用いて Scheduled Events を確認する"></a>IMDS を用いて Scheduled Events を確認する</h2><p>まずは IMDS について簡単に解説させていただきます。<br>IMDS（Instance Metadata Service）は、現在実行中の VM に関する情報を取得できるものとなっております。<br>実行中の VM 内から IMDS に HTTP アクセスを行うことで、情報を取得することが可能です。<br>なお、同一の可用性セット内の VM もしくは同じ VMSS 内のインスタンスについても合わせて情報を取得できます。</p><blockquote><p>■ご参考：Azure Instance Metadata Service<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/instance-metadata-service">https://learn.microsoft.com/ja-jp/azure/virtual-machines/instance-metadata-service</a></p></blockquote><p>この IMDS のエンドポイントの 1 つとして、Scheduled Events というものがございます。<br>これは VM の近い将来にスケジュールされている VM の再起動やメンテナンスのイベントを確認できるものとなっております。  </p><blockquote><p>■ご参考：Azure Metadata Service: Windows VM のScheduled Events<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/scheduled-events">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/scheduled-events</a></p></blockquote><blockquote><p>■ご参考：Azure Metadata Service: Linux VM の Scheduled Events<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/scheduled-events">https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/scheduled-events</a></p></blockquote><p>それでは、Scheduled Events の確認を実際にやってましょう。<br>以下のコマンドを Azure VM 上のゲスト OS 内にて実行します。  </p><p><strong>Windows</strong> の場合は PowerShell より以下のコマンドで、IMDS の Scheduled Events のエンドポイントに HTTP でアクセスします。  </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-RestMethod -Headers @&#123;&quot;Metadata&quot;=&quot;true&quot;&#125; -Method GET -Uri &quot;http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01&quot; | ConvertTo-Json -Depth 64</span><br></pre></td></tr></table></figure><p><strong>Linux</strong> の場合は以下の通り Bash で curl コマンドで、IMDS の Scheduled Events のエンドポイントに HTTP でアクセスします。  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H Metadata:<span class="literal">true</span> http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01</span><br></pre></td></tr></table></figure><p>実行結果として、以下の例のように直近のスケジュールされたイベントがレスポンスとして確認できます。</p><h3 id="特に何もスケジュールされたイベントが無い場合"><a href="#特に何もスケジュールされたイベントが無い場合" class="headerlink" title="特に何もスケジュールされたイベントが無い場合"></a>特に何もスケジュールされたイベントが無い場合</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;DocumentIncarnation&quot;</span>:  <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;Events&quot;</span>:  [</span><br><span class="line"></span><br><span class="line">               ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="起動を必要としないメンテナンスがスケジュールされている場合"><a href="#起動を必要としないメンテナンスがスケジュールされている場合" class="headerlink" title="起動を必要としないメンテナンスがスケジュールされている場合"></a>起動を必要としないメンテナンスがスケジュールされている場合</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;DocumentIncarnation&quot;</span>:  <span class="number">28</span>,</span><br><span class="line">    <span class="attr">&quot;Events&quot;</span>:  [</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="attr">&quot;EventId&quot;</span>:  <span class="string">&quot;E92E64F9-XXXX-XXXX-XXXX-FF3EBA4C0090&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;EventStatus&quot;</span>:  <span class="string">&quot;Scheduled&quot;</span>, → スケジュールされたイベントがある。★★★</span><br><span class="line">                       <span class="attr">&quot;EventType&quot;</span>:  <span class="string">&quot;Freeze&quot;</span>, → 再起動を伴わないメンテナンスである。★★★</span><br><span class="line">                       <span class="attr">&quot;ResourceType&quot;</span>:  <span class="string">&quot;VirtualMachine&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;Resources&quot;</span>:  [</span><br><span class="line">                                         <span class="string">&quot;VMName&quot;</span> → 対象の VM 名。★★★</span><br><span class="line">                                     ],</span><br><span class="line">                       <span class="attr">&quot;NotBefore&quot;</span>:  <span class="string">&quot;Mon, 19 Sep 2023 18:00:00 GMT&quot;</span>, → この時刻以降にメンテナンスが実行される。★★★</span><br><span class="line">                       <span class="attr">&quot;Description&quot;</span>:  <span class="string">&quot;This is sample Description&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;EventSource&quot;</span>:  <span class="string">&quot;Platform&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;DurationInSeconds&quot;</span>:  <span class="number">2</span> → 想定される影響時間は <span class="number">2</span> 秒である。★★★</span><br><span class="line">                   &#125;</span><br><span class="line">               ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>イベントによって何分前までには通知されるといった NotBefore の時間が違いますが、再起動を必要としないメンテナンスについては、実行される約 15 分前までにはスケジュールが設定されます。<br>つまり 20 分前といった場合はまだスケジュールが設定されていないために、確認が叶わない場合もございます点、ご留意ください。  </p><p>すなわち、定期的に IMDS の Scheduled Events をアクセスすることで、再起動を必要としないメンテナンス実行の約 15 分前には事前にメンテナンスが発生する予定を確認することが可能です。<br>次のセクションではこの Scheduled Events を定期的に確認する方法についてご案内させていただきます。  </p><hr><h2 id="Windows-環境で定期的に-Scheduled-Events-を監視し、再起動を必要としないメンテナンスがあった際にアラート通知を行うサンプル"><a href="#Windows-環境で定期的に-Scheduled-Events-を監視し、再起動を必要としないメンテナンスがあった際にアラート通知を行うサンプル" class="headerlink" title="Windows 環境で定期的に Scheduled Events を監視し、再起動を必要としないメンテナンスがあった際にアラート通知を行うサンプル"></a>Windows 環境で定期的に Scheduled Events を監視し、再起動を必要としないメンテナンスがあった際にアラート通知を行うサンプル</h2><p>Windows 環境においては、以下の通り公開ドキュメントとして、定期的に Scheduled Events を監視し、再起動を必要としないメンテナンスがスケジュールされた際にアラート通知を行うサンプルがございます。  </p><blockquote><p>■ご参考：Azure VM のスケジュールされたイベントを監視する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/scheduled-event-service">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/scheduled-event-service</a></p></blockquote><p>具体的な内容は実際のドキュメントをご確認いただきたく存じますが、簡単に内容を解説すると以下の通りとなります。  </p><ul><li>同一の可用性セットに VM を 2 つ作成する。</li><li>片方の VM にて SchService.ps1 という定期的な Scheduled Events のアクセスを行うスクリプトを実行する。</li><li>SchService.ps1 は同一の可用性セット内 VM に対する Scheduled Events を検知すると、その内容をイベントログに記録する。</li><li>Azure Monitor の Log Analytics を用いて、その記録されたイベントログを監視する。</li><li>Scheduled Events が記録されたイベントログを発見すると、アラート（メール通知等）を発報する。</li></ul><p>なお、恐縮ながら再起動を必要としないメンテナンスを疑似的に発生させて “EventType”:”Freeze” の Scheduled Events を発生させることは叶いません。<br>そのため、このサンプルの動作確認としては代替として再起動イベントを検知する形となっております。  </p><p>上記のサンプルによって、同一の可用性セット内の VM で再起動を必要としないメンテナンスがスケジュールされた際に、自動的にメール通知を行うといったことが可能となります。<br>また、SchService.ps1 をご自身で拡張いただくことで、Scheduled Events を検知したら自動的に何かを実行するといったスクリプトにしていただくことも可能です。</p><hr><h2 id="Linux-環境で定期的に-Scheduled-Events-を監視するサンプル"><a href="#Linux-環境で定期的に-Scheduled-Events-を監視するサンプル" class="headerlink" title="Linux 環境で定期的に Scheduled Events を監視するサンプル"></a>Linux 環境で定期的に Scheduled Events を監視するサンプル</h2><p>Linux 環境においては、上記の Windows のようにアラート通知を行うといったサンプルのご用意がございませんが、定期的な Scheduled Events の監視をするサンプルが以下の通りご用意されております。  </p><blockquote><p>■ご参考：Azure Metadata Service: Scheduled Events Samples<br><a href="https://github.com/Azure-Samples/virtual-machines-scheduled-events-discover-endpoint-for-non-vnet-vm">https://github.com/Azure-Samples/virtual-machines-scheduled-events-discover-endpoint-for-non-vnet-vm</a></p></blockquote><p>勿論、上記サンプル以外にも Scheduled Events へ定期的なアクセスを試みる方法を実行頂いても構いません。  </p><hr><p>以上の通り、Azure VM の再起動を必要としないメンテナンスを事前に検知する方法をご紹介させていただきました。<br>なお、再起動を必要としないメンテナンスを実行するタイミングをコントロールしたいといった場合は、Dedicated Host もしくは分離された仮想マシンをご利用の上、メンテナンス構成を設定いただくことで実現可能でございます。<br>この点については以下の公式ドキュメント等をご参照ください。  </p><blockquote><p>■ご参考：メンテナンス構成による VM の更新の管理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-configurations">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-configurations</a></p></blockquote><p>定期的なメンテナンスは安心してお客様に Azure をご利用いただく上で必要不可欠でございます点、ご理解賜りますと幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は表題の通り、Azure VM の再起動を必要としないメンテナンスを事前に検知する方法をご紹介させていただきます。&lt;br&gt;IMDS を用いて Scheduled Events を監視することで、再起</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>サービスタグに必要なアクセス制御 (RBAC) について</title>
    <link href="https://jpaztech.github.io/blog/network/azure-service-tag-authority/"/>
    <id>https://jpaztech.github.io/blog/network/azure-service-tag-authority/</id>
    <published>2023-12-25T06:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.677Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure サービスをご利用いただく中で、Azure ロールベースのアクセス制御 (RBAC) を利用し、必要な権限をユーザーに付与し、運用いただいているお客様も多いかと存じます。その中で、Azure Portal 上の NSG のサービスタグが一部しか表示されない事象があるというお問い合わせを多くいただいておりますので、その原因および回避策について本ブログでご説明いたします。</p><h2 id="NSG-のサービスタグが一部しか表示されない原因"><a href="#NSG-のサービスタグが一部しか表示されない原因" class="headerlink" title="NSG のサービスタグが一部しか表示されない原因"></a>NSG のサービスタグが一部しか表示されない原因</h2><p>以下のように、一部のサービスタグのみしか表示されないというお問い合わせをいただいております。</p><p><img src="/blog/network/azure-service-tag-authority/service-tag-rbac-ng.png"></p><p>結論から申し上げると、サービスタグを表示させるための、RBAC 権限が付与されていない、不足している場合、上記のような事象が発生いたします。上記のように一部のサービスタグのみしか表示されない場合、サービスタグを表示させるための、読み取りアクセス許可をユーザーに対して付与いただく必要がございます。具体的には、すべてのサービスタグを表示させるために、<span style="color: red; "><strong>サブスクリプション</strong></span>のスコープに対して、以下の 2 つの読み取り権限を付与いただく必要がございます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;Microsoft.Network/locations/serviceTags/read&quot;</span><br><span class="line">&quot;Microsoft.Network/locations/serviceTagDetails/read&quot;</span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/service-tags-overview">仮想ネットワーク サービス タグ - Virtual Network | Microsoft Learn</a></p><blockquote><p>現在のサブスクリプションに対して、認証され、読み取りアクセス許可を持つロールを持っている必要があります。</p></blockquote><h2 id="全てのサービスタグを表示させる方法"><a href="#全てのサービスタグを表示させる方法" class="headerlink" title="全てのサービスタグを表示させる方法"></a>全てのサービスタグを表示させる方法</h2><p>一部のサービスタグのみしか表示されない場合、以下の手順をご確認下さい。</p><h3 id="1-読み取りアクセス許可権限が付与されているか"><a href="#1-読み取りアクセス許可権限が付与されているか" class="headerlink" title="1. 読み取りアクセス許可権限が付与されているか"></a>1. 読み取りアクセス許可権限が付与されているか</h3><p>Azure Portal からサブスクリプションへ遷移いただき、[アクセス制御 (IAM)] &gt; アクセスの確認 &gt; 対象のユーザーを検索 &gt; 割り当てられているロールを選択 &gt; JSON から、上述の 2 つの権限、または 2 つの権限を含む権限 (e.g. “Microsoft.Network/*/read”, “*“) が付与されているかご確認下さい。</p><h3 id="2-読み取りアクセス許可権限を付与する"><a href="#2-読み取りアクセス許可権限を付与する" class="headerlink" title="2. 読み取りアクセス許可権限を付与する"></a>2. 読み取りアクセス許可権限を付与する</h3><ol><li>の手順において、サービスタグの読み取りアクセス許可が無かった場合、サブスクリプションのスコープに対して、閲覧者ロールを付与する、または、カスタムロールで最小限の権限を付与したい場合、以下の 2 つの権限をカスタムロールに追加ください。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;Microsoft.Network/locations/serviceTags/read&quot;</span><br><span class="line">&quot;Microsoft.Network/locations/serviceTagDetails/read&quot;</span><br></pre></td></tr></table></figure><p>サブスクリプションのスコープに対して、閲覧者権限を付与したい場合、Azure Portal からサブスクリプションへ遷移いただき、[アクセス制御 (IAM)] &gt; [+追加] &gt; [ロールの割り当ての追加] &gt; [閲覧者]を指定し、任意のユーザー、グループに権限を付与いただけます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/quickstart-assign-role-user-portal#grant-access">アクセス権の付与 - ロールベースのアクセス制御 | Microsoft Learn</a></p><p>カスタムロールをご利用いただいている場合、Azure Portal からサブスクリプションへ遷移いただき、[アクセス制御 (IAM)] &gt; ユーザーに付与しているカスタムロールから [編集] を押下 &gt; JSON から上記 2 つの権限を追加ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal#update-a-custom-role">カスタム ロールの更新 - ロールベースのアクセス制御 | Microsoft Learn</a></p><p>上記設定適用後、ロールの更新には少々お時間を要しますので、一度 Azure Portal からログアウトいただき、再ログインいただいた後、サービスタグが表示されるようになるかご確認いただければと存じます。</p><h2 id="カスタムロールのご利用について"><a href="#カスタムロールのご利用について" class="headerlink" title="カスタムロールのご利用について"></a>カスタムロールのご利用について</h2><p>Azure Portal の UI はサービスタグに関わらず、高頻度で改善/改修が行われているため、それに伴い、必要な権限が追加・変更になる場合がございます。そのため、カスタムロールで細かく権限を制御されている場合、Azure Portal の UI 変更にともなって、権限修正が必要になる可能性もございます。カスタムロールをご利用の場合には、お客様側でも十分に検証いただくと共に、修正が必要になる点も予めご認識いただきますようお願い申し上げます。</p><p>以上、ご参考になりましたら幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure サービスをご利用いただく中で、Azure ロールベースのアクセス制御 (RBAC) を利用し、必要な権限をユーザーに付与し、運用いただいているお客様も多いかと存じます。その中で、Azure</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Network Security Group" scheme="https://jpaztech.github.io/blog/tags/Network-Security-Group/"/>
    
    <category term="Service Tag" scheme="https://jpaztech.github.io/blog/tags/Service-Tag/"/>
    
    <category term="RBAC" scheme="https://jpaztech.github.io/blog/tags/RBAC/"/>
    
  </entry>
  
  <entry>
    <title>Artifact Streaming とは？ ACR のイメージを AKS にデプロイして試してみた</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-artifact-streaming/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-artifact-streaming/</id>
    <published>2023-12-24T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.621Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は <a href="https://qiita.com/advent-calendar/2023/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2023</a> の 24 日目の記事になります🎅</p><p>こんにちは。Azure テクニカル サポートチームの桐井です。</p><p><a href="https://techcommunity.microsoft.com/t5/apps-on-azure-blog/aks-welcomes-you-to-ignite-2023/ba-p/3983317">Ignite 2023</a> で、ACR/AKS 関連の機能としてArtifact Streaming が発表されました。<br>本記事では、Artifact Streaming を使って ACR にあるコンテナー イメージを AKS クラスターにデプロイする様子を紹介します。</p><p>Artifact Streaming は 2023/12 現在、プレビュー機能として提供されております。<br>今後のアップデートにより、将来この記事で紹介した内容から変更される可能性があることを何卒ご了承ください！</p><span id="more"></span><h2 id="Artifact-Streaming-とは"><a href="#Artifact-Streaming-とは" class="headerlink" title="Artifact Streaming とは"></a>Artifact Streaming とは</h2><blockquote><p>ご参考) Public preview: Artifact streaming support in Azure Kubernetes Service (AKS)<br><a href="https://azure.microsoft.com/ja-jp/updates/public-review-artifact-streaming-support-in-azure-kubernetes-service-aks/">https://azure.microsoft.com/ja-jp/updates/public-review-artifact-streaming-support-in-azure-kubernetes-service-aks/</a></p></blockquote><p>コンテナー イメージは、データの実体を表す複数の<code>レイヤー</code>と、イメージに含まれるレイヤーの情報をまとめた<code>マニフェスト</code>によって構成されています。</p><p>通常、コンテナー化されたアプリケーションを起動するには、コンテナー イメージの Pull (ダウンロードと展開) が必要になります。<br>イメージの Pull では次のような処理が行われます:</p><ol><li>コンテナー レジストリにアクセスし、マニフェストからレイヤーの情報を取得する</li><li>レイヤーのダウンロードが必要か確認する (ローカル キャッシュが利用できるか確認する)</li><li>各レイヤーをダウンロードする</li><li>ダウンロード済みのレイヤーを展開する</li><li>コンテナーを起動する</li></ol><p>このように、コンテナーの起動に至るまでには、イメージを構成するレイヤーのダウンロードと展開の処理が必要となります。<br>そのため、レイヤーのデータ サイズが大きい場合や、レイヤー数が多いコンテナー イメージの場合は、コンテナーが起動するまでに時間を要すことがあります。</p><p>特に、Pod のオートスケールをするシナリオでは、Pod の起動時間がオートスケールの速度に影響を与えます。</p><p>また、クラスター オートスケーラーによってノードが削減され、その後新規ノードが追加された場合には、ノード内のコンテナー イメージのキャッシュが利用できません (AKS ではノードプールの <a href="https://learn.microsoft.com/ja-jp/azure/aks/scale-down-mode">スケールダウン モード</a>が <code>Delete</code> の場合)。<br>新規ノードでは、コンテナー イメージのダウンロードと展開が再び必要となってしまうため、Pod の起動完了までに時間を要する要因となってしまいます。</p><p>これらの問題は、Artifact Streaming を利用することで、解決を図ることができます。<br>Artifact Streaming を利用すると、コンテナー イメージ全体のダウンロードと展開を待つことなく、コンテナーを開始できます。</p><h2 id="Artifact-Streaming-を試してみよう"><a href="#Artifact-Streaming-を試してみよう" class="headerlink" title="Artifact Streaming を試してみよう"></a>Artifact Streaming を試してみよう</h2><p>実際に AKS クラスターへコンテナー イメージをデプロイして、Artifact Streaming によってイメージの Pull 時間が変化するかを試してみましょう。</p><p>今回の検証では、コンテナー イメージとして <code>docker.io/jupyter/all-spark-notebook:latest</code> を使用します。<br>AKS にデプロイをする前に、まずは手元の PC でイメージの Pull を試してみます。<br>次のように、多数のレイヤーによって構成されているコンテナー イメージであることがわかります。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull docker.io/jupyter/all-spark-notebook:latest</span></span><br><span class="line">latest: Pulling from jupyter/all-spark-notebook</span><br><span class="line">aece8493d397: Pull complete</span><br><span class="line">fd92c719666c: Pull complete</span><br><span class="line">088f11eb1e74: Pull complete</span><br><span class="line">4f4fb700ef54: Pull complete</span><br><span class="line">ef8373d600b0: Pull complete</span><br><span class="line">77e45ee945dc: Pull complete</span><br><span class="line">a30f89a0af6c: Download complete</span><br><span class="line">dc42adc7eb73: Download complete</span><br><span class="line">abaa8376a650: Downloading [==&gt;                                                ]  4.314MB/104.8MB</span><br><span class="line">aa099bb9e49a: Download complete</span><br><span class="line">822c4cbcf6a6: Download complete</span><br><span class="line">d25166dcdc7b: Downloading [====&gt;                                              ]  2.494MB/30.5MB</span><br><span class="line">964fc3e4ff9f: Waiting</span><br><span class="line">2c4c69587ee4: Waiting</span><br><span class="line">de2cdd875fa8: Waiting</span><br><span class="line">75d33599f5f2: Waiting</span><br><span class="line">31973ea82470: Waiting</span><br><span class="line">96ee7e4439c7: Waiting</span><br><span class="line">1f9ad23c07ac: Waiting</span><br><span class="line">d19266e0cb17: Waiting</span><br><span class="line">9a165b6e9dc7: Pulling fs layer</span><br><span class="line">5689442fd4e1: Pulling fs layer</span><br><span class="line">9a6a202f62a6: Waiting</span><br><span class="line">734ea0c3d94e: Waiting</span><br><span class="line">a21a167f7127: Waiting</span><br><span class="line">467e20fcd668: Waiting</span><br><span class="line">7024bb03412a: Waiting</span><br><span class="line">7c128e9d2ddd: Waiting</span><br><span class="line">80782ae10995: Waiting</span><br><span class="line">691924032e73: Waiting</span><br><span class="line">05c5a5d9ae5f: Waiting</span><br><span class="line">15a3d66e1b80: Waiting</span><br><span class="line">688c0dcd61fc: Waiting</span><br><span class="line">ed7d16094f4e: Waiting</span><br></pre></td></tr></table></figure><h3 id="Artifact-Streaming-を使用する準備"><a href="#Artifact-Streaming-を使用する準備" class="headerlink" title="Artifact Streaming を使用する準備"></a>Artifact Streaming を使用する準備</h3><p>本記事の手順は、次のドキュメントに記載されている手順に沿っています。<br>ドキュメントをあわせてご参照ください。</p><blockquote><p>Azure Kubernetes Service (AKS) の成果物ストリーミングを使用してイメージのプル時間を短縮する (プレビュー)<br><a href="https://learn.microsoft.com/ja-jp/azure/aks/artifact-streaming">https://learn.microsoft.com/ja-jp/azure/aks/artifact-streaming</a></p></blockquote><p>Artifact Streaming を利用するために、Azure Container Registry (ACR) のリポジトリを設定していきます。</p><p>はじめに、今回利用するコンテナーイメージを ACR にインポートします。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr import -n &#123;ACR_NAME&#125; \</span></span><br><span class="line"><span class="bash">    --<span class="built_in">source</span> docker.io/jupyter/all-spark-notebook:latest \</span></span><br><span class="line"><span class="bash">    -t jupyter/all-spark-notebook:latest</span></span><br></pre></td></tr></table></figure><p>イメージのインポートが完了したら、Artifact Streaming を作成します。<br>作成にはしばらく時間がかかります。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr artifact-streaming create -n &#123;ACR_NAME&#125; \</span></span><br><span class="line"><span class="bash">    --image jupyter/all-spark-notebook:latest</span></span><br></pre></td></tr></table></figure><p><code>az acr artifact-streaming create</code> コマンドを実行すると、作成の進捗を確認するためのコマンド例が表示されます。<br><code>az acr artifact-streaming operation show</code> コマンドで進捗が確認できます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr artifact-streaming operation show -n &#123;ACR_NAME&#125; \</span></span><br><span class="line"><span class="bash">    --repository jupyter/all-spark-notebook \</span></span><br><span class="line"><span class="bash">    --id d7ea8de0-1810-48a1-b9b8-ed7f667ae1f6</span></span><br><span class="line"></span><br><span class="line">Command group &#x27;acr artifact-streaming&#x27; is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus</span><br><span class="line">&#123;</span><br><span class="line">  &quot;details&quot;: &quot;Conversion ongoing for resource jupyter/all-spark-notebook@sha256:b63bae2d9d34779ac969deeb4834efd838991f77269ca9a76bf6b0d1f8678d29&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;ArtifactStreamingConversion&quot;,</span><br><span class="line">  &quot;progress&quot;: &quot;8%&quot;,</span><br><span class="line">  &quot;resource&quot;: &quot;jupyter/all-spark-notebook@sha256:b63bae2d9d34779ac969deeb4834efd838991f77269ca9a76bf6b0d1f8678d29&quot;,</span><br><span class="line">  &quot;startTime&quot;: &quot;2023-12-07T07:27:12Z&quot;,</span><br><span class="line">  &quot;status&quot;: &quot;Running&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Artifact Streaming の作成が完了したら、レジストリに存在する Artifact Streaming の一覧を確認してみましょう。<br><code>az acr manifest list-referrers</code> コマンドに、レジストリ名とイメージ名を指定して実行します。<br><code>&quot;artifactType&quot;</code> が <code>&quot;application/vnd.azure.artifact.streaming.v1&quot;</code> となっていますね。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr manifest list-referrers -r &#123;ACR_NAME&#125; \</span></span><br><span class="line"><span class="bash">    -n jupyter/all-spark-notebook:latest</span></span><br><span class="line"></span><br><span class="line">Command group &#x27;acr manifest&#x27; is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus</span><br><span class="line">&#123;</span><br><span class="line">  &quot;manifests&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;annotations&quot;: &#123;</span><br><span class="line">        &quot;streaming.format&quot;: &quot;overlaybd&quot;,</span><br><span class="line">        &quot;streaming.platform.arch&quot;: &quot;amd64&quot;,</span><br><span class="line">        &quot;streaming.platform.os&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;streaming.version&quot;: &quot;v1&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;artifactType&quot;: &quot;application/vnd.azure.artifact.streaming.v1&quot;,</span><br><span class="line">      &quot;digest&quot;: &quot;sha256:2cba83dae18f99b6c958e9e34421dadaeee0db1cde4adc0241180de80efd4f34&quot;,</span><br><span class="line">      &quot;mediaType&quot;: &quot;application/vnd.oci.image.manifest.v1+json&quot;,</span><br><span class="line">      &quot;size&quot;: 17266</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>続いて AKS 側の設定をします。<br>Artifact Streaming を利用するには、Artifact Streaming オプションを有効化した AKS ノードプールが必要になります。</p><p><code>az aks nodepool add</code> コマンドに <code>--enable-artifact-streaming</code> オプションを付与して、新しいノードプールを追加します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az aks nodepool add \</span></span><br><span class="line"><span class="bash">    --resource-group myResourceGroup \</span></span><br><span class="line"><span class="bash">    --cluster-name myAKSCluster \</span></span><br><span class="line"><span class="bash">    --name acrtest \</span></span><br><span class="line"><span class="bash">    --node-count 1 \</span></span><br><span class="line"><span class="bash">    --enable-artifact-streaming</span></span><br></pre></td></tr></table></figure><p>ここでは <code>acrtest</code> という名前でノードプールを追加しました。<br><code>kubectl get nodes</code> コマンドでノードの一覧を表示すると、新しいノードが追加されていることが確認できます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE     VERSION</span><br><span class="line">aks-acrtest-29138108-vmss000000     Ready    agent   4h15m   v1.27.3</span><br><span class="line">aks-nodepool2-20356098-vmss00001d   Ready    agent   27h     v1.27.3</span><br></pre></td></tr></table></figure><p>これで ACR と AKS の準備は完了です！</p><h3 id="AKS-へのデプロイを試してみる"><a href="#AKS-へのデプロイを試してみる" class="headerlink" title="AKS へのデプロイを試してみる"></a>AKS へのデプロイを試してみる</h3><p>準備したコンテナー イメージを AKS クラスターにデプロイして、Artifact Streaming によってイメージの Pull 時間が短縮されているか確かめてみましょう。</p><p>検証では、Artifact Streaming が無効のノードプールと、有効のノードプールのそれぞれに、同じコンテナー イメージを使用する Deployment をデプロイします。</p><h4 id="Artifact-Streaming-が無効の場合"><a href="#Artifact-Streaming-が無効の場合" class="headerlink" title="Artifact Streaming が無効の場合"></a>Artifact Streaming が無効の場合</h4><p><code>nodeSelector</code> を使用して、Artifact Streaming が無効のノードプールに Pod をデプロイします。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jupyter</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jupyter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jupyter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jupyter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;agentpool&quot;:</span> <span class="string">nodepool2</span>  <span class="comment"># Artifact Streaming が無効のノードプール</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jupyter</span></span><br><span class="line">        <span class="attr">image:</span> &#123;<span class="string">ACR_NAME</span>&#125;<span class="string">.azurecr.io/jupyter/all-spark-notebook:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>YAML マニフェストをクラスターにデプロイします。<br><code>jupyter-79c4469c65-5cfpf</code> Pod が生成されました。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -o wide</span></span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE     IP            NODE                                NOMINATED NODE   READINESS GATES</span><br><span class="line">jupyter-79c4469c65-5cfpf                      1/1     Running   0          3m16s   10.244.0.19   aks-nodepool2-20356098-vmss00001i   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><code>kubectl describe pod</code> コマンドの結果から、Events フィールドのメッセージを確認します。</p><p><code>Pulled</code> イベントでは、<code>Successfully pulled image &quot;&#123;イメージ名&#125;&quot; in 1m25.27926119s</code> のようにメッセージが表示されています。<br>イメージの Pull に 1分25秒 ほど要したようです。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod jupyter-79c4469c65-5cfpf</span></span><br><span class="line">Name:             jupyter-79c4469c65-5cfpf</span><br><span class="line">  ...</span><br><span class="line">Node:             aks-nodepool2-20356098-vmss00001i/10.240.0.4</span><br><span class="line">  ...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  3m25s  default-scheduler  Successfully assigned default/jupyter-79c4469c65-5cfpf to aks-nodepool2-20356098-vmss00001i</span><br><span class="line">  Normal  Pulling    3m25s  kubelet            Pulling image &quot;&#123;ACR_NAME&#125;.azurecr.io/jupyter/all-spark-notebook:latest&quot;</span><br><span class="line">  Normal  Pulled     2m     kubelet            Successfully pulled image &quot;&#123;ACR_NAME&#125;.azurecr.io/jupyter/all-spark-notebook:latest&quot; in 1m25.27926119s (1m25.279277391s including waiting)</span><br><span class="line">  Normal  Created    2m     kubelet            Created container jupyter</span><br><span class="line">  Normal  Started    119s   kubelet            Started container jupyter</span><br></pre></td></tr></table></figure><h4 id="Artifact-Streaming-が有効の場合"><a href="#Artifact-Streaming-が有効の場合" class="headerlink" title="Artifact Streaming が有効の場合"></a>Artifact Streaming が有効の場合</h4><p>続いて Artifact Streaming を利用した場合の動作を確認してみましょう。</p><p><code>nodeSelector</code> を使用して、Artifact Streaming が有効のノードプールに Pod をデプロイします。<br>Pod 名やコンテナー名を変更していますが、使用するコンテナー イメージは先ほどと同じ <code>&#123;ACR_NAME&#125;.azurecr.io/jupyter/all-spark-notebook:latest</code> です。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jupyter-artifact-streaming</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jupyter-artifact-streaming</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jupyter-artifact-streaming</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jupyter-artifact-streaming</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;agentpool&quot;:</span> <span class="string">acrtest</span>  <span class="comment"># Artifact Streaming が有効のノードプール</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jupyter</span></span><br><span class="line">        <span class="attr">image:</span> &#123;<span class="string">ACR_NAME</span>&#125;<span class="string">.azurecr.io/jupyter/all-spark-notebook:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>YAML マニフェストをクラスターにデプロイします。<br><code>jupyter-artifact-streaming-5b58c9c797-pxs4l</code> Pod が生成されました。デプロイ先を指定したので、<code>acrtest</code>ノードプールのノードにデプロイされていますね。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -o wide</span></span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE     IP            NODE                                NOMINATED NODE   READINESS GATES</span><br><span class="line">jupyter-79c4469c65-c8hm6                      1/1     Running   0          2m10s   10.244.1.24   aks-nodepool2-20356098-vmss00001d   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">jupyter-artifact-streaming-5b58c9c797-pxs4l   1/1     Running   0          6s      10.244.2.5    aks-acrtest-29138108-vmss000000     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><code>kubectl describe pod</code> コマンドの結果から、Events フィールドのメッセージを確認します。</p><p><code>Pulling</code> イベントでは、<code>Streaming enabled for &quot;&#123;イメージ名&#125;&quot;</code> のようにメッセージが表示されており、Artifact Streaming が利用されていることが確認できます。</p><p>また、<code>Pulled</code> イベントでは、<code>Successfully pulled image &quot;&#123;イメージ名&#125;&quot; in 3.442267417s</code> のようにメッセージが表示されています。<br>およそ 3.44 秒ほどでイメージ Pull が完了しました！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod jupyter-artifact-streaming-5b58c9c797-pxs4l</span></span><br><span class="line">Name:             jupyter-artifact-streaming-5b58c9c797-pxs4l</span><br><span class="line">  ...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age        From                                                   Message</span><br><span class="line">  ----    ------     ----       ----                                                   -------</span><br><span class="line">  Normal  Pulling    &lt;unknown&gt;  acr-nodemon, kubelet, aks-acrtest-29138108-vmss000000  Streaming enabled for &quot;&#123;ACR_NAME&#125;.azurecr.io/jupyter/all-spark-notebook:latest&quot;, upgraded to streaming artifact with digest &quot;sha256:2cba83dae18f99b6c958e9e34421dadaeee0db1cde4adc0241180de80efd4f34&quot;, container started in 5s</span><br><span class="line">  Normal  Scheduled  19s        default-scheduler                                      Successfully assigned default/jupyter-artifact-streaming-5b58c9c797-pxs4l to aks-acrtest-29138108-vmss000000</span><br><span class="line">  Normal  Pulling    19s        kubelet                                                Pulling image &quot;&#123;ACR_NAME&#125;.azurecr.io/jupyter/all-spark-notebook:latest&quot;</span><br><span class="line">  Normal  Pulled     15s        kubelet                                                Successfully pulled image &quot;&#123;ACR_NAME&#125;.azurecr.io/jupyter/all-spark-notebook:latest&quot; in 3.442267417s (3.442273818s including waiting)</span><br><span class="line">  Normal  Created    14s        kubelet                                                Created container jupyter</span><br><span class="line">  Normal  Started    14s        kubelet                                                Started container jupyter</span><br></pre></td></tr></table></figure><p>Artifact Streaming を使わない場合では 1分25秒 ほど要したため、大幅に短縮されていますね！</p><h3 id="Artifact-Streaming-を削除するには？"><a href="#Artifact-Streaming-を削除するには？" class="headerlink" title="Artifact Streaming を削除するには？"></a>Artifact Streaming を削除するには？</h3><p><code>az acr artifact-streaming delete</code> というコマンドは存在しないようです。</p><p>作成した Artifact Streaming を削除したい場合には、リポジトリに存在するイメージ自体を削除します。<br>イメージの削除にともない Artifact Streaming も一緒に削除されます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr repository delete -n &#123;ACR_NAME&#125; --repository jupyter/all-spark-notebook</span></span><br></pre></td></tr></table></figure><h3 id="どのようなしくみなのか？"><a href="#どのようなしくみなのか？" class="headerlink" title="どのようなしくみなのか？"></a>どのようなしくみなのか？</h3><p>Artifact Streaming を使うと、なぜイメージ Pull の時間が短縮されるのでしょうか？</p><p>Artifact Streaming では、OverlayBD イメージ フォーマットというオープンソースのソリューションを利用しています。</p><blockquote><p>ご参考) containerd/overlaybd<br><a href="https://github.com/containerd/overlaybd">https://github.com/containerd/overlaybd</a></p></blockquote><blockquote><p>ご参考) containerd/accelerated-container-image<br><a href="https://github.com/containerd/accelerated-container-image">https://github.com/containerd/accelerated-container-image</a></p></blockquote><p>OverlayBD は、アリババクラウドのコンテナーイメージ加速技術プロジェクト DADI で開発されました。</p><blockquote><p>DADI: Alibaba Cloud’s Open-Source Accelerated Container Image Technology<br><a href="https://www.alibabacloud.com/blog/dadi-alibaba-clouds-open-source-accelerated-container-image-technology_597956">https://www.alibabacloud.com/blog/dadi-alibaba-clouds-open-source-accelerated-container-image-technology_597956</a></p></blockquote><p>OverlayBD は、コンテナー イメージのレイヤーを仮想ブロック デバイスとして提供し、オーバーレイ ファイルシステムとしてマウントします。<br>コンテナーは、オーバーレイ ファイルシステムを通してイメージのデータにアクセスをします。<br>コンテナーの起動前にイメージ全体をダウンロードや展開することなく、必要なデータのみをネットワーク経由でオンデマンドに読み込むことができます。</p><p>ネットワーク ドライブに保存されたファイルを、手元のマシンに一度ダウンロードしてから開くのではなく、SMB/CIFS でマウントして直接開く様子に似ていますね。</p><p>Pod がデプロイされたノードにログインし、<code>df</code> コマンドを実行すると、出力結果の中に <code>io.containerd.snapshotter.v1.overlaybd</code> の文字列が含まれていることが確認できます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@aks-acrtest-29138108-vmss000000:/# df -h | grep overlaybd</span><br><span class="line">/dev/sdc        252G  5.6G  234G   3% /var/lib/containerd/io.containerd.snapshotter.v1.overlaybd/snapshots/239/block/mountpoint</span><br></pre></td></tr></table></figure><hr><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>本記事では、Artifact Streaming の概要と、実際に AKS クラスターへコンテナーをデプロイした様子を紹介しました。<br>サイズの大きいコンテナー イメージを使用する Pod で起動時間を短縮したい場合に、利用を検討してみると良さそうです。</p><p>今回紹介しました Artifact Streaming が、今後の技術選定や AKS をよりご活用いただくうえでのご参考になりましたら幸いです。</p><p>Artifact Streaming は2023年12月現在、パブリック プレビューとして提供されております。ご利用いただきました際にお気づきの点やご要望などがございました際は、お気兼ねなくフィードバックいただけましたら幸いでございます。<br>また、AKS のご利用において、お困りの点やご不明点がありました際は、いつでも Azure サポートまでお気兼ねなくご相談ください。</p><hr><p>最後まで読んでいただきありがとうございました！<br><a href="https://qiita.com/advent-calendar/2023/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2023</a> は明日が最終日となります。是非ご覧くださいー！</p><p>本年は多くのお客様にお世話になりました。ありがとうございました。<br>来年もみなさまにとって素晴らしい年でありますように、心よりお祈り申し上げます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2023/microsoft-azure-tech&quot;&gt;Microsoft Azure Tech Advent Calendar 2023&lt;/a&gt; の 24 日目の記事になります🎅&lt;/p&gt;
&lt;p&gt;こんにちは。Azure テクニカル サポートチームの桐井です。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://techcommunity.microsoft.com/t5/apps-on-azure-blog/aks-welcomes-you-to-ignite-2023/ba-p/3983317&quot;&gt;Ignite 2023&lt;/a&gt; で、ACR/AKS 関連の機能としてArtifact Streaming が発表されました。&lt;br&gt;本記事では、Artifact Streaming を使って ACR にあるコンテナー イメージを AKS クラスターにデプロイする様子を紹介します。&lt;/p&gt;
&lt;p&gt;Artifact Streaming は 2023/12 現在、プレビュー機能として提供されております。&lt;br&gt;今後のアップデートにより、将来この記事で紹介した内容から変更される可能性があることを何卒ご了承ください！&lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
    <category term="Azure Container Registry (ACR)" scheme="https://jpaztech.github.io/blog/tags/Azure-Container-Registry-ACR/"/>
    
  </entry>
  
  <entry>
    <title>ACR の Firewall 機能を有効にした状態で ACR の機能を用いてコンテナー イメージをビルドする方法について</title>
    <link href="https://jpaztech.github.io/blog/containers/acr-how-to-build-image-with-firewall/"/>
    <id>https://jpaztech.github.io/blog/containers/acr-how-to-build-image-with-firewall/</id>
    <published>2023-12-22T03:00:00.000Z</published>
    <updated>2024-03-21T03:28:48.609Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は<a href="https://qiita.com/advent-calendar/2023/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2023</a> の 22 日目の記事になります。</p><p>こんにちは！ Azure テクニカル サポート チームの川畑です。<br>az acr buildコマンドを用いてコンテナー イメージをビルドする際に、ACR の Firewall 機能によって失敗するお問い合わせを頂きます。<br>この記事では、ACR のFirewall 機能を有効にした状態で ACR の機能を用いてコンテナー イメージをビルドする方法についてご紹介します。</p><span id="more"></span><hr><h2 id="ACR-のパブリック-ネットワーク-アクセス機能とは"><a href="#ACR-のパブリック-ネットワーク-アクセス機能とは" class="headerlink" title="ACR のパブリック ネットワーク アクセス機能とは"></a>ACR のパブリック ネットワーク アクセス機能とは</h2><p>ACR では、お客様のコンテナー イメージなど OCI アーティファクトをより安全に管理いただくために、ACR にアクセス可能な端末を制限するためのパブリック ネットワーク アクセス機能を提供しております。<br>パブリック ネットワーク アクセスの設定には、次の3 種類があります。</p><ul><li><p>「すべてのネットワーク」<br>名前の通りネットワーク レベルでの制限を実施いたしません。<br>そのため、インターネット経由でのアクセスを受け付けることが可能となります。</p></li><li><p>「選択されたネットワーク」<br>ACR の Firewall 機能を用いて、IP アドレス ベースでのアクセス制限を設けることが可能となります。<br>なお、ここで許可可能な IP アドレスの形式は CIDR 形式となっているため、IP アドレス レンジを許可することなども可能となります。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>許可可能な IP 規則は最大 100 個までとなります。</br></p><p>　ご参考情報：パブリック IP ネットワーク ルールを構成する </br></p><p>　<a href="https://learn.microsoft.com/ja-jp/azure/container-registry/container-registry-access-selected-networks">https://learn.microsoft.com/ja-jp/azure/container-registry/container-registry-access-selected-networks</a> </br></p></div><div class="alert is-warning"><p class="alert-title">警告</p><p>この設定を入れることによって、Azure Portal からリポジトリの情報を参照できなくなる 場合があります。</br></p><p>これは、Azure Portal を用いて ACR へアクセスしているクライアント端末の IP アドレスが許可されていないためとなります。</br></p><p>そのため、Azure Portal より ACR 内の情報を参照する必要がある場合には、クライアント端末のパブリック IP アドレスを許可してください。</p></div></li><li><p>「無効」<br>名前の通りパブリック IP アドレス経由でのアクセスを全て防ぐことが可能となります。<br>この設定だけでは、ACR にアクセス可能な端末が存在しなくなるため、あわせてプライベート エンドポイントを経由したアクセスを可能なように構成いただく必要があります。<br>下記ドキュメントに設定方法がまとまっておりますので、あわせてご参照ください。<br>　ご参考情報：Azure Private Link を使用して Azure Container Registry にプライベートで接続する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/container-registry/container-registry-private-link">https://learn.microsoft.com/ja-jp/azure/container-registry/container-registry-private-link</a></p></li></ul><h2 id="ACR-ビルドとは"><a href="#ACR-ビルドとは" class="headerlink" title="ACR ビルドとは"></a>ACR ビルドとは</h2><p>ACR ビルドとは、お客様のクライアント端末上ではなく、Azure が管理している各リージョンに存在する ACR 用のエージェントを用いてコンテナー イメージを作成する機能となります。</p><p>この機能を用いることで、お客様のクライアント端末にて Docker などのコンテナー ランタイムをインストールすることなく、Azure が用意しているエージェントを用いてコンテナー イメージを作成、ACR へプッシュすることが出来ます。</p><p>下記 は ACR ビルドの実行結果の一例となります。<br>今回の例では、 外部のコンテナー レジストリー (mcr.microsoft.com) より hello-world というコンテナー イメージを取得し、起動する Docker イメージを作成、ACR へプッシュします。</p><p>まずは、Docker イメージを作成するために Dockerfile を用意します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;FROM mcr.microsoft.com/hello-world&quot;</span> &gt; Dockerfile</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat Dockerfile</span> </span><br><span class="line">FROM mcr.microsoft.com/hello-world</span><br></pre></td></tr></table></figure><p>それでは、この Dockerfile を基に ACR ビルドを使って Docker イメージの作成、ACR へプッシュを行います。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr build --registry blogbuildtest --image buildtest/hello-world:v1 --file Dockerfile .</span></span><br><span class="line">Packing source code into tar to upload...</span><br><span class="line">Uploading archived source code from &#x27;/tmp/build_archive_6d41a3f0c1e24e1cbac736d1b271ad6c.tar.gz&#x27;...</span><br><span class="line">Sending context (345.000 Bytes) to registry: blogbuildtest...</span><br><span class="line">Queued a build with ID: ca1</span><br><span class="line">Waiting for an agent...</span><br><span class="line">2023/12/11 05:16:49 Downloading source code...</span><br><span class="line">2023/12/11 05:16:49 Finished downloading source code</span><br><span class="line">2023/12/11 05:16:50 Using acb_vol_4cfc16ec-0963-4b43-8581-f87207679198 as the home volume</span><br><span class="line">2023/12/11 05:16:50 Setting up Docker configuration...</span><br><span class="line">2023/12/11 05:16:50 Successfully set up Docker configuration</span><br><span class="line">2023/12/11 05:16:50 Logging in to registry: blogbuildtest.azurecr.io</span><br><span class="line">2023/12/11 05:16:51 Successfully logged into blogbuildtest.azurecr.io</span><br><span class="line">2023/12/11 05:16:51 Executing step ID: build. Timeout(sec): 28800, Working directory: &#x27;&#x27;, Network: &#x27;&#x27;</span><br><span class="line">2023/12/11 05:16:51 Scanning for dependencies...</span><br><span class="line">2023/12/11 05:16:51 Successfully scanned dependencies</span><br><span class="line">2023/12/11 05:16:51 Launching container with name: build</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/1 : FROM mcr.microsoft.com/hello-world</span><br><span class="line">latest: Pulling from hello-world</span><br><span class="line">1b930d010525: Pulling fs layer</span><br><span class="line">1b930d010525: Verifying Checksum</span><br><span class="line">1b930d010525: Download complete</span><br><span class="line">1b930d010525: Pull complete</span><br><span class="line">Digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">Status: Downloaded newer image for mcr.microsoft.com/hello-world:latest</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> fce289e99eb9</span></span><br><span class="line">Successfully built fce289e99eb9</span><br><span class="line">Successfully tagged blogbuildtest.azurecr.io/buildtest/hello-world:v1</span><br><span class="line">2023/12/11 05:16:52 Successfully executed container: build</span><br><span class="line">2023/12/11 05:16:52 Executing step ID: push. Timeout(sec): 3600, Working directory: &#x27;&#x27;, Network: &#x27;&#x27;</span><br><span class="line">2023/12/11 05:16:52 Pushing image: blogbuildtest.azurecr.io/buildtest/hello-world:v1, attempt 1</span><br><span class="line">The push refers to repository [blogbuildtest.azurecr.io/buildtest/hello-world]</span><br><span class="line">af0b15c8625b: Preparing</span><br><span class="line">af0b15c8625b: Pushed</span><br><span class="line">v1: digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a size: 524</span><br><span class="line">2023/12/11 05:16:54 Successfully pushed image: blogbuildtest.azurecr.io/buildtest/hello-world:v1</span><br><span class="line">2023/12/11 05:16:54 Step ID: build marked as successful (elapsed time in seconds: 1.093391)</span><br><span class="line">2023/12/11 05:16:54 Populating digests for step ID: build...</span><br><span class="line">2023/12/11 05:16:54 Successfully populated digests for step ID: build</span><br><span class="line">2023/12/11 05:16:54 Step ID: push marked as successful (elapsed time in seconds: 1.829038)</span><br><span class="line">2023/12/11 05:16:54 The following dependencies were found:</span><br><span class="line">2023/12/11 05:16:54 </span><br><span class="line">- image:</span><br><span class="line">    registry: blogbuildtest.azurecr.io</span><br><span class="line">    repository: buildtest/hello-world</span><br><span class="line">    tag: v1</span><br><span class="line">    digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">  runtime-dependency:</span><br><span class="line">    registry: mcr.microsoft.com</span><br><span class="line">    repository: hello-world</span><br><span class="line">    tag: latest</span><br><span class="line">    digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">  git: &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Run ID: ca1 was successful after 6s</span><br></pre></td></tr></table></figure><p>しかしながら、上述の通り、ACR ビルドは Azure にて管理している各リージョンに存在する ACR 用のエージェントによってコンテナー イメージの作成、ACR へのプッシュをする機能であるため、<strong>ACR 用のエージェントからお客様の ACR へのアクセス</strong>が行われます。</p><p>このアクセスには、パブリック IP アドレスが使われているため、ACR の Firewall 機能を用いてパブリック アクセスを防がれている ACR へのアクセスが失敗することが予想されます。</p><p>試しに Azure VM を用意し、この Azure VM が利用しているパブリック IP アドレスを ACR の Firewall 機能によって許可します。</p><p>この設定の場合、Azure VM から ACR への通信は成功するため、ACR からコンテナー イメージの取得等は実行できますが、ACR ビルドは失敗します。</p><p>作成した Azure VM は以下の通りであり、割り当てられたパブリック IP アドレスは 4.xxx.xxx.xxx となります。</p><p><img src="/blog/containers/acr-how-to-build-image-with-firewall/vm_information.png"><br>それでは、この IP アドレスを ACR の Firewall 機能で許可します。</p><p><img src="/blog/containers/acr-how-to-build-image-with-firewall/acr_information.png"><br>では、Azure VM に SSH をして、Docker イメージを ACR から取得してみます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull blogbuildtest.azurecr.io/buildtest/hello-world:v1</span></span><br><span class="line">v1: Pulling from buildtest/hello-world</span><br><span class="line">1b930d010525: Pull complete</span><br><span class="line">Digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">Status: Downloaded newer image for blogbuildtest.azurecr.io/buildtest/hello-world:v1</span><br><span class="line">blogbuildtest.azurecr.io/buildtest/hello-world:v1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker images</span></span><br><span class="line">REPOSITORY                                       TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">blogbuildtest.azurecr.io/buildtest/hello-world   v1        fce289e99eb9   4 years ago   1.84kB</span><br></pre></td></tr></table></figure><p>docker pull コマンドによってコンテナー イメージを ACR から取得出来ました。<br>次に ACR ビルドを使ってコンテナー イメージの作成をしてみます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr build --registry blogbuildtest --image buildtestfromvm/hello-world:v1 --file Dockerfile .</span></span><br><span class="line">Packing source code into tar to upload...</span><br><span class="line">Uploading archived source code from &#x27;/tmp/build_archive_ba9f4b643e5b4b79b251d6213e8abd99.tar.gz&#x27;...</span><br><span class="line">Sending context (26.336 KiB) to registry: blogbuildtest...</span><br><span class="line">Queued a build with ID: ca2</span><br><span class="line">Waiting for an agent...</span><br><span class="line">2023/12/11 06:06:48 Downloading source code...</span><br><span class="line">2023/12/11 06:06:48 Finished downloading source code</span><br><span class="line">2023/12/11 06:06:48 Using acb_vol_f6e0b320-1247-4584-b5c3-c620a4d138e5 as the home volume</span><br><span class="line">2023/12/11 06:06:48 Setting up Docker configuration...</span><br><span class="line">2023/12/11 06:06:49 Successfully set up Docker configuration</span><br><span class="line">2023/12/11 06:06:49 Logging in to registry: blogbuildtest.azurecr.io</span><br><span class="line">failed to login, ran out of retries: failed to set docker credentials: Error response from daemon: Get &quot;https://blogbuildtest.azurecr.io/v2/&quot;: denied: client with IP &#x27;52.xxx. xxx.  xxx &#x27; is not allowed access. Refer https://aka.ms/acr/firewall to grant access.</span><br><span class="line">: exit status 1</span><br><span class="line">Run ID: ca2 failed after 5s. Error: failed during run, err: exit status 1</span><br><span class="line">Run failed</span><br></pre></td></tr></table></figure><p>予想通り Failed となることが確認できました。<br>なお、この IP アドレス 52.xxx.xxx.xxx が ACR のエージェントが利用しているパブリック IP アドレスとなり、このパブリック IP アドレスが許可されていないことから処理が失敗したことが確認できました。</p><h2 id="ACR-ビルドの代替策"><a href="#ACR-ビルドの代替策" class="headerlink" title="ACR ビルドの代替策"></a>ACR ビルドの代替策</h2><p>前置きが長くなってしまいましたが、上述のように ACR ビルドを用いてコンテナー イメージを作成する場合、ACR の Firewall 機能によってアクセスが防がれてしまう場合があります。<br>この回避策としては、以下の方法が挙げられます。</p><ol><li><p>パブリック ネットワーク アクセスの設定を「すべてのネットワーク」に変更する<br>ACR のエージェントが ACR へアクセスする際に使用しているパブリック IP アドレスが許可されていないことで本事象は発生するため、インターネットからのアクセスを全て受け付けるよう変更いただくことで事象が改善します。</p></li><li><p>ACR のエージェントが利用するパブリック IP アドレスを許可する<br>ACR のエージェントが利用するパブリック IP アドレスを「選択されたネットワーク」の IP 規則に追加する方法が挙げられます。<br>Azure では、下記サイトにて  Azure の各サービスが利用する IP アドレスを公開しているため、こちらの AzureContainerRegistry.<region> の IP アドレスを追加いただくことで事象が改善することが想定されます。<br>　ご参考情報：Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center<br>　<a href="https://www.microsoft.com/en-us/download/confirmation.aspx?id=56519">https://www.microsoft.com/en-us/download/confirmation.aspx?id=56519</a></p><div class="alert is-warning"><p class="alert-title">警告</p><p>ACR 含め Azure が利用するパブリック IP アドレスは動的なものであり、今後変更される可能性があります。</p><p>そのため、定期的もしくはアクセスが失敗するようになりましたら、最新の ACR のパブリック IP アドレスをご確認・更新いただく必要があります。</p></div></li><li><p>ACR タスクを利用する<br>ACR の Firewall 機能では、「信頼されたサービス」のアクセスについては別途 IP 規則を追加いただくことなく、アクセスを許可することが可能となります。<br>そして、この 「信頼されたサービス」に、下記ドキュメントに記載の通り ACR タスクが登録されています。<br>　ご参考情報：信頼できるサービス<br>　<a href="https://learn.microsoft.com/ja-jp/azure/container-registry/allow-access-trusted-services#trusted-services">https://learn.microsoft.com/ja-jp/azure/container-registry/allow-access-trusted-services#trusted-services</a> </p><p>ACR タスクは、ACR ビルドの制御等を行うことができ、ACR ビルド同様にコンテナー イメージの作成を行うことが可能となります。<br>そのため、ACR ビルドの代替方法として ACR タスクをご利用いただくことで ACR の Firewall 機能でパブリック アクセスを防いだまま ACR の機能によってコンテナー イメージを作成することが可能となります。<br>次のセクションにて ACR タスクを使ったコンテナー イメージの作成方法について紹介します。</p></li></ol><h2 id="ACR-タスクのご紹介"><a href="#ACR-タスクのご紹介" class="headerlink" title="ACR タスクのご紹介"></a>ACR タスクのご紹介</h2><p>上述の通り、ACR タスクでは、ACR ビルドと同様に ACR の機能を使ってコンテナー イメージを作成することが可能となります。<br>それでは、早速 ACR タスクを使って Firewall 機能を有効化した ACR に対してコンテナー イメージの作成、プッシュをしてみます。</p><p>なお、おおまかな手順につきましては、下記ドキュメントにて記載されています。<br>こちらを参考に実施してみます。<br>　ご参考情報：例:ACR タスク<br>　<a href="https://learn.microsoft.com/ja-jp/azure/container-registry/allow-access-trusted-services#example-acr-tasks">https://learn.microsoft.com/ja-jp/azure/container-registry/allow-access-trusted-services#example-acr-tasks</a></p><p>ACR タスクを作成する前に事前準備が必要となります。</p><p>ACR ビルドでは、コンテナー イメージの作成に使用していた Dockerfile を az acr build コマンドを実行したクライアント端末に存在していましたが、ACR タスクでは ACR のエージェントにてアクセスが可能な場所に配置する必要があります。<br>ここでは、Dockerfile を ACR 上に配置し、ACR 上に配置した Dockerfile を ACR タスクより使用してコンテナー イメージを作成してみます。</p><p>ACR に Dockerfile を配置するにあたり、オープン ソースにて開発がされている ORAS を使用します。<br>簡単な使用方法につきましては、下記ドキュメントでも紹介されておりますので、ご参考ください。<br>　ご参考情報：Azure コンテナー レジストリを使って OCI 成果物をプッシュおよびプルする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/container-registry/container-registry-oci-artifacts">https://learn.microsoft.com/ja-jp/azure/container-registry/container-registry-oci-artifacts</a></p><p>それでは、ORAS を使って Dockerfile を ACR にプッシュします。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> oras push blogbuildtest.azurecr.io/hello-world.dockerfile:1.0 Dockerfile</span></span><br></pre></td></tr></table></figure><p>今回は hello-world.dockerfile というリポジトリとしてプッシュしました。<br>では、この hello-world.dockerfile を用いるよう ACR タスクを作成してみます。<br>コマンドは下記のような形式となります。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr task create -t &lt;イメージ名&gt; --registry &lt;ACR 名&gt; --name &lt;タスク名&gt; --context oci://&lt;ACR 名&gt;.azurecr.io/&lt;Dockerfile の OCI アーティファクト名&gt;:&lt;Tag&gt;  --file &lt;Dockerfile名&gt; --assign-identity &lt;[system] | マネージド ID のリソース ID&gt; -g &lt;リソース グループ名&gt;</span></span><br></pre></td></tr></table></figure><p>今回の環境では、下記のコマンドとなります。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr task create -t helloworld --registry blogbuildtest --name helloworldtask  --context oci://blogbuildtest.azurecr.io/hello-world.dockerfile:1.0  --file hello-world.dockerfile --assign-identity [system]</span></span><br></pre></td></tr></table></figure><p>なお、「信頼されたサービス」を利用してアクセスを行う場合には、ACR タスクにマネージド ID を利用する必要があります。</p><p>先ほど実行したコマンドにて、今回作成した ACR タスクにはシステム割り当てマネージド ID を利用するよう設定しているため、このシステム割り当てマネージド ID に必要な権限 (ACRPUSH) を割り当てます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> principalID=$(az acr task show --name helloworldtask --registry tasktest --query identity.principalId --output tsv -g blog)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> baseregID=$(az acr show --name blogbuildtest --query id --output tsv -g blog)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> az role assignment create --assignee <span class="variable">$principalID</span> --scope <span class="variable">$baseregID</span> --role acrpush</span></span><br></pre></td></tr></table></figure><p>次に、ACR タスク “helloworldtask” に対して  ACR “blogbuildtest” へのアクセスにマネージド ID を利用するよう設定を行います。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr task credential add --name helloworldtask --registry blogbuildtest --login-server blogbuildtest.azurecr.io --use-identity [system] -g blog</span></span><br></pre></td></tr></table></figure><p>これで準備は完了です。それでは、ACR タスクを実行します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az acr task run --name helloworldtask --registry blogbuildtest -g blog                                                                                              Queued a run with ID: cad</span></span><br><span class="line">Waiting for an agent...</span><br><span class="line">2023/12/14 19:29:42 Downloading source code...</span><br><span class="line">2023/12/14 19:29:45 Finished downloading source code</span><br><span class="line">2023/12/14 19:29:45 Using acb_vol_efd7cb79-502a-47b0-8e44-9689138ae1cb as the home volume</span><br><span class="line">2023/12/14 19:29:46 Setting up Docker configuration...</span><br><span class="line">2023/12/14 19:29:46 Successfully set up Docker configuration</span><br><span class="line">2023/12/14 19:29:46 Logging in to registry: blogbuildtest.azurecr.io</span><br><span class="line">2023/12/14 19:29:47 Successfully logged into blogbuildtest.azurecr.io</span><br><span class="line">2023/12/14 19:29:47 Executing step ID: build. Timeout(sec): 28800, Working directory: &#x27;&#x27;, Network: &#x27;&#x27;</span><br><span class="line">2023/12/14 19:29:47 Scanning for dependencies...</span><br><span class="line">2023/12/14 19:29:47 Successfully scanned dependencies</span><br><span class="line">2023/12/14 19:29:47 Launching container with name: build</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/1 : FROM mcr.microsoft.com/hello-world</span><br><span class="line">latest: Pulling from hello-world</span><br><span class="line">1b930d010525: Pulling fs layer</span><br><span class="line">1b930d010525: Verifying Checksum</span><br><span class="line">1b930d010525: Download complete</span><br><span class="line">1b930d010525: Pull complete</span><br><span class="line">Digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">Status: Downloaded newer image for mcr.microsoft.com/hello-world:latest</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> fce289e99eb9</span></span><br><span class="line">Successfully built fce289e99eb9</span><br><span class="line">Successfully tagged blogbuildtest.azurecr.io/helloworld:latest</span><br><span class="line">2023/12/14 19:29:48 Successfully executed container: build</span><br><span class="line">2023/12/14 19:29:48 Executing step ID: push. Timeout(sec): 3600, Working directory: &#x27;&#x27;, Network: &#x27;&#x27;</span><br><span class="line">2023/12/14 19:29:48 Pushing image: blogbuildtest.azurecr.io/helloworld:latest, attempt 1</span><br><span class="line">The push refers to repository [blogbuildtest.azurecr.io/helloworld]</span><br><span class="line">af0b15c8625b: Preparing</span><br><span class="line">af0b15c8625b: Layer already exists</span><br><span class="line">latest: digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a size: 524</span><br><span class="line">2023/12/14 19:29:49 Successfully pushed image: blogbuildtest.azurecr.io/helloworld:latest</span><br><span class="line">2023/12/14 19:29:49 Step ID: build marked as successful (elapsed time in seconds: 1.140930)</span><br><span class="line">2023/12/14 19:29:49 Populating digests for step ID: build...</span><br><span class="line">2023/12/14 19:29:49 Successfully populated digests for step ID: build</span><br><span class="line">2023/12/14 19:29:49 Step ID: push marked as successful (elapsed time in seconds: 0.898327)</span><br><span class="line">2023/12/14 19:29:49 The following dependencies were found:</span><br><span class="line">2023/12/14 19:29:49</span><br><span class="line">- image:</span><br><span class="line">    registry: blogbuildtest.azurecr.io</span><br><span class="line">    repository: helloworld</span><br><span class="line">    tag: latest</span><br><span class="line">    digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">  runtime-dependency:</span><br><span class="line">    registry: mcr.microsoft.com</span><br><span class="line">    repository: hello-world</span><br><span class="line">    tag: latest</span><br><span class="line">    digest: sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a</span><br><span class="line">  git: &#123;&#125;</span><br><span class="line"></span><br><span class="line">Run ID: cad was successful after 8s</span><br></pre></td></tr></table></figure><p>これで、Firewall を有効化している ACR に対して、ACR タスクを用いてコンテナー イメージを作成することが出来ました。</p><h3 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h3><p>この記事では、ACR のFirewall 機能を有効にした状態で ACR の機能を用いてコンテナー イメージをビルドする方法をご紹介しました。<br>ご参考にいただけますと幸いです。</p><p>本稿が皆様のお役に立ちましたら幸いです。</p><p>最後まで読んでいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;この記事は&lt;a href=&quot;https://qiita.com/advent-calendar/2023/microsoft-azure-tech&quot;&gt;Microsoft Azure Tech Advent Calendar 2023&lt;/a&gt; の 22 日目の記事になります。&lt;/p&gt;
&lt;p&gt;こんにちは！ Azure テクニカル サポート チームの川畑です。&lt;br&gt;az acr buildコマンドを用いてコンテナー イメージをビルドする際に、ACR の Firewall 機能によって失敗するお問い合わせを頂きます。&lt;br&gt;この記事では、ACR のFirewall 機能を有効にした状態で ACR の機能を用いてコンテナー イメージをビルドする方法についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Container Registry (ACR)" scheme="https://jpaztech.github.io/blog/tags/Azure-Container-Registry-ACR/"/>
    
  </entry>
  
</feed>
