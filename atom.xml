<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2022-03-02T05:20:41.368Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ExpressRoute の エッジ ルーターのメンテナンスに関して</title>
    <link href="https://jpaztech.github.io/blog/network/expressroute-maintenance/"/>
    <id>https://jpaztech.github.io/blog/network/expressroute-maintenance/</id>
    <published>2022-03-02T05:20:44.980Z</published>
    <updated>2022-03-02T05:20:41.368Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームです。<br>今回は ExpressRoute 回線のエッジルーターにおけるメンテナンスについて、メンテナンス時の基本的な挙動と、お問い合わせをいただくことの多いご質問への回答を紹介させていただきます。</p><br><h2 id="メンテナンスの通知"><a href="#メンテナンスの通知" class="headerlink" title="メンテナンスの通知"></a>メンテナンスの通知</h2><p>ExpressRoute 回線でメンテナンスが実施される場合、通常以下のようなお客様への通知が事前に行われております。</p><p><img src="/blog/network/expressroute-maintenance/expressroute-maintenance1.jpg" alt="通知メールのサンプル"></p><p>※ 本文中の日時やロケーションはメンテナンスごとに異なります。</p><br><h2 id="メンテナンスの対象"><a href="#メンテナンスの対象" class="headerlink" title="メンテナンスの対象"></a>メンテナンスの対象</h2><p>ExpressRoute ではエッジルーター (Microsoft Enterprise Edge: MSEE) と呼ばれる物理ルーターが、既定で Microsoft 側に 2 系統存在しており、それぞれが回線プロバイダー様のルーター (Provider Edge: PE)と BGP セッションを構成することで、冗長化が行われております (2 系統で冗長化されていない環境は SLA の範囲外です)。</p><p>メンテナンスの対象となるのはこの MSEE (図における黄色のルーター) です。</p><p>※ L2 モデルの回線プロバイダー様ご利用されている場合、回線プロバイダー様のスイッチを経て L3 レベルではお客様の管理所有するルーターと接続されています。そのため L2 モデルの回線プロバイダー様をご利用の場合、PE という表現についてはお客様が管理所有されている BGP ルーターと読み替えてください。</p><p><img src="/blog/network/expressroute-maintenance/expressroute-maintenance2.jpg" alt="ExpressRoute の接続図"></p><br><h2 id="メンテナンス時の挙動"><a href="#メンテナンス時の挙動" class="headerlink" title="メンテナンス時の挙動"></a>メンテナンス時の挙動</h2><p>メンテナンスは MSEE の冗長性を考慮して片系統ずつ実施されます。そのためメンテナンス実施中であっても、後述する「通信影響が生じる可能性のあるケース」に該当しない限りは、お客様への通信影響は想定されておりませんのでご安心ください。</p><p>メンテナンス時の挙動について少し具体的にご説明すると、メンテナンス対象の MSEE と PE 間の BGP セッションが切断される前に、以下のような手法で通信経路を非メンテナンス側に寄せる処理が行われます。</p><ol><li>MSEE から PE への通信経路<br>弊社側での経路制御により非メンテナンス側の経路が優先されるよう制御します。</li><li>PE から MSEE への通信経路<br>MSEE から PE に対して、 BGP で広報する経路のうち、メンテナンスを行う側の AS PATH を長くして広報することで、非メンテナンス側の経路が優先されるように制御します (AS Path Prepend)。</li></ol><p>上記 1 、 2 の手法により、双方向とも非メンテナンス側の経路が優先されるように制御が行われますので、メンテナンスの実施中もお客様への通信影響は想定されておりません。</p><p>以下の公開文書にも、メンテナンス実施中に AS PATH により経路を制御する旨が記載されています。</p><ul><li><p><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/designing-for-high-availability-with-expressroute#active-active-connections">ExpressRoute を使用した高可用性のための設計 - アクティブ/アクティブ接続</a></p><blockquote><p>メンテナンス アクティビティの期間、またはいずれかの接続に影響を与える計画外のイベント時に、Microsoft では、AS パス プリペンディングを使用して、正常な接続にトラフィックをドレインする方法を優先します。 Microsoft によりパス プリペンドが構成されている場合にトラフィックを正常なパスにルーティングできること、およびサービスの中断が発生しないように、必要なルート アドバタイズが適切に構成されていること確認する必要があります。</p></blockquote></li></ul><br><p><strong>通信影響が生じる可能性のあるケース</strong><br>上記のとおりほとんどの環境では通信影響はありませんが、例えば以下のような極めて限定的な条件下においては、一時的な通信影響が発生する可能性があります。</p><ul><li>お客様側で非常に長い AS Path を利用した経路制御を行っており、メンテナンス時に Microsoft 側で付与する AS Path がお客様の利用されている AS Path に負け、経路制御が効かないケース</li><li>お客様側で AS Path Prepend よりも優先度の高い手法による経路制御を行っているケース</li></ul><p>仮に上記のようなケースで PE から MSEE への通信経路の制御が動作しなくても、往復路が不一致となるのみですので、通常は通信への影響ありません。<br>しかし、例えばステートフルなファイアウォールを利用されている場合など、PE 側のネットワーク構成によってはこうして生じた往復路の不一致が許容されない場合があります。</p><p>このように、お客様側での通信制御によって AS Path Prepend が動作せず、かつ往復路の不一致が許容されない構成になっている場合には、メンテナンス時に一時的な通信影響が生じる可能性がございますので予めご承知おきください。<br>なお PE 側の経路制御状況やネットワーク構成が上記に該当しているかご確認されたい場合、お客様側のネットワークご担当者様にご確認いただくようお願いいたします。<br><br></p><hr><h2 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h2><ul><li><strong>現在利用している ExpressRoute 回線は冗長化されていますか</strong><br>ExpressRoute 回線は、「 1 回線」作成すると、必ず内部的には 2 本の物理的な回線が構成され、2 台の MSEE が利用されます。つまり、シングル構成になっていることは原則ありません。<br>ただし、L2 モデルのプロバイダー (お客様自身で BGP ルーターを構成いただく必要があるプロバイダー) をご利用いただいており、ルーターを片方の回線にしか接続していない、片方の回線しか BGP の Neighbor を確立していないなど、極めて例外的な構成を取っている場合に限っては、今回のメンテナンスにあたって通信影響が生じます。<br>このような構成は、SLA が担保されない、弊社として保証していない特殊な構成であり、プロバイダー様、またはお客様にて意図的に構成されるものです。そのため、ご利用されている ExpressRoute 回線が冗長構成となっているか確認されたい場合は、ご契約されているプロバイダー様、またはお客様側のネットワーク担当者様へご確認ください。</li></ul><ul><li><strong>仮想ネットワーク ゲートウェイ の SKU とメンテナンスに伴う影響の有無は関係ありますか</strong><br>既にリタイアした Basic 以外の SKU では、メンテナンスに伴う影響の有無には関係ありません。仮想ネットワーク ゲートウェイ は上記の図中の青色の部分ですが、メンテナンス対象である MSEE は黄色の部分です。</li></ul><ul><li><strong>メンテナンス期間が数時間取られていますが、この時間中ずっと切断されたままになるのですか</strong><br>いいえ、メンテナンス期間中の一部のタイミングでのみ、一時的な切断が発生します。また切断といっても、前述のとおり冗長化された回線の片系ずつの切断となります。</li></ul><ul><li><strong>PE 側で何らかのログが出力される可能性はありますか</strong><br>メンテナンスに伴って BGP セッションが切断された際には、PE 側では BGP セッションの切断を示すログなどが記録されることが想定されます。ルーターの監視を行っている場合は、メンテナンス期間中にこのようなログが記録されることをあらかじめご認識いただけますと幸いです。</li></ul><p>以上、ExpressRoute の MSEE メンテナンス通知を受け取られた際の影響確認、ならびに同メンテナンスによる影響を回避するにあたってのルーティング設計をご検討いただくにあたり、ご参考にしていただければ幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチームです。&lt;br&gt;今回は ExpressRoute 回線のエッジルーターにおけるメンテナンスについて、メンテナンス時の基本的な挙動と、お問い合わせをいただくことの多いご質問への回答を紹介させていただきます。&lt;/p&gt;
&lt;br&gt;

&lt;h2 id</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="Maintenance" scheme="https://jpaztech.github.io/blog/tags/Maintenance/"/>
    
  </entry>
  
  <entry>
    <title>Linux の 時刻同期設定について</title>
    <link href="https://jpaztech.github.io/blog/vm/linux-time-sync/"/>
    <id>https://jpaztech.github.io/blog/vm/linux-time-sync/</id>
    <published>2022-02-25T07:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.584Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの橋本です。</p><p>本記事では　Azure 環境下での Linux OS での時刻同期に関してご紹介します。<br>公式ドキュメントのみではわかりづらい部分があるかと思いますので、<br>よくご質問いただく内容を踏まえ、本記事で設定方法や、デフォルトの状態に関しての<br>情報を纏めてご紹介させていただければと考えております。<br>時刻同期の設計、環境構築などで今回の情報が皆様のお役に立てれば幸いです。</p><h2 id="関連ドキュメント"><a href="#関連ドキュメント" class="headerlink" title="関連ドキュメント"></a>関連ドキュメント</h2><p>公式ドキュメント上では以下の URL 情報にご案内があります。</p><blockquote><p><strong>Azure での Linux VM の時刻同期</strong><br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/time-sync">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/time-sync</a></p></blockquote><h2 id="ご案内の概要"><a href="#ご案内の概要" class="headerlink" title="ご案内の概要"></a>ご案内の概要</h2><p>本記事では以下の情報をご紹介します。</p><ol><li>デフォルトの時刻同期設定について</li><li>Azure 時刻同期サーバー、サービスの有無</li><li>PTP を利用した Azure ホストとの時刻同期</li></ol><h2 id="1-デフォルトの時刻同期設定について"><a href="#1-デフォルトの時刻同期設定について" class="headerlink" title="1. デフォルトの時刻同期設定について"></a>1. デフォルトの時刻同期設定について</h2><p>デフォルトの時刻同期設定は、ご利用のイメージによって異なり、一律の設定となっているわけではありません。<br>基本的には以下のいずれかの設定となっています。</p><ul><li>時刻同期サービスが未構成</li><li>NTP を利用した外部 NTP サーバーとの時刻同期が構成されている<br>(OS イメージ提供元にて提供されている NTP サーバーが指定されている)</li><li>PTP を利用した Azure ホストとの時刻同期が構成されている</li></ul><h2 id="2-Azure-時刻同期サーバー、時刻同期サービスの有無"><a href="#2-Azure-時刻同期サーバー、時刻同期サービスの有無" class="headerlink" title="2. Azure 時刻同期サーバー、時刻同期サービスの有無"></a>2. Azure 時刻同期サーバー、時刻同期サービスの有無</h2><p>時刻同期のプロトコルとしてよくご利用されている NTP サーバーについては、<br>お客様向けに Azure サービスとしてご用意はありません。</p><p>NTP をご利用いただくことについて制限などはありませんが、ご利用される場合には、外部の NTP サーバーをご指定いただく必要があります。</p><p>なお、Azure 上の Windows 仮想マシンの既定値に定義されている time.windows.com ですが、こちらはインターネット上のパブリックな NTP サーバーであり、Azure サービスとして提供しているものではなく、動作サポートをしているものではありませんのでご注意ください。</p><p>時刻同期のための Azure サービスとしては、 Azure ホストと同期する PTP を提供しています。<br>Azure Marketplace の最新の Linux イメージでは徐々に仮想マシンの時刻同期として PTP を利用するように変更されており、仮想マシンを作成した初期状態ですでに Azure ホストと同期されるように構成されているものもあります。</p><p>Azure ホスト自体は内部で Microsoft のタイムサーバーと同期しており、GPS アンテナを使用して、Microsoft が所有する Stratum 1 デバイスから時刻を取得しています。</p><h2 id="3-PTP-を利用した-Azure-ホストとの時刻同期"><a href="#3-PTP-を利用した-Azure-ホストとの時刻同期" class="headerlink" title="3. PTP を利用した Azure ホストとの時刻同期"></a>3. PTP を利用した Azure ホストとの時刻同期</h2><p>Azure ホストとの時刻同期を行う際の手順についてご紹介します。<br>以下の例では SUSE 環境での検証結果を前提として記載させていただきますが、パッケージインストールコマンド以外は基本的どのディストリビューションでも流れとしては同じとなります。</p><ol><li><p>NTP など他の時刻同期のサービスが起動している場合は停止</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo su –</span><br><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">systemctl stop ntp</span><br><span class="line">systemctl <span class="built_in">disable</span> ntp</span><br><span class="line">systemctl status ntp</span><br></pre></td></tr></table></figure></li><li><p>chrony をインストール</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">zypper install chrony</span><br></pre></td></tr></table></figure></li><li><p>インストールされた chrony パッケージが表示されることを確認</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">rpm -qa | grep chrony</span><br></pre></td></tr></table></figure></li><li><p>lsmod コマンドを実行し、hv_utils が表示結果に存在するか確認</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">lsmod | grep hv_utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">hv_utils               32768  1 </span><br><span class="line">ptp                    20480  1 hv_utils</span><br><span class="line">hv_vmbus              106496  7 hv_storvsc,hv_utils,hid_hyperv,hv_balloon,hv_netvsc,hyperv_keyboard,hyperv_fb</span><br></pre></td></tr></table></figure></li><li><p>PTP クロックソースを確認<br>高速ネットワークの利用有無など、環境によって出力結果が異なるため、後続の手順で正しいデバイス ファイルを選択するように hyperv の ptp クロックソースの情報を確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">ls /dev/ptp*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">ptp0 ptp1 ptp_hyperv</span><br></pre></td></tr></table></figure><p><strong>ptp_hyperv ファイルが存在する場合</strong><br>→　手順 6 にて /dev/ptp_hyperv を指定します。</p><p><strong>ptp0 のみが表示された場合</strong><br>→　手順 6  にて /dev/ptp0 を指定します。</p><p><strong>ptp0 と ptp1 ファイルのみが存在する場合</strong><br>→　この場合 udev ルールファイルを作成する方法がございますが、詳細につきましてはサポートにお問合せください。</p></li></ol><ol start="6"><li><p>chrony を利用しPTP クロックソースを利用した時刻同期を構成<br>以下の例は手順 5 の確認の結果、ptp0 が正しい PTP クロックソースと確認できた場合の設定となります。<br>手順 5 の確認の結果、ptp_hyperv が正しい PTP クロックソースの場合、差し替えて設定をお願いします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">vi /etc/chrony.conf</span><br></pre></td></tr></table></figure><p>ファイル末尾に以下行を追加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0</span><br></pre></td></tr></table></figure></li><li><p>chrony を起動し、さらにシステム起動時に自動実行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/chronyd.service to /usr/lib/systemd/system/chronyd.service.</span><br></pre></td></tr></table></figure></li><li><p>chrony による時刻同期状況を確認する ※PHC0 が存在すること</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">chronyc sources</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">210 Number of sources = 1</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample</span><br><span class="line">===============================================================================</span><br><span class="line"><span class="comment">#* PHC0                          0   3   377     3  +2401ns[+5304ns] +/- 2032ns</span></span><br></pre></td></tr></table></figure></li></ol><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの橋本です。&lt;/p&gt;
&lt;p&gt;本記事では　Azure 環境下での Linux OS での時刻同期に関してご紹介します。&lt;br&gt;公式ドキュメントのみではわかりづらい部分があるかと思いますので、&lt;br&gt;よくご質問いただく内容を踏</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>復旧 VM を使った Linux VM の Noboot 復旧手順</title>
    <link href="https://jpaztech.github.io/blog/vm/linux-noboot-recovery-managed-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/linux-noboot-recovery-managed-disk/</id>
    <published>2022-02-17T09:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.580Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの橋本です。</p><p>Linux OS にて設定変更後、または新たにアプリケーションなどをインストールした後で OS が起動しなくなり困ったことはないでしょうか。<br>今回は OS 設定変更後に正常に起動せず、ログインができなくなってしまったケースを想定し、問題の OS ディスクのクローンを作成し、復旧作業用の別の VM (以降復旧 VM) にて OS ディスクの修正対応をする方法をご案内させていただきます。</p><span id="more"></span> <h2 id="関連ドキュメント"><a href="#関連ドキュメント" class="headerlink" title="関連ドキュメント"></a>関連ドキュメント</h2><p>公式ドキュメント上では以下の URL 情報にご案内があります。</p><blockquote><p><strong>Azure Virtual Machine の修復コマンドを使用して Linux VM を修復する</strong><br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/repair-linux-vm-using-azure-virtual-machine-repair-commands">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/repair-linux-vm-using-azure-virtual-machine-repair-commands</a></p><p><strong>Linux レスキュー VM の Chroot 環境</strong><br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/chroot-environment-linux">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/chroot-environment-linux</a></p></blockquote><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本記事では、VM (testvm) (リソースグループ rg-test) の /etc/fstab 修正、rpm パッケージのアプリケーション インストールを行った後で　VM が起動できなくなったことを想定し、復旧手順について上記 2 つの公式ドキュメント記載内容を纏めた形で一連の流れをご紹介します。<br>また、復旧のために利用した復旧 VM 関連のリソースを、作業後に削除する方法も併せてご紹介します。</p><h2 id="作業概要"><a href="#作業概要" class="headerlink" title="作業概要"></a>作業概要</h2><ol><li>Azure CLI にて問題の VM を指定し、復旧 VM を作成</li><li>復旧 VM にて、問題の VM の OS ディスクをマウント</li><li>復旧 VM にて、修復操作を実施</li><li>復旧 VM で修正した OS ディスクのコピーを、問題の VM の OS ディスクとスワップ</li><li>不要となった復旧 VM のリソースグループを削除</li></ol><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-Azure-CLI-にて問題の-VM-を指定し、復旧-VM-を作成"><a href="#1-Azure-CLI-にて問題の-VM-を指定し、復旧-VM-を作成" class="headerlink" title="1. Azure CLI にて問題の VM を指定し、復旧 VM を作成"></a>1. Azure CLI にて問題の VM を指定し、復旧 VM を作成</h3><ul><li><p>Azure 環境へログイン</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az login</span><br></pre></td></tr></table></figure></li><li><p>復旧 VM 作成コマンドを実行<br>このコマンドを実行し、問題の VM の OS ディスクのコピー (自動で作成されます) をデータ ディスクとしてマウントした復旧 VM を作成します。復旧 VM は元の仮想マシンと同一サイズで作成され、通常の仮想マシンと同様にコストが掛かります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm repair create -g rg-test -n testvm</span><br></pre></td></tr></table></figure><p>下記のように実行結果が表示されるため、復旧 VM のログイン アカウントおよびパスワードを入力します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 省略 #</span></span><br><span class="line">The vm-repair extension is not up to date, please update with az extension update -n vm-repair</span><br><span class="line">Repair VM admin username:  <span class="comment"># 復旧 VM のログイン アカウントを入力</span></span><br><span class="line">Repair VM admin password:  <span class="comment"># 復旧 VM のログイン パスワードを入力</span></span><br><span class="line">Confirm Repair VM admin password:  <span class="comment"># パスワードを再入力</span></span><br><span class="line"><span class="comment"># 省略 #</span></span><br><span class="line">  <span class="string">&quot;repair_resource_group&quot;</span>: <span class="string">&quot;repair-testvm-20211127104931.115258&quot;</span>,</span><br><span class="line">  <span class="string">&quot;repair_vm_name&quot;</span>: <span class="string">&quot;repair-testvm_&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resource_tag&quot;</span>: <span class="string">&quot;repair_source=rg-test/testvm&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;SUCCESS&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-復旧-VM-にて、問題の-VM-の-OS-ディスクをマウント"><a href="#2-復旧-VM-にて、問題の-VM-の-OS-ディスクをマウント" class="headerlink" title="2. 復旧 VM にて、問題の VM の OS ディスクをマウント"></a>2. 復旧 VM にて、問題の VM の OS ディスクをマウント</h3><ul><li><p>Azure ポータルから復旧 VM “repair-testrh0_” の パブリック IP アドレスを確認</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/01.png"></p></li><li><p>上記確認したパブリック IP アドレス、手順 1 で作成したユーザ、パスワードで SSH ログインし、VM (testvm) のディスクをマウントし、chroot コマンドを実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo su - </span><br><span class="line"></span><br><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">lsblk</span><br></pre></td></tr></table></figure><p>コマンド表示結果例<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/02.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">lsblk -f</span><br></pre></td></tr></table></figure><p>コマンド実行例<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/03.png"></p><p>lsblk コマンドでは、復旧 VM に接続されたデータ ディスクのパーティション構成を確認します。<br>パーティション構成はお客様環境に依存するため、必ずしも今回の例と同じとは限りません。<br>今回の例では論理ボリューム名より各ファイルシステム判断し、sdc1 が 500M であることから /boot 、sdc15 が vfat であることから /boot/efi と判断しマウントをします。</p></li><li><p>各ファイル システムのマウント<br>本手順例では LVM 構成を前提とした手順となります。<br>非 LVM 構成の場合にも基本的な操作は同じとなりますが、ご不明な場合、公式ドキュメントに 非 LVM 構成を前提とした手順がございますので、ご参考にしていただければと思います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">mkdir /rescue</span><br><span class="line">mount /dev/mapper/rootvg-rootlv /rescue</span><br><span class="line">mount /dev/mapper/rootvg-varlv /rescue/var</span><br><span class="line">mount /dev/mapper/rootvg-homelv /rescue/home</span><br><span class="line">mount /dev/mapper/rootvg-usrlv /rescue/usr</span><br><span class="line">mount /dev/mapper/rootvg-tmplv /rescue/tmp</span><br><span class="line">mount /dev/sdc1 /rescue/boot/</span><br><span class="line">mount /dev/sdc15 /rescue/boot/efi</span><br><span class="line"><span class="built_in">cd</span> /rescue</span><br><span class="line">mount -t proc proc proc</span><br><span class="line">mount -t sysfs sys sys/</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev dev/</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev/pts dev/pts/</span><br><span class="line">mount -o <span class="built_in">bind</span> /run run/</span><br><span class="line">chroot /rescue</span><br></pre></td></tr></table></figure><p>※ chroot コマンド実行後プロンプトに [] が付与されます。<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/04.png"></p></li></ul><h3 id="3-復旧-VM-にて、修復操作を実施"><a href="#3-復旧-VM-にて、修復操作を実施" class="headerlink" title="3.　復旧 VM にて、修復操作を実施"></a>3.　復旧 VM にて、修復操作を実施</h3><ul><li><p>手順 2 で /rescue ディレクトリにマウントした VM (testvm) の root ファイル システムにアクセスし、修正対応を行います。<br>ここでは例としまして /etc/fstab を修正し、直前にインストールしたパッケージをアンインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ルートディレクトリ変更後の状態で実行</span></span><br><span class="line"><span class="built_in">cd</span> /etc</span><br><span class="line">vi fstab</span><br><span class="line"></span><br><span class="line">rpm --erase アプリケーションパッケージ</span><br><span class="line"><span class="comment"># Running in chroot, ignoring request: daemon-reload</span></span><br><span class="line"><span class="comment"># こちらのメッセージが出力される可能性がございますが、無視いただいて問題ありません。</span></span><br></pre></td></tr></table></figure></li><li><p>作業完了後、chroot から抜けて、ファイル システムをすべてアンマウントします。<br>その後ポータルから復旧 VM を停止します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ルートディレクトリ変更後の状態で実行</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>※ exit コマンド実行後プロンプトから [] が外れます<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/05.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">umount /rescue/proc/</span><br><span class="line">umount /rescue/sys/</span><br><span class="line">umount /rescue/dev/pts</span><br><span class="line">umount /rescue/dev/</span><br><span class="line">umount /rescue/run</span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">umount /rescue/boot/efi</span><br><span class="line">umount /rescue/boot</span><br><span class="line">umount /rescue/home</span><br><span class="line">umount /rescue/var</span><br><span class="line">umount /rescue/usr</span><br><span class="line">umount /rescue/tmp</span><br><span class="line">umount /rescue</span><br></pre></td></tr></table></figure><p>※ ファイルシステムがプロセス利用中のためアンマウントできない場合がありますが、後続の復旧 VM のシャットダウン操作でアンマウントされますので問題ありません。</p></li><li><p>Azure ポータルから復旧 VM “repair-testrh0_” を停止<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/06.png"></p></li></ul><h3 id="4-復旧-VM-で修正した-OS-ディスクのコピーを、問題の-VM-の-OS-ディスクとスワップ"><a href="#4-復旧-VM-で修正した-OS-ディスクのコピーを、問題の-VM-の-OS-ディスクとスワップ" class="headerlink" title="4. 復旧 VM で修正した OS ディスクのコピーを、問題の VM の OS ディスクとスワップ"></a>4. 復旧 VM で修正した OS ディスクのコピーを、問題の VM の OS ディスクとスワップ</h3><ul><li><p>“az vm repair restore” コマンドにて、問題の VM の OS ディスクを、修復した OS ディスクとスワップします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az vm repair restore -g rg-test -n testvm --verbose</span><br><span class="line"><span class="comment"># 省略 #</span></span><br><span class="line">Continue with clean-up and delete resources? (y/n): n ※復旧 VM 作成時に作成されたリソースを削除するかの選択。</span><br><span class="line">今回ご紹介の手順では n を選択し、後続の手順にて関連リソースを削除します。</span><br><span class="line">y を選択いただいても問題ありません。</span><br></pre></td></tr></table></figure><p>コマンドが完了すると、復旧 VM にアタッチされていたディスクが自動的に問題の仮想マシンの OS ディスクとしてアタッチされます。</p></li><li><p>問題の VM をポータルから起動し、ログインができるか確認</p></li></ul><h3 id="5-不要となった復旧-VM-のリソースグループを削除"><a href="#5-不要となった復旧-VM-のリソースグループを削除" class="headerlink" title="5. 不要となった復旧 VM のリソースグループを削除"></a>5. 不要となった復旧 VM のリソースグループを削除</h3><p>ポータル上からリソース グループ内のリソースを確認した後で削除する流れをご紹介します。</p><ul><li><p>復旧 VM のリソース グループ削除<br>ポータルのリソース グループのメニューより、<br>「repair-tesetvg-yyyymmdd・・・」の名称のリソース グループを選択。リソースグループ内のリソースが業務で利用していないことを確認して削除します。</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/10.png"></p></li></ul><ul><li><p>問題の VM の元ディスクの削除</p><p>管理ディスク環境と非管理ディスク環境で手順が異なります。<br>【管理ディスクをご利用環境の場合】、【非管理ディスクをご利用環境の場合】<br>手順をそれぞれ用意しておりますので、環境に合わせてご対応ください。</p><p>【管理ディスクをご利用環境の場合】</p><p>VM のリソースグループより、元々利用していたディスクを選択し、<br>ディスクの状態が　Unattached（どの VM からも利用されていない）であることを確認し、削除を行います。</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/11.png"><br><img src="/blog/vm/linux-noboot-recovery-managed-disk/12.png"></p><p>【非管理ディスクをご利用環境の場合】</p><p>VM のディスク情報より、現在 VM が利用している vhd ファイルを確認し、<br>仮想マシンの vhd ファイルが格納されているストレージアカウントのコンテナーをご確認ください。<br>現在 VM が利用していない VHD ファイル、<br>尚且つディスクの状態が利用可能（どの VM からも利用されていない）であることを確認し、削除を行います。</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/13.png"><br><img src="/blog/vm/linux-noboot-recovery-managed-disk/14.png"></p></li></ul><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの橋本です。&lt;/p&gt;
&lt;p&gt;Linux OS にて設定変更後、または新たにアプリケーションなどをインストールした後で OS が起動しなくなり困ったことはないでしょうか。&lt;br&gt;今回は OS 設定変更後に正常に起動せず、ログインができなくなってしまったケースを想定し、問題の OS ディスクのクローンを作成し、復旧作業用の別の VM (以降復旧 VM) にて OS ディスクの修正対応をする方法をご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>yum/dnf update に失敗する場合の原因と解決方法</title>
    <link href="https://jpaztech.github.io/blog/vm/rhui-yum-update/"/>
    <id>https://jpaztech.github.io/blog/vm/rhui-yum-update/</id>
    <published>2022-02-14T02:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.616Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure テクニカル サポート チームの高橋です。<br>今回はよく、お問い合わせを頂く<br>Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の仮想マシンにおいて<br>yum / dnf update やパッケージのインストールに失敗する場合の<br>よくある原因とその解決方法についてご紹介いたします。</p><span id="more"></span><hr><h2 id="Azure-RHUI-リポジトリ-とは？"><a href="#Azure-RHUI-リポジトリ-とは？" class="headerlink" title="Azure RHUI (リポジトリ) とは？"></a>Azure RHUI (リポジトリ) とは？</h2><p>Azure RHUI  (Red Hat Update Infrastructure) は、Azure Marketplace にある<br>Red Hat Enterprise Linux (RHEL) の従量課金 (PAYG) イメージから作成した VM を更新するために<br>提供されているリポジトリサーバーです。</p><p>Azure Marketplace から 作成した RHEL VM は、規定で Azure RHUI へのアクセスする構成が設定されているため<br>追加の設定は不要となります。</p><p>VM から、Azure RHUI にアクセスするためには、下記の IP アドレスに対する送信規則の 443 ポートの通信許可を設定する必要があります。<br>Azure RHUI の IP アドレスは下記公開ドキュメントにおまとめしておりますのでご確認ください。</p><blockquote><p> □ 参考 : RHUI コンテンツ配信サーバーの IP アドレス<br>   <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui#the-ips-for-the-rhui-content-delivery-servers">https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui#the-ips-for-the-rhui-content-delivery-servers</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p>※Azure RHUI へのアクセスは、弊社バックボーンネットワーク経由にて接続されており、</p><p>Azure VM から、オンプレミスのネットワークインフラストラクチャや、プロキシ、NVA (仮想アプライアンス) 経由でのアクセスはサポートされておらず、</p><p>Azure VM から直接、Azure RHUI に接続する必要がある点に注意してください。</p></div><hr><h2 id="Azure-RHUI-への接続確認"><a href="#Azure-RHUI-への接続確認" class="headerlink" title="Azure RHUI への接続確認"></a>Azure RHUI への接続確認</h2><p>yum / dnf update やパッケージのインストールに失敗する場合、<br>Azure RHUI への接続ができていない可能性がございます。<br>Azure VM 内から、curl コマンド等を使うことで、Azure RHUI への接続状況を確認することができます。<br>下記のコマンドをお試しください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line"><span class="comment"># curl -v https://rhui-2.microsoft.com:443</span></span><br><span class="line"><span class="comment"># curl -v https://rhui-3.microsoft.com:443</span></span><br></pre></td></tr></table></figure><p>&lt; 実行結果例 (成功時) &gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@rheltest ~]<span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line">* Rebuilt URL to: https://rhui-1.microsoft.com:443/</span><br><span class="line">*   Trying 52.187.75.218...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to rhui-1.microsoft.com (52.187.75.218) port 443 (<span class="comment">#0)</span></span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully <span class="built_in">set</span> certificate verify locations:</span><br><span class="line">*   CAfile: /etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">CApath: none</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server finished (14):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span><br><span class="line">* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Finished (20):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Finished (20):</span><br><span class="line">* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384</span><br><span class="line">* ALPN, server did not agree to a protocol</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: C=US; ST=WA; L=Redmond; O=Microsoft Corporation; CN=rhui-1.microsoft.com</span><br><span class="line">*  start date: Dec  7 11:14:49 2021 GMT</span><br><span class="line">*  expire date: Dec  2 11:14:49 2022 GMT</span><br><span class="line">*  subjectAltName: host <span class="string">&quot;rhui-1.microsoft.com&quot;</span> matched cert<span class="string">&#x27;s &quot;rhui-1.microsoft.com&quot;</span></span><br><span class="line"><span class="string">*  issuer: C=US; O=Microsoft Corporation; CN=Microsoft Azure TLS Issuing CA 01</span></span><br><span class="line"><span class="string">*  SSL certificate verify ok.</span></span><br><span class="line"><span class="string">&gt; GET / HTTP/1.1</span></span><br><span class="line"><span class="string">&gt; Host: rhui-1.microsoft.com</span></span><br><span class="line"><span class="string">&gt; User-Agent: curl/7.61.1</span></span><br><span class="line"><span class="string">&gt; Accept: */*</span></span><br><span class="line"><span class="string">&gt;</span></span><br><span class="line"><span class="string">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">&lt; Date: Mon, 24 Jan 2022 06:51:00 GMT</span></span><br><span class="line"><span class="string">&lt; Server: Apache/2.4.6 (Red Hat Enterprise Linux)</span></span><br><span class="line"><span class="string">&lt; X-Served-By: southeastasia-cds0</span></span><br><span class="line"><span class="string">&lt; X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="string">&lt; Last-Modified: Thu, 20 Jun 2019 06:37:48 GMT</span></span><br><span class="line"><span class="string">&lt; ETag: &quot;0-58bbb9592306b&quot;</span></span><br><span class="line"><span class="string">&lt; Accept-Ranges: bytes</span></span><br><span class="line"><span class="string">&lt; Content-Length: 0</span></span><br><span class="line"><span class="string">&lt; Connection: close</span></span><br><span class="line"><span class="string">&lt; Content-Type: text/html</span></span><br><span class="line"><span class="string">&lt;</span></span><br><span class="line"><span class="string">* Closing connection 0</span></span><br><span class="line"><span class="string">* TLSv1.2 (OUT), TLS alert, close notify (256):</span></span><br></pre></td></tr></table></figure><p>&lt; 実行結果例 (失敗時) &gt; </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]<span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line">* Rebuilt URL to: https://rhui-1.microsoft.com:443/</span><br><span class="line">*   Trying 52.187.75.218...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* connect to 52.187.75.218 port 443 failed: Connection timed out</span><br><span class="line">* Failed to connect to rhui-1.microsoft.com port 443: Connection timed out</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed to connect to rhui-1.microsoft.com port 443: Connection timed out</span><br></pre></td></tr></table></figure><p>Azure RHUI への接続確認が失敗する場合には、NSG やプロキシ等のネットワーク設定を確認する必要がございます。<br>よくお問い合わせを頂くエラー原因と解決方法は、以下のようになります。</p><hr><h2 id="エラーの原因その-1-Azure-RHUI-への接続ができない-NSG"><a href="#エラーの原因その-1-Azure-RHUI-への接続ができない-NSG" class="headerlink" title="エラーの原因その 1 : Azure RHUI への接続ができない (NSG)"></a>エラーの原因その 1 : Azure RHUI への接続ができない (NSG)</h2><p>セキュリティ上の理由から、Network Security Group (NSG) を利用して、<br>Azure VM からインターネットへのアクセスを制限を設定している場合がございます。<br>Azure portal から対象の仮想マシンを選択後、[ネットワーク] から確認することができます。<br>下記画像の例では、送信ポートの規則で、インターネットへの接続を拒否しています。</p><p><img src="/blog/vm/rhui-yum-update/01.png"></p><p>本設定がある場合には、Azure RHUI への接続確認は、失敗することが想定され、<br>yum update を実施した際や、パッケージのインストール時にはタイムアウトエラーが発生します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]<span class="comment"># yum update</span></span><br><span class="line">Red Hat Enterprise Linux 8 <span class="keyword">for</span> x86_64 - BaseOS - Extended Update Support from RHUI (RPMs)                                                              0.0  B/s |   0  B     01:30</span><br><span class="line">Failed to download metadata <span class="keyword">for</span> repo <span class="string">&#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;</span></span><br><span class="line">Error: Failed to download metadata <span class="keyword">for</span> repo <span class="string">&#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/blog/vm/rhui-yum-update/02.png"></p><p>この場合の解決方法としては、Azure RHUI へアクセスできるように、<br>Azure RHUI サーバーの IP アドレスに対する送信規則の 443 ポートの通信許可を設定する必要があります。<br>下記画像の通り、”送信セキュリティ規則の追加” から、通信許可の設定を追加する必要があります。<br>また、優先度は、DenyInternet (インターネットへの制限規則) より高くする必要がある点にご注意ください。</p><p><img src="/blog/vm/rhui-yum-update/03.png"></p><hr><h2 id="エラーの原因その-2-Azure-RHUI-への接続ができない-Proxy-等"><a href="#エラーの原因その-2-Azure-RHUI-への接続ができない-Proxy-等" class="headerlink" title="エラーの原因その 2 : Azure RHUI への接続ができない (Proxy 等)"></a>エラーの原因その 2 : Azure RHUI への接続ができない (Proxy 等)</h2><p>Azure VM から、オンプレミスのネットワークインフラストラクチャや、プロキシ、NVA (仮想アプライアンス) 経由での Azure RHUI へのアクセスはサポートされていないため、<br>Azure VM から直接、Azure RHUI に接続する必要があります。</p><p>この場合の解決方法としては、Azure VM が Azure RHUI の IP アドレスに直接接続できるようユーザー定義のルートテーブル UDR (User Defined Route) を作成する必要があります。<br>下記画像のように、RHUI コンテンツ配信サーバーの IP アドレス全てに対して、<br>次ホップ (Next hops) の種類に “Internet” を指定した UDR を作成頂く必要があります。</p><p><img src="/blog/vm/rhui-yum-update/04.png"></p><p>Azure VM のルートテーブルの作成手順については、下記公開ドキュメントをご確認ください。</p><blockquote><p>  □ 参考 : ルート テーブルの作成、変更、削除 | ルートの作成<br>   <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table#create-a-route-table">https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table#create-a-route-table</a></p></blockquote><div class="alert is-success"><p class="alert-title">ヒント</p><p>※プロキシの設定を実施している場合は、/etc/yum.conf 内の “proxy=” のプロキシ設定がないかご確認ください。</p><p>  プロキシ設定があった場合、コメントアウト等で無効にしてください。</p></div><hr><h2 id="エラーの原因その-3-クライアント証明書の期限切れ"><a href="#エラーの原因その-3-クライアント証明書の期限切れ" class="headerlink" title="エラーの原因その 3 : クライアント証明書の期限切れ"></a>エラーの原因その 3 : クライアント証明書の期限切れ</h2><p>古い RHEL VM イメージを利用している際には、 TLS/SSL クライアント証明書の期限が切れているために、<br>Azure RHUI に接続できない問題が発生することがあります。<br>クライアント証明書の期限が切れた際には、yum update を実施した際に下記のようなエラーが出力されることがあります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]<span class="comment"># yum update</span></span><br><span class="line">Loaded plugins: langpacks, product-id, search-disabled-repos</span><br><span class="line">rhui-microsoft-azure-rhel7-eus                                                                   | 2.1 kB  00:00:00</span><br><span class="line">https://rhui-1.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl<span class="comment">#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span></span><br><span class="line">Trying other mirror.</span><br><span class="line">https://rhui-2.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl<span class="comment">#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span></span><br><span class="line">Trying other mirror.</span><br><span class="line">https://rhui-3.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl<span class="comment">#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span></span><br><span class="line">Trying other mirror.</span><br></pre></td></tr></table></figure><p>この場合の解決方法としては、下記コマンドを実施頂き、<br>クライアント証明書を更新頂くことで、Azure RHUI へのアクセスができるようになることが想定されます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update -y --disablerepo=<span class="string">&#x27;*&#x27;</span> --enablerepo=<span class="string">&#x27;*microsoft*&#x27;</span></span><br></pre></td></tr></table></figure><p>※本コマンドは、ruhi の rpm のみを更新するコマンドとなります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>解消しない場合には、下記コマンドも併せてお試しください</p><p>sudo yum clean all</p><p>sudo yum makecache</p></div><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><p>今回ご紹介した方法でも、事象が解消しない場合には、<br>yum repolist all コマンドを実行頂き、有効なリポジトリをご確認頂ければと思います。</p><p>カスタムイメージや、ゴールドイメージの BYOS イメージをご利用されている場合には、<br>RHSM や サテライトに接続する必要があります。</p><blockquote><p>□ 参考 : Azure のオンデマンド Red Hat Enterprise Linux VM 用 Red Hat Update Infrastructure<br>   <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui">https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui</a></p></blockquote><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure テクニカル サポート チームの高橋です。&lt;br&gt;今回はよく、お問い合わせを頂く&lt;br&gt;Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の仮想マシンにおいて&lt;br&gt;yum / dnf update やパッケージのインストールに失敗する場合の&lt;br&gt;よくある原因とその解決方法についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="RHEL" scheme="https://jpaztech.github.io/blog/tags/RHEL/"/>
    
    <category term="RHUI" scheme="https://jpaztech.github.io/blog/tags/RHUI/"/>
    
  </entry>
  
  <entry>
    <title>強制トンネリング利用時の VPN ゲートウェイの動作変更についてのアナウンス</title>
    <link href="https://jpaztech.github.io/blog/network/vpn-defaultsite-update-2022feb/"/>
    <id>https://jpaztech.github.io/blog/network/vpn-defaultsite-update-2022feb/</id>
    <published>2022-02-02T05:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.376Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームです。</p><p>Azure の仮想ネットワーク ゲートウェイ (以下「ゲートウェイ」) を用いたサイト間 VPN 接続について、2022 年 2 月 24 日以降に、強制トンネリングに関する一部の動作の変更が行われることがアナウンスされました。</p><p>影響が生じる可能性のあるお客様には通知がすでに送信されているか、近日中に送信されることが想定されます。しかしながら、通知に含まれる説明は要点のみとなっているため、本記事にてその補足をさせていただきます。</p><span id="more"></span><p><br><br></p><h2 id="本記事の内容"><a href="#本記事の内容" class="headerlink" title="本記事の内容"></a>本記事の内容</h2><p>本記事では、動作変更の影響を受ける条件やその合致確認の方法、動作変更の内容および変更の影響を受けないようにする対処方法ついてまとめております。本記事を参考に影響有無を確認するとともに、影響が想定される場合は 2 月 24 日までにあらかじめ対処を実施いただければと思います。</p><p>前半ではリソース マネージャー モデル（新しいモデル）のための手順、後半ではクラシック モデル（古いモデル）のための手順をおまとめしておりますので、それぞれご利用の環境に合わせて確認ください。</p><p><br><br></p><h2 id="今回の動作変更の背景"><a href="#今回の動作変更の背景" class="headerlink" title="今回の動作変更の背景"></a>今回の動作変更の背景</h2><p>Azure のゲートウェイには、「SKU」と呼ばれるパラメーターがあり、ゲートウェイの性能や冗長構成を指定することができます。ゲートウェイの SKU には、大きくわけて以下の 2 種類があります。</p><ul><li>末尾に AZ がつく SKU: VpnGw1AZ、VpnGw2AZ、VpnGw3AZ、VpnGw4AZ、VpnGw5AZ<br></li><li>末尾に AZ がつかない SKU: VpnGw1、VpnGw2、VpnGw3、VpnGw4、VpnGw5、Basic、Standard、HighPerformance</li></ul><p>AZ がつく SKU とつかない SKU では、冗長性確保のためのデータセンター内部の配置が少し違うのみで、そのほかに機能面での基本的な違いはありません。</p><p>しかし今回、特定の条件下において、AZ がつく SKU と AZ がつかない SKU で強制トンネリングに関する一部の動作 (詳細は後述) に差異があることが判明しました。AZ がつかない SKU を対象に動作変更を行い、AZ がつく SKU の動作を正として動作を揃えるというのが、今回のアナウンスの内容です。</p><p><br><br></p><h2 id="動作変更の内容"><a href="#動作変更の内容" class="headerlink" title="動作変更の内容"></a>動作変更の内容</h2><h3 id="強制トンネリングを実現する-2-種類の方法"><a href="#強制トンネリングを実現する-2-種類の方法" class="headerlink" title="強制トンネリングを実現する 2 種類の方法"></a>強制トンネリングを実現する 2 種類の方法</h3><p>Azure のサイト間 VPN においては、Azure 仮想ネットワークから送信されるすべての通信を、データセンターのバックボーンネットワークではなく、VPN にルーティングする「強制トンネリング」という構成が可能です。サイト間 VPN で強制トンネリングを構成するためには、以下の 2 種類の方法があります。</p><ul><li>方法 1. 対向のルーターと BGP で経路交換を行い、対向のルーターからデフォルト ルート 0.0.0.0/0 (を広報する)</li><li>方法 2. BGP は利用せず、ゲートウェイに DefaultSite の設定を行う</li></ul><h3 id="動作が変更される対象となる方法"><a href="#動作が変更される対象となる方法" class="headerlink" title="動作が変更される対象となる方法"></a>動作が変更される対象となる方法</h3><p>このうち、方法 2 を利用している場合は、SKU によって強制トンネリングのために必要な作業が少し異なります。SKU に AZ がつく場合は、DefaultSite の設定を行うだけで、仮想ネットワーク内の全てのサブネットに対して、デフォルト ルートを VPN に向けるルートが反映されます。</p><p>しかし AZ がつかない場合は、DefaultSite の設定を行うだけでは強制トンネリングのためのルートが適用されません。DefaultSite の設定に加えて、0.0.0.0/0 のネクストホップをゲートウェイにしたユーザー定義ルート (UDR) を各サブネットに適用することで、はじめて強制トンネリングがそのサブネットで有効になります。</p><p>今回の動作変更では、この動作を AZ がつく SKU に合わせます。つまり、DefaultSite の設定がされている環境では、0.0.0.0/0 をゲートウェイに向ける UDR が適用されていなくても、強制トンネリングが有効になります。対象の環境においては、強制トンネリングが現状有効になっていないサブネットで、2 月 24 日以降に突然強制トンネリングが有効になる、ということが起こり得ます。</p><p>※ 方法 1 (BGP) を利用している場合は、今回の動作変更による影響はありません。</p><p><br><br></p><h2 id="動作変更による影響が生じる条件"><a href="#動作変更による影響が生じる条件" class="headerlink" title="動作変更による影響が生じる条件"></a>動作変更による影響が生じる条件</h2><p>以下の 5 つの条件に <strong>すべて</strong> 合致した場合に、今回の動作変更の影響を受けます。</p><ul><li>A. VPN 用の仮想ネットワーク ゲートウェイがある</li><li>B. ゲートウェイの SKU は末尾に AZ がつかないものである</li><li>C. サイト間 VPN を利用している</li><li>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していない</li><li>E. DefaultSiteの設定がされている</li></ul><p>それぞれの条件についての合致確認の方法は、本記事の末尾にまとめております。</p><p><br><br></p><h2 id="条件にすべて合致した場合の対応"><a href="#条件にすべて合致した場合の対応" class="headerlink" title="条件にすべて合致した場合の対応"></a>条件にすべて合致した場合の対応</h2><p>上記の 5 つの条件に <strong>すべて</strong> 合致した場合、動作変更の影響が生じる可能性があります。つまり、0.0.0.0/0 をゲートウェイに向けるユーザー定義ルートが適用されていなくても、2 月 24 日以降の動作変更によって、強制トンネリングがそのサブネットで有効になります。</p><p>予期せず強制トンネリングが有効になることを防ぐためには、あらかじめ 0.0.0.0/0 のネクストホップをインターネットに向ける UDR を適用することが有効です。2 月 24 日よりも前にこの UDR を適用しておくことで、その UDR が適用されたサブネットでは、動作変更によって強制トンネリングが突然有効になる状況を回避することができます。</p><p>（したがって、現状ですでに 0.0.0.0/0 のネクストホップをインターネットに設定する UDR が適用されているサブネットについては、影響を受けません）</p><h3 id="対応手順の例"><a href="#対応手順の例" class="headerlink" title="対応手順の例"></a>対応手順の例</h3><p>具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><ol><li><p><b>Azure ポータルを開きます。<br></b><br><a href="https://portal.azure.com/">https://portal.azure.com/</a></p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている場合は、手順 5) までスキップします。</b></p></li><li><p><b>[ルート テーブル] を開き、[+作成] をクリックします。</b></p></li><li><p><b>以下のパラメーターを入力し、[確認および作成] をクリックします。(詳細なパラメーターは環境に合わせてください)</b><br><br>　リソース グループ: 任意<br><br>　リージョン: ルート テーブルの適用対象の仮想ネットワークと合わせる<br><br>　名前: ルート テーブルの任意の名前<br><br>　ゲートウェイのルートを伝達する: Yes</p></li><li><p><b>4) で作成したルート テーブルか、既存のルート テーブルを開きます。</b></p></li><li><p><b>[ルート] メニューをクリックし、[+追加] をクリックします。</b></p></li><li><p><b>以下のパラメーターでルートを追加して [OK] をクリックします。</b><br><br>　ルート名: 任意の名前<br><br>　アドレス プレフィックス: 0.0.0.0/0<br><br>　ネクスト ホップの種類: インターネット<br></p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている状態で作業を行った場合は、これで終了です。</b></p></li><li><p><b>[サブネット] メニューをクリックし、[+関連付け] をクリックします。</b></p></li><li><p><b>ルート テーブルの適用対象の仮想ネットワークとサブネットを選択して、[OK] をクリックします。</b></p></li></ol><p>※ ルート テーブルの設定手順は <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table">公開資料</a> でも説明されておりますので、あわせてご覧ください。</p><p><br>　<br>　<br></p><h2 id="条件に合致しているかどうかを確認するための詳細手順"><a href="#条件に合致しているかどうかを確認するための詳細手順" class="headerlink" title="条件に合致しているかどうかを確認するための詳細手順"></a>条件に合致しているかどうかを確認するための詳細手順</h2><p>A～E それぞれの条件について、合致しているかどうかを確認するための手順の一例をご紹介いたします。</p><h3 id="A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認"><a href="#A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認" class="headerlink" title="A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認"></a>A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認</h3><p>Azure ポータルで [仮想ネットワーク ゲートウェイ] メニューを開き、[ゲートウェイの種類] が [Vpn] のものがあれば、この条件に合致しています。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-a01.png" alt="画面イメージ"></p><h3 id="B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認"><a href="#B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認" class="headerlink" title="B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認"></a>B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認</h3><p>A. でみつけたゲートウェイをクリックし、[SKU] 欄を確認して「AZ」が含まれていないものであれば、この条件に合致しています。（以下の画像は「AZ」が含まれる場合の例、つまり条件に合致しない例です）</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-b01.png" alt="画面イメージ"></p><h3 id="C-サイト間-VPN-を利用していることの確認"><a href="#C-サイト間-VPN-を利用していることの確認" class="headerlink" title="C. サイト間 VPN を利用していることの確認"></a>C. サイト間 VPN を利用していることの確認</h3><p>A. でみつけたゲートウェイをクリックし、[接続] メニューをクリックします。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-c01.png" alt="画面イメージ"></p><p>[接続] オブジェクトが表示されれば、この条件に合致しています。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-c02.png" alt="画面イメージ"></p><h3 id="D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認"><a href="#D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認" class="headerlink" title="D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認"></a>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認</h3><p>A. でみつけたゲートウェイをクリックし、[BGP ピア] メニューをクリックします。</p><p>[学習したルート] に 0.0.0.0/0 が含まれて <strong>いなければ</strong>、この条件に合致しています。（0.0.0.0/0 が含まれていたら、この条件に合致しませんので今回の変更の影響も受けません。少し紛らわしいのでご注意ください）</p><h3 id="E-DefaultSiteの設定がされていることの確認"><a href="#E-DefaultSiteの設定がされていることの確認" class="headerlink" title="E. DefaultSiteの設定がされていることの確認"></a>E. DefaultSiteの設定がされていることの確認</h3><p>この確認は PowerShell での作業が必要になります。</p><ol><li><p><b>Azure PowerShell を起動するか、<a href="https://shell.azure.com/">Cloud Shell</a> (PowerShell を選択) を開きます。</b></p></li><li><p><b>Azure PowerShell の場合、以下のコマンドを実行してサインインします。</b><br><br>Login-AzAccount</p></li><li><p><b>A. でみつけたゲートウェイが構築されているサブスクリプション ID を確認し、以下のコマンドを実行して操作対象のサブスクリプションを指定します。</b><br><br>Select-AzSubscription -SubscriptionId &lt;確認したサブスクリプション ID&gt;</p></li><li><p><b>以下のコマンドを実行し、対象のゲートウェイの構成情報を取得・表示します。</b><br><br>Get-AzVirtualNetworkGateway -Name &lt;ゲートウェイの名前&gt; -ResourceGroupName &lt;ゲートウェイのリソース グループ名&gt;</p></li><li><p><b>出力結果の中から、GatewayDefaultSite という行を探します。サイト名の情報が入っている場合は、この条件に合致します。「null」となっている場合は合致しません。</b></p></li></ol><br><hr><p><br>　<br>　<br>　<br><br><b>※ 以下は、クラシック デプロイ モデルをご利用の方に向けた手順です。</b><br><br></p><hr><h2 id="クラシックの場合-条件にすべて合致した場合の対応"><a href="#クラシックの場合-条件にすべて合致した場合の対応" class="headerlink" title="(クラシックの場合) 条件にすべて合致した場合の対応"></a>(クラシックの場合) 条件にすべて合致した場合の対応</h2><p>クラシック デプロイ モデルをご利用の場合における具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><h3 id="事前準備-Azure-PowerShell-の利用"><a href="#事前準備-Azure-PowerShell-の利用" class="headerlink" title="事前準備: Azure PowerShell の利用"></a>事前準備: Azure PowerShell の利用</h3><p>クラシック デプロイ モデルにおける対処のためには、Azure PowerShell をご利用いただくことができます。対処用のコマンドを実行するためには、事前に以下のコマンドを実行する必要があります。</p><ol><li><p><b>以下のコマンドを実行し、サインインします。</b><br><br>Add-AzureAccount</p></li><li><p><b>以下のコマンドを実行し、対象のサブスクリプションを指定します。</b><br><br>Select-AzureSubscription -SubscriptionId &lt;サブスクリプション ID&gt;</p></li></ol><h3 id="対応手順の例-1"><a href="#対応手順の例-1" class="headerlink" title="対応手順の例"></a>対応手順の例</h3><p>具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><ol><li><p><b>対象のサブネットにすでにルート テーブルが適用されているかどうかを確認します。</b><br><br>Get-AzureSubnetRouteTable -VirtualNetworkName “仮想ネットワーク名” -SubnetName “サブネット名”</p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている場合は、手順 4) までスキップします。</b></p></li><li><p><b>任意の名前でルート テーブルを作成します。</b><br><br>New-AzureRouteTable -Name “ルート テーブルの名前” -Location “リージョン名”</p></li><li><p><b>ルート テーブルに、0.0.0.0/0 のネクストホップを Internet に指定したルートを追加します。</b><br><br>Get-AzureRouteTable -Name “ルート テーブルの名前” | Set-AzureRoute -RouteName “DefaultRoute” -AddressPrefix “0.0.0.0/0” -NextHopType Internet</p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている状態で作業を行った場合は、これで終了です。</b></p></li><li><p><b>ルート テーブルをサブネットに適用します。</b><br><br>Set-AzureSubnetRouteTable -VirtualNetworkName “仮想ネットワーク名” -SubnetName “サブネット名” -RouteTableName “ルート テーブルの名前”</p></li></ol><br><hr><br><h2 id="クラシックの場合-条件に合致しているかどうかを確認するための詳細手順"><a href="#クラシックの場合-条件に合致しているかどうかを確認するための詳細手順" class="headerlink" title="(クラシックの場合) 条件に合致しているかどうかを確認するための詳細手順"></a>(クラシックの場合) 条件に合致しているかどうかを確認するための詳細手順</h2><p>クラシック デプロイ モデルをご利用の場合において、A～E それぞれの条件について、合致しているかどうかを確認するための手順の一例をご紹介いたします。</p><h3 id="事前準備-Azure-PowerShell-の利用-1"><a href="#事前準備-Azure-PowerShell-の利用-1" class="headerlink" title="事前準備: Azure PowerShell の利用"></a>事前準備: Azure PowerShell の利用</h3><p>クラシック デプロイ モデルにおける合致確認には、Azure PowerShell をご利用いただくことができます。合致確認用のコマンドを実行するためには、事前に以下のコマンドを実行する必要があります。</p><ol><li><p><b>以下のコマンドを実行し、サインインします。</b><br><br>Add-AzureAccount</p></li><li><p><b>以下のコマンドを実行し、対象のサブスクリプションを指定します。</b><br><br>Select-AzureSubscription -SubscriptionId &lt;確認したサブスクリプション ID&gt;</p></li></ol><h3 id="A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認-1"><a href="#A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認-1" class="headerlink" title="A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認"></a>A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認</h3><p>(確認不要) 下記 E. の手順に包含されるため、本手順は割愛します。</p><h3 id="B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認-1"><a href="#B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認-1" class="headerlink" title="B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認"></a>B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認</h3><p>(確認不要) クラシックでは、必ず AZ がつかない SKU となりますので、本手順は割愛します。</p><h3 id="C-サイト間-VPN-を利用していることの確認-1"><a href="#C-サイト間-VPN-を利用していることの確認-1" class="headerlink" title="C. サイト間 VPN を利用していることの確認"></a>C. サイト間 VPN を利用していることの確認</h3><p>(確認不要) 下記 E. の手順に包含されるため、本手順は割愛します。</p><h3 id="D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認-1"><a href="#D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認-1" class="headerlink" title="D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認"></a>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認</h3><p>(確認不要) クラシックでは BGP は利用できないため、本手順は割愛します。</p><h3 id="E-DefaultSiteの設定がされていることの確認-1"><a href="#E-DefaultSiteの設定がされていることの確認-1" class="headerlink" title="E. DefaultSiteの設定がされていることの確認"></a>E. DefaultSiteの設定がされていることの確認</h3><ol><li><p><b>Azure PowerShell で以下のコマンドを実行します。</b><br><br>Get-AzureVirtualNetworkGateway</p></li><li><p><b>表示されたゲートウェイの一覧から、以下のように DefaultSite に値が入っているものがあれば、合致しています。</b><br></p><blockquote><p>GatewayId            : xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<br><br>GatewayName          : Default<br><br>LastEventData        :<br><br>GatewayType          : DynamicRouting<br><br>LastEventTimeStamp   : xx/xx/xxxx xx:xx:xx<br><br>LastEventMessage     : Successfully updated the gateway for the following virtual network: xxxx <b>← 通常、ここに対象の仮想ネットワーク名が入ります。</b><br><br>LastEventID          : xxxxx<br><br>State                : Provisioned<br><br>VIPAddress           : x.x.x.x<br><br>DefaultSite          : Site01 <b>← ここにサイト名が入っていれば該当しています。該当しない場合空欄です。</b><br><br>GatewaySKU           : Standard<br><br>Location             : Japan East<br><br>VnetId               : xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<br><br>SubnetId             :<br><br>EnableBgp            : False<br><br>Asn                  : xxxxx<br><br>BgpPeeringAddress    : x.x.x.x<br><br>PeerWeight           : 0<br><br>OperationDescription :<br><br>OperationId          :<br><br>OperationStatus      :<br></p></blockquote></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチームです。&lt;/p&gt;
&lt;p&gt;Azure の仮想ネットワーク ゲートウェイ (以下「ゲートウェイ」) を用いたサイト間 VPN 接続について、2022 年 2 月 24 日以降に、強制トンネリングに関する一部の動作の変更が行われることがアナウンスされました。&lt;/p&gt;
&lt;p&gt;影響が生じる可能性のあるお客様には通知がすでに送信されているか、近日中に送信されることが想定されます。しかしながら、通知に含まれる説明は要点のみとなっているため、本記事にてその補足をさせていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>AKS コントロール プレーンとノード間の通信のはなし</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-control-plane-node-communication/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-control-plane-node-communication/</id>
    <published>2021-12-24T03:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.340Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は <a href="https://qiita.com/advent-calendar/2021/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2021</a> の 24 日目の記事になります🎅</p><p>こんにちは！！ Azure テクニカル サポート チームの桐井です。</p><p>AKS クラスターをデプロイすると、kube-system ネームスペースで <code>tunnelfront</code> や <code>aks-link</code> という名前の Pod が動いているかとおもいます。あるいは <code>konnectivity-agent</code> という Pod を見たことがあるという方もいるかもしれません。これらの Pod はどのような目的で使用されるのでしょう？</p><p>本記事では、これらのシステム Pod が担う AKS コントロール プレーンとノード間の通信について紹介します。</p><span id="more"></span><hr><h2 id="Kubernetes-クラスターのアーキテクチャ"><a href="#Kubernetes-クラスターのアーキテクチャ" class="headerlink" title="Kubernetes クラスターのアーキテクチャ"></a>Kubernetes クラスターのアーキテクチャ</h2><p>まずは説明にあたり、前提情報となる Kubernetes のアーキテクチャについて簡単に紹介いたします。Kubernetes のクラスターは、大きく分けて <strong>コントロール プレーン</strong> と <strong>ノード</strong> の 2 つのコンポーネントで構成されています。</p><p><img src="/blog/containers/aks-control-plane-node-communication/aks-control-plane-node-communication01.png" alt="AKS (Kubernetes) のアーキテクチャ"></p><h3 id="コントロール-プレーン"><a href="#コントロール-プレーン" class="headerlink" title="コントロール プレーン"></a>コントロール プレーン</h3><p>Kubernetes の主要なサービスが稼働しており、アプリケーション ワークロードのオーケストレーションを担います。コントロール プレーンでは API サーバー (kube-apiserver) が存在し、クラスターの操作を <a href="https://kubernetes.io/ja/docs/concepts/overview/kubernetes-api/">Kubernetes API</a> として提供します。</p><h3 id="ノード"><a href="#ノード" class="headerlink" title="ノード"></a>ノード</h3><p>コンテナー化されたアプリケーション ワークロードが実行されます。各ノードでは kubelet が動作しており、Pod のデプロイ内容に基づいてコンテナー ランタイムを操作したり、Node や Pod のステータスを API サーバーへ送信したりといった処理を行います。</p><p>Azure Kubernetes Service (AKS) は、Kubernetes コントロール プレーンを Azure のマネージド リソースとして提供するサービスとなっています。クラスターのアーキテクチャの詳細につきましては、下記 AKS ドキュメントをあわせてご参照ください。</p><blockquote><p>ご参考) Azure Kubernetes Services (AKS) における Kubernetes の中心概念<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/concepts-clusters-workloads">https://docs.microsoft.com/ja-jp/azure/aks/concepts-clusters-workloads</a></p></blockquote><h2 id="コントロール-プレーンとノード間の通信"><a href="#コントロール-プレーンとノード間の通信" class="headerlink" title="コントロール プレーンとノード間の通信"></a>コントロール プレーンとノード間の通信</h2><p>前述のように、クラスターの各種操作は Kubernetes API を介して行われます。クラスターの利用者が実行する kubectl コマンドや、ノード上で稼働する kubelet は、コントロール プレーンの API サーバー (kube-apiserver) にアクセスして、リソース操作や情報取得のリクエストを行います。</p><p>実際のアプリケーション ワークロードは、コントロール プレーンではなくノード側で動作しています。そのため、API サーバーはリクエストされたクラスター操作を実現するために、ノードや Pod との通信をする必要があります。</p><p>API サーバーとノードの通信は大きく 2 つにわけることができます。</p><p><img src="/blog/containers/aks-control-plane-node-communication/aks-control-plane-node-communication02.png" alt="API サーバーとノードの通信"></p><h3 id="1-ノードから-API-サーバー"><a href="#1-ノードから-API-サーバー" class="headerlink" title="(1) ノードから API サーバー"></a>(1) ノードから API サーバー</h3><p>API サーバーは HTTPS ポート (443) で Kubernetes API を公開しています。<br>kubelet や、Ingress Controller などの Kubernetes API を利用する Pod は、API サーバーのエンドポイントに HTTPS でアクセスをし、各種リソース情報の取得や更新を行います。</p><h3 id="2-API-サーバーからノード"><a href="#2-API-サーバーからノード" class="headerlink" title="(2) API サーバーからノード"></a>(2) API サーバーからノード</h3><p>一部のクラスター操作には、API サーバーから <a href="https://kubernetes.io/docs/reference/ports-and-protocols/#node">kubelet が持つ API エンドポイント</a>に対してリクエストを送信し、その結果を取得する処理が必要になります。</p><ul><li>Pod からログを取得する (kubectl logs)</li><li>Pod 上でコマンドを実行する (kubectl exec)</li><li>Pod / Service にポート フォワードで接続する (kubectl port-forward)</li></ul><p>また、<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/">Metrics API</a> へのアクセス (kubectl top) では、Node や Pod のリソース使用量を取得するために、ノード側で動作する <a href="https://github.com/kubernetes-sigs/metrics-server">metric-server</a> へのアクセスが必要となります。</p><p>これらの機能の実現をするために、API サーバーは kubelet や Pod / Service にアクセスする必要があるため、コントロール プレーンからノードへの通信経路が必要となります。</p><h2 id="コントロール-プレーンからノードへの通信の実現方法"><a href="#コントロール-プレーンからノードへの通信の実現方法" class="headerlink" title="コントロール プレーンからノードへの通信の実現方法"></a>コントロール プレーンからノードへの通信の実現方法</h2><p>冒頭で挙げたシステム Pod は、コントロール プレーンからノードへの通信を実現するために仮想的なネットワーク経路を作るクライアント Pod となっています。</p><p>これらのコンポーネントは Kubernetes のアーキテクチャ図には載っておらず、あまり聞き馴染みのない Pod かと思います。自分で仮想マシンを使って Kubernetes クラスターの構築 (<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kubernetes Hard Way</a>) を試したことがある方は、そのような Pod をインストールしたかな？と疑問に思うかもしれません。</p><p>コントロール プレーンとノードが同じネットワークに接続している場合は、kube-apiserver はノードや Pod に直接通信できます。ところが、コントロールプレーンとノードが異なるネットワークに存在し分断されている場合は、そのままではお互いに通信ができないので、何らかの方法でネットワーク経路を作り、通信ができるようにする必要があります。また、信頼できないネットワークやパブリック ネットワークを経由させる場合には、盗聴や中間者攻撃を防ぐためにネットワークの保護も必要です。</p><p>パブリック クラウドの Kubernetes サービスでは、コントロールプレーンをマネージド サービスとして提供するため、ノードが存在しているお客様の環境とは別のネットワークが使用されます。そのため、SSH トンネルや VPN といった技術を使って、API サーバーとノード間で仮想的なネットワーク経路が作られる構成になっています。</p><p><img src="/blog/containers/aks-control-plane-node-communication/aks-control-plane-node-communication03.png" alt="異なるネットワークに存在するコントロール プレーンとノード間でネットワーク接続を実現する"></p><p>コントロール プレーンとノード間のネットワーク接続には、いくつかの実現方法がございます。ここでは、AKS で利用されている通信方式と、各方式において kube-system ネームスペースにデプロイされるシステム Pod の名前を紹介いたします。クラスターの構成や作成時期によって、以下のいずれかの方式が利用されます。</p><h3 id="SSH-トンネル-tunnelfront-Pod"><a href="#SSH-トンネル-tunnelfront-Pod" class="headerlink" title="SSH トンネル (tunnelfront-* Pod)"></a>SSH トンネル (tunnelfront-* Pod)</h3><p><code>tunnelfront</code> という名前の Pod が存在するクラスターでは、SSH トンネルが使用されています。コントロール プレーン側には SSH サーバーが存在し、API サーバーのエンドポイントで SSH クライアントからの接続を受け付けています。<code>tunnelfront</code> Pod は SSH クライアントとなっており、コントロール プレーンとノード間で SSH トンネルを開始します。kubelet や Pod / Service 宛てのトラフィックは SSH トンネル経由で転送されます。</p><h3 id="VPN-トンネル-aks-link-Pod"><a href="#VPN-トンネル-aks-link-Pod" class="headerlink" title="VPN トンネル (aks-link-* Pod)"></a>VPN トンネル (aks-link-* Pod)</h3><p><code>aks-link</code> という名前の Pod が存在する場合は、VPN トンネル (OpenVPN) が使用されています。コントロール プレーン側には VPN サーバーが存在します。ノード側の <code>aks-link</code> Pod が VPN クライアントとなっており、コントロール プレーンとノード間で VPN トンネルを開始します。</p><h3 id="Konnectivity-konnectivity-agent-Pod"><a href="#Konnectivity-konnectivity-agent-Pod" class="headerlink" title="Konnectivity (konnectivity-agent-* Pod)"></a>Konnectivity (konnectivity-agent-* Pod)</h3><p><code>konnectivity-agent</code> という名前の Pod が存在する場合には <a href="https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/#konnectivity-service">Konnectivity service</a> が使用されています。Konnectivity はアップストリームの Kubernetes プロジェクトで<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">開発されている</a> TCP レベルのプロキシーです。コントロール プレーン側では Konnectivity Server が起動し、ノード側では Konnectivity Agent が起動します。</p><p>AKS では SSH / VPN トンネルに替わる新しい方式として、段階的に Konnectivity の導入がすすめられています。<a href="https://github.com/Azure/AKS/releases/tag/2021-10-28">Release 2021-10-28</a> で一部リージョンからロールアウトが開始されましたが、<a href="https://github.com/Azure/AKS/releases/tag/2021-11-18">Release 2021-11-18</a> 以降、2021 年の残りの期間ではロールアウトが中断となっています。そのため、日本リージョンで利用可能になるのはもう少し先になる見込みです。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>余談: 「コネクティビティ」というと英語の「connectivity」と紛らわしいので「Konnectivity with K」と呼ばれることがあります。</p></div><h2 id="トラブルシューティングの事例"><a href="#トラブルシューティングの事例" class="headerlink" title="トラブルシューティングの事例"></a>トラブルシューティングの事例</h2><p>コントロール プレーンとノードの通信については、関連するトラブルのご相談を Azure サポートにお寄せいただくことがございます。多く寄せられるご相談としましては、Kubernetes の一部機能が利用できないという事象です。</p><ul><li>Pod 上でコマンド実行ができない (kubectl exec)</li><li>Pod のログ取得ができない (kubectl logs)</li><li>port-forward ができない (kubectl port-forward)</li><li>Pod や Node のメトリックが取得できない (kubectl top)</li></ul><p>Pod の作成/削除といったリソース操作は成功するものの、上記に挙げましたように kubectl の一部コマンドが使えないという症状がある場合は、何らかの要因でコントロール プレーンとノード間の通信が成功していないことが考えられます。</p><blockquote><p>ご参考) Azure Kubernetes Service (AKS) についてよく寄せられる質問<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do">「kubectl logs を使用してログを取得できません。または、API サーバーに接続できません。 “Error from server: error dialing backend: dial tcp…” (サーバーからのエラー: バックエンドへのダイヤルでのエラー: tcp にダイヤル…) と表示されます。 どうすればよいですか。」</a><br><a href="https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do">https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do</a></p></blockquote><p>この事象が発生しました場合は以下の観点をご確認ください。</p><h3 id="観点-1-クラスターに必要な通信要件を満たしているか"><a href="#観点-1-クラスターに必要な通信要件を満たしているか" class="headerlink" title="(観点 1) クラスターに必要な通信要件を満たしているか"></a>(観点 1) クラスターに必要な通信要件を満たしているか</h3><p>API サーバーへの通信が NSG や Azure Firewall によってブロックされていないかを確認します。</p><p>下記 AKS ドキュメントに、クラスターの動作に必要なエンドポイントとポート番号の一覧がございます。ご利用の環境に応じて、通信が必要な FQDN / ポート番号の許可がされているかをご確認ください。</p><blockquote><p>ご参考) Azure Kubernetes Service (AKS) でクラスター ノードに対するエグレス トラフィックを制御する<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters">AKS クラスターに必要な送信ネットワーク規則と FQDN</a><br><a href="https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters">https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters</a></p></blockquote><h3 id="観点-2-kube-system-ネームスペースのシステム-Pod-が正常動作しているか"><a href="#観点-2-kube-system-ネームスペースのシステム-Pod-が正常動作しているか" class="headerlink" title="(観点 2) kube-system ネームスペースのシステム Pod が正常動作しているか"></a>(観点 2) kube-system ネームスペースのシステム Pod が正常動作しているか</h3><p>kube-system ネームスペース内のシステム Pod が正常に動作しているかを確認します。</p><p>本記事で紹介をいたしました <code>tunnelfront</code> や <code>aks-link</code> といったシステム Pod が Running ステータスで動作をしているか、また、Pod のログに何らかのエラー メッセージが出力されていないかをご確認ください。詳細につきましては下記の AKS トリアージ ガイドをご参照ください。</p><blockquote><p>ご参考) AKS トリアージのプラクティス - ノードとポッドの正常性を調べる<br><a href="https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity">2 - コントロール プレーンとワーカー ノードの接続を確認する</a><br><a href="https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity">https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity</a></p></blockquote><p>API サーバーとの通信に問題がある場合、<code>kubectl logs</code> が成功せず、Pod のログ確認ができないことが想定されます。<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview">Container Insights</a> が有効なクラスターでは、クラスター内の監視エージェント (omsagent) によって収集されたログが、Log Analytics ワークスペースから取得出来る場合がございます。kubectl コマンドでのログ取得が成功しない場合は、<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-log-query">クエリーを使用した Log Analytics からのログ取得</a>をお試しください。</p><p>上記をご確認いただいたあとも引き続き事象が発生します場合は、Azure サポートまでお気兼ねなくご相談ください。クラスターの状態を拝見させていただき、見解・対処方法をご案内いたします。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>Kubernetes コントロール プレーンとノード間の通信と、AKS における通信方式、そしてトラブルシューティングの事例について紹介しました。</p><p>本記事で紹介しました Konnectivity は段階的に各リージョンへロールアウトされる見込みです。最新の情報につきましては、AKS の GitHub リポジトリにございますリリース情報をご参照ください。</p><blockquote><p>ご参考) Azure/AKS - Releases<br><a href="https://github.com/Azure/AKS/releases">https://github.com/Azure/AKS/releases</a></p></blockquote><p>本稿が皆様のお役に立ちましたら幸いです。</p><h3 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h3><ul><li><a href="https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/">Control Plane-Node Communication - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/tasks/extend-kubernetes/setup-konnectivity/">Set up Konnectivity service - Kubernetes</a></li><li><a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1281-network-proxy">kubernetes / enhancements - API Server Network Proxy</a></li></ul><hr><p>最後まで読んでいただきありがとうございました！<br><a href="https://qiita.com/advent-calendar/2021/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2021</a> は明日が最終日となります！是非ご覧くださいー！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2021/microsoft-azure-tech&quot;&gt;Microsoft Azure Tech Advent Calendar 2021&lt;/a&gt; の 24 日目の記事になります🎅&lt;/p&gt;
&lt;p&gt;こんにちは！！ Azure テクニカル サポート チームの桐井です。&lt;/p&gt;
&lt;p&gt;AKS クラスターをデプロイすると、kube-system ネームスペースで &lt;code&gt;tunnelfront&lt;/code&gt; や &lt;code&gt;aks-link&lt;/code&gt; という名前の Pod が動いているかとおもいます。あるいは &lt;code&gt;konnectivity-agent&lt;/code&gt; という Pod を見たことがあるという方もいるかもしれません。これらの Pod はどのような目的で使用されるのでしょう？&lt;/p&gt;
&lt;p&gt;本記事では、これらのシステム Pod が担う AKS コントロール プレーンとノード間の通信について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>Azure File の診断設定を試す</title>
    <link href="https://jpaztech.github.io/blog/storage/azureFilesMonitoring/"/>
    <id>https://jpaztech.github.io/blog/storage/azureFilesMonitoring/</id>
    <published>2021-12-22T01:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.400Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は <a href="https://qiita.com/advent-calendar/2021/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2021</a> の 22 日目の記事になります。</p><p>こんにちは、Azure テクニカル サポート チームの木下です。<br>今回は Azure Files の診断設定機能を紹介いたします。<br>Azure Files へのアクセスについて、「いつ、誰が、どのオブジェクトに、どのような操作を行ったか」という情報を取得したいというお問い合わせをいただくことがございます。<br>Azure Files へアクセスした際のログは、Azure Files の診断設定機能を使用することで、アクセス要求元や操作内容を大まかに把握することができます。<br>この記事では Azure Files 診断設定機能の設定方法とどのようなログを取得することができるのかを紹介していきます。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ol><li>Azure Files 診断設定の設定手順</li><li>診断ログ内容を確認</li></ol><h2 id="1-Azure-Files-診断設定の設定手順"><a href="#1-Azure-Files-診断設定の設定手順" class="headerlink" title="1. Azure Files 診断設定の設定手順"></a>1. Azure Files 診断設定の設定手順</h2><p>1-1. Azure Portal &gt; 対象のストレージ アカウントに移動します。</p><p>1-2. [監視] &gt; [診断設定] をクリックします。<br><img src="/blog/storage/azureFilesMonitoring/azureFilesMonitoring09.png"></p><p>1-3. 診断設定を有効にする種類として [file] を選択します。<br><img src="/blog/storage/azureFilesMonitoring/azureFilesMonitoring10.png"></p><p>1-4. [診断設定を追加する]をクリックします。<br><img src="/blog/storage/azureFilesMonitoring/azureFilesMonitoring11.png"></p><p>1-5. [診断設定]ページにて、「診断設定の名前」、取得するログ操作の「カテゴリ」と「宛先の詳細」を選択します。</p><ul><li>診断設定の名前：任意の名前</li><li>ログ：取得するログ操作のカテゴリ (StorageRead(読み取り)、StorageWrite(書き込み)、削除(StorageDelete))</li><li>宛先の詳細：ログの送信先 ※ここではログの送信先としてストレージ アカウントを選択しています。</li></ul><p><img src="/blog/storage/azureFilesMonitoring/azureFilesMonitoring04.png"></p><p>これで Azure Files の診断設定が完了です。</p><h2 id="2-診断ログ内容を確認"><a href="#2-診断ログ内容を確認" class="headerlink" title="2. 診断ログ内容を確認"></a>2. 診断ログ内容を確認</h2><p>1 の手順にて診断ログの送信先をストレージ アカウントへ設定した場合、以下の画像のように送信先ストレージ アカウント内の各コンテナーにログが格納されることとなります。<br><img src="/blog/storage/azureFilesMonitoring/azureFilesMonitoring05.png"></p><p>※ログは定期的に収集されますので、タイムラグが発生する可能性がございます。</p><table><thead><tr><th>カテゴリ</th><th>説明</th><th>送信先ストレージ アカウント内コンテナー名</th></tr></thead><tbody><tr><td>StorageRead</td><td>オブジェクトに対する読み取り操作。</td><td>insights-logs-storageread</td></tr><tr><td>StorageWrite</td><td>オブジェクトに対する書き込み操作。</td><td>insights-logs-storagewrite</td></tr><tr><td>StorageDelete</td><td>オブジェクトに対する削除操作。</td><td>insights-logs-storagedelete</td></tr></tbody></table><ul><li>参考：収集とルーティング<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-monitoring?tabs=azure-portal#collection-and-routing">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-monitoring?tabs=azure-portal#collection-and-routing</a></li></ul><p>Azure Files 内のオブジェクトに対して、「いつ、誰が、どのオブジェクトに、どのような操作を行ったか」を把握するために、Azure Files の診断設定にて取得したログを確認してみましょう。</p><table><thead><tr><th>プロパティ</th><th>説明</th><th>把握したい情報</th></tr></thead><tbody><tr><td>time</td><td>ストレージで要求が受信された協定世界時 (UTC) での時刻。 (例: 2018/11/08 21:09:36.6900118)。日本時間の場合は UTC +9 時間。</td><td>いつ</td></tr><tr><td>category</td><td>要求された操作のカテゴリ。 例: StorageRead、StorageWrite、またはStorageDelete。</td><td>操作内容</td></tr><tr><td>operationName</td><td>実行された REST 操作の種類。</td><td>操作内容</td></tr><tr><td>callerIpAddress</td><td>ポート番号を含む要求元の IP アドレス (例: 192.XXX.X.XXX:4362)。</td><td>誰が</td></tr><tr><td>smbPrimarySID</td><td>要求元の SID</td><td>誰が</td></tr><tr><td>uri</td><td>要求された Uniform Resource Identifier</td><td>対象オブジェクト</td></tr><tr><td>properties</td><td>要求された操作の詳細</td><td>対象オブジェクト</td></tr></tbody></table><p>上記のように、各プロパティを確認することで、「いつ、誰が、どのオブジェクトに、どのような操作を行ったか」の情報を得ることができます。<br>ただし、Azure Files へアクセスいただく際に使用されるプロトコルや認証方法により取得できるリソース ログのプロパティは異なります。</p><p>Azure Files にて使用可能なプロトコルや認証方法については以下をご参照ください。</p><p>&lt;参考&gt;</p><ul><li>Azure Files とは<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction</a></li><li>ソリューション 4 - REST API ベースのツール (Storage Explorer や Powershell など) を使用する<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-troubleshoot-windows-file-connection-problems#solution-4---use-rest-api-based-tools-like-storage-explorerpowershell">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-troubleshoot-windows-file-connection-problems#solution-4---use-rest-api-based-tools-like-storage-explorerpowershell</a></li><li>SMB アクセスの Azure Files ID ベース認証オプションの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-active-directory-overview">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-active-directory-overview</a></li><li>ストレージ アカウント アクセス キーを管理する<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-account-keys-manage?tabs=azure-portal">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-account-keys-manage?tabs=azure-portal</a></li></ul><p>それでは、プロトコル、認証方法別にリソース ログのサンプルを見ていきます。<br>以下は取得されたログの一例であり、すべてのログが網羅されているものではございませんのでご了承ください。</p><h3 id="2-1-SMB-プロトコル・ストレージ-アカウントキー認証の場合"><a href="#2-1-SMB-プロトコル・ストレージ-アカウントキー認証の場合" class="headerlink" title="2-1.SMB プロトコル・ストレージ アカウントキー認証の場合"></a>2-1.SMB プロトコル・ストレージ アカウントキー認証の場合</h3><p>SMB プロトコルを使用し Azure Files をストレージ アカウントキー認証でマウント後、Azure Files 配下のオブジェクトを操作した際のログとなります。<br>操作の要求元に関ましてアクセス元の IP アドレスの取得は可能ですが、詳細なユーザー情報の特定までは叶いません。</p><p>category: StorageRead</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-19T09:48:37.8138026Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageRead&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Read&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 1, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;192.XXX.X.XXX&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;NTLMv2&quot;&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;XXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\test.txt&quot;,★対象オブジェクト</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;2021/11/19 09:41:48.2315339&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:1,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;requestHeaderSize&quot;:64,</span><br><span class="line">&quot;requestBodySize&quot;:49,</span><br><span class="line">&quot;responseHeaderSize&quot;:64,</span><br><span class="line">&quot;responseBodySize&quot;:118,</span><br><span class="line">&quot;contentLengthHeader&quot;:50,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:5,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbMessageID&quot;:275,</span><br><span class="line">&quot;smbCommandMajor&quot;:8,</span><br><span class="line">&quot;smbCommandDetail&quot;:</span><br><span class="line">&quot;Bytes=0x32 Offset=0x0 ExtentReads=1&quot;,</span><br><span class="line">&quot;smbFileId&quot;:XXXXXXXXXXXXX&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\test.txt&quot;, ★対象オブジェクト</span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category:StorageWrite</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-19T10:21:21.5491188Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageWrite&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Create&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 8, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;192.XXX.X.XXX&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;NTLMv2&quot;&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;XXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\&quot;,★対象オブジェクト</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;2021/11/19 08:37:14.3501386&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:6,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;requestHeaderSize&quot;:64,</span><br><span class="line">&quot;requestBodySize&quot;:208,</span><br><span class="line">&quot;responseHeaderSize&quot;:64,</span><br><span class="line">&quot;responseBodySize&quot;:168,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:1,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbMessageID&quot;:4,</span><br><span class="line">&quot;smbCommandMajor&quot;:5,</span><br><span class="line">&quot;smbCommandMinor&quot;:&quot;FileReOpen&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\&quot;, ★対象オブジェクト</span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category: StorageDelete</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-19T10:35:39.3706377Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageDelete&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Close&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 3, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;192.XXX.X.XXX&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;NTLMv2&quot;&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;XXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\testcopy.txt&quot;,★対象オブジェクト</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;2021/11/19 10:32:03.4499784&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:3,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;requestHeaderSize&quot;:64,</span><br><span class="line">&quot;requestBodySize&quot;:24,</span><br><span class="line">&quot;responseHeaderSize&quot;:64,</span><br><span class="line">&quot;responseBodySize&quot;:112,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:1,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbMessageID&quot;:147,</span><br><span class="line">&quot;smbCommandMajor&quot;:6,</span><br><span class="line">&quot;smbCommandMinor&quot;:&quot;FileCloseAndDelete&quot;,</span><br><span class="line">&quot;smbCommandDetail&quot;:&quot;Detail=Client&quot;,</span><br><span class="line">&quot;smbFileId&quot;:XXXXXXXXXXXXX&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\testcopy.txt&quot;, </span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-SMB-プロトコル・ID-ベース認証の場合"><a href="#2-2-SMB-プロトコル・ID-ベース認証の場合" class="headerlink" title="2-2.SMB プロトコル・ID ベース認証の場合"></a>2-2.SMB プロトコル・ID ベース認証の場合</h3><p>SMB プロトコルを使用し Azure Files を ID ベース認証でマウント後、Azure Files 配下のオブジェクトを操作した際のログとなります。<br>ID ベース認証を使用したアクセスの場合、リソース ログに SID が出力されるため、SID よりユーザーを特定することができます。</p><p>例として使用した 2 つのユーザーの SID は以下となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User Name          SID</span><br><span class="line">================== ==============================================</span><br><span class="line">contoso\testuser01 S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-1103</span><br><span class="line">contoso\testuser02 S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-1104</span><br></pre></td></tr></table></figure><p>category: StorageRead</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-26T04:53:47.0548913Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageRead&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Read&quot;,★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 6, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;10.X.X.X&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;Kerberos&quot;,</span><br><span class="line">&quot;requester&quot;:&#123;&quot;smbPrimarySID&quot;:&quot;S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-1103&quot;&#125;&#125;, ★誰が (ユーザー contoso\testuser01 であることを特定できます)</span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\oldtestuser03\\test01.txt&quot;,★対象オブジェクト</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;2021/11/26 04:53:39.1662456&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:6,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;requestHeaderSize&quot;:64,</span><br><span class="line">&quot;requestBodySize&quot;:49,</span><br><span class="line">&quot;responseHeaderSize&quot;:64,</span><br><span class="line">&quot;responseBodySize&quot;:71,</span><br><span class="line">&quot;contentLengthHeader&quot;:3,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:5,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbMessageID&quot;:226,</span><br><span class="line">&quot;smbCommandMajor&quot;:8,</span><br><span class="line">&quot;smbCommandDetail&quot;:&quot;Bytes=0x3 Offset=0x0 ExtentReads=1&quot;,</span><br><span class="line">&quot;smbFileId&quot;:XXXXXXXXXXXXX</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\oldtestuser03\\test01.txt&quot;, ★対象オブジェクト</span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-26T10:16:12.1669701Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageRead&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;ChangeNotify&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: -1073741536, </span><br><span class="line">&quot;durationMs&quot;: 0, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;10.X.X.X&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;Kerberos&quot;,</span><br><span class="line">&quot;requester&quot;:&#123;&quot;smbPrimarySID&quot;:&quot;S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-1104&quot;&#125;&#125;, ★誰が (ユーザー contoso\testuser02 であることを特定できます)</span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\&quot;,</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;1601/01/01 00:00:00.0000000&quot;,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;responseHeaderSize&quot;:64,</span><br><span class="line">&quot;responseBodySize&quot;:61,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:5,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbMessageID&quot;:284,</span><br><span class="line">&quot;smbCommandMajor&quot;:15,</span><br><span class="line">&quot;smbCommandDetail&quot;:&quot;Filter=0x2&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\&quot;, ★操作対象</span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category: StorageWrite</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-26T10:17:22.9734137Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageWrite&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Close&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 8, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;10.X.X.X&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;Kerberos&quot;,</span><br><span class="line">&quot;requester&quot;:&#123;&quot;smbPrimarySID&quot;:&quot;S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-1103&quot;&#125;&#125;, ★誰が (ユーザー contoso\testuser01 であることを特定できます)</span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\&quot;,★対象オブジェクト</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;2021/05/17 16:12:01.7491068&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:8,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:1,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbCommandMajor&quot;:6,</span><br><span class="line">&quot;smbCommandMinor&quot;:&quot;DirectoryClose&quot;,</span><br><span class="line">&quot;smbCommandDetail&quot;:&quot;Detail=Closing master session&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\aptsstor01.file.core.windows.net\\shared01\\&quot;, ★対象オブジェクト</span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category: StorageDelete</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-26T10:09:26.9040113Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageDelete&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Close&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;0x311&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 4, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;10.X.X.X&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;Kerberos&quot;,</span><br><span class="line">&quot;requester&quot;:&#123;&quot;smbPrimarySID&quot;:&quot;S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-1104&quot;&#125;&#125;, ★誰が (ユーザー contoso\testuser02 であることを特定できます)</span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;\\\\&lt;ストレージ アカウント名&gt;.file.core.windows.net\\shared01\\newtestuser03\\test.txt&quot;,★対象オブジェクト</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;2021/11/22 15:51:37.8846765&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:3,</span><br><span class="line">&quot;operationCount&quot;:0,</span><br><span class="line">&quot;requestHeaderSize&quot;:64,</span><br><span class="line">&quot;requestBodySize&quot;:24,</span><br><span class="line">&quot;responseHeaderSize&quot;:64,</span><br><span class="line">&quot;responseBodySize&quot;:112,</span><br><span class="line">&quot;smbSessionId&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbTreeConnectID&quot;:5,</span><br><span class="line">&quot;smbPersistentHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbVolatileHandleID&quot;:XXXXXXXXXXXXX,</span><br><span class="line">&quot;smbCreditsConsumed&quot;:1,</span><br><span class="line">&quot;smbMessageID&quot;:66,</span><br><span class="line">&quot;smbCommandMajor&quot;:6,</span><br><span class="line">&quot;smbCommandMinor&quot;:&quot;FileCloseAndDelete&quot;,</span><br><span class="line">&quot;smbCommandDetail&quot;:&quot;Detail=Client&quot;,</span><br><span class="line">&quot;smbFileId&quot;:XXXXXXXXXXXXX</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;\\\\aptsstor01.file.core.windows.net\\shared01\\newtestuser03\\test.txt&quot;, ★対象オブジェクト</span><br><span class="line">&quot;protocol&quot;: &quot;SMB&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-NFS-プロトコルの場合"><a href="#2-3-NFS-プロトコルの場合" class="headerlink" title="2-3.NFS プロトコルの場合"></a>2-3.NFS プロトコルの場合</h3><p>NFS プロトコルを使用し Azure Files をマウント後、Azure Files 配下のオブジェクトを操作した際のログとなります。<br>なお、NFS プロトコルでの操作の場合、操作日時、操作内容までの確認はできますが、要求元の IP アドレスや対象オブジェクトの特定は叶いません。</p><p>category: StorageRead</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-19T12:13:43.2858440Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageRead&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Nfs4ReadDir&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;4.1&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 0, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;fde4:XXXX:XXXX:XXXX:XXXX:XXX:XXX:X&quot;, ★誰が (現状特定不可)</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;VNetPolicy&quot;&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;1601/01/01 00:00:00.0000000&quot;,</span><br><span class="line">&quot;operationCount&quot;:2,</span><br><span class="line">&quot;requestHeaderSize&quot;:4,</span><br><span class="line">&quot;requestBodySize&quot;:36,</span><br><span class="line">&quot;responseHeaderSize&quot;:4,</span><br><span class="line">&quot;responseBodySize&quot;:16</span><br><span class="line">&#125;, </span><br><span class="line">&quot;protocol&quot;: &quot;NFS&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category:StorageWrite</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123;</span><br><span class="line">&quot;time&quot;: &quot;2021-11-19T12:13:57.6016724Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageWrite&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;Nfs4Write&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;4.1&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 0, </span><br><span class="line">&quot;durationMs&quot;: 11, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;fde4:XXXX:XXXX:XXXX:XXXX:XXX:XXX:X&quot;, ★誰が (現状特定不可)</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;VNetPolicy&quot;&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;1601/01/01 00:00:00.0000000&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:11,</span><br><span class="line">&quot;operationCount&quot;:2,</span><br><span class="line">&quot;requestHeaderSize&quot;:4,</span><br><span class="line">&quot;requestBodySize&quot;:40,</span><br><span class="line">&quot;responseHeaderSize&quot;:4,</span><br><span class="line">&quot;responseBodySize&quot;:20,</span><br><span class="line">&quot;contentLengthHeader&quot;:5</span><br><span class="line">&#125;, </span><br><span class="line">&quot;protocol&quot;: &quot;NFS&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-HTTPS-プロトコルの場合"><a href="#2-4-HTTPS-プロトコルの場合" class="headerlink" title="2-4.HTTPS プロトコルの場合"></a>2-4.HTTPS プロトコルの場合</h3><p>Azure Portal より Azure Files 配下のオブジェクトを操作した際のログとなります。<br>操作の要求元に関ましてアクセス元の IP アドレスの取得は可能ですが、詳細なユーザー情報の特定までは叶いません。</p><p>category: StorageRead</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">例</span><br><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-25T02:35:57.6382029Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageRead&quot;,★操作内容 </span><br><span class="line">&quot;operationName&quot;: &quot;GetFileServiceProperties&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;2020-06-12&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 200, </span><br><span class="line">&quot;statusText&quot;: &quot;Success&quot;, </span><br><span class="line">&quot;durationMs&quot;: 12, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;10.XX.XX.XX:33801&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: &#123;&quot;type&quot;:&quot;AccountKey&quot;,&quot;tokenHash&quot;:&quot;system-1(XXXXXXXXXXXXXXXXXXXXXXXXXX)&quot;&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;/&lt;ストレージ アカウント名&gt;&quot;,★対象オブジェクト</span><br><span class="line">&quot;serverLatencyMs&quot;:12,</span><br><span class="line">&quot;requestHeaderSize&quot;:338,</span><br><span class="line">&quot;responseHeaderSize&quot;:152,</span><br><span class="line">&quot;responseBodySize&quot;:514,</span><br><span class="line">&quot;tlsVersion&quot;:&quot;TLS 1.2&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;https://&lt;ストレージ アカウント名&gt;.file.core.windows.net/?restype=service&amp;comp=properties&amp;sk=system-1&quot;, </span><br><span class="line">&quot;protocol&quot;: &quot;HTTPS&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category:StorageWrite</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-25T03:50:51.5869028Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageWrite&quot;, ★操作内容</span><br><span class="line">&quot;operationName&quot;: &quot;CreateFile&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;2015-02-21&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 201, </span><br><span class="line">&quot;statusText&quot;: &quot;Success&quot;, </span><br><span class="line">&quot;durationMs&quot;: 18, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;192.XXX.X.XXX:59292&quot;, ★誰が</span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;type&quot;:&quot;SAS&quot;,</span><br><span class="line">&quot;tokenHash&quot;:&quot;key1(XXXXXXXXXXXXXXXXXXXXXX),SasSignature(XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX)&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;userAgentHeader&quot;:&quot;Mozilla/X.X (Windows NT XX.X; Win64; x64) XXXXXXXXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;referrerHeader&quot;:&quot;https://portal.azure.com/&quot;,</span><br><span class="line">&quot;clientRequestId&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;etag&quot;:&quot;\&quot;XXXXXXXXXXXXXXXXXXXXXX\&quot;&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;/&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;lastModifiedTime&quot;:&quot;11/25/2021 3:50:51 AM&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:18,</span><br><span class="line">&quot;requestHeaderSize&quot;:954,</span><br><span class="line">&quot;responseHeaderSize&quot;:330,&quot;tlsVersion&quot;:&quot;TLS 1.2&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;https://&lt;ストレージ アカウント名&gt;.file.core.windows.net/shared01/test.jpg&lt;SAS&gt;&quot;, </span><br><span class="line">&quot;protocol&quot;: &quot;HTTPS&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>category: StorageDelete</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">&quot;time&quot;: &quot;2021-11-25T04:41:44.7852905Z&quot;, ★いつ</span><br><span class="line">&quot;resourceId&quot;: &quot;&lt;リソース ID&gt;&quot;, </span><br><span class="line">&quot;category&quot;: &quot;StorageDelete&quot;,★操作内容 </span><br><span class="line">&quot;operationName&quot;: &quot;DeleteFile&quot;, ★操作内容</span><br><span class="line">&quot;operationVersion&quot;: &quot;2020-02-10&quot;, </span><br><span class="line">&quot;schemaVersion&quot;: &quot;1.0&quot;, </span><br><span class="line">&quot;statusCode&quot;: 202, </span><br><span class="line">&quot;statusText&quot;: &quot;Success&quot;, </span><br><span class="line">&quot;durationMs&quot;: 45, </span><br><span class="line">&quot;callerIpAddress&quot;: &quot;192.XXX.X.XXX:46997&quot;, </span><br><span class="line">&quot;correlationId&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXX&quot;, </span><br><span class="line">&quot;identity&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;type&quot;:&quot;SAS&quot;,</span><br><span class="line">&quot;tokenHash&quot;:&quot;key1(XXXXXXXXXXXXXXXXXXXXXX),SasSignature(XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX)&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;location&quot;: &quot;Japan East&quot;, </span><br><span class="line">&quot;properties&quot;: </span><br><span class="line">&#123;</span><br><span class="line">&quot;accountName&quot;:&quot;&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;userAgentHeader&quot;:&quot;Mozilla/X.X (Windows NT XX.X; Win64; x64) XXXXXXXXXXXXXXXXXXXXXX&quot;,</span><br><span class="line">&quot;serviceType&quot;:&quot;file&quot;,</span><br><span class="line">&quot;objectKey&quot;:&quot;/&lt;ストレージ アカウント名&gt;&quot;,</span><br><span class="line">&quot;serverLatencyMs&quot;:45,</span><br><span class="line">&quot;requestHeaderSize&quot;:705,</span><br><span class="line">&quot;responseHeaderSize&quot;:246,</span><br><span class="line">&quot;tlsVersion&quot;:&quot;TLS 1.2&quot;</span><br><span class="line">&#125;, </span><br><span class="line">&quot;uri&quot;: &quot;https://&lt;ストレージ アカウント名&gt;.file.core.windows.net/shared01/test.jpg&lt;SAS&gt;&quot;, </span><br><span class="line">&quot;protocol&quot;: &quot;HTTPS&quot;, </span><br><span class="line">&quot;resourceType&quot;: &quot;Microsoft.Storage/storageAccounts/fileServices&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="alert is-info"><p class="alert-title">Note</p><p>より詳細なプロパティと説明に関しては、下記公開情報におまとめしておりますので併せてご参照ください。</p><p>-参考：</p><p>リソース ログ</p><p><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-monitoring-reference#resource-logs">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-monitoring-reference#resource-logs</a></p><p>StorageFileLogs</p><p><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/storagefilelogs">https://docs.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/storagefilelogs</a></p></div><hr><p>本稿は以上となりますが、いかがでしたでしょうか。 本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2021/microsoft-azure-tech&quot;&gt;Microsoft Azure Tech Advent Calendar 2021&lt;/a&gt; の 22 日目の記事になります</summary>
      
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>ARMテンプレートでデフォルトのIP構成の名前、IPアドレスを指定の上、NICをデプロイする手順について</title>
    <link href="https://jpaztech.github.io/blog/vm/how-to-deploy-nic-using-arm-template/"/>
    <id>https://jpaztech.github.io/blog/vm/how-to-deploy-nic-using-arm-template/</id>
    <published>2021-12-14T08:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.552Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの イ ソヨンです。</p><p>Azure portal、Azure PowerShell 及び Azure CLI などで NIC を作成いただく場合、デフォルトで IP 構成 [ipconfig1] が自動的に作成されます。デフォルトの IP 構成の名前、IP アドレスを任意の値でご指定いただきたい場合には、ARM テンプレートを利用して NIC を作成いただく必要があります。</p><p>そこで本記事では、ARM テンプレートでデフォルトの IP 構成の名前、IP アドレスを指定の上、NIC をデプロイする手順についてご紹介します。<span id="more"></span><br>ARM テンプレートでリソースを作成する際のご参考としてもお役立ていただけるかと存じますので、ぜひご活用いただけますと幸いです。</p><hr><h2 id="すでに仮想ネットワーク及びパブリックIPアドレスをご作成いただいた場合"><a href="#すでに仮想ネットワーク及びパブリックIPアドレスをご作成いただいた場合" class="headerlink" title="すでに仮想ネットワーク及びパブリックIPアドレスをご作成いただいた場合"></a>すでに仮想ネットワーク及びパブリックIPアドレスをご作成いただいた場合</h2><p>本手順は、すでに仮想ネットワーク及びパブリック IP アドレスをご作成いただいた場合を想定しております。</p><ol><li><p>下記テンプレートの【】に各変数を入力し、NIC 作成の ARM テンプレートを作成します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;,</span><br><span class="line">     &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span><br><span class="line">     &quot;parameters&quot;: &#123;</span><br><span class="line">         &quot;networkInterfaces_【NIC名】_name&quot;: &#123;</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【NIC名】&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;String&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;publicIPAddresses_【public ip address名】_externalid&quot;: &#123;</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【public ip addressパス】&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;String&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;virtualNetworks_【vnet名】_externalid&quot;: &#123;</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【vnetパス】&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;String&quot;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;variables&quot;: &#123;&#125;,</span><br><span class="line">     &quot;resources&quot;: [</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/networkInterfaces&quot;,</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-11-01&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[parameters(&#x27;【NIC名】&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;【リージョン名】&quot;,</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;ipConfigurations&quot;: [</span><br><span class="line">                     &#123;</span><br><span class="line">                         &quot;name&quot;: &quot;【IP構成名】&quot;,</span><br><span class="line">                         &quot;properties&quot;: &#123;</span><br><span class="line">                             &quot;privateIPAddress&quot;: &quot;【public ip address名】&quot;,</span><br><span class="line">                             &quot;privateIPAllocationMethod&quot;: &quot;【プライベート IP アドレスの割り当て[DYNAMIC] (動的) または [STATIC](静的)】&quot;,</span><br><span class="line">                             &quot;publicIPAddress&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[parameters(&#x27;publicIPAddresses_【public ip address名】_externalid&#x27;)]&quot;</span><br><span class="line">                             &#125;,</span><br><span class="line">                             &quot;subnet&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[concat(parameters(&#x27;virtualNetworks_【vnet名】_externalid&#x27;), &#x27;/subnets/default&#x27;)]&quot;</span><br><span class="line">                             &#125;,</span><br><span class="line">                             &quot;primary&quot;: true,</span><br><span class="line">                             &quot;privateIPAddressVersion&quot;: &quot;IPv4&quot;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 ],</span><br><span class="line">                 &quot;dnsSettings&quot;: &#123;</span><br><span class="line">                     &quot;dnsServers&quot;: []</span><br><span class="line">                 &#125;,</span><br><span class="line">                 &quot;enableAcceleratedNetworking&quot;: true,</span><br><span class="line">                 &quot;enableIPForwarding&quot;: false</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ol><p>以下は、仮想ネットワーク [happyxmasvnet] の上に、パブリック IP アドレス [happyxmaspip] を持つネットワークインターフェース [happyxmasnic] を、[japaneast] (東日本) リージョンにご作成いただく場合の ARM テンプレートの作成例になります。<br>以下のテンプレートでは、IP 構成 [happyxmasnipconf] を作成しております。</p>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;,</span><br><span class="line">     &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span><br><span class="line">     &quot;parameters&quot;: &#123;</span><br><span class="line">         &quot;networkInterfaces_happyxmasnic_name&quot;: &#123;</span><br><span class="line">             &quot;defaultValue&quot;: &quot;happyxmasnic&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;String&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;publicIPAddresses_happyxmaspip_externalid&quot;: &#123;</span><br><span class="line">             &quot;defaultValue&quot;: &quot;/subscriptions/*****-*****-*****-*****-**********/resourceGroups/********/providers/Microsoft.Network/publicIPAddresses/happyxmaspip&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;String&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;virtualNetworks_happyxmasvnet_externalid&quot;: &#123;</span><br><span class="line">             &quot;defaultValue&quot;: &quot;/subscriptions/*****-*****-*****-*****-**********/resourceGroups/********/providers/Microsoft.Network/virtualNetworks/happyxmasvnet&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;String&quot;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;variables&quot;: &#123;&#125;,</span><br><span class="line">     &quot;resources&quot;: [</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/networkInterfaces&quot;,</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-11-01&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[parameters(&#x27;networkInterfaces_happyxmasnic_name&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;japaneast&quot;,</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;ipConfigurations&quot;: [</span><br><span class="line">                     &#123;</span><br><span class="line">                         &quot;name&quot;: &quot;happyxmasnipconf&quot;,</span><br><span class="line">                         &quot;properties&quot;: &#123;</span><br><span class="line">                             &quot;privateIPAddress&quot;: &quot;***.***.***.***&quot;,</span><br><span class="line">                             &quot;privateIPAllocationMethod&quot;: &quot;Static&quot;,</span><br><span class="line">                             &quot;publicIPAddress&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[parameters(&#x27;publicIPAddresses_happyxmaspip_externalid&#x27;)]&quot;</span><br><span class="line">                             &#125;,</span><br><span class="line">                             &quot;subnet&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[concat(parameters(&#x27;virtualNetworks_happyxmasvnet_externalid&#x27;), &#x27;/subnets/default&#x27;)]&quot;</span><br><span class="line">                             &#125;,</span><br><span class="line">                             &quot;primary&quot;: true,</span><br><span class="line">                             &quot;privateIPAddressVersion&quot;: &quot;IPv4&quot;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 ],</span><br><span class="line">                 &quot;dnsSettings&quot;: &#123;</span><br><span class="line">                     &quot;dnsServers&quot;: []</span><br><span class="line">                 &#125;,</span><br><span class="line">                 &quot;enableAcceleratedNetworking&quot;: true,</span><br><span class="line">                 &quot;enableIPForwarding&quot;: false</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>Azure Portal から、「カスタムテンプレート」を開き、「エディターで独自のテンプレートを作成する」を押下します。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/01.png"></p></li><li><p>手順 1 で作成した json ファイルを貼り付けて保存します。</p></li><li><p>各パラメータの情報が正しく表示されることを確認し、「確認と作成」を押下します。</p></li><li><p>問題なく NIC が作成されたことを確認します。</p></li><li><p>[IP 構成] のブレードを開き、ご指定の IP 構成が作成されたことを確認します。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/02.png"></p></li></ol><hr><h2 id="NIC-と合わせて仮想ネットワーク及びパブリック-IP-アドレスを合わせて新規作成いただく場合"><a href="#NIC-と合わせて仮想ネットワーク及びパブリック-IP-アドレスを合わせて新規作成いただく場合" class="headerlink" title="NIC と合わせて仮想ネットワーク及びパブリック IP アドレスを合わせて新規作成いただく場合"></a>NIC と合わせて仮想ネットワーク及びパブリック IP アドレスを合わせて新規作成いただく場合</h2><p>NIC と合わせて仮想ネットワーク及びパブリック IP アドレスを新規作成する場合は、quickstart の ARM テンプレートをご活用いただけます。</p><blockquote><p>(参照) Network Interface with Public IP Address<br><a href="https://azure.microsoft.com/ja-jp/resources/templates/nic-publicip-dns-vnet/">https://azure.microsoft.com/ja-jp/resources/templates/nic-publicip-dns-vnet/</a></p></blockquote><ol><li><p>上記公開テンプレートから「Azure へのデプロイ」を押下いただき、「テンプレートの編集」から ARM テンプレートを編集の上、保存します。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/03.png"></p><p>下記テンプレートの【】に各変数を入力し、NIC作成のARMテンプレートを作成します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;,</span><br><span class="line">     &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span><br><span class="line">     &quot;parameters&quot;: &#123;</span><br><span class="line">         &quot;dnsLabelPrefix&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【パブリックIPのDNS名ラベル】&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;DNS Label for the Public IP. Must be lowercase. It should match with the following regular expression: ^[a-z][a-z0-9-]&#123;1,61&#125;[a-z0-9]$ or it will raise an error.&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;vnetAddressPrefix&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【ご希望のvnetのIPアドレス】&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Address Prefix&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;subnetPrefix&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【ご希望のサブネットのIPアドレス】&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Subnet prefix&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;publicIPAddressType&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【パブリック IP アドレスの割り当て[DYNAMIC] (動的) または [STATIC](静的)】&quot;,</span><br><span class="line">             &quot;allowedValues&quot;: [</span><br><span class="line">                 &quot;Dynamic&quot;,</span><br><span class="line">                 &quot;Static&quot;</span><br><span class="line">             ],</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Type of public IP address&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;location&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;【各リソースの位置。リソースグループのロケーションを指定する場合は [resourceGroup().location]】&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Location for all resources.&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;variables&quot;: &#123;</span><br><span class="line">         &quot;virtualNetworkName&quot;: &quot;【ご希望のvnet名】&quot;,</span><br><span class="line">         &quot;publicIPAddressName&quot;: &quot;【ご希望のIPアドレス名】&quot;,</span><br><span class="line">         &quot;subnetName&quot;: &quot;【ご希望のサブネット名】&quot;,</span><br><span class="line">         &quot;nicName&quot;: &quot;【NIC名】&quot;,</span><br><span class="line">         &quot;subnetRef&quot;: &quot;[resourceId(&#x27;Microsoft.Network/virtualNetworks/subnets&#x27;, variables(&#x27;virtualNetworkName&#x27;), variables(&#x27;subnetName&#x27;))]&quot;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;resources&quot;: [</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-05-01&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/publicIPAddresses&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[variables(&#x27;publicIPAddressName&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;[parameters(&#x27;location&#x27;)]&quot;,</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;publicIPAllocationMethod&quot;: &quot;[parameters(&#x27;publicIPAddressType&#x27;)]&quot;,</span><br><span class="line">                 &quot;dnsSettings&quot;: &#123;</span><br><span class="line">                     &quot;domainNameLabel&quot;: &quot;[parameters(&#x27;dnsLabelPrefix&#x27;)]&quot;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-05-01&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/virtualNetworks&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[variables(&#x27;virtualNetworkName&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;[parameters(&#x27;location&#x27;)]&quot;,</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;addressSpace&quot;: &#123;</span><br><span class="line">                     &quot;addressPrefixes&quot;: [</span><br><span class="line">                         &quot;[parameters(&#x27;vnetAddressPrefix&#x27;)]&quot;</span><br><span class="line">                     ]</span><br><span class="line">                 &#125;,</span><br><span class="line">                 &quot;subnets&quot;: [</span><br><span class="line">                     &#123;</span><br><span class="line">                         &quot;name&quot;: &quot;[variables(&#x27;subnetName&#x27;)]&quot;,</span><br><span class="line">                         &quot;properties&quot;: &#123;</span><br><span class="line">                             &quot;addressPrefix&quot;: &quot;[parameters(&#x27;subnetPrefix&#x27;)]&quot;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 ]</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-05-01&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/networkInterfaces&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[variables(&#x27;nicName&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;[parameters(&#x27;location&#x27;)]&quot;,</span><br><span class="line">             &quot;dependsOn&quot;: [</span><br><span class="line">                 &quot;[resourceId(&#x27;Microsoft.Network/virtualNetworks/&#x27;, variables(&#x27;virtualNetworkName&#x27;))]&quot;,</span><br><span class="line">                 &quot;[resourceId(&#x27;Microsoft.Network/publicIPAddresses/&#x27;, variables(&#x27;publicIPAddressName&#x27;))]&quot;</span><br><span class="line">             ],</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;ipConfigurations&quot;: [</span><br><span class="line">                     &#123;</span><br><span class="line">                         &quot;name&quot;: &quot;【IP構成名】&quot;,</span><br><span class="line">                         &quot;properties&quot;: &#123;</span><br><span class="line">                             &quot;publicIPAddress&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[resourceId (&#x27;Microsoft.Network/publicIPAddresses/&#x27;, variables(&#x27;publicIPAddressName&#x27;))]&quot;</span><br><span class="line">                             &#125;,</span><br><span class="line">                             &quot;privateIPAllocationMethod&quot;: &quot;【プライベート IP アドレスの割り当て[DYNAMIC] (動的) または [STATIC](静的)】&quot;,</span><br><span class="line">                             &quot;subnet&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[variables(&#x27;subnetRef&#x27;)]&quot;</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 ]</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下は仮想ネットワーク [merryxmasvnet] の上に、DNS ラベル [merryxmasdnslavel] .(リージョン名).cloudapp.azure.com からのパブリック IP アドレス [merryxmaspip] を持つネットワーク インターフェース [merryxmasnic] を、リソース グループと同リージョンに作成いただく場合の ARM テンプレートの作成例になります。<br>以下のテンプレートでは、IP 構成 [merryxmasnipconf] を作成しております。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;,</span><br><span class="line">     &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span><br><span class="line">     &quot;parameters&quot;: &#123;</span><br><span class="line">         &quot;dnsLabelPrefix&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;merryxmasdnslavel&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;DNS Label for the Public IP. Must be lowercase. It should match with the following regular expression: ^[a-z][a-z0-9-]&#123;1,61&#125;[a-z0-9]$ or it will raise an error.&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;vnetAddressPrefix&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;10.0.0.0/16&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Address Prefix&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;subnetPrefix&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;10.0.0.0/24&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Subnet prefix&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;publicIPAddressType&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;Static&quot;,</span><br><span class="line">             &quot;allowedValues&quot;: [</span><br><span class="line">                 &quot;Dynamic&quot;,</span><br><span class="line">                 &quot;Static&quot;</span><br><span class="line">             ],</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Type of public IP address&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;location&quot;: &#123;</span><br><span class="line">             &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">             &quot;defaultValue&quot;: &quot;[resourceGroup().location]&quot;,</span><br><span class="line">             &quot;metadata&quot;: &#123;</span><br><span class="line">                 &quot;description&quot;: &quot;Location for all resources.&quot;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;variables&quot;: &#123;</span><br><span class="line">         &quot;virtualNetworkName&quot;: &quot;merryxmasvnet&quot;,</span><br><span class="line">         &quot;publicIPAddressName&quot;: &quot;merryxmaspip&quot;,</span><br><span class="line">         &quot;subnetName&quot;: &quot;merryxmassubnet&quot;,</span><br><span class="line">         &quot;nicName&quot;: &quot;merryxmasnic&quot;,</span><br><span class="line">         &quot;subnetRef&quot;: &quot;[resourceId(&#x27;Microsoft.Network/virtualNetworks/subnets&#x27;, variables(&#x27;virtualNetworkName&#x27;), variables(&#x27;subnetName&#x27;))]&quot;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;resources&quot;: [</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-05-01&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/publicIPAddresses&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[variables(&#x27;publicIPAddressName&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;[parameters(&#x27;location&#x27;)]&quot;,</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;publicIPAllocationMethod&quot;: &quot;[parameters(&#x27;publicIPAddressType&#x27;)]&quot;,</span><br><span class="line">                 &quot;dnsSettings&quot;: &#123;</span><br><span class="line">                     &quot;domainNameLabel&quot;: &quot;[parameters(&#x27;dnsLabelPrefix&#x27;)]&quot;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-05-01&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/virtualNetworks&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[variables(&#x27;virtualNetworkName&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;[parameters(&#x27;location&#x27;)]&quot;,</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;addressSpace&quot;: &#123;</span><br><span class="line">                     &quot;addressPrefixes&quot;: [</span><br><span class="line">                         &quot;[parameters(&#x27;vnetAddressPrefix&#x27;)]&quot;</span><br><span class="line">                     ]</span><br><span class="line">                 &#125;,</span><br><span class="line">                 &quot;subnets&quot;: [</span><br><span class="line">                     &#123;</span><br><span class="line">                         &quot;name&quot;: &quot;[variables(&#x27;subnetName&#x27;)]&quot;,</span><br><span class="line">                         &quot;properties&quot;: &#123;</span><br><span class="line">                             &quot;addressPrefix&quot;: &quot;[parameters(&#x27;subnetPrefix&#x27;)]&quot;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 ]</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">             &quot;apiVersion&quot;: &quot;2020-05-01&quot;,</span><br><span class="line">             &quot;type&quot;: &quot;Microsoft.Network/networkInterfaces&quot;,</span><br><span class="line">             &quot;name&quot;: &quot;[variables(&#x27;nicName&#x27;)]&quot;,</span><br><span class="line">             &quot;location&quot;: &quot;[parameters(&#x27;location&#x27;)]&quot;,</span><br><span class="line">             &quot;dependsOn&quot;: [</span><br><span class="line">                 &quot;[resourceId(&#x27;Microsoft.Network/virtualNetworks/&#x27;, variables(&#x27;virtualNetworkName&#x27;))]&quot;,</span><br><span class="line">                 &quot;[resourceId(&#x27;Microsoft.Network/publicIPAddresses/&#x27;, variables(&#x27;publicIPAddressName&#x27;))]&quot;</span><br><span class="line">             ],</span><br><span class="line">             &quot;properties&quot;: &#123;</span><br><span class="line">                 &quot;ipConfigurations&quot;: [</span><br><span class="line">                     &#123;</span><br><span class="line">                         &quot;name&quot;: &quot;merryxmasnipconf&quot;,</span><br><span class="line">                         &quot;properties&quot;: &#123;</span><br><span class="line">                             &quot;publicIPAddress&quot;: &#123;</span><br><span class="line">                             &quot;id&quot;: &quot;[resourceId (&#x27;Microsoft.Network/publicIPAddresses/&#x27;, variables(&#x27;publicIPAddressName&#x27;))]&quot;</span><br><span class="line">                             &#125;,</span><br><span class="line">                             &quot;privateIPAllocationMethod&quot;: &quot;Dynamic&quot;,</span><br><span class="line">                             &quot;subnet&quot;: &#123;</span><br><span class="line">                                 &quot;id&quot;: &quot;[variables(&#x27;subnetRef&#x27;)]&quot;</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 ]</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;       </span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>各パラメータの情報が正しく表示されることを確認し、「確認と作成」を押下します。</p></li><li><p>問題なくNICが作成されたことを確認します。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/04.png"></p></li><li><p>[IP 構成] のブレードを開き、ご指定の IP 構成が作成されたことを確認します。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/05.png"></p></li></ol><hr><h2 id="Azure-Portal-から-ARM-テンプレートのサンプル作る方法"><a href="#Azure-Portal-から-ARM-テンプレートのサンプル作る方法" class="headerlink" title="Azure Portal から ARM テンプレートのサンプル作る方法"></a>Azure Portal から ARM テンプレートのサンプル作る方法</h2><p>Azure Portal にてリソースを作成する前に、ARM テンプレートにエクスポートすると、「0」から作成するより効率的かつ正確な ARM テンプレートを作成いただけます。</p><ol><li><p>Azure Portal の各リソースの作成画面から、各変数を入力いただき、画面右下の「Automation のテンプレートをダウンロードする」を押下します。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/06.png"></p></li><li><p>当該作業に対してARMテンプレートのフォーマットが表示されます。<br>編集済みのテンプレートは「保存」し、今後同作業を実施する際の ARM テンプレートとして活用いただけます。<br>尚、「ライブラリに追加　(プレビュー)」を押下し、Azure のテンプレート　ライブラリへ保存することも可能です。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/07.png"></p></li><li><p>Azure のテンプレート ライブラリへ保存した ARM テンプレートは、Azure Portal の「テンプレート」へ保存され、<br>いつでも簡単に編集・デプロイいただけます。</p><p><img src="/blog/vm/how-to-deploy-nic-using-arm-template/08.png"></p><blockquote><p>(参考) ポータルを使用したテンプレートの生成<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/templates/quickstart-create-templates-use-the-portal#generate-a-template-using-the-portal">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/templates/quickstart-create-templates-use-the-portal#generate-a-template-using-the-portal</a></p></blockquote></li></ol><p>本記事は以上となりますが、いかがでしたでしょうか。<br>本記事の内容が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの イ ソヨンです。&lt;/p&gt;
&lt;p&gt;Azure portal、Azure PowerShell 及び Azure CLI などで NIC を作成いただく場合、デフォルトで IP 構成 [ipconfig1] が自動的に作成されます。デフォルトの IP 構成の名前、IP アドレスを任意の値でご指定いただきたい場合には、ARM テンプレートを利用して NIC を作成いただく必要があります。&lt;/p&gt;
&lt;p&gt;そこで本記事では、ARM テンプレートでデフォルトの IP 構成の名前、IP アドレスを指定の上、NIC をデプロイする手順についてご紹介します。</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="ARM Template" scheme="https://jpaztech.github.io/blog/tags/ARM-Template/"/>
    
  </entry>
  
  <entry>
    <title>【図解】ストレージ アカウントにおける冗長性の種類について</title>
    <link href="https://jpaztech.github.io/blog/storage/introduction-of-azure-storage-redundancy/"/>
    <id>https://jpaztech.github.io/blog/storage/introduction-of-azure-storage-redundancy/</id>
    <published>2021-12-10T08:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.408Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>Azure Storage では、4 つのデータ サービスが提供されており、日々多くのお客様にご利用いただいています。<br>各データ サービスにはストレージ アカウントを通じてアクセスするため、お客様にてご要件に併せたストレージ アカウントの種類や冗長性 (データのレプリケート方法) の種類を選択いただく必要があります。</p><p>本記事では、Azure Storage として提供している 4 つのデータ サービスやストレージ アカウントの概要について説明した上で、レプリケートされたデータがどのように配置されているのかを図を用いてご紹介します。</p><span id="more"></span><hr><h2 id="Azure-Storage-と-4-つのデータ-サービス"><a href="#Azure-Storage-と-4-つのデータ-サービス" class="headerlink" title="Azure Storage と 4 つのデータ サービス"></a>Azure Storage と 4 つのデータ サービス</h2><p>Azure では、お客様のデータを Azure 上に格納するために提供されている方法のうち、4 つのデータ サービス (Azure BLOB、Azure Files、Azure キュー、Azure テーブル) を Azure Storage という名前で呼んでいます。<br>各データ サービスの詳細につきましては、以下の公開情報に記載がありますのでご確認ください。</p><blockquote><p>ご参考) コア Azure Storage サービスの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction</a></p><blockquote><ul><li><strong><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction#blob-storage">Azure BLOB</a></strong>:<br>テキストおよびバイナリ データのための高度にスケーラブルなオブジェクト ストア。<ul><li><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-block-blobs">ブロック BLOB</a>:<br>大量のデータを効率的にアップロードするための最適化されています。</li><li><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs">追加 BLOB</a>:<br>ブロックで構成され、追加操作用に最適化されています。</li><li><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-page-blobs">ページ BLOB</a>:<br>ランダムな読み取りと書き込みの操作用に最適化されています。</li></ul></li><li><strong><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction#azure-files">Azure Files</a></strong>:<br>クラウドまたはオンプレミスのデプロイ用のマネージド ファイル共有。<br>1 つの　Azure ファイル共有に対して、SMB と NFS の両方のプロトコルを使用したアクセスはサポートされませんが、同じストレージ アカウント内に SMB と NFS のファイル共有を作成することは可能です。<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/files-smb-protocol?tabs=azure-portal">SMB ファイル共有</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/files-nfs-protocol">NFS ファイル共有</a></li></ul></li><li><strong><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction#queue-storage">Azure キュー</a></strong>:<br>アプリケーション コンポーネント間の信頼性の高いメッセージングのためのメッセージング ストア。</li><li><strong><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction#table-storage">Azure テーブル</a></strong>:<br>構造化データのスキーマレス ストレージのための NoSQL ストア。</li></ul></blockquote></blockquote><p>公開情報にて、コア Azure Storage サービスとして、Azure ディスクが記載されております。<br>これは、Azure 管理ディスクの実態が、仮想ハード ディスク (VHD ファイル) であり、Microsoft で管理しているストレージ アカウント上にページ BLOB (Azure BLOB で利用できる 3 種類の BLOB の 1 つ) として格納されているためになります。</p><blockquote><blockquote><ul><li><strong><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-introduction#disk-storage">Azure ディスク</a></strong>:<br>Azure VM のためのブロック レベルのストレージ ボリューム。</li></ul></blockquote></blockquote><hr><h2 id="ストレージ-アカウントとは"><a href="#ストレージ-アカウントとは" class="headerlink" title="ストレージ アカウントとは"></a>ストレージ アカウントとは</h2><p>ストレージ アカウントとは、グローバルな一意な名前をもって、Azure Storage データ オブジェクト (BLOB、ファイル、キュー、テーブル) をグループ化するためのコンテナー (論理的な区画) です。<br>ストレージ アカウント内のデータには、 HTTP または HTTPS 経由などでアクセスすることが可能です。</p><p>Azure Storage データ オブジェクトは、ストレージ アカウント作成時にご指定いただいたリージョンのデータセンター内の物理サーバー群 (ストレージ クラスターまたはスタンプと呼びます) に格納されております。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/01.png"></p><hr><h2 id="ストレージ-アカウントの種類"><a href="#ストレージ-アカウントの種類" class="headerlink" title="ストレージ アカウントの種類"></a>ストレージ アカウントの種類</h2><p>ストレージ アカウントには、パフォーマンスや用途によって複数の種類があります。<br>※ 本記事では、クラシック環境のストレージ アカウントおよび ARM 環境のレガシ ストレージ アカウントについては扱いません。</p><blockquote><p>ご参考) ストレージ アカウントの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-account-overview">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-account-overview</a></p><blockquote><ul><li><strong>Standard 汎用 v2</strong><br>BLOB、ファイル共有、キュー、テーブル用の Standard タイプのストレージ アカウント。<br>Azure Storage を使用するほとんどのシナリオにお勧めします。</li><li><strong>Premium ブロック BLOB</strong><br>ブロック BLOB と追加 BLOB 用の Premium タイプのストレージ アカウント。<br>トランザクション レートが高く、比較的小さなオブジェクトが使用されるシナリオ、またはストレージ待ち時間が一貫して短いことが要求されるシナリオに推奨されます。</li><li><strong>Premium ファイル共有</strong><br>ファイル共有専用の Premium タイプのストレージ アカウント。<br>エンタープライズまたはハイ パフォーマンス スケール アプリケーションにお勧めします。<br>SMB ファイル共有と NFS ファイル共有の両方をサポートするストレージアカウントが必要な場合は、このタイプのアカウントを使用します。</li><li><strong>Premium ページ BLOB</strong><br>ページ BLOB に特化した Premium Storage アカウントの種類。</li></ul></blockquote></blockquote><p>各ストレージ アカウントの種類にてサポートされている Azure Storage のデータサービスは、下記の通りとなります。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/02.png"></p><hr><h2 id="冗長性-データのレプリケート方法-の種類と各データ-サービスのご利用可否"><a href="#冗長性-データのレプリケート方法-の種類と各データ-サービスのご利用可否" class="headerlink" title="冗長性 (データのレプリケート方法) の種類と各データ サービスのご利用可否"></a>冗長性 (データのレプリケート方法) の種類と各データ サービスのご利用可否</h2><p>Azure Storage では、ユーザー データを Azure 基盤側の計画されたイベント (メンテナンス) / 計画外のイベント (一時的なハードウェア障害、ネットワークの障害、災害など) から保護するため、常に複数 (構成によっては 3 つ以上) のコピーを実施しています。</p><p>データのレプリケート方法としては、LRS、ZRS、GRS、GZRS の 4 種類と GRS、GZRS のセカンダリ リージョンへ読み取りアクセスが可能となった RA-GRS、RA-GZRS の計 6 種類があります。</p><blockquote><p>ご参考) Azure Storage の冗長性<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#supported-azure-storage-services">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#supported-azure-storage-services</a></p></blockquote><p>それぞれについて説明します。</p><hr><h3 id="ローカル冗長ストレージ-LRS"><a href="#ローカル冗長ストレージ-LRS" class="headerlink" title="ローカル冗長ストレージ (LRS)"></a>ローカル冗長ストレージ (LRS)</h3><p>LRS は、ストレージ アカウントを作成したリージョンの単一のデータ センター内で、データを同期的に 3 回複製します。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/03.png"></p><p>最も安価なレプリケーション オプションですが、データセンター単位の障害が発生した場合には、回復不能となるリスクがあり、高可用性を必要とするアプリケーションには推奨されません。</p><blockquote><p>ご参考) ローカル冗長ストレージ<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#locally-redundant-storage">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#locally-redundant-storage</a></p></blockquote><p>なお、LRS で利用可能な Azure Storage データ サービスは以下の通りです。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/12.png"></p><hr><h3 id="ゾーン冗長ストレージ-ZRS"><a href="#ゾーン冗長ストレージ-ZRS" class="headerlink" title="ゾーン冗長ストレージ (ZRS)"></a>ゾーン冗長ストレージ (ZRS)</h3><p>ZRS は、可用性ゾーン対応リージョンでご利用いただけるレプリケーション オプションであり、ストレージ アカウントを作成したリージョンの 3 つの Azure 可用性ゾーン間で、データを同期的に複製します。</p><p>可用性ゾーン対応リージョンの場合では、それぞれ異なる電源・ネットワーク・冷却装置を持つ物理的に分離された場所を 3 つに分け、複数のゾーンにデータをレプリケートすることで、ゾーン単位の障害が発生した場合でも別のゾーンからデータが利用できることを実現しています。</p><blockquote><p>ご参考) リージョンと可用性ゾーン<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/az-overview?context=/azure/virtual-machines/context/context">https://docs.microsoft.com/ja-jp/azure/availability-zones/az-overview?context=/azure/virtual-machines/context/context</a></p></blockquote><p>ZRS では、ゾーンごとにデータがレプリケートされているため、データセンター単位の障害やゾーン単位の障害が発生した場合でも、影響を受けていないゾーンに保管されているデータにアクセスすることが可能となります。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/04.png"></p><p>リージョン単位の障害が発生した場合には回復不能となるリスクがあるため、さらに高可用性を必要とするアプリケーションをご利用の場合には、セカンダリ リージョンにもデータをレプリケートする Geo 冗長をご検討ください。</p><blockquote><p>ご参考) ゾーン冗長ストレージ<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#zone-redundant-storage">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#zone-redundant-storage</a></p></blockquote><p>なお、ZRS で利用可能な Azure Storage データ サービスは以下の通りです。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/13.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><strong>コラム：ゾーンごとにデータがレプリケートされている場合はどこにアクセスしているのか</strong></p><p>　</p><p>ストレージ アカウント名は DNS ホスト名の一部となっており、エンドポイント (<strong>&lt;ストレージ アカウント名&gt;.&lt;サービス&gt;.core.windows.net</strong>) をご指定いただくことで、DNS 経由でデータが保存されている場所にアクセスします。</p><p>ZRS をご利用の場合、データはゾーンごとに複製されておりますため、ストレージ アカウントのエンドポイントは 3 つの IP アドレスに紐づけられています。</p><p>　</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/09.png"></p><p>　</p><p>ZRS の保管されているデータに書き込みを行った場合には、リクエストを投げた際に一番応答の早いゾーンの IP アドレスに解決が行われ、そのゾーンに保存されているデータに対して書き込み操作が実施されます。</p><p>残りのゾーンについては、バックエンドで書き込み操作を実施した変更が同期されます。</p><p>　</p><p>ゾーンが使用できなくなった場合には、Azure 側で DNS の再指定などのネットワークの更新が実施されますので、お客様における切り替え作業は発生いたしません。</p><p>　</p><p>なお、ストレージ アカウントに紐づく IP アドレスを固定化することは叶いませんので、ストレージ アカウント内のデータにアクセスする際はエンドポイントとして提供されている <strong>&lt;ストレージ アカウント名&gt;.&lt;サービス&gt;.core.windows.net</strong> をご利用ください。</p></div><hr><h3 id="Geo-冗長ストレージ-GRS"><a href="#Geo-冗長ストレージ-GRS" class="headerlink" title="Geo 冗長ストレージ (GRS)"></a>Geo 冗長ストレージ (GRS)</h3><p>Geo 冗長は、プライマリ リージョンのデータをセカンダリ リージョンにもレプリケートする構成です。<br>セカンダリ リージョンは、プライマリ リージョンのペア リージョンになります。</p><blockquote><p>ご参考) すべての地域の Azure リージョン間レプリケーションのペアリング<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure#azure-cross-region-replication-pairings-for-all-geographies">https://docs.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure#azure-cross-region-replication-pairings-for-all-geographies</a></p></blockquote><p>GRS は、プライマリ リージョンで LRS を使用してデータを同期的に 3 回複製した後、データをセカンダリ リージョンに非同期的に複製します。セカンダリ リージョンでは LRS を利用して、単一のデータ センター内でデータを同期的に 3 回複製します。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/05.png"></p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/10.png"></p><blockquote><p>ご参考) geo 冗長ストレージ<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy?toc=/azure/storage/blobs/toc.json#geo-redundant-storage">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy?toc=/azure/storage/blobs/toc.json#geo-redundant-storage</a></p></blockquote><div class="alert is-warning"><p class="alert-title">警告</p><p>非同期の複製に関して、プライマリ リージョンに障害が発生した場合にも、最新の変更がセカンダリ リージョンに同期できておらず、最新の変更分に関してはデータが失われる可能性があります。</p><p>非同期的に行う複製の間隔 (回復ポイントの目標 / RPO) に関する SLA はありませんが、Azure Storage における RPO 目安としては 15 分未満となります。</p></div><p>なお、GRS で利用可能な Azure Storage データ サービスは以下の通りです。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/14.png"></p><hr><h3 id="geo-ゾーン冗長ストレージ-GZRS"><a href="#geo-ゾーン冗長ストレージ-GZRS" class="headerlink" title="geo ゾーン冗長ストレージ (GZRS)"></a>geo ゾーン冗長ストレージ (GZRS)</h3><p>GZRS は、プライマリ リージョンで ZRS を使用してデータを同期的に 3 回複製した後、データをセカンダリ リージョンに非同期的に複製します。セカンダリ リージョンでは LRS を利用して、単一のデータ センター内でデータを同期的に 3 回複製します。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/06.png"></p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/11.png"></p><blockquote><p>ご参考) geo ゾーン冗長ストレージ<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy?toc=/azure/storage/blobs/toc.json#geo-zone-redundant-storage">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-redundancy?toc=/azure/storage/blobs/toc.json#geo-zone-redundant-storage</a></p></blockquote><p>なお、GRS で利用可能な Azure Storage データ サービスは以下の通りです。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/15.png"></p><hr><h3 id="GRS、GZRS-と-RA-GRS、RA-GZRS-の違い"><a href="#GRS、GZRS-と-RA-GRS、RA-GZRS-の違い" class="headerlink" title="GRS、GZRS と RA-GRS、RA-GZRS の違い"></a>GRS、GZRS と RA-GRS、RA-GZRS の違い</h3><p>GRS、GZRS と RA-GRS、RA-GZRS の違いは、セカンダリ リージョンのデータへのアクセス状況です。<br>それぞれについて説明します。</p><p>なお、RA-GRS および RA-GZRS で利用可能な Azure Storage データ サービスは以下の通りです。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/16.png"></p><h4 id="GRS、GZRS"><a href="#GRS、GZRS" class="headerlink" title="GRS、GZRS"></a>GRS、GZRS</h4><p>GRS、GZRS の場合は、エンドポイントによって、プライマリ リージョンのデータへの読み取り/書き込みが実施できます。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/07.png"></p><p>セカンダリ リージョン上のデータについては、フェールオーバーによってエンドポイントに関連付いている IP アドレスが切り替わることで、アクセスが可能になります。<br>フェールオーバー中はプライマリ リージョンでの読み取り/書き込みアクセスができなくなり、フェールオーバー完了後に新しいプライマリ リージョン (元セカンダリ リージョン) にて読み取り/書き込みが実施できるようになります。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/17.png"></p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/19.png"></p><h4 id="RA-GRS、RA-GZRS"><a href="#RA-GRS、RA-GZRS" class="headerlink" title="RA-GRS、RA-GZRS"></a>RA-GRS、RA-GZRS</h4><p>RA-GRS、RA-GZRS では、プライマリ リージョンのデータへの読み取り/書き込みとセカンダリ リージョンのデータに対して読み取りが実施できます。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/08.png"></p><p>フェールオーバーを実施した場合、フェールオーバー中はプライマリ リージョンでの読み取り/書き込みアクセスができなくなりますが、セカンダリ リージョンの読み取りアクセスは継続してご利用いただけることが想定されています。<br>フェールオーバー完了後には、新しいプライマリ リージョン (元セカンダリ リージョン) にて読み取り/書き込みが実施できるようになります。</p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/18.png"></p><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/19.png"></p><hr><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事でご紹介した内容のまとめは、以下の通りです。</p><h3 id="冗長性-データのレプリケート方法-の種類"><a href="#冗長性-データのレプリケート方法-の種類" class="headerlink" title="冗長性 (データのレプリケート方法) の種類"></a>冗長性 (データのレプリケート方法) の種類</h3><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/21.png"></p><h3 id="ストレージ-アカウントの種類およびレプリケーションの種類に対するデータ-サービスのサポート状況"><a href="#ストレージ-アカウントの種類およびレプリケーションの種類に対するデータ-サービスのサポート状況" class="headerlink" title="ストレージ アカウントの種類およびレプリケーションの種類に対するデータ サービスのサポート状況"></a>ストレージ アカウントの種類およびレプリケーションの種類に対するデータ サービスのサポート状況</h3><p><img src="/blog/storage/introduction-of-azure-storage-redundancy/20.png"></p><p>本記事の内容が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;Azure Storage では、4 つのデータ サービスが提供されており、日々多くのお客様にご利用いただいています。&lt;br&gt;各データ サービスにはストレージ アカウントを通じてアクセスするため、お客様にてご要件に併せたストレージ アカウントの種類や冗長性 (データのレプリケート方法) の種類を選択いただく必要があります。&lt;/p&gt;
&lt;p&gt;本記事では、Azure Storage として提供している 4 つのデータ サービスやストレージ アカウントの概要について説明した上で、レプリケートされたデータがどのように配置されているのかを図を用いてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>お問い合わせ発行時と「異なる」サブスクリプションならびに AAD テナントの調査依頼に対してのセキュリティ チェックが強化されます</title>
    <link href="https://jpaztech.github.io/blog/information/Different-subscriptions-research/"/>
    <id>https://jpaztech.github.io/blog/information/Different-subscriptions-research/</id>
    <published>2021-11-26T03:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.352Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームです。</p><p>2021 年 12 月より、Azure ポータルから「サブスクリプション A」でお問い合わせを起票し、お問い合わせ初期あるいは途中に「サブスクリプション B」のリソースの調査を依頼されるケースにおいて、「サブスクリプション B」 側のアクセス権の有無のチェックの徹底が行われます。アクセス権を持たない場合には例外無くお問い合わせ対応を中座させていただくこととなります。<br>このため、適切なサポート リクエスト発行のための権限の付与がされたアカウントから、正しいサブスクリプションとリソース名を選択してお問い合わせを起票いただきますようお願いします。<br><br>※ Azure Active Directory (AAD) に関しても同様で、正しい AAD テナントからのお問い合わせの発行をお願いいたします。</p><p>後述の詳細では、この背景ならびに設定方法、また例外的なシナリオについてご説明します。</p><h2 id="詳細"><a href="#詳細" class="headerlink" title="[詳細]"></a>[詳細]</h2><p>マイクロソフトのクラウド プラットフォームではお客様の情報保護を最優先に運営しております。<br>サポートにおいても GDPR などの各国・地域におけるセキュリティ要件に準拠し、サポート担当者や使用ツールなどのセキュリティ ホールが無いようにつとめています。<br>Azure サポートにおいても原則として、影響があったサブスクリプションから、適切な権限を持つユーザーからのお問い合わせのみを受け付けるというポリシーとなっています。</p><p>Azure サポート要求を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request">https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request</a></p><blockquote><p>Azure ロールベースのアクセス制御<br>サポート リクエストを作成するには、<a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#owner">所有者</a>か、<a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#contributor">共同作成者</a>か、またはサブスクリプション レベルで<a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#support-request-contributor">サポート リクエスト共同作成者</a>ロールが割り当てられている必要があります。<br>Azure Active Directory シナリオなどのサブスクリプションを使用せずにサポート リクエストを作成するには、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/roles/permissions-reference">管理者</a>である必要があります。</p></blockquote><p>本ポリシーは数年来存在しており、原則としてこのポリシーに従って運用を行ってまいりましたが、<br>これまで、例外的に、ユーザーからの権限を有する証跡などの提示などがなされた場合に対応が許容されるケースが存在しました。<br>一方で、<a href="https://blogs.microsoft.com/on-the-issues/2021/10/24/new-activity-from-russian-actor-nobelium/">昨今の大規模なサイバー攻撃</a>に代表される、顧客情報漏洩のリスクが日々高まる状況となっています。<br>上記ポリシーをあらためてシステマチックに実装し、徹底することで、サポート経由でのソーシャル ハッキング、あるいはサポート担当者のクレデンシャル漏洩時のサポート ツールの悪用によるリスクを回避します。</p><p>上記 URL に記載のとおり、Azure サポートをご利用いただくお客様には、適切な権限 (サブスクリプション レベルにて “所有者”、”共同作成者”、ないしは “サポート リクエスト共同作成者”) を設定の上、適切なサブスクリプションとリソース名を選択してお問い合わせください。</p><h2 id="異なるサブスクリプションの調査の必要性が発生するシナリオの例"><a href="#異なるサブスクリプションの調査の必要性が発生するシナリオの例" class="headerlink" title="[異なるサブスクリプションの調査の必要性が発生するシナリオの例]"></a>[異なるサブスクリプションの調査の必要性が発生するシナリオの例]</h2><p>ご用件によって、異なるサブスクリプションの調査が必要となるシナリオが存在します。<br>一例として、同じ問題ではあるが、複数のサブスクリプションの参照が求められるトラブルシュートが発生する場合が挙げられます。<br>例えば、「サブスクリプション A」上の VM と「サブスクリプション B」上の VM の間での接続不良が発生し、両方の調査が求められるという状況です。<br>この場合、1 件で異なるサブスクリプションの調査が行える場合がございますが、その際には必ず、異なるサブスクリプション側にも、お問い合わせ起票者と同じユーザー アカウントが、”所有者”、”共同作成者”、ないしは “サポート リクエスト共同作成者”として設定されている必要があります。</p><p>※この設定がない場合、解析を行うツール側でのセキュリティ チェックが行えないため、調査が行えません。<br>そのような場合、以下のワークアラウンドにご協力ください。</p><h2 id="異なるサブスクリプションについて調査が必要な場合のワークアラウンド"><a href="#異なるサブスクリプションについて調査が必要な場合のワークアラウンド" class="headerlink" title="[異なるサブスクリプションについて調査が必要な場合のワークアラウンド]"></a>[異なるサブスクリプションについて調査が必要な場合のワークアラウンド]</h2><p>サブスクリプション A、サブスクリプション B それぞれから、合計 2 件のお問い合わせを起票してください。後から起票したサブスクリプションには、先に起票したお問い合わせ番号を記入してください。サポート担当者より、2件が関連していることを把握し、スムースに対応させていただきます。<br>サブスクリプション A、サブスクリプション B の管理者が異なる場合も、連携して調査行うことが可能ですが、必ず後からお問い合わせを起票した側のサブスクリプション側では、「先に発行したお問い合わせ番号」と、「情報開示・連携を行ってもよい」という一言を併記ください。</p><h2 id="補足-CSP-サブスクリプションでの問い合わせについて"><a href="#補足-CSP-サブスクリプションでの問い合わせについて" class="headerlink" title="[補足: CSP サブスクリプションでの問い合わせについて]"></a>[補足: CSP サブスクリプションでの問い合わせについて]</h2><p>CSP パートナーは、CSP エンド ユーザー サブスクリプションの環境で発生した問題についてファースト ラインのサポートを提供し、解決が難しい場合にマイクロソフトにお問い合わせをいただくこととなります。<br>この際も、必ず、問題が発生した CSP エンド ユーザー サブスクリプションからお問い合わせを発行してください。<br>なお、この際には CSP パートナーとして、CSP エンド ユーザー サブスクリプションに対しての代理管理者 (AOBO = Admin On Behalf Of) の権限を有し、環境にアクセスできる状態としていただく必要があります。<br>適切なアクセス権を有しないお客様において、無関係なサブスクリプションからお問い合わせを起票し、サポート担当者に対して調査対象サブスクリプションを要請される場合がございますが、前述のセキュリティ上の制限に抵触する場合には調査続行が不可能なため、対応を中座させていただくこととなります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームです。&lt;/p&gt;
&lt;p&gt;2021 年 12 月より、Azure ポータルから「サブスクリプション A」でお問い合わせを起票し、お問い合わせ初期あるいは途中に「サブスクリプション B」のリソースの調査を依頼されるケースにおいて、「サブスク</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>電話経由における Azure サブスクリプションの調査のセキュリティ チェックが厳格化されます</title>
    <link href="https://jpaztech.github.io/blog/information/Security-check-stricter/"/>
    <id>https://jpaztech.github.io/blog/information/Security-check-stricter/</id>
    <published>2021-11-26T03:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.352Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームです。</p><p>12/8 (水) より、Premier サポートなどの電話経由におけるお問い合わせ発行の際、Azure サブスクリプション上のリソースに対して調査を行う必要がある場合、セキュリティ チェックが厳格化されます。<br>※リソースに依存しない、一般的な Q&amp;A の内容の場合には無関係です。</p><p>電話経由でサポート リクエストの起票を行う場合には、お問い合わせ起票の際にご連絡いただくメール アドレス (＝ ユーザー アカウント) が、調査対象となるサブスクリプションの所有者か、共同作成者か、またはサブスクリプション レベルでサポート リクエスト共同作成者ロールに割り当てられている必要があります。<br><span style="color: red; ">※この権限を有さない場合、調査が困難となりますので、対応を中座し適切な権限を持つユーザーからのお問い合わせの再起票をお願いすることとなります。</span></p><p>なお、Azure サポートにおいては、可能な限り Azure ポータル経由でのお問い合わせを推奨します。<br>電話経由でのサポートは、Azure ポータルに何らかの理由でアクセスできない場合に備え残っておりますが、効率性は低い方法となります。  電話の場合、お問い合わせ起票の後のサポート担当者の決定後、サブスクリプション ID や影響のあったリソース名のヒアリングが行われた後に調査となります。<br>Azure ポータルの場合、サブスクリプション ID とリソース名があらかじめ指定いただける上、サポートで用いる自動解析ツールが事前に実行されるなど内部的な効率化も図られていることから、Azure ポータルのほうがより効果的な解決を行えるものとなります。</p><h2 id="詳細"><a href="#詳細" class="headerlink" title="[詳細]"></a>[詳細]</h2><p>マイクロソフトのクラウド プラットフォームではお客様の情報保護を最優先に運営しております。<br>サポートにおいても GDPR などの各国・地域におけるセキュリティ要件に準拠し、サポート担当者や使用ツールなどのセキュリティ ホールが無いようにつとめています。Azure サポートにおいても原則として、影響があったサブスクリプションから、適切な権限を持つユーザーからのお問い合わせのみを受け付けるというポリシーとなっています。</p><p>Azure サポート要求を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request">https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request</a></p><blockquote><p>Azure ロールベースのアクセス制御<br>サポート リクエストを作成するには、所有者か、共同作成者か、またはサブスクリプション レベルでサポート リクエスト共同作成者ロールが割り当てられている必要があります。<br>Azure Active Directory シナリオなどのサブスクリプションを使用せずにサポート リクエストを作成するには、管理者である必要があります。</p></blockquote><p>本ポリシーは数年来存在しており、原則としてこのポリシーに従って運用を行ってまいりましたが、これまで、例外的に、ユーザーからの権限を有する証跡などの提示などがなされた場合に対応が許容されるケースが存在しました。<br>一方で、昨今の大規模なサイバー攻撃に代表される、顧客情報漏洩のリスクが日々高まる状況となっています。<br>上記ポリシーをあらためてシステマチックに実装し、徹底することで、サポート経由でのソーシャル ハッキング、あるいはサポート担当者のクレデンシャル漏洩時のサポート ツールの悪用によるリスクを回避します。</p><p>Premier サポートによる電話起票においては、上記のようなシステム的なセキュリティ チェックが行えない関係上、一部のサポート シナリオにおける調査方法が制限される場合があるため、Azure ポータルからの起票を推奨します。<br>また、電話起票の場合にも、必ずお問い合わせ起票者のユーザー アカウント = お問い合わせ時に指定いただく E-mail アドレス にて、対象サブスクリプションの調査権限を設定いただいていることをご確認ください。電話でのお問い合わせ起票後の担当者変更によるセキュリティの再チェックは行えません。<br>(例: ユーザー A が電話にてお問い合わせを起票したが、対象サブスクリプションに調査権限が無い場合に、あとから口頭あるいはメールなどにて適切な権限を持つユーザー B を紹介いただくケース。この場合も調査続行は行えませんので、正しいアクセス権を持つユーザー B からお問い合わせを発行してください。)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームです。&lt;/p&gt;
&lt;p&gt;12/8 (水) より、Premier サポートなどの電話経由におけるお問い合わせ発行の際、Azure サブスクリプション上のリソースに対して調査を行う必要がある場合、セキュリティ チェックが厳格化されます。&lt;b</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>サブスクリプション ID とリソース ID の確認について</title>
    <link href="https://jpaztech.github.io/blog/information/Subscription-ID-verification/"/>
    <id>https://jpaztech.github.io/blog/information/Subscription-ID-verification/</id>
    <published>2021-11-26T03:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.352Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームです。</p><p>お客様から日々お問い合わせ頂いている内容について、正確に調査や状況確認を行うために、我々サポートエンジニアからお客様にリソース情報 (サブスクリプション ID 、リソース ID) をお伺いすることがあります。<br>本トピックでは、このサブスクリプション ID とリソース ID の確認方法についてご紹介いたします。</p><h2 id="サブスクリプション-ID-とは"><a href="#サブスクリプション-ID-とは" class="headerlink" title="サブスクリプション ID とは"></a>サブスクリプション ID とは</h2><p>Microsoft Azure をご利用頂く際に、お客様と日本マイクロソフト株式会社は、無償または有償のサブスクリプション契約 (無料評価版、従量課金プラン等) を結びます。<br>お客様が締結したこのサブスクリプション契約を一意のものとして識別するために、マイクロソフトでは 32 桁の GUID を付与しています。この GUID がサブスクリプション ID で以下のフォーマットで表記されます。</p><p>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</p><h2 id="サブスクリプション名とサブスクリプション-ID-の確認方法について"><a href="#サブスクリプション名とサブスクリプション-ID-の確認方法について" class="headerlink" title="サブスクリプション名とサブスクリプション ID の確認方法について"></a>サブスクリプション名とサブスクリプション ID の確認方法について</h2><p>以下では、Azure Portal からサブスクリプション名とサブスクリプション ID 確認する方法についてご案内いたします。</p><ol><li><p>Azure ポータルにサインインします。</p></li><li><p>Azure Poral ホーム画面上部の検索バーから [サブスクリプション] と検索 / Azure Portal ホーム画面下部の移動から [サブスクリプション]をクリックします。</p></li></ol><p><img src="/blog/information/Subscription-ID-verification/01.png"></p><ol start="3"><li><p>表示されたサブスクリプション一覧から、該当のサブスクリプションを選択しクリックします。<br><img src="/blog/information/Subscription-ID-verification/02.png"></p></li><li><p>画面上部にサブスクリプション名とサブスクリプション ID が表示されます。</p></li><li><p>カーソルを合わせると[クリップボードにコピー]が表示されます。</p></li></ol><p><img src="/blog/information/Subscription-ID-verification/03.png"></p><h3 id="特定のリソースからサブスクリプション名とサブスクリプション-ID-を確認する"><a href="#特定のリソースからサブスクリプション名とサブスクリプション-ID-を確認する" class="headerlink" title="特定のリソースからサブスクリプション名とサブスクリプション ID を確認する"></a>特定のリソースからサブスクリプション名とサブスクリプション ID を確認する</h3><p>特定のリソースからサブスクリプション名とサブスクリプション ID を確認するためには、リソースの概要画面上部から確認できます。<br><img src="/blog/information/Subscription-ID-verification/04.png"></p><h2 id="リソース-ID-とは"><a href="#リソース-ID-とは" class="headerlink" title="リソース ID とは"></a>リソース ID とは</h2><p>Azure のリソース ID とは Azure Resource Manager におけるリソースの一意な識別子を示しており、以下のフォーマットで表記されます。<br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderName}/ {resourceType}/{resourceName}</p><h2 id="リソース-ID-の確認方法について"><a href="#リソース-ID-の確認方法について" class="headerlink" title="リソース ID の確認方法について"></a>リソース ID の確認方法について</h2><ol><li><p>調査対象のリソースの概要画面の右部の [JSON ビュー] をクリックします。 (例では Azure VM を示す。)<br><img src="/blog/information/Subscription-ID-verification/05.png"></p></li><li><p>JSON ビュー上部にリソース ID が表示されます。</p></li><li><p>カーソルを合わせると[クリップボードにコピー]が表示されます。<br><img src="/blog/information/Subscription-ID-verification/06.png"></p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームです。&lt;/p&gt;
&lt;p&gt;お客様から日々お問い合わせ頂いている内容について、正確に調査や状況確認を行うために、我々サポートエンジニアからお客様にリソース情報 (サブスクリプション ID 、リソース ID) をお伺いすることがあります。&lt;b</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
    <category term="Azure Portal" scheme="https://jpaztech.github.io/blog/tags/Azure-Portal/"/>
    
  </entry>
  
  <entry>
    <title>特定のユーザーへ仮想マシンの起動 / 停止 / 再起動 のみの操作を許可する方法</title>
    <link href="https://jpaztech.github.io/blog/vm/rbac-vm-start-stop-restart/"/>
    <id>https://jpaztech.github.io/blog/vm/rbac-vm-start-stop-restart/</id>
    <published>2021-11-11T02:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.604Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure テクニカル サポート チームの高橋です。<br>今回は、よくお問い合わせを頂く、特定のユーザーに対して、<br>仮想マシンの 起動 / 停止 / 再起動 のみの操作を実行できるようにする方法について<br>Azure portal 上のスクリーンショット付きで設定の手順をご紹介いたします。</p><p>本手順を実施することで、特定のユーザーは仮想マシンに対して、削除等の操作を実施できなくなり、<br>誤って仮想マシンを削除するといった問題を事前に防ぐことができます。</p><span id="more"></span><hr><h2 id="RBAC-とは"><a href="#RBAC-とは" class="headerlink" title="RBAC とは ?"></a>RBAC とは ?</h2><p>Azure では、ロールベースのアクセス制御 (RBAC) という機能を使用し、<br>アクセスできるリソースを制限や、リソースへの操作を制限することが可能となります。<br>Azure には複数の組み込みロールのご用意がありますが、<br>独自のカスタムロールを作成することで、必要最低限のリソースへの操作を許可することができます。</p><blockquote><p> □ 参考 : Azure ロールベースのアクセス制御 (Azure RBAC) とは<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/overview">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/overview</a></p><p> □ 参考 : Azure 組み込みロール<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p>※カスタムロールを作成するには、所有者やユーザー アクセス管理者など、カスタム ロールを作成するための権限を持つユーザーでの操作が必要となります。</p></div><hr><h2 id="必要な権限について"><a href="#必要な権限について" class="headerlink" title="必要な権限について"></a>必要な権限について</h2><p>仮想マシンの起動 / 停止 / 再起動の操作を行うために最低限必要なリソースプロバイダ (操作項目) は、次の4つです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>“Microsoft.Compute/virtualMachines/read”                // 仮想マシンのプロパティを取得します</p><p>“Microsoft.Compute/virtualMachines/start/action”        // 仮想マシンを起動します</p><p>“Microsoft.Compute/virtualMachines/deallocate/action”   // 仮想マシンを電源オフにし、コンピューティング リソースを解放します。</p><p>“Microsoft.Compute/virtualMachines/restart/action”      // 仮想マシンを再起動します。</p></div><p>リソースプロバイダを追加したい際には、下記の公開ドキュメントから<br>ご要望のリソースプロバイダを追加頂くことも可能です。</p><blockquote><p> □ 参考 : Azure リソース プロバイダーの操作<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftcompute">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftcompute</a></p></blockquote><hr><h2 id="カスタムロールを作成する手順"><a href="#カスタムロールを作成する手順" class="headerlink" title="カスタムロールを作成する手順"></a>カスタムロールを作成する手順</h2><ol><li>Azure portal から、カスタム ロールを割り当て可能にするサブスクリプションを開き、<br>“アクセス制御 (IAM)” から [+ 追加] をクリックし、[カスタムロールの追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/01.png"></p><ol><li>任意のカスタムロール名を入力し、必要に応じてカスタムロールの説明を入力します。<br>ここでは、testrole というカスタムロール名で作成します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/02.png"></p><ol start="3"><li>アクセス許可のタブへ移動し、[アクセス許可の追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/03.png"></p><ol start="4"><li>下記のような、画面に移りますので、”アクセス許可を検索してください” に許可したいリソースプロバイダを入力してください。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/04.png"></p><ol start="5"><li>“Microsoft.Compute/virtualMachines/read” を入力すると、対象のアクセス許可が表示されますので、<br>チェックを入れ、[追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/05.png"></p><ol start="6"><li>同様の手順で、残りの 3 つの権限も追加します。</li></ol><blockquote><p>“Microsoft.Compute/virtualMachines/start/action”<br>“Microsoft.Compute/virtualMachines/deallocate/action”<br>“Microsoft.Compute/virtualMachines/restart/action”</p></blockquote><ol start="7"><li>下記の通り、4 つアクセス許可が追加されたことが確認できます。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/06.png"></p><ol start="8"><li>[JSON] のタブから、JSON 形式でも、アクセス許可を編集することが可能になります。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/07.png"></p><ol start="9"><li>アクセス許可を追加したあとは、カスタムロールを作成します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/08.png"></p><p>これで、カスタムロールの作成が完了です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>カスタムロールの作成後、反映には、数分かかる場合がございます。</p></div><p><img src="/blog/vm/rbac-vm-start-stop-restart/09.png"></p><hr><h2 id="カスタムロールをユーザーに割り当てる"><a href="#カスタムロールをユーザーに割り当てる" class="headerlink" title="カスタムロールをユーザーに割り当てる"></a>カスタムロールをユーザーに割り当てる</h2><p>次は、特定のユーザーに対して、カスタムロールを割り当てていきます。</p><ol><li>カスタム ロールを割り当て可能にするサブスクリプションを開き、”アクセス制御 (IAM)” から<br>[+ 追加] をクリックし、[ロールの割り当ての追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/10.png"></p><ol start="2"><li>[ロールの割り当ての追加] に、登録されているすべてのロールが表示されますので、<br>作成したカスタムロールを選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/11.png"></p><ol start="3"><li>[メンバー] のタブから、[+ メンバーを選択する] を選択します。<br>画面右端に、カスタムロールを割り当てたい特定のユーザーを選択します。<br>ここでは、testuser という特定のユーザーを選択します。<br>(グループを選択することも可能です。)</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/12.png"></p><ol start="4"><li>ロールの割り当てに問題がなければ、”レビューと割り当て” を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/13.png"></p><ol start="5"><li>しばらくすると、ロールの割り当てが追加されます。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/14.png"></p><p>これで、特定のユーザーに対して、仮想マシンの起動 / 停止 / 再起動が許可されました。<br>それでは、testuser で、Azure portal へログインし、仮想マシンが起動できるか確認します。<br>下記の通り、無事に仮想マシンの起動ができました。</p><p><img src="/blog/vm/rbac-vm-start-stop-restart/15.png"></p><p>testuser は、仮想マシンの起動 / 停止 / 再起動の操作が許可されています。<br>そのため、仮想マシンの削除を実施しようとすると、下記画像のように<br>権限エラーとなり仮想マシンの削除は実施できなくなります。</p><p><img src="/blog/vm/rbac-vm-start-stop-restart/16.png"></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>※カスタムロールの設定が反映されていない場合には、一度 Azure portal からログアウトし、再度ログインをお試しください。</p></div><p>カスタムロールの作成方法につきましては、下記の公式ドキュメントにもございます。</p><blockquote><p> □ 参考：Azure portal を使用して Azure カスタム ロールを作成または更新する<br>    <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal</a></p></blockquote><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><p>RBAC の権限付与は、管理グループ、サブスクリプション、リソースグループ、リソース<br>いずれかのスコープに対して適用することが可能となります。<br>今回、サブスクリプションをスコープとしたカスタムロールを割り当てたため、<br>サブスクリプション内に存在する全ての仮想マシンに対して同様の操作が実施可能になります。</p><p>特定の複数の仮想マシンに対して権限付与をしたい場合には、<br>対象の仮想マシンが所属するリソースグループや<br>仮想マシンひとつひとつに対して権限付与を行っていただくことが可能になります。<br>（親スコープに設定された権限は、子スコープに継承されます。）</p><blockquote><p> □ 参考 : Azure RBAC のスコープについて<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/scope-overview">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/scope-overview</a></p></blockquote><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure テクニカル サポート チームの高橋です。&lt;br&gt;今回は、よくお問い合わせを頂く、特定のユーザーに対して、&lt;br&gt;仮想マシンの 起動 / 停止 / 再起動 のみの操作を実行できるようにする方法について&lt;br&gt;Azure portal 上のスクリーンショット付きで設定の手順をご紹介いたします。&lt;/p&gt;
&lt;p&gt;本手順を実施することで、特定のユーザーは仮想マシンに対して、削除等の操作を実施できなくなり、&lt;br&gt;誤って仮想マシンを削除するといった問題を事前に防ぐことができます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="RBAC" scheme="https://jpaztech.github.io/blog/tags/RBAC/"/>
    
  </entry>
  
  <entry>
    <title>2021 年 10 月 13 日に発生した仮想マシンの問題について (Tracking ID 0NC_-L9G)</title>
    <link href="https://jpaztech.github.io/blog/vm/20211013-rca-azure-vm/"/>
    <id>https://jpaztech.github.io/blog/vm/20211013-rca-azure-vm/</id>
    <published>2021-10-18T02:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.460Z</updated>
    
    <content type="html"><![CDATA[<p>いつも Azure IaaS テクニカル サポート チームのブログを参照いただきましてありがとうございます。</p><p>今回は日本時間の 10/13 に発生しました仮想マシンの障害について、RCA (Root Cause Analysis) レポートの日本語版の抄訳を紹介します。原文は <a href="https://azure.microsoft.com/ja-jp/status/history/">状態の履歴および根本原因分析 (RCA)</a> を確認ください。</p><p>日本語版の抄訳の PDF については、以下のリンクよりダウンロード頂けます。</p><p><a href="/blog/vm/20211013-rca-azure-vm/0NC_-L9G.pdf">0NC_-L9G.pdf</a></p><p>本障害では、仮想マシンをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。あらためて、今回の障害により多くのお客様にご迷惑をお掛けしましたことを深くお詫び申し上げます。</p><span id="more"></span><h2 id="影響の概要"><a href="#影響の概要" class="headerlink" title="影響の概要:"></a>影響の概要:</h2><p>日本時間 10 月 13 日 午後 3 時 27 分から午後 9 時 42 分まで Windows ベースの仮想マシンをご利用されている一部のお客様で、起動、作成、更新、削除などの管理オペレーションを実施されている時、失敗のメッセージを受け取られた可能性がございます。また、新規仮想マシンのデプロイや拡張機能の更新も、失敗となっていた可能性がございます。可用性セットや仮想マシンのスケールセットへのオペレーションも同様に影響を受けていました。</p><p><u>Windows ベースではない仮想マシンは影響を受けなかったものの、Windows の仮想マシンに依存しているサービスは、リソース作成時に同様の影響を受けていた可能性がございます。</u></p><h2 id="原因"><a href="#原因" class="headerlink" title="原因:"></a>原因:</h2><p>Windows ベースの仮想マシンは、仮想マシンと Azure ファブリック間の相互作用を管理する Windows 仮想マシンエージェント(VM エージェント)を利用します。</p><p>Windows 仮想マシンの作成や更新を実施する際、Computer Resource Provider（CRP）はプラットフォームイメージリポジトリから最新版の VM エージェントパッケージのダウンロードするロケーションを取得いたします。VM エージェントはこの取得した情報を用いて、仮想マシン内でエージェントを最新版に更新します。</p><p>クラシックリソースを Azure Resource Manager (ARM) へ移行する行程の一つとして、弊社はイメージと拡張機能の発行元を、地域的(リージョナル)な ARM 発行パイプラインへマイグレーションしており、現在は約 20% 程完了しております。</p><p>午後 3 時 27 分ころ、弊社内のツールはこれらの移行を行うため ARM テンプレートを生成しましたが、このツールはエッジケース（最大や最小限の動作パラメータでのみ発生する問題または状況) を考慮していなかったため、意図されてない結果として、マイグレーション後に、 ARM リージョナルサービス内でのみ発行されているサブスクリプションに対して、Windows VM エージェント拡張機能が表示されるようマークされてしまいました。その結果、地域的なプラットフォームイメージリポジトリから何も受け取れず（zero results）、VM 管理オペレーションが失敗し始めました。</p><p>お客様の Windows 仮想マシンにおける起動、停止、作成や削除などのオペレーションは Windows VM エージェントの拡張機能を見つけることができなかったため、完了することができない結果となってしまいました。 </p><p>私たちの変更管理のプロセスの一部は、Safe Deployment Practice (SDP) のフレームワークをレバレッジすることです。<br><a href="https://azure.microsoft.com/en-us/blog/advancing-safe-deployment-practices/">(https://azure.microsoft.com/en-us/blog/advancing-safe-deployment-practices/)</a>.　この場合、弊社クラシックモデルのインフラ機能のいくつかは SDP フレームワークと合致しません。この不適合性は私たちが ARM への完全なマイグレーションを行う重要性を強調するものになります。マイグレーションが完了しましたら、クラシックリソースに特化したツールを使わないまま、SDP フレームワーク使用し、すべて変更ができるようになります。</p><h2 id="緩和策"><a href="#緩和策" class="headerlink" title="緩和策:"></a>緩和策:</h2><p>根本原因の特定にあたり、Azure コンポーネント用の複数のリリースがプラットフォーム上で同時に実行されており、それぞれを調査するため時間を要することになりました。根本的な原因を確実に特定できるよういくつかの想定されるシナリオを排除するため、それらに関連するコンポーネントに特化した技術者たち（SMEs）が調査対応を進めていたことも時間を要した理由でした。</p><p>私たちは問題自体を確定し、いくつかの緩和策を確認した後、まず始めに一つの地域にて拡張機能を公開し影響を軽減させて、その結果を検証しました。そして仮想マシンへの膨大なリクエストでもこれ以上影響が出ない事を確認いたしました。この検証の後、一つ一つの地域で新しいパイプラインへの変更を展開し始め、事象緩和へと至りました。変更が完了した後、エンジニアたちはオペレーションの成功率を監視しておりました。</p><h2 id="次のステップ"><a href="#次のステップ" class="headerlink" title="次のステップ:"></a>次のステップ:</h2><p>影響があったお客様へ深くお詫び申し上げます。Microsoft Azure プラットフォームの改善、そして将来的にこのような障害が再発しないよう私たちは下記を継続して取り組んでいきます。</p><ul><li>すべての復旧作業が実施されるまで、未実施のパッケージ（Linux バージョンの VM エージェントも含む）のマイグレーションを一時中断します。</li><li>追加の事前確認 (pre-check) と事後確認 (post-check) を開発し、実装いたします。</li><li>VM オペレーション中に VM エージェントが見つからないエラーが発生したとき、VM オペレーションがエラーから復旧できるよう改善いたします。</li><li>エンジニア部門は各拡張タイプをフライトするため、そしてマイグレーションの残工程に存在しうる障害を防ぐために、他の安全策も評価しています。</li></ul><h2 id="フィードバックのお願い"><a href="#フィードバックのお願い" class="headerlink" title="フィードバックのお願い:"></a>フィードバックのお願い:</h2><p>Azure カスタマー・コミュニケーション・エクスペリエンスの向上のためのアンケートにご協力ください: <a href="https://aka.ms/AzurePIRSurvey">https://aka.ms/AzurePIRSurvey</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;いつも Azure IaaS テクニカル サポート チームのブログを参照いただきましてありがとうございます。&lt;/p&gt;
&lt;p&gt;今回は日本時間の 10/13 に発生しました仮想マシンの障害について、RCA (Root Cause Analysis) レポートの日本語版の抄訳を紹介します。原文は &lt;a href=&quot;https://azure.microsoft.com/ja-jp/status/history/&quot;&gt;状態の履歴および根本原因分析 (RCA)&lt;/a&gt; を確認ください。&lt;/p&gt;
&lt;p&gt;日本語版の抄訳の PDF については、以下のリンクよりダウンロード頂けます。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/blog/vm/20211013-rca-azure-vm/0NC_-L9G.pdf&quot;&gt;0NC_-L9G.pdf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本障害では、仮想マシンをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。あらためて、今回の障害により多くのお客様にご迷惑をお掛けしましたことを深くお詫び申し上げます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway - App Service 間のリダイレクトの問題</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-appservice-redirectissue/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-appservice-redirectissue/</id>
    <published>2021-10-14T03:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.356Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの大塚です。</p><p>この記事では Application Gateway と App Service を組み合わせた時によくお問い合わせをいただくリダイレクトの問題についてご紹介させていただきます。</p><span id="more"></span><hr><h3 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h3><p>Application Gateway のバックエンドにマルチテナントである App Service を指定するシナリオでは、App Service の 既定の FQDN（xxx.azurewebsites.net）をバックエンドに配置し、この FQDN でホスト名の上書きを行うことで実現させることが一般的です。<br>※詳細は<a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/configure-web-app-portal">こちら</a>のドキュメントをご参照ください。 </p><p>しかしながら Application Gateway のフロント エンドにカスタム ドメインを設定しており、バックエンドに指定した App Service 側でリダイレクトの応答が返されるシナリオでは前述の構成だと意図せず App Service の 既定の FQDN が利用されてしまい期待した動作とならない場合があります。</p><p>この場合のトラブルシュートについては<a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/troubleshoot-app-service-redirection-app-service-url">こちら</a>のドキュメントに対処方法が記載されております。このブログではこのドキュメントの手順をもう少しかみくだきご紹介いたします。</p><h4 id="現在の構成"><a href="#現在の構成" class="headerlink" title="現在の構成"></a>現在の構成</h4><p>まず、現在の構成は以下とします。この状態でクライアントから 「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> に接続すると、ブラウザの URL 表示が App Service のFQDN となってしまう事象が発生しています。これをカスタムドメインで表示させることが目的です。</p><ul><li>   カスタム ドメイン 「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> は Application Gateway のパブリック IP アドレスに名前解決されるように構成済み</li><li>   Application Gateway のバックエンド プールには App Service の既定の FQDN 「maotsuwebapp.azurewebsites.net」 を設定し HTTP 設定とカスタム プローブでバックエンドターゲットからホスト名を選択する設定をいれている</li></ul><p><img src="/blog/network/appgw-appservice-redirectissue/01.png"></p><p><span id="application-gateway-issue-check"></span></p><h2 id="App-Service-のリダイレクトの問題に合致しているかどうかの確認"><a href="#App-Service-のリダイレクトの問題に合致しているかどうかの確認" class="headerlink" title="App Service のリダイレクトの問題に合致しているかどうかの確認"></a><a href="#application-gateway-issue-check">App Service のリダイレクトの問題に合致しているかどうかの確認</a></h2><p>現在発生している問題がリダイレクトの問題かどうか確認しましょう。確認にはブラウザの F12 キーを押し開発者ツールを使用し、Network タブを確認します。※<a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace">参考サイトはこちら</a></p><p>確認してみるとクライアントから 「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> に接続すると、応答ヘッダー内の Location ヘッダーにApp Service の既定の FQDN が入り、リダイレクトの指示がされています。</p><p><img src="/blog/network/appgw-appservice-redirectissue/02.png"></p><p>この場合、App Service のリダイレクトの問題に合致しているので、後述の方法で対処することでリダイレクト構成時にもアドレスバーの FQDN をカスタム ドメインで構成することが可能です。</p><h3 id="リダイレクトの問題の対応方法"><a href="#リダイレクトの問題の対応方法" class="headerlink" title="リダイレクトの問題の対応方法"></a>リダイレクトの問題の対応方法</h3><p>このリダイレクトの問題を対処するには次の２ つの方法があります。使い分け分けとしては大まかに以下のように整理できます。</p><ul><li><p><strong>Application Gateway の書き換え規則をつかう</strong><br>Application Gateway V2 SKU を利用の場合で、Location ヘッダーのみの書き換えで対応が可能な場合</p></li><li><p><strong>カスタム ドメインをつかう</strong><br>Application Gateway V1 SKU を利用の場合、または V2 SKU を利用しているものの referer ヘッダーや Cookie などにもドメインが含まれていて書き換えでの対応が複雑となる場合</p></li></ul><p>それではそれぞれの対応方法について見てみましょう。</p><p><span id="application-gateway-rewrite"></span></p><h2 id="Application-Gateway-の書き換え規則をつかう"><a href="#Application-Gateway-の書き換え規則をつかう" class="headerlink" title="Application Gateway の書き換え規則をつかう"></a><a href="#application-gateway-rewrite">Application Gateway の書き換え規則をつかう</a></h2><p>Application Gateway V2 から追加された「書き換え規則」を使います。設定内容は下記の通りです。<br>※書き換え規則の設定方法の詳細については<a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#modify-a-redirection-url">こちら</a>もご参照ください。</p><h4 id="必要な作業"><a href="#必要な作業" class="headerlink" title="必要な作業"></a>必要な作業</h4><ul><li>「If（条件）」の一致させるパターン ： <code>(https?):\/\/.*azurewebsites\.net(.*)$</code></li><li>「Then（結果）」 のヘッダー値 ：<code>&#123;http_resp_Location_1&#125;://&lt;カスタム ドメイン名&gt;&#123;http_resp_Location_2&#125;</code></li></ul><p><img src="/blog/network/appgw-appservice-redirectissue/03.png"></p><p><span id="application-gateway-custom-domain"></span></p><h2 id="カスタム-ドメインをつかう"><a href="#カスタム-ドメインをつかう" class="headerlink" title="カスタム ドメインをつかう"></a><a href="#application-gateway-custom-domain">カスタム ドメインをつかう</a></h2><h4 id="必要な作業-1"><a href="#必要な作業-1" class="headerlink" title="必要な作業"></a>必要な作業</h4><p><strong>1. App Service側にもカスタムドメイン「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> を登録する</strong><br><strong>2. Application Gateway 側で HTTP 設定とカスタム プローブの変更する</strong><br><strong>3. 動作の確認</strong><br>それぞれの作業内容についてご説明します。</p><hr><h3 id="1-App-Service側にもカスタムドメイン「www-maotsunet-com」-を登録する"><a href="#1-App-Service側にもカスタムドメイン「www-maotsunet-com」-を登録する" class="headerlink" title="1. App Service側にもカスタムドメイン「www.maotsunet.com」 を登録する"></a>1. App Service側にもカスタムドメイン「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> を登録する</h3><p>App Service はマルチテナント サービスのため、IP アドレスでのリクエストを受け入れることはできません。<br>そのため、既定の FQDN 以外で接続したい場合は事前にカスタム ドメインの登録を行う必要があります。<br>App Service にカスタム ドメインを設定する際に、カスタム ドメインの CNAME が既にApplication Gatewayなど WebApps 以外に向いている場合、カスタム ドメインの設定はできません。<br>このような場合、App Service の「カスタム ドメインの検証 ID」を使用し、asuid という名前の TXT レコードを作成することで回避することが可能です。<br>例えば、カスタム ドメインに<a href="http://www.maotsunet.com/">www.maotsunet.com</a> を登録しようとしている場合 maotsunet.com の DNS ゾーンに以下のレコードを追加します。App Service 側にカスタム ドメインを追加する作業の詳細については<a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-web-tutorial-custom-domain?tabs=cname#3-get-a-domain-verification-id">こちら</a>もご参照ください。</p><ol><li><p>App Service のカスタム ドメインの項目から「カスタム ドメイン検証 ID」をコピーします。<br><img src="/blog/network/appgw-appservice-redirectissue/dnstxt.jpg" alt="カスタム ドメインの検証 ID をコピー"></p></li><li><p>   「ｍaotsunet.com」 ゾーンを管理しているDNS サーバーに以下のようなレコードを追加します。</p></li></ol><ul><li>名前：asuid.&lt;ホスト名&gt;</li><li>種類：TXT</li><li>値：コピーしたカスタムドメインの検証 ID</li></ul><p>【例】<a href="http://www.maotsunet.com/">www.maotsunet.com</a> というカスタムドメインで、 maotsuwebapp.azurewebsites.net という App Service のドメインの場合</p><ul><li>名前：asuid.www</li><li>種類：TXT</li><li>値：123456789123456789123456789XXXXXXX</li></ul><p>(※) Azure DNS でゾーンの管理している場合は下記のように構成します</p><p><img src="/blog/network/appgw-appservice-redirectissue/azdns.jpg"></p><p>これによって、カスタム ドメイン設定時の検証において、asuid のレコードを参照して検証を行うため、元のホスト名の CNAME が Application Gateway など WebApps 以外に向いている状態でカスタム ドメインが設定可能となります。</p><p>3）対象の WebApps の設定にてカスタム ドメインの 「検証」 ・ 「カスタム ドメインの追加」 を行います<br><img src="/blog/network/appgw-appservice-redirectissue/domainkensho.jpg"></p><p><span style="color: red"> (注意)<br>Application Gateway と App Service 間で HTTPS プロトコルを使用する場合、カスタム ドメインの証明書を App Service 側にも設定する必要がありますのでご留意ください。また、作成した asuid の DNS レコードは WebApps 側のカスタム ドメインの設定後は不要となりますので、削除頂いても問題ございません。</span></p><h3 id="2-Application-Gateway-側で-HTTP-設定とカスタム-プローブの変更"><a href="#2-Application-Gateway-側で-HTTP-設定とカスタム-プローブの変更" class="headerlink" title="2. Application Gateway 側で HTTP 設定とカスタム プローブの変更"></a>2. Application Gateway 側で HTTP 設定とカスタム プローブの変更</h3><p>次に Application Gateway 側の設定を変更します。</p><p>1）    管理ポータルより、正常性プローブを選択し、以下のように変更し保存します<br>    ※下記以外はそのままの設定で問題ありません</p><p>・    ホスト： カスタム ドメイン<br>・    ホスト名をバックエンド HTTP 設定から選択します：いいえ</p><p><img src="/blog/network/appgw-appservice-redirectissue/06.jpg"></p><p>2）    HTTP 設定にて 「新しいホスト名でオーバーライドする」 で いいえ にチェックをいれ保存します<br>※カスタム プローブは １）で変更したものが紐づいている状態となります（ホスト名の箇所でカスタム ドメインを入れても問題ありません）</p><p><img src="/blog/network/appgw-appservice-redirectissue/07.png"></p><p><span style="color: red">(注意)<br> V2 を利用する場合、この変更により Application Gateway - App Service 間で HTTPS プロトコルを使用する場合にライブトラフィックおよびプローブで利用される証明書はカスタム ドメインの証明書となります。バックエンド側に登録したカスタム ドメイン用の証明書が自己署名証明書など、公的機関から発行されていない場合、Application Gateway の HTTP 設定でルート証明書をアップロードする必要があります。</span> ※この動作ついては <a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview#end-to-end-tls-with-the-v2-sku">こちら</a> のドキュメントをご確認ください。</p><h3 id="3-動作の確認"><a href="#3-動作の確認" class="headerlink" title="3. 動作の確認"></a>3. 動作の確認</h3><p>設定は以上です。最後に再度意図した動作となっているかどうかご確認します。<br>再度クライアントから Application Gateway にアクセスした際の F12 のログを確認すると Location ヘッダーの内容がカスタム ドメインとなっていることが確認できます。</p><p><img src="/blog/network/appgw-appservice-redirectissue/08.png"></p><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="すでにApplication-Gateway-に向けているカスタムドメインと同じものを-App-Service-に登録することは可能ですか"><a href="#すでにApplication-Gateway-に向けているカスタムドメインと同じものを-App-Service-に登録することは可能ですか" class="headerlink" title="-  すでにApplication Gateway に向けているカスタムドメインと同じものを App Service に登録することは可能ですか"></a>-  すでにApplication Gateway に向けているカスタムドメインと同じものを App Service に登録することは可能ですか</h4><p> はい、可能です。App Service 側ではあくまで 「そのカスタムドメインを受け入れる構成にするために登録する」 ことが目的であり、この登録する際に一時的に該当のドメインを所有しているかどうかの検証があるため、ドメインを管理している DNS 側での設定作業が必要となります。この作業が終われば、App Service の設定は DNS から削除しても問題ありません。実際にカスタム ドメインが名前解決した結果得られる IP アドレスは Application Gateway の IP となることが想定です。</p><h4 id="Azure-Front-Door-のバックエンドに-App-Service-を構成している場合でも同じ事象がおきますか"><a href="#Azure-Front-Door-のバックエンドに-App-Service-を構成している場合でも同じ事象がおきますか" class="headerlink" title="- Azure Front Door のバックエンドに App Service を構成している場合でも同じ事象がおきますか"></a>- Azure Front Door のバックエンドに App Service を構成している場合でも同じ事象がおきますか</h4><p> はい、起きる可能性があります。本Blog にてご紹介した App Service のリダイレクトの問題であると判断できた場合、Azure Front Door のバックエンドの構成で「バックエンド ホスト ヘッダー」の箇所にカスタム ドメインを設定することで対応可能です。</p><p><img src="/blog/network/appgw-appservice-redirectissue/09.png"></p><p><span id="reference"></span></p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference">参考情報</a></h2><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-web-tutorial-custom-domain?tabs=cname#map-your-domain">チュートリアル:既存のカスタム DNS 名を Azure App Service にマップする</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview">Application Gateway での TLS 終了とエンド ツー エンド TLS の概要</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの大塚です。&lt;/p&gt;
&lt;p&gt;この記事では Application Gateway と App Service を組み合わせた時によくお問い合わせをいただくリダイレクトの問題についてご紹介させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>既存 VM の OS ディスクのリソース名を変更する</title>
    <link href="https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/"/>
    <id>https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/</id>
    <published>2021-09-10T00:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.540Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チーム、インターン生の藤澤です。</p><p>Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。<br>本記事では、既存 VM の OS ディスクのリソース名を変更する手順について紹介します。</p><span id="more"></span><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>手順としては、大きく 3 つの作業を実施します。<br>Windows VM、Linux VM ともに同様の手順となります。</p><ol><li>OS ディスクのスナップショットを作成する</li><li>スナップショットから管理ディスクを作成する</li><li>元の OS ディスクと 2 のディスクを入れ替える (スワップする)</li><li>VM の動作確認をする</li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順は、<strong>ARM デプロイ モデル</strong> の VM にて、<strong>管理ディスク</strong> をご利用いただいていることを前提としています。</p><p>　</p><p>スナップショットを取得する際、OS ディスクのスワップを行う際には、<strong>VM が停止済み (割り当て解除)</strong> 状態である必要があります。ダウンタイムが発生するため、業務影響の少ない時間帯にご実施ください。</p></div><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-OS-ディスクのスナップショットを作成する"><a href="#1-OS-ディスクのスナップショットを作成する" class="headerlink" title="1. OS ディスクのスナップショットを作成する"></a>1. OS ディスクのスナップショットを作成する</h3><ol><li><p>Azure Portal の上部検索バーから、[Virtual Machines] で検索します。<br><img src="/blog/vm/how-to-change-os-disk-name/01.png"></p></li><li><p>対象の VM を選択します。<br>対象 VM が起動している場合には [停止] をクリックし、”停止済み (割り当て解除)” 状態となっていることを確認します。<br><img src="/blog/vm/how-to-change-os-disk-name/02.png"></p></li><li><p>画面左下の [ディスク] を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/03.png"></p></li><li><p>OS ディスク (リソース名を変更するディスク) を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/04.png"></p></li><li><p>[スナップショットの作成] をクリックします。<br><img src="/blog/vm/how-to-change-os-disk-name/05.png"></p></li><li><p>必要事項を入力後、[作成] を選択します。</p><blockquote><p>ご参考：Azure リソースの名前付け規則と制限事項 - Microsoft.Compute<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules#microsoftcompute">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules#microsoftcompute</a><br>参照箇所：disks</p></blockquote><p><img src="/blog/vm/how-to-change-os-disk-name/06.png"></p></li></ol><h3 id="2-スナップショットから管理ディスクを作成する"><a href="#2-スナップショットから管理ディスクを作成する" class="headerlink" title="2. スナップショットから管理ディスクを作成する"></a>2. スナップショットから管理ディスクを作成する</h3><ol><li><p>Azure Portal の上部検索バーで [スナップショット] と検索します。<br><img src="/blog/vm/how-to-change-os-disk-name/07.png"></p></li><li><p>作成したスナップショット (手順 1 ~ 6) を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/08.png"></p></li><li><p>[ディスクの作成] を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/09.png"></p></li><li><p>必要項目を適宜入力し、[確認および作成] をクリックします。<br> 変更後の OS ディスク名は、”ディスクの詳細” の “ディスク名” で任意の値を入力してください。<br> <img src="/blog/vm/how-to-change-os-disk-name/10.png"></p></li></ol><h3 id="3-元の-OS-ディスクと-2-のディスクを入れ替える-スワップする"><a href="#3-元の-OS-ディスクと-2-のディスクを入れ替える-スワップする" class="headerlink" title="3. 元の OS ディスクと 2 のディスクを入れ替える (スワップする)"></a>3. 元の OS ディスクと 2 のディスクを入れ替える (スワップする)</h3><p>※ VM が停止済み (割り当て解除) 状態である必要があります。<br>※ 対象 VM が起動している場合には [停止] をクリックし、”停止済み (割り当て解除)” 状態となっていることを確認します。</p><ol><li><p>Azure Portal の上部検索バーから、[Virtual Machines] で検索します。<br><img src="/blog/vm/how-to-change-os-disk-name/01.png"></p></li><li><p>対象の VM を選択します。<br>対象 VM が起動している場合には [停止] をクリックし、”停止済み (割り当て解除)” 状態となっていることを確認します。<br><img src="/blog/vm/how-to-change-os-disk-name/02.png"></p></li><li><p>画面左下の [ディスク] を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/03.png"></p></li><li><p>[OS ディスクのスワップ] をクリックします。<br> <img src="/blog/vm/how-to-change-os-disk-name/13.png"></p></li><li><p>作成したディスクを選択します。<br> <img src="/blog/vm/how-to-change-os-disk-name/14.png"></p></li><li><p>ディスクのリソース名が反映されているか確認します。<br> VM を起動・接続し、問題なく動作することをご確認ください。<br> <img src="/blog/vm/how-to-change-os-disk-name/15.png"></p></li></ol><h3 id="4-VM-の動作確認をする"><a href="#4-VM-の動作確認をする" class="headerlink" title="4. VM の動作確認をする"></a>4. VM の動作確認をする</h3><p>OS ディスクのスワップが完了した後には、念のため VM が正しく動作すること (ゲスト OS が起動し、アプリケーション等の動作に問題がないこと) をご確認ください。</p><ol><li><p>VM を起動します。</p></li><li><p>VM に接続し、正しく動作することを確認します。</p></li><li><p>必要に応じてスワップ後の元ディスクを削除します。</p></li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>管理ディスクは、使用するディスク領域の量に関係なく、作成したディスクの種類に応じて固定料金で課金されます。</p><p>上記手順を実施いただいた後は、必要に応じて元ディスクを削除してください。</p><p>　</p><p><strong>ご参考</strong></p><p>・<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/disks-types">Azure IaaS VM 用のディスクの種類の選択</a>)</p><p>・<a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">Managed Disks の価格</a></p></div><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チーム、インターン生の藤澤です。&lt;/p&gt;
&lt;p&gt;Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。&lt;br&gt;本記事では、既存 VM の OS ディスクのリソース名を変更する手順について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
  </entry>
  
  <entry>
    <title>VM 作成時に OS ディスク名を指定する方法について</title>
    <link href="https://jpaztech.github.io/blog/vm/set-os-disk-name-using-arm-template/"/>
    <id>https://jpaztech.github.io/blog/vm/set-os-disk-name-using-arm-template/</id>
    <published>2021-09-09T05:02:00.000Z</published>
    <updated>2022-03-02T05:20:41.620Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの西澤です。</p><p>Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。<br>本記事では、ARM テンプレートを使用して VM 作成時に OS ディスクのリソース名を変更する手順についてご紹介します。</p><span id="more"></span><p>既存の VM の OS ディスクのリソース名を変更する手順については、ブログ <a href="https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/">既存 VM の OS ディスクのリソース名を変更する</a> に記載されていますので、併せてご確認いただけますと幸いです。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>下記の手順で OS ディスク名を指定の上、VM をデプロイいたします。<br>Windows VM、Linux VM ともに同様の手順となります。</p><ol><li>Azure Portal より ARM テンプレートを用意する</li><li>OS ディスクの名前を設定する</li><li>VM をデプロイする </li><li>確認</li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順は、ARM デプロイ モデル の VM にて、管理ディスク をご利用いただいていることを前提としています。</p></div><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h2 id="1-Azure-Portal-より-ARM-テンプレートを用意する"><a href="#1-Azure-Portal-より-ARM-テンプレートを用意する" class="headerlink" title="1. Azure Portal より ARM テンプレートを用意する"></a>1. Azure Portal より ARM テンプレートを用意する</h2><p>Azure ポータルより [Virtual Machines] を開き、VM の新規作成画面を開きます。<br>必要な項目を設定し、画面下部にある [確認および作成] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/1.png"></p><p>検証が完了しましたら、画面下部にある [Automation のテンプレートをダウンロードする] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/2.png"></p><p>表示された ARM テンプレートを使用して VM をデプロイするため、[デプロイ] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/3.png"></p><p>ARM テンプレートを使用したカスタム デプロイの画面へ遷移しましたら、テンプレートを編集するため、<br>[テンプレートの編集] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/4.png"></p><h2 id="2-OS-ディスクの名前を設定する"><a href="#2-OS-ディスクの名前を設定する" class="headerlink" title="2. OS ディスクの名前を設定する"></a>2. OS ディスクの名前を設定する</h2><p>ARM テンプレート内の下記箇所を追記して、OS ディスクの名前を編集します。<br>編集が完了しましたら、画面下部にある [保存] を選択します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;resources&quot;: [&#123;</span><br><span class="line">&quot;properties&quot;: &#123;</span><br><span class="line">&quot;storageProfile&quot;: &#123;</span><br><span class="line">&quot;osDisk&quot;: &#123;</span><br><span class="line">&quot;name&quot;: &quot;ここにご希望の OS ディスクの名前を記入します&quot;,</span><br></pre></td></tr></table></figure><div class="alert is-warning"><p class="alert-title">警告</p><p>最後の「,」の付け忘れにご注意ください。</p></div><p><img src="/blog/vm/set-os-disk-name-using-arm-template/5.png"></p><p>ARM テンプレートのパラメータに関する詳細内容に関しましては<br>下記の弊社公式ドキュメントをご参照ください。</p><blockquote><p>ご参考：Azure Resource Manager テンプレートの仮想マシン<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/template-description">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/template-description</a></p></blockquote><h2 id="3-VM-をデプロイする"><a href="#3-VM-をデプロイする" class="headerlink" title="3. VM をデプロイする"></a>3. VM をデプロイする</h2><p>必要な項目を設定し、画面下部にある  [確認と作成] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/6.png"></p><p>検証が正常に完了しましたら、[作成] を押してデプロイください。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/7.png"></p><h2 id="4-確認"><a href="#4-確認" class="headerlink" title="4. 確認"></a>4. 確認</h2><p>デプロイが完了したら、Azure Portal からデプロイした Virtual Machine を選択し、[ディスク] を選択ください。<br>OS ディスクの名前が設定した名前となっていることをご確認いただければ完了です。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/8.png"></p><hr><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの西澤です。&lt;/p&gt;
&lt;p&gt;Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。&lt;br&gt;本記事では、ARM テンプレートを使用して VM 作成時に OS ディスクのリソース名を変更する手順についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Managed Disk" scheme="https://jpaztech.github.io/blog/tags/Managed-Disk/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
    <category term="ARM Template" scheme="https://jpaztech.github.io/blog/tags/ARM-Template/"/>
    
  </entry>
  
  <entry>
    <title>VM の再作成により可用性ゾーンを変更する (Azure ポータル編)</title>
    <link href="https://jpaztech.github.io/blog/vm/change-availability-zone-from-portal/"/>
    <id>https://jpaztech.github.io/blog/vm/change-availability-zone-from-portal/</id>
    <published>2021-08-11T09:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.464Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの松岡です。</p><p>VM における可用性ゾーンの利用有無は、VM を新規作成する場合にのみ設定することができますが、運用をしている中で VM を可用性ゾーンへ組み入れる必要が発生したり、逆に、可用性ゾーンに組み入れられていると一部機能が対応しないため、可用性ゾーンから外したいという状況もあるかと思います。<br>本稿では、そのような際、VM の可用性ゾーンを変更する方法について、Azure ポータルからの実施方法をご案内します。</p><span id="more"></span><p>なお、Azure ポータルからではなく Azure PowerShell を用いた実施方法を確認する場合は、以下の記事をご確認ください。</p><blockquote><p>VM の再作成により可用性ゾーンを変更する (PowerShell 編)<br><a href="https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/">https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/</a></p></blockquote><p>また、可用性ゾーンをサポートしているのは一部リージョンのみとなりますので、ご留意ください。</p><blockquote><p>Azure での Availability Zones をサポートしているリージョン<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region">https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region</a></p></blockquote><hr><h2 id="■-手順を利用する前提条件"><a href="#■-手順を利用する前提条件" class="headerlink" title="■ 手順を利用する前提条件"></a>■ 手順を利用する前提条件</h2><p>本手順では、管理ディスクを利用していることを前提としてご案内します。</p><hr><h2 id="■-手順の流れについて"><a href="#■-手順の流れについて" class="headerlink" title="■ 手順の流れについて"></a>■ 手順の流れについて</h2><p>VM の可用性ゾーンを変更する場合、以下の流れにて作業を行います。</p><ol><li>VM を停止 (割り当て解除) する</li><li>ディスクのスナップショットを作成する</li><li>ディスクのスナップショットから新規にディスクを作成する</li><li>新規に作成したディスクから VM を作成する</li><li>作成したスナップショット、および元々利用していたリソースを削除する</li></ol><p>本稿では、VM の可用性ゾーンを 1 から 2 に変更する手順を例として紹介します。</p><hr><h2 id="■-VM-の可用性ゾーンを変更する手順"><a href="#■-VM-の可用性ゾーンを変更する手順" class="headerlink" title="■ VM の可用性ゾーンを変更する手順"></a>■ VM の可用性ゾーンを変更する手順</h2><h3 id="1-VM-を停止-割り当て解除-する"><a href="#1-VM-を停止-割り当て解除-する" class="headerlink" title="1. VM を停止 (割り当て解除) する"></a>1. VM を停止 (割り当て解除) する</h3><p>Azure ポータルより [Virtual Machines] - [&lt;当該 VM 名&gt;] を開き、VM を停止 (割り当て解除) します。<br>VM の状態が [停止済み (割り当て解除)] になっていることを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/1.png"></p><p>左メニュー “設定” より [ディスク] を選択し、開いた画面 “OS ディスク” より [&lt;当該 OS ディスク名&gt;] をクリックします。</p><p><img src="/blog/vm/change-availability-zone-from-portal/2.png"></p><h3 id="2-ディスクのスナップショットを作成する"><a href="#2-ディスクのスナップショットを作成する" class="headerlink" title="2. ディスクのスナップショットを作成する"></a>2. ディスクのスナップショットを作成する</h3><p>画面の “＋ スナップショットの作成” をクリックします。</p><p><img src="/blog/vm/change-availability-zone-from-portal/3.png"></p><p>必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>“記憶域の種類” は、スナップショットを高パフォーマンスのディスクに保存する必要がある場合を除き、 [Standard_HDD] を選択します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/4.png"></p><p>データディスクがある場合、データディスクについても同様にスナップショットを作成します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/5.png"></p><h3 id="3-ディスクのスナップショットから新規にディスクを作成する"><a href="#3-ディスクのスナップショットから新規にディスクを作成する" class="headerlink" title="3. ディスクのスナップショットから新規にディスクを作成する"></a>3. ディスクのスナップショットから新規にディスクを作成する</h3><p>Azure ポータル 上部の検索バーに “スナップショット” と入力し、サービス [スナップショット] を選択します。<br>上記手順で作成した OS ディスクおよび、データ ディスクのスナップショットが作成されていることを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/6.png"></p><p>OS ディスクのスナップショットを選択し、[+ ディスクの作成] をクリックします。</p><p><img src="/blog/vm/change-availability-zone-from-portal/7.png"></p><p>必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>可用性ゾーンを希望のゾーン番号に変更します。<br>こちらの手順では、元々選択していた “1” から “2” へとゾーンを変更しています。</p><p><img src="/blog/vm/change-availability-zone-from-portal/8.png"></p><p>データ ディスクについても同様にディスクを作成します。</p><h3 id="4-新規に作成したディスクから-VM-を作成する"><a href="#4-新規に作成したディスクから-VM-を作成する" class="headerlink" title="4. 新規に作成したディスクから VM を作成する"></a>4. 新規に作成したディスクから VM を作成する</h3><p>Azure ポータル上部の検索バーに “ディスク” と入力し、サービス [ディスク] を選択します。<br>上記手順で作成した OS ディスクおよび、データ ディスクが作成されていることを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/9.png"></p><p>作成した OS ディスクを選択し、[+ VM の作成] をクリックします。<br>表示されているディスクの状態が “Unattached”、可用性ゾーンが指定した番号であるかを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/10.png"></p><p>必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>可用性ゾーンの番号は、作成したディスクと同じ番号を指定します。<br>データ ディスクは [既存のディスクの接続] より、スナップショットから作成したデータ ディスクを適宜選択します。<br>VNET は同様に既存のものから選択出来ますが、NIC は新規に作成されます。</p><p><img src="/blog/vm/change-availability-zone-from-portal/11.png"></p><p>作成された VM が、指定のゾーン番号で表示されていること(こちらの手順ではゾーン “2” )を確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/12.png"></p><h3 id="5-作成したスナップショット、および元々利用していたリソースを削除する"><a href="#5-作成したスナップショット、および元々利用していたリソースを削除する" class="headerlink" title="5. 作成したスナップショット、および元々利用していたリソースを削除する"></a>5. 作成したスナップショット、および元々利用していたリソースを削除する</h3><p>作成した VM が正常動作することを確認後、元々利用していたリソース、および元々利用していたリソースを削除し、手順は完了です。</p><hr><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの松岡です。&lt;/p&gt;
&lt;p&gt;VM における可用性ゾーンの利用有無は、VM を新規作成する場合にのみ設定することができますが、運用をしている中で VM を可用性ゾーンへ組み入れる必要が発生したり、逆に、可用性ゾーンに組み入れられていると一部機能が対応しないため、可用性ゾーンから外したいという状況もあるかと思います。&lt;br&gt;本稿では、そのような際、VM の可用性ゾーンを変更する方法について、Azure ポータルからの実施方法をご案内します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Availability Zone" scheme="https://jpaztech.github.io/blog/tags/Availability-Zone/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure VPN ゲートウェイにメンテナンスがあったか確認する方法</title>
    <link href="https://jpaztech.github.io/blog/network/vpngw-how-to-check-maintenance/"/>
    <id>https://jpaztech.github.io/blog/network/vpngw-how-to-check-maintenance/</id>
    <published>2021-07-27T15:00:00.000Z</published>
    <updated>2022-03-02T05:20:41.380Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームです。<br>今回は、Azure でお使いいただいている VPN ゲートウェイにおいて、メンテナンスが行われていたことを事後確認する方法をご紹介します。<br>今回ご紹介する内容については以下の前提条件の下記載されておりますので予めご了承ください。</p><p><strong>前提</strong></p><ul><li>メンテナンスの日時を事前に確認する方法ではなく、あくまで事後に確認する方法になります。</li><li>VPN ゲートウェイに対する全てのメンテナンスを対象としてはおらず、種類によってはお客様自身でメンテナンスの形跡をご確認をいただけない場合もあります。</li></ul><p><strong>目次</strong>  </p><ul><li>はじめに  </li><li>診断ログとは  </li><li>診断ログ設定の事前準備  </li><li>診断ログの設定方法  </li><li>診断ログよりメンテナンスの形跡を確認する方法  </li><li>最後に  </li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure の サイト間 VPN (S2S VPN) をご利用いただいているお客様より、一時的に S2S VPN の切断が発生したというお問い合わせをいただくことがあります。<br>インターネットを経由して接続される S2S VPN の切断は様々な要因によって発生致しますが、VPN ゲートウェイに対して行われるメンテナンスもその主たる要因の一つです。<br>VPN ゲートウェイでは健全なサービス運用及び品質維持のため、不定期にメンテナンスが行われ、この作業は数十秒から数分程度の一時的な S2S VPN の切断を伴う場合があります。<br>VPN ゲートウェイに対するメンテナンスについては事前通知が行われておらず、残念ながら計画された予定を把握いただくことはできません。<br>一方で、ご利用いただいている S2S VPN において一時的な切断を検知する度に、それがメンテナンスによるものか否かをサポートにお問い合わせいただくのは、大変お手間かと思います。  </p><p>そこで今回は、お客様自身で VPN ゲートウェイにメンテナンスが行われたことを確認する方法をご紹介いたします。<br>VPN ゲートウェイのメンテナンスには多岐にわたる種類があり、全てのメンテナンスを事後確認できるわけではないのですが、一部でもお客様自身でご確認をいただければご負担も減ると思いますのでご一読ください。</p><h2 id="診断ログとは"><a href="#診断ログとは" class="headerlink" title="診断ログとは"></a>診断ログとは</h2><p>VPN ゲートウェイのメンテナンスの形跡を確認するためには、対象のリソースに対して診断ログという機能を有効にします。<br>診断ログは Azure で提供される様々なサービスにおいて利用することが可能で、主に特定のリソースに関わるイベントや、そのリソースの状態を表す情報をログとして取得する機能です。<br>VPN ゲートウェイで取得できる診断ログには下記の様に複数の種類があり、欲しい情報に応じてどのログを取得するかを選択できます(複数種類のログを取得することも可能です)。  </p><ul><li><strong>GatewayDiagnosticLog</strong><br>ゲートウェイ構成イベント、主要な変更、メンテナンス イベントのリソース ログが含まれています。</li><li><strong>TunnelDiagnosticLog</strong><br>トンネルの状態変更イベントが含まれています。 トンネルの接続/切断イベントには、状態変更の理由の概要があります (該当する場合)。</li><li><strong>RouteDiagnosticLog</strong><br>ゲートウェイで発生する静的ルートへの変更および BGP イベントがログに記録されます。</li><li><strong>IKEDiagnosticLog</strong><br>ゲートウェイ上の IKE コントロールのメッセージおよびイベントがログに記録されます。</li><li><strong>P2SDiagnosticLog</strong><br>ゲートウェイ上のポイント対サイト コントロールのメッセージおよびイベントがログに記録されます。 接続ソース情報は IKEv2 接続に対してのみ提供されます。</li></ul><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log">VPN Gateway からのリソース ログ イベントにアラートを設定する</a></p><p>ご覧の通り VPN ゲートウェイ自身や S2S VPN / P2S VPN接続に関する様々な情報を取得できる診断ログですが、今回の主題であるメンテナンスの確認には、 “GatewayDiagnosticLog” という種類のログを使用します。</p><h2 id="診断ログ設定の事前準備"><a href="#診断ログ設定の事前準備" class="headerlink" title="診断ログ設定の事前準備"></a>診断ログ設定の事前準備</h2><p>診断ログは、設定時に指定したサービスに出力され、その内容を確認することができます。<br>出力先には、Log Analytics ワークスペース、ストレージアカウント、及びイベントハブが指定可能です。<br>これらの出力先を複数指定する(例えば Log Analytics ワークスペースに診断ログを出力しつつ、ストレージアカウントにも保存する)ことも可能ですが、今回は検索のし易さや出力結果の可読性を考慮して Log Analytics ワークスペースを出力先に指定する手順をご紹介します。</p><p>診断ログを設定する前に、出力先として指定する Log Analytics ワークスペースを作成しておく必要があります。<br>Log Analytics ワークスペースの作成方法は、以下の通りです。</p><ol><li>Azure ポータルより「すべてのサービス」を選択します。</li><li>「モニター」のカテゴリより、「Log Analytics ワークスペース」という項目を選択します。</li><li>「Log Analytics ワークスペース」の画面で「＋ 追加」を選択します。</li><li> Log Analytics ワークスペースの作成画面にて、サブスクリプションとリソースグループ、リソースの名称及びリージョンを指定します。</li></ol><p>(Log Analytics ワークスペース作成画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/create-log-analytics-workspace.png"></p><p>上記の手順はこちらのドキュメントで紹介されている手順 1 から手順 3 までの部分に該当致しますので、併せてご確認ください。</p><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp//azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log#set-up-alerts-in-the-azure-portal">Azure portal でアラートを設定する</a></p><h2 id="診断ログの設定方法"><a href="#診断ログの設定方法" class="headerlink" title="診断ログの設定方法"></a>診断ログの設定方法</h2><p>Log Analytics ワークスペースの作成が完了しましたので、次に仮想ネットワークゲートウェイの診断ログを設定します。<br>具体的な診断ログの設定方法は、以下の通りです。  </p><ol><li>Azure ポータルより「すべてのサービス」を選択します。</li><li>「モニター」のカテゴリより、「モニター」という項目を選択します。</li><li>「モニター」の画面で左側のペインより「診断設定」を選択します。</li><li>「診断設定」の画面にて、サブスクリプションとリソースグループを指定し、対象の VPN ゲートウェイ(仮想ネットワークゲートウェイ)を選択します。</li><li>「+ 診断設定を追加する」を選択します。</li><li>診断ログ設定自体の名称を設定し、取得したいログ(今回は最低限 “GatewayDiagnosticLog” )にチェックを入れ、出力先を指定し保存します。</li></ol><p>(診断ログ設定画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/diag-setting.png"></p><p>上記の手順はこちらのドキュメントで紹介されている手順 4 から手順 6 までの部分に該当致します。<br>Azure ポータルのスクリーンショット情報もあるので、よこちらもご参照ください。  </p><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp//azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log#set-up-alerts-in-the-azure-portal">Azure portal でアラートを設定する</a></p><p>なお、診断ログは設定を行った以後より取得が行われるため、設定を行う以前のログを遡って確認することはできない点予めご了承ください。<br>また、診断ログの設定後、実際にログの情報が取得開始されるまでには数時間程度かかる場合がございます。</p><h2 id="診断ログよりメンテナンスの形跡を確認する方法"><a href="#診断ログよりメンテナンスの形跡を確認する方法" class="headerlink" title="診断ログよりメンテナンスの形跡を確認する方法"></a>診断ログよりメンテナンスの形跡を確認する方法</h2><p>診断ログを有効化したら、 VPN ゲートウェイにおけるメンテナンスの形跡を確認する準備が整いました。<br>ここで、先の手順で診断ログの出力先に指定した Log Analytics ワークスペースより、メンテナンスの形跡を含む内容があるかを確認してみます。</p><ol><li>Azure ポータルより「すべてのサービス」を選択します。</li><li>「モニター」のカテゴリより、「Log Analytics ワークスペース」という項目を選択します。</li><li>診断ログの出力先として指定した Log Analytics ワークスペースを選択します。</li><li>「Log Analytics ワークスペース」の画面で左側のペインより「ログ」を選択します。</li><li>クエリの入力欄診断ログの内容を検索するクエリを入力の上、「時間の範囲」を S2S VPN 切断を検知した時間帯を含む値に設定し「実行」を押下します。</li></ol><p>(Log Analytics ワークスペース　クエリ実行画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/log-analytics-workspace-query.png"></p><p>入力するクエリの具体例として、下記を Log Analytics ワークスペース上で実行いただくことで、メンテナンスの情報を含む “GatewayDiagnosticLog” の内容を検索することが可能です。<br>このクエリで条件として指定している OperationName == “HostMaintenanceEvent” という部分が、メンテナンスの形跡を示すものです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where Category == &quot;GatewayDiagnosticLog&quot;</span><br><span class="line">| where OperationName == &quot;HostMaintenanceEvent&quot;</span><br><span class="line">| project TimeGenerated, Resource, OperationName, Message</span><br></pre></td></tr></table></figure><p>上記クエリの実行結果に該当する診断ログが見られる場合、メンテナンスが発生したと判断できます。<br>その場合、以下の画像のように “OperationName “ フィールドが “HostMaintenanceEvent” である実行結果が確認できます。  </p><p>(Log Analytics ワークスペース　クエリ実行結果画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/HostMaintenanceEvent.png"></p><p>なお、診断ログの内容を検索するためのクエリについては、お客様自身で適宜カスタマイズいただくことができます。<br>例えば複数の VPN ゲートウェイで診断ログを取得しているような環境で、リソース名で対象をフィルターしたい場合には、下記のように “Resource” フィールドを追加してください。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where Category == &quot;GatewayDiagnosticLog&quot;</span><br><span class="line">| where OperationName == &quot;HostMaintenanceEvent&quot;</span><br><span class="line">| where Resource == &quot;VPNGW01&quot;</span><br><span class="line">| project TimeGenerated, Resource, OperationName, Message</span><br></pre></td></tr></table></figure><p>その他、診断ログを検索する期間については Azure ポータル上からも設定できますが、クエリで日付や時間帯を指定したい場合は “TimeGenerated” フィールドでフィルターすることも可能です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where TimeGenerated &gt; datetime(&quot;2021/04/27T04:00:00&quot;) and TimeGenerated &lt; datetime(&quot;2021/04/27T06:00:00&quot;)</span><br><span class="line">| where Category == &quot;GatewayDiagnosticLog&quot;</span><br><span class="line">| where OperationName == &quot;HostMaintenanceEvent&quot;</span><br><span class="line">| project TimeGenerated, Resource, OperationName, Message</span><br></pre></td></tr></table></figure><p>このように、 S2S VPN の接続断を検知した時間帯付近の診断ログの内容を確認することで、お客様ご自身で迅速にメンテナンスの形跡を確認できますので是非ご活用ください。<br>もし今回ご紹介した方法を用いてもメンテナンスの形跡を確認できず、なおかつ S2S VPN の対向側となるお客様環境にも問題が見受けられない場合には、お気兼ねなく Azure サポートまでお問い合わせください。  </p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>最後に、メンテナンスの事後確認とは別の観点でございますが、メンテナンスによる S2S VPN への影響を最小化するために、VPN ゲートウェイを  Active / Active で運用する構成についてもご紹介いたします。</p><p>VPN ゲートウェイは内部的に 2 台インスタンスを所有しており、デフォルトではうち 1 台が Active として稼働している Active /Standby の状態で構成されます。<br>VPN ゲートウェイのメンテナンスはこの 2 台のインスタンスに対して順番に行われ、それに伴いフェイルオーバーが生じます。  </p><p>一方 Active / Active でVPN ゲートウェイを構成した場合、 2 台のインスタンスが同時に Active で稼働するため、常時 2 本の VPN トンネルが構成可能です。<br>片方のインスタンスにメンテナンスが行われている間も、もう片方のインスタンスと構成している VPN トンネルが維持されることから、メンテナンス時におけるエンドツーエンドの接続性への影響を軽減できます。  </p><p>VPN ゲートウェイの Active / Active 構成については以下ドキュメントにも記載がございますので、ご参照ください。  </p><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-highlyavailable">高可用性のクロスプレミス接続および VNet 間接続</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチームです。&lt;br&gt;今回は、Azure でお使いいただいている VPN ゲートウェイにおいて、メンテナンスが行われていたことを事後確認する方法をご紹介します。&lt;br&gt;今回ご紹介する内容については以下の前提条件の下記載されておりますので予めご了</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway 設定変更の影響</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-configchange/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-configchange/</id>
    <published>2021-07-05T05:30:00.000Z</published>
    <updated>2022-03-02T05:20:41.360Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの杜です。</p><p>Application Gateway に設定変更を行う際に既存接続(TCP コネクション)への影響についてご紹介させて頂きます。<br>SKU により動作が異なっていますので、以下にて各 SKU の詳細をご説明します。</p><h2 id="Application-Gateway-SKU-Standard-v1-amp-WAF-v1"><a href="#Application-Gateway-SKU-Standard-v1-amp-WAF-v1" class="headerlink" title="Application Gateway SKU Standard_v1 &amp; WAF_v1"></a>Application Gateway SKU Standard_v1 &amp; WAF_v1</h2><h3 id="設定変更の影響"><a href="#設定変更の影響" class="headerlink" title="設定変更の影響"></a>設定変更の影響</h3><p>基本的には既存接続に影響するような設定変更をしない限り影響はありません。</p><p>例えば、１つの Application Gateway に以下の設定が入っている場合は</p><ul><li>リスナー A → 要求ルーティング A → HTTP設定 A → バックエンド プール A, カスタム正常性プローブ A</li><li>リスナー B → 要求ルーティング B → HTTP設定 B → バックエンド プール B, カスタム正常性プローブ B</li></ul><p>任意の設定 A に対する設定変更、もしくは新規設定を追加してもリスナー B への既存接続に影響しません。</p><h3 id="影響がある場合の動作"><a href="#影響がある場合の動作" class="headerlink" title="影響がある場合の動作"></a>影響がある場合の動作</h3><p>既存接続が使用している設定を変更する場合、Application Gateway から クライアントに対して <strong>TCP RST</strong> を送信する動作だと確認しています。</p><p>例えば、リスナー A が使用している証明書を更新しますと、パケット キャプチャにて以下の動作が確認しています。</p><p>クライアント IP 192.168.0.172<br>Application Gateway パブリック IP 20.48.x.x</p><p><img src="./v1_rst.png"></p><blockquote><p>パケット レベルの詳細動作について現時点では公開ドキュメントに記載されておらず、保証される動作わけではございませんので、予めご了承ください。</p></blockquote><h2 id="Application-Gateway-SKU-Standard-v2-amp-WAF-v2"><a href="#Application-Gateway-SKU-Standard-v2-amp-WAF-v2" class="headerlink" title="Application Gateway SKU Standard_v2 &amp; WAF_v2"></a>Application Gateway SKU Standard_v2 &amp; WAF_v2</h2><h3 id="設定変更の影響-1"><a href="#設定変更の影響-1" class="headerlink" title="設定変更の影響"></a>設定変更の影響</h3><p>基本的には全般の作業がすべての既存接続に影響を与えます。<br>たとえ関連しない新規設定を追加するだけでも、既存すべてのリスナーへの TCP 接続が切断される動作となります。</p><p>例えば、１つの Application Gateway に以下の設定が入っている場合は</p><ul><li>リスナー A → 要求ルーティング A → HTTP設定 A → バックエンド プール A, カスタム正常性プローブ A</li><li>リスナー B → 要求ルーティング B → HTTP設定 B → バックエンド プール B, カスタム正常性プローブ B</li></ul><p>任意の設定 A か B に対する設定変更、もしくは新規の HTTP 設定やバックエンド プールを追加しますと、リスナー A 及び B への既存接続が切断されます。</p><h3 id="影響がある場合の動作-1"><a href="#影響がある場合の動作-1" class="headerlink" title="影響がある場合の動作"></a>影響がある場合の動作</h3><p>任意の設定が変更される場合は、Application Gateway から クライアントに対して <strong>TCP FIN</strong> を送信する動作だと確認しています。</p><p>例えば、リスナー A が使用している証明書を更新しますと、パケット キャプチャにて以下の動作が確認しています。</p><p>クライアント IP 192.168.0.172<br>Application Gateway パブリック IP 20.48.x.x</p><p><img src="./v2_fin.png"></p><blockquote><p>パケット レベルの詳細動作について現時点では公開ドキュメントに記載されていなく、保証される動作わけではございませんので、予めご了承ください。</p></blockquote><h2 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h2><h2 id="TCP-コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？"><a href="#TCP-コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？" class="headerlink" title="TCP コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？"></a>TCP コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？</h2><p>クライアントの接続設定と挙動により一概にご案内できませんが、例えば Chrome などのブラウザが再接続などによって基本的には瞬断以外の影響はないと思われますが、<br>もし少しの切断も許されないような環境でご利用の場合、メンテナンスの時間帯を設置して Application Gateway の設定変更をご実施頂きますようお願い致します。</p><h3 id="設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？"><a href="#設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？" class="headerlink" title="設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？"></a>設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？</h3><p>Azure 基盤側の処理状況によって固定ではありませんが、数十秒から数分間かかる場合は多いと見受けられます。<br>Azure ポータルから設定変更した場合は、下記のような設定変更の通知が出た後、数十秒後に接続済みの TCP コネクションが Application Gateway 側よりクローズされる動作を確認しています。<br><img src="./v2_notification.png"></p><h3 id="Application-Gateway-v2-が-KeyVault-と連携している場合では、Key-Vault-側で証明書を更新した際にも同じように瞬断などの影響を受けますか？"><a href="#Application-Gateway-v2-が-KeyVault-と連携している場合では、Key-Vault-側で証明書を更新した際にも同じように瞬断などの影響を受けますか？" class="headerlink" title="Application Gateway v2 が KeyVault と連携している場合では、Key Vault 側で証明書を更新した際にも同じように瞬断などの影響を受けますか？"></a>Application Gateway v2 が KeyVault と連携している場合では、Key Vault 側で証明書を更新した際にも同じように瞬断などの影響を受けますか？</h3><p>以下の公開ドキュメントに記載されている通り、KeyVault と連携した場合は証明書更新が検出されると Application Gateway に自動的に反映する動作となります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/key-vault-certs">Key Vault 証明書を使用した TLS 終端</a></li></ul><blockquote><p>インスタンスによって Key Vault が 4 時間間隔でポーリングされ、証明書の更新バージョン (存在する場合) が取得されます。 更新された証明書が検出されると、HTTPS リスナーに現在関連付けられている TLS または SSL 証明書が自動的にローテーションされます。</p></blockquote><p>この時に手動で証明書更新と同様な影響を受けることを確認しています。<br>そのため、既存接続に影響するタイミングをコントロールされたい場合は、証明書は手動更新にして頂きますようにお願い致します。</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチームの杜です。&lt;/p&gt;
&lt;p&gt;Application Gateway に設定変更を行う際に既存接続(TCP コネクション)への影響についてご紹介させて頂きます。&lt;br&gt;SKU により動作が異なっていますので、以下にて各 SKU の詳細をご説</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
</feed>
