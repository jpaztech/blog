<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2025-05-01T03:38:55.217Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Firewall のキャパシティに関する問題およびその原因 / 対策について</title>
    <link href="https://jpaztech.github.io/blog/network/Azure_Firewall-capacity-issue/"/>
    <id>https://jpaztech.github.io/blog/network/Azure_Firewall-capacity-issue/</id>
    <published>2025-05-01T03:39:00.339Z</published>
    <updated>2025-05-01T03:38:55.217Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Networking サポート チームの間島です。</p><p>今回は、多くの通信が Azure Firewall を経由するような大規模なシステム (例 : 万単位のユーザー数での Azure Virtual Desktop 利用など) を運用されているお客様より、特にお問い合わせいただくことが多い Azure Firewall のキャパシティに関する問題およびその原因 / 対策についてご紹介いたします。</p><p>なお、大規模なシステムにて Azure Firewall の利用を検討する際にパフォーマンス観点で考慮すべき事項につきましては、下のリンク先がお客様のご参考になるかと思いますので、まず最初にご一読いただき、弊社の担当営業にもご連絡 / ご相談ください。</p><div class="alert is-important"><p class="alert-title">重要</p><p>Azure Firewall のパフォーマンスに関するベスト プラクティス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-best-practices">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-best-practices</a></p></div><h2 id="Azure-Firewall-のキャパシティに関するお問い合わせの例"><a href="#Azure-Firewall-のキャパシティに関するお問い合わせの例" class="headerlink" title="Azure Firewall のキャパシティに関するお問い合わせの例"></a>Azure Firewall のキャパシティに関するお問い合わせの例</h2><h3 id="SNAT-ポートが枯渇する"><a href="#SNAT-ポートが枯渇する" class="headerlink" title="SNAT ポートが枯渇する"></a>SNAT ポートが枯渇する</h3><h4 id="問題"><a href="#問題" class="headerlink" title="- 問題"></a>- 問題</h4><p>Azure 内の仮想マシン (VM) や Azure Virtual Desktop (AVD) から Azure Firewall を経由するインターネットへのアクセスが増加した結果、Azure Firewall の SNAT ポートが枯渇し、VM や AVD からインターネットへのアクセスがエラーとなる。</p><h4 id="原因"><a href="#原因" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall では、下のリンク先に記載されているように、パブリック IP アドレス毎にインスタンス 1 つにつき 2,496 個の SNAT ポートを利用することが可能となっていますが、当該の Azure Firewall にてパブリック IP アドレスを 1 つしか使用していない場合には、スケールアウトによりインスタンス数が最大の 20 になった場合でも、最大 49,920 個のSNAT ポートしか利用できません。その結果、SNAT ポートを多く利用する環境の場合には、SNAT ポートの枯渇が発生する場合があります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall の既知の問題と制限事項</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues</a></p></div><h4 id="対策"><a href="#対策" class="headerlink" title="- 対策"></a>- 対策</h4><p>SNAT ポートを多く利用する環境の場合には、設計段階にてパブリック IP アドレスを 複数使用して Azure Firewall を構成することを検討してください。また通信先にて、Azure Firewall にて SNAT された後の IP アドレスのレンジにより、アクセス許可を行う要件がある場合には、通信先でのアクセス許可を簡素化するために、Azure Firewall のパブリック IP アドレスを IP アドレス プレフィックスから割り当てることをご検討ください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>パブリック IP アドレス プレフィックス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/public-ip-address-prefix">https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/public-ip-address-prefix</a></p></div><p>また、運用段階では、Azure Firewall の下記のメトリックを監視し、SNAT 枯渇が発生しないよう運用監視を行い、空きの SNAT ポートが不足した場合にはパブリック IP アドレスの追加をご検討ください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>ファイアウォールの正常性状態</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#firewall-health-state">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#firewall-health-state</a></p><p>SNAT ポート使用率</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#snat-port-utilization">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#snat-port-utilization</a></p></div><h3 id="IDPS-機能を使用すると-Azure-Firewall-を経由する通信のスループットが低下する"><a href="#IDPS-機能を使用すると-Azure-Firewall-を経由する通信のスループットが低下する" class="headerlink" title="IDPS 機能を使用すると Azure Firewall を経由する通信のスループットが低下する"></a>IDPS 機能を使用すると Azure Firewall を経由する通信のスループットが低下する</h3><h4 id="問題-1"><a href="#問題-1" class="headerlink" title="- 問題"></a>- 問題</h4><p>Azure Firewall Premium を利用しており、最大 100 Gbps のスループットを期待していたが、IDPS 機能を使用した場合のスループットが期待値より低い。</p><h4 id="原因-1"><a href="#原因-1" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall Premium にて、TLS (トランスポート層セキュリティ) 検査と IDPS (侵入検出および防止) を利用する場合には、Azure Firewall のスループットに影響を及ぼす可能性があります。Azure Firewall Premium にて IDPS 機能を「アラートを出して拒否」に設定し、TLS および IPS を使用する場合には、Azure Firewall Premium の最大スループットは 10 Gbps、単一 TCP 接続の最大スループットは 300 Mbps に低下します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall のパフォーマンス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance</a></p><p>パフォーマンス データ</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-data">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-data</a></p></div><h4 id="対策-1"><a href="#対策-1" class="headerlink" title="- 対策"></a>- 対策</h4><p>TLS (トランスポート層セキュリティ) 検査や IDPS (侵入検出および防止) を利用する場合には、設計段階にて上記の最大スループットを考慮したシステム設計を行ってください。<br>また、テスト段階において、本番環境と同様なトラフィックや、将来のユーザー数やアプリケーション数の増加を想定したトラフィックを発生させて、パフォーマンス テストを実施 / 評価してください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>パフォーマンス テスト</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-testing">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-testing</a></p></div><h3 id="Azure-Firewall-のインスタンスのスケールアウトが遅い"><a href="#Azure-Firewall-のインスタンスのスケールアウトが遅い" class="headerlink" title="Azure Firewall のインスタンスのスケールアウトが遅い"></a>Azure Firewall のインスタンスのスケールアウトが遅い</h3><h4 id="問題-2"><a href="#問題-2" class="headerlink" title="- 問題"></a>- 問題</h4><p>お客様企業の社員が業務を開始する時間帯に、Azure 内の仮想マシン (VM) や Azure Virtual Desktop (AVD) から Azure Firewall を経由するインターネットへのアクセスが急増し、Azure Firewall の CPU 使用率やスループットが上昇するが、Azure Firewall のインスタンスのスケールアウトが追随せず、VM や AVD からインターネットへのアクセスがエラーとなる。</p><h4 id="原因-2"><a href="#原因-2" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall は、平均スループットまたは CPU 消費量が 60% になるか、接続使用率が 80% になると、徐々にスケールアウトしますが、スケールアウトには 5 ～ 7 分かかります。 そのため、Azure Firewall を経由するインターネットへのアクセスが急増した場合には、Azure Firewall のスケールアウトが追随できない場合があります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall のスケールアウトにはどのくらいの時間がかかりますか。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-faq#azure-firewall--------------------------">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-faq#azure-firewall--------------------------</a></p></div><h4 id="対策-2"><a href="#対策-2" class="headerlink" title="- 対策"></a>- 対策</h4><p>設計段階では、上記のスケールアウトの動作を考慮したシステム設計を行ってください。パフォーマンス テストを行うときは、少なくとも 10 ～ 15 分のテストを行い、Azure Firewall のスケールアウトの速度がお客様のシステム要件を満たしているかどうか確認 / 評価してください。また、運用段階では、Azure Firewall の下記のメトリックを監視し、システムを利用するユーザー数の増加や、新しいアプリケーションの追加による影響を確認 / 評価してください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>AZFW 待機時間プローブ</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#azfw-latency-probe">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#azfw-latency-probe</a></p></div><h3 id="Azure-Firewall-の負荷が高いにも関わらずスケールアウトしない-インスタンスが枯渇している"><a href="#Azure-Firewall-の負荷が高いにも関わらずスケールアウトしない-インスタンスが枯渇している" class="headerlink" title="Azure Firewall の負荷が高いにも関わらずスケールアウトしない (インスタンスが枯渇している)"></a>Azure Firewall の負荷が高いにも関わらずスケールアウトしない (インスタンスが枯渇している)</h3><h4 id="問題-3"><a href="#問題-3" class="headerlink" title="- 問題"></a>- 問題</h4><p>AVD の利用ユーザーが増加したことにより、Azure Firewall のパフォーマンス系のメトリックからはインスタンス数が不足していると推測されるが、インスタンスがスケールアウトせず、AVD を利用する全ユーザーに影響が生じた。</p><h4 id="原因-3"><a href="#原因-3" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall は最大 20 インスタンスまでスケールアウトすることが可能ですが、それ以上のスケールアウトは、現時点ではサポートされておりません。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall の既知の問題と制限事項</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues</a></p></div><h4 id="対策-3"><a href="#対策-3" class="headerlink" title="- 対策"></a>- 対策</h4><p>設計段階では、上記のインスタンス数の上限を考慮したシステム設計を行ってください。なお、現時点では Azure Firewall にはインスタンス数や CPU 使用率のメトリックはないため、運用段階では「待機時間プローブ」や「スループット」のメトリック監視により代替してください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall 監視データリファレンス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference</a></p></div><p>当ブログが、お客様よりお問い合わせをいただくことが多い Azure Firewall のキャパシティ問題に関して、お客様にて設計や運用を行う際の手助けになりましたら、幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Networking サポート チームの間島です。&lt;/p&gt;
&lt;p&gt;今回は、多くの通信が Azure Firewall を経由するような大規模なシステム (例 : 万単位のユーザー数での Azure Virtual Desktop 利用など) を運用さ</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="capacity" scheme="https://jpaztech.github.io/blog/tags/capacity/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway の HTTP2 サポート</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-http2/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-http2/</id>
    <published>2025-03-21T03:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.223Z</updated>
    
    <content type="html"><![CDATA[<p>いつもお世話になっております。Azure Networking チームの庄です。<br>Application Gateway V1 のリタイアが 2026 年 4 月 28 日であると発表されてから暫く経ち、V1 をご利用のお客様の中で V2 への移行計画を進められているご状況かと思います。</p><p>※ V1 のリタイアについて詳しくは<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/v1-retirement">こちら</a></p><p>今回のブログでは Application Gateway V1 と V2 で HTTP/2 を取り扱う際の動作の違いについてご紹介します。皆様のご参考になりましたら幸いです。</p><p>HTTP/2（Hypertext Transfer Protocol version 2）は、ウェブ ページのデータをウェブ サーバーから取得するための新しい通信方法です。<br>HTTP/1.1 の後継として、2015 年に正式な仕様として承認されました。HTTP/2 には、「h2」と「h2c」の二つの識別子があります。HTTP/2 の接続が確立される際にトランスポート層セキュリティ（TLS) が利用されたかどうかによって、HTTP/2 通信には「h2」または「h2c」識別子が表示されます。つまり、HTTP/2 の識別子を通じて、HTTP/2 通信が暗号化されているかどうかを判断することができます。</p><p>・識別子が “h2” となっている場合、それは HTTP/2 通信が TLS を使用するプロトコルであることを示しています。</p><p>・識別子が “h2c” となっている場合、HTTP/2 通信が TLS を使用しません。この際、クライアントは HTTP/2 通信に “Upgrade” ヘッダーと “HTTP2-Settings” ヘッダーを送信します。”Upgrade” ヘッダーの値は「h2c」が設定され、”HTTP2-Settings” ヘッダーの値はトークン（例: AAMAAABkAAQCAAAAAAIAAAAA）が設定されます。</p><p><a href="https://datatracker.ietf.org/doc/html/rfc9113#section-3.1">HTTP/2 の関連記事 (英語)</a></p><blockquote><p>The “h2c” string was previously used as a token for use in the HTTP Upgrade mechanism’s Upgrade header field. This usage was never widely deployed and is deprecated by this document. The same applies to the HTTP2-Settings header field, which was used with the upgrade to “h2c”.</p></blockquote><p>現在、Edge や Chrome など現在主要なブラウザーでは、HTTP/2 over TLS (h2) のみが HTTP/2 として使用できます。<br><img src="./chrome check.png" alt="HAR1" style="width:800px;"/> </p><p>例えば、<a href="http://www.microsoft.com/">www.microsoft.com</a> のサイトは HTTP/2 に対応していますが、 <a href="http://www.microsoft.com/">www.microsoft.com</a> に HTTPS ではなく HTTP で接続する場合、<br>ブラウザーが HTTP/2 over TCP (h2c) をサポートしていないため、HTTP/2 は使用されず、HTTP/1.1 で接続を確立します。<br>(以下のスクリーンショットの例ではその後 HTTPS の URL にリダイレクトされ、HTTP/2 over TLS (h2)で接続しています。)</p><img src="./httpyahoo.png" alt="HAR2" style="width:800px;"/> <img src="./yahoo.png" alt="HAR3" style="width:800px;"/> <p>なお、ブラウザからのアクセスではなく、curl コマンドなどの他の HTTP クライアントから HTTP リクエストを送信する際には、HTTP/2 over TCP (h2c) を利用して HTTP/2 通信が行われる可能性があります。この状況では、Application Gateway が接続先となる際に、v1 と v2 で動作が異なります。v1 の場合、HTTP/2 通信はダウングレードされて、v2 の場合は HTTP ステータスコード 403 が応答されます。詳細の動作つきましては、以下のセクションをご参照ください。</p><h1 id="Application-Gateway-のサポートに"><a href="#Application-Gateway-のサポートに" class="headerlink" title="Application Gateway のサポートに"></a>Application Gateway のサポートに</h1><p>Application Gateway はリバース プロキシとして動作するため、フロントエンド接続（クライアント - Application Gateway）とバックエンド接続（Application Gateway - バックエンド サーバー）の二つの接続が発生します。現在、バックエンド接続における HTTP/2 はサポートされておりません。</p><p>フロントエンド接続における HTTP/2 のサポート状況については、リスナーで利用しているプロトコルによって異なります。詳細は以下のテーブルをご参照いただけますと幸いです。</p><table><thead><tr><th>リスナーのプロトコル</th><th>サポート状況</th></tr></thead><tbody><tr><td>HTTPS</td><td>サポート</td></tr><tr><td>HTTP</td><td>非サポート</td></tr></tbody></table><p>一般的なシナリオとして、HTTP/2 over TLS (h2) が使用されるため、Application Gateway でも HTTP/2 over TLS (h2) のみを考慮しています。そのため、Application Gateway では、HTTPS リスナーでのみ HTTP/2 をサポートしています。v1、v2 ともに HTTP リスナーでは HTTP/2 の通信をサポートしていませんが、HTTP リスナーに対して実際にクライアントから HTTP/2 通信を送信する際には、SKU によって動作が異なります。以下にそれぞれの SKU の動作について紹介します。</p><h3 id="v1-の動作"><a href="#v1-の動作" class="headerlink" title="v1 の動作"></a>v1 の動作</h3><p>v1 の HTTP リスナーに HTTP/2 を用いて送信すると、通信がダウングレードされ、Application Gateway は HTTP/1.1 でレスポンスを送信します。</p><p>v1 の HTTP リスナーに HTTP/2 リクエストを curl コマンドで送信した結果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root:/# curl -v http://&lt;v1 Appgw の IP&gt; --http2</span><br><span class="line">*   Trying xxxxxx:80...</span><br><span class="line">* Connected to xxxx port 80 (#0)</span><br><span class="line">&gt; GET / HTTP/1.1</span><br><span class="line">&gt; Host: xxxxxx</span><br><span class="line">&gt; User-Agent: curl/7.81.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; Connection: Upgrade, HTTP2-Settings</span><br><span class="line">&gt; Upgrade: h2c</span><br><span class="line">&gt; HTTP2-Settings: AAMAAABkAAQCAAAAAAIAAAAA</span><br><span class="line">&gt;</span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Date: Wed, 25 Dec 2024 09:09:10 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 7</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Server: Microsoft-IIS/10.0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="v2-の動作"><a href="#v2-の動作" class="headerlink" title="v2 の動作"></a>v2 の動作</h3><p>v2 の場合は、HTTP リスナーに HTTP/2 を送信すると、Application Gateway はクライアントに 403 を応答します。</p><p>v2 の HTTP リスナーに HTTP/2 リクエストを curl コマンドで送信した結果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root: curl --http2 -v -k http://&lt;v2 Appgw の IP&gt;</span><br><span class="line">*   Trying xxxx:80...</span><br><span class="line">* Connected to xxxx (xxxx) port 80 (#0)</span><br><span class="line">&gt; GET / HTTP/1.1</span><br><span class="line">&gt; Host: xxxx</span><br><span class="line">&gt; User-Agent: curl/7.81.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; Connection: Upgrade, HTTP2-Settings</span><br><span class="line">&gt; Upgrade: h2c</span><br><span class="line">&gt; HTTP2-Settings: AAMAAABkAAQCAAAAAAIAAAAA</span><br><span class="line">&gt;</span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP/1.1 403 Forbidden</span><br><span class="line">&lt; Server: Microsoft-Azure-Application-Gateway/v2</span><br><span class="line">&lt; Date: Wed, 25 Dec 2024 08:51:52 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 179</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;Microsoft-Azure-Application-Gateway/v2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection #0 to host xxxx left intact</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上記の HTTP リスナーに HTTP/2 を送信した通信結果を、Application Gateway で設定可能な診断ログの 1 つであるアクセス ログから対象の通信結果を確認すると、「httpStatus」のプロパティには 403 が記載され、「serverStatus」のプロパティには 403 以外の別のステータスコードが記載されます。こちらは想定されているログの記録結果です。</p><p>また、このブロックは Application Gateway V2 自体のコード レベルでの動作であり、WAF を利用していない場合でも同様に HTTP 403 を返す動作となります。つまり、Application Gateway v2 は WAF の利用の有無にかかわらず HTTP リスナーで受け取った HTTP/2 通信をブロックすることが想定された動作となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;いつもお世話になっております。Azure Networking チームの庄です。&lt;br&gt;Application Gateway V1 のリタイアが 2026 年 4 月 28 日であると発表されてから暫く経ち、V1 をご利用のお客様の中で V2 への移行計画を進められている</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>NSG フローログ から VNet フローログ への移行についてよくある質問</title>
    <link href="https://jpaztech.github.io/blog/network/migration-from-NSG-Flowlog-to-Vnet-Flowlog/"/>
    <id>https://jpaztech.github.io/blog/network/migration-from-NSG-Flowlog-to-Vnet-Flowlog/</id>
    <published>2025-02-26T00:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.267Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>2027 年 9 月 30 日にネットワーク セキュリティ グループ (NSG) フローログが廃止され、2025 年 6 月 30 日以降新しい NSG フロー ログが作成できなくなるため、VNet フロー ログへ移行いただくことを推奨する内容がアナウンスされました。(Tracking ID:4NBJ-DQ0)<br>アナウンスされてから半年ほど経過いたしましたので、VNet フロー ログへの移行に際する概要およびよくある質問についてこの記事にてご紹介させていただきます。</p><h2 id="アナウンスの概要"><a href="#アナウンスの概要" class="headerlink" title="[アナウンスの概要]"></a>[アナウンスの概要]</h2><p>2027 年 9 月 30 日にネットワーク セキュリティ グループ (NSG) フロー ログが廃止され、2025 年 6 月 30 日以降新しい NSG フロー ログが作成できなくなります。<br>提供終了日 (2027 年 9 月 30 日) を過ぎると、NSG フロー ログで有効になっているトラフィック分析がサポートされなくなり、サブスクリプション内の既存の NSG フロー ログ リソースが削除されるため、NSG のフロー ログの廃止に伴い、VNet フロー ログへの移行を推奨しております。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/nsg-flow-logs-overview">ネットワーク セキュリティ グループのフローのログ記録</a></p><blockquote><p>重要 <br><br>2027 年 9 月 30 日にネットワーク セキュリティ グループ (NSG) フロー ログは廃止されます。 この提供終了の一環として、2025 年 6 月 30 日以降新しい NSG フロー ログを作成できなくなります。<br>NSG フロー ログの制限を克服するために、仮想ネットワーク フロー ログに移行することをお勧めします。<br>提供終了日を過ぎると、NSG フロー ログで有効になっているトラフィック分析がサポートされなくなり、サブスクリプション内の既存の NSG フロー ログ リソースが削除されます。<br>ただし、NSG フロー ログのレコードは削除されず、引き続きそれぞれのアイテム保持ポリシーに従います。 詳細については、公式告知を参照してください。</p></blockquote><h2 id="NSG-フロー-ログと-VNet-フロー-ログの違い"><a href="#NSG-フロー-ログと-VNet-フロー-ログの違い" class="headerlink" title="[NSG フロー ログと VNet フロー ログの違い]"></a>[NSG フロー ログと VNet フロー ログの違い]</h2><p>フロー ログは、ネットワーク トラフィックの監視と分析に使用される Network Watcher の機能の 1 つとして提供しているロギング サービスです。ネットワーク セキュリティ グループ (NSG) で設定したセキュリティ ルールの評価や仮想ネットワーク (VNet) 内のトラフィックを監視し、NSG で許可されたトラフィックと拒否されたトラフィックを記録することが可能です。今までは Subnet や NIC のみでしかログの採取ができませんでしたが、VNet フロー ログの登場によって、VNet 単位でのログを採取することが可能となりました。NSG フロー ログと VNet フロー ログの違いについて完結にお伝えすると、VNet フロー ログは、NSG フロー ログの上位互換にあたる機能となりますが、具体的な違いについては以下の表をご覧ください。</p><table><thead><tr><th>機能の違い</th><th>NSG フロー ログ</th><th>Vnet フロー ログ</th></tr></thead><tbody><tr><td>フロー ログを取得できる対象範囲 (ターゲット)</td><td>Subnet/NIC</td><td>VNet/Subnet/NIC</td></tr><tr><td>ログ形式</td><td><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/vnet-flow-logs-overview#log-format">ログ形式</a><br><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/vnet-flow-logs-overview#sample-log-record">サンプル ログ レコード</a></td><td><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/nsg-flow-logs-overview#log-format">ログ形式</a><br><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/nsg-flow-logs-overview#sample-log-records">サンプル ログ レコード</a></td></tr><tr><td>トラフィック分析のスキーマ</td><td><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/traffic-analytics-schema?tabs=nsg#traffic-analytics-schema">トラフィック分析スキーマ</a></td><td><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/traffic-analytics-schema?tabs=vnet#traffic-analytics-schema">トラフィック分析スキーマ</a></td></tr><tr><td>ストレージ アカウント</td><td><code>https//&#123;storageAccountName&#125;@insights-logs-networksecuritygroupflowevent</code> のパス内に保存</td><td><code>https://&#123;storageAccountName&#125;@insights-logs-flowlogflowevent</code> のパス内に保存</td></tr><tr><td>Log Analytics Workspace</td><td>“AzureNetworkAnalytics_CL” テーブルに保存</td><td>“NTANetAnalytics” テーブルに保存</td></tr><tr><td>NSG フロー ログではサポートされず、<br>VNet フロー ログではサポートされたシナリオ</td><td>右記が非サポート シナリオ</td><td>ステートレス フロー内のバイトとパケット<br>仮想ネットワーク暗号化の識別(VNet Encryption)<br>Azure API マネージメント<br>Application Gateway<br>Virtual Network Manager<br>ExpressRoute Gateway<br>Virtual Machine scale sets<br>VPN Gateway<br>Azure VM (D family v6 series)<br>Azure VM (E family v6 series)<br>Azure VM (F family v6 series)</td></tr><tr><td>VNet フロー ログではサポートされず、<br>NSG フロー ログではサポートされるシナリオ</td><td>なし</td><td>-</td></tr></tbody></table><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="[FAQ]"></a>[FAQ]</h2><p>Q1. 既存の NSG フロー ログのデータは削除されますか<br><br>A1. いいえ。既存の NSG フロー ログのデータは削除されません (ただしストレージ アカウントのリテンション期間に準じます)。移行前のログ (NSG フロー ログ) は保存先のストレージ アカウント内の [insights-logs-networksecuritygroupflowevent] というパスに保存され、移行後のログ (VNet フロー ログ)は [insights-logs-flowlogflowevent] というパスに保存されます。<br>また、トラフィック分析を有効化にしている場合、NSG フロー ログは [AzureNetworkAnalytics_CL] テーブル、VNet フロー ログは [NTANetAnalytics] テーブルを Log Analytics ワークスペースのクエリで確認が可能です。</p><p>Q2. NSG フロー ログから VNet フロー ログへ移行スクリプトを利用して移行した場合、既存の環境において通信影響やパフォーマンス影響はありますか<br><br>A2. いいえ。NSG フロー ログから VNet フロー ログへの移行に伴う通信影響ございません。</p><p>Q3. NSG フロー ログでトラフィック分析を有効化し、Log Analytics で独自のクエリを利用し分析を行っていましたが、VNet フロー ログでも同じクエリで分析することは可能ですか<br><br>A3. いいえ。NSG フロー ログと VNet フローログでは、トラフィック分析のスキーマが異なるため NSG フロー ログで利用していたクエリを使い回すことはできません。VNet フロー ログのスキーマを参考の上、VNet フロー ログ用のクエリを作成いただく必要があります。</p><p>(参考)<br><br><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/traffic-analytics-schema?tabs=vnet#traffic-analytics-schema">トラフィック分析スキーマ - Network Watcher | Microsoft Learn</a></p><p>Q4. NSG フロー ログから VNet フロー ログへ移行スクリプトを利用する場合の PowerShell のバージョンに指定はありますか<br><br>A4. Powershell 7 以降での動作を想定しております。 Powershell 7よりも前のバージョンでスクリプトを実行した場合、スクリプトの実行に失敗することが想定されます。Powershell のバージョンは $PSVersionTable を実行いただくことで確認可能です。</p><p>Q5. 移行スクリプト (MigrationFromNsgToAzureFlowLogging.ps1) を実行した際に選択できる、”Proceed with migration with aggregation” (集計あり) と “Proceed with migration without aggregation” (集計なし) の違いはなんですか<br><br>A5. “Proceed with migration with aggregation” は、同じ VNet 内の NIC/Subnet に関連付けられている NSG の NSG フロー ログを 1 つの VNet フロー ログにまとめて、移行する方法です。例えば、VNetA 内に Subnet-1、NIC1 があり、それぞれに NSG が関連付けられており、NSG フロー ログを設定している場合 (NSG フロー ログが 2 つ設定されている) は、VNetA をターゲットとした VNet フロー ログが 1 つ作成されます。<br>一方で、”Proceed with migration without aggregation” は、同じ VNet 内の Subnet/NIC の NSG の NSG フロー ログを VNet フロー ログと 1:1 対応する形で移行する方法です。例えば、 VNetA 内に Subnet-1、NIC1 があり、それぞれに NSG が関連付けられており、NSG フロー ログを設定している場合 (NSG フロー ログが 2 つ設定されている) は、Subnet と NIC をターゲットとした VNet フロー ログが 1 つずつ作成されます。(現在有効化されている NSG フロー ログの数だけ VNet フロー ログが作成されます。)<br>なお、移行元に複数の NSG フローログが構成されている環境において “Proceed with migration with aggregation” で移行する場合、NSG フローログごとの設定値 (i.e. 出力先のストレージアカウントやリテンション期間、Traffic Analytics の有無、FlowLog Version)が異なると 1 つの VNet フローログにまとめられない動作になりますことをご留意ください。<br>仮に異なる設定値を持った状態で “Proceed with migration with aggregation” を選択した場合、同じ設定を持った NSG フローログは VNet フローログにまとめられ、異なる設定を持った NSG フローログは “Proceed with migration without aggregation” と同様に 1:1 対応する形で移行される動作となります。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/nsg-flow-logs-migrate#run-migration-script">移行スクリプトを実行する - Network Watcher | Microsoft Learn</a></p><blockquote><p>フロー ログを移行するネットワーク セキュリティ グループが同じ仮想ネットワーク内の 3 つのネットワーク インターフェイスに関連付けられている場合は、集計ありの移行を選択して 1 つの仮想ネットワーク フロー ログ リソースを仮想ネットワークに適用することができます。 <br><br>また、集計なしの移行を選択し、3 つの仮想ネットワーク フロー ログ (ネットワーク インターフェイスごとに 1 つの仮想ネットワーク フロー ログ リソース) を持つこともできます。</p></blockquote><p>Q6. 移行の種類、”Proceed with migration with aggregation” (集計あり) と “Proceed with migration without aggregation” (集計なし) の選び方が分かりません<br><br>A6. フロー ログの保存先をサブネットや NIC ごとに別のストレージ アカウントにしたい場合や、ログの対象を特定のサブネットや NIC のみに限定したい場合は、”Proceed with migration without aggregation” (集計なし) を選択し移行いただく必要があります。</p><p>Q7. NSG フロー ログを有効化しており、トラフィック分析も有効化していますが、VNet フロー ログ移行後はトラフィック分析を無効化したいと考えています。移行スクリプトのオプションでトラフィック分析を無効化することはできますか<br><br>A7. いいえ。移行スクリプトでは、既存の NSG フロー ログの設定を引き継ぐ形で VNet フロー ログが作成されます。トラフィック分析を無効化したい場合、移行前にトラフィック分析を無効化いただく、もしくは移行後にトラフィック分析を無効化いただく必要があります。</p><p>Q8. 移行スクリプト (MigrationFromNsgToAzureFlowLogging.ps1) を実行した際に VNet フロー ログの名称は指定できますか<br><br>A8. いいえ、移行スクリプトを用いた移行では VNet フロー ログの名称が自動的に指定されるため明示的に名称を指定することはできません。明示的に名称を指定したい場合、VNet フロー ログを新規で作成いただく必要があります。<br>自動的に指定される名称は、移行の種類 (“Proceed with migration with aggregation”/“Proceed with migration without aggregation”) によって命名規則が異なります。<br><br>“Proceed with migration with aggregation” の場合、&lt;Subnet や NIC が属する VNet 名&gt; “-“ &lt;リソースグループ名&gt; “-“ flowlog の命名規則で VNet フロー ログが作成されます。<br><br>“Proceed with migration without aggregation” の場合、&lt;NIC 名/ Subnet 名&gt; “-“ &lt;リソースグループ名&gt; “-“ flowlog の命名規則で VNet フロー ログが作成されます。</p><p>Q9. 2025 年 6 月 30 日以降に既存の NSG フローログの設定変更はできますか<br><br>A9. はい。2025 年 6 月 30 日以降、新規の NSG フローログは作成不可となりますが、既存の NSG フローログの設定変更は可能です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;2027 年 9 月 30 日にネットワーク セキュリティ グループ (NSG) フローログが廃止され、2025 年 6 月 30 日以降新しい NSG フロー ログが作成できなくなるため、VNet </summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Network Watcher" scheme="https://jpaztech.github.io/blog/tags/Network-Watcher/"/>
    
    <category term="NSG Flow Log" scheme="https://jpaztech.github.io/blog/tags/NSG-Flow-Log/"/>
    
    <category term="Vnet Flow Log" scheme="https://jpaztech.github.io/blog/tags/Vnet-Flow-Log/"/>
    
  </entry>
  
  <entry>
    <title>Virtual WAN の相互接続性について</title>
    <link href="https://jpaztech.github.io/blog/network/vwan_transit/"/>
    <id>https://jpaztech.github.io/blog/network/vwan_transit/</id>
    <published>2025-01-08T03:30:00.000Z</published>
    <updated>2025-05-01T03:38:55.287Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>この記事では、Virtual WAN の仮想ハブに接続した各環境 (VNet/ブランチ (サイト間 VPN、ポイント対サイト VPN、ExpressRoute)) における相互接続について紹介いたします。<br>従来の仮想ネットワーク環境と比べ、どのようなケースに Virtual WAN の導入が適しているか、ご判断の助けになれば幸いです。</p><h2 id="Virtual-WAN-の相互接続性について"><a href="#Virtual-WAN-の相互接続性について" class="headerlink" title="Virtual WAN の相互接続性について"></a>Virtual WAN の相互接続性について</h2><p>Virtual WAN は仮想ハブというコンポーネントを中心としており、この仮想ハブに対して様々な環境を接続することができます。<br>仮想ハブに対して接続する主な環境は、仮想ネットワークと、ブランチと呼ばれるオンプレミス環境です。<br>この “ブランチ” については、Virtual WAN 内の仮想ハブに接続するオンプレミス環境をまとめた総称であり、具体的な接続パターンは以下の様なものがあります。  </p><ul><li>サイト間 VPN (S2S VPN)</li><li>ポイント対サイトユーザー VPN (P2S VPN)</li><li>ExpressRoute</li></ul><p>※ その他、仮想ハブと Vnet 上の仮想アプライアンス間で直接 BGP ピアを構成したり、仮想ハブ上に所定のパートナーが提供するアプライアンス製品やサービスをデプロイし SD-WAN 環境を構成するといったことも可能ですが、今回の記事ではよくご利用いただく、仮想ネットワークとブランチ (サイト間 VPN、ポイント対サイト VPN、ExpressRoute) 接続のパターンにフォーカスしたいと思います。</p><p>Virtual WAN では、仮想ネットワークやブランチを仮想ハブに接続することで、複雑な操作を伴わずにそれぞれの環境間を相互接続させるということをコンセプトにしております。<br>上述したような仮想ネットワーク/ブランチ (サイト間 VPN、ポイント対サイト VPN、ExpressRoute) の接続については、一部条件付きのケースもございますが、基本的に Virtual WAN によって相互接続させることが可能です。<br>Virtual WAN の相互接続性については、以下の公式ドキュメントにも言及がありますので、併せてご参照ください。</p><p>(参考)<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-wan/virtual-wan-global-transit-network-architecture">グローバル トランジット ネットワーク アーキテクチャと Virtual WAN</a></p><h2 id="各接続パターンについて"><a href="#各接続パターンについて" class="headerlink" title="各接続パターンについて"></a>各接続パターンについて</h2><p>Virtual WAN 環境と仮想ネットワーク環境における相互接続性の差をわかりやすく示すため、まずは概要として簡単な表を以下に記載しております。</p><p>この表では、縦軸と横軸に記載された環境間での相互接続可否を示しており、記号はそれぞれ以下の意味を表します。  </p><ul><li>〇については相互接続が可能となるよう構成可能  </li><li>×については相互接続が可能となる構成が非サポート  </li><li>△については相互接続可能となるよう構成可能であるが、特定のオプションや別サービスの利用が伴うため考慮が必要  </li></ul><p>※ 本記事では詳細な構成及び設定の方法については割愛いたしますが、〇と表記しているケースでも構成によっては相互接続が可能とならないケースもある点ご了承ください。</p><p>また、縦軸と横軸において省略して記載している各表記は、以下を示しております。</p><ul><li>VNet = 仮想ネットワーク環境</li><li>S2S = サイト間 VPN で接続されたオンプレミス拠点</li><li>P2S =  ポイント対サイト VPN で接続されたクライアント端末</li><li>ExpressRoute = ExpressRoute 回線で接続されたオンプレミス拠点</li></ul><h4 id="仮想ネットワーク環境の場合"><a href="#仮想ネットワーク環境の場合" class="headerlink" title="仮想ネットワーク環境の場合"></a>仮想ネットワーク環境の場合</h4><p><img src="/blog/network/vwan_transit/vwan_transit_1.png" alt="img1"></p><h4 id="Virtual-WAN-環境の場合"><a href="#Virtual-WAN-環境の場合" class="headerlink" title="Virtual WAN 環境の場合"></a>Virtual WAN 環境の場合</h4><p><img src="/blog/network/vwan_transit/vwan_transit_2.png" alt="img2"></p><p>以下では、各接続パターンにおいてどのような相互接続が可能となるか、通常の仮想ネットワーク環境とも比較しながらもう少し詳しく見ていこうと思います。</p><h3 id="S2S-to-S2S"><a href="#S2S-to-S2S" class="headerlink" title="S2S to S2S"></a>S2S to S2S</h3><p>仮想ハブ上の VPN ゲートウェイには複数のサイト間 VPN を接続可能ですが、サイト間 VPN で接続された拠点同士で相互接続ができるように構成することが可能です。<br><img src="/blog/network/vwan_transit/vwan_transit_3.png" alt="img3"></p><p>従来の仮想ネットワーク環境でも、同様に複数のサイト間 VPN で接続された拠点間の相互接続 (トランジット接続) ができるように構成することが可能です。</p><p>(参考)<br><a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-vpn-faq#does-azure-vpn-gateway-support-bgp-transit-routing">VPN Gateway に関する FAQ - Azure VPN Gateway では、BGP トランジット ルーティングをサポートしていますか。</a></p><h3 id="P2S-to-S2S"><a href="#P2S-to-S2S" class="headerlink" title="P2S to S2S"></a>P2S to S2S</h3><p>ポイント対サイトユーザー VPN のクライアントから、サイト間 VPN の接続先拠点にアクセスすることが可能です。<br><img src="/blog/network/vwan_transit/vwan_transit_4.png" alt="img4"></p><p>従来の仮想ネットワーク環境でも、ポイント対サイト VPN のクライアントからサイト間 VPN の接続先拠点にアクセスできるよう構成することは可能です。</p><p>(ご参考)<br><a href="https://learn.microsoft.com/ja-jp/Azure/vpn-gateway/vpn-gateway-about-point-to-site-routing">ポイント対サイト VPN ルーティングについて</a><br>※ ポイント対サイトユーザー VPN で利用するプロトコルや、接続端末の OS 種別によっては、カスタムルートの構成やゲスト OS 内でのルート設定といった追加作業が必要になる場合もございます。</p><h3 id="S2S-to-ExpressRoute"><a href="#S2S-to-ExpressRoute" class="headerlink" title="S2S to ExpressRoute"></a>S2S to ExpressRoute</h3><p>このシナリオは、通常の仮想ネットワーク環境と比較し、Virtual WAN 環境で容易に構成できることが大きな特徴です。<br>まず、Virtual WAN 環境では、サイト間 VPN と ExpressRoute 回線を仮想ハブに接続するのみで、相互に疎通させることが可能です。<br><img src="/blog/network/vwan_transit/vwan_transit_5.png" alt="img5"></p><p>従来の仮想ネットワーク環境でも、サイト間 VPN と ExpressRoute 用の仮想ネットワークゲートウェイを同じ仮想ネットワークに共存させて同時にオンプレミス拠点と接続することはできますが、既定の構成のままでは各拠点間の相互接続を行うことはできません。<br>仮想ネットワーク環境でサイト間 VPN と ExpressRoute に接続された拠点間でトランジット通信を実現したい場合、Azure Route Server という別のリソースを追加で構成し、各仮想ネットワークゲートウェイと BGP による経路交換を行う必要があります。</p><p>(参考)<br><a href="https://learn.microsoft.com/ja-jp/azure/route-server/expressroute-vpn-support">ExpressRoute と Azure VPN に対する Azure Route Server のサポート</a></p><p>このように、通常の仮想ネットワーク環境では更に別のサービスを構成してトランジット通信を実現する必要があるほか、VPN 用仮想ネットワークゲートウェイの構成やパラメーター、ゲートウェイサブネットのサイズ等に一定の制約が生じるなど、様々な考慮事項が生じます。<br>Virtual WAN 環境では上記のような別リソースの構成は伴わず、仮想ハブ上のゲートウェイにサイト間 VPN と ExpressRoute 回線の接続を構成すれば、基本的には既定の構成で拠点間の相互通信を実現することができます。</p><h3 id="P2S-to-ExpressRoute"><a href="#P2S-to-ExpressRoute" class="headerlink" title="P2S to ExpressRoute"></a>P2S to ExpressRoute</h3><p>OpenVPN プロトコルで接続したポイント対サイトユーザー VPN のクライアントから、ExpressRoute の接続先拠点にアクセスすることも可能です。<br><img src="/blog/network/vwan_transit/vwan_transit_6.png" alt="img6"></p><p>従来の仮想ネットワーク環境では、前述の Azure Route Server を利用したとしても、P2S VPN の接続クライアントから ExprsesRoute 接続先拠点へのトランジット接続は非サポートとなります。  </p><p>(参考)<a href="https://learn.microsoft.com/ja-jp/azure/route-server/route-server-faq#can-azure-route-server-provide-transit-between-expressroute-and-a-point-to-site-p2s-vpn-gateway-connection-when-enabling-the-branch-to-branch">Azure Route Server に関してよく寄せられる質問 (FAQ)</a></p><h3 id="ExpressRoute-to-ExpressRoute"><a href="#ExpressRoute-to-ExpressRoute" class="headerlink" title="ExpressRoute to ExpressRoute"></a>ExpressRoute to ExpressRoute</h3><p><img src="/blog/network/vwan_transit/vwan_transit_7.png" alt="img7"></p><p>複数の ExpressRoute 回線で接続された拠点間のトランジット通信は、Virtual WAN 環境であっても既定の状態では不可能です。<br>以下のうちいずれかのオプション機能を利用することで、実現が可能となります。</p><ul><li>Global Reach の利用 (仮想ハブを経由することなく各 ExpressRoute 回線間で直接トラフィックが転送されます)</li><li>プライベート ルーティング ポリシーの有効化(仮想ハブに Azure Firewall を伴う、セキュリティ保護付き仮想ハブの利用が必要となります。また、有効化の際にサポートリクエストによる依頼が必要となります。) </li></ul><p>(参考)<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-wan/how-to-routing-policies#expressroute">ルーティング インテントを使用した ExpressRoute 回線間のトランジット接続</a></p><p>従来の仮想ネットワーク環境でも同様に、既定の状態では複数の ExpressRoute 回線で接続された拠点間のトランジット通信ができません。<br>実現する場合には、Global Reach を利用する必要がございます。</p><h3 id="VNet-to-Branch-S2S-P2S-ExpressRoute"><a href="#VNet-to-Branch-S2S-P2S-ExpressRoute" class="headerlink" title="VNet to Branch (S2S, P2S, ExpressRoute)"></a>VNet to Branch (S2S, P2S, ExpressRoute)</h3><p>Virtual WAN 環境では、仮想ネットワーク環境と各ブランチ (サイト間、ポイント対サイト、ExpressRoute) で接続された環境間の疎通が可能です。<br><img src="/blog/network/vwan_transit/vwan_transit_8.png" alt="img8"></p><p>同様に、従来の仮想ネットワーク環境でも、サイト間、ポイント対サイト、ExpressRoute で接続された環境との通信は可能です。<br>複数の仮想ネットワークを接続する場合は、ハブ用の仮想ネットワークを用意して各スポークと VNet ピアリングを構成した上で、ゲートウェイ転送オプションを有効化しておく必要がございます。<br>Virtual WAN 環境であれば、仮想ハブに複数の仮想ネットワークを順次接続していけば、自動的にブランチ環境との接続性を確保することができます。</p><h3 id="VNet-to-VNet"><a href="#VNet-to-VNet" class="headerlink" title="VNet to VNet"></a>VNet to VNet</h3><p>Virtual WAN 環境では、仮想ハブに接続した仮想ネットワーク同士の疎通も可能です。<br>たくさんの仮想ネットワーク間で相互接続性を確保したい時には、それぞれの仮想ネットワークを仮想ハブに接続していくことで、自動的に相互通信ができるようになります。<br><img src="/blog/network/vwan_transit/vwan_transit_9.png" alt="img9"></p><p>従来の仮想ネットワーク環境では、複数の仮想ネットワーク間は基本的に VNet ピアリングによって接続します。<br>もちろん、VNet ピアリングによって仮想ネットワーク間の通信は可能となりますが、VNet ピアリングでは基本的に直接ピアリングした先の仮想ネットワークにしかアクセスすることができません。<br>相互接続したい仮想ネットワークの数が多くなる場合、メッシュ状に VNet ピアリングを構成するか、ハブ用の仮想ネットワークを用意してルーティング用の NVA を配置するといった対処が必要となります。  </p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>この記事では、Virtual WAN 環境における各環境間の相互接続についてご紹介いたしました。<br>通常の仮想ネットワーク環境を用いるパターンと比較しますと、実現できることの違いや、同じようなトラフィックフローが実現できたとしても構成の難度や複雑性が異なってくる点がご理解いただけたのではないかと思います。<br>Virtual WAN 環境の利用をご検討いただく一助となれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;この記事では、Virtual WAN の仮想ハブに接続した各環境 (VNet/ブランチ (サイト間 VPN、ポイント対サイト VPN、ExpressRoute)) における相互接続について紹介いたします。&lt;b</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VirtualWAN" scheme="https://jpaztech.github.io/blog/tags/VirtualWAN/"/>
    
  </entry>
  
  <entry>
    <title>403 エラーが発生し Azure ストレージ アカウント内のコンテンツにアクセスできない</title>
    <link href="https://jpaztech.github.io/blog/storage/storageFirewall-403Error/"/>
    <id>https://jpaztech.github.io/blog/storage/storageFirewall-403Error/</id>
    <published>2025-01-07T06:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.339Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下・富田です。  </p><p>今回は Azure ストレージ アカウント内コンテンツへのアクセス時に 403 エラー（認証エラー）が発生した場合の、対処法をストレージファイアウォール観点でエラー事例とともにご紹介いたします。<br>403 エラーは認証エラーですので、ネットワークとしては疎通ができている状態ですが、認証によってアクセスが拒否されている状況となります。<br>本記事ではまず、ストレージ アカウント自体に備わっているファイアウォール（ネットワーク設定）の観点でトラブルシューティングのご紹介をさせていただきます。</p><hr><h2 id="ストレージ-アカウント内のコンテンツ表示における-403-エラーの表示例"><a href="#ストレージ-アカウント内のコンテンツ表示における-403-エラーの表示例" class="headerlink" title="ストレージ アカウント内のコンテンツ表示における 403 エラーの表示例"></a>ストレージ アカウント内のコンテンツ表示における 403 エラーの表示例</h2><p>アクセスを行うツールによって表示が異なりますが、いくつかスクリーンショットを交えてエラー表示の例を記載させていただきます。<br>どれも 403 エラーや Access is denied として表示され、アクセス拒否となっていることが分かります。  </p><h3 id="Azure-ポータルでストレージ-アカウントの-Blob-コンテナー内の表示、およびストレージブラウザーで-Blob-や-Azure-Files-にアクセスした際"><a href="#Azure-ポータルでストレージ-アカウントの-Blob-コンテナー内の表示、およびストレージブラウザーで-Blob-や-Azure-Files-にアクセスした際" class="headerlink" title="Azure ポータルでストレージ アカウントの Blob コンテナー内の表示、およびストレージブラウザーで Blob や Azure Files にアクセスした際"></a>Azure ポータルでストレージ アカウントの Blob コンテナー内の表示、およびストレージブラウザーで Blob や Azure Files にアクセスした際</h3><p><img src="/blog/storage/storageFirewall-403Error/Storage01.png" alt="This request is not authorized to perform this operation."></p><h3 id="Azure-ポータルで-Azure-Files（ファイル共有）にアクセスした際"><a href="#Azure-ポータルで-Azure-Files（ファイル共有）にアクセスした際" class="headerlink" title="Azure ポータルで Azure Files（ファイル共有）にアクセスした際"></a>Azure ポータルで Azure Files（ファイル共有）にアクセスした際</h3><p><img src="/blog/storage/storageFirewall-403Error/Storage02.png" alt="このマシンからはアクセスできないようです。このストレージ アカウントは VNet にあります。"></p><h3 id="Azure-Storage-Explorer-で-Blob-コンテナーにアクセスした際"><a href="#Azure-Storage-Explorer-で-Blob-コンテナーにアクセスした際" class="headerlink" title="Azure Storage Explorer で Blob コンテナーにアクセスした際"></a>Azure Storage Explorer で Blob コンテナーにアクセスした際</h3><p><img src="/blog/storage/storageFirewall-403Error/Storage03.png" alt="This request is not authorized to perform this operation."></p><h3 id="Azure-Storage-Explorer-で-Azure-Files（ファイル共有）にアクセスした際"><a href="#Azure-Storage-Explorer-で-Azure-Files（ファイル共有）にアクセスした際" class="headerlink" title="Azure Storage Explorer で Azure Files（ファイル共有）にアクセスした際"></a>Azure Storage Explorer で Azure Files（ファイル共有）にアクセスした際</h3><p><img src="/blog/storage/storageFirewall-403Error/Storage90.png" alt="Unable to retrieve child resources"></p><h3 id="AzCopy-コマンドにてファイルコピー時した際"><a href="#AzCopy-コマンドにてファイルコピー時した際" class="headerlink" title="AzCopy コマンドにてファイルコピー時した際"></a>AzCopy コマンドにてファイルコピー時した際</h3><p><img src="/blog/storage/storageFirewall-403Error/Storage04.png" alt="INFO: Authentication failed, it is either not correct, or expired, or does not have the correct permission / RESPONSE 403: 403 This request is not authorized to perform this operation. / ERROR CODE: AuthorizationFailure"></p><h3 id="Azure-Files（ファイル共有）を-New-PSDrive-コマンドでマウントした際"><a href="#Azure-Files（ファイル共有）を-New-PSDrive-コマンドでマウントした際" class="headerlink" title="Azure Files（ファイル共有）を New-PSDrive コマンドでマウントした際"></a>Azure Files（ファイル共有）を New-PSDrive コマンドでマウントした際</h3><p><img src="/blog/storage/storageFirewall-403Error/Storage05.png" alt="New-PSDrive : Access is denied"></p><p>これらのエラーの場合は、以下の原因によりアクセス拒否となっている可能性がございます。  </p><ul><li>ストレージ アカウント自体に備わっているファイアウォール（ネットワーク設定）によりアクセス拒否されている</li><li>データ操作の認可がされていない</li></ul><p>まずは、それぞれのアクセス制御の機能について解説させていただきます。</p><hr><h2 id="ストレージ-アカウントのファイアウォール（ネットワーク設定）とデータへの認可について"><a href="#ストレージ-アカウントのファイアウォール（ネットワーク設定）とデータへの認可について" class="headerlink" title="ストレージ アカウントのファイアウォール（ネットワーク設定）とデータへの認可について"></a>ストレージ アカウントのファイアウォール（ネットワーク設定）とデータへの認可について</h2><p>ストレージ アカウントには、特定の VNET や特定のグローバル IP アドレスからのアクセスのみを許可するといった、ファイアウォール機能が備わっております。<br>こちらのファイアウォールを有効としている場合、許可されていないクライアントからの接続では上記のような 403 エラーでアクセス拒否が発生します。  </p><p>■ご参考：Azure Storage ファイアウォールおよび仮想ネットワークを構成する<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-network-security">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-network-security</a>  </p><p>また、ファイアウォールで許可されたクライアントからのアクセスであっても、アクセス先のデータに対して適切な認可がされていない場合は、同様に 403 エラーのアクセス拒否が発生します。  </p><p>■ご参考：Azure Storage 内のデータへのアクセスを承認する<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/authorize-data-access">https://learn.microsoft.com/ja-jp/azure/storage/common/authorize-data-access</a>  </p><p>今回、本ブログ記事ではストレージ アカウントのファイアウォールの観点でのトラブルシューティングをご紹介させていただきます。  </p><hr><h2 id="ストレージ-アカウントのファイアウォールを一時的に無効化してみる"><a href="#ストレージ-アカウントのファイアウォールを一時的に無効化してみる" class="headerlink" title="ストレージ アカウントのファイアウォールを一時的に無効化してみる"></a>ストレージ アカウントのファイアウォールを一時的に無効化してみる</h2><div class="alert is-warning"><p class="alert-title">警告</p><p>一時的に全てのネットワークからの接続が許可されますので、この点についてご留意くださいませ。</p></div><p>意図せず 403 エラーでアクセス拒否となった場合、ファイアウォールによってブロックされていないかといった点を切り分けるために、一時的にファイアウォールを無効化するのが容易な手段となります。<br>ファイアウォールが元から無効であったり、ファイアウォールを無効化しても 403 エラーのアクセス拒否が継続する場合は、データ認可の問題などファイアウォールとは別の原因があると判断できます。  </p><p>以下の手順で Azure ポータルよりファイアウォールを無効化することが可能でございます。</p><ol><li>対象のストレージアカウントの画面で「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」より「すべてのネットワーク」を選択し「保存」します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage06.png"></p><p>「すべてのネットワーク」が選択されている場合、ストレージファイアウォールの設定は無効状態となります。</p><p>「すべてのネットワーク」が選択されている状態に変更が完了したら、403 エラーのアクセス拒否が解消されるか確認してください。（少し反映までに時間がかかることもございます。）<br>403 エラーのアクセス拒否が解消されていれば、ストレージファイアウォールの設定に問題があると判断できます。  </p><p>もし、このままストレージファイアウォールを無効としても運用上差し支えなければ無効の状態でご利用ください。<br>アクセス元を制限したい場合は、以下に沿ってファイアウォール有効化の設定をご確認ください。  </p><hr><h2 id="特定のパブリック-IP-アドレス（グローバル-IP-アドレス）からの接続を許可するようにファイアウォールを設定する"><a href="#特定のパブリック-IP-アドレス（グローバル-IP-アドレス）からの接続を許可するようにファイアウォールを設定する" class="headerlink" title="特定のパブリック IP アドレス（グローバル IP アドレス）からの接続を許可するようにファイアウォールを設定する"></a>特定のパブリック IP アドレス（グローバル IP アドレス）からの接続を許可するようにファイアウォールを設定する</h2><p>Azure ポータルにて以下の手順で、特定のパブリック IP アドレス（グローバル IP アドレス）からの接続を許可するようにファイアウォールを設定することが可能です。  </p><ol><li>対象のストレージアカウントの画面で「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」のクライアント端末の IP アドレスを追加し「保存」します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage10.png"></p><p>パブリック IP アドレスを指定しても上手く接続できない場合は、以下の注意点についてご確認くださいませ。</p><ul><li><a href="https://jpaztech.github.io/blog/storage/storageFirewall-accesscontroll/">接続元クライアントが Azure VM の場合は、同一リージョンのストレージ アカウントへの接続時にプライベート IP アドレスで接続するため</a>、このようなパブリック IP アドレスでの接続許可が叶いません。後述の VNET 単位の接続許可の設定をご検討ください。</li><li>クライアント IP アドレスとして表示されるのは、Azure ポータルに接続している IP アドレスです。プロキシ使用時にエンドポイントをバイパスしている際などは、Azure ポータルにアクセスしている IP アドレスとストレージ アカウントにアクセスしている IP アドレスが異なることがございます。</li><li>Express Route をご利用されており、Microsoft Peering または Public Peering を用いて Azure ストレージに接続する構成の場合、Azure ストレージに側の接続元の IP アドレスはオンプレミスのプライベート IP アドレスではなく、Microsoft Peering または Public Peering で構成したパブリック IP アドレスとなります。そのため、Express Route 経由後のパブリック IP アドレスを追加していただく必要があることをあらかじめご留意ください。</li></ul><p>アクセス許可を行いたいアクセス元の IP アドレスが分からない状態の場合、下記の通り Azure ストレージの診断設定でログを取得し、403 エラーを検知しているログより接続元クライアントの IP アドレスを特定することも可能です。  </p><hr><h2 id="ストレージ-アカウントの診断設定およびアクセス元-IP-アドレスの特定"><a href="#ストレージ-アカウントの診断設定およびアクセス元-IP-アドレスの特定" class="headerlink" title="ストレージ アカウントの診断設定およびアクセス元 IP アドレスの特定"></a>ストレージ アカウントの診断設定およびアクセス元 IP アドレスの特定</h2><p>ストレージ アカウントの診断設定を有効にすることで、ストレージにアクセスしたクライアント IP アドレスをログとして記録することが可能です。  </p><p>■ご参考：Azure Monitor の診断設定を作成する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings</a>  </p><p>具体的な診断設定によるログ採取の手順例としては、Azure Files（ファイル共有）での手順について、以下の弊社ブログ記事で解説しております。  </p><p>■ご参考：Azure Files の診断設定を試す<br><a href="https://jpaztech.github.io/blog/storage/azureFilesMonitoring">https://jpaztech.github.io/blog/storage/azureFilesMonitoring</a>  </p><p>上記は、Azure Files（ファイル共有）での例とはなっておりますが、診断設定を有効にする種類として file ではなく blob を設定すれば、同様に Blob ストレージについてもアクセスログを採取することが可能です。<br>採取されたログ内に callerIpAddress として、実際のアクセス元となるクライアントの IP アドレスが記録されますので、これによりアクセス元 IP アドレスの特定が可能でございます。  </p><hr><h2 id="特定の仮想ネットワーク（VNET）およびサブネットからのアクセスを許可する"><a href="#特定の仮想ネットワーク（VNET）およびサブネットからのアクセスを許可する" class="headerlink" title="特定の仮想ネットワーク（VNET）およびサブネットからのアクセスを許可する"></a>特定の仮想ネットワーク（VNET）およびサブネットからのアクセスを許可する</h2><p>ストレージ アカウントのファイアウォールでは、特定のパブリック IP アドレスからのアクセス許可でだけではなく、特定の VNET 上のサブネットからのアクセスを許可する設定をすることが可能です。<br>以下が Azure ポータルでその設定をする手順となります。</p><ol><li>対象のストレージアカウントの画面で「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」の「仮想ネットワーク」に許可する仮想ネットワークおよびサブネットを追加します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage07.png"></p><p>すでに利用したい仮想ネットワークがある場合は「既存の仮想ネットワークを追加する」から追加します。<br>仮想ネットワークが未作成の場合は「新しい仮想ネットワークを追加する」より作成追加してください。  </p><p>異なるサブスクリプションの仮想ネットワークを追加する場合は、「サブスクリプション」項目のプルダウンより、対象のサブスクリプション内の仮想ネットワークおよびサブネットを選択し有効化します。<br>(有効化が完了するまで最大 15 分かかる場合がございます。有効化が完了したら「追加」をクリックします。  </p><p><img src="/blog/storage/storageFirewall-403Error/Storage18.png"><br>　<br>3. 追加した仮想ネットワークおよびサブネットが表示されエンドポイントの状態が有効となっていることを確認し「保存」します。</p><p><img src="/blog/storage/storageFirewall-403Error/Storage08.png"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>ストレージファイアウォール設定で「すべてのネットワーク」と「選択されたネットワーク」の切り替えを行う場合や、登録しているサブネットが仮想ネットワーク上で一度削除され、新たに同名でサブネットが作成された場合などにより、古い情報が残存した状態となりエンドポイントの状態が「見つかりません」というようなエラーが表示されることがあります。</p><p>その場合は、一度ストレージファイアウォール「仮想ネットワーク」項目からエラーが表示されているサブネットを削除し、上述の手順で仮想ネットワークおよびサブネットの追加をお試しいただきますようお願いいたします。</p></div><p><img src="/blog/storage/storageFirewall-403Error/Storage09.png"></p><hr><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>ストレージ アカウントのファイアウォールにより許可されたクライアントから、正しく認可されたデータへアクセスがされた場合は、403 エラーのアクセス拒否は発生せず正常にアクセス可能になるものと存じます。<br>403 エラーのアクセス拒否が改善せずお困りの場合は、実施されたトラブルシューティングの内容を添えて弊社 Azure 技術サポート窓口までお問い合わせいただければ、トラブルシューティングのご支援をさせていただくことも可能でございます。  </p><p>本稿が皆様のお役に立ちましたら幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下・富田です。  &lt;/p&gt;
&lt;p&gt;今回は Azure ストレージ アカウント内コンテンツへのアクセス時に 403 エラー（認証エラー）が発生した場合の、対処法をストレージファイアウォール観点でエラー事例とともにご紹介い</summary>
      
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>Azure 仮想ハブに Azure Firewall を配置する構成について</title>
    <link href="https://jpaztech.github.io/blog/network/vwan-vhub-firewall-overview/"/>
    <id>https://jpaztech.github.io/blog/network/vwan-vhub-firewall-overview/</id>
    <published>2025-01-05T15:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.283Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>Virtual WAN では、仮想ハブと接続されている仮想ネットワーク、および各ブランチ (サイト間  VPN (S2S VPN)、ExpressRoute、およびユーザー VPN (P2S VPN)) 間の接続が可能になります。<br>(以下、この仮想ネットワークや各ブランチと仮想ハブとの接続を、「接続」と表記します。)<br>この接続において、仮想ハブ内にデプロイした Azure Firewall を経由させることができますので、ご紹介させていただきます。  </p><p><strong>目次</strong>  </p><ul><li>はじめに - セキュリティ保護付き仮想ハブとは -</li><li>セキュリティ保護付き仮想ハブをご利用いただくメリット</li><li>ルーティング インテントとルーティング ポリシーの構成方法について</li><li>ルーティング インテントとルーティング ポリシーを構成した後の通信確認例 </li><li>最後に  </li></ul><h2 id="はじめに-セキュリティ保護付き仮想ハブとは"><a href="#はじめに-セキュリティ保護付き仮想ハブとは" class="headerlink" title="はじめに - セキュリティ保護付き仮想ハブとは -"></a>はじめに - セキュリティ保護付き仮想ハブとは -</h2><p>Virtual WAN においては、上述したとおり複数の接続間で通信が可能となる反面、例えば、  </p><ul><li>ある Vnet は他の Vnet とは接続させたいがブランチとは接続させたくない  </li><li>ある Vnet は他の Vnet とは接続させたくないがブランチとは接続したい  </li></ul><p>といった、お互いに接続したい要件と接続させたくない要件が両立する場合など、仮想ハブを介した接続同士で通信制御を行いたい場合は考慮が必要となります。<br>また、各接続からインターネットに接続するにあたり、一度 Azure Firewall を経由させることで、通信のフィルターを行いたい、というご要件もあるかと存じます。  </p><p>上述したようなご要件に対応する方法として、Virtual WAN をご利用いただき、かつ仮想ハブとしてセキュリティ保護付き仮想ハブをご利用いただけます。<br>セキュリティ保護付き仮想ハブとは、ハブとスポークの構成を提供する仮想ハブとしての機能に加え、Azure Firewall の機能、<br>および Azure Firewall や Network Virtual Appliance (NVA) を経由するためのルーティング機能がセットになっている仮想ハブとなります。  </p><h2 id="セキュリティ保護付き仮想ハブを用いた構成例"><a href="#セキュリティ保護付き仮想ハブを用いた構成例" class="headerlink" title="セキュリティ保護付き仮想ハブを用いた構成例"></a>セキュリティ保護付き仮想ハブを用いた構成例</h2><p>ひとつの Virtual WAN に一つのセキュリティ保護付き仮想ハブのみをご利用いただく場合、以下のような接続形態を提供します。<br>なお、複数の仮想ハブをまたがる構成においてご利用いただくことも可能ですが、ここでは一つのセキュリティ保護付き仮想ハブのみをご利用いただいている場合を例にご説明します。  </p><h3 id="構成例-1-プライベートな通信間を-Azure-Firewall-にてフィルター"><a href="#構成例-1-プライベートな通信間を-Azure-Firewall-にてフィルター" class="headerlink" title="構成例 1. プライベートな通信間を Azure Firewall にてフィルター"></a>構成例 1. プライベートな通信間を Azure Firewall にてフィルター</h3><p>以下のような接続形態になります。  </p><blockquote><p>(各接続) - (仮想ハブ内の Azure Firewall) - (各接続)  </p></blockquote><p>■構成例 1 の図<br><img src="/blog/network/vwan-vhub-firewall-overview/diag-p2p-viaAzFw.png"></p><p>具体的には、以下のような各通信が該当します。<br>・仮想ネットワーク間の接続 (V2V)<br>・ブランチ間の接続 (B2B)<br>・ブランチと仮想ネットワーク (B2V)  </p><h3 id="構成例-2-インターネットへの通信を-Azure-Firewall-にてフィルター"><a href="#構成例-2-インターネットへの通信を-Azure-Firewall-にてフィルター" class="headerlink" title="構成例 2. インターネットへの通信を Azure Firewall にてフィルター"></a>構成例 2. インターネットへの通信を Azure Firewall にてフィルター</h3><p>以下のような接続形態になります。  </p><blockquote><p>(各接続) - (仮想ハブ内の Azure Firewall) - (インターネット)  </p></blockquote><p>■構成例 2 の図<br><img src="/blog/network/vwan-vhub-firewall-overview/diag-p2i-viaAzFw.png"></p><p>具体的には、以下の通信が該当します。<br>・仮想ネットワークからインターネットに向けた接続 (V2I)<br>・ブランチからインターネットに向けた通信において Azure Firewall を通したい場合 (B2I) (*ご参考)  </p><blockquote><p>(*ご参考)<br>こちらの構成は、以下弊サポート発行 Blog の項目「1）Virtual WAN を利用する」に記載がございますのでご参考になさってください。<br><a href="https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/#1%EF%BC%89Virtual-WAN-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B">オンプレミスからのインターネット宛ての通信を Azure 経由にする方法</a></p></blockquote><h2 id="セキュリティ保護付き仮想ハブをご利用いただくメリット"><a href="#セキュリティ保護付き仮想ハブをご利用いただくメリット" class="headerlink" title="セキュリティ保護付き仮想ハブをご利用いただくメリット"></a>セキュリティ保護付き仮想ハブをご利用いただくメリット</h2><p>上記のような接続形態は、セキュリティ保護付き仮想ハブをご利用いただかない Virtual WAN、または Virtual WAN そのものをご使用いただかなくても、ご要件次第ではありますが実現可能です。<br>では、セキュリティ保護付き仮想ハブをご利用いただくメリットは何か、というと、<br>一つ一つの接続に対してルーティングを独自に設定する必要がない、という点が挙げられます。  </p><p>セキュリティ保護付き仮想ハブをご利用いただく際、ルーティング インテントとルーティング ポリシーを構成いただくことで、ルーティング制御も自動的に行われます。<br>この構成時にご指定いただくのは、仮想ハブがひとつの構成においては  </p><p>・プライベート トラフィックを保護するか (上記 &lt;形態 1&gt; が該当します)<br>・インターネット トラフィックを保護するか (上記 &lt;形態 2&gt; が該当します)  </p><p>のいずれかとなりますが、この際にルーティングをお客様で別途設定いただく必要はなく、ルーティングの制御も含めて自動的に行われます。<br>もし、ルーティング インテントとルーティング ポリシーをご利用いただかない場合、Azure Firewall で保護したい通信はすべてお客様でルーティングの設定をしていただくことになり、構成次第では複雑な制御が必要になり、また接続が増える等の要件変更のたびに設定が必要となります。  </p><h2 id="ルーティング-インテントとルーティング-ポリシーの構成方法について"><a href="#ルーティング-インテントとルーティング-ポリシーの構成方法について" class="headerlink" title="ルーティング インテントとルーティング ポリシーの構成方法について"></a>ルーティング インテントとルーティング ポリシーの構成方法について</h2><p>ルーティング インテントとルーティング ポリシーの構成方法としては二通りの方法があり、Azure portal を介して、Virtual WAN ポータルまたは Azure Firewall Manager を使って構成できます。<br>仮想ハブ内に Azure Firewall をデプロイされている場合、どちらで実施いただいても同等となります。  </p><p>Azure Firewall が仮想ハブにデプロイされている環境において、Virtual WAN ポータルからプライベート トラフィックを構成する際の図例は以下となります。<br>対象の仮想ハブを選択し、[ルーティング] の [ルーティング ポリシー] を選択し、[プライベート トラフィック] で [Azure Firewall]、[ネクスト ホップ リソース] で、当該の Azure Firewall のリソースを選択します。  </p><p>■Virtual WAN ポータルからの構成図例<br><img src="/blog/network/vwan-vhub-firewall-overview/routing-intent-VWANportal.png"></p><p>上記、Virtual WAN ポータルからの構成後に Azure Firewall Manager を確認すると、プライベート トラフィックが Azure Firewall を経由する構成となっていることがわかります。(Send via Azure Firewall)<br>併せて、仮想ハブ間 (Inter-hub) の通信も Azure Firewall を経由することがわかります。  </p><p>■Azure Firewall Manager における表示例<br><img src="/blog/network/vwan-vhub-firewall-overview/routing-intent-AzFwManager.png"></p><h2 id="ルーティング-インテントとルーティング-ポリシーを構成した後の通信確認例"><a href="#ルーティング-インテントとルーティング-ポリシーを構成した後の通信確認例" class="headerlink" title="ルーティング インテントとルーティング ポリシーを構成した後の通信確認例"></a>ルーティング インテントとルーティング ポリシーを構成した後の通信確認例</h2><p>試しに Vnet 間の通信を行ってみると、仮想ハブ内の Azure Firewall を経由していることがわかります。<br>仮想ハブ内の Azure Firewall を経由していることの確認方法は何点か考えられますが、Azure Firewall の診断ログを確認いただけます。<br>ログを確認するには、事前に診断ログを記録するように設定いただく必要はございますが、運用管理上の観点からも推奨となります。  </p><p>■診断ログ確認画面例<br><img src="/blog/network/vwan-vhub-firewall-overview/AzFw-diaglog.png"></p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>今回は、Virtual WAN をご利用いただき Any to Any の接続を実現しつつ、かつ Azure Firewall を経由させて通信のフィルターを実現するにあたってのセキュリティ保護付き仮想ハブの概要、およびルーティング インテントとルーティング ポリシーについてご説明いたしました。<br>今回は概要ご説明のため、比較的簡易な仮想ハブ 1 つの構成についてご説明いたしましたが、さらに複雑な構成を含む、ルーティング インテントとルーティング ポリシーについての詳細は以下公開文書をご確認ください。  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-wan/how-to-routing-policies">Virtual WAN ハブのルーティング インテントとルーティング ポリシーの構成方法</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;Virtual WAN では、仮想ハブと接続されている仮想ネットワーク、および各ブランチ (サイト間  VPN (S2S VPN)、ExpressRoute、およびユーザー VPN (P2S VPN)) 間の</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Virtual WAN" scheme="https://jpaztech.github.io/blog/tags/Virtual-WAN/"/>
    
  </entry>
  
  <entry>
    <title>VirtualWAN 活用について</title>
    <link href="https://jpaztech.github.io/blog/network/vwan_intro/"/>
    <id>https://jpaztech.github.io/blog/network/vwan_intro/</id>
    <published>2024-12-25T03:30:00.000Z</published>
    <updated>2025-05-01T03:38:55.284Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure テクニカル サポート チームです。<br>この記事では Azure VirtualWAN を効果的に利用いただくためのアイデアをご提供させていただきます。</p><p>VWAN はハブ＆スポーク VNET 構成を手軽にかつ、大規模に実現することができるサービスです。<br>複数の仮想ネットワークをハブ＆スポークで接続するだけでなく、 ExpressRoute や Site-to-Site 接続によるオンプレミス接続、Point-to-Site 接続によるクライアントアクセスだけでなく、Azure Firewall や NVA を配置する等の高機能を提供することもできる、 Azure Network の最終形のようなサービスです。</p><p><img src="/blog/network/vwan_intro/vwan241225_1.png" alt="img1"></p><p>VWAN は高機能で様々なユースケースに対応することができる柔軟性がある反面、機能面、設定面が複雑でわかりにくいというご意見もございました。今回のドキュメントでは、シンプルな構成であっても VWAN を有効に活用できるケースをご紹介いたします。</p><h2 id="1-1-VWAN-アーキテクチャと特徴"><a href="#1-1-VWAN-アーキテクチャと特徴" class="headerlink" title="1.1 VWAN アーキテクチャと特徴"></a><strong>1.1 VWAN アーキテクチャと特徴</strong></h2><p>VWAN standard は１つ以上の仮想ハブ( vHUB ) を含みます。vHUB を作成すると内部的に仮想ネットワークと vHUB ルータが配置されます。その他、必要に応じて以下のリソースを配置して機能を拡張することができ、オンプレミスサイトへの接続や、セキュリティソリューションを vHUB 内にデプロイが可能です。</p><ol><li>ExpressRoute ゲートウェイ</li><li>Site-to-Site ゲートウェイ</li><li>Point-to-Site ゲートウェイ</li><li>Azure Firewall ( 以降 AzFW )</li><li>NVA ( Network Virtual Appliance ) </li></ol><p>vHUB は複数作成することができ、vHUB には VM などリソースを配置されたスポークVNET を接続します。同一 vHUB に接続する異なる VNET 上のリソースは vHUB ルータ経由で通信することができます ( VNet 間のトランジット接続 )</p><p><img src="/blog/network/vwan_intro/vwan241225_2.png" alt="img2"></p><p>また、 同一 VWAN リソース内の vHUB リソース同士はデフォルト状態で接続されており、明示的な設定なしに異なる vHUB に接続するスポーク VNET 上のリソース間で通信ができます。</p><p>VWAN を活用することで簡単に実現できる構成例<br>１．VNET ハブ＆スポーク構成<br>通常、VNET でハブ＆スポーク 構成ではハブ VNET に AzFWもしくは NVA を配置し、スポーク VNET 側では UDR を設定する必要がありますが、設定・管理の手間が発生いたします。<br>VWAN を使用する場合には vHUB がハブ VNET + AzFW/NVA の代わりとなるため、簡単かつシンプルにハブ&amp;スポーク構成を実現できます。</p><p><img src="/blog/network/vwan_intro/vwan241225_3.png" alt="img3"></p><h1 id="2-VWAN-活用例"><a href="#2-VWAN-活用例" class="headerlink" title="2. VWAN 活用例"></a><strong>2. VWAN 活用例</strong></h1><h2 id="2-1-大規模-VNET-構成例"><a href="#2-1-大規模-VNET-構成例" class="headerlink" title="2.1  大規模 VNET 構成例"></a><strong>2.1  大規模 VNET 構成例</strong></h2><p>一般的に複数 VNET 間で通信が必要になる環境では、 VNET 間をメッシュで VNET Peering するか、ハブ＆スポーク構成をとる必要があります。<br>しかしながら、どちらの方法でも設定工数が多く、また VNET 追加が発生した場合の作業が多いなど設定管理面で課題があります。</p><h3 id="構成-1-VNET-をフルメッシュで-VNET-Peering-する"><a href="#構成-1-VNET-をフルメッシュで-VNET-Peering-する" class="headerlink" title="構成 1. VNET をフルメッシュで VNET Peering する"></a><strong>構成</strong> 1. VNET をフルメッシュで VNET Peering する</h3><p><img src="/blog/network/vwan_intro/vwan241225_4.png" alt="img4"></p><p>課題点 VNET ピアリング数が多く、新たに VNET を追加する場合にも設定工数がかかる</p><h3 id="構成-2-ハブ-VNET-を作成して-AzFW-NVA-を配置し、ハブ＆スポーク構成を作る"><a href="#構成-2-ハブ-VNET-を作成して-AzFW-NVA-を配置し、ハブ＆スポーク構成を作る" class="headerlink" title="構成 2. ハブ VNET を作成して AzFW, NVA を配置し、ハブ＆スポーク構成を作る"></a><strong>構成 2. ハブ VNET を作成して AzFW, NVA を配置し、ハブ＆スポーク構成を作る</strong></h3><p><img src="/blog/network/vwan_intro/vwan241225_5.png" alt="img5"></p><p>課題点 ハブ VNET 上に AzFW, NVA が必須となり、またスポークVNET 側にはそれぞれユーザ定義ルートを設定、管理する必要がある</p><p>VirtualWAN を使用することでこれらの課題点を解決し、シンプルな運用が可能です。<br>VirtualWAN ( Standard SKU ) では標準で仮想ハブに仮想ハブルータが配置されるため、ユーザが AzFW, NVA を仮想ハブに配置する必要がなく、<br>またスポーク VNET にユーザ定義ルート設定も不要であるため、 VNET 数が多い環境への対応も容易です。</p><p><img src="/blog/network/vwan_intro/vwan241225_6.png" alt="img6"></p><h2 id="2-2-ExpressRoute-Site-to-Site-Point-to-Site-間のトランジットルーティング"><a href="#2-2-ExpressRoute-Site-to-Site-Point-to-Site-間のトランジットルーティング" class="headerlink" title="2.2. ExpressRoute, Site-to-Site, Point-to-Site 間のトランジットルーティング"></a><strong>2.2. ExpressRoute, Site-to-Site, Point-to-Site 間のトランジットルーティング</strong></h2><p>非 VirtualWAN 環境でも 1 VNET に ExpressRoute GW, VPNGW を配置し、 ExpressRoute, サイト間接続, ポイント対サイト接続することができますが、<br>ExpressRoute, サイト間接続/ポイント対サイト接続の相互接続( トランジット接続 ) はできません。<br>Azure Route Server を追加することで ExpressRoute ⇔ サイト間接続の相互接続は可能になりますが、それでも ExpressRoute ⇔ ポイント対サイト間の接続はできません。</p><p>ご参考. <a href="https://learn.microsoft.com/ja-jp/azure/route-server/expressroute-vpn-support">ExpressRoute と Azure VPN のサポート - Azure Route Server</a></p><h2 id="2-3-スポーク-VNET-間、オンプレミスサイト間の通信を強制的に-AzFW-経由させる"><a href="#2-3-スポーク-VNET-間、オンプレミスサイト間の通信を強制的に-AzFW-経由させる" class="headerlink" title="2.3. スポーク VNET  間、オンプレミスサイト間の通信を強制的に AzFW 経由させる"></a><strong>2.3. スポーク VNET  間、オンプレミスサイト間の通信を強制的に AzFW 経由させる</strong></h2><p>しばしば通信セキュリティ要件として、オンプレミスサイトと VNET 間の通信や、VNET 間の通信を AzFW を経由させたい、という要件がございます。<br>非 VirtualWAN 環境でもハブ＆スポーク VNET 構成を組むことで、通信をハブ VNET 上の AzFW を経由させることは可能ではありますが、<br>前述の通り、 スポーク VNET にユーザ定義ルート設定が必要になり煩雑な運用が発生いたします。</p><p>VirtualWAN では、セキュリティ付き仮想ハブ機能を有効にするだけで、<br>仮想ハブ上に AzFW や、その他認定された NVA を配置することができます</p><p>ご参考. <a href="https://learn.microsoft.com/ja-jp/azure/firewall-manager/secured-virtual-hub?toc=/azure/virtual-wan/toc.json&bc=/azure/virtual-wan/breadcrumb/toc.json">セキュリティ保護付き仮想ハブとは</a></p><h2 id="2-4-複数リージョンにまたがる大規模-VNET-構成"><a href="#2-4-複数リージョンにまたがる大規模-VNET-構成" class="headerlink" title="2.4 複数リージョンにまたがる大規模 VNET 構成"></a><strong>2.4 複数リージョンにまたがる大規模 VNET 構成</strong></h2><p>VirtualWAN を使用しない場合、複数ハブ VNET を接続・運用する際のルーティング設計は非常に難しくなります。<br>一方、VirtualWAN では複数 vHUB を配置することができ、ハブ間を簡単に自動で接続する機能が標準で準備されております。<br>これにより、 VirtualWAN ユーザーはスポーク VNET やハブ VNET のルーティングを意識することなく、スポークVNET間の通信が行えます。<br>vHUB はどのリージョンにも配置することができ、ハブごとにゲートウェイを配置することが可能です。<br>これにより下記２つのメリットが期待できます。</p><ul><li><p>オンプレミスサイトとの通信品質の改善<br>オンプレミスサイトとの通信でも、地理的に近いリージョンの vHUB に接続ポイントを設けることで通信遅延を低減が可能です。</p></li><li><p>リージョン障害への耐性向上<br>リージョン障害が発生し　vHUB の一つが支障した場合でも別リージョン　vHUB がオンプレミスサイトへの接続を持っていれば、<br>自動的に通信が迂回し、サービス継続させることができます。<br>例としては vHUB A, B, C が存在し、vHUB C 配下にスポーク VNET C が接続。vHUB A, B がオンプレミスサイトへの接続を持っている構成を想定します。<br>このとき vHUB A が大規模障害により停止した場合でも、スポーク VNET C は vHUB B 経由でオンプレイスサイトとの通信を継続できます。</p></li></ul><h1 id="3-まとめ"><a href="#3-まとめ" class="headerlink" title="3. まとめ"></a><strong>3. まとめ</strong></h1><p>この記事では VirtualWAN を使用するだけで簡単に実現ができる構成についてご紹介をいたしました。<br>VirtualWAN は高機能なサービスではございますが、シンプルに使用するだけでも強力なソリューションとなります。<br>今後、ご活用の機会がありましたらご検討をお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;この記事では Azure VirtualWAN を効果的に利用いただくためのアイデアをご提供させていただきます。&lt;/p&gt;
&lt;p&gt;VWAN はハブ＆スポーク V</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VirtualWAN" scheme="https://jpaztech.github.io/blog/tags/VirtualWAN/"/>
    
  </entry>
  
  <entry>
    <title>高速ネットワーク未対応・対応済・必須の VM サイズについて</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-size-accelerated-networking/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-size-accelerated-networking/</id>
    <published>2024-12-02T00:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.669Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今年も日本マイクロソフトの社員がお届けする、 <a href="https://qiita.com/advent-calendar/2024/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2024</a> が始まりました！<br>本記事は 2 日目の記事となります。 </p><p>Advent Calendar には他にも多くの Azure に関する有益な記事が公開されますので、是非ご参照くださいませ！<br>今回は、お問い合わせいただくことも多い高速ネットワーク未対応・対応済・必須の VM サイズについて解説します。  </p><hr><p>高速ネットワークはその名の通り、Azure VM のネットワークパフォーマンスを向上させるオプションです。<br>具体的なメリットや対応 OS 等の情報は以下の公式ドキュメントをご参照ください。</p><p>■ご参考：高速ネットワークの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/accelerated-networking-overview">https://learn.microsoft.com/ja-jp/azure/virtual-network/accelerated-networking-overview</a>  </p><p>Azure VM はお客様のニーズに応える様々な VM サイズをご用意しています。<br>高速ネットワークについては VM サイズによって、以下の 3 パターンのサポート状況となります。　　</p><ul><li>高速ネットワーク未対応</li><li>高速ネットワーク対応済み</li><li>高速ネットワーク必須</li></ul><p>各 VM サイズが高速ネットワークに対応しているか、必須であるかといった点については、各 VM サイズの公式ドキュメント内の記載をご参照ください。  </p><p>■ご参考：Azure の仮想マシンのサイズ<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes/overview">https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes/overview</a>  </p><p>以下にそれぞれ詳細について解説します。  </p><hr><h1 id="高速ネットワーク未対応の-VM-サイズについて"><a href="#高速ネットワーク未対応の-VM-サイズについて" class="headerlink" title="高速ネットワーク未対応の VM サイズについて"></a>高速ネットワーク未対応の VM サイズについて</h1><p>一部の古い VM サイズでは高速ネットワークに対応していないサイズがございます。<br>そのような古い VM サイズをご利用の場合は、是非高速ネットワークに対応している新しい VM サイズへの変更もご検討いただけますと幸いです。  </p><p>■ご参考：仮想マシンのサイズの変更<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes/resize-vm">https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes/resize-vm</a>  </p><p>なお、高速ネットワークを有効にした状態の別の VM サイズから、高速ネットワーク未対応の VM サイズに変更をしようとした場合、以下のように互角性が無いといった表示となります。<br>高速ネットワーク未対応の VM サイズに変更する場合は、一旦高速ネットワークに対応を無効にする必要がありますので、その点ご注意ください。  </p><p> <img src="/blog/vm/vm-size-accelerated-networking/1.png"> </p><hr><h1 id="高速ネットワーク対応済みの-VM-サイズについて"><a href="#高速ネットワーク対応済みの-VM-サイズについて" class="headerlink" title="高速ネットワーク対応済みの VM サイズについて"></a>高速ネットワーク対応済みの VM サイズについて</h1><p>記事公開時点で、多くの VM サイズは高速ネットワークに対応済みとなっています。<br>これは、高速ネットワークを無効で使っていただくことも、有効にして使っていただくことも可能な VM サイズです。  </p><hr><h1 id="高速ネットワーク必須の-VM-サイズについて"><a href="#高速ネットワーク必須の-VM-サイズについて" class="headerlink" title="高速ネットワーク必須の VM サイズについて"></a>高速ネットワーク必須の VM サイズについて</h1><p>一部の新しい VM サイズでは、高速ネットワークが「必須」として記載されているものがあります。<br>これは自動的に高速ネットワークが有効となるサイズです。  </p><p>高速ネットワーク必須の VM サイズをご利用の場合、Azure ポータル等で高速ネットワークを無効と設定したとしても、実際は高速ネットワークが有効の状態となります。<br>※Azure ポータル等では「高速ネットワーク：無効」の表示になっていたとしても、実際は有効な状態になっています。  </p><p>すなわち、高速ネットワーク無効の状態の別の VM サイズから、高速ネットワーク必須の VM サイズに変更いただくことも可能です。  </p><hr><h1 id="高速ネットワークと-VM-サイズのまとめ"><a href="#高速ネットワークと-VM-サイズのまとめ" class="headerlink" title="高速ネットワークと VM サイズのまとめ"></a>高速ネットワークと VM サイズのまとめ</h1><p>上記の内容をまとめると、以下のような形となります。  </p><table><thead><tr><th></th><th>高速ネットワークを<span style="color:red;">無効</span>に設定</th><th>高速ネットワークを<span style="color:green;">有効</span>に設定</th></tr></thead><tbody><tr><td>高速ネットワーク未対応の VM サイズ</td><td>高速ネットワークは<span style="color:red;">無効</span>となる</td><td>そもそも設定不可</td></tr><tr><td>高速ネットワーク対応済みの VM サイズ</td><td>高速ネットワークは<span style="color:red;">無効</span>となる</td><td>高速ネットワークは<span style="color:green;">有効</span>となる</td></tr><tr><td>高速ネットワーク必須の VM サイズ</td><td>高速ネットワークは<span style="color:green;">自動的に有効</span>となる</td><td>高速ネットワークは<span style="color:green;">有効</span>となる</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><hr><h1 id="高速ネットワークが有効になっているかゲスト-OS-内から確認を行う"><a href="#高速ネットワークが有効になっているかゲスト-OS-内から確認を行う" class="headerlink" title="高速ネットワークが有効になっているかゲスト OS 内から確認を行う"></a>高速ネットワークが有効になっているかゲスト OS 内から確認を行う</h1><p>高速ネットワークが有効になっているかゲスト OS 内から確認を行う手順について記載させていただきます。<br>詳細は以下のドキュメントをご確認いただきたく存じますが、簡単な確認方法としては Mellanox の NIC が増えている場合は、高速ネットワークが有効になっていると判断できます。  </p><p>■ご参考：高速ネットワークが有効になっていることを確認します。（Windows）<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/create-vm-accelerated-networking-cli?tabs=windows#confirm-that-accelerated-networking-is-enabled">https://learn.microsoft.com/ja-jp/azure/virtual-network/create-vm-accelerated-networking-cli?tabs=windows#confirm-that-accelerated-networking-is-enabled</a>  </p><p>■ご参考：高速ネットワークが有効になっていることを確認します。（Linux）<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/create-vm-accelerated-networking-cli?tabs=linux#confirm-that-accelerated-networking-is-enabled">https://learn.microsoft.com/ja-jp/azure/virtual-network/create-vm-accelerated-networking-cli?tabs=linux#confirm-that-accelerated-networking-is-enabled</a>  </p><p>高速ネットワークが正常に有効になっている Windows の場合はデバイス マネージャーにて以下の例のように、Mellanox の NIC があることが確認できます。<br>なお、Mellanox の名前が ConnectX-4 Lx 以外の場合もあります。  </p><p> <img src="/blog/vm/vm-size-accelerated-networking/2.png"> </p><p>高速ネットワークが正常に有効になっている Linux の場合は、「ip a」コマンドで NIC を表示すると、IP アドレスが付与されていない NIC があることが確認できます。</p><p> <img src="/blog/vm/vm-size-accelerated-networking/3.png"> </p><hr><p>今回の内容は以上となります。<br>上記の記事が皆様のお役に立てますと幸いでございます。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今年も日本マイクロソフトの社員がお届けする、 &lt;a href=&quot;https://qiita.com/advent-calendar/2024/microsoft-azure-tech&quot;&gt;Microsof</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Azure プライベート DNS ゾーンに関するベスト プラクティス及びよくあるお問合せ</title>
    <link href="https://jpaztech.github.io/blog/network/private-dns-zone-faq/"/>
    <id>https://jpaztech.github.io/blog/network/private-dns-zone-faq/</id>
    <published>2024-11-27T08:30:00.000Z</published>
    <updated>2025-05-01T03:38:55.272Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの杜です。</p><p>Azure DNS では、仮想ネットワーク内の名前解決結果を上書きできる<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone">プライベート DNS ゾーン</a>というサービスをご提供しており、<br><a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview">プライベート エンドポイント</a>の名前解決などと併用する場合が多いです。</p><p>このブログでは、プライベート DNS ゾーンのベスト プラクティス、及びよく頂いているお問い合わせをご紹介させて頂きます。</p><div class="alert is-info"><p class="alert-title">Note</p><p> プライベート DNS ゾーンの機能として、privatelink のプライベート DNS ゾーンを対象に、自ゾーンに存在しない DNS レコードを <a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-fallback">パブリック DNS にフォールバックする機能 (resolution policy)</a> が実装されたため、本ブログの「回避策」に追記しました。</p></div><span id="more"></span><hr><h3 id="シナリオ"><a href="#シナリオ" class="headerlink" title="シナリオ"></a>シナリオ</h3><ul><li>仮想ネットワーク上のリソース (VM) がプライベート エンドポイント経由でストレージ アカウントに接続する</li><li>仮想ネットワークでは Azure 既定の DNS (168.63.129.16) を DNS サーバーとして指定している</li><li>プライベート エンドポイント経由でストレージ アカウント<code>storagebloga</code>へアクセスするために、プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> をクライアント VM の仮想ネットワークにリンクした</li><li>プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> に <code>storagebloga IN A ＜プライベート エンドポイント IP＞</code> のレコードを登録し、プライベート エンドポイントの名前解決が成功している</li><li>ただし、それ以外の一部ストレージ アカウントの名前解決を行ったところ、空の結果 (NXDOMAIN) が返されてしまい、接続も失敗している</li><li>すべてストレージ アカウントの名前解決が失敗するわけではなく、問題なく接続できる場合もある</li><li>ストレージ アカウントの他に、AppService や Azure SQL Database など他の Azure PaaS サービスにも類似の事象がある</li></ul><h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>発生原因を理解するために、まず全体的な名前解決フローを説明させて頂きます。</p><p>ストレージ アカウントなどの Azure PaaS サービスでは、プライベート エンドポイントの有効化状況により、名前解決フローが異なります。<br>プライベート エンドポイントが無効化されているリソースでは、名前解決フローが以下となります。<code>privatelink.blob.core.windows.net</code> のドメインを経由しません。<br><img src="/blog/network/private-dns-zone-faq/01.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント無効化時の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 20 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 60 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントを有効化すると、<code>storagebloga.blob.core.windows.net</code> の CNAME 先が <code>privatelink.blob.core.windows.net</code> ドメインに変更される動作となります。<br>クライアントが存在する仮想ネットワークがプライベート DNS ゾーンにリンクしていない場合、名前解決結果は変わりません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化時の名前解決フロー (プライベート DNS ゾーンのリンクなし)</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 60 IN CNAME storagebloga.privatelink.blob.core.windows.net.</span><br><span class="line">storagebloga.privatelink.blob.core.windows.net. 60 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 17 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントへ接続させるには、お客様側にプライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> に A レコードを作成し、仮想ネットワークにリンクすることで、該当 CNAME 先を上書きして意図した名前解決が実現できています。<br><img src="/blog/network/private-dns-zone-faq/02.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時の名前解決フロー</span><br><span class="line">※10.0.3.4 がプライベート エンドポイントの IP アドレスとなります。</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 60 IN CNAME storagebloga.privatelink.blob.core.windows.net.</span><br><span class="line">storagebloga.privatelink.blob.core.windows.net. 60 IN A 10.0.3.4</span><br></pre></td></tr></table></figure><p>プライベート DNS ゾーンをリンクすると、Azure DNS が該当 DNS ゾーン <code>privatelink.blob.core.windows.net</code> の権威サーバーとなります。<br>そのドメインへの名前解決要求を受信した時に、インターネット経由で再帰的問い合わせを行わずに、プライベート DNS ゾーンに登録されているレコードを権威結果として応答するようになります。<br>その場合、プライベート DNS ゾーンに <code>storagebloga</code> 以外のレコードが登録されていないため、以下のように、NXDOMAIN が応答されてしまいます。<br><img src="/blog/network/private-dns-zone-faq/03.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時に、別のリソース（プライベート エンドポイント有効化）の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storageblogbwithpe.blob.core.windows.net. INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storageblogbwithpe.blob.core.windows.net. 60 IN CNAMEstorageblogbwithpe.privatelink.blob.core.windows.net.</span><br></pre></td></tr></table></figure><p>また、各ストレージ アカウントの構成次第で、プライベート エンドポイントが有効化されていない場合があります。<br>その場合の名前解決フローでは <code>privatelink.blob.core.windows.net</code> のドメインが存在しないため、プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> をリンクしても影響がありません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時に、別のリソース（プライベート エンドポイント無効化）の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storageblogcwithoutpe.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storageblogcwithoutpe.blob.core.windows.net. 20 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 60 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><h3 id="回避策"><a href="#回避策" class="headerlink" title="回避策"></a>回避策</h3><div class="alert is-info"><p class="alert-title">Note</p><p> プライベート DNS ゾーンの機能として、privatelink のプライベート DNS ゾーンを対象に、自ゾーンに存在しない DNS レコードを <a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-fallback">パブリック DNS にフォールバックする機能 (resolution policy)</a> が実装されたことで、回避策が追加されました。</p></div><h4 id="回避策-1"><a href="#回避策-1" class="headerlink" title="回避策 1"></a>回避策 1</h4><p>追加機能の<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-fallback">パブリック DNS にフォールバックする機能 (resolution policy)</a>を有効化することで、上述したシナリオを回避します。<br>プライベート DNS ゾーンのパブリック DNS にフォールバックする機能は、プライベート エンドポイントを対象とした priavatelink サブドメインを対象に動作します。<br>この機能は、プライベート DNS ゾーンを仮想ネットワークとリンクする時に選択が可能です。また、既存の privatelink サブドメインのプライベート DNS ゾーンにおいても、リンク設定を変更することで有効化可能です。</p><p>この機能の動作としては、プライベート DNS ゾーンが自ゾーンに存在しないレコードを確認した際に NXDOMAIN を応答しますが、この機能が有効化されていると、Azure の DNS はパブリック DNS に DNS クエリを再試行します。この動作により上述したシナリオが回避できます。<br><img src="/blog/network/private-dns-zone-faq/04-1.png"></p><h4 id="回避策-2"><a href="#回避策-2" class="headerlink" title="回避策 2"></a>回避策 2</h4><p>特定のストレージ アカウントの名前解決のみをプライベート DNS ゾーンで実現し、それ以外の名前解決への影響を回避したい場合は、<code>privatelink.blob.core.windows.net</code> ではなく、<br><code>storagebloga.privatelink.blob.core.windows.net</code> のプライベート DNS ゾーンを作成し、頂点（APEX）レコード <code>@ IN A ＜プライベート エンドポイント IP＞</code> を構成すれば実現できます。<br>そうしますと、Azure DNS の権威ドメインが <code>storagebloga.privatelink.blob.core.windows.net</code> のみとなり、それ以外 <code>storageblogcwithpe.privatelink.blob.core.windows.net</code> の名前解決要求を受けると、<br>インターネット経由で再帰的問い合わせを行い、プライベート DNS ゾーンに影響されなくなります。<br><img src="/blog/network/private-dns-zone-faq/04.png"></p><p>この回避策 2 を選択した場合、対象となる複数のストレージ アカウントが存在する場合は、ストレージ アカウントの名前ごとにプライベート DNS ゾーンを用意する必要がありますので、ご注意ください。</p><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="プライベート-DNS-ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。"><a href="#プライベート-DNS-ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。" class="headerlink" title="プライベート DNS ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。"></a>プライベート DNS ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。</h2><p>変更対象以外のレコードには影響がなく、該当プライベート DNS ゾーンで一時的に名前解決ができなくなるといった事象は発生しませんので、ご安心ください。</p><h2 id="東日本リージョンに本番環境を構築しており、プライベート-DNS-ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン-レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート-DNS-ゾーンもリージョンごとに作成する必要がありますでしょうか。"><a href="#東日本リージョンに本番環境を構築しており、プライベート-DNS-ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン-レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート-DNS-ゾーンもリージョンごとに作成する必要がありますでしょうか。" class="headerlink" title="東日本リージョンに本番環境を構築しており、プライベート DNS ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート DNS ゾーンもリージョンごとに作成する必要がありますでしょうか。"></a>東日本リージョンに本番環境を構築しており、プライベート DNS ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート DNS ゾーンもリージョンごとに作成する必要がありますでしょうか。</h2><p>プライベート DNS ゾーンを含め、Azure DNS は 100% の <a href="https://azure.microsoft.com/ja-jp/updates/azuredns100sla/">SLA</a> でご提供しているため、冗長化の観点ではリージョンごとに作成する必要はありません。</p><p>ただし、もし各リージョンの IP アドレス構成が異なり、同じ FQDN に対し、リージョンごとに名前解決結果を分けたい場合は、１つのプライベート DNS ゾーンでは実現できませんので、各リージョンごとにリソース グループを作成し、複数のプライベート DNS ゾーンの構成をご検討ください。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの杜です。&lt;/p&gt;
&lt;p&gt;Azure DNS では、仮想ネットワーク内の名前解決結果を上書きできる&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone&quot;&gt;プライベート DNS ゾーン&lt;/a&gt;というサービスをご提供しており、&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview&quot;&gt;プライベート エンドポイント&lt;/a&gt;の名前解決などと併用する場合が多いです。&lt;/p&gt;
&lt;p&gt;このブログでは、プライベート DNS ゾーンのベスト プラクティス、及びよく頂いているお問い合わせをご紹介させて頂きます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!NOTE] プライベート DNS ゾーンの機能として、privatelink のプライベート DNS ゾーンを対象に、自ゾーンに存在しない DNS レコードを &lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/dns/private-dns-fallback&quot;&gt;パブリック DNS にフォールバックする機能 (resolution policy)&lt;/a&gt; が実装されたため、本ブログの「回避策」に追記しました。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>Azure における有償 Azure テクニカル サポートの対応範囲</title>
    <link href="https://jpaztech.github.io/blog/other/azure_technical_support_explained/"/>
    <id>https://jpaztech.github.io/blog/other/azure_technical_support_explained/</id>
    <published>2024-11-08T03:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.289Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure 製品をご利用のお客様に向けて、Azure の有償テクニカル サポートの対応範囲や留意点について、以下の通りご案内いたします。<br>本内容では、課金や請求については言及しておりません。主に、有償のテクニカル サポート契約についての説明のみとなっております。</p><h2 id="サポート-プラン別の対応範囲"><a href="#サポート-プラン別の対応範囲" class="headerlink" title="サポート プラン別の対応範囲"></a>サポート プラン別の対応範囲</h2><h3 id="有償のサポート-プランに加入していない場合"><a href="#有償のサポート-プランに加入していない場合" class="headerlink" title="有償のサポート プランに加入していない場合"></a>有償のサポート プランに加入していない場合</h3><p>※対象プラン：Basic プランを含む無償のサポート プランを指します。</p><blockquote><p>恐れ入りますが、有償テクニカル サポート範囲内の対応はいたしかねます。ただし、コミュニティの専門家や Microsoft のエンジニア、その他のお客様とアイデアを交換できるコミュニティ チャネルである <a href="https://learn.microsoft.com/ja-jp/answers/tags/133/azure">Azure の Q&amp;A</a>で、技術的な質問への回答を得ることができます。 充実した検索ツールにより、さまざまなソースからの回答が得られるため、自己解決のための貴重なリソースとなります。ぜひご活用ください。</p></blockquote><h3 id="有償のサポート-プランをご購入の場合"><a href="#有償のサポート-プランをご購入の場合" class="headerlink" title="有償のサポート プランをご購入の場合"></a>有償のサポート プランをご購入の場合</h3><p>※対象プラン：Developer、Standard、Professional Direct を指します。</p><p>ご参考：<a href="https://azure.microsoft.com/ja-jp/support/plans/">Azure サポート プランの比較</a></p><blockquote><p>原則として、テクニカル サポートの対応範囲は障害対応（Break/fix）のみとなります。 ご購入のプランによって、対応する範囲や応答時間が異なります。また、Professional Direct をご購入の場合、プラン内容に合わせて、ProDirect デリバリー マネージャーからのガイダンスが定期的に得られます。</p></blockquote><h3 id="プレミア契約でサポート-プランをご購入の場合"><a href="#プレミア契約でサポート-プランをご購入の場合" class="headerlink" title="プレミア契約でサポート プランをご購入の場合"></a>プレミア契約でサポート プランをご購入の場合</h3><p>※対象プラン：エンタープライズ サポートを個別に購入した場合のサポート プランを指します。</p><blockquote><p>障害対応（Break/fix）と Advisory の両方が有償テクニカル サポート範囲内となります。 以下、障害対応（Break/fix）と Advisory の定義や対応範囲を詳細に説明いたします。 弊社の提供する有償テクニカル サポートをより活用していただくため、是非とも一度ご確認ください。どうぞよろしくお願いいたします。</p></blockquote><h2 id="障害対応（Break-fix）と-Advisory-の説明"><a href="#障害対応（Break-fix）と-Advisory-の説明" class="headerlink" title="障害対応（Break/fix）と Advisory の説明"></a>障害対応（Break/fix）と Advisory の説明</h2><h3 id="Azure-サポートにおける障害対応（Break-fix）の定義"><a href="#Azure-サポートにおける障害対応（Break-fix）の定義" class="headerlink" title="Azure サポートにおける障害対応（Break/fix）の定義"></a>Azure サポートにおける障害対応（Break/fix）の定義</h3><blockquote><p>障害対応の問題とは、Azure サービスの使用中に発生する可能性のある技術的な問題のことです。 障害対応とは、通常の使用中にテクノロジーに問題が発生し、正常に動作するように回復させる必要がある場合に、それをサポートするための作業を指します。</p></blockquote><h3 id="Azure-サポートにおける-Advisory-の定義"><a href="#Azure-サポートにおける-Advisory-の定義" class="headerlink" title="Azure サポートにおける Advisory の定義"></a>Azure サポートにおける Advisory の定義</h3><blockquote><p>Advisory サポートは、方法に関する一般的なご質問に対する支援を目的としています。 主に公開資料ベースやすでに存在しているベストプラクティスの案内となります。</p></blockquote><h3 id="両者の区別"><a href="#両者の区別" class="headerlink" title="両者の区別"></a>両者の区別</h3><blockquote><p>前者は「問題が発生している/発生した」ことに対しての支援です。一方、後者は問題が発生していない場合に、公開資料ベースでの一般的なご質問に対する支援です。</p></blockquote><h3 id="サポートをご活用するためのヒント"><a href="#サポートをご活用するためのヒント" class="headerlink" title="サポートをご活用するためのヒント"></a>サポートをご活用するためのヒント</h3><p>(公開資料ベース以外で）Advisory サポートに該当する内容（例） </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">再現頻度が低く、現在は問題が発生していないがログからの原因調査が必要とされる内容 </span><br><span class="line">回避策があるものの、原因究明（RCA）を優先的に実施したいという要望によるサポート側の調査</span><br></pre></td></tr></table></figure><p>Advisory サポートに含まれない内容（例） </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">コードレビュー </span><br><span class="line">設計や設定のレビュー </span><br><span class="line">カスタムコードのサンプルの提供（コーディングの言語やスクリプトの種類に関わらず、公開されているドキュメント内のものを除く） </span><br><span class="line">アーキテクチャに関する詳細なガイダンスやデザイン </span><br><span class="line">公開ドキュメントに記載してない仕様確認 </span><br><span class="line">（既存問題の修正に関わらない）機能のリクエストやフィードバック </span><br><span class="line">公開情報の範疇にないステップバイステップの手順提供やお客様環境に合わせた設計や構築の案内</span><br></pre></td></tr></table></figure><p>上記の内容に関して支援が必要な場合は、Premier サポートのカスタマーエンジニアによる稼働時間ベースのサービスをご検討いただくことをおすすめいたします。 お手数ですが、貴社内の Azure 契約を担当する窓口へ一度ご相談ください。</p><h2 id="お問い合わせの重要度と緊急度について"><a href="#お問い合わせの重要度と緊急度について" class="headerlink" title="お問い合わせの重要度と緊急度について"></a>お問い合わせの重要度と緊急度について</h2><p>Azure のサポートには、重要度が A ~ C に分類されております。</p><p>通常重要度（重要度 B、もしくは C）は、日本時間の営業時間（土日祝日を除く、9:00 ～ 17:30）のみ対応しています。 Standard、Professional Direct、Premier サポートにおいては 24 時間 365 日の緊急対応（重要度 A）が提供されています。</p><p>緊急対応は、運用環境における「障害対応」、つまり正常な状態で稼働していたサービスが正常に機能しなくなった場合の復旧・問題の回避を目的としています。 原因追求や、ハウツー（※）については重要度 B、もしくは C として、通常営業時間内での対応となります。 ※ 原因追求やハウツーは障害対応ではないため、重要度を落としても、ご契約や内容によってお受けできない場合がございます。</p><p>Developer サポートは、開発環境を想定しているため、24 時間 365 日の対応は行えず、重要度 A でも通常時間内での優先対応となります。</p><h2 id="留意点：お問い合わせ1件につき1つの問題を扱います。"><a href="#留意点：お問い合わせ1件につき1つの問題を扱います。" class="headerlink" title="留意点：お問い合わせ1件につき1つの問題を扱います。"></a>留意点：お問い合わせ1件につき1つの問題を扱います。</h2><p>1件あたりを “問題の最小単位” とさせていただく必要があるため、複雑な問題については、切り分けによって複数のインシデントに分割していただくようお願いさせていただく場合があります。 </p><p>このような対応は、お客様により良いサポート体験を提供させていただくためのものでございます。何卒ご理解賜りますようお願い申し上げます。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>よくあるご質問について、以下の通り列挙いたします。ご一読いただけますと幸いです。</p><p><strong>Q.オンプレミスの PC やサーバーに不調が発生した場合、Azure サポートで対応が行えるか</strong><br>オンプレミス、つまり自社や自宅の環境のサポート対応は Azure サポートの対応範囲外となります。エンタープライズ サポートの Unified サポートであれば、マイクロソフトの製品に限って対応が可能です。</p><p><strong>Q.Azure 上における特定製品のライセンスについての問い合わせをしたい</strong><br>マイクロソフト製品のライセンス（Windows Server や SQL Server 等）については、ライセンス リセラーとなるパートナー各社にお問い合わせください。 パートナー ネットワークに加入されている弊社パートナー様の場合、弊社パートナー コールセンターにご相談ください。<br>・<a href="https://partner.microsoft.com/ja-jp/support?stage=1">パートナー コールセンター</a></p><p><strong>Q.Azure 上の Windows Server 仮想マシンにおけるサードパーティ製品について問い合わせが可能か</strong><br>サードパーティ製品のサポートは行っておりませんので、開発元にお問い合わせいただきますようお願いいたします。</p><p><strong>Q.Azure 上の Windows Server 仮想マシンにおける OS 内の設定について、ベストプラクティス・特定機能の設定方法・仕様確認などを行いたい</strong><br>Azure サポートの対応範囲外となりますが、エンタープライズ サポートの Unified サポートであれば対応可能です。</p><p><strong>Q.Office 365 製品の問い合わせが可能か</strong><br>Office 365 の製品についてのサポートは Azure サポート契約ではお受けできないため、Office 365 サポートをご利用いただく必要がございます。 しかしながら、Azure 上に導入いただいた Office 365 製品において、Azure プラットフォーム側の問題が発生している可能性がある場合など、Azure プラットフォームとしての見解が必要な内容については Azure サポートにご相談ください。</p><p><strong>Q.Azure の特定の技術・挙動について仕様確認をしたい</strong><br>仕様の確認に関する調査については、Professional Direct、エンタープライズ サポートの Unified サポートでのAdvisory サービスに含まれます。</p><p><strong>Q.Azure Marketplace におけるサードパーティ製品の質疑応答・トラブルシューティングの依頼は可能か</strong><br>Azure 基盤側の問題、例えば「サードパーティ製として提供されている仮想マシンが、Azure 基盤側の要因で接続できなくなった」といったケースであれば Azure テクニカル サポートにて対応が可能です。 それ以外の、価格、ライセンス、製品固有のご質問・トラブルシュートは提供元にご質問ください。</p><p><strong>Q.Azure 製品やサービスの利用において、パフォーマンスが出ない</strong><br>構築後、正常にパフォーマンスが出ていた状態から一時的に極端に悪化している場合には障害対応の範囲となり、Azure サポートでの対応が可能です。<br>障害対応の範囲外となるパフォーマンスの調査は Azure 観点からであれば Unified や Premier サポートにて承ることができます。<br>一方で、システム全体のパフォーマンスチューニングはカスタマー エンジニアによる稼働時間ベースのサービスにおいてのみ承れます。</p><p><strong>Q.仕様確認したい場合、どうすればいいですか</strong><br>Advisory 範囲として、ドキュメント上に言及されているものからの回答となります。大規模な案件で、非公式な上限値などをお知りになりたい場合、Premier サポートにて承ります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure 製品をご利用のお客様に向けて、Azure の有償テクニカル サポートの対応範囲や留意点について、以下の通りご案内いたします。&lt;br&gt;本内容では、課金や請求については言及しておりません。主に</summary>
      
    
    
    
    
    <category term="Other" scheme="https://jpaztech.github.io/blog/tags/Other/"/>
    
    <category term="Support Explained" scheme="https://jpaztech.github.io/blog/tags/Support-Explained/"/>
    
  </entry>
  
  <entry>
    <title>Azure File Sync のログ採取について</title>
    <link href="https://jpaztech.github.io/blog/storage/get-afs-logs/"/>
    <id>https://jpaztech.github.io/blog/storage/get-afs-logs/</id>
    <published>2024-11-07T03:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.314Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>お客様より Azure Files Sync のトラブルシューティングのサポートリクエストをいただいた際に、調査のためログの採取をお願いすることがございます。<br>本記事ではログの採取方法についてご紹介をさせていただきます。 </p><span id="more"></span><ol><li><a href=".#1-Debug-StorageSyncServer-Diagnose%EF%BC%88%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BA%E6%96%AD%EF%BC%89">Debug-StorageSyncServer -Diagnose（サーバー診断）</a></li><li><a href=".#2-Debug-StorageSyncServer-TestNetworkConnectivity%EF%BC%88%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E6%8E%A5%E7%B6%9A%E3%83%86%E3%82%B9%E3%83%88%EF%BC%89">Debug-StorageSyncServer -TestNetworkConnectivity（ネットワーク接続テスト）</a> </li><li><a href=".#3-Debug-StorageSyncServer-FileSyncErrorsReport%EF%BC%88%E5%90%8C%E6%9C%9F%E5%A4%B1%E6%95%97%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%EF%BC%89">Debug-StorageSyncServer -FileSyncErrorsReport（同期失敗に関するレポート）</a> </li><li><a href=".#4-Debug-StorageSyncServer-AFSDiag%EF%BC%88%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%8E%E9%9B%86%EF%BC%89">Debug-StorageSyncServer -AFSDiag（ログとトレースを収集）</a> </li><li><a href=".#5-Azure-Files-Sync-%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%83%AD%E3%82%B0%E3%81%AE%E6%8E%A1%E5%8F%96">Azure Files Sync に関するイベントログの採取</a></li></ol><p>各ログの採取は問題の発生しているサーバーエンドポイントとなる Windows Server 上で PowerShell より実行をお願いいたします。<br>調査のためにすべてのログが必要といったわけではございませんので、担当エンジニアからご依頼させていただいたログを取得いただけますと幸いでございます。 </p><p>なお、公開ドキュメントにも Azure Files Sync のトラブルシューティングについての記載がございますので、ご自身でトラブルシューティング可能な点が無いかご確認いただくこともできます。 </p><p>■ご参考：Azure File Sync のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot">https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot</a></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>各コマンド実行前に Import-Module をしていますが、初回に Import-Module を 1 回のみ 実行することで、都度 Import-Module を実行する必要はございません。</p></div><hr><h3 id="1-Debug-StorageSyncServer-Diagnose（サーバー診断）"><a href="#1-Debug-StorageSyncServer-Diagnose（サーバー診断）" class="headerlink" title="1. Debug-StorageSyncServer -Diagnose（サーバー診断）"></a>1. Debug-StorageSyncServer -Diagnose（サーバー診断）</h3><p>Azure File Sync に関する一般的な問題が無いか診断をするコマンドとなります。 </p><p>■ ログ取得方法 </p><p>以下のコマンドを実行して表示される結果をコピーして、テキストファイルでご共有ください。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-Diagnose</span></span><br></pre></td></tr></table></figure><hr><h3 id="2-Debug-StorageSyncServer-TestNetworkConnectivity（ネットワーク接続テスト）"><a href="#2-Debug-StorageSyncServer-TestNetworkConnectivity（ネットワーク接続テスト）" class="headerlink" title="2. Debug-StorageSyncServer -TestNetworkConnectivity（ネットワーク接続テスト）"></a>2. Debug-StorageSyncServer -TestNetworkConnectivity（ネットワーク接続テスト）</h3><p>サーバーエンドポイントとして使用している Windows Server から各種 Azure 上のリソースへのネットワーク疎通テストを行うコマンドとなります。<br>正常な通信ができていない可能性がある場合などに使用します。 </p><p>以下のドキュメントのように、通信経路上に、Firewallがある場合、Proxyがある場合等をはじめとして、Azure File Sync に関連するAzureサービスとの通信が可能な状況かどうかを確認することができます。 </p><p>■ご参考：Azure File Sync のプロキシとファイアウォールの設定<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/file-sync/file-sync-firewall-and-proxy">https://learn.microsoft.com/ja-jp/azure/storage/file-sync/file-sync-firewall-and-proxy</a>　 </p><p>■ ログ取得方法 </p><p>以下のコマンドを実行して表示される結果をコピーして、テキストファイルでご共有ください。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-TestNetworkConnectivity</span></span><br></pre></td></tr></table></figure><hr><h3 id="3-Debug-StorageSyncServer-FileSyncErrorsReport（同期失敗に関するレポート）"><a href="#3-Debug-StorageSyncServer-FileSyncErrorsReport（同期失敗に関するレポート）" class="headerlink" title="3. Debug-StorageSyncServer -FileSyncErrorsReport（同期失敗に関するレポート）"></a>3. Debug-StorageSyncServer -FileSyncErrorsReport（同期失敗に関するレポート）</h3><p>同期に失敗したファイルの特定などを行うコマンドです。<br>ファイルの同期に問題が発生している場合に使用します。<br>Azure Portal上にて、同期のエラーが表示されている際に、同期エラーとなっている具体的なファイル・フォルダーや、同期エラーとなっているエラー内容を、ファイル・フォルダーごとに確認するために使用できます。 </p><p>■ご参考：同期されていない特定のファイルまたはフォルダーがあるかどうかを確認するにはどうすればよいですか?<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot-sync-errors#how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing">https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot-sync-errors#how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing</a>  </p><p>■ ログ取得方法<br>以下のコマンドを実行して表示される結果をコピーして、テキストファイルでご共有ください。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-FileSyncErrorsReport</span> </span><br></pre></td></tr></table></figure><hr><h3 id="4-Debug-StorageSyncServer-AFSDiag（ログとトレースを収集）"><a href="#4-Debug-StorageSyncServer-AFSDiag（ログとトレースを収集）" class="headerlink" title="4. Debug-StorageSyncServer -AFSDiag（ログとトレースを収集）"></a>4. Debug-StorageSyncServer -AFSDiag（ログとトレースを収集）</h3><p>Azure File Sync に関する詳細なログおよびトレースを行うコマンドです。<br>一般的に広く情報を収集したい場合に、このコマンドで情報収集をお願いする場合もございますが、主に事象の再現性がある場合に、再現時の情報を収集するためのコマンドとしてご案内することが多いものとなります。 </p><p>■ ログ取得方法 </p><p>以下のコマンドを実行すると、「Please reproduce the problem and press D when done …:」というメッセージが表示されます。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-AFSDiag</span> <span class="literal">-OutputDirectory</span> C:\output <span class="literal">-KernelModeTraceLevel</span> Verbose <span class="literal">-UserModeTraceLevel</span> Verbose </span><br></pre></td></tr></table></figure><p>何か特定の操作で再現性のある問題についてトレースする場合は、再現操作を行った後に D を入力し Enter キーを押下してください。<br>特定の操作で起こる問題ではない場合には、そのまま何もせず D を入力し Enter キーを押下してください。<br>実行完了までに少しお時間がかかる場合がございますが、完了すると C:\output フォルダー配下に AFSDiag_2023-04-20-03-40-20.zip というようなファイルが生成されます。<br>こちらの生成されたファイルをご共有ください。 </p><hr><h3 id="5-Azure-Files-Sync-に関するイベントログの採取"><a href="#5-Azure-Files-Sync-に関するイベントログの採取" class="headerlink" title="5. Azure Files Sync に関するイベントログの採取"></a>5. Azure Files Sync に関するイベントログの採取</h3><p>Windows イベントログに Azure File Sync に関するログが記録されます。 </p><p>■ ログ取得方法 </p><p>“C:\Windows\System32\winevt\Logs” フォルダーに保存されている、「Microsoft-FileSync-」で始まるファイル名のものを全て、ファイルごとご共有ください。 </p><hr><p>上記内容がお役に立てますと幸いでございます。 </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;お客様より Azure Files Sync のトラブルシューティングのサポートリクエストをいただいた際に、調査のためログの採取をお願いすることがございます。&lt;br&gt;本記事ではログの採取方法についてご紹介をさせていただきます。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較</title>
    <link href="https://jpaztech.github.io/blog/network/fw-snat/"/>
    <id>https://jpaztech.github.io/blog/network/fw-snat/</id>
    <published>2024-10-25T05:30:00.000Z</published>
    <updated>2025-05-01T03:38:55.255Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較について紹介します。</p><span id="more"></span><div class="alert is-info"><p class="alert-title">Note</p><p> この記事は当初 Azure Firewall のパブリック IP の使われ方がランダムではないため、実際のパブリック IP の使われ方を説明しておりましたが、内容を Azure Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較に変更いたしました。</p></div><h2 id="Azure-Firewall-のパブリック-IP-による-SNAT-について"><a href="#Azure-Firewall-のパブリック-IP-による-SNAT-について" class="headerlink" title="Azure Firewall のパブリック IP による SNAT について"></a>Azure Firewall のパブリック IP による SNAT について</h2><p>Azure Firewall を経由してインターネット宛に通信するときは、関連付けられているパブリック IP へ送信元のアドレス変換（SNAT）が行われます。パブリック IP が 1 つしかない時はそのパブリック IP のアドレスしか使用されませんが、複数のパブリック IP アドレスが Azure Firewall に関連付けられている場合の動作は、以下のドキュメントに記載がございます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/deploy-multi-public-ip-powershell">Azure PowerShell を使用して複数のパブリック IP アドレスを使用する Azure Firewall をデプロイする</a></p><h2 id="NAT-ゲートウェイ-による-SNAT-について"><a href="#NAT-ゲートウェイ-による-SNAT-について" class="headerlink" title="NAT ゲートウェイ による SNAT について"></a>NAT ゲートウェイ による SNAT について</h2><p>Azure Firewall Subnet に NAT ゲートウェイを関連付けることにより、Azure Firewall のパブリック IP ではなく、NAT ゲートウェイで SNAT を行うことができるようになります。NAT ゲートウェイによる SNAT では関連付けられているパブリック IP がランダムかつほぼ均等に使用されます。<br>注意点として、NAT ゲートウェイはゾーン冗長をサポートしていないため、利用する場合は Azure Firewall をゾーン冗長しないようにデプロイする必要があります。<br>Azure Firewall と NAT ゲートウェイを組み合わせて使用する方法については以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/integrate-with-nat-gateway">Azure Virtual Network NAT を使用した SNAT ポートのスケーリング | Microsoft Learn</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/nat-gateway/tutorial-hub-spoke-nat-firewall">チュートリアル： ハブ アンド スポーク ネットワークで NAT ゲートウェイと Azure Firewall を統合する - Azure Virtual Network NAT | Microsoft Learn</a></p><h2 id="Azure-Firewall-と-NAT-Gateway-の比較表"><a href="#Azure-Firewall-と-NAT-Gateway-の比較表" class="headerlink" title="Azure Firewall と NAT Gateway の比較表"></a>Azure Firewall と NAT Gateway の比較表</h2><p>以下の表は Azure Firewall のパブリック IP による SNAT と NAT Gateway の機能比較表です。</p><table><thead><tr><th align="left">機能</th><th align="center">Firewall のパブリック IP</th><th align="center">NAT ゲートウェイ</th></tr></thead><tbody><tr><td align="left">SNAT ポート数（パブリック IP 1 つにつき）</td><td align="center">2,496 * FW 内部インスタンス数 ※1</td><td align="center">64,512</td></tr><tr><td align="left">関連付けられる パブリック IP の数</td><td align="center">250</td><td align="center">16</td></tr><tr><td align="left">パブリック IP が使用される順番</td><td align="center">基本的にプライマリから使用され、ポートが枯渇すると次が使用される</td><td align="center">ランダムかつほぼ均等に使用される</td></tr><tr><td align="left">ゾーン冗長のサポート</td><td align="center">○</td><td align="center">×</td></tr><tr><td align="left">価格</td><td align="center">FW と FW のパブリック IP の価格</td><td align="center">FW と FW のパブリック IP, NAT ゲートウェイと NAT ゲートウェイ のパブリック IP の価格</td></tr></tbody></table><p>※1 Azure Firewall の内部インスタンス数は最低 2 となり、負荷に応じてスケールアウトします。</p><p>以上、ご参考になれば幸いです。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure CDN Microsoft Standard SKU (クラシック) のリタイアについて</title>
    <link href="https://jpaztech.github.io/blog/network/mscdn-classic-retire/"/>
    <id>https://jpaztech.github.io/blog/network/mscdn-classic-retire/</id>
    <published>2024-09-30T14:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.267Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>本ブログでは、Azure CDN Microsoft Standard SKU (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と、Azure CDN Microsoft Standard SKU を MS CDN と記載致します)。</p><span id="more"></span><hr><h2 id="MS-CDN-クラシック-のリタイアについて"><a href="#MS-CDN-クラシック-のリタイアについて" class="headerlink" title="MS CDN (クラシック) のリタイアについて"></a>MS CDN (クラシック) のリタイアについて</h2><p>2027 年 9 月 30 日に MS CDN (クラシック) の提供が終了し、MS CDN (クラシック) に対するサポートも終了します。<br>提供終了までの間は既存の MS CDN (クラシック) の設定を変更することは可能ですが、2025 年 10 月 1 日以降は Azure ポータル、Terraform、Azure PowerShell や Azure CLI などを使用して新しい MS CDN (クラシック) リソースが作成できなくなります。<br>アナウンス内容につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://azure.microsoft.com/en-us/updates/v2/Azure-CDN-Standard-from-Microsoft-classic-will-be-retired-on-30-September-2027">Retirement: Azure CDN Standard from Microsoft (classic) will be retired on September 30th, 2027</a></p><blockquote><p>[!注意]<br>なお、記事には誤りがあり、2025 年 10 月 1 日以降も既存の MS CDN (クラシック) のリソースは更新できます。</p></blockquote><h2 id="MS-CDN-クラシック-のリタイアに関する-FAQ"><a href="#MS-CDN-クラシック-のリタイアに関する-FAQ" class="headerlink" title="MS CDN (クラシック) のリタイアに関する FAQ"></a>MS CDN (クラシック) のリタイアに関する FAQ</h2><p>MS CDN (クラシック) のリタイアに関するよくある質問につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/cdn/classic-cdn-retirement-faq">Azure CDN Standard from Microsoft (クラシック) の廃止に関する FAQ</a></p><h2 id="MS-CDN-クラシック-から-AFD-Standard-Premium-への移行方法について"><a href="#MS-CDN-クラシック-から-AFD-Standard-Premium-への移行方法について" class="headerlink" title="MS CDN (クラシック) から AFD Standard/Premium への移行方法について"></a>MS CDN (クラシック) から AFD Standard/Premium への移行方法について</h2><p>MS CDN (クラシック) の提供が終了する 2027 年 9 月 30 日までに、事前にお客様にて AFD Standard/Premium へ移行する必要がございます。<br>MS CDN (クラシック) から AFD Standard/Premium にゼロ ダウンタイムで移行するプロセスや手順に関しましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/cdn/migrate-tier">Microsoft Azure CDN (クラシック) を Standard/Premium レベルに移行する</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Azure CDN Microsoft Standard SKU (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と、Azure CDN Microsoft Standard SKU を MS CDN と記載致します)。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
  </entry>
  
  <entry>
    <title>Azure Network 製品について TLS 1.2 以降に移行するアナウンスの補足 (Tracking ID:7_8G-D8Z)</title>
    <link href="https://jpaztech.github.io/blog/network/tls1.2_migration/"/>
    <id>https://jpaztech.github.io/blog/network/tls1.2_migration/</id>
    <published>2024-09-26T10:27:00.000Z</published>
    <updated>2025-05-01T03:38:55.277Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。</p><p>メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。</p><h2 id="TLS-バージョンとは"><a href="#TLS-バージョンとは" class="headerlink" title="TLS バージョンとは"></a>TLS バージョンとは</h2><p>TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、<a href="https://datatracker.ietf.org/doc/html/rfc8996">RFC 8996</a> により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。</p><h2 id="TLS-接続時のバージョン選定動作について"><a href="#TLS-接続時のバージョン選定動作について" class="headerlink" title="TLS 接続時のバージョン選定動作について"></a>TLS 接続時のバージョン選定動作について</h2><p>TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。</p><h3 id="Windows-OS-の場合"><a href="#Windows-OS-の場合" class="headerlink" title="Windows OS の場合"></a>Windows OS の場合</h3><p><a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows">こちらの公開ドキュメント</a>の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。<br>また、特定の TLS バージョンを有効化/無効化されたい場合は、<a href="https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/">こちらの記事</a>の通りご対応ください。</p><p>Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。</p><p>参考として、Android など他のクライアント対応状況は<a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation">こちら</a>の公開ドキュメントに開示されています。 </p><h3 id="Chrome-Edge-などのブラウザの場合"><a href="#Chrome-Edge-などのブラウザの場合" class="headerlink" title="Chrome/Edge などのブラウザの場合"></a>Chrome/Edge などのブラウザの場合</h3><p>最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、<br>特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。<br>Edgeの場合は<a href="https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg">こちらの記事</a>の通り対応できます。</p><h3 id="それ以外の場合"><a href="#それ以外の場合" class="headerlink" title="それ以外の場合"></a>それ以外の場合</h3><p>上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。</p><h3 id="TLS-チェッカー-ツール"><a href="#TLS-チェッカー-ツール" class="headerlink" title="TLS チェッカー ツール"></a>TLS チェッカー ツール</h3><p><a href="https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html">こちら</a>のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。</p><h2 id="Azure-Network製品の対応状況及び推奨アクションについて"><a href="#Azure-Network製品の対応状況及び推奨アクションについて" class="headerlink" title="Azure Network製品の対応状況及び推奨アクションについて"></a>Azure Network製品の対応状況及び推奨アクションについて</h2><p>以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。<br>もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。</p></div><span id="more"></span><h2 id="Application-Gateway"><a href="#Application-Gateway" class="headerlink" title="Application Gateway"></a>Application Gateway</h2><p>以下の URL にて、2025 年 8 月 31 日に TLS バージョン 1.0 および 1.1 のサポートが終了することが案内されました。こちらの URL 先のページでは英文で記載されておりますので、本ブログでは日本語にて内容をご案内いたします。  </p><p><a href="https://azure.microsoft.com/en-us/updates/v2/Azure-Application-Gateway-support-for-TLS-10-and-TLS-11-will-end-by-31-August-2025">Retirement: Azure Application Gateway support for TLS 1.0 and TLS 1.1 will end by 31 August 2025 (microsoft.com)</a>  </p><p>つきましては、2025 年 8 月 31 日までに以下の作業をご実施いただきますようお願いいたします。  </p><h3 id="クライアントから-Application-Gateway-への接続について"><a href="#クライアントから-Application-Gateway-への接続について" class="headerlink" title="クライアントから Application Gateway への接続について"></a>クライアントから Application Gateway への接続について</h3><p><del>現時点では、Application Gateway は2024 年 10 月 31 日以降にも引き続き TLS1.0 から TLS1.3 をサポートしており、TLS1.2 以下のバージョンをサポートしなくなる予定はございません。</del><br>以下の設定方法を参考に Application Gateway の TLS ポリシーにて、定義済みの AppGwSslPolicy20220101S、AppGwSslPolicy20220101、または最小プロトコル バージョンが TLS 1.2 のカスタムポリシーに更新することをお勧めします（CustomV2 ポリシーは、デフォルトで最小プロトコルバージョンが 1.2 になっています）。  </p><h4 id="最小TLS-バージョンの設定方法"><a href="#最小TLS-バージョンの設定方法" class="headerlink" title="最小TLS バージョンの設定方法"></a>最小TLS バージョンの設定方法</h4><p>下図の通り、Azure ポータル → 対象 Application Gateway → 「リスナー」のタブにて、 「選択した SSL ポリシー」の「変更」ボタンをクリックし、「 SSL ポリシーの変更」より設定できます。<br><img src="/blog/network/tls1.2_migration/appgw_tls_setting.png"></p><p>また、Application Gateway SKU v2 の場合は、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-configure-listener-specific-ssl-policy">こちらの手順通り</a>、リスナー毎に異なる TLS バージョンを設定することも可能です。 </p><h3 id="Application-Gateway-からバックエンド-サーバーへの接続について"><a href="#Application-Gateway-からバックエンド-サーバーへの接続について" class="headerlink" title="Application Gateway からバックエンド サーバーへの接続について"></a>Application Gateway からバックエンド サーバーへの接続について</h3><p>2025 年 8 月 31 日以降、バックエンドサーバーへの接続は常に最小プロトコル TLS のバージョンは 1.2 となり、最大プロトコル TLS バージョンは 1.3 となります。バックエンド接続の TLS バージョンについて、Application Gateway 側で何かを設定する必要はありません。<br>バックエンドのサーバーがこれらの更新されたプロトコル TLS バージョン （TLS 1.2 または 1.3）に対応していることをお客様にて確認し、必要に応じて 2025 年 8 月 31 日までに Application Gateway のバックエンドに指定しているサーバー側で最小プロトコル TLS バージョンが 1.2 以上となるよう、ご対応いただけますようお願いいたします。  </p><h2 id="Azure-Firewall"><a href="#Azure-Firewall" class="headerlink" title="Azure Firewall"></a>Azure Firewall</h2><p>Azure Firewall では、TLS バージョンが関わる部分は TLS インスペクションのみとなります。アプリケーション ルール、ネットワーク ルール、及び DNAT ルールで通信を許可する場合は本通知の対象外となります。</p><p>TLS インスペクション機能を使用する場合は、<a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-features#tls-inspection">こちらの公開ドキュメント</a>の記載通り、現状及び 2024 年 10 月 31 日以降にも TLS1.0 及び TLS1.1 は互換性のために引き続き動作する予定ですが、早めに TLS 1.2 に移行することを強く推奨します。</p><blockquote><p>ヒント<br>TLS 1.0 と 1.1 は非推奨になっていて、サポートされません。 TLS 1.0 と 1.1 のバージョンの TLS/SSL (Secure Sockets Layer) は脆弱であることが確認されています。現在、これらは下位互換性を維持するために使用可能ですが、推奨されていません。 できるだけ早く TLS 1.2 に移行してください。</p></blockquote><p>また、現状の TLS インスペクション機能では TLS1.3 をサポートしておりません。</p><h2 id="Front-Door"><a href="#Front-Door" class="headerlink" title="Front Door"></a>Front Door</h2><p>2025 年 3 月 1 日に TLS バージョン 1.0 および 1.1 のサポートが終了することが案内されました。</p><p>Azure Front Door でカスタム ドメインを利用する場合は、<strong>2025 年 3 月 1 日以降に最小 TLS バージョン 1.0 および 1.1 のサポートは終了</strong>するため、<strong>最小 TLS バージョンを 1.2 以上に変更</strong>いただく必要がございます。<br>各 SKU における最小 TLS バージョンの更新方法は以下の通りです。  </p><ul><li>Azure Front Door を使用している場合は、「<a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/standard-premium/how-to-configure-https-custom-domain?tabs=powershell">カスタム ドメインに対して HTTPS を構成する - Azure Front Door | Microsoft Learn</a>」を使用して TLS 1.2 以上に設定します。</li><li>Azure Front Door クラシックを使用している場合は、「<a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/front-door-custom-domain-https">Front Door (クラシック) カスタム ドメインで HTTPS を構成する - Azure Front Door | Microsoft Learn</a>」を使用して TLS 1.2 に設定します。</li><li>Microsoft CDN を使用している場合は、「<a href="https://learn.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-1-default-enable-https-with-a-cdn-managed-certificate">チュートリアル:Azure CDN カスタム ドメインで HTTPS を構成する | Microsoft Learn</a>」を使用して TLS 1.2 に設定します。</li></ul><h2 id="Private-Link-Service-または-Private-Endpoint"><a href="#Private-Link-Service-または-Private-Endpoint" class="headerlink" title="Private Link Service または Private Endpoint"></a>Private Link Service または Private Endpoint</h2><p>Private Link Service と Private Endpoint のサービスでは、TLS プロトコルは終端しません。<br>Private Link Service と Private Endpoint を利用した通信の場合には、クライアントとサーバーの通信上の両端で TLS ネゴシエーションが実施されます。クライアントおよびサーバーとなるサービスの観点でご確認頂く必要があります。 </p><h2 id="Bastion"><a href="#Bastion" class="headerlink" title="Bastion"></a>Bastion</h2><p>Bastion はお客様側で証明書の管理運用を意識する必要のないサービスとして、<a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-overview#key">以下の公開ドキュメント</a>の記載通り、 TLS 1.2 のみをサポートしておりますので、お客様側の対処が不要です。 </p><blockquote><p>Bastion では、TLS 1.2 がサポートされています。 以前の TLS バージョンはサポートされません。</p></blockquote><h2 id="Traffic-Manager"><a href="#Traffic-Manager" class="headerlink" title="Traffic Manager"></a>Traffic Manager</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-how-it-works#how-clients-connect-using-traffic-manager">こちらの公開ドキュメント</a>の説明通り、TrafficManager は DNS レベルで動作するため、Traffic Manager 自身がクライアントからのリクエストを処理することはなく、クライアントは直接エンドポイントに接続します。このため、クライアント - Traffic Manager 間で TLS が使用されることはありませんので、Traffic Manager 側の対処が不要となります。</p><p>一方で、Traffic Manager はエンドポイントの監視方法として HTTPS を提供しているため、HTTPS で正常性プローブを送信するように構成した場合、Traffic Manager - エンドポイント間では TLS が使用されます。<br>（Tracking ID: VSKS-DSG の通知は、この Traffic Manager - エンドポイント間の正常性プローブの通信において、TLS 1.0/1.1 のサポートが 2024 年 6 月 30 日より終了することをご案内しております。）</p><p>TLS はクライアント (Traffic Manager) およびサーバー (エンドポイント) 間で使用可能な TLS バージョンのネゴシエイトを行います。エンドポイント側で TLS 1.0/1.1 が無効化されている限り Traffic Manager がTLS 1.0/1.1 でエンドポイントに接続することはありません。したがいまして、正常性プローブのプロトコルとして HTTPS を選択されている場合は、エンドポイントが TLS 1.2 以上で正常性プローブを受け取れるように構成いただく必要がございますが、具体的なエンドポイント側の TLS 設定状況、及び TLS 1.0/1.1 の無効化方法に関しましては、お客様に各サーバー (エンドポイント) 観点でご確認頂く必要があります。</p><h2 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a>Load Balancer</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-faqs#azure-load-balancer---tls-ssl---------------">こちらの公開ドキュメント</a>記載通り、Azure Load Balancer では、TLS 接続を終端せずにバックエンド サーバーへ転送する動作となりますので、本通知の対象外となります。 </p><h2 id="Virtual-Network"><a href="#Virtual-Network" class="headerlink" title="Virtual Network"></a>Virtual Network</h2><p>Virtual Network が仮想化の IP アドレス空間を提供するサービスとして、TLS 通信を終端することはありませんので、本通知の対象外となります。<br>もし仮想ネットワーク上に稼働する他の Azure リソースの対処方法をご確認されたい場合は、各リソース観点でご確認頂く必要があります。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。&lt;/p&gt;
&lt;p&gt;メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。&lt;/p&gt;
&lt;h2 id=&quot;TLS-バージョンとは&quot;&gt;&lt;a href=&quot;#TLS-バージョンとは&quot; class=&quot;headerlink&quot; title=&quot;TLS バージョンとは&quot;&gt;&lt;/a&gt;TLS バージョンとは&lt;/h2&gt;&lt;p&gt;TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8996&quot;&gt;RFC 8996&lt;/a&gt; により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。&lt;/p&gt;
&lt;h2 id=&quot;TLS-接続時のバージョン選定動作について&quot;&gt;&lt;a href=&quot;#TLS-接続時のバージョン選定動作について&quot; class=&quot;headerlink&quot; title=&quot;TLS 接続時のバージョン選定動作について&quot;&gt;&lt;/a&gt;TLS 接続時のバージョン選定動作について&lt;/h2&gt;&lt;p&gt;TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。&lt;/p&gt;
&lt;h3 id=&quot;Windows-OS-の場合&quot;&gt;&lt;a href=&quot;#Windows-OS-の場合&quot; class=&quot;headerlink&quot; title=&quot;Windows OS の場合&quot;&gt;&lt;/a&gt;Windows OS の場合&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows&quot;&gt;こちらの公開ドキュメント&lt;/a&gt;の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。&lt;br&gt;また、特定の TLS バージョンを有効化/無効化されたい場合は、&lt;a href=&quot;https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/&quot;&gt;こちらの記事&lt;/a&gt;の通りご対応ください。&lt;/p&gt;
&lt;p&gt;Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。&lt;/p&gt;
&lt;p&gt;参考として、Android など他のクライアント対応状況は&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation&quot;&gt;こちら&lt;/a&gt;の公開ドキュメントに開示されています。 &lt;/p&gt;
&lt;h3 id=&quot;Chrome-Edge-などのブラウザの場合&quot;&gt;&lt;a href=&quot;#Chrome-Edge-などのブラウザの場合&quot; class=&quot;headerlink&quot; title=&quot;Chrome/Edge などのブラウザの場合&quot;&gt;&lt;/a&gt;Chrome/Edge などのブラウザの場合&lt;/h3&gt;&lt;p&gt;最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、&lt;br&gt;特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。&lt;br&gt;Edgeの場合は&lt;a href=&quot;https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg&quot;&gt;こちらの記事&lt;/a&gt;の通り対応できます。&lt;/p&gt;
&lt;h3 id=&quot;それ以外の場合&quot;&gt;&lt;a href=&quot;#それ以外の場合&quot; class=&quot;headerlink&quot; title=&quot;それ以外の場合&quot;&gt;&lt;/a&gt;それ以外の場合&lt;/h3&gt;&lt;p&gt;上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。&lt;/p&gt;
&lt;h3 id=&quot;TLS-チェッカー-ツール&quot;&gt;&lt;a href=&quot;#TLS-チェッカー-ツール&quot; class=&quot;headerlink&quot; title=&quot;TLS チェッカー ツール&quot;&gt;&lt;/a&gt;TLS チェッカー ツール&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html&quot;&gt;こちら&lt;/a&gt;のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。&lt;/p&gt;
&lt;h2 id=&quot;Azure-Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;a href=&quot;#Azure-Network製品の対応状況及び推奨アクションについて&quot; class=&quot;headerlink&quot; title=&quot;Azure Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;/a&gt;Azure Network製品の対応状況及び推奨アクションについて&lt;/h2&gt;&lt;p&gt;以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。&lt;br&gt;もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!WARNING]&lt;br&gt;以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の複製 / 移動方法ついてのまとめ</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-copy-move-scenario/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-copy-move-scenario/</id>
    <published>2024-09-24T03:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.647Z</updated>
    
    <content type="html"><![CDATA[<p>今回は、お問い合わせいただくことの多い Azure VM の複製 / 移動方法ついてのまとめの記事となります。 </p><span id="more"></span><ul><li>同一サブスクリプション内での Azure VM の複製 / 移動 </li><li>テナントは同じだが別のサブスクリプションへの Azure VM の複製 / 移動 </li><li>別のテナントにある別のサブスクリプションへの Azure VM の複製 / 移動 </li></ul><p>どのパターンにも対応した記事となっております。<br>なお、あくまで複製 / 移動方法の例をご紹介するものとなります点、ご承知おきいただけますと幸いです。 </p><p>まず、手順については複製 / 移動先のテナントが同じか別かによって大きく手順が変わります。<br>そのため、本記事では以下の通り 4 つのパターンに分けて手順をご紹介させていただきます。 </p><table><thead><tr><th>複製 / 移動先は同じテナントか？</th><th>実施する内容は複製か移動か？</th><th>シナリオ</th></tr></thead><tbody><tr><td>同じテナント内</td><td>VM 複製（コピー）を行う</td><td>シナリオ 1</td></tr><tr><td>同じテナント内</td><td>VM の移動をする</td><td>シナリオ 2</td></tr><tr><td>別テナント</td><td>VM 複製（コピー）を行う</td><td>シナリオ 3</td></tr><tr><td>別テナント</td><td>VM の移動をする</td><td>シナリオ 4</td></tr></tbody></table><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>今回は VM の一般化は行わず、完全複製での移動・複製をする場合の手順となります。<br>一般化してイメージを展開する場合は、以下のドキュメントに記載の ACG (Azure Compute Gallery) のご利用をご検討くださいませ。  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/azure-compute-gallery">(参考) Azure Compute Gallery でリソースを格納、共有する</a></p><p>また、Windows VM を一般化せず複製して利用いただくことが原則叶いません点ご留意ください。</p><p><a href="https://jpaztech.github.io/blog/vm/vm-replica-1/#Windows-VM%E3%82%92%E8%A4%87%E8%A3%BD%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%96%B9%E3%81%B8%E3%81%AE%E6%B3%A8%E6%84%8F%E5%96%9A%E8%B5%B7">(参考) Windows VMを複製しようとしている方への注意喚起</a></p><hr><h2 id="同一テナントか否かの確認"><a href="#同一テナントか否かの確認" class="headerlink" title="同一テナントか否かの確認"></a>同一テナントか否かの確認</h2><p>先述の通り、移動・複製元 (以降、”ソース”) と移動・複製先 (以降、”ターゲット”) のテナントが同一であるか否かによって方法が大きく異なります。<br>まずは、これを確認する手順をご案内いたします。</p><p>ソース サブスクリプションとターゲット サブスクリプションが同一テナント配下に属しているか確認します。<br>Azure Portal のサブスクリプションページの「基本」タブの「ディレクトリ」にてサブスクリプションが属しているテナントがご確認いただけます。</p><p><img src="/blog/vm/vm-copy-move-scenario/img001.png"></p><p>それでは、それぞれのシナリオに応じた方法を確認していきましょう。</p><hr><h2 id="シナリオ-1-同一テナント内での-VM-の複製（コピー）"><a href="#シナリオ-1-同一テナント内での-VM-の複製（コピー）" class="headerlink" title="シナリオ 1 - 同一テナント内での VM の複製（コピー）"></a>シナリオ 1 - 同一テナント内での VM の複製（コピー）</h2><p>このシナリオの場合、OS ディスクのスナップショットから VM を複製として作成することが可能です。<br>同一テナント内であればサブスクリプションを跨いだ複製の場合も、ユーザーが両方のサブスクリプションを操作できる権限があればこの手順が使用可能です。<br>手順の詳細につきましては、以下の弊社ブログをご参考ください。   </p><p><a href="https://jpaztech.github.io/blog/vm/vm-replica-3/">(参考) VM 複製方法について part.3/3 OS ディスクのスナップショットから複製する手順</a></p><hr><h2 id="シナリオ-2-同一テナント内での-VM-移動"><a href="#シナリオ-2-同一テナント内での-VM-移動" class="headerlink" title="シナリオ 2 - 同一テナント内での VM 移動"></a>シナリオ 2 - 同一テナント内での VM 移動</h2><p>同一テナント内での VM 移動として、考えられるシナリオとしては、以下のようなものが考えられます。</p><p><strong>A：同一テナント内でのリソースグループの移動</strong><br><strong>B：同一テナント内でのサブスクリプションの移動</strong><br><strong>C：同一テナント内でのリージョンの移動</strong><br><strong>D：同一テナント内でのVNETの移動</strong>  </p><p>それぞれ以下の通り紹介させていただきます。</p><hr><h3 id="A：同一テナント内でのリソースグループの移動-および-B：同一テナント内でのサブスクリプションの移動"><a href="#A：同一テナント内でのリソースグループの移動-および-B：同一テナント内でのサブスクリプションの移動" class="headerlink" title="A：同一テナント内でのリソースグループの移動 および B：同一テナント内でのサブスクリプションの移動"></a>A：同一テナント内でのリソースグループの移動 および B：同一テナント内でのサブスクリプションの移動</h3><p>こちら両方について 2 つの方法が利用可能ですので、ご紹介させていただきます。</p><h4 id="方法-AB1"><a href="#方法-AB1" class="headerlink" title="方法 AB1:"></a>方法 AB1:</h4><p>移動したいリソースをチェックしていただき、 右上の「移動」のドロップダウンリストから「別のリソース グループに移動する」もしくは「別のサブスクリプションへ移動する」をクリックすることでリソースの移動ができます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/move-resource-group-and-subscription#use-the-portal">(参考) リソースを新しいリソース グループまたはサブスクリプションに移動する - ポータルの使用</a></p><p><img src="/blog/vm/vm-copy-move-scenario/img002.png"></p><p>移動を実施いただく前に、移動対象のリソースに対して検証が実行されますが、 何かしらの原因により移動が叶わない場合、「検証状態」が「失敗」と表示され、 「エラーの詳細」から詳細な原因が確認いただけます。 </p><p><img src="/blog/vm/vm-copy-move-scenario/img003.png"></p><p>本手順については以下のドキュメントもご参照いただけますと幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/move-limitations/virtual-machines-move-limitations">(参考) 仮想マシンをリソース グループまたはサブスクリプションに移動するという特殊なケースの処理</a></p><h4 id="方法-AB2"><a href="#方法-AB2" class="headerlink" title="方法 AB2:"></a>方法 AB2:</h4><p>先述の「シナリオ 1 - 同一テナント内での VM の複製（コピー）」の方法で VM を複製した後に元の VM を削除する手順となります。<br>上記 AB1 の方法が対応していない場合などにもご利用いただけます。</p><hr><h3 id="C：同一テナント内でのリージョンの移動"><a href="#C：同一テナント内でのリージョンの移動" class="headerlink" title="C：同一テナント内でのリージョンの移動"></a>C：同一テナント内でのリージョンの移動</h3><p>同一テナント内でのリージョンの移動についても、以下の 2 種の方法をご紹介させていただきます。</p><h4 id="方法-C1："><a href="#方法-C1：" class="headerlink" title="方法 C1："></a>方法 C1：</h4><p>Azure Resource Mover を使用してリージョン間でリソースを移動することが可能でございます。<br>詳細については以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/resource-mover/move-region-within-resource-group">(参考) Azure Resource Mover を使用してリージョン間で (リソース グループから) リソースを移動する</a></p><h4 id="方法-C2："><a href="#方法-C2：" class="headerlink" title="方法 C2："></a>方法 C2：</h4><p>後述の「シナリオ 3 - 別のテナントへの VM の複製（コピー）」と同じ手順で VM 複製を行った後に、元の VM の削除を行います。</p><hr><h3 id="D：同一テナント内での-VNET-の移動"><a href="#D：同一テナント内での-VNET-の移動" class="headerlink" title="D：同一テナント内での VNET の移動"></a>D：同一テナント内での VNET の移動</h3><p>VM を別の VNET へ移動する場合は、以下の方法で VM 再作成が必要となります。</p><p><a href="https://jpaztech.github.io/blog/vm/recreate-vm-to-change-settings/">(参考) 設定変更不可の項目を VM 再作成により再設定する手順</a></p><hr><h2 id="シナリオ-3-別のテナントへの-VM-の複製（コピー）"><a href="#シナリオ-3-別のテナントへの-VM-の複製（コピー）" class="headerlink" title="シナリオ 3 - 別のテナントへの VM の複製（コピー）"></a>シナリオ 3 - 別のテナントへの VM の複製（コピー）</h2><p>テナントを跨いでコピーしたい場合は、そのテナントへディスクを転送してから VM 作成をいただく必要があります。<br>その方法についての 2 通りの方法をご紹介させていただきます。</p><h3 id="Azure-Storage-Explorer"><a href="#Azure-Storage-Explorer" class="headerlink" title="Azure Storage Explorer"></a>Azure Storage Explorer</h3><p>GUI ツールを利用したコピー方法です。こちらは、コマンド無しで VM を別のリージョン・サブスクリプション・テナントに複製が可能です。<br>こちらの手順につきましては、弊社ブログにて詳細手順をご確認いただけますので、ぜひ参考にしてください。</p><p><a href="https://jpaztech.github.io/blog/vm/copy-vm-with-storage-explorer/">(参考) Azure Storage Explorer を用いて、コマンド無しで VM を別のリージョン・サブスクリプション・テナントに移動/複製をしてみよう</a></p><h3 id="Azcopy-コマンド"><a href="#Azcopy-コマンド" class="headerlink" title="Azcopy コマンド"></a>Azcopy コマンド</h3><p>コマンドを用いた方法となります。<br>弊社ブログにて詳細な手順をご紹介しておりますのでこちらをご参照くださいませ。</p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/">(参考) Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法</a></p><div class="alert is-warning"><p class="alert-title">警告</p><p>どちらの手順も VHD ファイルからディスクを作成する際に VM の世代をソース VM の世代と合わせる必要があります。</p></div><hr><h2 id="シナリオ-4-別のテナントへの-VM-移動"><a href="#シナリオ-4-別のテナントへの-VM-移動" class="headerlink" title="シナリオ 4 - 別のテナントへの VM 移動"></a>シナリオ 4 - 別のテナントへの VM 移動</h2><p>テナントを跨いで VM を移動したい場合は、上記の「シナリオ 3 - 別のテナントへの VM の複製（コピー）」の手順を用いて VM 複製をした後に、元の VM を削除します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>別のテナントへの VM の複製 / 移動の方法として、サブスクリプション自体を別のテナントに移転してしまうという方法もございます。</p><p>他方、影響は大きなものとなりますので、参考情報としてのご紹介となります。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/transfer-subscription">(参考)  Azure サブスクリプションを別の Microsoft Entra ディレクトリに移転する</a></p></div><p>以上が各シナリオにおける VM の複製 / 移動の方法のまとめでした。<br>これらの情報が皆様のお役に立てますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;今回は、お問い合わせいただくことの多い Azure VM の複製 / 移動方法ついてのまとめの記事となります。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>オンプレミスと Microsoft サービス間の接続パターン</title>
    <link href="https://jpaztech.github.io/blog/network/connection-method-between-microsoft-and-on-prem/"/>
    <id>https://jpaztech.github.io/blog/network/connection-method-between-microsoft-and-on-prem/</id>
    <published>2024-09-11T15:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.237Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートの宇田です。</p><p>今回は Microsoft のネットワークとの様々な接続パターンをご紹介したいと思います。皆さんが自社ないしお客様の案件で Azure や Microsoft 365 などの各種 Microsoft サービスを新たに導入する、ひいては Microsoft のネットワークと接続する際の参考となれば幸いです。</p><h2 id="ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう"><a href="#ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう" class="headerlink" title="ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう"></a>ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう</h2><p>Microsoft のクラウド サービスを利用する際、 漠然と以下の図のようにオンプレミスから Microsoft のネットワークに対して通信が行われるようなイメージをされている方も多いのではないでしょうか。</p><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-1.png"></p><p>ただ、実際は上記のようにオンプレミスと Microsoft 間でシンプルに通信している訳ではなく、下図のように Microsoft 内のネットワークも用途別に様々なセグメントに分かれています。Internet、すなわち他の通信事業者に最も近い外側の部分 (Microsoft 視点でいうと上流のネットワーク) には世界中に張り巡らされた WAN が存在し、その拠点である POP には Microsoft が提供する CDN (Azure Front Door) なども配置されています。そして、皆様がご利用になる Azure や Microsoft 365 の各サービス (データセンター) は、その WAN の下にぶら下がる利用部門/ユーザーといった位置づけとなっています。</p><p>また、Windows Update のように弊社外の CDN が利用されている場合もあります。さらに言えば、昨今のクラウド サービスでは大半の通信が SSL/TLS で暗号化されており、その際に用いられる証明書の失効確認などで、外部の認証局 (CA) に対しての通信が発生することも一般的です。このため、Internet と一切の通信ができない完全閉域などを実現することは現実的ではありません。</p><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-2.png"></p><p>以上のような経緯から、ご利用になるサービスの通信要件 (IP アドレス、FQDN など) について、ドキュメント等を事前に十分ご確認いただくことが重要です。以下に通信要件が記載されたドキュメントの一例を記載しますが、各サービスの通信要件 (IP アドレスや FQDN) 及びその用途等については、Azure Networking サポートからは正確なご案内が出来かねます。お手数ですが、各サービスの通信要件について詳細な確認が必要な場合には、各製品・サービスのサポート窓口までお問い合わせいただければと思います。(例: XXXXX というサービスの通信要件を教えてください、XXXXX.microsoft.com との通信はどのような用途で使用されますか？、XXXXX というサービスは、ExpressRoute 経由で利用できますか？)</p><h3 id="参考-代表的なサービスの通信要件"><a href="#参考-代表的なサービスの通信要件" class="headerlink" title="(参考) 代表的なサービスの通信要件"></a>(参考) 代表的なサービスの通信要件</h3><ul><li><a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/urls-and-ip-address-ranges">Microsoft 365 (Office 365)</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls">Azure Portal</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-endpoints/">Microsoft Entra ID</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/network-requirements-consolidated">Azure Arc</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-network-configuration?tabs=PowerShellWindows#firewall-endpoints">Azure Monitor Agent</a></li></ul><h2 id="通信先の-IP-アドレス-FQDN-はどこに存在するのか"><a href="#通信先の-IP-アドレス-FQDN-はどこに存在するのか" class="headerlink" title="通信先の IP アドレス / FQDN はどこに存在するのか"></a>通信先の IP アドレス / FQDN はどこに存在するのか</h2><p>上記のようなドキュメントより、利用予定のサービスの通信要件を把握したら、次にそこに記載されている IP アドレスや FQDN が Microsoft の内外どちらなのか、Microsoft 内の場合には Azure 内なのか否かを判断する必要があります。(後述しますが、ExpressRoute 経由で通信できるのは Azure 内のみであるため、Azure 外の Public IP アドレスの場合は ExpressRoute 経由では通信できないということになります。)</p><p>弊社に限らず、Public IP アドレスは ARIN や APNIC、JPNIC といったインターネット レジストリが各組織 (AS) に対して割り当てを行っています。そのため、例えば以下のようなサイトに IP アドレスを入力することで、その IP アドレスがどの組織に対して割り当てられたものかを調べることができます。(つまり、ASN    が 8075 - MICROSOFT-CORP-MSN-AS-BLOCK 等となっていれば、Microsoft に割り当てられた Public IP アドレスであると判断できます。)</p><ul><li><a href="https://db-ip.com/">https://db-ip.com/</a> (外部サイト)</li></ul><p>また、Azure で利用されている Public IP アドレス (NSG 等で利用するサービス タグ) の内訳を、以下のページで入手できる JSON ファイルで確認いただくことが可能です。この JSON ファイル内において、”AzureCloud.japaneast” 等のリージョンごとのサービス タグの内訳に含まれていれば、その Public IP アドレスは Azure 内に存在する (ExpressRoute 経由で通信ができる) と判断していただければと思います。逆に、”AzureFrontDoor.Frontend” のようなサービス単位のタグにしか含まれておらず、リージョン単位のタグに含まれていない場合は、ExpressRoute 経由では通信できませんのでご注意ください。</p><ul><li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519">Azure IP Ranges and Service Tags – Public Cloud</a></li></ul><h2 id="Microsoft-のネットワークへの接続パターン"><a href="#Microsoft-のネットワークへの接続パターン" class="headerlink" title="Microsoft のネットワークへの接続パターン"></a>Microsoft のネットワークへの接続パターン</h2><p>前置きが長くなりましたが、ここからは Microsoft のネットワークと接続する様々なパターンについて見ていきましょう。</p><h3 id="Internet"><a href="#Internet" class="headerlink" title="Internet"></a>Internet</h3><p>Microsoft の各種クラウド サービスに接続する際の最も一般的な接続方法は、Internet 経由での接続です。在宅勤務をしながら Microsoft Teams を利用したり、Azure 上でホストされている業務アプリなどを利用している方も多いのではないでしょうか。</p><p>Internet 経由と聞くと、セキュアではないという印象をもたれる方もいるかもしれません。ただ、昨今は Microsoft の各種クラウド サービスにおけるほとんどの通信は HTTPS 等で暗号化通信が行われており、Internet 経由であっても安心してご利用いただけるようになっています。また、Azure 上の仮想ネットワーク (VNet) に VPN Gateway や仮想アプライアンスを配置し、VPN 接続をおこなうことも可能です。(稀に、Microsoft 365 宛の通信を VPN 経由にしたい等のご相談をいただくことがございますが、Azure の VPN Gateway としては、そのような接続はサポートしておりません。)</p><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-3.png"></p><h3 id="ExpressRoute"><a href="#ExpressRoute" class="headerlink" title="ExpressRoute"></a>ExpressRoute</h3><p>エンタープライズのお客様などでは、セキュリティ要件で閉域網での接続が必要な場合も少なくないと思います。そうした閉域網での接続が必要な場合には、ExpressRoute での接続をご検討ください。ExpressRoute では、Azure VNet の Private なアドレス空間に接続するための Private Peering と、Azure の Public IP アドレス帯に対して接続するための Microsoft Peering の二種類の接続形態が用意されています。(なお、ExpressRoute の接続先はあくまでも Azure の世界であり、Microsoft 365 等 Azure 外に対しての疎通性はありませんのでご注意ください。)</p><p>その他 ExpressRoute に関する詳細は、公式ドキュメントや本ブログで別途投稿している “詳説 Azure ExpressRoute” の連載を併せてご参照いただければと思います。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/expressroute/">ExpressRoute のドキュメント</a></li><li><a href="/blog/archive/expressroute-deep-dive-part1/">Part1: ExpressRoute を導入する前に</a></li><li><a href="/blog/archive/expressroute-deep-dive-part2/">Part2: ExpressRoute のルーティング制御について</a></li><li><a href="/blog/archive/expressroute-deep-dive-part3/">Part3: ExpressRoute の導入手順について</a></li><li><a href="/blog/archive/expressroute-deep-dive-part4/">Part4: ExpressRoute の冗長構成について</a></li><li><a href="/blog/archive/expressroute-deep-dive-part5/">Part5: ExpressRoute の増速やプロバイダー変更について</a></li><li><a href="/blog/network/expressroute-deep-dive-part6/">Part6: ExpressRoute の各種上限値について</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-4.png"></p><h3 id="ExpressRoute-IPsec-VPN"><a href="#ExpressRoute-IPsec-VPN" class="headerlink" title="ExpressRoute + IPsec VPN"></a>ExpressRoute + IPsec VPN</h3><p>通常の ExpressRoute 回線は、閉域網での接続を行うのみであり、伝送路での暗号化は行われていません。(Internet 経由の場合と同様、昨今ではほとんどの通信は暗号化されておりますので、伝送路で暗号化をしないからといってセキュアではないというわけではありません。) </p><p>もしセキュリティ要件が極めて厳しく、伝送路での暗号化も必須であるというような場合には、ExpressRoute 越しに Azure VNet 上の VPN Gateway と IPsec VPN を張ることも可能です。ただし、伝送路での暗号化が行えるのは VPN Gateway をデプロイする関係上、Azure VNet 宛の通信のみとなります。Microsoft Peering で接続する Azure の Public IP アドレス帯への通信は伝送路では暗号化されません。</p><p>Azure VNet に対して閉域かつ伝送路での暗号化を行った上で接続したい場合は、以下のドキュメント等を参考に構成していただければと思います。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/site-to-site-vpn-private-peering">ExpressRoute プライベート ピアリング経由のサイト間 VPN 接続を構成する</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-5.png"></p><h3 id="ExpressRoute-Direct-MACsec"><a href="#ExpressRoute-Direct-MACsec" class="headerlink" title="ExpressRoute Direct (+ MACsec)"></a>ExpressRoute Direct (+ MACsec)</h3><p>Microsoft Peering も含めて、伝送路での暗号化を行われたいという場合については、通常の ExpressRoute 回線ではなく、物理ポート (10G or 100G) 占有型の L1 接続である ExpressRoute Direct のサービスを利用していただくことで、MACsec をご利用いただくことが可能です。物理ポートを買い切っていただくモデルとなるため、他の接続形態と比較して費用が高額になりますが、伝送路での暗号化が必須要件となる場合の選択肢としてご参考程度に紹介いたします。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-macsec">ExpressRoute Direct ポートで MACsec を構成する</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-6.png"></p><h3 id="Azure-Peering-Service"><a href="#Azure-Peering-Service" class="headerlink" title="Azure Peering Service"></a>Azure Peering Service</h3><p>Azure だけでなく、Microsoft 365 のサービスに対しての疎通性も必要な場合は、Azure Peering Service が選択肢となります。Azure Peering Service は、Microsoft の WAN にあたる AS8075 のネットワークと接続を行うサービスとなるため、Azure 以外の Microsoft が所有する Public IP アドレス帯へも疎通性 (経路情報) が提供されます。ただし、ExpressRoute とは異なり閉域接続を謳うサービスではありません。(PNI や IX 経由で Microsoft の AS8075 と接続いただく際と同様の接続イメージとなります。)　Azure Peering Service は、あくまでも経路の最適化による遅延の削減や信頼性向上を目的としたサービスとなりますので、その点は予めご承知おきください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/peering-service/about">Azure Peering Service の概要</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-7.png"></p><h3 id="番外編-1-オンプレミスから-Internet-宛の通信を-Azure-経由としたい場合"><a href="#番外編-1-オンプレミスから-Internet-宛の通信を-Azure-経由としたい場合" class="headerlink" title="(番外編 1) オンプレミスから Internet 宛の通信を Azure 経由としたい場合"></a>(番外編 1) オンプレミスから Internet 宛の通信を Azure 経由としたい場合</h3><p>お客様によっては、Internet への出口を一元化したい、もしくは閉域環境でやむなく一部の Internet 宛の通信を行えるようにしなければならない等の理由で、オンプレミスから Internet 宛の通信を Azure 経由で行いたいというご相談をいただくことがあります。</p><p>こうした構成を実現する場合、以下の二通りの方法が考えられます。</p><ul><li>Azure 上に Forward Proxy を構築し、プロキシ経由で通信をさせる</li><li>Azure からオンプレミスに対して BGP でデフォルト ルートを広報させる</li></ul><p>前者については、Azure VM で Proxy (Squid 等) を構築いただき、PAC ファイルや Proxy サーバー上で特定の FQDN 宛の通信のみ許可するなどの制御をいただくことになります。他方で後者については、Azure 上に Virtual WAN もしくは Route Server + NVA を構築いただく構成となり、以下のブログで詳しくご紹介しておりますので、こちらをご参照いただければと思います。</p><ul><li><a href="https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/">オンプレミスからのインターネット宛ての通信を Azure 経由にする方法</a></li></ul><h3 id="番外編-2-ゼロトラスト-ソリューションをお探しの場合"><a href="#番外編-2-ゼロトラスト-ソリューションをお探しの場合" class="headerlink" title="(番外編 2) ゼロトラスト ソリューションをお探しの場合"></a>(番外編 2) ゼロトラスト ソリューションをお探しの場合</h3><p>ここまで紹介してきた接続方法とは少し毛色が違いますが、Microsoft ではゼロトラスト (ZTNA) 向けの SSE: Secure Service Edge (SASE: Secure Access Service Edge と呼ばれることもあります) ソリューションとして、Microsoft Entra Private Access および Microsoft Entra Internet Access から構成される Global Secure Access というサービスを提供しています。従来の Firewall や VPN 装置をリプレースし、ゼロトラスト ソリューションの導入を検討されている方は、こちらをご検討いただければと思います。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/overview-what-is-global-secure-access">Global Secure Access とは</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/concept-private-access">Microsoft Entra Private Access について学習する</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/architecture/sse-deployment-guide-internet-access">Microsoft の Security Service Edge ソリューションの Microsoft Entra Internet Access 概念実証デプロイ ガイド</a></li></ul><h2 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h2><h3 id="XXXXX-というサービスを完全閉域で利用できますか"><a href="#XXXXX-というサービスを完全閉域で利用できますか" class="headerlink" title="XXXXX というサービスを完全閉域で利用できますか"></a>XXXXX というサービスを完全閉域で利用できますか</h3><p>お客様のセキュリティ要件などで Internet 接続を行うことができず、完全閉域で Microsoft の各種クラウド サービスを利用したいといったご相談をいただくことがございます。ただ、前述の通り CDN や認証局などの弊社外との通信が必要となる場合がほとんどですので、Internet 接続が何らか必要になるものと予めご理解をいただければと思います。</p><div class="alert is-info"><p class="alert-title">Note</p><p> 「ExpressRoute 経由で XXXXX というサービスに通信できるか」といったお問い合わせを ExpressRoute の質問として Azure Networking サポートにお問い合わせいただく場合がございます。ただ、ExpressRoute は BGP で経路交換を行うのみであり、各製品・サービスがどのような FQDN や IP アドレスを使用しているかといった通信要件については、Azure Networking サポートでは情報を持ち合わせておりませんため、ご案内ができません。お手数ですが、対象製品のサポート窓口まで (複数製品の場合には、製品ごとに個別に) お問い合わせいただくようお願いいたします。</p></div><h3 id="Microsoft-365-に対して、閉域網で接続することはできますか"><a href="#Microsoft-365-に対して、閉域網で接続することはできますか" class="headerlink" title="Microsoft 365 に対して、閉域網で接続することはできますか"></a>Microsoft 365 に対して、閉域網で接続することはできますか</h3><p>Microsoft 365 は、Internet からのアクセスを前提に設計されており、ExpressRoute を利用した “閉域網のみ” で利用いただくようには設計されていません。前述の通り ExpressRoute 経由では通信できない外部のエンドポイントもございますので、ExpressRoute 経由の閉域網で Microsoft 365 を利用することは原則不可とご認識ください。唯一の例外として、法的要件などで閉域接続が必須のお客様のみ、弊社担当営業へご相談をいただき、開発部門による個別の承認を得たうえで Microsoft 365 の経路情報を受け取る (ルートフィルターで Microsoft 365 関連の BGP Community を利用する) ことが可能とはなっています。ただ、この承認を得た場合であっても、Microsoft 365 のすべての通信が閉域網で行えるわけではなく、Internet 接続が必要となる点は変わりませんのでご留意ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/azure-expressroute">Azure ExpressRoute for Microsoft 365</a></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p> Microsoft 365 の ExpressRoute は、ほとんどの状況でサービスに最適な接続モデルを提供しないため 、<strong>お勧めしません 。</strong> そのため、この接続モデルを使用するには Microsoft の承認が必要です。 お客様のすべての要求を確認し、必要なまれなシナリオでのみ、Microsoft 365 の ExpressRoute を承認します。 詳細については 、<a href="https://aka.ms/erguide">ExpressRoute for Microsoft 365 ガイド</a> を参照してください。また、生産性、ネットワーク、セキュリティ チームに関するドキュメントの包括的なレビューに従って、Microsoft アカウント チームと協力して、必要に応じて例外を送信してください。 Microsoft 365 のルート フィルターを作成しようとしている未承認のサブスクリプションには、 <a href="https://support.microsoft.com/kb/3181709">エラー メッセージ</a>が表示されます。</p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure サポートの宇田です。&lt;/p&gt;
&lt;p&gt;今回は Microsoft のネットワークとの様々な接続パターンをご紹介したいと思います。皆さんが自社ないしお客様の案件で Azure や Microsoft 365 などの各種 Microsoft サービスを新た</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="Azure Peering Service" scheme="https://jpaztech.github.io/blog/tags/Azure-Peering-Service/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM での Windows Server Standard Edition 利用について</title>
    <link href="https://jpaztech.github.io/blog/vm/winsererver-standard-edition/"/>
    <id>https://jpaztech.github.io/blog/vm/winsererver-standard-edition/</id>
    <published>2024-09-10T08:31:00.000Z</published>
    <updated>2025-05-01T03:38:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの富田です。<br>本ブログ記事では、Azure VM での Windows Server Standard Edition の利用についてご案内いたします。</p><span id="more"></span><p>Azure マーケット プレイスでは、Windows Server の Datacenter Edition (Azure Edition を含む) の提供はありますが、Standard Edition の提供はありません。</p><p>もし Standard Edition の利用をされたいといった場合は、オンプレミス環境から既に所有している Standard Edition の VHD やイメージをお持ちいただくことでご利用いただくことが可能となります。<br>VHD の準備方法については以下となります。</p><p>■ご参考：Azure にアップロードする Windows VHD または VHDX を準備する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image</a></p><p>なお、Standard Edition を利用したとしても Datacenter Edition を利用したとしても、Windows Server VM にかかる料金に差異はありません。上位エディションの Datacenter Edition (Azure Edition を含む) がマーケット プレイスより利用可能ですので、特別な事情がない限り、これらの利用をご検討いただけますと幸いです。</p><p>Windows Server エディションごとの機能の比較は以下のドキュメントを参考にしてください。</p><p>■ご参考 : Windows Server のエディションの比較 | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/windows-server/get-started/editions-comparison?pivots=windows-server-2022">https://learn.microsoft.com/ja-jp/windows-server/get-started/editions-comparison?pivots=windows-server-2022</a></p><p>簡単ではございますが、上記の内容が皆様のお役に立ちますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの富田です。&lt;br&gt;本ブログ記事では、Azure VM での Windows Server Standard Edition の利用についてご案内いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Azure Files をマウントするユーザーとアクセスについて</title>
    <link href="https://jpaztech.github.io/blog/vm/azure-files-user-mount/"/>
    <id>https://jpaztech.github.io/blog/vm/azure-files-user-mount/</id>
    <published>2024-09-10T08:30:00.000Z</published>
    <updated>2025-05-01T03:38:55.363Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。  </p><p>お客様より「Windows 環境でユーザー A でマウントした Azure Files についてユーザー B より参照ができない。」というお問い合わせをいただくことがございます。<br>こちらは New-PSDrive / net use / エクスプローラーでマウントした際の仕様となっており、マウントを行ったユーザー以外のユーザーからは Azure Files のマウント先を参照できないものとなっております。<br>そのため原則としてユーザー毎にマウントを行っていただく必要がございます点、ご留意くださいませ。 </p><span id="more"></span><p>なお、Windows Server 2019 / Windows 10 以降の OS では、New-SmbGlobalMapping コマンドを利用し Azure Files をマッピングいただくことで、 全てのユーザーでのアクセスが可能かつ、Windows ユーザーがログインしていない状態でも Azure Files へのアクセスが可能となります。<br>以下に手順を紹介させていただきますが、このような状態がお客様のセキュリティ要件上問題ないものであるかご確認をいただきますようお願いいたします。</p><p>—サンプル手順— </p><ol><li>該当環境に管理者アカウントでログインします。 </li><li>Powershell を [管理者として実行] から起動します。 </li><li>以下のコマンドの ＜＞ で指定している部分をご自身の環境に合わせて変更してから順に実行します。 </li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 共有で使用するアカウントを指定 </span></span><br><span class="line"><span class="variable">$User</span> = <span class="string">&quot;localhost\＜ストレージアカウント名＞&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 上記アカウントのパスワードを指定 </span></span><br><span class="line"><span class="variable">$PWord</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="string">&quot;＜ストレージアカウントアクセスキー＞&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## クレデンシャルを作成 </span></span><br><span class="line"><span class="variable">$Credential</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> System.Management.Automation.PSCredential <span class="literal">-ArgumentList</span> <span class="variable">$User</span>, <span class="variable">$PWord</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## -RemotePath に共有のパスを指定、-LocalPath にマッピングするドライブを指定 </span></span><br><span class="line"><span class="built_in">New-SmbGlobalMapping</span> <span class="literal">-RemotePath</span> \\＜ストレージアカウント名＞.file.core.windows.net\＜ファイル共有名＞ <span class="literal">-Credential</span> <span class="variable">$Credential</span> <span class="literal">-LocalPath</span> Z: <span class="literal">-Persistent</span> <span class="variable">$True</span> </span><br></pre></td></tr></table></figure><ol start="4"><li>一度サインアウトすることで、アクセス可能となります。 </li></ol><p>—手順ここまで— </p><p>■ご参考：Azure Files とは<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction">https://learn.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction</a></p><p>■ご参考： New-SmbGlobalMapping<br><a href="https://learn.microsoft.com/en-us/powershell/module/smbshare/new-smbglobalmapping">https://learn.microsoft.com/en-us/powershell/module/smbshare/new-smbglobalmapping</a>　 </p><p>上記の内容がお客様のお役に立てますと幸いでございます。 </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。  &lt;/p&gt;
&lt;p&gt;お客様より「Windows 環境でユーザー A でマウントした Azure Files についてユーザー B より参照ができない。」というお問い合わせをいただくことがございます。&lt;br&gt;こちらは New-PSDrive / net use / エクスプローラーでマウントした際の仕様となっており、マウントを行ったユーザー以外のユーザーからは Azure Files のマウント先を参照できないものとなっております。&lt;br&gt;そのため原則としてユーザー毎にマウントを行っていただく必要がございます点、ご留意くださいませ。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Azure Files" scheme="https://jpaztech.github.io/blog/tags/Azure-Files/"/>
    
  </entry>
  
  <entry>
    <title>Azure Bastion 接続不可の対処方法とよくあるお問い合わせ</title>
    <link href="https://jpaztech.github.io/blog/network/bastion-troubleshooting/"/>
    <id>https://jpaztech.github.io/blog/network/bastion-troubleshooting/</id>
    <published>2024-08-15T08:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.237Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの角村です。</p><p>今回は、Bastion 接続不可の際の原因の切り分け方法や原因ごとの対処法、よくあるお問い合わせについてご紹介します。<br>現在、Bastion に関するお問い合わせの約半分が接続不可に関するものですが、その原因は様々です。<br>トラブルシューティングの際には、原因の切り分けと、特定された原因に応じた対処方法を実施することで、問題が解消する可能性があります。</br></p><p>実際に Bastion 経由で VM への接続ができない場合は、まず以下の点を確認してみてください。</p><span id="more"></span><h2 id="特定の-VM-のみ-複数台の-VM-で発生している事象なのか"><a href="#特定の-VM-のみ-複数台の-VM-で発生している事象なのか" class="headerlink" title="特定の VM のみ/複数台の VM で発生している事象なのか"></a>特定の VM のみ/複数台の VM で発生している事象なのか</h2><p>接続の問題が Bastion 側にあるのか、もしくは VM 側にあるのかを切り分けるための判断材料になります。<br>もしも特定の VM のみが接続不可となっている場合、主な原因として考えられる内容および対処方法は以下のとおりです。</br></p><h3 id="・VM-および-VM-の-サブネットに適用された-NSG-において、通信が許可されていない可能性"><a href="#・VM-および-VM-の-サブネットに適用された-NSG-において、通信が許可されていない可能性" class="headerlink" title="・VM および VM の サブネットに適用された NSG において、通信が許可されていない可能性"></a><strong>・VM および VM の サブネットに適用された NSG において、通信が許可されていない可能性</strong></h3><p>Bastion - VM 間で RDP/SSH 通信が拒否されてしまっている場合、Bastion のサブネットから VM のサブネットへの SSH もしくは RDP (TCP ポート 22 もしくは TCP ポート 3389) の許可をするよう NSG の受信ルールを設定いただく必要がございます。</br><br>NSG の設定例については以下の公式ブログでご紹介しておりますので、ご一読いただけますと幸いです。<br><a href="https://jpaztech.github.io/blog/network/bastion-nsg/#VM-%E3%81%8A%E3%82%88%E3%81%B3-VM-%E3%81%AE%E3%82%B5%E3%83%96%E3%83%8D%E3%83%83%E3%83%88%E3%81%AE-NSG-%E3%81%AE%E5%8F%97%E4%BF%A1%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E8%A6%8F%E5%89%87">VM および VM のサブネットの NSG の受信セキュリティ規則</a></p><h3 id="・接続情報に誤りがある可能性"><a href="#・接続情報に誤りがある可能性" class="headerlink" title="・接続情報に誤りがある可能性"></a><strong>・接続情報に誤りがある可能性</strong></h3><p>接続情報に関しては、作成の際に間違えて登録してしまうケースや、久しぶりに仮想マシンを利用する際の記憶違いや記録ミスなど、日常的に起こしやすいエラーの1つです。過去のお問合せでは、パスワード リセットによって事象が解消したケースもございます。<br>パスワード リセット方法については以下の公開情報にてご案内しておりますので参考になりましたら幸いです。<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/windows/reset-rdp">Windows VM でリモート デスクトップ サービスまたはその管理者パスワードをリセットする - Virtual Machines | Microsoft Learn</a><br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/linux/reset-password">Azure VM 上でローカルの Linux パスワードをリセットする方法 - Virtual Machines | Microsoft Learn</a></p><p>複数台の VM において事象が発生している場合は、AzureBastionSubnet に関連付けられた NSG でパブリック インターネット、もしくはクライアントの グローバル IP アドレス範囲からの通信が許可されているかをご確認ください。<br>NSG の設定内容についての詳細は<a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-nsg#nsg">こちら</a>をご確認ください。</p><h2 id="特定のクライアント端末でのみ発生している事象なのか"><a href="#特定のクライアント端末でのみ発生している事象なのか" class="headerlink" title="特定のクライアント端末でのみ発生している事象なのか"></a>特定のクライアント端末でのみ発生している事象なのか</h2><p>クライアント PC 側に要因があるかどうかを切り分けるための判断材料になります。<br>特定のクライアントのみ事象が発生している場合、さらに以下の点をご確認いただく事で事象が解消する可能性があります。</br></p><h3 id="・ブラウザ-の拡張機能"><a href="#・ブラウザ-の拡張機能" class="headerlink" title="・ブラウザ の拡張機能"></a><strong>・ブラウザ の拡張機能</strong></h3><p>ブラウザの拡張機能が接続不可の要因となっている可能性があります。<br>可能であればブラウザの拡張機能を無効化の上、接続をお試しいただくか、InPrivate/シークレットモードを利用いただく事で事象が解消する可能性があります。<br>また、ブラウザによっては Bastion の利用がサポートされていない点についてもご注意ください。</p><p>参考- <a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-faq#browsers">どのブラウザーがサポートされていますか?</a></p><h3 id="・クライアント-PCおよび、ネットワークの問題"><a href="#・クライアント-PCおよび、ネットワークの問題" class="headerlink" title="・クライアント PCおよび、ネットワークの問題"></a><strong>・クライアント PCおよび、ネットワークの問題</strong></h3><p>クライアント 側の のプロキシ設定や ファイヤーウォールが Bastion への接続をブロックしている可能性があります。<br>その場合、&lt;*.bastion.azure.com&gt; への 443 (https) を許可いただく事で、事象が解消する可能性があります。</br><br>なお、Bastion はご利用方法によって URL が追加で必要になる場合があります。<br>例えば、ポータルから Bastion 経由で VM へ接続する場合は、上記 Bastion の URL 以外に、ポータルへの接続/操作のため、&lt;*.portal.azure.com&gt; の許可が現状の動作として必要です。</p><p>参考- <a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls?tabs=public-cloud">ファイアウォールまたはプロキシ サーバーで Azure portal の URL を許可する</a></p><hr><p>上記をご確認いただいても事象が解消しなかった場合や、該当する事象ではない場合は、Azure サポートまでお問い合わせください。<br>その際は、既にご確認いただいた内容と併せて、以下の点について情報提供いただけますと幸いです。</br></p><hr><blockquote><p><strong>・ 直近で接続不可となってしまった日時 (日本時間)</strong></p></blockquote><p>Azure 基盤側で接続不可時のログを確認する際に必要な情報となります。</p><blockquote><p><strong>・ Bastion および接続不可 VM のリソース ID</strong></p></blockquote><p>リソース ID は、リソース画面 左ブレード メニューの [概要] から 、画面右上の [JSON ビュー] をクリックいただくと確認可能でございます。<br>※お問合せ起票時に Bastion リソースを選択して起票いただいている場合は、接続不可 VM のリソース ID のみ、別途お問い合わせ内容に記載ください。</p><blockquote><p><strong>・ 接続エラー時のスクリーン ショット、もしくは接続実行コマンドと実行結果</strong></p></blockquote><p>ブラウザ経由で接続に失敗する場合は、発生したエラーの内容がわかるスクリーン ショットをご提供ください。<br>Azure CLI から az network bastion コマンドを利用している場合は、 debug オプションを付けた状態で実行コマンドと実行結果をご教示いただけますと幸いです。<br>以下に実行いただきたいコマンドの例を記載いたします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az network bastion rdp --name &lt;Bastion リソース名&gt; --resource-group &lt;Bastion が存在するリソース グループ名&gt; --target-resource-id &lt;ターゲット VM のリソース ID&gt; --debug</span><br></pre></td></tr></table></figure><p>※ 上記は RDP 接続時のコマンドとなります。お客様の接続方法に合わせてコマンドを変更ください</p><blockquote><p><strong>・ Bastion を経由せずに VM へ直接 RDP/SSH が可能かどうか</strong></p></blockquote><p>接続先 VM にパブリック IP が付与されている場合、クライアント PC からネイティブ クライアントを利用して直接 RDP/SSH 接続が可能かご確認ください。<br>もしくは、同一 Vnet 上の別 VM から 直接 RDP 接続が可能か確認いただくという方法でも問題ございません。</br></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>その他、接続不可以外によくお問い合わせいただく内容についても以下にまとめてみましたので、参考になりましたら幸いです。</p><h3 id="Bastion-で-Windows-Server-に対する同時-RDP-接続数について"><a href="#Bastion-で-Windows-Server-に対する同時-RDP-接続数について" class="headerlink" title="Bastion で Windows Server に対する同時 RDP 接続数について"></a>Bastion で Windows Server に対する同時 RDP 接続数について</h3><p>Bastion 経由で Windows Server に対する RDP の同時接続数は、現在 2 接続となっています。<br>サポート担当で動作を確認する限り、現在の Bastion における RDP 接続時の動作として、Windows Server に管理モードで RDP 接続をしています。<br>Windows Server の管理モードでの RDP 接続は、最大同時接続数が 2 となっており、この同時接続数を増やすことは出来ません。<br>なお、Bastion は複数の同時 RDP 接続が可能な RDS セッション ホストや Azure Virtual Desktop への RDP 接続には利用できません。<br>参考- <a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-faq">Azure Bastion に関する FAQ</a></p><h3 id="Bastion-インスタンスあたりのセッション数上限に達した際に検知したい"><a href="#Bastion-インスタンスあたりのセッション数上限に達した際に検知したい" class="headerlink" title="Bastion インスタンスあたりのセッション数上限に達した際に検知したい"></a>Bastion インスタンスあたりのセッション数上限に達した際に検知したい</h3><p>インスタンスあたりの同時接続数上限に達した際、それを検知してインスタンスをスケーリングさせたいというお問い合わせをいただく事がございます。<br>ご期待に沿えず恐れ入りますが、直接的にインスタンスあたりのセッション数の上限を検知する方法はありません。<br>そのため、例えばリモート接続で操作している VM の画面遷移が遅いなどの利用者からのフィード バックや、Bastion で監視可能なメトリックの情報を組み合わせて、お客様自身でインスタンスをスケールさせるタイミングをご判断いただく必要がございます。<br>なお、Bastion で監視可能なメトリックの一覧については<a href="https://learn.microsoft.com/ja-jp/azure/bastion/howto-metrics-monitor-alert">こちら</a>をご確認ください。</p><p>また、以下の公開情報では Bastion インスタンスあたりの同時接続可能数について記載されていますが、あくまで目安の数値となります。実際のご利用方法によって、インスタンスあたりの接続数上限は前後する点についてもご留意ください。<br>参考- <a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#azure-bastion-limits">Azure Bastion の制限</a></p><h3 id="Bastion-が対応している認証方法について"><a href="#Bastion-が対応している認証方法について" class="headerlink" title="Bastion が対応している認証方法について"></a>Bastion が対応している認証方法について</h3><p>Bastion 接続時に利用可能な認証方法は、ご利用いただくプロトコルや SKU によって異なります。<br>ご利用環境と認証方式のミスマッチが起きているお問い合わせが散見されるため、以下のとおり表にまとめました。</br></p><table><thead><tr><th>プロトコル</th><th>接続方法</th><th>認証方法</th><th>対応 SKU</th></tr></thead><tbody><tr><td>RDP</td><td>ブラウザ</td><td>・ユーザー/PW を手入力<br>・PW を Key Vault から読み込む</td><td>・Developer<br>・Basic<br>・Standard<br>・Premium</td></tr><tr><td>RDP</td><td>ネイティブ クライアント</td><td>・ユーザー/PW を手入力<br>・Entra ID 認証</td><td>・Standard<br>・Premium</td></tr><tr><td>RDP</td><td>共有可能リンク</td><td>・ユーザー/PW を手入力</td><td>・Standard<br>・Premium</td></tr><tr><td>SSH</td><td>ブラウザ</td><td>・ユーザー/PW を手入力<br>・PW を Key Vault から読み込む<br>・SSH Key をローカルから読み込む<br>・SSH Key を Key Vault から読み込む</td><td>・Developer<br>・Basic<br>・Standard<br>・Premium</td></tr><tr><td>SSH</td><td>ネイティブ クライアント</td><td>・ユーザー/PW を手入力<br>・Entra ID 認証<br>・SSH Key をローカルから読み込む</td><td>・Standard<br>・Premium</td></tr><tr><td>SSH</td><td>共有可能リンク</td><td>・ユーザー/PW を手入力<br>・SSH Key をローカルから読み込む</td><td>・Standard<br>・Premium</td></tr></tbody></table><h3 id="Bastion-接続時の解像度を調節したい"><a href="#Bastion-接続時の解像度を調節したい" class="headerlink" title="Bastion 接続時の解像度を調節したい"></a>Bastion 接続時の解像度を調節したい</h3><p>ご期待に沿えず恐れ入りますが、ブラウザから Bastion を利用してリモート接続されている場合は、解像度を変更いただく事はできません。<br>ネイティブ クライアント接続をご利用されている場合は、以下の手順で解像度の調節が可能となります。</br></p><ol><li><p>ネイティブ クライアント接続コマンドの末尾に ”–configure” オプションを付けて実行</br><br>実行コマンド例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az network bastion rdp --name &lt;Bastion リソース名&gt; --resource-group &lt;Bastion が存在するリソース グループ名&gt; --target-resource-id &lt;ターゲット VM のリソース ID&gt; --configure</span><br></pre></td></tr></table></figure></li><li><p>コマンド実行後、リモート デスクトップ画面が開くので、[画面] タブをクリック</br></p></li></ol><p><img src="/blog/network/bastion-troubleshooting/resolution-2.jpg"> </p></br>  3. 「画面の設定」にて、“リモート セッションですべてのモニターを使用する” のチェックをお外しいただき、上部のスライダーを操作いただく事で解像度の設定が可能となります。</br><p><img src="/blog/network/bastion-troubleshooting/resolution-3.jpg"> </p><p>以上、本情報が参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの角村です。&lt;/p&gt;
&lt;p&gt;今回は、Bastion 接続不可の際の原因の切り分け方法や原因ごとの対処法、よくあるお問い合わせについてご紹介します。&lt;br&gt;現在、Bastion に関するお問い合わせの約半分が接続不可に関するものですが、その原因は様々です。&lt;br&gt;トラブルシューティングの際には、原因の切り分けと、特定された原因に応じた対処方法を実施することで、問題が解消する可能性があります。&lt;/br&gt;&lt;/p&gt;
&lt;p&gt;実際に Bastion 経由で VM への接続ができない場合は、まず以下の点を確認してみてください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Bastion" scheme="https://jpaztech.github.io/blog/tags/Bastion/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway 書き換え規則の事例集</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-rewrite/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-rewrite/</id>
    <published>2024-07-03T22:00:00.000Z</published>
    <updated>2025-05-01T03:38:55.226Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Networking サポート チームの三島です。<br>Application Gateway v2 では HTTP ヘッダーなどのパラメーターを書き換える機能を提供しています。<br>この記事は、Application Gateway 書き換え規則に関してよく寄せられるお問い合わせをもとに事例集として再構成したものです。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Application Gateway では書き換え規則をサポートしています (※Standard_v2 / WAF_v2 SKU のみ)。<br>書き換え規則を使用することで、要求および応答中のヘッダーや URL を書き換えることができます。<br>この機能により、事例集に記載したような様々なシナリオに対応することが可能です。</p><h2 id="事例集"><a href="#事例集" class="headerlink" title="事例集"></a>事例集</h2><p>早速事例を紹介いたします。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#common-scenarios-for-header-rewrite">Microsoft Learn でも書き換え規則のシナリオをご紹介</a>しておりますので併せてご確認ください。</p><h3 id="事例-1-Location-ヘッダーの書き換え"><a href="#事例-1-Location-ヘッダーの書き換え" class="headerlink" title="事例 1 - Location ヘッダーの書き換え"></a>事例 1 - Location ヘッダーの書き換え</h3><p>サポート チームにいただくお問い合わせの中で最も多いのが Location ヘッダーの書き換えです。<br>Location ヘッダーの書き換えには複数のパターンがありますが、代表的なものは以下の 3 つです。  </p><ul><li>FQDN の書き換え: バックエンド サーバーが生成する URL の FQDN を、クライアント アクセス用の FQDN に書き換える (例: <em><a href="https://contoso.azurewebsites.net/">https://contoso.azurewebsites.net</a></em> -&gt; <em><a href="https://www.contoso.com/">https://www.contoso.com</a></em>、<em><a href="https://192.168.0.4/">https://192.168.0.4</a></em> -&gt; <em><a href="https://www.contoso.com/">https://www.contoso.com</a></em>)</li><li>URL スキームの書き換え: バックエンド サーバーが生成する URL のスキームを HTTP から HTTPS に書き換える (<em><a href="http://www.contoso.com/">http://www.contoso.com</a></em> -&gt; <em>http*<em>s</em></em>://<a href="http://www.contoso.com/">www.contoso.com</a>*)</li><li>リダイレクト ポートの書き換え: バックエンド サーバーが生成する URL のリダイレクト ポートを Application Gateway で書き換える (<em><a href="https://www.contoso.com/">https://www.contoso.com</a></em> -&gt; <em><a href="https://www.contoso.com:8443/">https://www.contoso.com:8443</a></em>)</li></ul><h4 id="事例-1-1-FQDN-の書き換え"><a href="#事例-1-1-FQDN-の書き換え" class="headerlink" title="事例 1-1 FQDN の書き換え"></a>事例 1-1 FQDN の書き換え</h4><h5 id="代表的なシナリオ"><a href="#代表的なシナリオ" class="headerlink" title="代表的なシナリオ"></a>代表的なシナリオ</h5><p>よくあるシナリオとしては、Application Gateway の背後に App Service (認証なし) を配置している構成です。<br>App Service においてカスタム ドメインが構成されていない場合、App Service が生成する Location ヘッダーのリダイレクト URL の FQDN は App Service 既定の FQDN <code>*.azurewebsites.net</code> が使用されます。<br>Application Gateway は、App Service が生成した Location ヘッダーをそのままクライアントに応答するため、クライアントは受け取ったリダイレクト URL の FQDN <code>*.azurewebsites.net</code> に直接アクセス (Application Gateway をバイパス) します。<br>App Service におけるアクセス制御の状態 (Application Gateway からのアクセスのみに限定しているなど) によっては、クライアントが App Service から接続を拒否され、リダイレクト URL にアクセスできないという結果になります。<br>また、クライアントにバックエンド サーバーの URL を公開したくないというご要件がある場合もこのシナリオで対応可能です。  </p><h5 id="構成例"><a href="#構成例" class="headerlink" title="構成例"></a>構成例</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/architecture/best-practices/host-name-preservation">Microsoft Learn でご案内しているとおり</a>、リバース プロキシ経由で Web アプリケーションにアクセスする構成では、Cookie やリダイレクト URL が正しく機能せず認証やセッションの問題が発生することがあるため、クライアントがリバース プロキシにアクセスする際に指定するホスト名とリバース プロキシがバックエンドにアクセスする際に指定するホスト名は、一致するように構成することが推奨されます。<br>しかしながら、何からの制約でリバース プロキシ側で URL を書き換える必要がある場合、Application Gateway の書き換え規則が有効です。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#modify-a-redirection-url">こちらの例</a>を参考に URL を書き換えます。</p><h4 id="事例-1-2-URL-スキームの書き換え"><a href="#事例-1-2-URL-スキームの書き換え" class="headerlink" title="事例 1-2 URL スキームの書き換え"></a>事例 1-2 URL スキームの書き換え</h4><h5 id="代表的なシナリオ-1"><a href="#代表的なシナリオ-1" class="headerlink" title="代表的なシナリオ"></a>代表的なシナリオ</h5><p>バックエンド サーバーが HTTP で動作しており、バックエンド サーバーが生成する Location ヘッダーの URL スキームが <code>http://</code> になってしまうという事例です。<br>Location ヘッダーを受け取ったクライアントは、HTTP で Application Gateway にアクセスします。Application Gateway で HTTP リスナーが動作していない場合はアクセスが失敗し、HTTP リスナーでリダイレクトが構成されている場合は不要なリダイレクトが発生するといった結果になります。</p><h5 id="構成例-1"><a href="#構成例-1" class="headerlink" title="構成例"></a>構成例</h5><p>以下のような書き換え規則を作成します。</p><h6 id="If"><a href="#If" class="headerlink" title="If"></a>If</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>HTTP ヘッダー</td><td>-</td></tr><tr><td>ヘッダーの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>http:\/\/(.*)</td><td>http:// で始まり、任意の文字列が 1 回以上で構成される URL を正規表現で表しています。<br>バックエンド サーバーが生成する URL に応じて任意の正規表現が構成可能です。<br><code>\</code>は環境によっては円マークが表示されますがバックスラッシュです。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>ヘッダー値</td><td>https://{http_resp_Location_1}</td><td>書き換え後のヘッダー値は「<code>https://</code> で始まり、応答の Location ヘッダーを正規表現によりキャプチャした 1 番目のグループで構成される URL」を返却するように構成しています。<br>If 条件において URL パスも含めてグループ 1 としてキャプチャするように正規表現を構成しているため、この正規表現でスキーム以降の URL パスが維持されます。<br>ほかの要件がある場合は If 条件の正規表現を修正し、{http_resp_Location_n} を組み合わせて応答 URL を構成することができます。</td></tr></tbody></table><h4 id="事例-1-3-リダイレクト-ポートの書き換え"><a href="#事例-1-3-リダイレクト-ポートの書き換え" class="headerlink" title="事例 1-3 リダイレクト ポートの書き換え"></a>事例 1-3 リダイレクト ポートの書き換え</h4><h5 id="代表的なシナリオ-2"><a href="#代表的なシナリオ-2" class="headerlink" title="代表的なシナリオ"></a>代表的なシナリオ</h5><p>バックエンド サーバーが HTTPS (デフォルト ポートの 443) で動作しており、Application Gateway がカスタム ポート (例として 8443) でリクエストをリッスンしている構成を考えます。<br>バックエンド サーバーは、Location ヘッダーの URL を HTTPS のデフォルト ポート (443) <code>https://www.contoso.com</code> で生成します。<br>Location ヘッダーを受け取ったクライアントは、HTTPS:443 で Application Gateway にアクセスします。しかしながら、Application Gateway がリッスンしているポートはカスタム ポートのため、リダイレクト先にアクセスできないという結果となります。  </p><h5 id="構成例-2"><a href="#構成例-2" class="headerlink" title="構成例"></a>構成例</h5><p>以下のような書き換え規則を作成します。</p><h6 id="If-1"><a href="#If-1" class="headerlink" title="If"></a>If</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>HTTP ヘッダー</td><td>-</td></tr><tr><td>ヘッダーの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>https:\/\/<a href="http://www.contoso.com(.*)/">www.contoso.com(.*)</a></td><td><code>https://www.contoso.com</code> で始まる任意の URL パスを正規表現でキャプチャしています。<br>バックエンド サーバーが生成する URL に応じて任意の正規表現が構成可能です。<br><code>\</code>は環境によっては円マークが表示されますがバックスラッシュです。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果-1"><a href="#結果-1" class="headerlink" title="結果"></a>結果</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>ヘッダー値</td><td><a href="https://www.contoso.com:8443{http_resp_Location_1}">https://www.contoso.com:8443{http_resp_Location_1}</a></td><td>書き換え後のヘッダー値は「<code>https://www.contoso.com:8443</code> で始まり、応答の Location ヘッダーを正規表現によりキャプチャした 1 番目のグループで構成される URL」を返却するように構成しています。<br>If 条件において URL パス部分をグループ 1 としてキャプチャするように正規表現を構成しているため、カスタム ポートを追加した状態のリダイレクト URL に書き換えることが可能です。<br>ほかの要件がある場合は If 条件の正規表現を修正し、{http_resp_Location_n} を組み合わせて応答 URL を構成することができます。</td></tr></tbody></table><h3 id="事例-2-ルーティング時に先頭パスを削除する"><a href="#事例-2-ルーティング時に先頭パスを削除する" class="headerlink" title="事例 2 - ルーティング時に先頭パスを削除する"></a>事例 2 - ルーティング時に先頭パスを削除する</h3><p>パスベース ルーティングを構成して複数のバックエンド サーバーに要求を振り分けているものの、複数のバックエンド サーバーが同一のパス階層を持つシナリオです。<br>具体例として以下のようなシナリオを考えます。  </p><ul><li>多言語対応のために、言語ごとにバックエンド サーバーを用意する</li><li>クライアントの要求 URL の先頭パスに応じて振り分けるバックエンド サーバーを制御する</li><li>クライアントの要求 URL の先頭パスが <code>/ja-jp/</code> のときは日本語コンテンツを提供するバックエンド サーバーに、<code>/en-us/</code> のときは英語コンテンツを提供するバックエンド サーバーに振り分けるようにパス ベース ルーティングを構成</li><li>ただし、バックエンド サーバーでは言語設定を制御する <code>/ja-jp/</code> や <code>/en-us/</code> のパス配下では動作しておらず、すべてのバックエンド サーバーが同一のパス階層を持っている</li></ul><h4 id="書き換え規則が必要な理由"><a href="#書き換え規則が必要な理由" class="headerlink" title="書き換え規則が必要な理由"></a>書き換え規則が必要な理由</h4><p>既定の Application Gateway の設定では、Application Gateway はクライアントから受け取った要求 URL パスをそのままバックエンド サーバーにルーティングします。<br>パスベース ルーティングを使用して要求 URL の先頭パスに応じてバックエンド サーバーを振り分ける場合には、先頭パスも含めてバックエンド サーバーにルーティングされます。(<em><a href="https://www.contoso.com/ja-jp/contents/example.html">https://www.contoso.com/ja-jp/contents/example.html</a></em> への要求は <em>https://&lt;バックエンド サーバーのホスト名&gt;/ja-jp/contents/example.html</em> にルーティングされます。)<br>一方で、このシナリオの場合、バックエンド サーバーは <code>/ja-jp/</code> 配下でコンテンツを提供しておらず <code>/contents/</code> 配下でコンテンツを提供しているため、パスの不一致によりリクエストしたコンテンツが存在しない (404 エラー) という結果になります。<br>このため、Application Gateway の書き換え規則を用いて <code>/ja-jp/</code> や <code>/en-us/</code> のパスを削除します。</p><h4 id="構成例-3"><a href="#構成例-3" class="headerlink" title="構成例"></a>構成例</h4><p>以下のような書き換え規則を作成し、パスベースの規則に関連付けます。</p><h6 id="If-バックエンド-URL-から-ja-jp-を削除"><a href="#If-バックエンド-URL-から-ja-jp-を削除" class="headerlink" title="If (バックエンド URL から /ja-jp/ を削除)"></a>If (バックエンド URL から /ja-jp/ を削除)</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>サーバー変数</td><td>-</td></tr><tr><td>サーバー変数</td><td>request_uri</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>(.*)\/ja-jp(.*)</td><td>シナリオ例では先頭パスが <code>/ja-jp/</code> ですが、<code>/ja-jp/</code> の前に <code>(.*)</code> を追加することでパスの途中に <code>/ja-jp/</code> が存在するパターンにも対応させています。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果-バックエンド-URL-から-ja-jp-を削除"><a href="#結果-バックエンド-URL-から-ja-jp-を削除" class="headerlink" title="結果 (バックエンド URL から /ja-jp/ を削除)"></a>結果 (バックエンド URL から /ja-jp/ を削除)</h6><table><thead><tr><th>設定値</th><th>値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>URL</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>コンポーネント</td><td>URL パス</td><td>-</td></tr><tr><td>URL パスの値</td><td>{var_request_uri_1}{var_request_uri_2}</td><td>If 条件の正規表現でキャプチャしたサーバー変数 request_uri のグループ 1 およびグループ 2 を抽出することでパス <code>/ja-jp/</code> の削除を実現しています。<br><code>/ja-jp/</code> が先頭パスの場合はグループ 1 は空の文字列となります。</td></tr><tr><td>パス マップの再評価</td><td>チェックしない</td><td>バックエンド プールの選択は Application Gateway に着信した URL パス (/ja-jp/ を含むもの) に基づいて行われるため再評価は不要です。</td></tr></tbody></table><h6 id="If-バックエンド-URL-から-en-us-を削除"><a href="#If-バックエンド-URL-から-en-us-を削除" class="headerlink" title="If (バックエンド URL から /en-us/ を削除)"></a>If (バックエンド URL から /en-us/ を削除)</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>サーバー変数</td><td>-</td></tr><tr><td>サーバー変数</td><td>request_uri</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>(.*)\/en-us(.*)</td><td>シナリオ例では先頭パスが <code>/en-us/</code> ですが、<code>/en-us/</code> の前に <code>(.*)</code> を追加することでパスの途中に <code>/en-us/</code> が存在するパターンにも対応させています。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果-バックエンド-URL-から-en-us-を削除"><a href="#結果-バックエンド-URL-から-en-us-を削除" class="headerlink" title="結果 (バックエンド URL から /en-us/ を削除)"></a>結果 (バックエンド URL から /en-us/ を削除)</h6><table><thead><tr><th>設定値</th><th>値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>URL</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>コンポーネント</td><td>URL パス</td><td>-</td></tr><tr><td>URL パスの値</td><td>{var_request_uri_1}{var_request_uri_2}</td><td>If 条件の正規表現でキャプチャしたサーバー変数 request_uri のグループ 1 およびグループ 2 を抽出することでパス <code>/en-us/</code> の削除を実現しています。<br><code>/en-us/</code> が先頭パスの場合はグループ 1 は空の文字列となります。</td></tr><tr><td>パス マップの再評価</td><td>チェックしない</td><td>バックエンド プールの選択は Application Gateway に着信した URL パス (/en-us/ を含むもの) に基づいて行われるため再評価は不要です。</td></tr></tbody></table><h3 id="事例-3-X-Forwarded-For-ヘッダーの値をもとにルーティングを行う"><a href="#事例-3-X-Forwarded-For-ヘッダーの値をもとにルーティングを行う" class="headerlink" title="事例 3 - X-Forwarded-For ヘッダーの値をもとにルーティングを行う"></a>事例 3 - X-Forwarded-For ヘッダーの値をもとにルーティングを行う</h3><p>少し複雑なシナリオですが、パスベース ルーティングと書き換え規則を組み合わせることで、X-Forwarded-For ヘッダーに含まれるクライアント IP アドレスをもとに特定のバックエンド サーバーにルーティングすることが可能です。<br>具体例として以下のようなシナリオを考えます。  </p><ul><li>特定のクライアントからのアクセスは特定のバックエンド サーバーにルーティングしたい</li><li>ただし、クライアントはプロキシ経由で Application Gateway にアクセスしており、Application Gateway が認識するクライアント IP アドレスはプロキシの IP アドレスとなる</li><li>このため、X-Forwarded-For ヘッダーに含まれる元のクライアント IP アドレスをもとにルーティングしたい</li></ul><p><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#parameter-based-path-selection">こちらのシナリオ</a>のパラメーターとして、クエリ文字列の代わりに X-Forwarded-For ヘッダーを使用しているとお考えください。</p><h4 id="構成例-4"><a href="#構成例-4" class="headerlink" title="構成例"></a>構成例</h4><p>以下のようなパスベース ルーティングおよび書き換え規則を作成します。</p><h6 id="パスベース-ルーティング"><a href="#パスベース-ルーティング" class="headerlink" title="パスベース ルーティング"></a>パスベース ルーティング</h6><p>2 種類のバックエンド プールを用意し、既定のルーティング先をバックエンド プール#1、パスベース ルーティングに合致した場合のルーティング先をバックエンド プール#2 とします。</p><ul><li>パックエンド プール#1<br>バックエンド サーバー： VM#1</li><li>パックエンド プール#2<br>バックエンド サーバー： VM#2</li><li>要求ルーティング規則<br>種類：パスベース<br>既定のバックエンド プール： パックエンド プール#1<br>パスベースの規則： /path2 -&gt; パックエンド プール#2  </li></ul><h6 id="書き換え規則-If"><a href="#書き換え規則-If" class="headerlink" title="書き換え規則 (If)"></a>書き換え規則 (If)</h6><table><thead><tr><th>設定値</th><th>値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>サーバー変数</td><td>-</td></tr><tr><td>サーバー変数</td><td>add_x_forwarded_for_proxy</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン (例 1)</td><td>192\.0\.2\.1(.*)</td><td>add_x_forwarded_for_proxy サーバー変数の先頭に、元の IP アドレスが含まれる (つまり、「IP1, IP2, IP3・・・」のカンマ区切りのうち IP1 がマッチ対象) 場合の正規表現例です。複数の IP アドレスをマッチ対象としたい場合は、IP アドレスごとに書き換え規則を作成します。<br>※192.0.2.1 は例示用の IP アドレスです。実際には元のクライアント IP アドレスを入力します。</td></tr><tr><td>一致させるパターン  (例 2)</td><td>192\.0\.2\.(2[0-4]\d|25[0-5]|[01]?\d\d?)(.*)</td><td>マッチ対象の IP アドレスがプレフィックス単位で特定可能な場合は、プレフィックスに含まれる全 IP アドレスにマッチさせるように正規表現を構成することも可能です。<br>これは 192.0.2.0/24 のアドレス プレフィックス (第 4 オクテットが 0 -255 の IP アドレス) にマッチさせる場合の正規表現例です。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="書き換え規則-結果"><a href="#書き換え規則-結果" class="headerlink" title="書き換え規則 (結果)"></a>書き換え規則 (結果)</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>URL</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>コンポーネント</td><td>URL パス</td><td>-</td></tr><tr><td>URL パスの値</td><td>/path2</td><td>パスベース ルーティングに一致させたいパスを入力します。</td></tr><tr><td>パス マップの再評価</td><td>チェックする</td><td>URL を書き換えた後のパスを再評価することで、/path2 に合致するパスベース ルーティングが機能しパックエンド プール#2 にルーティングされます。</td></tr></tbody></table><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>サポート担当にお寄せいただいたお問い合わせをもとに Application Gateway v2 の書き換え規則の事例をご紹介しました。<br>Application Gateway の書き換え規則は様々なパラメーターの書き換えをサポートしていることに加えて、ほかの機能と組み合わせることで対応可能となるシナリオもございます。<br>本稿が、お客様が Application Gateway を活用する際の参考となれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Networking サポート チームの三島です。&lt;br&gt;Application Gateway v2 では HTTP ヘッダーなどのパラメーターを書き換える機能を提供しています。&lt;br&gt;この記事は、Application Gateway 書き換え規</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
</feed>
