<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2024-11-26T07:55:52.857Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Firewall のキャパシティに関する問題およびその原因 / 対策について</title>
    <link href="https://jpaztech.github.io/blog/network/Azure_Firewall-capacity-issue/"/>
    <id>https://jpaztech.github.io/blog/network/Azure_Firewall-capacity-issue/</id>
    <published>2024-11-26T07:55:58.081Z</published>
    <updated>2024-11-26T07:55:52.857Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Networking サポート チームの間島です。</p><p>今回は、多くの通信が Azure Firewall を経由するような大規模なシステム (例 : 万単位のユーザー数での Azure Virtual Desktop 利用など) を運用されているお客様より、特にお問い合わせいただくことが多い Azure Firewall のキャパシティに関する問題およびその原因 / 対策についてご紹介いたします。</p><p>なお、大規模なシステムにて Azure Firewall の利用を検討する際にパフォーマンス観点で考慮すべき事項につきましては、下のリンク先がお客様のご参考になるかと思いますので、まず最初にご一読いただき、弊社の担当営業にもご連絡 / ご相談ください。</p><div class="alert is-important"><p class="alert-title">重要</p><p>Azure Firewall のパフォーマンスに関するベスト プラクティス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-best-practices">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-best-practices</a></p></div><h2 id="Azure-Firewall-のキャパシティに関するお問い合わせの例"><a href="#Azure-Firewall-のキャパシティに関するお問い合わせの例" class="headerlink" title="Azure Firewall のキャパシティに関するお問い合わせの例"></a>Azure Firewall のキャパシティに関するお問い合わせの例</h2><h3 id="SNAT-ポートが枯渇する"><a href="#SNAT-ポートが枯渇する" class="headerlink" title="SNAT ポートが枯渇する"></a>SNAT ポートが枯渇する</h3><h4 id="問題"><a href="#問題" class="headerlink" title="- 問題"></a>- 問題</h4><p>Azure 内の仮想マシン (VM) や Azure Virtual Desktop (AVD) から Azure Firewall を経由するインターネットへのアクセスが増加した結果、Azure Firewall の SNAT ポートが枯渇し、VM や AVD からインターネットへのアクセスがエラーとなる。</p><h4 id="原因"><a href="#原因" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall では、下のリンク先に記載されているように、パブリック IP アドレス毎にインスタンス 1 つにつき 2,496 個の SNAT ポートを利用することが可能となっていますが、当該の Azure Firewall にてパブリック IP アドレスを 1 つしか使用していない場合には、スケールアウトによりインスタンス数が最大の 20 になった場合でも、最大 49,920 個のSNAT ポートしか利用できません。その結果、SNAT ポートを多く利用する環境の場合には、SNAT ポートの枯渇が発生する場合があります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall の既知の問題と制限事項</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues</a></p></div><h4 id="対策"><a href="#対策" class="headerlink" title="- 対策"></a>- 対策</h4><p>SNAT ポートを多く利用する環境の場合には、設計段階にてパブリック IP アドレスを 複数使用して Azure Firewall を構成することを検討してください。また通信先にて、Azure Firewall にて SNAT された後の IP アドレスのレンジにより、アクセス許可を行う要件がある場合には、通信先でのアクセス許可を簡素化するために、Azure Firewall のパブリック IP アドレスを IP アドレス プレフィックスから割り当てることをご検討ください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>パブリック IP アドレス プレフィックス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/public-ip-address-prefix">https://learn.microsoft.com/ja-jp/azure/virtual-network/ip-services/public-ip-address-prefix</a></p></div><p>また、運用段階では、Azure Firewall の下記のメトリックを監視し、SNAT 枯渇が発生しないよう運用監視を行い、空きの SNAT ポートが不足した場合にはパブリック IP アドレスの追加をご検討ください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>ファイアウォールの正常性状態</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#firewall-health-state">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#firewall-health-state</a></p><p>SNAT ポート使用率</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#snat-port-utilization">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#snat-port-utilization</a></p></div><h3 id="IDPS-機能を使用すると-Azure-Firewall-を経由する通信のスループットが低下する"><a href="#IDPS-機能を使用すると-Azure-Firewall-を経由する通信のスループットが低下する" class="headerlink" title="IDPS 機能を使用すると Azure Firewall を経由する通信のスループットが低下する"></a>IDPS 機能を使用すると Azure Firewall を経由する通信のスループットが低下する</h3><h4 id="問題-1"><a href="#問題-1" class="headerlink" title="- 問題"></a>- 問題</h4><p>Azure Firewall Premium を利用しており、最大 100 Gbps のスループットを期待していたが、IDPS 機能を使用した場合のスループットが期待値より低い。</p><h4 id="原因-1"><a href="#原因-1" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall Premium にて、TLS (トランスポート層セキュリティ) 検査と IDPS (侵入検出および防止) を利用する場合には、Azure Firewall のスループットに影響を及ぼす可能性があります。Azure Firewall Premium にて IDPS 機能を「アラートを出して拒否」に設定し、TLS および IPS を使用する場合には、Azure Firewall Premium の最大スループットは 10 Gbps、単一 TCP 接続の最大スループットは 300 Mbps に低下します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall のパフォーマンス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance</a></p><p>パフォーマンス データ</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-data">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-data</a></p></div><h4 id="対策-1"><a href="#対策-1" class="headerlink" title="- 対策"></a>- 対策</h4><p>TLS (トランスポート層セキュリティ) 検査や IDPS (侵入検出および防止) を利用する場合には、設計段階にて上記の最大スループットを考慮したシステム設計を行ってください。<br>また、テスト段階において、本番環境と同様なトラフィックや、将来のユーザー数やアプリケーション数の増加を想定したトラフィックを発生させて、パフォーマンス テストを実施 / 評価してください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>パフォーマンス テスト</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-testing">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-performance#performance-testing</a></p></div><h3 id="Azure-Firewall-のインスタンスのスケールアウトが遅い"><a href="#Azure-Firewall-のインスタンスのスケールアウトが遅い" class="headerlink" title="Azure Firewall のインスタンスのスケールアウトが遅い"></a>Azure Firewall のインスタンスのスケールアウトが遅い</h3><h4 id="問題-2"><a href="#問題-2" class="headerlink" title="- 問題"></a>- 問題</h4><p>お客様企業の社員が業務を開始する時間帯に、Azure 内の仮想マシン (VM) や Azure Virtual Desktop (AVD) から Azure Firewall を経由するインターネットへのアクセスが急増し、Azure Firewall の CPU 使用率やスループットが上昇するが、Azure Firewall のインスタンスのスケールアウトが追随せず、VM や AVD からインターネットへのアクセスがエラーとなる。</p><h4 id="原因-2"><a href="#原因-2" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall は、平均スループットまたは CPU 消費量が 60% になるか、接続使用率が 80% になると、徐々にスケールアウトしますが、スケールアウトには 5 ～ 7 分かかります。 そのため、Azure Firewall を経由するインターネットへのアクセスが急増した場合には、Azure Firewall のスケールアウトが追随できない場合があります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall のスケールアウトにはどのくらいの時間がかかりますか。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-faq#azure-firewall--------------------------">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-faq#azure-firewall--------------------------</a></p></div><h4 id="対策-2"><a href="#対策-2" class="headerlink" title="- 対策"></a>- 対策</h4><p>設計段階では、上記のスケールアウトの動作を考慮したシステム設計を行ってください。パフォーマンス テストを行うときは、少なくとも 10 ～ 15 分のテストを行い、Azure Firewall のスケールアウトの速度がお客様のシステム要件を満たしているかどうか確認 / 評価してください。また、運用段階では、Azure Firewall の下記のメトリックを監視し、システムを利用するユーザー数の増加や、新しいアプリケーションの追加による影響を確認 / 評価してください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>AZFW 待機時間プローブ</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#azfw-latency-probe">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference#azfw-latency-probe</a></p></div><h3 id="Azure-Firewall-の負荷が高いにも関わらずスケールアウトしない-インスタンスが枯渇している"><a href="#Azure-Firewall-の負荷が高いにも関わらずスケールアウトしない-インスタンスが枯渇している" class="headerlink" title="Azure Firewall の負荷が高いにも関わらずスケールアウトしない (インスタンスが枯渇している)"></a>Azure Firewall の負荷が高いにも関わらずスケールアウトしない (インスタンスが枯渇している)</h3><h4 id="問題-3"><a href="#問題-3" class="headerlink" title="- 問題"></a>- 問題</h4><p>AVD の利用ユーザーが増加したことにより、Azure Firewall のパフォーマンス系のメトリックからはインスタンス数が不足していると推測されるが、インスタンスがスケールアウトせず、AVD を利用する全ユーザーに影響が生じた。</p><h4 id="原因-3"><a href="#原因-3" class="headerlink" title="- 原因"></a>- 原因</h4><p>Azure Firewall は最大 20 インスタンスまでスケールアウトすることが可能ですが、それ以上のスケールアウトは、現時点ではサポートされておりません。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall の既知の問題と制限事項</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues">https://learn.microsoft.com/ja-jp/azure/firewall/firewall-known-issues</a></p></div><h4 id="対策-3"><a href="#対策-3" class="headerlink" title="- 対策"></a>- 対策</h4><p>設計段階では、上記のインスタンス数の上限を考慮したシステム設計を行ってください。なお、現時点では Azure Firewall にはインスタンス数や CPU 使用率のメトリックはないため、運用段階では「待機時間プローブ」や「スループット」のメトリック監視により代替してください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Firewall 監視データリファレンス</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference">https://learn.microsoft.com/ja-jp/azure/firewall/monitor-firewall-reference</a></p></div><p>当ブログが、お客様よりお問い合わせをいただくことが多い Azure Firewall のキャパシティ問題に関して、お客様にて設計や運用を行う際の手助けになりましたら、幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Networking サポート チームの間島です。&lt;/p&gt;
&lt;p&gt;今回は、多くの通信が Azure Firewall を経由するような大規模なシステム (例 : 万単位のユーザー数での Azure Virtual Desktop 利用など) を運用さ</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="capacity" scheme="https://jpaztech.github.io/blog/tags/capacity/"/>
    
  </entry>
  
  <entry>
    <title>Azure における有償 Azure テクニカル サポートの対応範囲</title>
    <link href="https://jpaztech.github.io/blog/other/azure_technical_support_explained/"/>
    <id>https://jpaztech.github.io/blog/other/azure_technical_support_explained/</id>
    <published>2024-11-08T03:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.929Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure 製品をご利用のお客様に向けて、Azure の有償テクニカル サポートの対応範囲や留意点について、以下の通りご案内いたします。<br>本内容では、課金や請求については言及しておりません。主に、有償のテクニカル サポート契約についての説明のみとなっております。</p><h2 id="サポート-プラン別の対応範囲"><a href="#サポート-プラン別の対応範囲" class="headerlink" title="サポート プラン別の対応範囲"></a>サポート プラン別の対応範囲</h2><h3 id="有償のサポート-プランに加入していない場合"><a href="#有償のサポート-プランに加入していない場合" class="headerlink" title="有償のサポート プランに加入していない場合"></a>有償のサポート プランに加入していない場合</h3><p>※対象プラン：Basic プランを含む無償のサポート プランを指します。</p><blockquote><p>恐れ入りますが、有償テクニカル サポート範囲内の対応はいたしかねます。ただし、コミュニティの専門家や Microsoft のエンジニア、その他のお客様とアイデアを交換できるコミュニティ チャネルである <a href="https://learn.microsoft.com/ja-jp/answers/tags/133/azure">Azure の Q&amp;A</a>で、技術的な質問への回答を得ることができます。 充実した検索ツールにより、さまざまなソースからの回答が得られるため、自己解決のための貴重なリソースとなります。ぜひご活用ください。</p></blockquote><h3 id="有償のサポート-プランをご購入の場合"><a href="#有償のサポート-プランをご購入の場合" class="headerlink" title="有償のサポート プランをご購入の場合"></a>有償のサポート プランをご購入の場合</h3><p>※対象プラン：Developer、Standard、Professional Direct を指します。</p><p>ご参考：<a href="https://azure.microsoft.com/ja-jp/support/plans/">Azure サポート プランの比較</a></p><blockquote><p>原則として、テクニカル サポートの対応範囲は障害対応（Break/fix）のみとなります。 ご購入のプランによって、対応する範囲や応答時間が異なります。また、Professional Direct をご購入の場合、プラン内容に合わせて、ProDirect デリバリー マネージャーからのガイダンスが定期的に得られます。</p></blockquote><h3 id="プレミア契約でサポート-プランをご購入の場合"><a href="#プレミア契約でサポート-プランをご購入の場合" class="headerlink" title="プレミア契約でサポート プランをご購入の場合"></a>プレミア契約でサポート プランをご購入の場合</h3><p>※対象プラン：エンタープライズ サポートを個別に購入した場合のサポート プランを指します。</p><blockquote><p>障害対応（Break/fix）と Advisory の両方が有償テクニカル サポート範囲内となります。 以下、障害対応（Break/fix）と Advisory の定義や対応範囲を詳細に説明いたします。 弊社の提供する有償テクニカル サポートをより活用していただくため、是非とも一度ご確認ください。どうぞよろしくお願いいたします。</p></blockquote><h2 id="障害対応（Break-fix）と-Advisory-の説明"><a href="#障害対応（Break-fix）と-Advisory-の説明" class="headerlink" title="障害対応（Break/fix）と Advisory の説明"></a>障害対応（Break/fix）と Advisory の説明</h2><h3 id="Azure-サポートにおける障害対応（Break-fix）の定義"><a href="#Azure-サポートにおける障害対応（Break-fix）の定義" class="headerlink" title="Azure サポートにおける障害対応（Break/fix）の定義"></a>Azure サポートにおける障害対応（Break/fix）の定義</h3><blockquote><p>障害対応の問題とは、Azure サービスの使用中に発生する可能性のある技術的な問題のことです。 障害対応とは、通常の使用中にテクノロジーに問題が発生し、正常に動作するように回復させる必要がある場合に、それをサポートするための作業を指します。</p></blockquote><h3 id="Azure-サポートにおける-Advisory-の定義"><a href="#Azure-サポートにおける-Advisory-の定義" class="headerlink" title="Azure サポートにおける Advisory の定義"></a>Azure サポートにおける Advisory の定義</h3><blockquote><p>Advisory サポートは、方法に関する一般的なご質問に対する支援を目的としています。 主に公開資料ベースやすでに存在しているベストプラクティスの案内となります。</p></blockquote><h3 id="両者の区別"><a href="#両者の区別" class="headerlink" title="両者の区別"></a>両者の区別</h3><blockquote><p>前者は「問題が発生している/発生した」ことに対しての支援です。一方、後者は問題が発生していない場合に、公開資料ベースでの一般的なご質問に対する支援です。</p></blockquote><h3 id="サポートをご活用するためのヒント"><a href="#サポートをご活用するためのヒント" class="headerlink" title="サポートをご活用するためのヒント"></a>サポートをご活用するためのヒント</h3><p>(公開資料ベース以外で）Advisory サポートに該当する内容（例） </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">再現頻度が低く、現在は問題が発生していないがログからの原因調査が必要とされる内容 </span><br><span class="line">回避策があるものの、原因究明（RCA）を優先的に実施したいという要望によるサポート側の調査</span><br></pre></td></tr></table></figure><p>Advisory サポートに含まれない内容（例） </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">コードレビュー </span><br><span class="line">設計や設定のレビュー </span><br><span class="line">カスタムコードのサンプルの提供（コーディングの言語やスクリプトの種類に関わらず、公開されているドキュメント内のものを除く） </span><br><span class="line">アーキテクチャに関する詳細なガイダンスやデザイン </span><br><span class="line">公開ドキュメントに記載してない仕様確認 </span><br><span class="line">（既存問題の修正に関わらない）機能のリクエストやフィードバック </span><br><span class="line">公開情報の範疇にないステップバイステップの手順提供やお客様環境に合わせた設計や構築の案内</span><br></pre></td></tr></table></figure><p>上記の内容に関して支援が必要な場合は、Premier サポートのカスタマーエンジニアによる稼働時間ベースのサービスをご検討いただくことをおすすめいたします。 お手数ですが、貴社内の Azure 契約を担当する窓口へ一度ご相談ください。</p><h2 id="お問い合わせの重要度と緊急度について"><a href="#お問い合わせの重要度と緊急度について" class="headerlink" title="お問い合わせの重要度と緊急度について"></a>お問い合わせの重要度と緊急度について</h2><p>Azure のサポートには、重要度が A ~ C に分類されております。</p><p>通常重要度（重要度 B、もしくは C）は、日本時間の営業時間（土日祝日を除く、9:00 ～ 17:30）のみ対応しています。 Standard、Professional Direct、Premier サポートにおいては 24 時間 365 日の緊急対応（重要度 A）が提供されています。</p><p>緊急対応は、運用環境における「障害対応」、つまり正常な状態で稼働していたサービスが正常に機能しなくなった場合の復旧・問題の回避を目的としています。 原因追求や、ハウツー（※）については重要度 B、もしくは C として、通常営業時間内での対応となります。 ※ 原因追求やハウツーは障害対応ではないため、重要度を落としても、ご契約や内容によってお受けできない場合がございます。</p><p>Developer サポートは、開発環境を想定しているため、24 時間 365 日の対応は行えず、重要度 A でも通常時間内での優先対応となります。</p><h2 id="留意点：お問い合わせ1件につき1つの問題を扱います。"><a href="#留意点：お問い合わせ1件につき1つの問題を扱います。" class="headerlink" title="留意点：お問い合わせ1件につき1つの問題を扱います。"></a>留意点：お問い合わせ1件につき1つの問題を扱います。</h2><p>1件あたりを “問題の最小単位” とさせていただく必要があるため、複雑な問題については、切り分けによって複数のインシデントに分割していただくようお願いさせていただく場合があります。 </p><p>このような対応は、お客様により良いサポート体験を提供させていただくためのものでございます。何卒ご理解賜りますようお願い申し上げます。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>よくあるご質問について、以下の通り列挙いたします。ご一読いただけますと幸いです。</p><p><strong>Q.オンプレミスの PC やサーバーに不調が発生した場合、Azure サポートで対応が行えるか</strong><br>オンプレミス、つまり自社や自宅の環境のサポート対応は Azure サポートの対応範囲外となります。エンタープライズ サポートの Unified サポートであれば、マイクロソフトの製品に限って対応が可能です。</p><p><strong>Q.Azure 上における特定製品のライセンスについての問い合わせをしたい</strong><br>マイクロソフト製品のライセンス（Windows Server や SQL Server 等）については、ライセンス リセラーとなるパートナー各社にお問い合わせください。 パートナー ネットワークに加入されている弊社パートナー様の場合、弊社パートナー コールセンターにご相談ください。<br>・<a href="https://partner.microsoft.com/ja-jp/support?stage=1">パートナー コールセンター</a></p><p><strong>Q.Azure 上の Windows Server 仮想マシンにおけるサードパーティ製品について問い合わせが可能か</strong><br>サードパーティ製品のサポートは行っておりませんので、開発元にお問い合わせいただきますようお願いいたします。</p><p><strong>Q.Azure 上の Windows Server 仮想マシンにおける OS 内の設定について、ベストプラクティス・特定機能の設定方法・仕様確認などを行いたい</strong><br>Azure サポートの対応範囲外となりますが、エンタープライズ サポートの Unified サポートであれば対応可能です。</p><p><strong>Q.Office 365 製品の問い合わせが可能か</strong><br>Office 365 の製品についてのサポートは Azure サポート契約ではお受けできないため、Office 365 サポートをご利用いただく必要がございます。 しかしながら、Azure 上に導入いただいた Office 365 製品において、Azure プラットフォーム側の問題が発生している可能性がある場合など、Azure プラットフォームとしての見解が必要な内容については Azure サポートにご相談ください。</p><p><strong>Q.Azure の特定の技術・挙動について仕様確認をしたい</strong><br>仕様の確認に関する調査については、Professional Direct、エンタープライズ サポートの Unified サポートでのAdvisory サービスに含まれます。</p><p><strong>Q.Azure Marketplace におけるサードパーティ製品の質疑応答・トラブルシューティングの依頼は可能か</strong><br>Azure 基盤側の問題、例えば「サードパーティ製として提供されている仮想マシンが、Azure 基盤側の要因で接続できなくなった」といったケースであれば Azure テクニカル サポートにて対応が可能です。 それ以外の、価格、ライセンス、製品固有のご質問・トラブルシュートは提供元にご質問ください。</p><p><strong>Q.Azure 製品やサービスの利用において、パフォーマンスが出ない</strong><br>構築後、正常にパフォーマンスが出ていた状態から一時的に極端に悪化している場合には障害対応の範囲となり、Azure サポートでの対応が可能です。<br>障害対応の範囲外となるパフォーマンスの調査は Azure 観点からであれば Unified や Premier サポートにて承ることができます。<br>一方で、システム全体のパフォーマンスチューニングはカスタマー エンジニアによる稼働時間ベースのサービスにおいてのみ承れます。</p><p><strong>Q.仕様確認したい場合、どうすればいいですか</strong><br>Advisory 範囲として、ドキュメント上に言及されているものからの回答となります。大規模な案件で、非公式な上限値などをお知りになりたい場合、Premier サポートにて承ります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure 製品をご利用のお客様に向けて、Azure の有償テクニカル サポートの対応範囲や留意点について、以下の通りご案内いたします。&lt;br&gt;本内容では、課金や請求については言及しておりません。主に</summary>
      
    
    
    
    
    <category term="Other" scheme="https://jpaztech.github.io/blog/tags/Other/"/>
    
    <category term="Support Explained" scheme="https://jpaztech.github.io/blog/tags/Support-Explained/"/>
    
  </entry>
  
  <entry>
    <title>Azure File Sync のログ採取について</title>
    <link href="https://jpaztech.github.io/blog/storage/get-afs-logs/"/>
    <id>https://jpaztech.github.io/blog/storage/get-afs-logs/</id>
    <published>2024-11-07T03:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.957Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>お客様より Azure Files Sync のトラブルシューティングのサポートリクエストをいただいた際に、調査のためログの採取をお願いすることがございます。<br>本記事ではログの採取方法についてご紹介をさせていただきます。 </p><span id="more"></span><ol><li><a href=".#1-Debug-StorageSyncServer-Diagnose%EF%BC%88%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BA%E6%96%AD%EF%BC%89">Debug-StorageSyncServer -Diagnose（サーバー診断）</a></li><li><a href=".#2-Debug-StorageSyncServer-TestNetworkConnectivity%EF%BC%88%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E6%8E%A5%E7%B6%9A%E3%83%86%E3%82%B9%E3%83%88%EF%BC%89">Debug-StorageSyncServer -TestNetworkConnectivity（ネットワーク接続テスト）</a> </li><li><a href=".#3-Debug-StorageSyncServer-FileSyncErrorsReport%EF%BC%88%E5%90%8C%E6%9C%9F%E5%A4%B1%E6%95%97%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%EF%BC%89">Debug-StorageSyncServer -FileSyncErrorsReport（同期失敗に関するレポート）</a> </li><li><a href=".#4-Debug-StorageSyncServer-AFSDiag%EF%BC%88%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%8E%E9%9B%86%EF%BC%89">Debug-StorageSyncServer -AFSDiag（ログとトレースを収集）</a> </li><li><a href=".#5-Azure-Files-Sync-%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%83%AD%E3%82%B0%E3%81%AE%E6%8E%A1%E5%8F%96">Azure Files Sync に関するイベントログの採取</a></li></ol><p>各ログの採取は問題の発生しているサーバーエンドポイントとなる Windows Server 上で PowerShell より実行をお願いいたします。<br>調査のためにすべてのログが必要といったわけではございませんので、担当エンジニアからご依頼させていただいたログを取得いただけますと幸いでございます。 </p><p>なお、公開ドキュメントにも Azure Files Sync のトラブルシューティングについての記載がございますので、ご自身でトラブルシューティング可能な点が無いかご確認いただくこともできます。 </p><p>■ご参考：Azure File Sync のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot">https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot</a></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>各コマンド実行前に Import-Module をしていますが、初回に Import-Module を 1 回のみ 実行することで、都度 Import-Module を実行する必要はございません。</p></div><hr><h3 id="1-Debug-StorageSyncServer-Diagnose（サーバー診断）"><a href="#1-Debug-StorageSyncServer-Diagnose（サーバー診断）" class="headerlink" title="1. Debug-StorageSyncServer -Diagnose（サーバー診断）"></a>1. Debug-StorageSyncServer -Diagnose（サーバー診断）</h3><p>Azure File Sync に関する一般的な問題が無いか診断をするコマンドとなります。 </p><p>■ ログ取得方法 </p><p>以下のコマンドを実行して表示される結果をコピーして、テキストファイルでご共有ください。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-Diagnose</span></span><br></pre></td></tr></table></figure><hr><h3 id="2-Debug-StorageSyncServer-TestNetworkConnectivity（ネットワーク接続テスト）"><a href="#2-Debug-StorageSyncServer-TestNetworkConnectivity（ネットワーク接続テスト）" class="headerlink" title="2. Debug-StorageSyncServer -TestNetworkConnectivity（ネットワーク接続テスト）"></a>2. Debug-StorageSyncServer -TestNetworkConnectivity（ネットワーク接続テスト）</h3><p>サーバーエンドポイントとして使用している Windows Server から各種 Azure 上のリソースへのネットワーク疎通テストを行うコマンドとなります。<br>正常な通信ができていない可能性がある場合などに使用します。 </p><p>以下のドキュメントのように、通信経路上に、Firewallがある場合、Proxyがある場合等をはじめとして、Azure File Sync に関連するAzureサービスとの通信が可能な状況かどうかを確認することができます。 </p><p>■ご参考：Azure File Sync のプロキシとファイアウォールの設定<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/file-sync/file-sync-firewall-and-proxy">https://learn.microsoft.com/ja-jp/azure/storage/file-sync/file-sync-firewall-and-proxy</a>　 </p><p>■ ログ取得方法 </p><p>以下のコマンドを実行して表示される結果をコピーして、テキストファイルでご共有ください。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-TestNetworkConnectivity</span></span><br></pre></td></tr></table></figure><hr><h3 id="3-Debug-StorageSyncServer-FileSyncErrorsReport（同期失敗に関するレポート）"><a href="#3-Debug-StorageSyncServer-FileSyncErrorsReport（同期失敗に関するレポート）" class="headerlink" title="3. Debug-StorageSyncServer -FileSyncErrorsReport（同期失敗に関するレポート）"></a>3. Debug-StorageSyncServer -FileSyncErrorsReport（同期失敗に関するレポート）</h3><p>同期に失敗したファイルの特定などを行うコマンドです。<br>ファイルの同期に問題が発生している場合に使用します。<br>Azure Portal上にて、同期のエラーが表示されている際に、同期エラーとなっている具体的なファイル・フォルダーや、同期エラーとなっているエラー内容を、ファイル・フォルダーごとに確認するために使用できます。 </p><p>■ご参考：同期されていない特定のファイルまたはフォルダーがあるかどうかを確認するにはどうすればよいですか?<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot-sync-errors#how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing">https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-storage/files/file-sync/file-sync-troubleshoot-sync-errors#how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing</a>  </p><p>■ ログ取得方法<br>以下のコマンドを実行して表示される結果をコピーして、テキストファイルでご共有ください。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-FileSyncErrorsReport</span> </span><br></pre></td></tr></table></figure><hr><h3 id="4-Debug-StorageSyncServer-AFSDiag（ログとトレースを収集）"><a href="#4-Debug-StorageSyncServer-AFSDiag（ログとトレースを収集）" class="headerlink" title="4. Debug-StorageSyncServer -AFSDiag（ログとトレースを収集）"></a>4. Debug-StorageSyncServer -AFSDiag（ログとトレースを収集）</h3><p>Azure File Sync に関する詳細なログおよびトレースを行うコマンドです。<br>一般的に広く情報を収集したい場合に、このコマンドで情報収集をお願いする場合もございますが、主に事象の再現性がある場合に、再現時の情報を収集するためのコマンドとしてご案内することが多いものとなります。 </p><p>■ ログ取得方法 </p><p>以下のコマンドを実行すると、「Please reproduce the problem and press D when done …:」というメッセージが表示されます。 </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll&quot;</span> </span><br><span class="line"><span class="built_in">Debug-StorageSyncServer</span> <span class="literal">-AFSDiag</span> <span class="literal">-OutputDirectory</span> C:\output <span class="literal">-KernelModeTraceLevel</span> Verbose <span class="literal">-UserModeTraceLevel</span> Verbose </span><br></pre></td></tr></table></figure><p>何か特定の操作で再現性のある問題についてトレースする場合は、再現操作を行った後に D を入力し Enter キーを押下してください。<br>特定の操作で起こる問題ではない場合には、そのまま何もせず D を入力し Enter キーを押下してください。<br>実行完了までに少しお時間がかかる場合がございますが、完了すると C:\output フォルダー配下に AFSDiag_2023-04-20-03-40-20.zip というようなファイルが生成されます。<br>こちらの生成されたファイルをご共有ください。 </p><hr><h3 id="5-Azure-Files-Sync-に関するイベントログの採取"><a href="#5-Azure-Files-Sync-に関するイベントログの採取" class="headerlink" title="5. Azure Files Sync に関するイベントログの採取"></a>5. Azure Files Sync に関するイベントログの採取</h3><p>Windows イベントログに Azure File Sync に関するログが記録されます。 </p><p>■ ログ取得方法 </p><p>“C:\Windows\System32\winevt\Logs” フォルダーに保存されている、「Microsoft-FileSync-」で始まるファイル名のものを全て、ファイルごとご共有ください。 </p><hr><p>上記内容がお役に立てますと幸いでございます。 </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;お客様より Azure Files Sync のトラブルシューティングのサポートリクエストをいただいた際に、調査のためログの採取をお願いすることがございます。&lt;br&gt;本記事ではログの採取方法についてご紹介をさせていただきます。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較</title>
    <link href="https://jpaztech.github.io/blog/network/fw-snat/"/>
    <id>https://jpaztech.github.io/blog/network/fw-snat/</id>
    <published>2024-10-25T05:30:00.000Z</published>
    <updated>2024-11-26T07:55:52.897Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較について紹介します。</p><span id="more"></span><div class="alert is-info"><p class="alert-title">Note</p><p> この記事は当初 Azure Firewall のパブリック IP の使われ方がランダムではなかったため、実際のパブリック IP の使われ方を説明しておりました。</p><p>しかしながら、2024 年 10 月時点ではパブリック IP がランダムに使用される動作に変更されたため、内容を Azure Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較に変更いたしました。</p></div><h2 id="Azure-Firewall-のパブリック-IP-による-SNAT-について"><a href="#Azure-Firewall-のパブリック-IP-による-SNAT-について" class="headerlink" title="Azure Firewall のパブリック IP による SNAT について"></a>Azure Firewall のパブリック IP による SNAT について</h2><p>Azure Firewall を経由してインターネット宛に通信するときは、関連付けられているパブリック IP へ送信元のアドレス変換（SNAT）が行われます。パブリック IP が 1 つしかない時はそのパブリック IP のアドレスしか使用されませんが、複数のパブリック IP アドレスが Azure Firewall に関連付けられている場合の動作は、以下のドキュメントの記載の通りランダムに選択されます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/deploy-multi-public-ip-powershell">Azure PowerShell を使用して複数のパブリック IP アドレスを使用する Azure Firewall をデプロイする</a></p><blockquote><p>SNAT -送信 SNAT 接続に追加のポートを使用できるので、SNAT ポートが不足する可能性が低減されます。 Azure Firewall では、接続に使用する送信元パブリック IP アドレスがランダムに選択されます。 ネットワークにダウンストリーム フィルターがある場合、ファイアウォールに関連付けられているすべてのパブリック IP アドレスを許可する必要があります。 この構成を簡略化するには、パブリック IP アドレス プレフィックスを使用することを検討してください。</p></blockquote><h2 id="NAT-ゲートウェイ-による-SNAT-について"><a href="#NAT-ゲートウェイ-による-SNAT-について" class="headerlink" title="NAT ゲートウェイ による SNAT について"></a>NAT ゲートウェイ による SNAT について</h2><p>Azure Firewall Subnet に NAT ゲートウェイを関連付けることにより、Azure Firewall のパブリック IP ではなく、NAT ゲートウェイで SNAT を行うことができるようになります。<br>注意点として、NAT ゲートウェイはゾーン冗長をサポートしていないため、利用する場合は Azure Firewall をゾーン冗長しないようにデプロイする必要があります。<br>Azure Firewall と NAT ゲートウェイを組み合わせて使用する方法については以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/integrate-with-nat-gateway">Azure Virtual Network NAT を使用した SNAT ポートのスケーリング | Microsoft Learn</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/nat-gateway/tutorial-hub-spoke-nat-firewall">チュートリアル： ハブ アンド スポーク ネットワークで NAT ゲートウェイと Azure Firewall を統合する - Azure Virtual Network NAT | Microsoft Learn</a></p><h2 id="Azure-Firewall-と-NAT-Gateway-の比較表"><a href="#Azure-Firewall-と-NAT-Gateway-の比較表" class="headerlink" title="Azure Firewall と NAT Gateway の比較表"></a>Azure Firewall と NAT Gateway の比較表</h2><p>以下の表は Azure Firewall のパブリック IP による SNAT と NAT Gateway の機能比較表です。</p><table><thead><tr><th align="left">機能</th><th align="center">Firewall のパブリック IP</th><th align="center">NAT ゲートウェイ</th></tr></thead><tbody><tr><td align="left">SNAT ポート数（パブリック IP 1 つにつき）</td><td align="center">2,496 * FW 内部インスタンス数 ※1</td><td align="center">64,512</td></tr><tr><td align="left">関連付けられる パブリック IP の数</td><td align="center">250</td><td align="center">16</td></tr><tr><td align="left">パブリック IP が使用される順番</td><td align="center">ランダム</td><td align="center">ランダムかつほぼ均等に使用される</td></tr><tr><td align="left">ゾーン冗長のサポート</td><td align="center">○</td><td align="center">×</td></tr><tr><td align="left">価格</td><td align="center">FW と FW のパブリック IP の価格</td><td align="center">FW と FW のパブリック IP, NAT ゲートウェイと NAT ゲートウェイ のパブリック IP の価格</td></tr></tbody></table><p>※1 Azure Firewall の内部インスタンス数は最低 2 となり、負荷に応じてスケールアウトします。</p><p>以上、ご参考になれば幸いです。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Firewall のパブリック IP と NAT ゲートウェイ併用構成の比較について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure CDN Microsoft Standard SKU (クラシック) のリタイアについて</title>
    <link href="https://jpaztech.github.io/blog/network/mscdn-classic-retire/"/>
    <id>https://jpaztech.github.io/blog/network/mscdn-classic-retire/</id>
    <published>2024-09-30T14:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.909Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>本ブログでは、Azure CDN Microsoft Standard SKU (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と、Azure CDN Microsoft Standard SKU を MS CDN と記載致します)。</p><span id="more"></span><hr><h2 id="MS-CDN-クラシック-のリタイアについて"><a href="#MS-CDN-クラシック-のリタイアについて" class="headerlink" title="MS CDN (クラシック) のリタイアについて"></a>MS CDN (クラシック) のリタイアについて</h2><p>2027 年 9 月 30 日に MS CDN (クラシック) の提供が終了し、MS CDN (クラシック) に対するサポートも終了します。<br>提供終了までの間は既存の MS CDN (クラシック) の設定を変更することは可能ですが、2025 年 10 月 1 日以降は Azure ポータル、Terraform、Azure PowerShell や Azure CLI などを使用して新しい MS CDN (クラシック) リソースが作成できなくなります。<br>アナウンス内容につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://azure.microsoft.com/en-us/updates/v2/Azure-CDN-Standard-from-Microsoft-classic-will-be-retired-on-30-September-2027">Retirement: Azure CDN Standard from Microsoft (classic) will be retired on September 30th, 2027</a></p><blockquote><p>[!注意]<br>なお、記事には誤りがあり、2025 年 10 月 1 日以降も既存の MS CDN (クラシック) のリソースは更新できます。</p></blockquote><h2 id="MS-CDN-クラシック-のリタイアに関する-FAQ"><a href="#MS-CDN-クラシック-のリタイアに関する-FAQ" class="headerlink" title="MS CDN (クラシック) のリタイアに関する FAQ"></a>MS CDN (クラシック) のリタイアに関する FAQ</h2><p>MS CDN (クラシック) のリタイアに関するよくある質問につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/cdn/classic-cdn-retirement-faq">Azure CDN Standard from Microsoft (クラシック) の廃止に関する FAQ</a></p><h2 id="MS-CDN-クラシック-から-AFD-Standard-Premium-への移行方法について"><a href="#MS-CDN-クラシック-から-AFD-Standard-Premium-への移行方法について" class="headerlink" title="MS CDN (クラシック) から AFD Standard/Premium への移行方法について"></a>MS CDN (クラシック) から AFD Standard/Premium への移行方法について</h2><p>MS CDN (クラシック) の提供が終了する 2027 年 9 月 30 日までに、事前にお客様にて AFD Standard/Premium へ移行する必要がございます。<br>MS CDN (クラシック) から AFD Standard/Premium にゼロ ダウンタイムで移行するプロセスや手順に関しましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/cdn/migrate-tier">Microsoft Azure CDN (クラシック) を Standard/Premium レベルに移行する</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Azure CDN Microsoft Standard SKU (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と、Azure CDN Microsoft Standard SKU を MS CDN と記載致します)。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
  </entry>
  
  <entry>
    <title>Azure Network 製品について TLS 1.2 以降に移行するアナウンスの補足 (Tracking ID:7_8G-D8Z)</title>
    <link href="https://jpaztech.github.io/blog/network/tls1.2_migration/"/>
    <id>https://jpaztech.github.io/blog/network/tls1.2_migration/</id>
    <published>2024-09-26T10:27:00.000Z</published>
    <updated>2024-11-26T07:55:52.921Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。</p><p>メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。</p><h2 id="TLS-バージョンとは"><a href="#TLS-バージョンとは" class="headerlink" title="TLS バージョンとは"></a>TLS バージョンとは</h2><p>TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、<a href="https://datatracker.ietf.org/doc/html/rfc8996">RFC 8996</a> により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。</p><h2 id="TLS-接続時のバージョン選定動作について"><a href="#TLS-接続時のバージョン選定動作について" class="headerlink" title="TLS 接続時のバージョン選定動作について"></a>TLS 接続時のバージョン選定動作について</h2><p>TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。</p><h3 id="Windows-OS-の場合"><a href="#Windows-OS-の場合" class="headerlink" title="Windows OS の場合"></a>Windows OS の場合</h3><p><a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows">こちらの公開ドキュメント</a>の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。<br>また、特定の TLS バージョンを有効化/無効化されたい場合は、<a href="https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/">こちらの記事</a>の通りご対応ください。</p><p>Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。</p><p>参考として、Android など他のクライアント対応状況は<a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation">こちら</a>の公開ドキュメントに開示されています。 </p><h3 id="Chrome-Edge-などのブラウザの場合"><a href="#Chrome-Edge-などのブラウザの場合" class="headerlink" title="Chrome/Edge などのブラウザの場合"></a>Chrome/Edge などのブラウザの場合</h3><p>最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、<br>特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。<br>Edgeの場合は<a href="https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg">こちらの記事</a>の通り対応できます。</p><h3 id="それ以外の場合"><a href="#それ以外の場合" class="headerlink" title="それ以外の場合"></a>それ以外の場合</h3><p>上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。</p><h3 id="TLS-チェッカー-ツール"><a href="#TLS-チェッカー-ツール" class="headerlink" title="TLS チェッカー ツール"></a>TLS チェッカー ツール</h3><p><a href="https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html">こちら</a>のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。</p><h2 id="Azure-Network製品の対応状況及び推奨アクションについて"><a href="#Azure-Network製品の対応状況及び推奨アクションについて" class="headerlink" title="Azure Network製品の対応状況及び推奨アクションについて"></a>Azure Network製品の対応状況及び推奨アクションについて</h2><p>以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。<br>もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。</p></div><span id="more"></span><h2 id="Application-Gateway"><a href="#Application-Gateway" class="headerlink" title="Application Gateway"></a>Application Gateway</h2><p>以下の URL にて、2025 年 8 月 31 日に TLS バージョン 1.0 および 1.1 のサポートが終了することが案内されました。こちらの URL 先のページでは英文で記載されておりますので、本ブログでは日本語にて内容をご案内いたします。  </p><p><a href="https://azure.microsoft.com/en-us/updates/v2/Azure-Application-Gateway-support-for-TLS-10-and-TLS-11-will-end-by-31-August-2025">Retirement: Azure Application Gateway support for TLS 1.0 and TLS 1.1 will end by 31 August 2025 (microsoft.com)</a>  </p><p>つきましては、2025 年 8 月 31 日までに以下の作業をご実施いただきますようお願いいたします。  </p><h3 id="クライアントから-Application-Gateway-への接続について"><a href="#クライアントから-Application-Gateway-への接続について" class="headerlink" title="クライアントから Application Gateway への接続について"></a>クライアントから Application Gateway への接続について</h3><p><del>現時点では、Application Gateway は2024 年 10 月 31 日以降にも引き続き TLS1.0 から TLS1.3 をサポートしており、TLS1.2 以下のバージョンをサポートしなくなる予定はございません。</del><br>以下の設定方法を参考に Application Gateway の TLS ポリシーにて、定義済みの AppGwSslPolicy20220101S、AppGwSslPolicy20220101、または最小プロトコル バージョンが TLS 1.2 のカスタムポリシーに更新することをお勧めします（CustomV2 ポリシーは、デフォルトで最小プロトコルバージョンが 1.2 になっています）。  </p><h4 id="最小TLS-バージョンの設定方法"><a href="#最小TLS-バージョンの設定方法" class="headerlink" title="最小TLS バージョンの設定方法"></a>最小TLS バージョンの設定方法</h4><p>下図の通り、Azure ポータル → 対象 Application Gateway → 「リスナー」のタブにて、 「選択した SSL ポリシー」の「変更」ボタンをクリックし、「 SSL ポリシーの変更」より設定できます。<br><img src="/blog/network/tls1.2_migration/appgw_tls_setting.png"></p><p>また、Application Gateway SKU v2 の場合は、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-configure-listener-specific-ssl-policy">こちらの手順通り</a>、リスナー毎に異なる TLS バージョンを設定することも可能です。 </p><h3 id="Application-Gateway-からバックエンド-サーバーへの接続について"><a href="#Application-Gateway-からバックエンド-サーバーへの接続について" class="headerlink" title="Application Gateway からバックエンド サーバーへの接続について"></a>Application Gateway からバックエンド サーバーへの接続について</h3><p>2025 年 8 月 31 日以降、バックエンドサーバーへの接続は常に最小プロトコル TLS のバージョンは 1.2 となり、最大プロトコル TLS バージョンは 1.3 となります。バックエンド接続の TLS バージョンについて、Application Gateway 側で何かを設定する必要はありません。<br>バックエンドのサーバーがこれらの更新されたプロトコル TLS バージョン （TLS 1.2 または 1.3）に対応していることをお客様にて確認し、必要に応じて 2025 年 8 月 31 日までに Application Gateway のバックエンドに指定しているサーバー側で最小プロトコル TLS バージョンが 1.2 以上となるよう、ご対応いただけますようお願いいたします。  </p><h2 id="Azure-Firewall"><a href="#Azure-Firewall" class="headerlink" title="Azure Firewall"></a>Azure Firewall</h2><p>Azure Firewall では、TLS バージョンが関わる部分は TLS インスペクションのみとなります。アプリケーション ルール、ネットワーク ルール、及び DNAT ルールで通信を許可する場合は本通知の対象外となります。</p><p>TLS インスペクション機能を使用する場合は、<a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-features#tls-inspection">こちらの公開ドキュメント</a>の記載通り、現状及び 2024 年 10 月 31 日以降にも TLS1.0 及び TLS1.1 は互換性のために引き続き動作する予定ですが、早めに TLS 1.2 に移行することを強く推奨します。</p><blockquote><p>ヒント<br>TLS 1.0 と 1.1 は非推奨になっていて、サポートされません。 TLS 1.0 と 1.1 のバージョンの TLS/SSL (Secure Sockets Layer) は脆弱であることが確認されています。現在、これらは下位互換性を維持するために使用可能ですが、推奨されていません。 できるだけ早く TLS 1.2 に移行してください。</p></blockquote><p>また、現状の TLS インスペクション機能では TLS1.3 をサポートしておりません。</p><h2 id="Front-Door"><a href="#Front-Door" class="headerlink" title="Front Door"></a>Front Door</h2><p>以下の URL にて、2024 年 12 月 1 日に TLS バージョン 1.0 および 1.1 のサポートが終了することが案内されました。こちらの URL 先のページでは英文で記載されておりますので、本ブログでは日本語にて内容をご案内いたします。  </p><p><a href="https://azure.microsoft.com/ja-jp/updates/v2/Azure-FrontDoor-support-for-TLS-10-and-TLS-11-will-end-by-1-Dec-2024">Retirement: Azure Front Door support for TLS 1.0 and TLS 1.1 will end by 1 Dec 2024 (microsoft.com)</a>  </p><p>Azure Front Door でカスタム ドメインを利用する場合は、<strong>2024 年 12 月 1 日以降に最小 TLS バージョン 1.0 および 1.1 のサポートは終了</strong>するため、<strong>最小 TLS バージョンを 1.2 以上に変更</strong>いただく必要がございます。<br>各 SKU における最小 TLS バージョンの更新方法は以下の通りです。  </p><ul><li>Azure Front Door を使用している場合は、「<a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/standard-premium/how-to-configure-https-custom-domain?tabs=powershell">カスタム ドメインに対して HTTPS を構成する - Azure Front Door | Microsoft Learn</a>」を使用して TLS 1.2 以上に設定します。</li><li>Azure Front Door クラシックを使用している場合は、「<a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/front-door-custom-domain-https">Front Door (クラシック) カスタム ドメインで HTTPS を構成する - Azure Front Door | Microsoft Learn</a>」を使用して TLS 1.2 に設定します。</li><li>Microsoft CDN を使用している場合は、「<a href="https://learn.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-1-default-enable-https-with-a-cdn-managed-certificate">チュートリアル:Azure CDN カスタム ドメインで HTTPS を構成する | Microsoft Learn</a>」を参照してください。Microsoft Learn<br>」を使用して TLS 1.2 に設定します。</li></ul><h2 id="Private-Link-Service-または-Private-Endpoint"><a href="#Private-Link-Service-または-Private-Endpoint" class="headerlink" title="Private Link Service または Private Endpoint"></a>Private Link Service または Private Endpoint</h2><p>Private Link Service と Private Endpoint のサービスでは、TLS プロトコルは終端しません。<br>Private Link Service と Private Endpoint を利用した通信の場合には、クライアントとサーバーの通信上の両端で TLS ネゴシエーションが実施されます。クライアントおよびサーバーとなるサービスの観点でご確認頂く必要があります。 </p><h2 id="Bastion"><a href="#Bastion" class="headerlink" title="Bastion"></a>Bastion</h2><p>Bastion はお客様側で証明書の管理運用を意識する必要のないサービスとして、<a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-overview#key">以下の公開ドキュメント</a>の記載通り、 TLS 1.2 のみをサポートしておりますので、お客様側の対処が不要です。 </p><blockquote><p>Bastion では、TLS 1.2 がサポートされています。 以前の TLS バージョンはサポートされません。</p></blockquote><h2 id="Traffic-Manager"><a href="#Traffic-Manager" class="headerlink" title="Traffic Manager"></a>Traffic Manager</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-how-it-works#how-clients-connect-using-traffic-manager">こちらの公開ドキュメント</a>の説明通り、TrafficManager は DNS レベルで動作するため、Traffic Manager 自身がクライアントからのリクエストを処理することはなく、クライアントは直接エンドポイントに接続します。このため、クライアント - Traffic Manager 間で TLS が使用されることはありませんので、Traffic Manager 側の対処が不要となります。</p><p>一方で、Traffic Manager はエンドポイントの監視方法として HTTPS を提供しているため、HTTPS で正常性プローブを送信するように構成した場合、Traffic Manager - エンドポイント間では TLS が使用されます。<br>（Tracking ID: VSKS-DSG の通知は、この Traffic Manager - エンドポイント間の正常性プローブの通信において、TLS 1.0/1.1 のサポートが 2024 年 6 月 30 日より終了することをご案内しております。）</p><p>TLS はクライアント (Traffic Manager) およびサーバー (エンドポイント) 間で使用可能な TLS バージョンのネゴシエイトを行います。エンドポイント側で TLS 1.0/1.1 が無効化されている限り Traffic Manager がTLS 1.0/1.1 でエンドポイントに接続することはありません。したがいまして、正常性プローブのプロトコルとして HTTPS を選択されている場合は、エンドポイントが TLS 1.2 以上で正常性プローブを受け取れるように構成いただく必要がございますが、具体的なエンドポイント側の TLS 設定状況、及び TLS 1.0/1.1 の無効化方法に関しましては、お客様に各サーバー (エンドポイント) 観点でご確認頂く必要があります。</p><h2 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a>Load Balancer</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-faqs#azure-load-balancer---tls-ssl---------------">こちらの公開ドキュメント</a>記載通り、Azure Load Balancer では、TLS 接続を終端せずにバックエンド サーバーへ転送する動作となりますので、本通知の対象外となります。 </p><h2 id="Virtual-Network"><a href="#Virtual-Network" class="headerlink" title="Virtual Network"></a>Virtual Network</h2><p>Virtual Network が仮想化の IP アドレス空間を提供するサービスとして、TLS 通信を終端することはありませんので、本通知の対象外となります。<br>もし仮想ネットワーク上に稼働する他の Azure リソースの対処方法をご確認されたい場合は、各リソース観点でご確認頂く必要があります。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。&lt;/p&gt;
&lt;p&gt;メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。&lt;/p&gt;
&lt;h2 id=&quot;TLS-バージョンとは&quot;&gt;&lt;a href=&quot;#TLS-バージョンとは&quot; class=&quot;headerlink&quot; title=&quot;TLS バージョンとは&quot;&gt;&lt;/a&gt;TLS バージョンとは&lt;/h2&gt;&lt;p&gt;TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8996&quot;&gt;RFC 8996&lt;/a&gt; により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。&lt;/p&gt;
&lt;h2 id=&quot;TLS-接続時のバージョン選定動作について&quot;&gt;&lt;a href=&quot;#TLS-接続時のバージョン選定動作について&quot; class=&quot;headerlink&quot; title=&quot;TLS 接続時のバージョン選定動作について&quot;&gt;&lt;/a&gt;TLS 接続時のバージョン選定動作について&lt;/h2&gt;&lt;p&gt;TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。&lt;/p&gt;
&lt;h3 id=&quot;Windows-OS-の場合&quot;&gt;&lt;a href=&quot;#Windows-OS-の場合&quot; class=&quot;headerlink&quot; title=&quot;Windows OS の場合&quot;&gt;&lt;/a&gt;Windows OS の場合&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows&quot;&gt;こちらの公開ドキュメント&lt;/a&gt;の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。&lt;br&gt;また、特定の TLS バージョンを有効化/無効化されたい場合は、&lt;a href=&quot;https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/&quot;&gt;こちらの記事&lt;/a&gt;の通りご対応ください。&lt;/p&gt;
&lt;p&gt;Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。&lt;/p&gt;
&lt;p&gt;参考として、Android など他のクライアント対応状況は&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation&quot;&gt;こちら&lt;/a&gt;の公開ドキュメントに開示されています。 &lt;/p&gt;
&lt;h3 id=&quot;Chrome-Edge-などのブラウザの場合&quot;&gt;&lt;a href=&quot;#Chrome-Edge-などのブラウザの場合&quot; class=&quot;headerlink&quot; title=&quot;Chrome/Edge などのブラウザの場合&quot;&gt;&lt;/a&gt;Chrome/Edge などのブラウザの場合&lt;/h3&gt;&lt;p&gt;最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、&lt;br&gt;特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。&lt;br&gt;Edgeの場合は&lt;a href=&quot;https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg&quot;&gt;こちらの記事&lt;/a&gt;の通り対応できます。&lt;/p&gt;
&lt;h3 id=&quot;それ以外の場合&quot;&gt;&lt;a href=&quot;#それ以外の場合&quot; class=&quot;headerlink&quot; title=&quot;それ以外の場合&quot;&gt;&lt;/a&gt;それ以外の場合&lt;/h3&gt;&lt;p&gt;上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。&lt;/p&gt;
&lt;h3 id=&quot;TLS-チェッカー-ツール&quot;&gt;&lt;a href=&quot;#TLS-チェッカー-ツール&quot; class=&quot;headerlink&quot; title=&quot;TLS チェッカー ツール&quot;&gt;&lt;/a&gt;TLS チェッカー ツール&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html&quot;&gt;こちら&lt;/a&gt;のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。&lt;/p&gt;
&lt;h2 id=&quot;Azure-Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;a href=&quot;#Azure-Network製品の対応状況及び推奨アクションについて&quot; class=&quot;headerlink&quot; title=&quot;Azure Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;/a&gt;Azure Network製品の対応状況及び推奨アクションについて&lt;/h2&gt;&lt;p&gt;以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。&lt;br&gt;もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!WARNING]&lt;br&gt;以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の複製 / 移動方法ついてのまとめ</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-copy-move-scenario/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-copy-move-scenario/</id>
    <published>2024-09-24T03:00:00.000Z</published>
    <updated>2024-11-26T07:55:53.325Z</updated>
    
    <content type="html"><![CDATA[<p>今回は、お問い合わせいただくことの多い Azure VM の複製 / 移動方法ついてのまとめの記事となります。 </p><span id="more"></span><ul><li>同一サブスクリプション内での Azure VM の複製 / 移動 </li><li>テナントは同じだが別のサブスクリプションへの Azure VM の複製 / 移動 </li><li>別のテナントにある別のサブスクリプションへの Azure VM の複製 / 移動 </li></ul><p>どのパターンにも対応した記事となっております。<br>なお、あくまで複製 / 移動方法の例をご紹介するものとなります点、ご承知おきいただけますと幸いです。 </p><p>まず、手順については複製 / 移動先のテナントが同じか別かによって大きく手順が変わります。<br>そのため、本記事では以下の通り 4 つのパターンに分けて手順をご紹介させていただきます。 </p><table><thead><tr><th>複製 / 移動先は同じテナントか？</th><th>実施する内容は複製か移動か？</th><th>シナリオ</th></tr></thead><tbody><tr><td>同じテナント内</td><td>VM 複製（コピー）を行う</td><td>シナリオ 1</td></tr><tr><td>同じテナント内</td><td>VM の移動をする</td><td>シナリオ 2</td></tr><tr><td>別テナント</td><td>VM 複製（コピー）を行う</td><td>シナリオ 3</td></tr><tr><td>別テナント</td><td>VM の移動をする</td><td>シナリオ 4</td></tr></tbody></table><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>今回は VM の一般化は行わず、完全複製での移動・複製をする場合の手順となります。<br>一般化してイメージを展開する場合は、以下のドキュメントに記載の ACG (Azure Compute Gallery) のご利用をご検討くださいませ。  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/azure-compute-gallery">(参考) Azure Compute Gallery でリソースを格納、共有する</a></p><p>また、Windows VM を一般化せず複製して利用いただくことが原則叶いません点ご留意ください。</p><p><a href="https://jpaztech.github.io/blog/vm/vm-replica-1/#Windows-VM%E3%82%92%E8%A4%87%E8%A3%BD%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%96%B9%E3%81%B8%E3%81%AE%E6%B3%A8%E6%84%8F%E5%96%9A%E8%B5%B7">(参考) Windows VMを複製しようとしている方への注意喚起</a></p><hr><h2 id="同一テナントか否かの確認"><a href="#同一テナントか否かの確認" class="headerlink" title="同一テナントか否かの確認"></a>同一テナントか否かの確認</h2><p>先述の通り、移動・複製元 (以降、”ソース”) と移動・複製先 (以降、”ターゲット”) のテナントが同一であるか否かによって方法が大きく異なります。<br>まずは、これを確認する手順をご案内いたします。</p><p>ソース サブスクリプションとターゲット サブスクリプションが同一テナント配下に属しているか確認します。<br>Azure Portal のサブスクリプションページの「基本」タブの「ディレクトリ」にてサブスクリプションが属しているテナントがご確認いただけます。</p><p><img src="/blog/vm/vm-copy-move-scenario/img001.png"></p><p>それでは、それぞれのシナリオに応じた方法を確認していきましょう。</p><hr><h2 id="シナリオ-1-同一テナント内での-VM-の複製（コピー）"><a href="#シナリオ-1-同一テナント内での-VM-の複製（コピー）" class="headerlink" title="シナリオ 1 - 同一テナント内での VM の複製（コピー）"></a>シナリオ 1 - 同一テナント内での VM の複製（コピー）</h2><p>このシナリオの場合、OS ディスクのスナップショットから VM を複製として作成することが可能です。<br>同一テナント内であればサブスクリプションを跨いだ複製の場合も、ユーザーが両方のサブスクリプションを操作できる権限があればこの手順が使用可能です。<br>手順の詳細につきましては、以下の弊社ブログをご参考ください。   </p><p><a href="https://jpaztech.github.io/blog/vm/vm-replica-3/">(参考) VM 複製方法について part.3/3 OS ディスクのスナップショットから複製する手順</a></p><hr><h2 id="シナリオ-2-同一テナント内での-VM-移動"><a href="#シナリオ-2-同一テナント内での-VM-移動" class="headerlink" title="シナリオ 2 - 同一テナント内での VM 移動"></a>シナリオ 2 - 同一テナント内での VM 移動</h2><p>同一テナント内での VM 移動として、考えられるシナリオとしては、以下のようなものが考えられます。</p><p><strong>A：同一テナント内でのリソースグループの移動</strong><br><strong>B：同一テナント内でのサブスクリプションの移動</strong><br><strong>C：同一テナント内でのリージョンの移動</strong><br><strong>D：同一テナント内でのVNETの移動</strong>  </p><p>それぞれ以下の通り紹介させていただきます。</p><hr><h3 id="A：同一テナント内でのリソースグループの移動-および-B：同一テナント内でのサブスクリプションの移動"><a href="#A：同一テナント内でのリソースグループの移動-および-B：同一テナント内でのサブスクリプションの移動" class="headerlink" title="A：同一テナント内でのリソースグループの移動 および B：同一テナント内でのサブスクリプションの移動"></a>A：同一テナント内でのリソースグループの移動 および B：同一テナント内でのサブスクリプションの移動</h3><p>こちら両方について 2 つの方法が利用可能ですので、ご紹介させていただきます。</p><h4 id="方法-AB1"><a href="#方法-AB1" class="headerlink" title="方法 AB1:"></a>方法 AB1:</h4><p>移動したいリソースをチェックしていただき、 右上の「移動」のドロップダウンリストから「別のリソース グループに移動する」もしくは「別のサブスクリプションへ移動する」をクリックすることでリソースの移動ができます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/move-resource-group-and-subscription#use-the-portal">(参考) リソースを新しいリソース グループまたはサブスクリプションに移動する - ポータルの使用</a></p><p><img src="/blog/vm/vm-copy-move-scenario/img002.png"></p><p>移動を実施いただく前に、移動対象のリソースに対して検証が実行されますが、 何かしらの原因により移動が叶わない場合、「検証状態」が「失敗」と表示され、 「エラーの詳細」から詳細な原因が確認いただけます。 </p><p><img src="/blog/vm/vm-copy-move-scenario/img003.png"></p><p>本手順については以下のドキュメントもご参照いただけますと幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/move-limitations/virtual-machines-move-limitations">(参考) 仮想マシンをリソース グループまたはサブスクリプションに移動するという特殊なケースの処理</a></p><h4 id="方法-AB2"><a href="#方法-AB2" class="headerlink" title="方法 AB2:"></a>方法 AB2:</h4><p>先述の「シナリオ 1 - 同一テナント内での VM の複製（コピー）」の方法で VM を複製した後に元の VM を削除する手順となります。<br>上記 AB1 の方法が対応していない場合などにもご利用いただけます。</p><hr><h3 id="C：同一テナント内でのリージョンの移動"><a href="#C：同一テナント内でのリージョンの移動" class="headerlink" title="C：同一テナント内でのリージョンの移動"></a>C：同一テナント内でのリージョンの移動</h3><p>同一テナント内でのリージョンの移動についても、以下の 2 種の方法をご紹介させていただきます。</p><h4 id="方法-C1："><a href="#方法-C1：" class="headerlink" title="方法 C1："></a>方法 C1：</h4><p>Azure Resource Mover を使用してリージョン間でリソースを移動することが可能でございます。<br>詳細については以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/resource-mover/move-region-within-resource-group">(参考) Azure Resource Mover を使用してリージョン間で (リソース グループから) リソースを移動する</a></p><h4 id="方法-C2："><a href="#方法-C2：" class="headerlink" title="方法 C2："></a>方法 C2：</h4><p>後述の「シナリオ 3 - 別のテナントへの VM の複製（コピー）」と同じ手順で VM 複製を行った後に、元の VM の削除を行います。</p><hr><h3 id="D：同一テナント内での-VNET-の移動"><a href="#D：同一テナント内での-VNET-の移動" class="headerlink" title="D：同一テナント内での VNET の移動"></a>D：同一テナント内での VNET の移動</h3><p>VM を別の VNET へ移動する場合は、以下の方法で VM 再作成が必要となります。</p><p><a href="https://jpaztech.github.io/blog/vm/recreate-vm-to-change-settings/">(参考) 設定変更不可の項目を VM 再作成により再設定する手順</a></p><hr><h2 id="シナリオ-3-別のテナントへの-VM-の複製（コピー）"><a href="#シナリオ-3-別のテナントへの-VM-の複製（コピー）" class="headerlink" title="シナリオ 3 - 別のテナントへの VM の複製（コピー）"></a>シナリオ 3 - 別のテナントへの VM の複製（コピー）</h2><p>テナントを跨いでコピーしたい場合は、そのテナントへディスクを転送してから VM 作成をいただく必要があります。<br>その方法についての 2 通りの方法をご紹介させていただきます。</p><h3 id="Azure-Storage-Explorer"><a href="#Azure-Storage-Explorer" class="headerlink" title="Azure Storage Explorer"></a>Azure Storage Explorer</h3><p>GUI ツールを利用したコピー方法です。こちらは、コマンド無しで VM を別のリージョン・サブスクリプション・テナントに複製が可能です。<br>こちらの手順につきましては、弊社ブログにて詳細手順をご確認いただけますので、ぜひ参考にしてください。</p><p><a href="https://jpaztech.github.io/blog/vm/copy-vm-with-storage-explorer/">(参考) Azure Storage Explorer を用いて、コマンド無しで VM を別のリージョン・サブスクリプション・テナントに移動/複製をしてみよう</a></p><h3 id="Azcopy-コマンド"><a href="#Azcopy-コマンド" class="headerlink" title="Azcopy コマンド"></a>Azcopy コマンド</h3><p>コマンドを用いた方法となります。<br>弊社ブログにて詳細な手順をご紹介しておりますのでこちらをご参照くださいませ。</p><p><a href="https://jpaztech.github.io/blog/vm/create-vm-using-vhd/">(参考) Azure VM からエクスポートした VHD ファイルを用いた複製 VM の作成方法</a></p><div class="alert is-warning"><p class="alert-title">警告</p><p>どちらの手順も VHD ファイルからディスクを作成する際に VM の世代をソース VM の世代と合わせる必要があります。</p></div><hr><h2 id="シナリオ-4-別のテナントへの-VM-移動"><a href="#シナリオ-4-別のテナントへの-VM-移動" class="headerlink" title="シナリオ 4 - 別のテナントへの VM 移動"></a>シナリオ 4 - 別のテナントへの VM 移動</h2><p>テナントを跨いで VM を移動したい場合は、上記の「シナリオ 3 - 別のテナントへの VM の複製（コピー）」の手順を用いて VM 複製をした後に、元の VM を削除します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>別のテナントへの VM の複製 / 移動の方法として、サブスクリプション自体を別のテナントに移転してしまうという方法もございます。</p><p>他方、影響は大きなものとなりますので、参考情報としてのご紹介となります。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/transfer-subscription">(参考)  Azure サブスクリプションを別の Microsoft Entra ディレクトリに移転する</a></p></div><p>以上が各シナリオにおける VM の複製 / 移動の方法のまとめでした。<br>これらの情報が皆様のお役に立てますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;今回は、お問い合わせいただくことの多い Azure VM の複製 / 移動方法ついてのまとめの記事となります。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>オンプレミスと Microsoft サービス間の接続パターン</title>
    <link href="https://jpaztech.github.io/blog/network/connection-method-between-microsoft-and-on-prem/"/>
    <id>https://jpaztech.github.io/blog/network/connection-method-between-microsoft-and-on-prem/</id>
    <published>2024-09-11T15:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートの宇田です。</p><p>今回は Microsoft のネットワークとの様々な接続パターンをご紹介したいと思います。皆さんが自社ないしお客様の案件で Azure や Microsoft 365 などの各種 Microsoft サービスを新たに導入する、ひいては Microsoft のネットワークと接続する際の参考となれば幸いです。</p><h2 id="ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう"><a href="#ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう" class="headerlink" title="ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう"></a>ネットワーク構成を検討する前に、利用予定のサービスの通信要件を確認しましょう</h2><p>Microsoft のクラウド サービスを利用する際、 漠然と以下の図のようにオンプレミスから Microsoft のネットワークに対して通信が行われるようなイメージをされている方も多いのではないでしょうか。</p><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-1.png"></p><p>ただ、実際は上記のようにオンプレミスと Microsoft 間でシンプルに通信している訳ではなく、下図のように Microsoft 内のネットワークも用途別に様々なセグメントに分かれています。Internet、すなわち他の通信事業者に最も近い外側の部分 (Microsoft 視点でいうと上流のネットワーク) には世界中に張り巡らされた WAN が存在し、その拠点である POP には Microsoft が提供する CDN (Azure Front Door) なども配置されています。そして、皆様がご利用になる Azure や Microsoft 365 の各サービス (データセンター) は、その WAN の下にぶら下がる利用部門/ユーザーといった位置づけとなっています。</p><p>また、Windows Update のように弊社外の CDN が利用されている場合もあります。さらに言えば、昨今のクラウド サービスでは大半の通信が SSL/TLS で暗号化されており、その際に用いられる証明書の失効確認などで、外部の認証局 (CA) に対しての通信が発生することも一般的です。このため、Internet と一切の通信ができない完全閉域などを実現することは現実的ではありません。</p><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-2.png"></p><p>以上のような経緯から、ご利用になるサービスの通信要件 (IP アドレス、FQDN など) について、ドキュメント等を事前に十分ご確認いただくことが重要です。以下に通信要件が記載されたドキュメントの一例を記載しますが、各サービスの通信要件 (IP アドレスや FQDN) 及びその用途等については、Azure Networking サポートからは正確なご案内が出来かねます。お手数ですが、各サービスの通信要件について詳細な確認が必要な場合には、各製品・サービスのサポート窓口までお問い合わせいただければと思います。(例: XXXXX というサービスの通信要件を教えてください、XXXXX.microsoft.com との通信はどのような用途で使用されますか？、XXXXX というサービスは、ExpressRoute 経由で利用できますか？)</p><h3 id="参考-代表的なサービスの通信要件"><a href="#参考-代表的なサービスの通信要件" class="headerlink" title="(参考) 代表的なサービスの通信要件"></a>(参考) 代表的なサービスの通信要件</h3><ul><li><a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/urls-and-ip-address-ranges">Microsoft 365 (Office 365)</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls">Azure Portal</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-endpoints/">Microsoft Entra ID</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/network-requirements-consolidated">Azure Arc</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-network-configuration?tabs=PowerShellWindows#firewall-endpoints">Azure Monitor Agent</a></li></ul><h2 id="通信先の-IP-アドレス-FQDN-はどこに存在するのか"><a href="#通信先の-IP-アドレス-FQDN-はどこに存在するのか" class="headerlink" title="通信先の IP アドレス / FQDN はどこに存在するのか"></a>通信先の IP アドレス / FQDN はどこに存在するのか</h2><p>上記のようなドキュメントより、利用予定のサービスの通信要件を把握したら、次にそこに記載されている IP アドレスや FQDN が Microsoft の内外どちらなのか、Microsoft 内の場合には Azure 内なのか否かを判断する必要があります。(後述しますが、ExpressRoute 経由で通信できるのは Azure 内のみであるため、Azure 外の Public IP アドレスの場合は ExpressRoute 経由では通信できないということになります。)</p><p>弊社に限らず、Public IP アドレスは ARIN や APNIC、JPNIC といったインターネット レジストリが各組織 (AS) に対して割り当てを行っています。そのため、例えば以下のようなサイトに IP アドレスを入力することで、その IP アドレスがどの組織に対して割り当てられたものかを調べることができます。(つまり、ASN    が 8075 - MICROSOFT-CORP-MSN-AS-BLOCK 等となっていれば、Microsoft に割り当てられた Public IP アドレスであると判断できます。)</p><ul><li><a href="https://db-ip.com/">https://db-ip.com/</a> (外部サイト)</li></ul><p>また、Azure で利用されている Public IP アドレス (NSG 等で利用するサービス タグ) の内訳を、以下のページで入手できる JSON ファイルで確認いただくことが可能です。この JSON ファイル内において、”AzureCloud.japaneast” 等のリージョンごとのサービス タグの内訳に含まれていれば、その Public IP アドレスは Azure 内に存在する (ExpressRoute 経由で通信ができる) と判断していただければと思います。逆に、”AzureFrontDoor.Frontend” のようなサービス単位のタグにしか含まれておらず、リージョン単位のタグに含まれていない場合は、ExpressRoute 経由では通信できませんのでご注意ください。</p><ul><li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519">Azure IP Ranges and Service Tags – Public Cloud</a></li></ul><h2 id="Microsoft-のネットワークへの接続パターン"><a href="#Microsoft-のネットワークへの接続パターン" class="headerlink" title="Microsoft のネットワークへの接続パターン"></a>Microsoft のネットワークへの接続パターン</h2><p>前置きが長くなりましたが、ここからは Microsoft のネットワークと接続する様々なパターンについて見ていきましょう。</p><h3 id="Internet"><a href="#Internet" class="headerlink" title="Internet"></a>Internet</h3><p>Microsoft の各種クラウド サービスに接続する際の最も一般的な接続方法は、Internet 経由での接続です。在宅勤務をしながら Microsoft Teams を利用したり、Azure 上でホストされている業務アプリなどを利用している方も多いのではないでしょうか。</p><p>Internet 経由と聞くと、セキュアではないという印象をもたれる方もいるかもしれません。ただ、昨今は Microsoft の各種クラウド サービスにおけるほとんどの通信は HTTPS 等で暗号化通信が行われており、Internet 経由であっても安心してご利用いただけるようになっています。また、Azure 上の仮想ネットワーク (VNet) に VPN Gateway や仮想アプライアンスを配置し、VPN 接続をおこなうことも可能です。(稀に、Microsoft 365 宛の通信を VPN 経由にしたい等のご相談をいただくことがございますが、Azure の VPN Gateway としては、そのような接続はサポートしておりません。)</p><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-3.png"></p><h3 id="ExpressRoute"><a href="#ExpressRoute" class="headerlink" title="ExpressRoute"></a>ExpressRoute</h3><p>エンタープライズのお客様などでは、セキュリティ要件で閉域網での接続が必要な場合も少なくないと思います。そうした閉域網での接続が必要な場合には、ExpressRoute での接続をご検討ください。ExpressRoute では、Azure VNet の Private なアドレス空間に接続するための Private Peering と、Azure の Public IP アドレス帯に対して接続するための Microsoft Peering の二種類の接続形態が用意されています。(なお、ExpressRoute の接続先はあくまでも Azure の世界であり、Microsoft 365 等 Azure 外に対しての疎通性はありませんのでご注意ください。)</p><p>その他 ExpressRoute に関する詳細は、公式ドキュメントや本ブログで別途投稿している “詳説 Azure ExpressRoute” の連載を併せてご参照いただければと思います。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/expressroute/">ExpressRoute のドキュメント</a></li><li><a href="/blog/archive/expressroute-deep-dive-part1/">Part1: ExpressRoute を導入する前に</a></li><li><a href="/blog/archive/expressroute-deep-dive-part2/">Part2: ExpressRoute のルーティング制御について</a></li><li><a href="/blog/archive/expressroute-deep-dive-part3/">Part3: ExpressRoute の導入手順について</a></li><li><a href="/blog/archive/expressroute-deep-dive-part4/">Part4: ExpressRoute の冗長構成について</a></li><li><a href="/blog/archive/expressroute-deep-dive-part5/">Part5: ExpressRoute の増速やプロバイダー変更について</a></li><li><a href="/blog/network/expressroute-deep-dive-part6/">Part6: ExpressRoute の各種上限値について</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-4.png"></p><h3 id="ExpressRoute-IPsec-VPN"><a href="#ExpressRoute-IPsec-VPN" class="headerlink" title="ExpressRoute + IPsec VPN"></a>ExpressRoute + IPsec VPN</h3><p>通常の ExpressRoute 回線は、閉域網での接続を行うのみであり、伝送路での暗号化は行われていません。(Internet 経由の場合と同様、昨今ではほとんどの通信は暗号化されておりますので、伝送路で暗号化をしないからといってセキュアではないというわけではありません。) </p><p>もしセキュリティ要件が極めて厳しく、伝送路での暗号化も必須であるというような場合には、ExpressRoute 越しに Azure VNet 上の VPN Gateway と IPsec VPN を張ることも可能です。ただし、伝送路での暗号化が行えるのは VPN Gateway をデプロイする関係上、Azure VNet 宛の通信のみとなります。Microsoft Peering で接続する Azure の Public IP アドレス帯への通信は伝送路では暗号化されません。</p><p>Azure VNet に対して閉域かつ伝送路での暗号化を行った上で接続したい場合は、以下のドキュメント等を参考に構成していただければと思います。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/site-to-site-vpn-private-peering">ExpressRoute プライベート ピアリング経由のサイト間 VPN 接続を構成する</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-5.png"></p><h3 id="ExpressRoute-Direct-MACsec"><a href="#ExpressRoute-Direct-MACsec" class="headerlink" title="ExpressRoute Direct (+ MACsec)"></a>ExpressRoute Direct (+ MACsec)</h3><p>Microsoft Peering も含めて、伝送路での暗号化を行われたいという場合については、通常の ExpressRoute 回線ではなく、物理ポート (10G or 100G) 占有型の L1 接続である ExpressRoute Direct のサービスを利用していただくことで、MACsec をご利用いただくことが可能です。物理ポートを買い切っていただくモデルとなるため、他の接続形態と比較して費用が高額になりますが、伝送路での暗号化が必須要件となる場合の選択肢としてご参考程度に紹介いたします。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-macsec">ExpressRoute Direct ポートで MACsec を構成する</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-6.png"></p><h3 id="Azure-Peering-Service"><a href="#Azure-Peering-Service" class="headerlink" title="Azure Peering Service"></a>Azure Peering Service</h3><p>Azure だけでなく、Microsoft 365 のサービスに対しての疎通性も必要な場合は、Azure Peering Service が選択肢となります。Azure Peering Service は、Microsoft の WAN にあたる AS8075 のネットワークと接続を行うサービスとなるため、Azure 以外の Microsoft が所有する Public IP アドレス帯へも疎通性 (経路情報) が提供されます。ただし、ExpressRoute とは異なり閉域接続を謳うサービスではありません。(PNI や IX 経由で Microsoft の AS8075 と接続いただく際と同様の接続イメージとなります。)　Azure Peering Service は、あくまでも経路の最適化による遅延の削減や信頼性向上を目的としたサービスとなりますので、その点は予めご承知おきください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/peering-service/about">Azure Peering Service の概要</a></li></ul><p><img src="/blog/network/connection-method-between-microsoft-and-on-prem/connection-method-between-microsoft-and-on-prem-7.png"></p><h3 id="番外編-1-オンプレミスから-Internet-宛の通信を-Azure-経由としたい場合"><a href="#番外編-1-オンプレミスから-Internet-宛の通信を-Azure-経由としたい場合" class="headerlink" title="(番外編 1) オンプレミスから Internet 宛の通信を Azure 経由としたい場合"></a>(番外編 1) オンプレミスから Internet 宛の通信を Azure 経由としたい場合</h3><p>お客様によっては、Internet への出口を一元化したい、もしくは閉域環境でやむなく一部の Internet 宛の通信を行えるようにしなければならない等の理由で、オンプレミスから Internet 宛の通信を Azure 経由で行いたいというご相談をいただくことがあります。</p><p>こうした構成を実現する場合、以下の二通りの方法が考えられます。</p><ul><li>Azure 上に Forward Proxy を構築し、プロキシ経由で通信をさせる</li><li>Azure からオンプレミスに対して BGP でデフォルト ルートを広報させる</li></ul><p>前者については、Azure VM で Proxy (Squid 等) を構築いただき、PAC ファイルや Proxy サーバー上で特定の FQDN 宛の通信のみ許可するなどの制御をいただくことになります。他方で後者については、Azure 上に Virtual WAN もしくは Route Server + NVA を構築いただく構成となり、以下のブログで詳しくご紹介しておりますので、こちらをご参照いただければと思います。</p><ul><li><a href="https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/">オンプレミスからのインターネット宛ての通信を Azure 経由にする方法</a></li></ul><h3 id="番外編-2-ゼロトラスト-ソリューションをお探しの場合"><a href="#番外編-2-ゼロトラスト-ソリューションをお探しの場合" class="headerlink" title="(番外編 2) ゼロトラスト ソリューションをお探しの場合"></a>(番外編 2) ゼロトラスト ソリューションをお探しの場合</h3><p>ここまで紹介してきた接続方法とは少し毛色が違いますが、Microsoft ではゼロトラスト (ZTNA) 向けの SSE: Secure Service Edge (SASE: Secure Access Service Edge と呼ばれることもあります) ソリューションとして、Microsoft Entra Private Access および Microsoft Entra Internet Access から構成される Global Secure Access というサービスを提供しています。従来の Firewall や VPN 装置をリプレースし、ゼロトラスト ソリューションの導入を検討されている方は、こちらをご検討いただければと思います。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/overview-what-is-global-secure-access">Global Secure Access とは</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/global-secure-access/concept-private-access">Microsoft Entra Private Access について学習する</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/architecture/sse-deployment-guide-internet-access">Microsoft の Security Service Edge ソリューションの Microsoft Entra Internet Access 概念実証デプロイ ガイド</a></li></ul><h2 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h2><h3 id="XXXXX-というサービスを完全閉域で利用できますか"><a href="#XXXXX-というサービスを完全閉域で利用できますか" class="headerlink" title="XXXXX というサービスを完全閉域で利用できますか"></a>XXXXX というサービスを完全閉域で利用できますか</h3><p>お客様のセキュリティ要件などで Internet 接続を行うことができず、完全閉域で Microsoft の各種クラウド サービスを利用したいといったご相談をいただくことがございます。ただ、前述の通り CDN や認証局などの弊社外との通信が必要となる場合がほとんどですので、Internet 接続が何らか必要になるものと予めご理解をいただければと思います。</p><div class="alert is-info"><p class="alert-title">Note</p><p> 「ExpressRoute 経由で XXXXX というサービスに通信できるか」といったお問い合わせを ExpressRoute の質問として Azure Networking サポートにお問い合わせいただく場合がございます。ただ、ExpressRoute は BGP で経路交換を行うのみであり、各製品・サービスがどのような FQDN や IP アドレスを使用しているかといった通信要件については、Azure Networking サポートでは情報を持ち合わせておりませんため、ご案内ができません。お手数ですが、対象製品のサポート窓口まで (複数製品の場合には、製品ごとに個別に) お問い合わせいただくようお願いいたします。</p></div><h3 id="Microsoft-365-に対して、閉域網で接続することはできますか"><a href="#Microsoft-365-に対して、閉域網で接続することはできますか" class="headerlink" title="Microsoft 365 に対して、閉域網で接続することはできますか"></a>Microsoft 365 に対して、閉域網で接続することはできますか</h3><p>Microsoft 365 は、Internet からのアクセスを前提に設計されており、ExpressRoute を利用した “閉域網のみ” で利用いただくようには設計されていません。前述の通り ExpressRoute 経由では通信できない外部のエンドポイントもございますので、ExpressRoute 経由の閉域網で Microsoft 365 を利用することは原則不可とご認識ください。唯一の例外として、法的要件などで閉域接続が必須のお客様のみ、弊社担当営業へご相談をいただき、開発部門による個別の承認を得たうえで Microsoft 365 の経路情報を受け取る (ルートフィルターで Microsoft 365 関連の BGP Community を利用する) ことが可能とはなっています。ただ、この承認を得た場合であっても、Microsoft 365 のすべての通信が閉域網で行えるわけではなく、Internet 接続が必要となる点は変わりませんのでご留意ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/azure-expressroute">Azure ExpressRoute for Microsoft 365</a></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p> Microsoft 365 の ExpressRoute は、ほとんどの状況でサービスに最適な接続モデルを提供しないため 、<strong>お勧めしません 。</strong> そのため、この接続モデルを使用するには Microsoft の承認が必要です。 お客様のすべての要求を確認し、必要なまれなシナリオでのみ、Microsoft 365 の ExpressRoute を承認します。 詳細については 、<a href="https://aka.ms/erguide">ExpressRoute for Microsoft 365 ガイド</a> を参照してください。また、生産性、ネットワーク、セキュリティ チームに関するドキュメントの包括的なレビューに従って、Microsoft アカウント チームと協力して、必要に応じて例外を送信してください。 Microsoft 365 のルート フィルターを作成しようとしている未承認のサブスクリプションには、 <a href="https://support.microsoft.com/kb/3181709">エラー メッセージ</a>が表示されます。</p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure サポートの宇田です。&lt;/p&gt;
&lt;p&gt;今回は Microsoft のネットワークとの様々な接続パターンをご紹介したいと思います。皆さんが自社ないしお客様の案件で Azure や Microsoft 365 などの各種 Microsoft サービスを新た</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="Azure Peering Service" scheme="https://jpaztech.github.io/blog/tags/Azure-Peering-Service/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM での Windows Server Standard Edition 利用について</title>
    <link href="https://jpaztech.github.io/blog/vm/winsererver-standard-edition/"/>
    <id>https://jpaztech.github.io/blog/vm/winsererver-standard-edition/</id>
    <published>2024-09-10T08:31:00.000Z</published>
    <updated>2024-11-26T07:55:53.365Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの富田です。<br>本ブログ記事では、Azure VM での Windows Server Standard Edition の利用についてご案内いたします。</p><span id="more"></span><p>Azure マーケットプレイスでは、上位エディションである Datacenter Edition / Datacenter: Azure Edition が同じ利用料金で提供されておりますため、Standard Edition のご提供がございません。</p><p>もし Standard Edition の利用をされたいといった場合は、オンプレミス環境から既に所有している Standard Editionを持ち込むことは可能ではございます。<br>この場合は、以下のように VHD の準備が必要となります。</p><p>■ご参考：Azure にアップロードする Windows VHD または VHDX を準備する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image">https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image</a></p><p>上記の通り、Standard Edition を利用したとしても、料金の差異は無く、上位エディションの Datacenter Edition / Datacenter: Azure Editionがマーケットプレイスより、ご利用可能ですので、こちらの利用をご検討いただけますと幸いです。</p><p>Windows Server エディションごとの機能の比較は以下のドキュメントを参考にしてください。</p><p>■ご参考 : Windows Server のエディションの比較 | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/windows-server/get-started/editions-comparison?pivots=windows-server-2022">https://learn.microsoft.com/ja-jp/windows-server/get-started/editions-comparison?pivots=windows-server-2022</a></p><p>簡単ではございますが、上記の内容が皆様のお役に立ちますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの富田です。&lt;br&gt;本ブログ記事では、Azure VM での Windows Server Standard Edition の利用についてご案内いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Azure Files をマウントするユーザーとアクセスについて</title>
    <link href="https://jpaztech.github.io/blog/vm/azure-files-user-mount/"/>
    <id>https://jpaztech.github.io/blog/vm/azure-files-user-mount/</id>
    <published>2024-09-10T08:30:00.000Z</published>
    <updated>2024-11-26T07:55:53.009Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。  </p><p>お客様より「Windows 環境でユーザー A でマウントした Azure Files についてユーザー B より参照ができない。」というお問い合わせをいただくことがございます。<br>こちらは New-PSDrive / net use / エクスプローラーでマウントした際の仕様となっており、マウントを行ったユーザー以外のユーザーからは Azure Files のマウント先を参照できないものとなっております。<br>そのため原則としてユーザー毎にマウントを行っていただく必要がございます点、ご留意くださいませ。 </p><span id="more"></span><p>なお、Windows Server 2019 / Windows 10 以降の OS では、New-SmbGlobalMapping コマンドを利用し Azure Files をマッピングいただくことで、 全てのユーザーでのアクセスが可能かつ、Windows ユーザーがログインしていない状態でも Azure Files へのアクセスが可能となります。<br>以下に手順を紹介させていただきますが、このような状態がお客様のセキュリティ要件上問題ないものであるかご確認をいただきますようお願いいたします。</p><p>—サンプル手順— </p><ol><li>該当環境に管理者アカウントでログインします。 </li><li>Powershell を [管理者として実行] から起動します。 </li><li>以下のコマンドの ＜＞ で指定している部分をご自身の環境に合わせて変更してから順に実行します。 </li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 共有で使用するアカウントを指定 </span></span><br><span class="line"><span class="variable">$User</span> = <span class="string">&quot;localhost\＜ストレージアカウント名＞&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 上記アカウントのパスワードを指定 </span></span><br><span class="line"><span class="variable">$PWord</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="string">&quot;＜ストレージアカウントアクセスキー＞&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## クレデンシャルを作成 </span></span><br><span class="line"><span class="variable">$Credential</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> System.Management.Automation.PSCredential <span class="literal">-ArgumentList</span> <span class="variable">$User</span>, <span class="variable">$PWord</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## -RemotePath に共有のパスを指定、-LocalPath にマッピングするドライブを指定 </span></span><br><span class="line"><span class="built_in">New-SmbGlobalMapping</span> <span class="literal">-RemotePath</span> \\＜ストレージアカウント名＞.file.core.windows.net\＜ファイル共有名＞ <span class="literal">-Credential</span> <span class="variable">$Credential</span> <span class="literal">-LocalPath</span> Z: <span class="literal">-Persistent</span> <span class="variable">$True</span> </span><br></pre></td></tr></table></figure><ol start="4"><li>一度サインアウトすることで、アクセス可能となります。 </li></ol><p>—手順ここまで— </p><p>■ご参考：Azure Files とは<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction">https://learn.microsoft.com/ja-jp/azure/storage/files/storage-files-introduction</a></p><p>■ご参考： New-SmbGlobalMapping<br><a href="https://learn.microsoft.com/en-us/powershell/module/smbshare/new-smbglobalmapping">https://learn.microsoft.com/en-us/powershell/module/smbshare/new-smbglobalmapping</a>　 </p><p>上記の内容がお客様のお役に立てますと幸いでございます。 </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。  &lt;/p&gt;
&lt;p&gt;お客様より「Windows 環境でユーザー A でマウントした Azure Files についてユーザー B より参照ができない。」というお問い合わせをいただくことがございます。&lt;br&gt;こちらは New-PSDrive / net use / エクスプローラーでマウントした際の仕様となっており、マウントを行ったユーザー以外のユーザーからは Azure Files のマウント先を参照できないものとなっております。&lt;br&gt;そのため原則としてユーザー毎にマウントを行っていただく必要がございます点、ご留意くださいませ。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Azure Files" scheme="https://jpaztech.github.io/blog/tags/Azure-Files/"/>
    
  </entry>
  
  <entry>
    <title>Azure Bastion 接続不可の対処方法とよくあるお問い合わせ</title>
    <link href="https://jpaztech.github.io/blog/network/bastion-troubleshooting/"/>
    <id>https://jpaztech.github.io/blog/network/bastion-troubleshooting/</id>
    <published>2024-08-15T08:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの角村です。</p><p>今回は、Bastion 接続不可の際の原因の切り分け方法や原因ごとの対処法、よくあるお問い合わせについてご紹介します。<br>現在、Bastion に関するお問い合わせの約半分が接続不可に関するものですが、その原因は様々です。<br>トラブルシューティングの際には、原因の切り分けと、特定された原因に応じた対処方法を実施することで、問題が解消する可能性があります。</br></p><p>実際に Bastion 経由で VM への接続ができない場合は、まず以下の点を確認してみてください。</p><span id="more"></span><h2 id="特定の-VM-のみ-複数台の-VM-で発生している事象なのか"><a href="#特定の-VM-のみ-複数台の-VM-で発生している事象なのか" class="headerlink" title="特定の VM のみ/複数台の VM で発生している事象なのか"></a>特定の VM のみ/複数台の VM で発生している事象なのか</h2><p>接続の問題が Bastion 側にあるのか、もしくは VM 側にあるのかを切り分けるための判断材料になります。<br>もしも特定の VM のみが接続不可となっている場合、主な原因として考えられる内容および対処方法は以下のとおりです。</br></p><h3 id="・VM-および-VM-の-サブネットに適用された-NSG-において、通信が許可されていない可能性"><a href="#・VM-および-VM-の-サブネットに適用された-NSG-において、通信が許可されていない可能性" class="headerlink" title="・VM および VM の サブネットに適用された NSG において、通信が許可されていない可能性"></a><strong>・VM および VM の サブネットに適用された NSG において、通信が許可されていない可能性</strong></h3><p>Bastion - VM 間で RDP/SSH 通信が拒否されてしまっている場合、Bastion のサブネットから VM のサブネットへの SSH もしくは RDP (TCP ポート 22 もしくは TCP ポート 3389) の許可をするよう NSG の受信ルールを設定いただく必要がございます。</br><br>NSG の設定例については以下の公式ブログでご紹介しておりますので、ご一読いただけますと幸いです。<br><a href="https://jpaztech.github.io/blog/network/bastion-nsg/#VM-%E3%81%8A%E3%82%88%E3%81%B3-VM-%E3%81%AE%E3%82%B5%E3%83%96%E3%83%8D%E3%83%83%E3%83%88%E3%81%AE-NSG-%E3%81%AE%E5%8F%97%E4%BF%A1%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E8%A6%8F%E5%89%87">VM および VM のサブネットの NSG の受信セキュリティ規則</a></p><h3 id="・接続情報に誤りがある可能性"><a href="#・接続情報に誤りがある可能性" class="headerlink" title="・接続情報に誤りがある可能性"></a><strong>・接続情報に誤りがある可能性</strong></h3><p>接続情報に関しては、作成の際に間違えて登録してしまうケースや、久しぶりに仮想マシンを利用する際の記憶違いや記録ミスなど、日常的に起こしやすいエラーの1つです。過去のお問合せでは、パスワード リセットによって事象が解消したケースもございます。<br>パスワード リセット方法については以下の公開情報にてご案内しておりますので参考になりましたら幸いです。<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/windows/reset-rdp">Windows VM でリモート デスクトップ サービスまたはその管理者パスワードをリセットする - Virtual Machines | Microsoft Learn</a><br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/linux/reset-password">Azure VM 上でローカルの Linux パスワードをリセットする方法 - Virtual Machines | Microsoft Learn</a></p><p>複数台の VM において事象が発生している場合は、AzureBastionSubnet に関連付けられた NSG でパブリック インターネット、もしくはクライアントの グローバル IP アドレス範囲からの通信が許可されているかをご確認ください。<br>NSG の設定内容についての詳細は<a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-nsg#nsg">こちら</a>をご確認ください。</p><h2 id="特定のクライアント端末でのみ発生している事象なのか"><a href="#特定のクライアント端末でのみ発生している事象なのか" class="headerlink" title="特定のクライアント端末でのみ発生している事象なのか"></a>特定のクライアント端末でのみ発生している事象なのか</h2><p>クライアント PC 側に要因があるかどうかを切り分けるための判断材料になります。<br>特定のクライアントのみ事象が発生している場合、さらに以下の点をご確認いただく事で事象が解消する可能性があります。</br></p><h3 id="・ブラウザ-の拡張機能"><a href="#・ブラウザ-の拡張機能" class="headerlink" title="・ブラウザ の拡張機能"></a><strong>・ブラウザ の拡張機能</strong></h3><p>ブラウザの拡張機能が接続不可の要因となっている可能性があります。<br>可能であればブラウザの拡張機能を無効化の上、接続をお試しいただくか、InPrivate/シークレットモードを利用いただく事で事象が解消する可能性があります。<br>また、ブラウザによっては Bastion の利用がサポートされていない点についてもご注意ください。</p><p>参考- <a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-faq#browsers">どのブラウザーがサポートされていますか?</a></p><h3 id="・クライアント-PCおよび、ネットワークの問題"><a href="#・クライアント-PCおよび、ネットワークの問題" class="headerlink" title="・クライアント PCおよび、ネットワークの問題"></a><strong>・クライアント PCおよび、ネットワークの問題</strong></h3><p>クライアント 側の のプロキシ設定や ファイヤーウォールが Bastion への接続をブロックしている可能性があります。<br>その場合、&lt;*.bastion.azure.com&gt; への 443 (https) を許可いただく事で、事象が解消する可能性があります。</br><br>なお、Bastion はご利用方法によって URL が追加で必要になる場合があります。<br>例えば、ポータルから Bastion 経由で VM へ接続する場合は、上記 Bastion の URL 以外に、ポータルへの接続/操作のため、&lt;*.portal.azure.com&gt; の許可が現状の動作として必要です。</p><p>参考- <a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-safelist-urls?tabs=public-cloud">ファイアウォールまたはプロキシ サーバーで Azure portal の URL を許可する</a></p><hr><p>上記をご確認いただいても事象が解消しなかった場合や、該当する事象ではない場合は、Azure サポートまでお問い合わせください。<br>その際は、既にご確認いただいた内容と併せて、以下の点について情報提供いただけますと幸いです。</br></p><hr><blockquote><p><strong>・ 直近で接続不可となってしまった日時 (日本時間)</strong></p></blockquote><p>Azure 基盤側で接続不可時のログを確認する際に必要な情報となります。</p><blockquote><p><strong>・ Bastion および接続不可 VM のリソース ID</strong></p></blockquote><p>リソース ID は、リソース画面 左ブレード メニューの [概要] から 、画面右上の [JSON ビュー] をクリックいただくと確認可能でございます。<br>※お問合せ起票時に Bastion リソースを選択して起票いただいている場合は、接続不可 VM のリソース ID のみ、別途お問い合わせ内容に記載ください。</p><blockquote><p><strong>・ 接続エラー時のスクリーン ショット、もしくは接続実行コマンドと実行結果</strong></p></blockquote><p>ブラウザ経由で接続に失敗する場合は、発生したエラーの内容がわかるスクリーン ショットをご提供ください。<br>Azure CLI から az network bastion コマンドを利用している場合は、 debug オプションを付けた状態で実行コマンドと実行結果をご教示いただけますと幸いです。<br>以下に実行いただきたいコマンドの例を記載いたします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az network bastion rdp --name &lt;Bastion リソース名&gt; --resource-group &lt;Bastion が存在するリソース グループ名&gt; --target-resource-id &lt;ターゲット VM のリソース ID&gt; --debug</span><br></pre></td></tr></table></figure><p>※ 上記は RDP 接続時のコマンドとなります。お客様の接続方法に合わせてコマンドを変更ください</p><blockquote><p><strong>・ Bastion を経由せずに VM へ直接 RDP/SSH が可能かどうか</strong></p></blockquote><p>接続先 VM にパブリック IP が付与されている場合、クライアント PC からネイティブ クライアントを利用して直接 RDP/SSH 接続が可能かご確認ください。<br>もしくは、同一 Vnet 上の別 VM から 直接 RDP 接続が可能か確認いただくという方法でも問題ございません。</br></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>その他、接続不可以外によくお問い合わせいただく内容についても以下にまとめてみましたので、参考になりましたら幸いです。</p><h3 id="Bastion-で-Windows-Server-に対する同時-RDP-接続数について"><a href="#Bastion-で-Windows-Server-に対する同時-RDP-接続数について" class="headerlink" title="Bastion で Windows Server に対する同時 RDP 接続数について"></a>Bastion で Windows Server に対する同時 RDP 接続数について</h3><p>Bastion 経由で Windows Server に対する RDP の同時接続数は、現在 2 接続となっています。<br>サポート担当で動作を確認する限り、現在の Bastion における RDP 接続時の動作として、Windows Server に管理モードで RDP 接続をしています。<br>Windows Server の管理モードでの RDP 接続は、最大同時接続数が 2 となっており、この同時接続数を増やすことは出来ません。<br>なお、Bastion は複数の同時 RDP 接続が可能な RDS セッション ホストや Azure Virtual Desktop への RDP 接続には利用できません。<br>参考- <a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-faq">Azure Bastion に関する FAQ</a></p><h3 id="Bastion-インスタンスあたりのセッション数上限に達した際に検知したい"><a href="#Bastion-インスタンスあたりのセッション数上限に達した際に検知したい" class="headerlink" title="Bastion インスタンスあたりのセッション数上限に達した際に検知したい"></a>Bastion インスタンスあたりのセッション数上限に達した際に検知したい</h3><p>インスタンスあたりの同時接続数上限に達した際、それを検知してインスタンスをスケーリングさせたいというお問い合わせをいただく事がございます。<br>ご期待に沿えず恐れ入りますが、直接的にインスタンスあたりのセッション数の上限を検知する方法はありません。<br>そのため、例えばリモート接続で操作している VM の画面遷移が遅いなどの利用者からのフィード バックや、Bastion で監視可能なメトリックの情報を組み合わせて、お客様自身でインスタンスをスケールさせるタイミングをご判断いただく必要がございます。<br>なお、Bastion で監視可能なメトリックの一覧については<a href="https://learn.microsoft.com/ja-jp/azure/bastion/howto-metrics-monitor-alert">こちら</a>をご確認ください。</p><p>また、以下の公開情報では Bastion インスタンスあたりの同時接続可能数について記載されていますが、あくまで目安の数値となります。実際のご利用方法によって、インスタンスあたりの接続数上限は前後する点についてもご留意ください。<br>参考- <a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#azure-bastion-limits">Azure Bastion の制限</a></p><h3 id="Bastion-が対応している認証方法について"><a href="#Bastion-が対応している認証方法について" class="headerlink" title="Bastion が対応している認証方法について"></a>Bastion が対応している認証方法について</h3><p>Bastion 接続時に利用可能な認証方法は、ご利用いただくプロトコルや SKU によって異なります。<br>ご利用環境と認証方式のミスマッチが起きているお問い合わせが散見されるため、以下のとおり表にまとめました。</br></p><table><thead><tr><th>プロトコル</th><th>接続方法</th><th>認証方法</th><th>対応 SKU</th></tr></thead><tbody><tr><td>RDP</td><td>ブラウザ</td><td>・ユーザー/PW を手入力<br>・PW を Key Vault から読み込む</td><td>・Developer<br>・Basic<br>・Standard<br>・Premium</td></tr><tr><td>RDP</td><td>ネイティブ クライアント</td><td>・ユーザー/PW を手入力<br>・Entra ID 認証</td><td>・Standard<br>・Premium</td></tr><tr><td>RDP</td><td>共有可能リンク</td><td>・ユーザー/PW を手入力</td><td>・Standard<br>・Premium</td></tr><tr><td>SSH</td><td>ブラウザ</td><td>・ユーザー/PW を手入力<br>・PW を Key Vault から読み込む<br>・SSH Key をローカルから読み込む<br>・SSH Key を Key Vault から読み込む</td><td>・Developer<br>・Basic<br>・Standard<br>・Premium</td></tr><tr><td>SSH</td><td>ネイティブ クライアント</td><td>・ユーザー/PW を手入力<br>・Entra ID 認証<br>・SSH Key をローカルから読み込む</td><td>・Standard<br>・Premium</td></tr><tr><td>SSH</td><td>共有可能リンク</td><td>・ユーザー/PW を手入力<br>・SSH Key をローカルから読み込む</td><td>・Standard<br>・Premium</td></tr></tbody></table><h3 id="Bastion-接続時の解像度を調節したい"><a href="#Bastion-接続時の解像度を調節したい" class="headerlink" title="Bastion 接続時の解像度を調節したい"></a>Bastion 接続時の解像度を調節したい</h3><p>ご期待に沿えず恐れ入りますが、ブラウザから Bastion を利用してリモート接続されている場合は、解像度を変更いただく事はできません。<br>ネイティブ クライアント接続をご利用されている場合は、以下の手順で解像度の調節が可能となります。</br></p><ol><li><p>ネイティブ クライアント接続コマンドの末尾に ”–configure” オプションを付けて実行</br><br>実行コマンド例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az network bastion rdp --name &lt;Bastion リソース名&gt; --resource-group &lt;Bastion が存在するリソース グループ名&gt; --target-resource-id &lt;ターゲット VM のリソース ID&gt; --configure</span><br></pre></td></tr></table></figure></li><li><p>コマンド実行後、リモート デスクトップ画面が開くので、[画面] タブをクリック</br></p></li></ol><p><img src="/blog/network/bastion-troubleshooting/resolution-2.jpg"> </p></br>  3. 「画面の設定」にて、“リモート セッションですべてのモニターを使用する” のチェックをお外しいただき、上部のスライダーを操作いただく事で解像度の設定が可能となります。</br><p><img src="/blog/network/bastion-troubleshooting/resolution-3.jpg"> </p><p>以上、本情報が参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの角村です。&lt;/p&gt;
&lt;p&gt;今回は、Bastion 接続不可の際の原因の切り分け方法や原因ごとの対処法、よくあるお問い合わせについてご紹介します。&lt;br&gt;現在、Bastion に関するお問い合わせの約半分が接続不可に関するものですが、その原因は様々です。&lt;br&gt;トラブルシューティングの際には、原因の切り分けと、特定された原因に応じた対処方法を実施することで、問題が解消する可能性があります。&lt;/br&gt;&lt;/p&gt;
&lt;p&gt;実際に Bastion 経由で VM への接続ができない場合は、まず以下の点を確認してみてください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Bastion" scheme="https://jpaztech.github.io/blog/tags/Bastion/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway 書き換え規則の事例集</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-rewrite/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-rewrite/</id>
    <published>2024-07-03T22:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.865Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Networking サポート チームの三島です。<br>Application Gateway v2 では HTTP ヘッダーなどのパラメーターを書き換える機能を提供しています。<br>この記事は、Application Gateway 書き換え規則に関してよく寄せられるお問い合わせをもとに事例集として再構成したものです。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Application Gateway では書き換え規則をサポートしています (※Standard_v2 / WAF_v2 SKU のみ)。<br>書き換え規則を使用することで、要求および応答中のヘッダーや URL を書き換えることができます。<br>この機能により、事例集に記載したような様々なシナリオに対応することが可能です。</p><h2 id="事例集"><a href="#事例集" class="headerlink" title="事例集"></a>事例集</h2><p>早速事例を紹介いたします。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#common-scenarios-for-header-rewrite">Microsoft Learn でも書き換え規則のシナリオをご紹介</a>しておりますので併せてご確認ください。</p><h3 id="事例-1-Location-ヘッダーの書き換え"><a href="#事例-1-Location-ヘッダーの書き換え" class="headerlink" title="事例 1 - Location ヘッダーの書き換え"></a>事例 1 - Location ヘッダーの書き換え</h3><p>サポート チームにいただくお問い合わせの中で最も多いのが Location ヘッダーの書き換えです。<br>Location ヘッダーの書き換えには複数のパターンがありますが、代表的なものは以下の 3 つです。  </p><ul><li>FQDN の書き換え: バックエンド サーバーが生成する URL の FQDN を、クライアント アクセス用の FQDN に書き換える (例: <em><a href="https://contoso.azurewebsites.net/">https://contoso.azurewebsites.net</a></em> -&gt; <em><a href="https://www.contoso.com/">https://www.contoso.com</a></em>、<em><a href="https://192.168.0.4/">https://192.168.0.4</a></em> -&gt; <em><a href="https://www.contoso.com/">https://www.contoso.com</a></em>)</li><li>URL スキームの書き換え: バックエンド サーバーが生成する URL のスキームを HTTP から HTTPS に書き換える (<em><a href="http://www.contoso.com/">http://www.contoso.com</a></em> -&gt; <em>http*<em>s</em></em>://<a href="http://www.contoso.com/">www.contoso.com</a>*)</li><li>リダイレクト ポートの書き換え: バックエンド サーバーが生成する URL のリダイレクト ポートを Application Gateway で書き換える (<em><a href="https://www.contoso.com/">https://www.contoso.com</a></em> -&gt; <em><a href="https://www.contoso.com:8443/">https://www.contoso.com:8443</a></em>)</li></ul><h4 id="事例-1-1-FQDN-の書き換え"><a href="#事例-1-1-FQDN-の書き換え" class="headerlink" title="事例 1-1 FQDN の書き換え"></a>事例 1-1 FQDN の書き換え</h4><h5 id="代表的なシナリオ"><a href="#代表的なシナリオ" class="headerlink" title="代表的なシナリオ"></a>代表的なシナリオ</h5><p>よくあるシナリオとしては、Application Gateway の背後に App Service (認証なし) を配置している構成です。<br>App Service においてカスタム ドメインが構成されていない場合、App Service が生成する Location ヘッダーのリダイレクト URL の FQDN は App Service 既定の FQDN <code>*.azurewebsites.net</code> が使用されます。<br>Application Gateway は、App Service が生成した Location ヘッダーをそのままクライアントに応答するため、クライアントは受け取ったリダイレクト URL の FQDN <code>*.azurewebsites.net</code> に直接アクセス (Application Gateway をバイパス) します。<br>App Service におけるアクセス制御の状態 (Application Gateway からのアクセスのみに限定しているなど) によっては、クライアントが App Service から接続を拒否され、リダイレクト URL にアクセスできないという結果になります。<br>また、クライアントにバックエンド サーバーの URL を公開したくないというご要件がある場合もこのシナリオで対応可能です。  </p><h5 id="構成例"><a href="#構成例" class="headerlink" title="構成例"></a>構成例</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/architecture/best-practices/host-name-preservation">Microsoft Learn でご案内しているとおり</a>、リバース プロキシ経由で Web アプリケーションにアクセスする構成では、Cookie やリダイレクト URL が正しく機能せず認証やセッションの問題が発生することがあるため、クライアントがリバース プロキシにアクセスする際に指定するホスト名とリバース プロキシがバックエンドにアクセスする際に指定するホスト名は、一致するように構成することが推奨されます。<br>しかしながら、何からの制約でリバース プロキシ側で URL を書き換える必要がある場合、Application Gateway の書き換え規則が有効です。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#modify-a-redirection-url">こちらの例</a>を参考に URL を書き換えます。</p><h4 id="事例-1-2-URL-スキームの書き換え"><a href="#事例-1-2-URL-スキームの書き換え" class="headerlink" title="事例 1-2 URL スキームの書き換え"></a>事例 1-2 URL スキームの書き換え</h4><h5 id="代表的なシナリオ-1"><a href="#代表的なシナリオ-1" class="headerlink" title="代表的なシナリオ"></a>代表的なシナリオ</h5><p>バックエンド サーバーが HTTP で動作しており、バックエンド サーバーが生成する Location ヘッダーの URL スキームが <code>http://</code> になってしまうという事例です。<br>Location ヘッダーを受け取ったクライアントは、HTTP で Application Gateway にアクセスします。Application Gateway で HTTP リスナーが動作していない場合はアクセスが失敗し、HTTP リスナーでリダイレクトが構成されている場合は不要なリダイレクトが発生するといった結果になります。</p><h5 id="構成例-1"><a href="#構成例-1" class="headerlink" title="構成例"></a>構成例</h5><p>以下のような書き換え規則を作成します。</p><h6 id="If"><a href="#If" class="headerlink" title="If"></a>If</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>HTTP ヘッダー</td><td>-</td></tr><tr><td>ヘッダーの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>http:\/\/(.*)</td><td>http:// で始まり、任意の文字列が 1 回以上で構成される URL を正規表現で表しています。<br>バックエンド サーバーが生成する URL に応じて任意の正規表現が構成可能です。<br><code>\</code>は環境によっては円マークが表示されますがバックスラッシュです。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>ヘッダー値</td><td>https://{http_resp_Location_1}</td><td>書き換え後のヘッダー値は「<code>https://</code> で始まり、応答の Location ヘッダーを正規表現によりキャプチャした 1 番目のグループで構成される URL」を返却するように構成しています。<br>If 条件において URL パスも含めてグループ 1 としてキャプチャするように正規表現を構成しているため、この正規表現でスキーム以降の URL パスが維持されます。<br>ほかの要件がある場合は If 条件の正規表現を修正し、{http_resp_Location_n} を組み合わせて応答 URL を構成することができます。</td></tr></tbody></table><h4 id="事例-1-3-リダイレクト-ポートの書き換え"><a href="#事例-1-3-リダイレクト-ポートの書き換え" class="headerlink" title="事例 1-3 リダイレクト ポートの書き換え"></a>事例 1-3 リダイレクト ポートの書き換え</h4><h5 id="代表的なシナリオ-2"><a href="#代表的なシナリオ-2" class="headerlink" title="代表的なシナリオ"></a>代表的なシナリオ</h5><p>バックエンド サーバーが HTTPS (デフォルト ポートの 443) で動作しており、Application Gateway がカスタム ポート (例として 8443) でリクエストをリッスンしている構成を考えます。<br>バックエンド サーバーは、Location ヘッダーの URL を HTTPS のデフォルト ポート (443) <code>https://www.contoso.com</code> で生成します。<br>Location ヘッダーを受け取ったクライアントは、HTTPS:443 で Application Gateway にアクセスします。しかしながら、Application Gateway がリッスンしているポートはカスタム ポートのため、リダイレクト先にアクセスできないという結果となります。  </p><h5 id="構成例-2"><a href="#構成例-2" class="headerlink" title="構成例"></a>構成例</h5><p>以下のような書き換え規則を作成します。</p><h6 id="If-1"><a href="#If-1" class="headerlink" title="If"></a>If</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>HTTP ヘッダー</td><td>-</td></tr><tr><td>ヘッダーの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>https:\/\/<a href="http://www.contoso.com(.*)/">www.contoso.com(.*)</a></td><td><code>https://www.contoso.com</code> で始まる任意の URL パスを正規表現でキャプチャしています。<br>バックエンド サーバーが生成する URL に応じて任意の正規表現が構成可能です。<br><code>\</code>は環境によっては円マークが表示されますがバックスラッシュです。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果-1"><a href="#結果-1" class="headerlink" title="結果"></a>結果</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>応答ヘッダー</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>ヘッダー名</td><td>共通ヘッダー</td><td>-</td></tr><tr><td>共通ヘッダー</td><td>Location</td><td>-</td></tr><tr><td>ヘッダー値</td><td><a href="https://www.contoso.com:8443{http_resp_Location_1}">https://www.contoso.com:8443{http_resp_Location_1}</a></td><td>書き換え後のヘッダー値は「<code>https://www.contoso.com:8443</code> で始まり、応答の Location ヘッダーを正規表現によりキャプチャした 1 番目のグループで構成される URL」を返却するように構成しています。<br>If 条件において URL パス部分をグループ 1 としてキャプチャするように正規表現を構成しているため、カスタム ポートを追加した状態のリダイレクト URL に書き換えることが可能です。<br>ほかの要件がある場合は If 条件の正規表現を修正し、{http_resp_Location_n} を組み合わせて応答 URL を構成することができます。</td></tr></tbody></table><h3 id="事例-2-ルーティング時に先頭パスを削除する"><a href="#事例-2-ルーティング時に先頭パスを削除する" class="headerlink" title="事例 2 - ルーティング時に先頭パスを削除する"></a>事例 2 - ルーティング時に先頭パスを削除する</h3><p>パスベース ルーティングを構成して複数のバックエンド サーバーに要求を振り分けているものの、複数のバックエンド サーバーが同一のパス階層を持つシナリオです。<br>具体例として以下のようなシナリオを考えます。  </p><ul><li>多言語対応のために、言語ごとにバックエンド サーバーを用意する</li><li>クライアントの要求 URL の先頭パスに応じて振り分けるバックエンド サーバーを制御する</li><li>クライアントの要求 URL の先頭パスが <code>/ja-jp/</code> のときは日本語コンテンツを提供するバックエンド サーバーに、<code>/en-us/</code> のときは英語コンテンツを提供するバックエンド サーバーに振り分けるようにパス ベース ルーティングを構成</li><li>ただし、バックエンド サーバーでは言語設定を制御する <code>/ja-jp/</code> や <code>/en-us/</code> のパス配下では動作しておらず、すべてのバックエンド サーバーが同一のパス階層を持っている</li></ul><h4 id="書き換え規則が必要な理由"><a href="#書き換え規則が必要な理由" class="headerlink" title="書き換え規則が必要な理由"></a>書き換え規則が必要な理由</h4><p>既定の Application Gateway の設定では、Application Gateway はクライアントから受け取った要求 URL パスをそのままバックエンド サーバーにルーティングします。<br>パスベース ルーティングを使用して要求 URL の先頭パスに応じてバックエンド サーバーを振り分ける場合には、先頭パスも含めてバックエンド サーバーにルーティングされます。(<em><a href="https://www.contoso.com/ja-jp/contents/example.html">https://www.contoso.com/ja-jp/contents/example.html</a></em> への要求は <em>https://&lt;バックエンド サーバーのホスト名&gt;/ja-jp/contents/example.html</em> にルーティングされます。)<br>一方で、このシナリオの場合、バックエンド サーバーは <code>/ja-jp/</code> 配下でコンテンツを提供しておらず <code>/contents/</code> 配下でコンテンツを提供しているため、パスの不一致によりリクエストしたコンテンツが存在しない (404 エラー) という結果になります。<br>このため、Application Gateway の書き換え規則を用いて <code>/ja-jp/</code> や <code>/en-us/</code> のパスを削除します。</p><h4 id="構成例-3"><a href="#構成例-3" class="headerlink" title="構成例"></a>構成例</h4><p>以下のような書き換え規則を作成し、パスベースの規則に関連付けます。</p><h6 id="If-バックエンド-URL-から-ja-jp-を削除"><a href="#If-バックエンド-URL-から-ja-jp-を削除" class="headerlink" title="If (バックエンド URL から /ja-jp/ を削除)"></a>If (バックエンド URL から /ja-jp/ を削除)</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>サーバー変数</td><td>-</td></tr><tr><td>サーバー変数</td><td>request_uri</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>(.*)\/ja-jp(.*)</td><td>シナリオ例では先頭パスが <code>/ja-jp/</code> ですが、<code>/ja-jp/</code> の前に <code>(.*)</code> を追加することでパスの途中に <code>/ja-jp/</code> が存在するパターンにも対応させています。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果-バックエンド-URL-から-ja-jp-を削除"><a href="#結果-バックエンド-URL-から-ja-jp-を削除" class="headerlink" title="結果 (バックエンド URL から /ja-jp/ を削除)"></a>結果 (バックエンド URL から /ja-jp/ を削除)</h6><table><thead><tr><th>設定値</th><th>値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>URL</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>コンポーネント</td><td>URL パス</td><td>-</td></tr><tr><td>URL パスの値</td><td>{var_request_uri_1}{var_request_uri_2}</td><td>If 条件の正規表現でキャプチャしたサーバー変数 request_uri のグループ 1 およびグループ 2 を抽出することでパス <code>/ja-jp/</code> の削除を実現しています。<br><code>/ja-jp/</code> が先頭パスの場合はグループ 1 は空の文字列となります。</td></tr><tr><td>パス マップの再評価</td><td>チェックしない</td><td>バックエンド プールの選択は Application Gateway に着信した URL パス (/ja-jp/ を含むもの) に基づいて行われるため再評価は不要です。</td></tr></tbody></table><h6 id="If-バックエンド-URL-から-en-us-を削除"><a href="#If-バックエンド-URL-から-en-us-を削除" class="headerlink" title="If (バックエンド URL から /en-us/ を削除)"></a>If (バックエンド URL から /en-us/ を削除)</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>サーバー変数</td><td>-</td></tr><tr><td>サーバー変数</td><td>request_uri</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン</td><td>(.*)\/en-us(.*)</td><td>シナリオ例では先頭パスが <code>/en-us/</code> ですが、<code>/en-us/</code> の前に <code>(.*)</code> を追加することでパスの途中に <code>/en-us/</code> が存在するパターンにも対応させています。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="結果-バックエンド-URL-から-en-us-を削除"><a href="#結果-バックエンド-URL-から-en-us-を削除" class="headerlink" title="結果 (バックエンド URL から /en-us/ を削除)"></a>結果 (バックエンド URL から /en-us/ を削除)</h6><table><thead><tr><th>設定値</th><th>値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>URL</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>コンポーネント</td><td>URL パス</td><td>-</td></tr><tr><td>URL パスの値</td><td>{var_request_uri_1}{var_request_uri_2}</td><td>If 条件の正規表現でキャプチャしたサーバー変数 request_uri のグループ 1 およびグループ 2 を抽出することでパス <code>/en-us/</code> の削除を実現しています。<br><code>/en-us/</code> が先頭パスの場合はグループ 1 は空の文字列となります。</td></tr><tr><td>パス マップの再評価</td><td>チェックしない</td><td>バックエンド プールの選択は Application Gateway に着信した URL パス (/en-us/ を含むもの) に基づいて行われるため再評価は不要です。</td></tr></tbody></table><h3 id="事例-3-X-Forwarded-For-ヘッダーの値をもとにルーティングを行う"><a href="#事例-3-X-Forwarded-For-ヘッダーの値をもとにルーティングを行う" class="headerlink" title="事例 3 - X-Forwarded-For ヘッダーの値をもとにルーティングを行う"></a>事例 3 - X-Forwarded-For ヘッダーの値をもとにルーティングを行う</h3><p>少し複雑なシナリオですが、パスベース ルーティングと書き換え規則を組み合わせることで、X-Forwarded-For ヘッダーに含まれるクライアント IP アドレスをもとに特定のバックエンド サーバーにルーティングすることが可能です。<br>具体例として以下のようなシナリオを考えます。  </p><ul><li>特定のクライアントからのアクセスは特定のバックエンド サーバーにルーティングしたい</li><li>ただし、クライアントはプロキシ経由で Application Gateway にアクセスしており、Application Gateway が認識するクライアント IP アドレスはプロキシの IP アドレスとなる</li><li>このため、X-Forwarded-For ヘッダーに含まれる元のクライアント IP アドレスをもとにルーティングしたい</li></ul><p><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#parameter-based-path-selection">こちらのシナリオ</a>のパラメーターとして、クエリ文字列の代わりに X-Forwarded-For ヘッダーを使用しているとお考えください。</p><h4 id="構成例-4"><a href="#構成例-4" class="headerlink" title="構成例"></a>構成例</h4><p>以下のようなパスベース ルーティングおよび書き換え規則を作成します。</p><h6 id="パスベース-ルーティング"><a href="#パスベース-ルーティング" class="headerlink" title="パスベース ルーティング"></a>パスベース ルーティング</h6><p>2 種類のバックエンド プールを用意し、既定のルーティング先をバックエンド プール#1、パスベース ルーティングに合致した場合のルーティング先をバックエンド プール#2 とします。</p><ul><li>パックエンド プール#1<br>バックエンド サーバー： VM#1</li><li>パックエンド プール#2<br>バックエンド サーバー： VM#2</li><li>要求ルーティング規則<br>種類：パスベース<br>既定のバックエンド プール： パックエンド プール#1<br>パスベースの規則： /path2 -&gt; パックエンド プール#2  </li></ul><h6 id="書き換え規則-If"><a href="#書き換え規則-If" class="headerlink" title="書き換え規則 (If)"></a>書き換え規則 (If)</h6><table><thead><tr><th>設定値</th><th>値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>説明</th></tr></thead><tbody><tr><td>チェックする変数の型</td><td>サーバー変数</td><td>-</td></tr><tr><td>サーバー変数</td><td>add_x_forwarded_for_proxy</td><td>-</td></tr><tr><td>大文字と小文字を区別する</td><td>いいえ</td><td>-</td></tr><tr><td>演算子</td><td>等しい (=)</td><td>-</td></tr><tr><td>一致させるパターン (例 1)</td><td>192\.0\.2\.1(.*)</td><td>add_x_forwarded_for_proxy サーバー変数の先頭に、元の IP アドレスが含まれる (つまり、「IP1, IP2, IP3・・・」のカンマ区切りのうち IP1 がマッチ対象) 場合の正規表現例です。複数の IP アドレスをマッチ対象としたい場合は、IP アドレスごとに書き換え規則を作成します。<br>※192.0.2.1 は例示用の IP アドレスです。実際には元のクライアント IP アドレスを入力します。</td></tr><tr><td>一致させるパターン  (例 2)</td><td>192\.0\.2\.(2[0-4]\d|25[0-5]|[01]?\d\d?)(.*)</td><td>マッチ対象の IP アドレスがプレフィックス単位で特定可能な場合は、プレフィックスに含まれる全 IP アドレスにマッチさせるように正規表現を構成することも可能です。<br>これは 192.0.2.0/24 のアドレス プレフィックス (第 4 オクテットが 0 -255 の IP アドレス) にマッチさせる場合の正規表現例です。</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h6 id="書き換え規則-結果"><a href="#書き換え規則-結果" class="headerlink" title="書き換え規則 (結果)"></a>書き換え規則 (結果)</h6><table><thead><tr><th>設定値</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>書き換えの種類</td><td>URL</td><td>-</td></tr><tr><td>アクション タイプ</td><td>設定</td><td>-</td></tr><tr><td>コンポーネント</td><td>URL パス</td><td>-</td></tr><tr><td>URL パスの値</td><td>/path2</td><td>パスベース ルーティングに一致させたいパスを入力します。</td></tr><tr><td>パス マップの再評価</td><td>チェックする</td><td>URL を書き換えた後のパスを再評価することで、/path2 に合致するパスベース ルーティングが機能しパックエンド プール#2 にルーティングされます。</td></tr></tbody></table><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>サポート担当にお寄せいただいたお問い合わせをもとに Application Gateway v2 の書き換え規則の事例をご紹介しました。<br>Application Gateway の書き換え規則は様々なパラメーターの書き換えをサポートしていることに加えて、ほかの機能と組み合わせることで対応可能となるシナリオもございます。<br>本稿が、お客様が Application Gateway を活用する際の参考となれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Networking サポート チームの三島です。&lt;br&gt;Application Gateway v2 では HTTP ヘッダーなどのパラメーターを書き換える機能を提供しています。&lt;br&gt;この記事は、Application Gateway 書き換え規</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway WAF V2 CRS 3.2 以降で追加された要求本文の検査について</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-waf-body-file-size/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-waf-body-file-size/</id>
    <published>2024-05-14T12:08:00.000Z</published>
    <updated>2024-11-26T07:55:52.869Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの大塚です。</p><p>この記事では、先日新たに追加された Application Gateway WAF ポリシーのマネージド ルールにおいて CRS （コア ルール セット）3.2 以上を利用している際に要求本文(＝Request Body)のサイズ、ファイル アップロードのサイズ、および要求本文の検査をより細かく制御できる機能についてご紹介します。</p><span id="more"></span><hr><h3 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h3><p>この記事は、以下の 3 つのシナリオにすべてあてはまるお客様向けの内容となります。</p><ul><li> Application Gateway WAF V2 の SKU を利用している</li><li> WAF ポリシーを利用している</li><li> WAF ポリシーのマネージド ルールで指定している CRS バージョンが 3.2 以上である</li></ul><p>WAF によってチェックされる要求サイズへの制限につきましては<a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits">こちら</a>のドキュメントに記載がございますが、本ブログでは今回追加された新機能のみに焦点をおき、ご紹介いたします。</p><h3 id="新しく追加された機能"><a href="#新しく追加された機能" class="headerlink" title="新しく追加された機能"></a>新しく追加された機能</h3><p>今回追加された機能を含め、現在 CRS 3.2 以上の WAFで利用できる機能は以下となります。</p><ul><li> ① 要求の本文に含まれる内容において、先頭から何 KB の範囲を WAF で評価させるかの検査の上限を指定することができる</li><li> ② 要求の本文の検査するサイズの上限の指定とは独立して、要求本文の内容を検査する/しないを指定できる</li><li> ③ 要求の本文に含まれる内容の検査とは独立して、要求本文のサイズの検査を無効にできる</li><li> ④ 要求の本文の検査とは独立して、ファイル アップロードのサイズの検査を無効にできる</li><li> ⑤ 要求本文のサイズの上限を指定できる <code>※ 8 KB から 2000 KB（2MB） の範囲</code></li><li> ⑥ ファイル アップロードのサイズの上限を指定できる <code>※ 1 MB から 4000 MB（4GB） の範囲</code></li></ul><p>実際のポータルの設定画面と上記項番の該当箇所は以下のようになります。<br><img src="/blog/network/appgw-waf-body-file-size/15.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>大きく追加された機能としては ① です。</p><p>②から④ は CRS 3.1 以下でも利用できましたが、それぞれの設定が独立して指定できるようになりました。</p><p>⑤から⑥ はこれまでと変わらず WAF 利用時のサイズの上限を指定する項目となります。  </p></div><p><span id="wafv2limit"></span></p><h3 id="上限値の整理"><a href="#上限値の整理" class="headerlink" title="上限値の整理"></a><a href="#wafv2limit">上限値の整理</a></h3><p>Application Gateway V2 の要求本文サイズやファイル アップロードサイズの「上限値」について整理しましょう。<br>（※単位の違いにもご留意ください）</p><table><thead><tr><th></th><th>要求本文のサイズ上限</th><th>ファイル アップロードのサイズ上限</th></tr></thead><tbody><tr><td>Application Gateway V2 自体の上限値 （要求本文/ファイルアップロードの上限適用を無効にした場合はこの上限になります）</td><td>4 GB</td><td>4 GB</td></tr><tr><td>Application Gateway WAF V2/CRS 3.2 以降の上限値</td><td>2 MB</td><td>4 GB</td></tr><tr><td>Application Gateway WAF V2/CRS 3.1 以前の上限値</td><td>128 KB</td><td>750 MB</td></tr></tbody></table><p><span id="labtest"></span></p><h3 id="実際の動作の確認"><a href="#実際の動作の確認" class="headerlink" title="実際の動作の確認"></a><a href="labtest">実際の動作の確認</a></h3><p>それでは新しく追加された ① の機能について動作を詳しく確認してみましょう。</p><p>この検証では、クライアントが送信するリクエストの要求本文の先頭から 10 KB 目に WAF で検知される文字列を含ませて送信してみることにします。設定内容によって実際に WAF がどのように動作するかを検証してみました。</p><h3 id="「要求本文検査の上限-KB-」が-128-既定値-の場合"><a href="#「要求本文検査の上限-KB-」が-128-既定値-の場合" class="headerlink" title="「要求本文検査の上限 (KB)」が 128 (既定値)の場合"></a>「要求本文検査の上限 (KB)」が 128 (既定値)の場合</h3><p><img src="/blog/network/appgw-waf-body-file-size/02.png"></p><p>検査する要求本文の範囲は先頭から 128 KB までを指定しています。<br>要求本文の先頭から 10 KB 目に WAF で検知される文字列が含まれているリクエストを送信しているので、この場合は該当文字列はWAF での評価がされます。アクセス ログより HTTP ステータス コード 403 が返され、ブロックされることが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/03.png"></p><h3 id="「要求本文検査の上限-KB-」が-8-の場合"><a href="#「要求本文検査の上限-KB-」が-8-の場合" class="headerlink" title="「要求本文検査の上限 (KB)」が 8 の場合"></a>「要求本文検査の上限 (KB)」が 8 の場合</h3><p><img src="/blog/network/appgw-waf-body-file-size/04.png"></p><p>検査する要求本文の範囲は先頭から 8 KB までを指定しています。<br>要求本文の先頭から 10 KB 目に WAF で検知される文字列が含まれているリクエストを送信しているので、この場合は該当文字列は WAF での評価はされません。アクセス ログより HTTP ステータス コード 200 が返されたことが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/05.png"></p><h3 id="「要求本文検査の上限-KB-」を「要求本文最大サイズ-KB-」よりも大きくした場合"><a href="#「要求本文検査の上限-KB-」を「要求本文最大サイズ-KB-」よりも大きくした場合" class="headerlink" title="「要求本文検査の上限 (KB)」を「要求本文最大サイズ (KB)」よりも大きくした場合"></a>「要求本文検査の上限 (KB)」を「要求本文最大サイズ (KB)」よりも大きくした場合</h3><p><img src="/blog/network/appgw-waf-body-file-size/09.png"></p><p>検査する要求本文の範囲は先頭から 15 KB までを指定していますが、要求本文のサイズ上限を 8 KB に指定しています。<br>この場合「要求本文最大サイズ」の上限値まで要求本文の内容が検査されます。さらにサイズの上限に合致している場合は WAF でブロックされます。アクセス ログより HTTP ステータス コード 403 が返され、ブロックされたことが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/11.png"></p><p>WAF 側のログでは要求本文の長さ (サイズ)が上限を超過したためブロックしたことを示すログが記録されていました。</p><p><img src="/blog/network/appgw-waf-body-file-size/10.png"></p><h3 id="「要求本文の検査を適用する」を無効にする"><a href="#「要求本文の検査を適用する」を無効にする" class="headerlink" title="「要求本文の検査を適用する」を無効にする"></a>「要求本文の検査を適用する」を無効にする</h3><p><img src="/blog/network/appgw-waf-body-file-size/06.png"></p><p>要求本文の検査を無効に指定しているので、要求本文に含まれる内容に対して WAF の評価はされません。アクセス ログより HTTP ステータス コード 200 が返されたことが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/07.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>要求本文の検査を無効（②の項番）にしている状態でも、要求本文の最大サイズ指定（⑤の項番）を有効としている場合はその設定は有効です。つまり以下のように設定している場合、要求本文の内容は WAF で評価されませんが、要求本文のサイズが 8 KB より大きい場合は WAF で評価されブロックされます。</p><p><img src="/blog/network/appgw-waf-body-file-size/08.png"></p></div><h3 id="Application-Gateway-V2-側の制限値によってブロックされた場合の動作"><a href="#Application-Gateway-V2-側の制限値によってブロックされた場合の動作" class="headerlink" title="Application Gateway V2 側の制限値によってブロックされた場合の動作"></a>Application Gateway V2 側の制限値によってブロックされた場合の動作</h3><p>番外編として、Application Gateway V2 自体のサイズ上限値に合致した場合はどのような動作となるかも確認しました。<br>設定値はすべて無効に指定します。</p><blockquote><p><img src="/blog/network/appgw-waf-body-file-size/13.png"></p></blockquote><p>要求本文のサイズを Application Gateway V2 の上限である 4 GB よりも大きくしてリクエストを送信したところ、アクセス ログより HTTP ステータス コード 413 が返されることが確認できました。この時 WAF 側のログには何も記録はありません。また、ファイル アップロードサイズでも同じ動作が確認できました。</p><blockquote><p><img src="/blog/network/appgw-waf-body-file-size/14.png"></p></blockquote><p>Application Gateway V2 の上限に合致した場合は HTTP ステータス コード 403 ではなく 413 となることが確認できました。<br>本ブログ記事の内容が皆様のお役に少しでも立てましたら幸いです。</p><p><span id="reference"></span></p><h3 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference">参考情報</a></h3><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits">Web Application Firewall の要求とファイル アップロードのサイズ制限</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits">Application Gateway の制限</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの大塚です。&lt;/p&gt;
&lt;p&gt;この記事では、先日新たに追加された Application Gateway WAF ポリシーのマネージド ルールにおいて CRS （コア ルール セット）3.2 以上を利用している際に要求本文(＝Request Body)のサイズ、ファイル アップロードのサイズ、および要求本文の検査をより細かく制御できる機能についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>可用性セットや可用性ゾーン上の単一 VM インスタンスの可用性について</title>
    <link href="https://jpaztech.github.io/blog/vm/sla-singlevm-availability/"/>
    <id>https://jpaztech.github.io/blog/vm/sla-singlevm-availability/</id>
    <published>2024-05-02T03:00:00.000Z</published>
    <updated>2024-11-26T07:55:53.301Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームです。 </p><p>本ブログ記事では、可用性セットや可用性ゾーン上に単一の VM インスタンスのみを構成した場合の SLA についてご案内いたします。 </p><span id="more"></span><p>可用性セットや可用性ゾーンは、VM 群を稼働するハードウェアが単一障害点とならないように分散配置することで基盤障害の影響を一部の VM に限定するサービスとなります。</p><p>例えば、あるシステムにおいてゾーン 1 とゾーン 2 に 1 台ずつ VM を構成している場合、ゾーン 1 で基盤障害が発生した際にはゾーン 1 の VM は影響を受けますが、ゾーン 2 の VM は影響を受けずに稼働を継続するため、システム全体としての可用性を向上させることができます。<br>すなわち、一つ一つの VM インスタンスとしての可用性には変わりはなく、可用性セットや可用性ゾーンに複数の VM を冗長構成で構築いただくことで、初めて高可用性の恩恵を受けることが可能となります。<br>そのため、VM インスタンス 1 台のみを可用性セットや可用性ゾーンに構成することは可能ですが、可用性が向上している訳ではございませんので、SLA の考え方としては可用性セット・可用性ゾーン無しの状態と同じ単一インスタンスとしての計算となります。  </p><p>可用性セットや可用性ゾーンを構成した場合の SLA については、構成した全ての VM インスタンスが停止してしまった際にダウンタイムとして計算されるような形となります。<br>一つ以上のインスタンスが稼働を継続できている場合にはそれぞれのインスタンスとしての SLA のみが適用されますことご留意ください。</p><p>Azure VM の可用性セットおよび可用性ゾーンの詳細については、以下の公式ドキュメントをご確認いただけますと幸いでございます。</p><p>■ご参考：Azure Virtual Machines の可用性オプション<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/availability">https://learn.microsoft.com/ja-jp/azure/virtual-machines/availability</a>  </p><p>また、SLA については毎月最新の情報が公開されますため、詳細につきましては、以下のサイトにございます Word ファイルをダウンロードいただき、ご確認いただきますと幸いです。<br>最新バージョンはサイト上部の [Download] からご確認いただけますので、”仮想マシン” セクションをご覧ください。  </p><p>■ご参考： Service Level Agreements (SLA) for Online Services<br><a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=18">https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=18</a>  </p><p><img src="/blog/vm/sla-singlevm-availability/img001.png"></p><p>簡単ではございますが、上記の内容がお客様のお役に立ちますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームです。 &lt;/p&gt;
&lt;p&gt;本ブログ記事では、可用性セットや可用性ゾーン上に単一の VM インスタンスのみを構成した場合の SLA についてご案内いたします。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway WAF  の誤検知対応</title>
    <link href="https://jpaztech.github.io/blog/network/handle-waf-false-positive/"/>
    <id>https://jpaztech.github.io/blog/network/handle-waf-false-positive/</id>
    <published>2024-05-02T03:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.901Z</updated>
    
    <content type="html"><![CDATA[<p>いつもお世話になっております。Azure Networking チームの庄です。</p><p>Web アプリケーションは、SQL インジェクションやクロスサイトスクリプティングなど、既知の脆弱性を悪用した攻撃のターゲットになることが多いです。Application Gateway および Azure Front Door を使用しているお客様の Web アプリケーションをそのような攻撃から保護するためには、Azure は Web アプリケーションファイアウォール（WAF）サービスを提供しています。</p><p>Application Gateway で WAF を使用する際に、本来許可されるべき通信がブロックされる事例がしばしば発生します。このような事象が発生した場合に、お客様自身がどのように初期対応を行うことができるかについて、こちらのブログではその詳細な対応方法を説明いたします。</p><p>WAF で誤検知 (False Positive) が発生した理由は、WAF の不具合ではなく、ルールに基づく正確な検査の結果、お客様のアプリケーションにとって望ましくなく、ルール違反と判断された通信が検出されたためです。たとえば、Request Body や Header 内に攻撃と判断される文字列が存在すると、WAF によって通信がブロックされます。この結果がお客様のアプリケーションにとって望ましくない場合、その通信が WAF より誤検知されています。この記事では、WAF での誤検知が発生する際に、誤検知を回避するための対処方法につきまして紹介いたします。</p><h2 id="WAF-側の設定"><a href="#WAF-側の設定" class="headerlink" title="WAF 側の設定"></a>WAF 側の設定<br /></h2><p>Azure WAF の設定を使って誤検知を避ける方法には、主に3つの方法があります。</p><h3 id="設定方法１：除外を利用する"><a href="#設定方法１：除外を利用する" class="headerlink" title="設定方法１：除外を利用する"></a>設定方法１：除外を利用する</h3><p>除外は、特定の Header や Request Body 内で誤検知が起こった部分を指定し、これらを誤検知として検出されたルールの評価から外す方法です。この方法は、本記事で紹介した 3 つの中で最も柔軟性が高いと考えられます。除外の設定は、WAF ポリシーの「管理されているルール」のページで見つけることができます。ただし、除外の設定が利用できない場合もあるので、その場合は他の設定方法の利用をご検討いただく必要があります。その具体的な設定方法については本記事他の箇所をご確認ください。</p><img src="./exclusion.png" alt="除外を利用する" style="width:600px;"/> <h3 id="設定方法２：カスタム-ルールを利用する"><a href="#設定方法２：カスタム-ルールを利用する" class="headerlink" title="設定方法２：カスタム ルールを利用する"></a>設定方法２：カスタム ルールを利用する</h3><p>カスタム ルールを使用することで、特定の IP アドレスからの通信や特定のパスへのアクセスを WAF の評価から除外し、通信を管理されたルールから ”Bypass” するルールを作成できます。カスタム ルールは管理されたルールよりも優先され、ここで設定したルールによって通信が許可または拒否されます。カスタム ルールの設定は、WAF ポリシーの「カスタム ルール」ページで行うことができます。</p><img src="./customruleportal.png" alt="カスタム ルールを利用する" style="width:600px;"/> <h3 id="設定方法３：特定のルールの無効化"><a href="#設定方法３：特定のルールの無効化" class="headerlink" title="設定方法３：特定のルールの無効化"></a>設定方法３：特定のルールの無効化</h3><p>WAF で特定のルールによる誤検知が発生した場合、そのルールを無効にすることも誤検知への対処法の一つです。ルールの無効化は、WAF ポリシーの「管理されているルール」ページで行うことができます。</p><img src="./disabledrules.png" alt="特定のルールの無効化" style="width:700px;"/> <div class="alert is-info"><p class="alert-title">Note</p><p>これらの方法以外にも、WAF の要求本文の検査を無効にすることが考えられますが、これを行うと WAF が Request Body の検査を行わなくなり、セキュリティ リスクが高まる可能性があります。この無効化を検討する場合は、サーバー側でのセキュリティ対策の実施をお勧めします。</p></div><h2 id="アプリケーション側の対応"><a href="#アプリケーション側の対応" class="headerlink" title="アプリケーション側の対応"></a>アプリケーション側の対応</h2><p>WAF 側の設定だけでは要件を満たさない場合、アプリケーション側での対策が解決策の一つになります。例えば、ユーザー情報をフォームで収集するアプリケーションを開発する際に、フォーム入力で「#」や「%」のような、攻撃に利用される可能性のある文字の使用を制限する設定を追加することで、ユーザーがこれらの文字を含むリクエストを送信することによる誤検知を防ぐことができます。具体的にどのような文字列が管理されたルールに一致するかについては、お客様ご自身で OWASP コミュニティのサイトや Core Rule Set の GitHub ページなどで確認する必要があります。</p><p><a href="https://owasp.org/www-project-modsecurity-core-rule-set/">OWASP ModSecurity Core Rule Set</a></p><p><a href="https://github.com/coreruleset/coreruleset">Core Rule Set の GitHub</a></p><h1 id="ログ"><a href="#ログ" class="headerlink" title="ログ"></a>ログ</h1><p>誤検知が発生した場合、その原因を理解することが最初のステップです。具体的には、どのルールによって誤検知が起きているのか、そしてその誤検知の原因が何なのかを WAF のログから把握する必要があります。この情報がなければ、誤検知を避けるための適切な対策を講じることができません。WAF のログは、WAF に関連付けられた Application Gateway のログで以下のクエリを実行することで確認できます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where ResourceProvider == &quot;MICROSOFT.NETWORK&quot; and Category == &quot;ApplicationGatewayFirewallLog&quot;</span><br></pre></td></tr></table></figure><p>このクエリを実行すると、次のような形式のログが出力されます。誤検知を避けるためには、WAF の設定で特定のログフィールドに注意を払う必要があります。該当するフィールドは下の図の赤い枠で示されています。詳しいについては、「WAF ログのフィールド」セクションをご覧ください。</p><img src="./examplelog.png" alt="ログ" style="width:900px;"/><p>上記のクエリ以外にも、以下のドキュメントには様々な WAF ログのクエリ例が記載されています。ご参考いただければと存じます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/log-analytics">Log Analytics を使用して Application Gateway Web アプリケーション ファイアウォール (WAF) のログを調べる</a></p><h2 id="WAF-ログのフィールド"><a href="#WAF-ログのフィールド" class="headerlink" title="WAF ログのフィールド"></a>WAF ログのフィールド</h2><p>誤検知に対応するためには、以下の WAF ログのフィールドを理解する必要があります。</p><h3 id="フィールド１：ruleSetType-amp-ruleSetVersion"><a href="#フィールド１：ruleSetType-amp-ruleSetVersion" class="headerlink" title="フィールド１：ruleSetType &amp; ruleSetVersion"></a>フィールド１：ruleSetType &amp; ruleSetVersion</h3><p>ruleSetType と ruleSetVersion は、特定の通信がどのルールセット内のどのルールに一致しているを表示します。特に WAF ポリシーに複数のバージョンのルールセットが設定されている場合、正しいバージョンのルールセットに対して除外を作成する必要があるので、こちらのフィールドの参照が必要です。</p><h3 id="フィールド２：ruleId"><a href="#フィールド２：ruleId" class="headerlink" title="フィールド２：ruleId"></a>フィールド２：ruleId</h3><p>ruleId は、特定の通信がどのルールに一致しているかを示します。OWASP 3.2 以上の WAF ポリシーを利用する際には、こちらのフィールドの参照して、除外を作成するときに正しいルールを選択する必要があります。</p><h3 id="フィールド３：-details-data"><a href="#フィールド３：-details-data" class="headerlink" title="フィールド３： details_data"></a>フィールド３： details_data</h3><p>ルールにマッチした原因は、WAF ログの details_data で確認できます。通常、以下の形式でマッチした内容を確認できます。</p><img src="./details.png" alt="details_data" style="width:700px;"/><h4 id="上図-①-の部分について"><a href="#上図-①-の部分について" class="headerlink" title="上図 ① の部分について"></a>上図 ① の部分について</h4><p>① は、通常、マッチした文字列です。例えば、Request Body に「#」が含まれているためにルールによって検出された場合、①には「#」が表示されます。</p><h4 id="上図-②-の部分について"><a href="#上図-②-の部分について" class="headerlink" title="上図 ② の部分について"></a>上図 ② の部分について</h4><p>② は、通常、Request Body のどの部分にマッチする文字列が含まれているかを示します。例えば、ある Header 名に「#」が含まれている場合、② には「HeaderName」が表示されます。② に表示されるものはマッチしたルールの種類（OWASP や Bot Manager Rule など）によって異なることがあります。</p><h4 id="上図-③-の部分について"><a href="#上図-③-の部分について" class="headerlink" title="上図 ③ の部分について"></a>上図 ③ の部分について</h4><p> ③ は、② の内容と関連しています。② が要求本文フィールドの名前「xxxName」を示している場合、③ではその具体的な要求本文フィールド名が表示されます。例えば、 Header 名に不正な文字「#」が含まれてWAFによって検出された場合、③ にはその Header 名を表示します。また、「XXX : YYYY」という形式で表示される場合もあります。これは、要求本文フィールド値に不正な文字列が検出された場合のログ表示形式です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>details_data に「Inbound Anomaly Score Exceeded」（受信異常スコア超過）というメッセージが記載されている場合、実際の検出原因は同じ Transaction ID を持つ他のログで確認できます。詳細については、下記の異常スコアのドキュメントを参照していただければ幸いです</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-crs-rulegroups-rules?tabs=drs21#anomaly-scoring">Web Application Firewall の DRS および CRS の規則グループと規則 ｜異常スコアリング</a></p></div><h3 id="フィールド-４：action"><a href="#フィールド-４：action" class="headerlink" title="フィールド ４：action"></a>フィールド ４：action</h3><p> WAF の Action は、検出された通信に対して実施された操作を示します。ログのアクションフィールドには、「Matched」と「Blocked」の二つの値がありますが、表示される値は WAF ポリシーのモードによって異なります。</p><h4 id="ポリシー-モード-検出"><a href="#ポリシー-モード-検出" class="headerlink" title="ポリシー モード : 検出"></a>ポリシー モード : 検出</h4><p>検出モードでは WAF は Allow や Block といったアクションを実行しませんので Detected のみが記録されます。</p><h4 id="ポリシー-モード-防止"><a href="#ポリシー-モード-防止" class="headerlink" title="ポリシー モード : 防止"></a>ポリシー モード : 防止</h4><p>Allowed : 通信がカスタムルールなどにより、WAF から許可された場合に表示されます。<br>Blocked : 特定のルールに一致する要求が検出され、危険と判断されたため、通信は WAF  によってブロックされます。<br>Matched : 一部の条件に一致する要求がある場合、WAF はさらに評価を行い、最終的な異常スコアリングルールに基づいて、要求をブロックするかどうかを決定します。<br>Log : 防止モードで記録される Action です。カスタムルールの Action (結果の欄) に “トラフィックのみをログに記録する” を指定した場合に、WAF ログの Action フィールドには、Log という値が記録されます。</p><h1 id="除外"><a href="#除外" class="headerlink" title="除外"></a>除外</h1><p>除外を作成する際には、ログに検出された内容に基づいて除外を作成します。しかし、利用中の WAF ポリシーのバージョンにより、設定できる除外のパラメーターが異なります。</p><table><thead><tr><th>除外</th><th>CRS 3.1 以前</th><th>CRS 3.2 以降</th></tr></thead><tbody><tr><td>キーと値による要求属性の除外</td><td>×</td><td>○</td></tr><tr><td>ルールごとの除外</td><td>×</td><td>○</td></tr><tr><td>要求属性の大小文字区別</td><td>区別しません</td><td>Header 以外は区別します</td></tr></tbody></table><h2 id="設定フィールド：適用対象"><a href="#設定フィールド：適用対象" class="headerlink" title="設定フィールド：適用対象"></a>設定フィールド：適用対象</h2><img src="./rule.png" alt="適用対象" style="width:700px;"/><p>OWASP 3.2 以降の WAF ポリシーの除外設定では、ログの ruleSetType &amp; ruleSetVersion フィールドに記載された内容に基づいて、適切なルールセット バージョンを選択する必要があります。例えば、誤検知が発生した際に ruleSetType &amp; ruleSetVersion が以下の値を表示している場合、適用対象として OWASP_3.2 を選択する必要があります。</p><table><thead><tr><th>ruleSetType</th><th>ruleSetVersion</th></tr></thead><tbody><tr><td>OWASP CRS</td><td>3.2</td></tr></tbody></table><p>OWASP 3.1 以前の WAF ポリシーの除外設定では、グローバル除外(すべての WAF ルールに適用するように除外)のみ設定可能です。</p><h2 id="設定フィールド：ルールの追加"><a href="#設定フィールド：ルールの追加" class="headerlink" title="設定フィールド：ルールの追加"></a>設定フィールド：ルールの追加</h2><p><img src="/blog/network/handle-waf-false-positive/selectrule.png"></p><p>OWASP 3.2 以降の WAF ポリシーを利用する際には、ログに記載された ruleId フィールドに基づき、除外を適用したい特定のルールを選択します。「ルールの追加」ボタンをクリックしてルール検索ページを開き、ログに表示された ruleId フィールドに記載されたルール ID を検索することで、除外を適用する対象となるルールを選び出せます。この操作により、特定のルールに対してのみ除外を適用でき、他のルールにマッチした場合は除外が適用されません。<br>OWASP 3.1 以前の WAF ポリシーの除外設定では、こちらのルールの追加ができません。</p><h2 id="一致変数"><a href="#一致変数" class="headerlink" title="一致変数"></a>一致変数</h2><p>OWASP 3.2 以降の WAF ポリシーでは、以下の一致変数が設定できます。</p><img src="./32arg.png" alt="一致変数1" style="width:200px;"/><p>OWASP 3.1 以前の WAF ポリシーでは、以下の一致変数が設定できます。</p><img src="./30arg.png" alt="一致変数2" style="width:200px;"/><p>一致変数の選択は、details_data 内の ② の値に基づいて行います。</p><img src="./requestarg.png" alt="一致変数3"  style="width:200px;"/><p>② の値と一致変数の対応例は以下の通りです。</p><table><thead><tr><th>②の値</th><th>一致変数の選択</th></tr></thead><tbody><tr><td>xxxKey</td><td>要求xxxキー</td></tr><tr><td>xxxName</td><td>要求xxx名</td></tr><tr><td>xxxValue</td><td>要求xxx値</td></tr><tr><td>Args</td><td>要求引数値</td></tr></tbody></table><h2 id="演算子"><a href="#演算子" class="headerlink" title="演算子"></a>演算子</h2><p>演算子の選択には「次の値で始まる」、「次で終わる」、「次の値に等しい」、「次の値を含む」、「いずれかと等しい」といったオプションがあります。その中で特に注意が必要なオプションとして、「いずれかと等しい」を利用する場合、セレクターに設定される値に関わらず、「*」がセレクター値として適用されます。詳細は以下のドキュメントに関連記事があります。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-configuration?tabs=portal#identify-request-attributes-to-exclude">Web アプリケーション ファイアウォールの除外リスト</a></p><h2 id="セレクター"><a href="#セレクター" class="headerlink" title="セレクター"></a>セレクター</h2><p>セレクターでは、基本的には、details_data 内の ① の値に基づいて行いますが、セレクターを設定できないものがあります。</p><h3 id="セレクターに使用できるのは文字、数字、句読点のみです"><a href="#セレクターに使用できるのは文字、数字、句読点のみです" class="headerlink" title="セレクターに使用できるのは文字、数字、句読点のみです"></a>セレクターに使用できるのは文字、数字、句読点のみです</h3><p>セレクターのフィールドでは、文字、数字、句読点以外の入力が許可されていません。そのため、details_data 内の ① の値に特殊文字が含まれている場合、セレクターにその文字を直接設定することはできません。例えば、「Hea#der」という名前の Header が WAF によって「#」の存在で検出された場合、① には「#」が表示されます。しかし、セレクター内では「#」の入力が許可されていないため、演算子として「次の値を含む」を選択し、セレクターには「Hea」や「der」といった値を選んで除外設定を行うことで、該当する Header を除外することが可能です。</p><h3 id="効果がない除外設定"><a href="#効果がない除外設定" class="headerlink" title="効果がない除外設定"></a>効果がない除外設定</h3><p>details_data で検出された要求 xxx 値に基づいて除外を設定する際、WAF は特定の文字列を含む値に対して除外を適用できないため、以下のような除外設定では効果がありません。</p><table><thead><tr><th>検知内容</th></tr></thead><tbody><tr><td>Matched Data: <strong>#12</strong> found within <strong>ARGS</strong> : <strong>page</strong>: <strong>#1234</strong></td></tr></tbody></table><table><thead><tr><th>効果がない除外の設定</th><th>効果がある除外の設定</th></tr></thead><tbody><tr><td>一致変数：要求引数値</td><td>一致変数：要求引数値</td></tr><tr><td>演算子： 次の値を含む</td><td>演算子： 次の値を含む</td></tr><tr><td>セレクター： 12 or 34</td><td>セレクター： page</td></tr></tbody></table><table><thead><tr><th>検知内容</th></tr></thead><tbody><tr><td>Matched Data: <strong>#</strong> found within <strong>CookieValue</strong> : <strong>co</strong>: <strong>#aaaa</strong></td></tr></tbody></table><table><thead><tr><th>効果がない除外の設定</th><th>効果がある除外の設定</th></tr></thead><tbody><tr><td>一致変数：要求引数値</td><td>一致変数：要求引数値</td></tr><tr><td>演算子： 次の値を含む</td><td>演算子： 次の値を含む</td></tr><tr><td>セレクター： a or aa</td><td>セレクター： co</td></tr></tbody></table><p>上記の効果がない除外の設定例と効果がある除外の設定例を比較すると、details_data に値で検出された場合、セレクターには検出された値をセレクターに入力すると、除外の効果がありません（例：Header 値がマッチした場合は、セレクターにその Header 値を入力）。</p><p>details_data に値で検出された場合、効果がある除外を作成するためには、検出された値を含んでいる要求本文フィールドの名前をセレクターに入力する必要があります（例：Header 値がマッチした場合は、セレクターにその Header 名を入力）。</p><p>上記の例以外にも、以下のドキュメントには様々な除外例が記載されています。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-configuration?tabs=portal">要求属性の例</a></p><p><img src="/blog/network/handle-waf-false-positive/exclusionexamples.png"></p><h2 id="カスタム-ルール"><a href="#カスタム-ルール" class="headerlink" title="カスタム ルール"></a>カスタム ルール</h2><p>カスタム ルールを使用することで、特定のクエリ ストリングが含まれる URI、特定の IP アドレスからのアクセス、または特定のパスへのアクセスを許可することが可能ですが、具体的なルール設定はお客さんに決める必要があります。これらのカスタム ルールは、管理されたルールよりも高い優先順位を持ちます。カスタム ルールによって通信が許可または拒否された場合は、管理されたルールと他の優先度が低いカスタム ルールに評価されないことが想定された動作です。カスタム ルールの設定は、WAF ポリシーの「カスタム ルール」ページで行うことができます。カスタム ルールで設定できるフィールドにつきましては、以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/custom-waf-rules-overview">Azure Application Gateway の Web アプリケーション ファイアウォール v2 カスタム規則</a></p><h2 id="特定のルールの無効化"><a href="#特定のルールの無効化" class="headerlink" title="特定のルールの無効化"></a>特定のルールの無効化</h2><p>WAF においては、個々のルールを無効化したり、ルールごとに特定のアクションを指定したりすることが可能です。ルールを無効化することで、WAF を介した通信がそのルールに基づいて評価されなくなります。ただし、管理されたルールの中には無効化ができないルールも存在する点にはご注意ください。<br><img src="/blog/network/handle-waf-false-positive/disabledrules.png"></p><h1 id="サポートからの支援"><a href="#サポートからの支援" class="headerlink" title="サポートからの支援"></a>サポートからの支援</h1><p>もしブログに記載されている方法でお客様の誤検知事象が解消されない場合は、サポート窓口にて調査を行うことができます。スムーズに状況を確認するために、WAF にアクセスし、通信がブロックされた際の HAR ファイルなどの基本的な切り分け情報を添付していただくことをお願いします。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace">HAR ファイルの取得手順</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;いつもお世話になっております。Azure Networking チームの庄です。&lt;/p&gt;
&lt;p&gt;Web アプリケーションは、SQL インジェクションやクロスサイトスクリプティングなど、既知の脆弱性を悪用した攻撃のターゲットになることが多いです。Application Gat</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>オンプレミスからのインターネット宛ての通信を Azure 経由にする方法</title>
    <link href="https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/"/>
    <id>https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/</id>
    <published>2024-04-30T06:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.889Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>本ブログでは、オンプレミスからのインターネット宛ての通信を Azure 経由にする方法について、ご紹介いたします。</p><span id="more"></span><hr><p>お客様のクラウド利用が進み、オンプレミスとクラウドを組み合わせたハイブリッド クラウド環境が普及してきました。ハイブリッド クラウド環境では、オンプレミスとクラウド間の通信の他に、インターネットへのアクセスをオンプレミス経由、またはクラウド経由にさせたいというご要望をいただくことがあります。</p><p>従来から、お客様のセキュリティポリシーの要件により、Azure からのインターネットへの通信をオンプレミスを経由させて、オンプレミスでセキュリティ対策を実施されることがありました。Azure では、Azure 環境からインターネットへの通信をオンプレミス経由させることを「強制トンネリング（Forced Tunneling）」と呼んでいます。</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/01.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/about-site-to-site-tunneling">サイト間構成用の強制トンネリングについて</a></p><p>昨今では、Azure の提供する Azure Firewall や、サードパーティー製のネットワーク仮想アプライアンス（NVA - Network Virtual Appliance）として、多くのセキュリティサービスが提供されています。<br>オンプレミスに設置されていた物理的なセキュリティベンダーの製品が、Azure 上の NVA としても提供されるようになり、従来実施していた同様のセキュリティ対策を Azure 上で実施することも可能になってきました。<br>また、NVA は物理的なデバイスと比べ、スケールアウトを迅速に行いやすいなど、クラウド環境特有のメリットもあります。</p><p>このような背景から、オンプレミスからインターネット接続を Azure を経由させたいというご要望をいただくことが多くなりましたので、本ブログでは概要をご説明します。</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/02.png"></p><p>まず、オンプレミスから Azure を経由させてインターネットに接続させるには、Azure からオンプレミスのルーターに対してデフォルトルート（0.0.0.0/0）（Azure では「既定のルート」と呼ばれることがあります）をルーティング プロトコルの BGP で広報する必要があります。<br>デフォルトルートを Azure から広報するには、以下の 2 種類の方法が考えられます。</p><p>１）Virtual WAN を利用する<br>２）Azure Route Server と NVA（Network Virtual Appliance - 仮想アプライアンス）を利用する</p><h2 id="1）Virtual-WAN-を利用する"><a href="#1）Virtual-WAN-を利用する" class="headerlink" title="1）Virtual WAN を利用する"></a>1）Virtual WAN を利用する</h2><p>比較的大規模な環境で利用される Virtual WAN では、ハブ アンド スポーク アーキテクチャで、仮想ハブ内に Azure Firewall や、サードパーティ製のセキュリティ用 NVA、または SD-WAN 用 NVA などをデプロイすることができます。<br>Azure Firewall や、これらの NVA からデフォルトルートを広報することにより、ExpressRoute 回線（ER）や Site to Site VPN（S2S VPN）で接続されたオンプレミスからの通信を、Azure を経由してインターネットにアクセスさせることが可能になります。</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/03.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-wan/virtual-wan-about">Azure Virtual WAN とは</a></p><p>Azure Firewall をすでに Virtual WAN の仮想ハブにデプロイしている場合、インターネット向けの通信を Azure Firewall に向けるためのルーティング ポリシーを設定します。<br>次に、S2S VPN 接続の場合には VPN サイトで「既定のルートを伝達」を有効化させることにより、デフォルトルート（0.0.0.0/0）をオンプレミスに広報します。<br>ER 接続の場合も、同様の「既定のルートを伝達」を有効化させることにより、デフォルトルート（0.0.0.0/0）をオンプレミスに広報します。</p><p>これだけで、オンプレミスは Azure から広報されたデフォルトルート（0.0.0.0/0）を学習し、オンプレミスからインターネットへの通信を Azure 経由にさせることが可能になります。<br>Virtual WAN の場合には、このように簡単にデフォルトルート（0.0.0.0/0）を広報することが可能です。</p><h3 id="インターネット向けのルーティング-ポリシーを設定"><a href="#インターネット向けのルーティング-ポリシーを設定" class="headerlink" title="インターネット向けのルーティング ポリシーを設定"></a>インターネット向けのルーティング ポリシーを設定</h3><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/04.png"></p><h3 id="VPN-接続の場合"><a href="#VPN-接続の場合" class="headerlink" title="VPN 接続の場合"></a>VPN 接続の場合</h3><p>「既定のルートを伝達」を有効化<br><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/05.png"></p><h3 id="ExpressRoute-接続の場合"><a href="#ExpressRoute-接続の場合" class="headerlink" title="ExpressRoute 接続の場合"></a>ExpressRoute 接続の場合</h3><p>「既定のルートを伝達」を有効化<br><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/06.png"></p><h2 id="2）Azure-Route-Server-と-NVA（Network-Virtual-Appliance-ネットワーク仮想アプライアンス）を利用する"><a href="#2）Azure-Route-Server-と-NVA（Network-Virtual-Appliance-ネットワーク仮想アプライアンス）を利用する" class="headerlink" title="2）Azure Route Server と NVA（Network Virtual Appliance - ネットワーク仮想アプライアンス）を利用する"></a>2）Azure Route Server と NVA（Network Virtual Appliance - ネットワーク仮想アプライアンス）を利用する</h2><p>Virutal WAN ではなく、仮想ネットワーク（VNet）を利用している場合には、少々複雑にはなってしまいますが、Azure Route Server（RS）とサードパーティー製の NVA を利用して、実現することができます。</p><p>RS は NVA と BGP で経路交換することにより、VNet と NVA の間で経路の学習をすることができます。<br>そのため、RS を利用することで、VNet が NVA から広報されたインターネット向けの経路を学習します。<br>さらに、RS は NVA から広報されたインターネット向けの経路を、仮想ネットワークゲートウェイに対しても広報することができます。<br>これにより、オンプレミスは仮想ネットワークゲートウェイから広報されたインターネット向けの経路を学習することにより、オンプレミスからインターネットへの通信を Azure 経由にさせることが可能になります。<br>また、RS は BGP の経路交換だけに使われるため、実際のトラフィックは RS を通ることはありません。</p><p>ER 回線と Site to Site VPN（S2S VPN）では、Azure でデプロイする仮想ネットワークゲートウェイの種類が異なり、ER GW と VPN GW という 2 種類があります。<br>ER GW と VPN GW は、実装の違いによりオンプレミスへ経路広報ができる経路に違いがあります。<br>そのため、NVA で広報する経路を以下のようにする必要があるので、この点はご注意ください。</p><h3 id="ER-回線"><a href="#ER-回線" class="headerlink" title="ER 回線"></a>ER 回線</h3><p>・デフォルトルート（0.0.0.0/0）を広報する  </p><blockquote><p>[経路広報]<br>オンプレミス &lt;– ER 回線 &lt;– ER GW &lt;–  RS &lt;– NVA（0.0.0.0/0 を広報する）<br>[トラフィックフロー]<br>オンプレミス –&gt; ER 回線 –&gt; ER GW –&gt; NVA –&gt; インターネット</p></blockquote><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/07.png"></p><h3 id="Site-to-Site-VPN"><a href="#Site-to-Site-VPN" class="headerlink" title="Site to Site VPN"></a>Site to Site VPN</h3><p>・0.0.0.0/1, 128.0.0.0/1 の２つ経路を広報する<br>※ VPN GW は、オンプレミス向けにはデフォルトルート（0.0.0.0/0）を広報できない実装となっているため</p><blockquote><p>[経路広報]<br>オンプレミス &lt;– Site to Site VPN (S2S VPN) &lt;– VPN GW &lt;–  RS &lt;– NVA (0.0.0.0/1, 128.0.0.0/1 の２つを広報する）<br>[トラフィックフロー]<br>オンプレミス –&gt; Site to Site VPN (S2S VPN) –&gt; VPN GW –&gt; NVA –&gt; インターネット</p></blockquote><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/08.png"></p><p>NVA で経路広報をする方法は、NVA の設定方法に依存するため、本ブログでは割愛します。</p><p>NVA で経路広報の設定をしたのち、RS で「ピアの追加」をし「ブランチ間」を有効化することで、<br>オンプレミス – ER GW/VPN GW – RS – NVA 間で経路情報の交換を開始します。<br>これにより、オンプレミスは NVA からインターネット向けの経路を学習し、オンプレミスからインターネットへの通信を、Azure 経由にさせることが可能になります。</p><h3 id="RS-の設定について"><a href="#RS-の設定について" class="headerlink" title="RS の設定について"></a>RS の設定について</h3><p>RS でピアの追加<br><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/09.png"></p><p>RS で「ブランチ間」を有効化</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/10.png"></p><p>RS と NVA を利用する方法は、NVA の OS 上のスタティックルートを設定したり、NVA の NIC のサブネットにインターネット向けのユーザー定義ルートを設定したりと、実際には複雑な作業が必要となりますので、参考情報に RS と NVA に関する情報を補足しております。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は、オンプレミスからのインターネット宛ての通信を Azure 経由にする方法について、以下の２つの方法をご紹介しました。</p><p>１）Virtual WAN を利用する<br>２）Azure Route Server と NVA（Network Virtual Appliance - 仮想アプライアンス）を利用する</p><p>どちらを選択されるかは、お客様の様々な状況にも依存しますので、適切な方法を選択し事前検証をした上で実際の動作もご確認ください。<br>動作でご不明な点があれば、Azure ポータルより弊社サポートまでお問い合わせください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;本ブログでは、オンプレミスからのインターネット宛ての通信を Azure 経由にする方法について、ご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="VPN" scheme="https://jpaztech.github.io/blog/tags/VPN/"/>
    
    <category term="Virtual WAN" scheme="https://jpaztech.github.io/blog/tags/Virtual-WAN/"/>
    
  </entry>
  
  <entry>
    <title>VM サイズの選定および変更時の注意点について</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-size-change/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-size-change/</id>
    <published>2024-04-17T06:00:00.000Z</published>
    <updated>2024-11-26T07:55:53.353Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure テクニカル サポート チームの前田です。<br>Azure テクニカル サポート窓口におきまして、Azure VM のサイズに関するお問い合わせをいただくことがあります。<br>しかしながら、弊サポート窓口にお問い合わせいただいた場合であっても、原則としてサポートより具体的な VM サイズを直接ご提案することは叶わず、最終的にはお客様にご判断いただく必要が生じます。<br>このため、お客様のお手元にて VM サイズの選定にあたり適切な内容をご確認いただけるよう、また変更時のトラブルについて初動対処が可能となるよう、本記事を公開させていただきます。<br>各項目に添付の弊社公開情報と併せまして、少しでもご参考になりましたら幸いに存じます。  </p><h2 id="目次"><a href="#目次" class="headerlink" title="目次  "></a>目次  <!-- omit in toc --></h2><ul><li><a href=".#VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E3%81%B3%E6%96%B9">VM サイズの選び方</a><ul><li><a href=".#%E3%82%B5%E3%82%A4%E3%82%BA%E9%81%B8%E5%AE%9A%E6%99%82%E3%81%AB%E4%B8%80%E8%88%AC%E3%81%AB%E8%80%83%E6%85%AE%E3%81%99%E3%81%B9%E3%81%8D%E9%A0%85%E7%9B%AE">サイズ選定時に一般に考慮すべき項目</a></li><li><a href=".#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E3%82%BB%E3%83%AC%E3%82%AF%E3%82%BF%E3%83%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">仮想マシン セレクターについて</a></li></ul></li><li><a href=".#VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E6%8A%9E%E3%83%BB%E5%A4%89%E6%9B%B4%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">VM サイズの選択・変更ができない場合のトラブルシューティング</a><ul><li><a href=".#%E5%BD%93%E8%A9%B2%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%80%81%E3%82%BE%E3%83%BC%E3%83%B3%E3%81%AB%E3%81%A6%E5%A4%89%E6%9B%B4%E5%85%88%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B">当該リージョン、ゾーンにて変更先のサイズが提供されているか</a></li><li><a href=".#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E4%B8%80%E6%99%82%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE%E6%9C%89%E7%84%A1">ローカル一時ディスクの有無</a></li><li><a href=".#%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E8%A7%A3%E9%99%A4%E3%82%92%E8%A1%8C%E3%81%86%E3%81%93%E3%81%A8%E3%81%A7-VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E6%8A%9E%E8%82%A2%E3%81%8C%E5%A2%97%E3%81%88%E3%82%8B%E5%A0%B4%E5%90%88">割り当て解除を行うことで VM サイズの選択肢が増える場合</a></li><li><a href=".#%E5%8F%AF%E7%94%A8%E6%80%A7%E3%82%BB%E3%83%83%E3%83%88%E5%88%A9%E7%94%A8%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F">可用性セット利用時の注意</a></li></ul></li><li><a href=".#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85">注意事項</a><ul><li><a href=".#%E3%82%AF%E3%82%A9%E3%83%BC%E3%82%BF%E3%81%AE%E4%B8%8D%E8%B6%B3%E3%81%AB%E3%82%88%E3%82%8B-VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E6%8A%9E%E4%B8%8D%E8%83%BD%E4%BA%8B%E4%BE%8B">クォータの不足による VM サイズの選択不能事例</a></li><li><a href=".#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E5%A4%89%E6%9B%B4%E3%81%AB%E3%82%88%E3%82%8A%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B">仮想マシン サイズの変更により再起動が発生する</a></li></ul></li><li><a href=".#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">おわりに</a></li></ul><h2 id="VM-サイズの選び方"><a href="#VM-サイズの選び方" class="headerlink" title="VM サイズの選び方"></a>VM サイズの選び方</h2><h3 id="サイズ選定時に一般に考慮すべき項目"><a href="#サイズ選定時に一般に考慮すべき項目" class="headerlink" title="サイズ選定時に一般に考慮すべき項目"></a>サイズ選定時に一般に考慮すべき項目</h3><p>まず VM サイズを選定いただくにあたり、一般に考慮すべき項目としては下記内容が挙げられるかと存じます。<br>ご要件によりこの他にも必要な要件があるかと存じますため、一例としてご参考になりましたら幸いでございます。  </p><ul><li>CPU、メモリ、ネットワーク帯域といった基本スペック</li><li>Intel 社、AMD 社の CPU の差異 </li><li>ディスクの最大アタッチ数</li><li>Premium Storage の利用可否</li><li>一時ディスクの有無</li></ul><p>Azure におきましては、CPU 対メモリ比のバランスのとれた汎用サイズの他、メモリ比率の高いメモリの最適化サイズなど、特徴ごとに様々な VM サイズのシリーズをご用意しております。<br>各シリーズの詳細につきましては、下記公開情報にてご紹介しておりますのでご参考ください。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes">VM サイズ - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h3 id="仮想マシン-セレクターについて"><a href="#仮想マシン-セレクターについて" class="headerlink" title="仮想マシン セレクターについて"></a>仮想マシン セレクターについて</h3><p>ご利用の環境において CPU やメモリの必要な容量などの要件が既に明確な場合、仮想マシン セレクターにてご希望に応じた VM サイズを自動でご提案します。<br>その他、リージョンの指定やプレミアム ストレージの利用可否など、細かな設定が可能ですので、VM サイズの選定の第一歩として有効活用いただければと存じます。  </p><p>ご参考：<a href="https://azure.microsoft.com/ja-jp/pricing/vm-selector/">Microsoft Azure VM セレクター</a>  </p><hr><h2 id="VM-サイズの選択・変更ができない場合のトラブルシューティング"><a href="#VM-サイズの選択・変更ができない場合のトラブルシューティング" class="headerlink" title="VM サイズの選択・変更ができない場合のトラブルシューティング"></a>VM サイズの選択・変更ができない場合のトラブルシューティング</h2><p>続いて、VM サイズの変更ができない場合のトラブルシューティングについてご紹介します。</p><h3 id="当該リージョン、ゾーンにて変更先のサイズが提供されているか"><a href="#当該リージョン、ゾーンにて変更先のサイズが提供されているか" class="headerlink" title="当該リージョン、ゾーンにて変更先のサイズが提供されているか"></a>当該リージョン、ゾーンにて変更先のサイズが提供されているか</h3><p>GPU 搭載の VM サイズや、提供開始が比較的直近の VM サイズをご利用いただく場合、ご利用可能なリージョンや可用性ゾーンに制限が生じている場合があります。<br>リージョンおよび可用性ゾーンそれぞれの制限につきましては、下記の手順にてご確認いただくことが可能です。</p><ul><li>各リージョンでの提供状況<br>下記公開情報内「製品」項目にて「Virtual Machines」を検索いただき、「リージョン」にてご利用予定のリージョンをご選択ください。</li></ul><p>ご参考：<a href="https://azure.microsoft.com/ja-jp/explore/global-infrastructure/products-by-region/?products=virtual-machines">リージョン別の Azure 製品 | Microsoft Azure</a></p><ul><li>各可用性ゾーンでの提供状況<br>各可用性ゾーンでの VM サイズのご提供状況につきましては、VM をご利用いただくサブスクリプションにて、下記コマンド例をご参考に Azure CLI または Azure PowerShell コマンドよりご確認ください。<br>なお、各可用性ゾーンでのご提供状況につきましては、サブスクリプションごとにご確認いただく必要がございます点、ご留意のほどお願いいたします。  </li></ul><p>JapanEast リージョンでの確認コマンド例<br>Azure CLI の場合：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm list-skus --location japaneast --output table  </span><br></pre></td></tr></table></figure><p>Azure PowerShell の場合：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AzComputeResourceSku | where &#123;$_.Locations.Contains(&quot;japaneast&quot;)&#125;;  </span><br></pre></td></tr></table></figure><p>出力例について、一部表記が異なりますが概ね同じ内容となるため、統合してご紹介いたします。  </p><p>出力例：  </p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResourceType      Locations    Name                      Zones    Restrictions</span><br><span class="line">----------------  -----------  ------------------------  -------  ------------</span><br><span class="line">virtualMachines   japaneast    Standard_D2s_v5           <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>    None</span><br></pre></td></tr></table></figure><p>下記例の場合、Japan East リージョンの Standard_B16as_v2 サイズは、当該サブスクリプションにて、可用性ゾーン 1,2 で提供されている状況となります。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResourceType      Locations    Name                      Zones    Restrictions</span><br><span class="line">----------------  -----------  ------------------------  -------  ------------</span><br><span class="line">virtualMachines   japaneast    Standard_B16as_v2         <span class="number">1</span>,<span class="number">2</span>      None</span><br></pre></td></tr></table></figure><p>なお、Restrictions として何からの制限が記載されていることもございます。 </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/create-cli-availability-zone#check-vm-sku-availability">Azure CLI を使用してゾーン VM を作成する - Azure Virtual Machines | Microsoft Learn</a><br>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/create-powershell-availability-zone#check-vm-sku-availability">Azure PowerShell を使用したゾーン VM の作成 - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h3 id="ローカル一時ディスクの有無"><a href="#ローカル一時ディスクの有無" class="headerlink" title="ローカル一時ディスクの有無"></a>ローカル一時ディスクの有無</h3><p>ローカル一時ディスクの有無が異なるサイズへ変更する場合、VM の再作成が必要となります。<br>ゲスト OS 上での事前作業等が必要となりますので、詳細な手順につきましては下記の公式ドキュメントをご参照ください。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/azure-vms-no-temp-disk">FAQ - ローカル一時ディスクを持たない Azure VM のサイズ - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h3 id="割り当て解除を行うことで-VM-サイズの選択肢が増える場合"><a href="#割り当て解除を行うことで-VM-サイズの選択肢が増える場合" class="headerlink" title="割り当て解除を行うことで VM サイズの選択肢が増える場合"></a>割り当て解除を行うことで VM サイズの選択肢が増える場合</h3><p>シリーズ違いなど大きく異なる VM サイズへの変更を行う際、割り当て解除を行うことで Azure Portal から確認可能な変更先の VM サイズの種類が増える場合があります。<br>これは仮想マシンが割り当てられる物理ホストごとに利用可能な VM サイズが決まっていることから、この制限を撤廃する割り当て解除を実施することで選択肢が増えるものとなります。<br>リージョン・可用性ゾーンでの提供、および後述のクォータ等に問題がないにもかかわらず変更先の VM サイズが表示されない場合、VM の割り当て解除をご検討ください。  </p><hr><h3 id="可用性セット利用時の注意"><a href="#可用性セット利用時の注意" class="headerlink" title="可用性セット利用時の注意"></a>可用性セット利用時の注意</h3><p>可用性セットをご利用の場合、通常の VM と比較し VM の割り当てを行う物理ホストに一定の制限が生じますため、サイズ変更の際に割り当てのエラーが発生する場合があります。<br>当該事象の発生時には、可用性セットに含まれる全ての VM を割り当て解除いただくことで、より最適な物理ホストへの配置が可能となりますので、お試しください。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/allocation-failure">Azure VM の割り当てエラーのトラブルシューティング - Virtual Machines | Microsoft Learn</a>  </p><hr><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><h3 id="クォータの不足による-VM-サイズの選択不能事例"><a href="#クォータの不足による-VM-サイズの選択不能事例" class="headerlink" title="クォータの不足による VM サイズの選択不能事例"></a>クォータの不足による VM サイズの選択不能事例</h3><p>Azure のサブスクリプションでは各機能に対しクォータに制限があり、VM サイズにも同様にクォータが設定されています。<br>Azure Portal 上で仮想マシンの作成時や変更時に VM サイズの選択を行う際、下記画面例のように「クォータの要求」が表示される場合、当該サブスクリプションにて適切なカテゴリでのクォータの引き上げが必要となります。  </p><p>画面例：<br><img src="/blog/vm/vm-size-change/vm-size-change001.png" alt="vm-size-change001"></p><p>特に、GPU を利用する VM サイズでは、クォータに制限が生じている場合が散見されますので、ご注意いただければと存じます。<br>下記公開情報をご参考に、事象に該当する場合はクォータの引き上げについてもご検討いただけますと幸いです。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/quotas/per-vm-quota-requests">VM ファミリの vCPU クォータの増加 - Azure Quotas | Microsoft Learn</a>  </p><hr><h3 id="仮想マシン-サイズの変更により再起動が発生する"><a href="#仮想マシン-サイズの変更により再起動が発生する" class="headerlink" title="仮想マシン サイズの変更により再起動が発生する"></a>仮想マシン サイズの変更により再起動が発生する</h3><p>仮想マシン サイズの変更時は、いずれのサイズの場合であっても再起動が発生します。<br>現時点での仕様としてご理解いただき、ユーザー影響の少ない時間帯での実施をご検討いただきますようお願いいたします。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/resize-vm?tabs=portal">仮想マシンのサイズ変更 - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>VM サイズの選定・変更に際し、弊サポートへよくお問い合わせいただく事例をご紹介いたしました。<br>Azure VM では VM サイズの変更が容易でございますので、VM サイズの選定の際はお手元にて負荷テスト等を検証の上でご判断をいただければと存じます。<br>お手元での VM サイズの選定に際し、本記事の内容がご参考となりましたら幸いでございます。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;p&gt;こんにちは、Azure テクニカル サポート チームの前田です。&lt;br&gt;Azure テクニカル サポート窓口におきまして、Azure VM のサイズに関するお問い合わせをいただくことがあります。&lt;br&gt;しかしながら、弊サポー</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure Front Door (クラシック) のリタイアについて</title>
    <link href="https://jpaztech.github.io/blog/network/afd-classic-retire/"/>
    <id>https://jpaztech.github.io/blog/network/afd-classic-retire/</id>
    <published>2024-03-29T12:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.857Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>本ブログでは、Azure Front Door (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と記載致します)。</p><span id="more"></span><hr><h2 id="AFD-クラシック-のリタイアについて"><a href="#AFD-クラシック-のリタイアについて" class="headerlink" title="AFD (クラシック) のリタイアについて"></a>AFD (クラシック) のリタイアについて</h2><p>2027 年 3 月 31 日に AFD (クラシック) の提供が終了し、AFD (クラシック) に対するサポートも終了します。<br>提供終了までの間は既存の AFD (クラシック) の設定を変更することは可能ですが、2025 年 4 月 1 日以降は Azure ポータル、Terraform、Azure PowerShell や Azure CLI などを使用して新しい AFD (クラシック) リソースが作成できなくなります。<br>アナウンス内容につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://azure.microsoft.com/ja-jp/updates/azure-front-door-classic-will-be-retired-on-31-march-2027/">Azure Front Door (classic) will be retired on 31 March 2027</a></p><h2 id="AFD-クラシック-のリタイアに関する-FAQ"><a href="#AFD-クラシック-のリタイアに関する-FAQ" class="headerlink" title="AFD (クラシック) のリタイアに関する FAQ"></a>AFD (クラシック) のリタイアに関する FAQ</h2><p>AFD (クラシック) のリタイアに関するよくある質問につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/classic-retirement-faq">Azure Front Door (classic) retirement FAQ</a></p><h2 id="AFD-クラシック-から-AFD-Standard-Premium-への移行方法について"><a href="#AFD-クラシック-から-AFD-Standard-Premium-への移行方法について" class="headerlink" title="AFD (クラシック) から AFD Standard/Premium への移行方法について"></a>AFD (クラシック) から AFD Standard/Premium への移行方法について</h2><p>AFD (クラシック) の提供が終了する 2027 年 3 月 31 日までに、事前にお客様にて AFD Standard/Premium へ移行する必要がございます。<br>AFD (クラシック) から AFD Standard/Premium にゼロ ダウンタイムで移行するプロセスや手順に関しましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/migrate-tier">Azure Front Door (クラシック) から Standard/Premium に移行する</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Azure Front Door (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と記載致します)。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="AzureFrontDoor" scheme="https://jpaztech.github.io/blog/tags/AzureFrontDoor/"/>
    
  </entry>
  
  <entry>
    <title>ExpressRoute にデフォルトルートを広報していてオンプレミス以外とも通信したい場合の構成</title>
    <link href="https://jpaztech.github.io/blog/network/expressroute-forced-tunneling-routing/"/>
    <id>https://jpaztech.github.io/blog/network/expressroute-forced-tunneling-routing/</id>
    <published>2024-03-29T06:00:00.000Z</published>
    <updated>2024-11-26T07:55:52.885Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの角田です。<br>オンプレミスから ExpressRoute 経由で デフォルトルート (0.0.0.0/0) を広報している場合に、特定のサブネットからオンプレミスに通信させたくない場合や、オンプレミス以外にも通信させたい要件があるかと存じます。<br>今回は、その様な要件を解決する方法をご紹介します。 </p><span id="more"></span><hr><h2 id="想定シナリオ"><a href="#想定シナリオ" class="headerlink" title="想定シナリオ"></a>想定シナリオ</h2><p>以下 3 パターンのシナリオについてご紹介します。<br>全てオンプレミスからデフォルトルートを広報されている構成 (Azure では強制トンネリング構成とも呼称) を前提としており、いずれも対象のサブネットにルートテーブルリソースを関連付けて解決します。 </p><ul><li>シナリオ 1. 特定のサブネットからオンプレミスに対して通信させたくない場合 </li><li>シナリオ 2. 基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合 </li><li>シナリオ 3. 基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合 </li></ul><p>以下それぞれ記載いたします。</p><h3 id="シナリオ-1-特定のサブネットからオンプレミスに対して通信させたくない場合"><a href="#シナリオ-1-特定のサブネットからオンプレミスに対して通信させたくない場合" class="headerlink" title="シナリオ 1. 特定のサブネットからオンプレミスに対して通信させたくない場合"></a>シナリオ 1. 特定のサブネットからオンプレミスに対して通信させたくない場合</h3><p>ルートテーブルリソースでは、「ゲートウェイのルートを伝達する」というオプションがございます。<br>このオプションが無効の場合、Gateway から対象のサブネットへのルート伝達を停止することが可能となります。<br>ルート伝達を停止することで、対象のサブネットから オンプレミスに対して通信不能とさせることが可能です。 </p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario1.png" alt="scenario1"></p><p>本設定は UDR の構成ページにございますので、「いいえ」をご選択ください。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario1-config.png" alt="scenario1-config"></p><h3 id="シナリオ-2-基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合"><a href="#シナリオ-2-基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合" class="headerlink" title="シナリオ 2. 基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合"></a>シナリオ 2. 基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合</h3><p>Azure ではルーティングの優先順位付けにロンゲストマッチを利用しておりますので、より詳細な経路を学習している場合は、そちらを優先する動作となります。<br>例えば 203.0.113.0/24 に対する経路を 直接インターネットに通信したい場合、ルートテーブルリソースにて 203.0.113.0/24 のユーザー定義ルート (以下 UDR) を記載することで、直接インターネットと通信することが可能です。 </p><blockquote><p>注意<br>仮想マシンがインターネットと通信する場合、<br>インターネットと通信する手段をサブネット内の仮想マシンが持つ必要がございます。<br>詳しくは下記をご参照ください。<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/">Azure VM の送信接続 (SNAT) オプション まとめ | Japan Azure IaaS Core Support Blog</a></p></blockquote><p>下図では、仮想マシンに パブリック IP リソースを持たせた際の動作となります。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario2.png" alt="scenario2"></p><p>ルートの追加はルートテーブルリソースのルートページにございますので、「追加」を押下して追加ください。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario2-config.png" alt="scenario2-config"></p><h3 id="シナリオ-3-基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合"><a href="#シナリオ-3-基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合" class="headerlink" title="シナリオ 3. 基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合"></a>シナリオ 3. 基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合</h3><p>Azure では、同一のアドレスプレフィックスを複数の方法で学習している場合、BGP で学習したルートよりも UDR で記載したルートを優先する動作となります。 (参考 1 )<br>そのため UDR にて宛先をインターネットとしたデフォルトルートを記載した場合、すべてのトラフィックがインターネットに転送され、オンプレミスに対して通信することができない状態となります。<br>この状態で オンプレミスに対して通信させたい場合、対象のアドレスプレフィックスをオンプレミスより広報いただくことで、ロンゲストマッチによりルートが優先され、通信可能となります。<br>例えば 192.168.254.0/24 の宛先についてオンプレミスと通信したい場合、デフォルトルートに加えて 192.168.254.0/24 のルートを広報いただくことで、192.168.254.0/24 宛のトラフィックをオンプレミスに対して通信することが可能となります。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario3.png" alt="scenario3"></p><blockquote><p>注意<br>UDR で特定の経路のネクストホップを[仮想ネットワーク ゲートウェイ]に設定し、オンプレミスと通信させることはできません。<br>ExpressRoute ゲートウェイをネクストホップとして設定することをサポートしていないためです。 (参考 2 )<br>このシナリオを解決する場合は、当該経路を BGP 経由で広報頂けますようお願いいたします。</p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>1.) <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#how-azure-selects-a-route">Azure 仮想ネットワーク トラフィックのルーティング | Microsoft Learn</a></p><blockquote><p>Azure がルートを選択するしくみ<br>送信トラフィックがサブネットから送信されると、Azure は最長プレフィックス一致アルゴリズムを使用して、宛先 IP アドレスに基づいてルートを選択します。<br>たとえば、ルート テーブルに 2 つのルートがあるとします。<br>一方のルートではアドレス プレフィックス 10.0.0.0/24 を指定し、もう一方のルートではアドレス プレフィックス 10.0.0.0/16 を指定しています。<br>Azure は、10.0.0.5 宛てのトラフィックを、10.0.0.0/24 アドレス プレフィックスを使用してルートで指定されたネクスト ホップの種類に転送します。<br>このプロセスが発生するのは、10.0.0.5 が両方のアドレス プレフィックスに含まれている場合でも、10.0.0.0/24 が 10.0.0.0/16 よりも長いプレフィックスであるためです。<br>Azure は、10.0.1.5 宛てのトラフィックを、10.0.0.0/16 アドレス プレフィックスを使用してルートで指定されたネクストホップの種類に転送します。<br>このプロセスが発生するのは、10.0.1.5 が 10.0.0.0/24 アドレス プレフィックスに含まれておらず、10.0.0.0/16 アドレス プレフィックスを持つルートが一致する最長プレフィックスであるためです。<br>複数のルートに同じアドレス プレフィックスが含まれている場合は、次の優先順位に基づいてルートの種類が選択されます。</p><p>1.ユーザー定義のルート<br>2.BGP のルート<br>3.システム ルート </p></blockquote><p>2.) <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#custom-routes">Azure 仮想ネットワーク トラフィックのルーティング | Microsoft Learn</a></p><blockquote><p>ユーザー定義ルートを作成するときは、次のネクストホップの種類を指定できます。<br>(中略)<br>[仮想ネットワーク ゲートウェイ] :<br>特定のアドレス プレフィックス宛てのトラフィックを仮想ネットワーク ゲートウェイにルーティングする場合に指定します。<br>種類が VPN の仮想ネットワーク ゲートウェイを作成する必要があります。<br>ExpressRoute ではカスタム ルートに BGP を使用する必要があるため、種類を ExpressRoute として作成された仮想ネットワーク ゲートウェイをユーザー定義ルートで指定することはできません。<br>VPN 接続と ExpressRoute 接続が共存している場合、仮想ネットワーク ゲートウェイは指定できません。 </p></blockquote><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの角田です。&lt;br&gt;オンプレミスから ExpressRoute 経由で デフォルトルート (0.0.0.0/0) を広報している場合に、特定のサブネットからオンプレミスに通信させたくない場合や、オンプレミス以外にも通信させたい要件があるかと存じます。&lt;br&gt;今回は、その様な要件を解決する方法をご紹介します。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
  </entry>
  
  <entry>
    <title>VM イメージ バージョンを指定して VM を作成する方法について</title>
    <link href="https://jpaztech.github.io/blog/vm/create-vm-specific-version/"/>
    <id>https://jpaztech.github.io/blog/vm/create-vm-specific-version/</id>
    <published>2024-03-28T03:00:00.000Z</published>
    <updated>2024-11-26T07:55:53.049Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azureサポートチームです。<br>この記事では、VM イメージ バージョンを指定して VM を作成する方法についてご紹介します。</p><span id="more"></span><p>通常、Marketplace から VM を作成すると、最新のバージョン (latest) が既定で作成されます。</p><p>ここで Azure Marketplace の Windows Server イメージを例にとると、以下のドキュメントに示す通り毎月最新のパッチがリリースされていることを確認いただくことができます。</p><ul><li><a href="https://support.microsoft.com/ja-jp/topic/windows-server-release-on-azure-marketplace-update-history-6dbc5136-db53-6c5d-61f6-da370e2fa68c">Windows Server release on Azure Marketplace update history - Microsoft サポート</a></li></ul><p>通常、最新のセキュリティパッチが適用されたイメージをご利用いただくことが一般的かと存じます。しかし、お客様によっては何らかの理由により最新のセキュリティ更新プログラムが適用されていない VM を作成する必要がある場合もあるかと存じます。<br>そのような場合には、VM イメージ バージョンを指定して VM をデプロイすることができます。</p><p>例えば、2023 年 10 月時点の Windows Server バージョン 2022 のイメージをデプロイする場合は「<a href="https://support.microsoft.com/ja-jp/topic/2023-%E5%B9%B4-10-%E6%9C%88%E3%81%AE-windows-server-%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8-cb930aa9-4609-48f4-90b2-13767a0f9dcd">2023 年 10 月の Windows Server イメージ - Microsoft サポート</a>」に記載されているバージョン「20348.2031.231006」を指定して VM を作成するという手順となります。<br>本記事では、VM 作成時にイメージ バージョンを指定する手順について説明します。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>下記手順にそって VM イメージ バージョンを指定し、VM をデプロイします。</p><h3 id="大まかな流れ"><a href="#大まかな流れ" class="headerlink" title="大まかな流れ"></a>大まかな流れ</h3><ol><li>イメージを検索する<br> 1-1. Azure CLI を使用して VM イメージを検索する<br> 1-2. PowerShell を使用して VM イメージを検索する</li><li>Azure Portal より ARM テンプレートを用意する</li><li>VM バージョンを指定する</li><li>VM をデプロイする</li><li>指定したバージョンで作成できたかを確認する</li></ol><h2 id="実際の手順"><a href="#実際の手順" class="headerlink" title="実際の手順"></a>実際の手順</h2><p>それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。</p><hr><h3 id="1-VM-イメージを検索する"><a href="#1-VM-イメージを検索する" class="headerlink" title="1. VM イメージを検索する"></a>1. VM イメージを検索する</h3><p>この項では、必要なバージョンの VM イメージを検索する手順について説明します。最新のバージョンでない VM イメージは、Azure Marketplace からは検索できず、 Azure CLI または PowerShell を使用して検索する必要があります。</p><p>VM イメージを検索するには、次の 4 つの属性を指定する必要があります。</p><table><thead><tr><th>属性</th><th>意味</th><th>説明</th><th>例</th></tr></thead><tbody><tr><td>Publisher</td><td>発行元</td><td>イメージを作成した組織</td><td>Canonical、MicrosoftWindowsServer</td></tr><tr><td>Offer</td><td>プラン</td><td>発行元によって作成された関連するイメージのグループ名</td><td>UbuntuServer、WindowsServer</td></tr><tr><td>Sku</td><td>SKU</td><td>ディストリビューションのメジャー リリースなど、<br>プランのインスタンス</td><td>18.04-LTS、2019-Datacenter</td></tr><tr><td>Version</td><td>バージョン</td><td>イメージの SKU のバージョン番号</td><td>20348.2031.231006、latest</td></tr></tbody></table><p>この記事では、次の属性の例に基づいて東日本リージョンから <a href="https://support.microsoft.com/ja-jp/topic/2023-%E5%B9%B4-10-%E6%9C%88%E3%81%AE-windows-server-%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8-cb930aa9-4609-48f4-90b2-13767a0f9dcd">2023 年 10 月の Windows Server イメージ</a>を検索し、VM をデプロイします。</p><table><thead><tr><th>属性</th><th>意味</th><th>後述の検索の結果、今回利用する値</th></tr></thead><tbody><tr><td>Publisher</td><td>発行元</td><td>MicrosoftWindowsServer</td></tr><tr><td>Offer</td><td>プラン</td><td>WindowsServer</td></tr><tr><td>Sku</td><td>SKU</td><td>2022-datacenter-azure-edition</td></tr><tr><td>Version</td><td>バージョン</td><td>20348.2031.231006</td></tr></tbody></table><hr><h4 id="1-1-Azure-CLI-を使用して-VM-イメージを検索する"><a href="#1-1-Azure-CLI-を使用して-VM-イメージを検索する" class="headerlink" title="1-1. Azure CLI を使用して VM イメージを検索する"></a>1-1. Azure CLI を使用して VM イメージを検索する</h4><p>基本的には、「<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/cli-ps-findimage">Azure CLI を使用して Azure Marketplace イメージ情報を検索する</a>」のドキュメントにある通りの手順で検索します。</p><hr><h5 id="1-Publisher-を指定して、Offer-を一覧表示します。"><a href="#1-Publisher-を指定して、Offer-を一覧表示します。" class="headerlink" title="1. Publisher を指定して、Offer を一覧表示します。"></a>1. Publisher を指定して、Offer を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-offers --location &lt;リージョン&gt; --publisher &lt;発行元&gt; --output table</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-offers --location japaneast --publisher MicrosoftWindowsServer --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果です。指定した Publisher 内の Offer の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Location    Name</span><br><span class="line">----------  ----------------------------------------</span><br><span class="line">japaneast   19h1gen2servertest</span><br><span class="line">japaneast   microsoftserveroperatingsystems-previews</span><br><span class="line">japaneast   servertesting</span><br><span class="line">japaneast   windows-cvm</span><br><span class="line">japaneast   WindowsServer</span><br><span class="line">japaneast   windowsserver-gen2preview</span><br><span class="line">japaneast   windowsserver-previewtest</span><br><span class="line">japaneast   windowsserverdotnet</span><br><span class="line">japaneast   windowsserverhotpatch-previews</span><br><span class="line">japaneast   WindowsServerSemiAnnual</span><br><span class="line">japaneast   windowsserverupgrade</span><br></pre></td></tr></table></figure><p>次に、確認した Offer を指定してその Offer 内の Sku の一覧を表示します。</p><hr><h5 id="2-Publisher、Offer-を指定して、Sku-を一覧表示します。"><a href="#2-Publisher、Offer-を指定して、Sku-を一覧表示します。" class="headerlink" title="2. Publisher、Offer を指定して、Sku を一覧表示します。"></a>2. Publisher、Offer を指定して、Sku を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-skus --location &lt;リージョン&gt; --publisher &lt;発行元&gt; --offer &lt;プラン&gt; --output table</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-skus --location japaneast --publisher MicrosoftWindowsServer --offer WindowsServer --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。指定した Offer 内の Sku の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Location    Name</span><br><span class="line">----------  -------------------------------------------------</span><br><span class="line">(略)</span><br><span class="line"> </span><br><span class="line">japaneast   2022-datacenter</span><br><span class="line">japaneast   2022-datacenter-azure-edition</span><br><span class="line">japaneast   2022-datacenter-azure-edition-core</span><br><span class="line">japaneast   2022-datacenter-azure-edition-core-smalldisk</span><br><span class="line">japaneast   2022-datacenter-azure-edition-hotpatch</span><br><span class="line">japaneast   2022-datacenter-azure-edition-hotpatch-smalldisk</span><br><span class="line">japaneast   2022-datacenter-azure-edition-smalldisk</span><br><span class="line">japaneast   2022-datacenter-core</span><br><span class="line">japaneast   2022-datacenter-core-g2</span><br><span class="line">japaneast   2022-datacenter-core-smalldisk</span><br><span class="line">japaneast   2022-datacenter-core-smalldisk-g2</span><br><span class="line">japaneast   2022-datacenter-g2</span><br><span class="line"> </span><br><span class="line">(略)</span><br></pre></td></tr></table></figure><p>東日本リージョンに 2022-datacenter-azure-edition の Sku が存在することが確認できたので、次に、その Sku を指定して、Sku 内の Version を一覧表示します。</p><hr><h5 id="3-Publisher、Offer、Sku-を指定して、Version-を一覧表示します。"><a href="#3-Publisher、Offer、Sku-を指定して、Version-を一覧表示します。" class="headerlink" title="3. Publisher、Offer、Sku を指定して、Version を一覧表示します。"></a>3. Publisher、Offer、Sku を指定して、Version を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list --location &lt;リージョン&gt; --publisher &lt;発行元&gt; --offer &lt;プラン&gt; --sku &lt;SKU&gt; --all --output table</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list --location japaneast --publisher MicrosoftWindowsServer --offer WindowsServer --sku 2022-datacenter-azure-edition --all --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Architecture    Offer          Publisher               Sku                               Urn                                                                                      Version</span><br><span class="line">--------------  -------------  ----------------------  --------------------------------  ---------------------------------------------------------------------------------------  -----------------</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.1970.230905     20348.1970.230905</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.2031.231006     20348.2031.231006</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.2113.231109     20348.2113.231109</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.2159.231202     20348.2159.231202</span><br><span class="line">(略)</span><br></pre></td></tr></table></figure><p>Version 20348.2031.231006 のイメージが存在することが確認できたので、次に VM をデプロイします。「2. Azure Portal より ARM テンプレートを用意する」以降の手順を実施します。</p><hr><h4 id="1-2-PowerShell-を使用して-VM-イメージを検索する"><a href="#1-2-PowerShell-を使用して-VM-イメージを検索する" class="headerlink" title="1-2. PowerShell を使用して VM イメージを検索する"></a>1-2. PowerShell を使用して VM イメージを検索する</h4><p>基本的には、「<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/cli-ps-findimage#list-image">Azure PowerShell を使用して Azure Marketplace VM イメージを検索して使用する</a>」のドキュメントにある通りの手順で検索します。</p><hr><h5 id="1-Publisher-を指定して、Offer-を一覧表示します。-1"><a href="#1-Publisher-を指定して、Offer-を一覧表示します。-1" class="headerlink" title="1. Publisher を指定して、Offer を一覧表示します。"></a>1. Publisher を指定して、Offer を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$locName=&quot;japaneast&quot;</span><br><span class="line">$pubName=&quot;MicrosoftWindowsServer&quot;</span><br><span class="line">Get-AzVMImageOffer -Location $locName -PublisherName $pubName | Select Offer</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果です。指定した Publisher  内の Offer の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Offer</span><br><span class="line">-----</span><br><span class="line">19h1gen2servertest</span><br><span class="line">microsoftserveroperatingsystems-previews</span><br><span class="line">servertesting</span><br><span class="line">windows-cvm</span><br><span class="line">WindowsServer</span><br><span class="line">windowsserver-gen2preview</span><br><span class="line">windowsserver-previewtest</span><br><span class="line">windowsserverdotnet</span><br><span class="line">windowsserverhotpatch-previews</span><br><span class="line">WindowsServerSemiAnnual</span><br><span class="line">windowsserverupgrade</span><br></pre></td></tr></table></figure><p>次に、確認した Offer を指定してその Offer 内の Sku の一覧を表示します。</p><hr><h5 id="2-Publisher、Offer-を指定して、Sku-を一覧表示します。-1"><a href="#2-Publisher、Offer-を指定して、Sku-を一覧表示します。-1" class="headerlink" title="2. Publisher、Offer を指定して、Sku を一覧表示します。"></a>2. Publisher、Offer を指定して、Sku を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$offerName=&quot;WindowsServer&quot;</span><br><span class="line">Get-AzVMImageSku -Location $locName -PublisherName $pubName -Offer $offerName | Select Skus</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。指定した Offer 内の Sku の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Skus</span><br><span class="line">----</span><br><span class="line">(略)</span><br><span class="line">2022-datacenter</span><br><span class="line">2022-datacenter-azure-edition</span><br><span class="line">2022-datacenter-azure-edition-core</span><br><span class="line">2022-datacenter-azure-edition-core-smalldisk</span><br><span class="line">2022-datacenter-azure-edition-hotpatch</span><br><span class="line">2022-datacenter-azure-edition-hotpatch-smalldisk</span><br><span class="line">2022-datacenter-azure-edition-smalldisk</span><br><span class="line">2022-datacenter-core</span><br><span class="line">2022-datacenter-core-g2</span><br><span class="line">2022-datacenter-core-smalldisk</span><br><span class="line">2022-datacenter-core-smalldisk-g2</span><br><span class="line">2022-datacenter-g2</span><br><span class="line">2022-datacenter-smalldisk</span><br><span class="line">2022-datacenter-smalldisk-g2</span><br></pre></td></tr></table></figure><p>東日本リージョンに 2022-datacenter-azure-edition の Sku が存在することが確認できたので、次に、その Sku を指定して、Sku 内の Version を一覧表示します。</p><hr><h5 id="3-Publisher、Offer、Sku-を指定して、Versionを一覧表示します。"><a href="#3-Publisher、Offer、Sku-を指定して、Versionを一覧表示します。" class="headerlink" title="3. Publisher、Offer、Sku を指定して、Versionを一覧表示します。"></a>3. Publisher、Offer、Sku を指定して、Versionを一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$skuName=&quot;2022-datacenter-azure-edition&quot;</span><br><span class="line">Get-AzVMImage -Location $locName -PublisherName $pubName -Offer $offerName -Sku $skuName | Select Version</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Version</span><br><span class="line">-------</span><br><span class="line">20348.1129.221007</span><br><span class="line">20348.1131.221014</span><br><span class="line">20348.1249.221105</span><br><span class="line">20348.1366.221207</span><br><span class="line">20348.1487.230106</span><br><span class="line">20348.1547.230207</span><br><span class="line">20348.1607.230310</span><br><span class="line">20348.1668.230404</span><br><span class="line">20348.1726.230505</span><br><span class="line">20348.1787.230607</span><br><span class="line">20348.1787.230621</span><br><span class="line">20348.1850.230707</span><br><span class="line">20348.1906.230803</span><br><span class="line">20348.1970.230905</span><br><span class="line">20348.2031.231006</span><br><span class="line">20348.2113.231109</span><br><span class="line">20348.2159.231202</span><br></pre></td></tr></table></figure><p>Version 20348.2031.231006 のイメージが存在することが確認できたので、次に VM をデプロイします。「2. Azure Portal より ARM テンプレートを用意する」以降の手順を実施します。</p><hr><h3 id="2-Azure-Portal-より-ARM-テンプレートを用意する"><a href="#2-Azure-Portal-より-ARM-テンプレートを用意する" class="headerlink" title="2. Azure Portal より ARM テンプレートを用意する"></a>2. Azure Portal より ARM テンプレートを用意する</h3><p>この項では、1項にて検索したバージョンの Azure Marketplace イメージを利用し VMを作成する方法を説明します。先にも記載した通り Azure Portal から VM を通常通り作成すると最新のバージョンが利用される動作となることから、ARM テンプレートを編集しバージョン指定を行って VM を作成する必要があります。</p><p>Azure ポータルより [Virtual Machines] を開き、VM の新規作成画面を開きます。<br>必要な項目を設定し、画面下部にある [確認および作成] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img001.png"></p><p> [検証に成功しました] と表示されたら、画面下部にある [Automation のテンプレートをダウンロードする] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img002.png"></p><p>表示された ARM テンプレートを使用して VM をデプロイするため、[デプロイ] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img003.png"></p><p>ARM テンプレートを使用したカスタム デプロイの画面へ遷移しましたら、テンプレートを編集するため、[テンプレートの編集] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img010.png"></p><hr><h3 id="3-VM-バージョンを指定する"><a href="#3-VM-バージョンを指定する" class="headerlink" title="3. VM バージョンを指定する"></a>3. VM バージョンを指定する</h3><p>ARM テンプレートの “imageReference” 配下で、 バージョンを編集します。<br> “version”: “latest” の “latest” を修正し、今回指定するバージョンを入力します。</p><p><img src="/blog/vm/create-vm-specific-version/img004.png"></p><p>今回の例では、”version”: “20348.2031.231006” と設定します。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;imageReference&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;publisher&quot;</span>: <span class="string">&quot;MicrosoftWindowsServer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;offer&quot;</span>: <span class="string">&quot;WindowsServer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sku&quot;</span>: <span class="string">&quot;2022-datacenter-azure-edition&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;20348.2031.231006&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>編集が完了しましたら、画面下部にある [保存] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img005.png"></p><hr><h3 id="4-VM-をデプロイする"><a href="#4-VM-をデプロイする" class="headerlink" title="4. VM をデプロイする"></a>4. VM をデプロイする</h3><p>[カスタム デプロイ] 画面に戻ります。リソースグループ名など、いくつかの値は設定されていない既定の状態に戻ってしまいますので、再度設定しなおします。<br>[リソース グループ]、[Admin Password] の値を再度設定したら、[確認と作成] をクリックします。</p><p><img src="/blog/vm/create-vm-specific-version/img006.png"></p><p>“カスタム デプロイ” 画面にて [確認と作成] をクリックし、”確認と作成” の “ご契約条件” の画面で、[作成] をクリックするとデプロイが開始されます。</p><p><img src="/blog/vm/create-vm-specific-version/img007.png"></p><p>テンプレート編集画面に戻って “保存されていない編集は破棄されます” のポップアップメッセージが表示された場合は、[OK] をクリックしてデプロイ進行中の画面に遷移します。<br>最後に、デプロイが完了したことを確認します。</p><p><img src="/blog/vm/create-vm-specific-version/img008.png"></p><hr><h3 id="5-指定したバージョンで作成できたかの確認"><a href="#5-指定したバージョンで作成できたかの確認" class="headerlink" title="5. 指定したバージョンで作成できたかの確認"></a>5. 指定したバージョンで作成できたかの確認</h3><p>VM に RDP 接続をして OS ビルドを確認します。今回の例では、指定した “20348.2031” となっています。</p><p><img src="/blog/vm/create-vm-specific-version/img009.png"></p><hr><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回の記事では、Windows Server のイメージを検索し、VM をデプロイしました。</p><p>上記の手順において、発行元、プラン、SKU、バージョンを置き換えることによって、Linux など他のイメージについてもこの手順が応用できます。詳細については、次のドキュメントを参照してください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/cli-ps-findimage">CLI を使用してマーケットプレース購入プランの情報を検索および使用する - Azure Virtual Machines | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/cli-ps-findimage">PowerShell を使用してマーケットプレース購入プランの情報を検索および使用する - Azure Virtual Machines | Microsoft Learn</a></li></ul><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azureサポートチームです。&lt;br&gt;この記事では、VM イメージ バージョンを指定して VM を作成する方法についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
</feed>
