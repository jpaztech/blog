---
title: AKS ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã®é€šä¿¡ã®ã¯ãªã—
date: 2021-12-24 12:00:00
tags:
  - Containers
  - Azure Kubernetes Service (AKS)
---

ã“ã®è¨˜äº‹ã¯ [Microsoft Azure Tech Advent Calendar 2021](https://qiita.com/advent-calendar/2021/microsoft-azure-tech) ã® 24 æ—¥ç›®ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ğŸ…

ã“ã‚“ã«ã¡ã¯ï¼ï¼ Azure ãƒ†ã‚¯ãƒ‹ã‚«ãƒ« ã‚µãƒãƒ¼ãƒˆ ãƒãƒ¼ãƒ ã®æ¡äº•ã§ã™ã€‚

AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€kube-system ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã§ `tunnelfront` ã‚„ `aks-link` ã¨ã„ã†åå‰ã® Pod ãŒå‹•ã„ã¦ã„ã‚‹ã‹ã¨ãŠã‚‚ã„ã¾ã™ã€‚ã‚ã‚‹ã„ã¯ `konnectivity-agent` ã¨ã„ã† Pod ã‚’è¦‹ãŸã“ã¨ãŒã‚ã‚‹ã¨ã„ã†æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã® Pod ã¯ã©ã®ã‚ˆã†ãªç›®çš„ã§ä½¿ç”¨ã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ï¼Ÿ

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã‚Œã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ  Pod ãŒæ‹…ã† AKS ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã®é€šä¿¡ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

<!-- more -->

---

## Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã¾ãšã¯èª¬æ˜ã«ã‚ãŸã‚Šã€å‰ææƒ…å ±ã¨ãªã‚‹ Kubernetes ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦ç°¡å˜ã«ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚Kubernetes ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯ã€å¤§ããåˆ†ã‘ã¦ **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³** ã¨ **ãƒãƒ¼ãƒ‰** ã® 2 ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

![AKS (Kubernetes) ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](./aks-control-plane-node-communication/aks-control-plane-node-communication01.png)

### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³
Kubernetes ã®ä¸»è¦ãªã‚µãƒ¼ãƒ“ã‚¹ãŒç¨¼åƒã—ã¦ãŠã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‹…ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã§ã¯ API ã‚µãƒ¼ãƒãƒ¼ (kube-apiserver) ãŒå­˜åœ¨ã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ“ä½œã‚’ [Kubernetes API](https://kubernetes.io/ja/docs/concepts/overview/kubernetes-api/) ã¨ã—ã¦æä¾›ã—ã¾ã™ã€‚

### ãƒãƒ¼ãƒ‰
ã‚³ãƒ³ãƒ†ãƒŠãƒ¼åŒ–ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚å„ãƒãƒ¼ãƒ‰ã§ã¯ kubelet ãŒå‹•ä½œã—ã¦ãŠã‚Šã€Pod ã®ãƒ‡ãƒ—ãƒ­ã‚¤å†…å®¹ã«åŸºã¥ã„ã¦ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’æ“ä½œã—ãŸã‚Šã€Node ã‚„ Pod ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ API ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã—ãŸã‚Šã¨ã„ã£ãŸå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

Azure Kubernetes Service (AKS) ã¯ã€Kubernetes ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ Azure ã®ãƒãƒãƒ¼ã‚¸ãƒ‰ ãƒªã‚½ãƒ¼ã‚¹ã¨ã—ã¦æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è©³ç´°ã«ã¤ãã¾ã—ã¦ã¯ã€ä¸‹è¨˜ AKS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚ã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ã€‚

> ã”å‚è€ƒ) Azure Kubernetes Services (AKS) ã«ãŠã‘ã‚‹ Kubernetes ã®ä¸­å¿ƒæ¦‚å¿µ
> https://docs.microsoft.com/ja-jp/azure/aks/concepts-clusters-workloads


## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã®é€šä¿¡

å‰è¿°ã®ã‚ˆã†ã«ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®å„ç¨®æ“ä½œã¯ Kubernetes API ã‚’ä»‹ã—ã¦è¡Œã‚ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®åˆ©ç”¨è€…ãŒå®Ÿè¡Œã™ã‚‹ kubectl ã‚³ãƒãƒ³ãƒ‰ã‚„ã€ãƒãƒ¼ãƒ‰ä¸Šã§ç¨¼åƒã™ã‚‹ kubelet ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã® API ã‚µãƒ¼ãƒãƒ¼ (kube-apiserver) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒªã‚½ãƒ¼ã‚¹æ“ä½œã‚„æƒ…å ±å–å¾—ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã§ã¯ãªããƒãƒ¼ãƒ‰å´ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€API ã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ“ä½œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ãƒãƒ¼ãƒ‰ã‚„ Pod ã¨ã®é€šä¿¡ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

API ã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ¼ãƒ‰ã®é€šä¿¡ã¯å¤§ãã 2 ã¤ã«ã‚ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![API ã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ¼ãƒ‰ã®é€šä¿¡](./aks-control-plane-node-communication/aks-control-plane-node-communication02.png)

### (1) ãƒãƒ¼ãƒ‰ã‹ã‚‰ API ã‚µãƒ¼ãƒãƒ¼

API ã‚µãƒ¼ãƒãƒ¼ã¯ HTTPS ãƒãƒ¼ãƒˆ (443) ã§ Kubernetes API ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
kubelet ã‚„ã€Ingress Controller ãªã©ã® Kubernetes API ã‚’åˆ©ç”¨ã™ã‚‹ Pod ã¯ã€API ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« HTTPS ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã—ã€å„ç¨®ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã‚„æ›´æ–°ã‚’è¡Œã„ã¾ã™ã€‚

### (2) API ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒãƒ¼ãƒ‰

ä¸€éƒ¨ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ“ä½œã«ã¯ã€API ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ [kubelet ãŒæŒã¤ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ](https://kubernetes.io/docs/reference/ports-and-protocols/#node)ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãã®çµæœã‚’å–å¾—ã™ã‚‹å‡¦ç†ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

* Pod ã‹ã‚‰ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹ (kubectl logs)
* Pod ä¸Šã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ (kubectl exec)
* Pod / Service ã«ãƒãƒ¼ãƒˆ ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§æ¥ç¶šã™ã‚‹ (kubectl port-forward)

ã¾ãŸã€[Metrics API](https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/) ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ (kubectl top) ã§ã¯ã€Node ã‚„ Pod ã®ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ãƒãƒ¼ãƒ‰å´ã§å‹•ä½œã™ã‚‹ [metric-server](https://github.com/kubernetes-sigs/metrics-server) ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã®å®Ÿç¾ã‚’ã™ã‚‹ãŸã‚ã«ã€API ã‚µãƒ¼ãƒãƒ¼ã¯ kubelet ã‚„ Pod / Service ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã‹ã‚‰ãƒãƒ¼ãƒ‰ã¸ã®é€šä¿¡çµŒè·¯ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã‹ã‚‰ãƒãƒ¼ãƒ‰ã¸ã®é€šä¿¡ã®å®Ÿç¾æ–¹æ³•

å†’é ­ã§æŒ™ã’ãŸã‚·ã‚¹ãƒ†ãƒ  Pod ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã‹ã‚‰ãƒãƒ¼ãƒ‰ã¸ã®é€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ä»®æƒ³çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒè·¯ã‚’ä½œã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ Pod ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ Kubernetes ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã«ã¯è¼‰ã£ã¦ãŠã‚‰ãšã€ã‚ã¾ã‚Šèãé¦´æŸ“ã¿ã®ãªã„ Pod ã‹ã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½¿ã£ã¦ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ§‹ç¯‰ ([Kubernetes Hard Way](https://github.com/kelseyhightower/kubernetes-the-hard-way)) ã‚’è©¦ã—ãŸã“ã¨ãŒã‚ã‚‹æ–¹ã¯ã€ãã®ã‚ˆã†ãª Pod ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‹ãªï¼Ÿã¨ç–‘å•ã«æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰ãŒåŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã—ã¦ã„ã‚‹å ´åˆã¯ã€kube-apiserver ã¯ãƒãƒ¼ãƒ‰ã‚„ Pod ã«ç›´æ¥é€šä¿¡ã§ãã¾ã™ã€‚ã¨ã“ã‚ãŒã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰ãŒç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å­˜åœ¨ã—åˆ†æ–­ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ã¾ã¾ã§ã¯ãŠäº’ã„ã«é€šä¿¡ãŒã§ããªã„ã®ã§ã€ä½•ã‚‰ã‹ã®æ–¹æ³•ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒè·¯ã‚’ä½œã‚Šã€é€šä¿¡ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ä¿¡é ¼ã§ããªã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„ãƒ‘ãƒ–ãƒªãƒƒã‚¯ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’çµŒç”±ã•ã›ã‚‹å ´åˆã«ã¯ã€ç›—è´ã‚„ä¸­é–“è€…æ”»æ’ƒã‚’é˜²ããŸã‚ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä¿è­·ã‚‚å¿…è¦ã§ã™ã€‚

ãƒ‘ãƒ–ãƒªãƒƒã‚¯ ã‚¯ãƒ©ã‚¦ãƒ‰ã® Kubernetes ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ãƒãƒãƒ¼ã‚¸ãƒ‰ ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æä¾›ã™ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ãŠå®¢æ§˜ã®ç’°å¢ƒã¨ã¯åˆ¥ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€SSH ãƒˆãƒ³ãƒãƒ«ã‚„ VPN ã¨ã„ã£ãŸæŠ€è¡“ã‚’ä½¿ã£ã¦ã€API ã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ¼ãƒ‰é–“ã§ä»®æƒ³çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒè·¯ãŒä½œã‚‰ã‚Œã‚‹æ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚

![ç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å­˜åœ¨ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’å®Ÿç¾ã™ã‚‹](./aks-control-plane-node-communication/aks-control-plane-node-communication03.png)

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«ã¯ã€ã„ãã¤ã‹ã®å®Ÿç¾æ–¹æ³•ãŒã”ã–ã„ã¾ã™ã€‚ã“ã“ã§ã¯ã€AKS ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹é€šä¿¡æ–¹å¼ã¨ã€å„æ–¹å¼ã«ãŠã„ã¦ kube-system ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ  Pod ã®åå‰ã‚’ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ§‹æˆã‚„ä½œæˆæ™‚æœŸã«ã‚ˆã£ã¦ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹å¼ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

### SSH ãƒˆãƒ³ãƒãƒ« (tunnelfront-* Pod)

`tunnelfront` ã¨ã„ã†åå‰ã® Pod ãŒå­˜åœ¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã¯ã€SSH ãƒˆãƒ³ãƒãƒ«ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã«ã¯ SSH ã‚µãƒ¼ãƒãƒ¼ãŒå­˜åœ¨ã—ã€API ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ SSH ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶šã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ã€‚`tunnelfront` Pod ã¯ SSH ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãªã£ã¦ãŠã‚Šã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã§ SSH ãƒˆãƒ³ãƒãƒ«ã‚’é–‹å§‹ã—ã¾ã™ã€‚kubelet ã‚„ Pod / Service å®›ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ SSH ãƒˆãƒ³ãƒãƒ«çµŒç”±ã§è»¢é€ã•ã‚Œã¾ã™ã€‚

### VPN ãƒˆãƒ³ãƒãƒ« (aks-link-* Pod)

`aks-link` ã¨ã„ã†åå‰ã® Pod ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€VPN ãƒˆãƒ³ãƒãƒ« (OpenVPN) ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã«ã¯ VPN ã‚µãƒ¼ãƒãƒ¼ãŒå­˜åœ¨ã—ã¾ã™ã€‚ãƒãƒ¼ãƒ‰å´ã® `aks-link` Pod ãŒ VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãªã£ã¦ãŠã‚Šã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã§ VPN ãƒˆãƒ³ãƒãƒ«ã‚’é–‹å§‹ã—ã¾ã™ã€‚

### Konnectivity (konnectivity-agent-* Pod)

`konnectivity-agent` ã¨ã„ã†åå‰ã® Pod ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã¯ [Konnectivity service](https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/#konnectivity-service) ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚Konnectivity ã¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã® Kubernetes ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§[é–‹ç™ºã•ã‚Œã¦ã„ã‚‹](https://github.com/kubernetes-sigs/apiserver-network-proxy) TCP ãƒ¬ãƒ™ãƒ«ã®ãƒ—ãƒ­ã‚­ã‚·ãƒ¼ã§ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³å´ã§ã¯ Konnectivity Server ãŒèµ·å‹•ã—ã€ãƒãƒ¼ãƒ‰å´ã§ã¯ Konnectivity Agent ãŒèµ·å‹•ã—ã¾ã™ã€‚

AKS ã§ã¯ SSH / VPN ãƒˆãƒ³ãƒãƒ«ã«æ›¿ã‚ã‚‹æ–°ã—ã„æ–¹å¼ã¨ã—ã¦ã€æ®µéšçš„ã« Konnectivity ã®å°å…¥ãŒã™ã™ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚[Release 2021-10-28](https://github.com/Azure/AKS/releases/tag/2021-10-28) ã§ä¸€éƒ¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸãŒã€[Release 2021-11-18](https://github.com/Azure/AKS/releases/tag/2021-11-18) ä»¥é™ã€2021 å¹´ã®æ®‹ã‚Šã®æœŸé–“ã§ã¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãŒä¸­æ–­ã¨ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€æ—¥æœ¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã®ã¯ã‚‚ã†å°‘ã—å…ˆã«ãªã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚

> [!TIP]
> ä½™è«‡: ã€Œã‚³ãƒã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã€ã¨ã„ã†ã¨è‹±èªã®ã€Œconnectivityã€ã¨ç´›ã‚‰ã‚ã—ã„ã®ã§ã€ŒKonnectivity with Kã€ã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®äº‹ä¾‹

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰ã®é€šä¿¡ã«ã¤ã„ã¦ã¯ã€é–¢é€£ã™ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã®ã”ç›¸è«‡ã‚’ Azure ã‚µãƒãƒ¼ãƒˆã«ãŠå¯„ã›ã„ãŸã ãã“ã¨ãŒã”ã–ã„ã¾ã™ã€‚å¤šãå¯„ã›ã‚‰ã‚Œã‚‹ã”ç›¸è«‡ã¨ã—ã¾ã—ã¦ã¯ã€Kubernetes ã®ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ããªã„ã¨ã„ã†äº‹è±¡ã§ã™ã€‚

* Pod ä¸Šã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒã§ããªã„ (kubectl exec)
* Pod ã®ãƒ­ã‚°å–å¾—ãŒã§ããªã„ (kubectl logs)
* port-forward ãŒã§ããªã„ (kubectl port-forward)
* Pod ã‚„ Node ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ãŒå–å¾—ã§ããªã„ (kubectl top)

Pod ã®ä½œæˆ/å‰Šé™¤ã¨ã„ã£ãŸãƒªã‚½ãƒ¼ã‚¹æ“ä½œã¯æˆåŠŸã™ã‚‹ã‚‚ã®ã®ã€ä¸Šè¨˜ã«æŒ™ã’ã¾ã—ãŸã‚ˆã†ã« kubectl ã®ä¸€éƒ¨ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ãˆãªã„ã¨ã„ã†ç—‡çŠ¶ãŒã‚ã‚‹å ´åˆã¯ã€ä½•ã‚‰ã‹ã®è¦å› ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã®é€šä¿¡ãŒæˆåŠŸã—ã¦ã„ãªã„ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

> ã”å‚è€ƒ) Azure Kubernetes Service (AKS) ã«ã¤ã„ã¦ã‚ˆãå¯„ã›ã‚‰ã‚Œã‚‹è³ªå•
> [ã€Œkubectl logs ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã¯ã€API ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ "Error from server: error dialing backend: dial tcpâ€¦" (ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®ãƒ€ã‚¤ãƒ¤ãƒ«ã§ã®ã‚¨ãƒ©ãƒ¼: tcp ã«ãƒ€ã‚¤ãƒ¤ãƒ«...) ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ã€‚ã€](https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do)
> https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do

ã“ã®äº‹è±¡ãŒç™ºç”Ÿã—ã¾ã—ãŸå ´åˆã¯ä»¥ä¸‹ã®è¦³ç‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

### (è¦³ç‚¹ 1) ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«å¿…è¦ãªé€šä¿¡è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹

API ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€šä¿¡ãŒ NSG ã‚„ Azure Firewall ã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

ä¸‹è¨˜ AKS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®å‹•ä½œã«å¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒãƒ¼ãƒˆç•ªå·ã®ä¸€è¦§ãŒã”ã–ã„ã¾ã™ã€‚ã”åˆ©ç”¨ã®ç’°å¢ƒã«å¿œã˜ã¦ã€é€šä¿¡ãŒå¿…è¦ãª FQDN / ãƒãƒ¼ãƒˆç•ªå·ã®è¨±å¯ãŒã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

> ã”å‚è€ƒ) Azure Kubernetes Service (AKS) ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ ãƒãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹ã‚¨ã‚°ãƒ¬ã‚¹ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹
> [AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«å¿…è¦ãªé€ä¿¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¦å‰‡ã¨ FQDN](https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters)
> https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters

### (è¦³ç‚¹ 2) kube-system ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚·ã‚¹ãƒ†ãƒ  Pod ãŒæ­£å¸¸å‹•ä½œã—ã¦ã„ã‚‹ã‹

kube-system ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹å†…ã®ã‚·ã‚¹ãƒ†ãƒ  Pod ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ç´¹ä»‹ã‚’ã„ãŸã—ã¾ã—ãŸ `tunnelfront` ã‚„ `aks-link` ã¨ã„ã£ãŸã‚·ã‚¹ãƒ†ãƒ  Pod ãŒ Running ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§å‹•ä½œã‚’ã—ã¦ã„ã‚‹ã‹ã€ã¾ãŸã€Pod ã®ãƒ­ã‚°ã«ä½•ã‚‰ã‹ã®ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ãªã„ã‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚è©³ç´°ã«ã¤ãã¾ã—ã¦ã¯ä¸‹è¨˜ã® AKS ãƒˆãƒªã‚¢ãƒ¼ã‚¸ ã‚¬ã‚¤ãƒ‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

> ã”å‚è€ƒ) AKS ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã®ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ - ãƒãƒ¼ãƒ‰ã¨ãƒãƒƒãƒ‰ã®æ­£å¸¸æ€§ã‚’èª¿ã¹ã‚‹
> [2 - ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼ ãƒãƒ¼ãƒ‰ã®æ¥ç¶šã‚’ç¢ºèªã™ã‚‹](https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity)
> https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity

API ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å•é¡ŒãŒã‚ã‚‹å ´åˆã€`kubectl logs` ãŒæˆåŠŸã›ãšã€Pod ã®ãƒ­ã‚°ç¢ºèªãŒã§ããªã„ã“ã¨ãŒæƒ³å®šã•ã‚Œã¾ã™ã€‚[Container Insights](https://docs.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview) ãŒæœ‰åŠ¹ãªã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (omsagent) ã«ã‚ˆã£ã¦åé›†ã•ã‚ŒãŸãƒ­ã‚°ãŒã€Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‹ã‚‰å–å¾—å‡ºæ¥ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚kubectl ã‚³ãƒãƒ³ãƒ‰ã§ã®ãƒ­ã‚°å–å¾—ãŒæˆåŠŸã—ãªã„å ´åˆã¯ã€[ã‚¯ã‚¨ãƒªãƒ¼ã‚’ä½¿ç”¨ã—ãŸ Log Analytics ã‹ã‚‰ã®ãƒ­ã‚°å–å¾—](https://docs.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-log-query)ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚

ä¸Šè¨˜ã‚’ã”ç¢ºèªã„ãŸã ã„ãŸã‚ã¨ã‚‚å¼•ãç¶šãäº‹è±¡ãŒç™ºç”Ÿã—ã¾ã™å ´åˆã¯ã€Azure ã‚µãƒãƒ¼ãƒˆã¾ã§ãŠæ°—å…¼ã­ãªãã”ç›¸è«‡ãã ã•ã„ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’æ‹è¦‹ã•ã›ã¦ã„ãŸã ãã€è¦‹è§£ãƒ»å¯¾å‡¦æ–¹æ³•ã‚’ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚

## ã•ã„ã”ã«

Kubernetes ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒãƒ¼ãƒ‰é–“ã®é€šä¿¡ã¨ã€AKS ã«ãŠã‘ã‚‹é€šä¿¡æ–¹å¼ã€ãã—ã¦ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®äº‹ä¾‹ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã—ãŸ Konnectivity ã¯æ®µéšçš„ã«å„ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¸ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã•ã‚Œã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚æœ€æ–°ã®æƒ…å ±ã«ã¤ãã¾ã—ã¦ã¯ã€AKS ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã«ã”ã–ã„ã¾ã™ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

> ã”å‚è€ƒ) Azure/AKS - Releases
> https://github.com/Azure/AKS/releases

æœ¬ç¨¿ãŒçš†æ§˜ã®ãŠå½¹ã«ç«‹ã¡ã¾ã—ãŸã‚‰å¹¸ã„ã§ã™ã€‚

### å‚è€ƒãƒªãƒ³ã‚¯

* [Control Plane-Node Communication - Kubernetes](https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/)
* [Set up Konnectivity service - Kubernetes](https://kubernetes.io/docs/tasks/extend-kubernetes/setup-konnectivity/)
* [kubernetes / enhancements - API Server Network Proxy](https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1281-network-proxy)

---

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
[Microsoft Azure Tech Advent Calendar 2021](https://qiita.com/advent-calendar/2021/microsoft-azure-tech) ã¯æ˜æ—¥ãŒæœ€çµ‚æ—¥ã¨ãªã‚Šã¾ã™ï¼æ˜¯éã”è¦§ãã ã•ã„ãƒ¼ï¼
